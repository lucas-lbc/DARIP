Repo,IssueNum,Title_Description,Fixers,Labels,Created_at,Closed_at,Creator,Commentators,Label_adders,Label_removers,Assigns,Unassigns,Closer,Links
vercel/next.js,10075,"PerformanceObserver code is broken on canary only see title

Safari:
>TypeError: entryTypes contained only unsupported types



QQ:
![image](https://user-images.githubusercontent.com/616428/72293927-7f415f00-3622-11ea-9a44-80bd4e823b6d.png)
",prateekbh,kind: bug,2020-01-13T21:34:07Z,2020-01-15T04:16:39Z,Timer,balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,10152,"Missing compiler.hooks.failed in watchCompilers # Bug report

When running webpack in watch mode (dev), errors thrown by Webpack plugins are not shown.

## Describe the bug

We are missing a hook into [`compiler.hooks.failed`](https://webpack.js.org/api/compiler-hooks/#failed). We should add a hook into it here: https://github.com/zeit/next.js/blob/58b2d9e208c56cee0dab2eff287d2a19cb0e6de1/packages/next/build/output/index.ts#L220

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Initialize an empty Next.js project
2. Create a `next.config.js` with:

```js
class MyWebpackPlugin {
  apply(compiler) {
    compiler.hooks.emit.tapPromise(async () => {
      throw new Error('foo');
    });
  }
}

module.exports = {
  webpack: (config) => {
    config.plugins.push(new MyWebpackPlugin());

    return config;
  }
};
```
3. Run `npm run dev`

## Expected behavior

The error `foo` should be visible in the console, indicating that the compilation has failed. Instead, the compilation ""hangs"", when it actually failed.


## System information

- OS: macOS
- Version of Next.js: 9.2.0

## Additional context

N/A.
",Timer,kind: bug;type: needs investigation,2020-01-18T18:34:59Z,2020-08-18T06:03:37Z,satazor,Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,1020,"Accessing /static/{dir} will redirect to OS relative path Version: 1.2.3 & 2.0.0-beta.24

Let say I have folder /static/img, accessing url http://localhost:3000/static/img will redirect to http://localhost:3000/Users/bob/myapp/static/img/ .",timneutkens,kind: bug,2017-02-07T03:10:28Z,2017-02-08T00:13:26Z,firdausramlan,arunoda;firdausramlan;timneutkens,arunoda;timneutkens,timneutkens,timneutkens,,arunoda,
vercel/next.js,10268,"Built-in CSS Module Support Not Injecting *.module.css styling during SSR # Bug report

## Describe the bug
The new built-in css module support does not work during SSR, at least not without further configuration that I'm not aware of. Once the page is loaded client side, the styles are injected for the component and everything looks as it should.

I checked the html using Postman http client and noticed that there's no `<style></style>` element injected in the `<head />` element. However, after the page loads in a browser, that `<style></style>` element is injected with the expected scoped css.

I tried the basic example from the blog post, and it worked. However, there's no example with SSR and components.


## To Reproduce
I have a custom `pages/_app.jsx` and a component somewhere in my `pages/index.jsx` page, which is server side rendered using `getInitialProps()`. The component imports its own ./comp.module.css file.

## Expected behavior
The css modules imported across my app structure should be gathered during server side rendering and injected into the `<head/>` of my html that is sent to the client. That way, when the user first sees my page, all the styling is in place.

## Screenshots

#### What's sent down from SSR:
<img width=""1440"" alt=""Screen Shot 2020-01-25 at 8 51 12 PM"" src=""https://user-images.githubusercontent.com/5778798/73129538-941fda00-3fb4-11ea-8cfd-4cb6c6fed58c.png"">

#### What's show after the module's css is finally injected into the `<head/>` on the client:
<img width=""1440"" alt=""Screen Shot 2020-01-25 at 8 51 13 PM"" src=""https://user-images.githubusercontent.com/5778798/73129539-941fda00-3fb4-11ea-8e78-652894125b25.png"">


## System information

OS: macOS
Browser: Chrome
Version of Next.js: 9.2.1

## Additional context

This may be related to https://github.com/zeit/next.js/issues/10267
This is the feature I'm referring to: https://nextjs.org/blog/next-9-2#built-in-css-module-support-for-component-level-styles
",Timer,kind: bug;please add a complete reproduction,2020-01-26T01:53:34Z,2020-06-22T14:15:38Z,Lwdthe1,Lwdthe1;0xAsimetriq;ramasilveyra;mzygmunt;yanv1991;Timer;CrocoDillon;jeff-zhenz;balazsorban44;joonhocho;timneutkens,timneutkens,,Timer,,Timer,vercel/next.js#13058;
vercel/next.js,10404,"Global CSS during development is not injected on SSR # Bug report

## Describe the bug

Global CSS during development is not injected on SSR.

It creates a bad DX due to FOUC.

Probably same issue than https://github.com/zeit/next.js/issues/10268.

## To Reproduce

Repro https://github.com/ramasilveyra/bug-repro-next-global-css

## Expected behavior

Global CSS should be injected on SSR even in development.

## System information

- OS: macOS
- Browser: Chrome
- Version of Next.js: 9.1.2
",Timer,kind: bug,2020-02-03T20:49:32Z,2020-06-22T14:10:21Z,ramasilveyra,Timer;joonhocho;likerRr;balazsorban44,Timer,,Timer,,,
vercel/next.js,1042,"Babel not transpiling when using next@2.0.0-beta.24 If i use the beta 24 babel stops transpiling the code and simply copies the original into the output folder, reverting back to beta 20 fixes this issue

i have this on my package.json
```Javascript
""babel"": {
    ""presets"": [
      ""next/babel""
    ],
    ""ignore"": [
      "".next"",
      ""build""
    ]
}
```",arunoda,kind: bug,2017-02-08T20:29:45Z,2017-08-30T18:07:31Z,angel200sdnot,timneutkens;angel200sdnot;arunoda;bukinoshita,arunoda;timneutkens,arunoda,arunoda,,timneutkens,
vercel/next.js,1045,"Component display names in react-devtools shows `_fn` [2.0.0-beta.24] Recently updated to `2.0.0-beta.24`. It works fine before on `2.0.0-beta.17`.

<img width=""480"" alt=""screen shot 2017-02-09 at 2 31 17 pm"" src=""https://cloud.githubusercontent.com/assets/1287624/22771911/aca58180-eed4-11e6-88db-9179367ab12a.png"">
",arunoda,kind: bug,2017-02-09T06:35:23Z,2017-02-09T14:40:32Z,cvpcasada,arunoda;nkzawa,arunoda,,arunoda,,timneutkens,
vercel/next.js,10467,"Hot Reload Don't Work On New File Added Or  New Css Class Added globally  # Bug report

## Describe the bug

i'm trying to build a website with next.js but everytime i add a new file or a css class in layout folder in main.js file globally. the dev server doesn't reload i have to end the server and restart it again then it will show the changes

this is my package json 

{
  ""version"": ""1.0.0"",
  ""main"": ""index.js"",
  ""dependencies"": {
    ""next"": ""^9.2.1"",
    ""react"": ""^16.12.0"",
    ""react-dom"": ""^16.12.0""
  },
  ""devDependencies"": {
    ""dotenv"": ""^8.2.0""
  },
  ""scripts"": {
    ""dev"": ""next dev"",
    ""build"": ""next build"",
    ""export"": ""next export"",
    ""deploy"": ""next build && next export"",
    ""start"": ""next start""
  },
}

## System information

- OS: macOS
- Browser (if applies) Chrome
- Version of Next.js: 9.2.1
",Timer,kind: bug;type: needs investigation,2020-02-08T17:57:56Z,2020-09-10T17:16:38Z,naveenkash,naveenkash;Timer;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,10557,"FOUC with css-modules while using ""next/dynamic"" # FOUC with css-modules while using ""next/dynamic""

## Describe the bug

While using components with css-modules, if they are wrapped in ""next/dynamic"", they are unstyled until full hydration.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Get this demo - https://github.com/khades/next-dynamic-css
2. Install its dependencies
3. Build it.
4. Run it. (Its more obvious in production mode).
5. Set browser in ""Slow 3G throttling mode"".
6. Open http://localhost:3000

## Expected behavior

Either proper .css stylesheet comes in or whole page is not displayed unless all dynamic components are hydrated and styled.
",Timer,kind: bug;type: needs investigation,2020-02-17T13:29:43Z,2020-08-24T05:20:12Z,khades,khades;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,10598,"Different params received in `unstable_getStaticProps` in development and production (ZEIT) # Bug report

## Describe the bug

Having a page at `/docs/p/[...chunks]/index.js`, and visiting ie. `/docs/p/foo/bar`:
1. in dev the `unstable_getStaticProps` function receives `{ params: ['foo', 'bar'] }`
2. in production (on ZEIT) it receives `{ params: [ 'foo/bar' ] }`

## Expected behavior

I guess `{ params: ['foo', 'bar'] }` is the correct one.

## Screenshots

Runtime error on ZEIT:

![Schermata 2020-02-19 alle 17 15 27](https://user-images.githubusercontent.com/51573/74851402-776c8d00-533b-11ea-9634-d0131e91b596.png)

## System information

Version of Next.js: 9.2.1
",Timer,kind: bug,2020-02-19T16:17:28Z,2020-02-24T18:06:12Z,stefanoverna,balazsorban44,timneutkens,,timneutkens,,Timer,
vercel/next.js,1061,"TypeError: Cannot read property 'Component' of undefined I am using the [cloudinary-react library](https://github.com/cloudinary/cloudinary-react) and have run into the following error message when I add the Image component to my project:

**In the DOM**
```plaintext
TypeError: Cannot read property 'Component' of undefined
    at _callee3$ (http://localhost:3000/_next/-/main.js:3977:50)
    at tryCatch (http://localhost:3000/_next/-/commons.js:36939:40)
    at Generator.invoke [as _invoke] (http://localhost:3000/_next/-/commons.js:37230:22)
    at Generator.prototype.(anonymous function) [as next] (http://localhost:3000/_next/-/commons.js:36991:21)
    at step (http://localhost:3000/_next/-/commons.js:3724:30)
    at http://localhost:3000/_next/-/commons.js:3742:14
    at F (http://localhost:3000/_next/-/commons.js:2033:28)
    at http://localhost:3000/_next/-/commons.js:3721:12
    at doRender (http://localhost:3000/_next/-/main.js:3999:18)
    at Object._callee$ (http://localhost:3000/_next/-/main.js:3891:20)
```

**In the devtools**
```plaintext
Warning: React attempted to reuse markup in a container but the checksum was invalid. 
This generally means that you are using server rendering and the markup generated on the server was not what the client was expecting. 
React injected new markup to compensate which works but you have lost many of the benefits of server rendering. 
Instead, figure out why the markup being generated is different on the client or server:
 (client) tid=""1""><div class=""error"" data-jsx=""676
 (server) tid=""1""><div class=""wrapper"" data-jsx=""2
```

The Image component takes in a `cloudName` & `publicId`. The `publicId` is a string that represents a photo on the Cloudinary API server attached to the user's `cloudName`. Could it be that this is CORS issue and causing this error to appear? I'm not entirely sure what this is saying.",timneutkens,kind: bug,2017-02-09T23:25:35Z,2017-02-19T20:35:48Z,rockchalkwushock,sakulstra;rockchalkwushock;czzarr;timneutkens;rauchg;mattapperson;erikras;kunal-mandalia;mocheng;fortranlee;cruzeiro99;khuong291;jlcarvalho;niksurff,arunoda,,timneutkens,,nkzawa,
vercel/next.js,1070,"Don't clear terminal history when running `next` The user should still see the history after using `ctrl` + `c` to stop the app.

cc @rauchg ",timneutkens,kind: bug,2017-02-10T15:47:22Z,2017-02-16T00:50:05Z,leo,thangngoc89;leo;rauchg;timneutkens;nkzawa,leo;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,1079,"<Link> retains query string if href pathname is equal to current pathname Context:

starting url = `myapp.com/about?foo=bar`
click `<Link href=""/""><a>home</a></Link>`
result url = `myapp.com`

vs

starting url = `myapp.com?foo=bar`
click `<Link href=""/""><a>home</a></Link>`
result url = `myapp.com?foo=bar`

I would expect the latter to behave like the former. Thoughts?

",timneutkens,kind: bug,2017-02-11T01:35:02Z,2017-02-11T19:50:42Z,eezing,arunoda;timneutkens;eezing,arunoda,,timneutkens,,timneutkens,
vercel/next.js,10883,"Using router.push with non-absolute query fails as invalid href. # Bug report

## Describe the bug

Cannot push query parameter with `Router.push` unless using absolute URL. Instead will receive `Unhandled Rejection (Error): Invalid href passed to router: ?some-query https://err.sh/zeit/next.js/invalid-href-passed` and route is not changed. Would appear Next thinks the URL is external.

## To Reproduce

I'm using `useRouter` hook. To reproduce you can do something like `router.push('?some-query')`, which breaks with `push` but works fine in `Link` or as a regular anchor's `href`.

I have made this repository with an example: https://github.com/zjr/next-push-query-bug.

Sorry it has the create-next-app cruft in it, I'm short on time.

## Expected behavior

Query is appended to current location.

## System information

- Next.js v9.2.2
- React v 16.13.0
",Janpot,kind: bug,2020-03-07T16:17:04Z,2020-08-05T18:23:09Z,zjr,ClementLevesque;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,1089,"Latest beta breaks the using-router example Just bringing this to your attention.
I've followed the `using-router` example and get the following error:

```bash
Uncaught Error: No router instance found.
You should only use ""next/router"" inside the client side of your app.
```

and current usage is like so, from a `Link` component.

```js

import React, { PropTypes } from 'react';
import Router from 'next/router';

const onClickHandler = (href) => {
  return (e) => {
    e.preventDefault();
    Router.push(href);
  };
};

const Link = ({ children, href, ...props }) => (
  <a  href={href} {...props} onClick={onClickHandler(href)}>
    {children}
  </a>
);

Link.propTypes = {
  href: PropTypes.string,
  children: PropTypes.array.isRequired
};

export default Link;

```


I've seen some commits that change the router api. So this isn't really a surprise.

A documentation update would be nice tho :)",arunoda,kind: bug,2017-02-12T09:32:45Z,2017-02-12T21:18:23Z,svnlto,svnlto;arunoda,arunoda,,arunoda,,nkzawa,
vercel/next.js,10975,"[9.3] CSS Modules cannot be imported from within node_modules # Bug report
Trying to migrate to next 9.3 and using the built-in sass feature. 
When trying to use CSS modules with next 9.3, all my modules trigger the warning 

```.bash
./src/components/Footer/Footer.module.scss
CSS Modules cannot be imported from within node_modules

./src/components/Footer/Footer.module.scss
Module build failed: Error: Final loader (./node_modules/next/dist/build/webpack/loaders/error-loader.js) didn't return a Buffer or String
```

## Describe the bug

I'm trying to properly migrate to Next 9.3 and use the built-in sass feature. When I have a file named `*.module.scss` (not even imported), I have warnings in the terminal saying that `CSS Modules cannot be imported from within node_modules.`.

## To Reproduce

- Remove `@zeit/next-sass`  from `next.config.js` and `package.json`
- Remove .next folder
- Add saas `npm install sass`
- Create a file `Something.module.scss`. No need to import it.
- Note the warnings in the terminal

## Expected behavior

No warning should popup in the terminal.

## System information

- OS: macOS Mojave 10.14.6
- Version of Next.js: 9.3.0
- Version of Node: 13.9.0
- Version of npm: 6.13.7

## Additional context

I have updated `next.config.js` to be able to use the importing convention `~/` instead of `../`

`next.config.js`

```.js
const path = require('path');

module.exports = {
  webpack: config => {
    // Alias
    config.resolve.alias['~'] = path.resolve(__dirname + '/src');
    return config;
  }
};
```

`package.json`

```.json
{
  ""name"": ""..."",
  ""version"": ""0.1.0"",
  ""description"": ""..."",
  ""main"": ""index.js"",
  ""scripts"": {
    ""dev"": ""next dev"",
    ""build"": ""next build"",
    ""start"": ""next start""
  },
  ""keywords"": [],
  ""author"": ""..."",
  ""license"": ""MIT"",
  ""dependencies"": {
    ""@contentful/rich-text-react-renderer"": ""^13.4.0"",
    ""@optimizely/react-sdk"": ""^1.1.0"",
    ""bootstrap"": ""^4.4.1"",
    ""contentful"": ""^7.14.0"",
    ""isomorphic-unfetch"": ""^3.0.0"",
    ""next"": ""^9.3.0"",
    ""next-compose-plugins"": ""^2.2.0"",
    ""react"": ""^16.12.0"",
    ""react-bootstrap"": ""^1.0.0-beta.17"",
    ""react-dom"": ""^16.12.0"",
    ""react-optimize"": ""^2.2.1"",
    ""sass"": ""^1.26.2""
  }
}

```

Also, I'm using ZEIT Now, therefore in dev using:

```.bash
now dev
```

Thank you for your help!",Timer,kind: bug,2020-03-11T15:26:25Z,2020-08-06T17:20:11Z,Danetag,timneutkens;Danetag;claus;SeyedAlirezaFatemi;ali4heydari;Timer;xstable;fryck;Shivamk99;stopyransky;balazsorban44;ShanonJackson;jackocnr;javi11292;drkgrntt,timneutkens,timneutkens,,,Timer,
vercel/next.js,11173,"Microsoft Edge 16-18 missing ""flat"" polyfill # Bug report

## Describe the bug

When loading out Next site with Edge 18, there is a critical `TypeError` stating `Object doesn't support property or method 'flat'`

## To Reproduce


1. Go to https://epdev123.org/wiki/lang_en/magnus-dunn in Edge 18
2. Notice the full-screen critical error

* View our public sentry issue here: https://sentry.io/share/issue/cc2dd3b7d40b44a4ae69806e81a63c46/

## Expected behavior

This page should load properly like all other browsers were able to 

## Screenshots

![image](https://user-images.githubusercontent.com/3408480/76974607-ca6c3c80-6907-11ea-8b92-a849e9d3d38a.png)


## System information

- OS: Windows
- Browser: Edge 18, Edge 17, Edge 16 (see [Sentry Issue](https://sentry.io/share/issue/cc2dd3b7d40b44a4ae69806e81a63c46/) for browser breakdown)
- Version of Next.js: 9.3.1

## Additional context

This issue may relate to the recent changes in Next's polyfilling partially described in https://github.com/zeit/next.js/issues/7993

* I looked into adding this flat polyfill manually, but it's [already included in `next-polyfill-nomodule`](https://github.com/zeit/next.js/blob/canary/packages/next-polyfill-nomodule/src/index.js) as `import 'core-js/features/array/flat'`

* We have zero polyfilling in our application currently, we're fully relying on Next's included polyfills. We have not changed the included version of `core-js`

* This is a private project, we can email a zip to anyone at Zeit, just let me know if this looks like a valid bug to you all",Timer,kind: bug,2020-03-18T15:01:55Z,2020-09-14T19:25:31Z,dawsbot,dawsbot;alexanbj;Timer;balazsorban44;martpie,Timer,,Timer,,Timer,
vercel/next.js,11195,"FOUC using both global CSS and CSS modules # Bug report

## Describe the bug
When I use both global CSS and CSS modules and I import some JS libraries, there is a flash of unstyled content when I view the page in the dev mode.

The FOUC disappears when I don't import the CSS module file OR when I don't import any JS libraries...

It is only happening in the dev mode which makes it not a huge concern but it is still a bit stressful 棣冩 

## To Reproduce

Complete reproduction on [https://github.com/tomdohnal/nextjs-fouc](url)

1. Go to http://localhost:3333
2. You can see the FOUC

You have to either do a hard refresh or open the page in a tab to experience the FOUC.

## Expected behavior

There should be no FOUC.

## System information

- OS: macOS, Linux (not tested on Windows)
- Browser: Chrome, Firefox (not tested on other ones)
- Version of Next.js: 9.3.1
",Timer,kind: bug;type: needs investigation,2020-03-19T10:48:15Z,2020-06-22T14:10:20Z,tomdohnal,tafelito;webdeb;Timer;tomdohnal;mkotsollaris;balazsorban44,Timer,,Timer,,,vercel/next.js#13058;
vercel/next.js,11448,"CSS Module chunking isn't working as intended - duplicates. # Bug report
Love the library, love zeit just though i'd use your website as an example.
Chunks contain duplicate class names resulting in weird/unexpected ordering of css. The example provided here doesn't show the ordering breaking however in my own application classes specificity can change depending on the order of classes duplicated.


## Describe the bug
Chunks contain duplicate classes across multiple chunks.

## To Reproduce
I don't have a reproduction repository as i don't have time but looking at zeit.co i can tell its using Next 9.3+ so therefore the reproduction is simple look at your own website and inspect this element ""tooltip container"" 

![image](https://user-images.githubusercontent.com/13631026/77835023-560a8680-71ae-11ea-851f-f4f0079dea94.png)

![image](https://user-images.githubusercontent.com/13631026/77834983-ff9d4800-71ad-11ea-9558-9c7895559c46.png)


Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to zeit.co
2: inspect recent activity text
3: find span with class ""tooltip_container""
look at how many duplicate class names are applied.

## Expected behavior
css classes are not duplicated across chunks
",Timer,kind: bug;good first issue;type: needs investigation,2020-03-28T22:16:53Z,2020-08-18T06:10:59Z,ShanonJackson,hmillison;fabinppk;rjoaopereira;Timer;alexandre-marchina;mycolaos;balazsorban44,Timer;timneutkens,Timer,Timer,,Timer,
vercel/next.js,11504,"Error in anonymous function doesn't trigger react-error-overlay # Bug report

## Describe the bug

This is basically just a detail, but an error thrown in a page component that isn't named doesn't trigger `react-error-overlay`.

## To Reproduce

1. Create a page
    ```tsx
    // ./pages/home.js
    export default function () {
      throw new Error('boom')
    }
    ```
2. run `next dev`
3. visit `http://localhost:3000/home`
4. see the serverside rendered error, and not `react-error-overlay` kicking in

## Expected behavior

`react-error-overlay` shows. Just like it does when you do

```tsx
// ./pages/home.js
export default function Home () {
  throw new Error('hello')
}
```
or
```tsx
// ./pages/home.js
export default () => {
  throw new Error('hello')
}
```

## System information

- Version of Next.js: 9.3.2

",Timer,kind: bug,2020-03-30T21:35:02Z,2020-08-04T04:37:52Z,Janpot,Janpot;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,11608,"`fetchNextData` error handling fails with TypeError: Attempted to assign to readonly property. # Bug report

## Describe the bug

I woke up this morning to find that some of our site's CTA links (using 'next/link') were broken in mobile browsers, displaying ""An unexpected error has occurred"" to the user. The only thing I could find in Rollbar was this error: `TypeError: Attempted to assign to readonly property.`.

Testing locally with iOS Simulator, I traced it to this line in `.next/static/development/pages/_app.js`:
```
      err.code = 'PAGE_LOAD_ERROR';
```

Here is the full function where the error is occurring:
```
function fetchNextData(pathname, query, isServerRender, cb) {
  var attempts = isServerRender ? 3 : 1;

  function getResponse() {
    return fetch(utils_1.formatWithValidation({
      // @ts-ignore __NEXT_DATA__
      pathname: ""/_next/data/"".concat(__NEXT_DATA__.buildId).concat(pathname, "".json""),
      query: query
    }), {
      // Cookies are required to be present for Next.js' SSG ""Preview Mode"".
      // Cookies may also be required for `getServerSideProps`.
      //
      // > `fetch` won閳ユ獩 send cookies, unless you set the credentials init
      // > option.
      // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
      //
      // > For maximum browser compatibility when it comes to sending &
      // > receiving cookies, always supply the `credentials: 'same-origin'`
      // > option instead of relying on the default.
      // https://github.com/github/fetch#caveats
      credentials: 'same-origin'
    }).then(function (res) {
      if (!res.ok) {
        if (--attempts > 0 && res.status >= 500) {
          return getResponse();
        }

        throw new Error(""Failed to load static props"");
      }

      return res.json();
    });
  }

  return getResponse().then(function (data) {
    return cb ? cb(data) : data;
  })[""catch""](function (err) {
    // We should only trigger a server-side transition if this was caused
    // on a client-side transition. Otherwise, we'd get into an infinite
    // loop.
    if (!isServerRender) {
      err.code = 'PAGE_LOAD_ERROR';
    }

    throw err;
  });
}
```

The page I am attempting to transition to is using `getServerSideProps` to check the user's a/b test cookie and redirect them based on the result:

```
export const getServerSideProps = async (ctx) => {
  const expVariantId = getOrSetGoCookie(ctx);

  if (expVariantId === '1') {
    const { res, query } = ctx;

    res
      .writeHead(307, {
        Location: `${process.env.HI_BASE_URL}/signup?${queryString.stringify(query)}`,
      })
      .end();

    return { props: {} };
  }

  return { props: { expVariantId } };
};
```

This issue never occurs when navigating to the page directly or using a standard anchor tag - _only_ when using 'next/link'.

Here is the link for reference:
```
            <Link href=""/start"" as={`${process.env.HI_BASE_URL}/start`} passHref>
              <Button as=""a"" variant=""green"" width={1} mt={6} data-testid=""GetStartedA"">
                Get Started
              </Button>
            </Link>
```

## To Reproduce

Obviously, this is a sort of complicated example, and I'm not exactly sure what's causing the initial error. Let me know if you need more information, and I can try to create an example repo when I'm able to.

## Expected behavior

It would seem there are 2 issues here. One is that an error is occurring during when clicking a `next/link` to a page using `getServerSideProps` to redirect. The other is that during the handling of this error, another error is thrown when attempting to set the value of `err.code`.

I would expect to get information about what the error is, if it's something caused by my code, but we never make it that far.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- OS: iOS
- Browser: Safari (reported on Chrome too)
- Version of Next.js: 9.3.3

## Additional context

Thank you! Again, happy to provide any more detail necessary.",Timer,kind: bug,2020-04-02T18:21:12Z,2020-08-10T17:15:38Z,pjaws,marco-koenen;pjaws;saleebm;revolunet;Timer;luismramirezr;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,11702,"Router.push breaks on relative paths for old browsers (Chrome 49, IE11) # Bug report

## Describe the bug

When using router.push with a relative url on older browsers, it will throw an error (in dev) or silently fail (in prod). E.g.

```jsx
function Component() {
  const router = useRouter()
  return <button onClick={() => router.push('/foo')}>Click me</button>
}
```

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Trigger a Router.push call as explained above
3. If URL is supported by the browser, all is well
4. If URL is polyfilled you'll get a `Invalid href passed to router`

## Expected behavior

There should be no discrepancies between the 2 behaviors

## System information

- OS: macOS, Windows
- Browser: tested on Chrome 49, IE11, probably others
- Version of Next.js: 9.3.4

## Additional context

I tracked the issue down to this call here

https://github.com/zeit/next.js/blob/b274fe39d38111588e625342a89dc568ad38fff5/packages/next/next-server/lib/router/router.ts#L395

this will evaluate differently based on whether or not the polyfill is used.
When the native URL is used, `protocol` will be `null`, when the polyfill version is used, `protocol` will be `http://`, thus throwing the error just below the mentioned line.

This is caused by the [polyfill](https://github.com/lifaon74/url-polyfill) not throwing when an invalid URL is created, like `new URL('/foo')`, and triggering a [different behavior](https://github.com/GoogleChromeLabs/native-url/blob/66ed9808f9b995b80e66b7928817748a4da7afc7/src/parse.js#L99) on [`native-url`](https://github.com/GoogleChromeLabs/native-url).
A PR has just been merged regarding this bug and will hopefully get published soon https://github.com/lifaon74/url-polyfill/pull/54 
",Timer,kind: bug,2020-04-06T16:38:01Z,2020-07-16T14:36:49Z,acifani,u840903;acifani;Timer;balazsorban44,Timer,,Timer,,,
vercel/next.js,11711,"No eTag for HTML in SSR mode from 9.3.1 # Bug report

## Describe the bug

According to [docs](https://nextjs.org/docs/api-reference/next.config.js/disabling-etag-generation) ETag response header should be generated by default for each response. 
From version 9.3.1 for HTML in SSR mode it is not. 

## To Reproduce

1. Create fresh NextJS app.
2. Add 'getServerSideProps' method to enable SSR mode.
3. Build and start the application.
4. Inspect the response for '/'
5. There is no ETag response header 

## Expected behavior

ETag header is calculated and present in the response. 

## System information

- OS: Arch
- Version of Next.js: 9.3.1 - 9.3.4

## Additional context

I was comparing the code of 9.3.0 and 9.3.1 and I've found the TODO in packages/next/next-server/server/send-payload.ts which could address the issue.
",timneutkens,kind: bug,2020-04-06T19:30:30Z,2020-07-01T14:59:20Z,batorskik,luke-j;balazsorban44,Timer;timneutkens,,Timer,Timer,,
vercel/next.js,11946,"Inconsistent loading order of CSS in dev mode # Bug report

## Describe the bug

It's based on https://github.com/zeit/next.js/issues/10148#issuecomment-614478653. When `_app.jsx` contains component which imports postcss module the order of css chunks is inconsistent. Most likely css from module is inserted before global css.


## To Reproduce

I created a repo for you https://github.com/Joozty/nextjs-css. It's a fork from https://github.com/zeit/next.js/issues/10148. So the steps to reproduce are almost identical.

## Expected behavior

CSS in dev mode should be imported/inserted the same way as on production, i.e. global css first and then modules.


Thanks a lot :) 
",Timer,kind: bug,2020-04-16T12:58:29Z,2020-04-22T14:51:58Z,Joozty,fabinppk;iksent;bravokiloecho;balazsorban44;ashfaqnisar;Timer,Timer,,Timer,,Timer,
vercel/next.js,12232,"getLocalIdent generating invalid classnames # Bug report

## Describe the bug

`getLocalIdent` some times generating invalid calssnames (starts from number)

## To Reproduce

1. Go to https://github.com/ke-community/platform
2. Install `client` (you can use gitpod), run it, open site - see some styles
3. remove https://github.com/ke-community/platform/blob/master/client/next.config.js#L69 to reproduce default behavior
4. rerun dev, go to site, see classnames in devtools (starts from number thats invalid)

## Expected behavior

`getLocalIdent` generate valid classnames

## Screenshots

![image](https://user-images.githubusercontent.com/27290320/80346747-e8687d80-8873-11ea-9518-be012bb458b6.png)


## System information

- OS: gitpod
- Vivaldi | 3.0.1874.32鑱(Stable channel)鑱(64-bit)
- ""next"": ""^9.3.5""
- ""reshadow"": ""0.0.1-alpha.75""
- Version of Node.js: v12.16.2
",Timer,kind: bug,2020-04-27T07:45:47Z,2020-04-27T14:35:11Z,artalar,balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,12235,"Unable to create build if ./public folder size increases up to 20 GB # Bug report
Unable to create build if ./public folder size increases up to 20 GB

## Describe the bug
We are using next.js for e-commerce project which has a huge number of customer images in ./public/media folder. We are facing issue when we mount all image in media folder and the `npm run build` and `npm start` both fall into infinite loop. 

A clear and concise description of what the bug is.
Increase size of ./public folder and `npm run build` and `npm start` both fall into infinite loop. 

## To Reproduce
Increase size of ./public folder and `npm run build` and `npm start` both fall into infinite loop. 

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Create a media folder in ./public/media and then copy to many files and folder in this folder up to 20 GB.
2. Run `npm run build`

## Expected behavior

It should have some way to exclude a directories inside ./public folder which is not linked build creation.

## System information

- OS: [Linux Ubuntu 18.4]
- Browser [chrome]
- Version of Next.js: [^9.2.2]
- Version of Node.js: [v10.19.0]

## Additional context

We have searched for the reason and found e.g. 
if(hasPublicDir){publicFiles=await(0,_recursiveReaddir.recursiveReadDir)(publicDir,/.*/);}

Expected if there is any way to exclude the specified folder 

",Timer;timneutkens,kind: bug;type: needs investigation,2020-04-27T11:06:14Z,2020-06-10T20:35:35Z,amancp,jaysinghcp;aakashcp;balazsorban44,Timer,,Timer,,,
vercel/next.js,12304,"Experimental React refresh breaks custom scss configuration # Bug report

## Describe the bug

I was working on version 9.3.5 and using [`next-sass`](https://github.com/zeit/next-plugins/tree/master/packages/next-sass) to compile `.scss` files. Switching to version 9.3.6 and turning on react refresh results in the following error:

```
components/common/common.scss:1
ReferenceError: self is not defined
```

Due to internal constraints, I cannot use the `[name].module.scss` method of using sass.

## To Reproduce

1. Use next version 9.3.6
2. Apply `next-sass` in `next.config.js`
3. Set `reactRefresh: true`
4. Import an `.scss` file in the index page
5. Run the app locally with `next`
6. See the above compilation error

## Expected behavior

The `.scss` files should compile normally.

## System information

- OS: macOS
- Version of Next.js: 9.3.6
- Version of Node.js: 12.16.1",Timer,kind: bug,2020-04-29T02:52:33Z,2020-05-03T23:56:52Z,stefvhuynh,Cloudo;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,12343,"Styles duplicated across css chunks create source order issues # Bug report

## Describe the bug
I have an application that uses a component on multiple pages. When I build the project that component's styles are duplicated in each of the relevant css page chunks; this creates visual bugs.

For example (`some-component`, and `initial-page-component-override` are classes applied to the same element in the DOM on the initial page):

**initial-page.chunk.css**
```
// component styles
.some-component { margin-bottom: 10px; }

// page specific override
.initial-page-component-override { margin-bottom: 20px; }
```

**second-page.chunk.css**
```
// component styles
.some-component { margin-bottom: 10px; }
```

When second-page.chunk.css is added to the DOM the component styles are reapplied over the top of any page specific styles defined in the initial page. The overrides are lost and the incorrect margin is now applied to the component on the initial page. N.B. this is not an issue in dev mode, only in production.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Checkout https://github.com/petewarman/nextjs-css-module-issue
2. `npm i`, `npm run build`, `npm start`
3. Hover the cursor over the lime green button 
4. See it change to pink when the second page's stylesheet is preloaded

## Expected behavior

Style declarations should not be duplicated in compiled stylesheets. Component styles should loaded (in their own chunk?) above page specific styles.

## System information

- OS: macOS
- Version of Next.js: 9.3.6
- Version of Node.js: 10.16.3",Timer,kind: bug,2020-04-30T10:02:00Z,2020-08-18T05:12:35Z,petewarman,iksent;fabinppk;kambala3000;grefrit;Howard86;alexandre-marchina;isggwp;AurangzaibRamzan;bherila;VictorPivnenko;marcin-piela-sf;EduardoPedrosa;ysthedood;talaikis;lucasmogari;Timer;sophiekoonin;MurkyMeow;p-chan,Timer,,,,Timer,
vercel/next.js,1236,"Flash of Unstyled Content with <style jsx> I am using `<style jsx>` for most things on the site. 

I am also using the `<Head>` component in my layout to inline a custom `<style>` tag that includes my minified reset and other items. 

My question is, both `<Head>` and `<style jsx>` is not part of the rendered HTML from the server. It seems to me that because the page is declarative that it should be rendered as part of the Universal Rendering and already have the style tags for `<style jsx>` and `<Head>` present at the top of the file.

What is the best way to handle this besides reverting to outside CSS file and ripping all styles out of the `<style jsx>` tags?",timneutkens,kind: bug,2017-02-21T21:27:24Z,2017-02-27T23:45:50Z,khrome83,timneutkens;khrome83;sedubois;lacymorrow;NathanielHill;HcgRandon;hugotox;hajdun;hipstersmoothie;ftorre104;rauchg,timneutkens,,timneutkens,,arunoda,
vercel/next.js,12422,"Example 'with-typescript-styled-components' warning using experimental 'reactRefresh' # Bug report

## Describe the bug

Console throws warning after adding `reactRefresh` feature that I really like:

```
index.js:1 Warning: Prop `className` did not match. Server: ""pages__Title-lrbmwi-0 fFBxIA"" Client: ""pages___c-lrbmwi-0 dlZKIM""
```

**next.config.js**
```
module.exports = {
  experimental: {
    reactRefresh: true,
  },
};
```

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. npm init next-app --example with-typescript-styled-components portfolio
2. cd portfolio
3. add next,config.js (read start)
4. npm run dev
5. See error

## Expected behavior

A clear console without any warning.

## Screenshots

![image](https://user-images.githubusercontent.com/6414011/80893160-2c261180-8cd0-11ea-8722-7ea819a3b506.png)

## System information

- OS: WIN 10
- Browser: Chrome
- Version of Next.js: latest
- Version of Node.js: 13.5.0

## Additional context

Maybe we should ping Dan on his post but i'm not sure, maybe someone fixed it somehow and I;m just missing something: https://twitter.com/dan_abramov/status/1255217396597633024
",Timer,kind: bug,2020-05-02T22:00:13Z,2020-05-08T14:28:52Z,barthicus,balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,12445,"CSS Modules and prefetch load styles in wrong order # Bug report

Using `composes` in CSS modules leads to loading css in the wrong order after prefetching.

## To Reproduce

Here is a minimal reproducible example: 
https://github.com/standy/next-css-modules-error

## Screenshots

[Watch GIF](https://raw.githubusercontent.com/standy/next-css-modules-error/master/example.gif)

## System information

- OS: Windows
- Browser: Chrome
- Version of Next.js: noticed after updating from 9.2.1 to 9.3.6
- Version of Node.js: 13.12.0

",Timer,kind: bug,2020-05-03T17:11:00Z,2020-08-17T21:20:07Z,standy,Timer;balazsorban44,timneutkens;Timer,Timer,Timer,,,
vercel/next.js,12448,"styles flickering in dev with tailwind + css modules # Bug report

## Describe the bug

I'm using tailwindcss with css modules and I notice that the first time the page loads, all my styles are not loaded. Trying to figure it put what was happening, I run the tailwindcss example and added a style from a css module and it happens there too, even when built for prod.

## To Reproduce

Run the example from https://github.com/zeit/next.js/tree/canary/examples/with-tailwindcss

Add a `index.module.css` file with some style

add the styles form the css module in the `index.js` page

## Expected behavior

Without the use of the css modules, all styles are loaded fine the first time, without flickering. Same behavior is expected using css modules

## Screenshots

![May-03-2020 14-06-19](https://user-images.githubusercontent.com/5973652/80921889-51099b80-8d47-11ea-9aab-d1597e4820f9.gif)

## System information

- OS: macOS
- Browser (if applies) [e.g. chrome, safari]
- Version of Next.js: v9.3.6
- Version of Node.js: v13.12.0
- Version of tailwindcss: v1.4.4

",Timer,kind: bug;type: next,2020-05-03T18:07:14Z,2020-06-22T14:10:20Z,tafelito,Pytal;mzygmunt;timneutkens;Prottoy2938;talaikis;dalisalvador;dani97;Adrianjs42;webdeb;fadonascimento;Timer;casperle,timneutkens;Timer,Timer,Timer,,,vercel/next.js#13058;
vercel/next.js,12530,"Using getServerSideProps breaks scroll restoration # Bug report

## Describe the bug

When using getServerSideProps, a server roundtrip is made every time the user navigates to a page, to load the page's data json (generated by getServerSideProps).

This _also_ happens when the page is navigated to _via the browser's back and forward buttons_. The latency of the request, even when cached, breaks browser-native scroll restoration.

As there is no way to intervene with the request on the client side (using getServerSideProps, the request is made Next-internally), it can't be blocked. Using getInitialProps, it was possible to cache data on the client side and return it immediately. This is not possible anymore with getServerSideProps.

## To Reproduce

The issue is sufficiently documented [here](https://github.com/zeit/next.js/issues/3303).

## Expected behavior

Pages using getServerSideProps do not break scroll restoration when navigated to via the browser's back/forward buttons.
",ijjk,kind: bug;type: needs investigation,2020-05-05T18:56:37Z,2020-07-06T14:27:46Z,claus,tyler-ground;claus;Timer;Livven;balazsorban44,timneutkens;Timer,,Timer,,,
vercel/next.js,12753,"$RefreshReg$ is not defined in web worker after upgrading to 9.4.0 # Bug report

I believe this is a React Refresh-related issue.

Potentially relevant:
- https://github.com/facebook/react-native/issues/25684
- https://github.com/facebook/react/blob/master/packages/react-refresh/src/__tests__/ReactFresh-test.js

## Describe the bug

After upgrading to Next.js `9.4.0`, workers throw the following exception on load:

```ts
Uncaught ReferenceError: $RefreshReg$ is not defined
    at Module.eval (blocks.ts:239)
    at eval (blocks.ts:296)
    at Module../shared/blocks.ts (48ba4b417edc794a158b.worker.js:311)
    at __webpack_require__ (48ba4b417edc794a158b.worker.js:29)
    at Module.eval (WorldChunk.ts:12)
    at eval (WorldChunk.ts?c4f7:22)
    at Module../lib/Data/WorldChunk.ts (48ba4b417edc794a158b.worker.js:115)
    at __webpack_require__ (48ba4b417edc794a158b.worker.js:29)
    at Module.eval (WorldChunkReader.worker.ts?024a:1)
    at eval (WorldChunkReader.worker.ts?024a:21)
```



## To Reproduce

1. Configure `worker-loader` like so in `next.config.js`:
```js
config.module.rules.unshift({
  test: /\.worker\.(js|ts|tsx)$/,
  loader: ""worker-loader"",
  options: {
    name: ""static/[hash].worker.js"",
    publicPath: ""/_next/"",
  },
});

// Overcome webpack referencing `window` in chunks
config.output.globalObject = ""self"";
```
2. Load a worker
3. See error

## Expected behavior

No error, workers load successfully as in Next 9.3

## Screenshots

![image](https://user-images.githubusercontent.com/709451/81619006-77f64c00-939d-11ea-8e3b-71b190f9c4c9.png)
![image](https://user-images.githubusercontent.com/709451/81620471-ce18be80-93a0-11ea-95f1-a1c021167460.png)



## System information

- OS: macOS
- Browser (if applies) Chrome
- Version of Next.js: 9.4.0
- Version of Node.js: 13.12.0
",Timer,kind: bug,2020-05-11T22:54:01Z,2020-07-14T16:17:11Z,Jarred-Sumner,Jarred-Sumner;Timer;hbeckeri;adriancooney;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,12851,"unexpected params in getStaticProps # Bug report

## Describe the bug

I'm getting unexpected or undocumented results for getStaticProps with a dynamic route parameter. The params slug is an array of path parts (looks like `path.split('/')`). It occurs for me when the page is in a dynamic folder and named index.js and **not** with a spread filename ie `[...slug].js`. Here's an example:

Problem case:
```javascript
// at pages/abc/[slug]/index.js
export async function getStaticProps({ params }) {
  console.log(params); // --- @build: { slug: 'a' } @runtime: { slug: ['abc', 'a'] }
}
```

What I expected:
```javascript
// at pages/abc/[slug]/index.js
export async function getStaticProps({ params }) {
  console.log(params); // { slug: 'some-slug' }
}
```
I get these errors at runtime after deploying to now serverless. Builds are successful and the page appears to work but found the error in the now function logs.
",ijjk,kind: bug;type: needs investigation,2020-05-13T19:46:00Z,2021-06-23T18:15:55Z,stevez86,ijjk;stevez86;pcwa-ahendricks;codeincontext;jmlivemercial;Aleksion;timneutkens;robwebdev;leo;mattpocock,ijjk,,,,ijjk,vercel/next.js#19985;
vercel/next.js,13011,"Catch-all dynamic route doesn't catch a path with undefined path parameter # Bug report

## Describe the bug

Hello! I'm experiencing an issue with a dynamic catch-all route and empty path parameters. For example: 

```
/pages/[...slug]/index.tsx
```

Is not catching the route: http://localhost:3000/empty//parameter

Instead, it is loading default 404 page.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

Create a simple catch-all page:

```js
// /pages/[...slug]/index.js
export default function () {
  return <div>{'Hello!'}</div>;
}
```

Then try to load URL with empty path parameter:

http://localhost:3000/empty//parameter

## Expected behavior

It should load the catch-all page, not a 404. 

## System information

- OS: macOS
- Browser (if applies): Chrome
- Version of Next.js: 9.4.0
- Version of Node.js: 14.0.0",Timer;Janpot,kind: bug,2020-05-17T14:48:51Z,2021-08-03T15:06:27Z,kweiberth,tomdohnal;Timer;kweiberth;dalfriedrice;balazsorban44,Timer,Timer,Timer,Timer,,
vercel/next.js,13058,"Development server has a flash of unstyled content (FOUC) # Bug report

## Describe the bug

A clear and concise description of what the bug is.

When using Next.js, it appears that the CSS isn't fully hydrated into the `<head>` when the `<div id=""__next"">` element first becomes visible.

This causes a flash of unstyled content (or FOUC) when running our development server. It seems like it's fine in production though (which seems strange to me).

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Clone [this repository](https://github.com/tutorbookapp/covid-tutoring) by running:
```
$ git clone https://github.com/tutorbookapp/covid-tutoring
```
2. Install our dependencies (more details in our `README.md`) by running:
```
$ npm i && lerna bootstrap --hoist
```
3. Start a development server by running:
```
$ npm run dev
```
4. Notice the FOUC when first loading the page.

## Expected behavior

A clear and concise description of what you expected to happen.

The `<div id=""__next"">` element should only be visible **after** the necessary above-the-fold stylesheets (i.e. the style sheets that are included in the React components that are visible above-the-fold) are inserted into `<head>`. The remaining stylesheets can then be loaded with the `<div id=""__next"">` element visible.

## Screenshots

If applicable, add screenshots to help explain your problem.

See the FOUC visible on our development server:

![fouc](https://user-images.githubusercontent.com/20798889/82243201-09ad0e80-98f4-11ea-9b09-c00c7897e85e.gif)

Notice that it's gone on [our production website](https://tutorbook.org):

![no-fouc](https://user-images.githubusercontent.com/20798889/82243247-1df10b80-98f4-11ea-9ad9-01275a97a448.gif)

## System information

- OS: Ubuntu 18.04.2
- Browser: Firefox 76.0.1
- Version of Next.js: 9.4.0
- Version of Node.js: 12.16.1
",Timer,kind: bug;type: needs investigation,2020-05-18T17:42:55Z,2020-06-22T14:10:20Z,nicholaschiang,avijitelu;robgraeber;jimbuck;casperle;ozthekoder;showell215;BlakeBrown;jamesryan-dev;nicholaschiang;Timer;florianmatz;praveen7557;derskeal;ElegantSoft;osequi;tgrassl;anatolzak;coultonluke;dnaranjo89;yanv1991,Timer,,Timer,,,
vercel/next.js,13132,"Passing args in URL with `experimental.basePath` causes the page to constantly being reloaded. # Bug report

## Describe the bug

We are using next: ""^9.4.1"" in a project with `experimental.basePath` and when working with the project on development and we have params on URL the page constantly reloads making impossible to work on dev mode.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

I generated a simple [repo](https://github.com/robertovg/next-base-path-example) & [code-sandbox](https://codesandbox.io/s/github/robertovg/next-base-path-example) to show the problem. 
- Contains a basepath set to `myPath`
- Only contains a simple `index` page with a link to add params to the URL,

When you load the visit the project with params: [Live Sandbox](https://1mzx6.sse.codesandbox.io/myPath) and click on the link, o directly go to the URL with params on the [URL](https://1mzx6.sse.codesandbox.io/myPath?reloadsWithAnyParam=true)

The page loads correctly, but after a second it starts to reload from time to time.

If no params in the URL or `experimental.basePath` set, it works like as expected.

## Expected behavior

I would like to work with `experimental.basePath` without unexpected page reloads.


## Additional context

Obviously this is an experimental feature based on this [PR](https://github.com/zeit/next.js/pull/9872) but we will need sooner than later in our projects.

Thanks in advance 棣冩
",Timer;ijjk,kind: bug;good first issue;type: needs investigation,2020-05-20T10:16:26Z,2020-06-08T17:53:48Z,robertovg,ijjk;DrUNE;robertovg;designbyadrian;TyMick;balazsorban44,timneutkens;Timer,Timer,Timer,,Timer,
vercel/next.js,13231,"IE11, development, HMR: Object doesn't support property or method 'attachShadow'.  # Bug report

## Describe the bug

Basically the nextjs page bugs in IE11 development with the following message.
```
Object doesn't support property or method 'attachShadow'
``` 
It seems related to development hot module reloading. Somehow the `/_next/webpack-hmr` route is caught by express. I have by the way seen similar bugs when using custom routes in pure nextjs pages previously. Unsure if this is related.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Install the `custom-server-express` example.
2. Add this snippet in `server.js`:
```
  server.get('/:one/:two', (req, res) => {
    console.log(""Parameters"", req.params)
    return res.redirect('/a')
  })
```
3. Open `localhost:3000` in Internet Explorer 11.
4. The page flashes the actual content before going white.
5. Open the console (F12) and the `attachShadow` message flashes indefinitely.
6. In the command window, read the message `Parameters { one: '_next', two: 'webpack-hmr' }`

## Expected behavior

I expected to see my content. I would have also expected that `attachShadow` was either added as a built-in polyfill in nextjs, or that the function was avoided. I believe it can be traced to this location: `@next\react-dev-overlay\lib\internal\components\ShadowPortal.js`. In other locations in the next package you have an if-test to avoid this - it seems to me.

## Screenshots

![image](https://user-images.githubusercontent.com/19666956/82674366-781b0500-9c43-11ea-9921-5b8d29553d24.png)

## System information

- OS: Windows 10
- Browser: IE 11
- Version of Next.js: latest (as per today, using the custom-server-express example)
- Version of Node.js: 10.16.0

## Additional context

I came across this while updating a production package. I wanted to debug the polyfills and find out whether I still need to add polyfills for IE11 after next 9.3. This was a major roadblock.

The real problem here is probably using attachShadow in IE11.

I will try to recreate it without an express server...",JanKaifer,kind: bug;good first issue;area: Compiler;please verify canary,2020-05-22T13:53:16Z,2022-12-12T19:44:53Z,aorsten,aorsten;kate-hall;bolatovumar;mliq;Unsfer;riazXrazor;haydnhkim;jtakahashi64;oliviertassinari;ntsim;kevinolivar;revolunet;balazsorban44;tomdohnal;amigolargo;myarete;Timer,timneutkens,Timer,,,balazsorban44,
vercel/next.js,13473,"Link should create path with parameters from query parameters # Feature request

As described here: https://nextjs.org/docs/api-reference/next/link#with-url-object You can give the `href` attribute query parameters and it will construct a url with `?parameter=value`. It would be handy if next could create for routes that have parameters like `/[slug]/[...parameters]` the routes themself from query parameters with the same name.

## Is your feature request related to a problem? Please describe.

At the moment you  have to construct paths for links your self. Have to handle trailing slashes hashes and query parameter. While the other way around parameters in the path get already parsed into the query object.

## Describe the solution you'd like

Example:
```
<Link href={{ pathname : '/[slug]/[...parameters]' } query={ slug: ""awesome"", parameters : [""feature"",""that"",""makes"",""live"",""easier""] }}>...</Link>
```
could lead to the url `/awesome/feature/that/makes/live/easier`. All other query parameter that don't match in the `pathname` would be passed through as usual.

## Describe alternatives you've considered

One could also put it in a separate field and don't mix it with the query object, but next js does it the other way around already, that's why I would consider doing it the same way in this direction as well.

Thank you for your awesome work.",ijjk,kind: bug,2020-05-28T01:51:56Z,2020-09-02T16:23:27Z,JustTB,balazsorban44,Timer,,Timer,,,
vercel/next.js,13516,"CSR (client side transition) not working on 404 pages # Bug report

## Describe the bug

Using a Link to go to a 404 page doesn't work. The link is unresponsive, nothing happens on the browser.

You can reproduce this at https://nrn-v1-hyb-mst-aptd-gcms-lcz-sty-c1-peyfrlyfe.now.sh/fr/examples/built-in-utilities/errors-handling and click on the `This is a client-side navigation (CSR)` link.

Note that using `This is a normal navigation` link works as expected, but it uses a `<a>` link instead.

## To Reproduce

1. Use `<Link>` from `next/link` with href to a non-existing page
2. Try to click on it

## Expected behavior

The link should redirect to a 404 page.

## Screenshots

Video at https://youtu.be/mhJE5s-CIEE


## Additional context

Reproduced on v9.4.1 to v9.4.4
",Timer;ijjk,kind: bug,2020-05-28T20:26:41Z,2020-06-13T03:16:27Z,Vadorequest,Timer;Vadorequest;ijjk;balazsorban44,Timer,Timer,Timer,Timer,Timer,
vercel/next.js,13524,"Experimental optional catch all routes getStaticProps receive stringified array instead of array # Bug report

## Describe the bug

With optional catch all routes `getStaticProps` receive stringified array instead of array.

## To Reproduce

1. With this `getStaticPaths` :
```typescript
// [[...slug]].tsx
export const getStaticPaths: GetStaticPaths<PagePathParams> = async () => {
  return {
    paths: [
      {
        params: {
          slug: ['p1', 'p2'],
        },
      },
      {
        params: {
          slug: ['p3', 'p4'],
        },
      },
    ],
    fallback: false,
  }
}

export const getStaticProps: GetStaticProps<any, PagePathParams> = async ({ params }) => {
  console.log('getStaticProps', { params })
  return {
    props: {},
  }
}
```
2. Output is:
```
getStaticProps { params: { slug: [ '[p3', 'p4]' ] } }
getStaticProps { params: { slug: [ '[p1', 'p2]' ] } }
```

## Expected behavior

Output should be the same like with normal catch all `[...slug].tsx`:
```
getStaticProps { params: { slug: [ 'p1', 'p2' ] } }
getStaticProps { params: { slug: [ 'p3', 'p4' ] } }
```

## Environment
""next"": ""9.4.4"",
",Janpot,kind: bug,2020-05-28T22:37:52Z,2020-06-01T17:08:35Z,czterystaczwarty,balazsorban44,Timer,Timer,Janpot,,,
vercel/next.js,13574,"Fast refresh does not work correctly with MDX # Bug report

## Describe the bug

Instead of just replacing the contents, fast refresh performs a full page reload if it is an `.mdx` file.

## To Reproduce

1. `git clone https://github.com/michel-kraemer/test-nextjs-fast-reload-mdx.git`
2. `cd test-nextjs-fast-reload-mdx`
3. `npm i`
4. `npm run dev`
5. Open http://localhost:3000 in your web browser
6. You should see `Hello World!`
7. Change the file `pages/index.mdx`
8. The full page will be refreshed!!
9. Open http://localhost:3000/test in your web browser
10. Change the file `pages/test.jsx`
11. The text will be updated without a full page reload

## Expected behavior

Instead of reloading the full page, only the contents should be updated.

## Screenshots

閳

## System information

- OS: macOS
- Browser: chrome
- Version of Next.js: 9.4.4
- Version of Node.js: 14.3.0

## Additional context

* This has worked correctly in Next.js 9.3.x with HMR.
* The issue can be reproduced, no matter if the `.mdx` file imports/exports a `Layout` or not.
",Timer,kind: bug;type: needs investigation,2020-05-30T07:37:33Z,2020-08-04T21:24:58Z,michel-kraemer,vishalvijay;remorses;balazsorban44;michel-kraemer;aulneau;Timer;gaearon,Timer,,Timer,,,
vercel/next.js,13620,"Experimental nested catch all routes don't work and workaround doesn't either # Bug report

## Describe the bug

We need the optional catch all route `/[locale]/search/[[...slug]].tsx` to be able to:
- Show the search view at `/en/search`.
- Show the search view with a selected user at `/en/search/USER_ID` (the ""user view"" is just a dialog that opens when a search result is clicked).

But nesting a catch all route isn't currently supported (even though it's not explicitly stated in [the documentation](https://nextjs.org/docs/routing/dynamic-routes) that you can't do it), so our workaround was to create two pages:
1. The search view (without a user selected) at `src/pages/[locale]/search/index.tsx`.
2. The user view (the search view with a user selected) at `src/pages/[locale]/search/[user].tsx`.

The code in those two pages is identical (with the search view code just ignoring the fact that there isn't a user selected). So, we define the pages in a separate file (in `src/search/page.tsx`) and re-export it from the page files like so (note that we're using the Typescript `baseUrl` and `paths` options to map `@tutorbook/*` to `src/*`):
```tsx
export * from '@tutorbook/search/page';
```

But that results in messed up tree shaking and [your `next-ssg-transform` plugin](https://github.com/vercel/next.js/blob/canary/packages/next/build/babel/plugins/next-ssg-transform.ts) isn't able to remove the server-side only code that's used in the `getServerSideProps` function exported from `@tutorbook/search/page` and re-exported from `pages/[locale]/search/index.tsx`. So we're left with the following (expected) error:
```
Module not found: Can't resolve 'child_process' in '/home/nchiang/repos/tutorbook/node_modules/google-auth-library/build/src/auth'
```
When the `getServerSideProps` function is defined directly in the page (i.e. in `pages/[locale]/search/index.tsx` and again in `pages/[locale]/search/[user].tsx`) it works fine.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Clone [this public repository](https://github.com/tutorbookapp/tutorbook).
2. Checkout to the `develop` branch by running:
```
$ cd tutorbook/ && git checkout develop && git pull
```
3. Install our dependencies and start a development server by running the following (in the root of the repository):
```
$ npm i && npm run dev
```
4. Open up http://0.0.0.0:3000/en/search/ or http://0.0.0.0:3000/en/search/dv90ZS4zKFWWda296t2GuHQ9VRf1`.
5. See error.

## Expected behavior

1. Update [this documentation](https://nextjs.org/docs/routing/dynamic-routes) to make it explicit that you do not support nested catch all routes (e.g. `/[locale]/search/[[...slug]].tsx`).
2. Fix [the `next-ssg-transform` plugin](https://github.com/vercel/next.js/blob/canary/packages/next/build/babel/plugins/next-ssg-transform.ts) so that it removes the server-side only imports from re-exported `getServerSideProps` functions.

## System information

- OS: Ubuntu 18.04.2
- Version of Next.js: 9.4.0
- Version of Node.js: 12.16.1

## Additional context

Current workaround is just to literally copy the same code into both page files (i.e. `src/pages/[locale]/search/index.tsx` and `src/pages/[locale]/search/[user].tsx` are exactly the same).",Janpot,kind: bug,2020-05-31T22:08:26Z,2020-06-08T18:09:40Z,nicholaschiang,svenheden;Janpot;nicholaschiang;Timer;balazsorban44,Timer,Timer,Janpot,,Timer,
vercel/next.js,13624,"Provide the possibility to include json files inside /public/static/locales/ folder in the vercel lambda # Feature request

## Is your feature request related to a problem? Please describe.
When deploying a next-i18next translated project to vercel, the serverless lambda doesn't include the .json translation files located under `public/static/locales.` Thus, following error arises every time when deploying to vercel: 
![Screenshot_2020-06-01 Serverless Functions 閳 Vercel](https://user-images.githubusercontent.com/60541010/83388844-7396df00-a3ef-11ea-8ead-3ba040f77aec.png)

The creator of next-i18next [recommended to reach out to the vercel team](https://github.com/isaachinman/next-i18next/issues/274#issuecomment-624554871).
A user then [created a issue dedicated to this on the vercel repo ](https://github.com/vercel/vercel/discussions/4271). Here, @paulogdm [noted that this is due to a known next.js framework limitation](https://github.com/vercel/vercel/discussions/4271#discussioncomment-16330), captured in [[vercel/next.js#8251]](https://github.com/vercel/next.js/issues/8251).

Unfortunately, there's no real solution or workaround for this problem yet. I opened a new issue for this to give this problem more attention, because no user of next-i18next is able to deploy to vercel because of this framework limitation.

## Describe the solution you'd like

- somehow configure that vercel should include all files inside `public/static/locales` in the serverless lambda

## Describe alternatives you've considered
I tried to manually import the language files as suggested [here](https://github.com/vercel/next.js/issues/8251#issuecomment-544008976), but the containing folder is still not detected (the error stays the same)

## Additional context
Folder structure:
![Bildschirmfoto von 2020-06-01 10-22-38](https://user-images.githubusercontent.com/60541010/83390334-f02abd00-a3f1-11ea-9b9d-77f041e6eb93.png)
",Timer,kind: bug,2020-06-01T08:26:50Z,2020-07-08T06:55:20Z,borispoehland,derek-fong;Timer;borispoehland;shunkakinoki;lavaxun;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,13659,"Navigating to hash does not trigger router change # Bug report

## Describe the bug

I would like to navigate to a hash on the same page, and be able to react to that change from different components.
More precisely what I want to achieve is to jump to a collapsible section and expand it automatically based on that the hash in the URL matches the id of that section.

When creating a NextLink with a hash, `router` of `useRouter` does not change/trigger

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

My link:

```jsx
<NextLink href=""#section"">
  <a>Jump to section</a>
</NextLink>
```

My component where I expect the change:
```jsx
//...
const router = useRouter()
return (
  <Collapsible expanded={router.asPath.endsWith(""#section"")}>
    Lorem ipsum
  </Collapsible>
)
```

## Expected behavior

Navigating to a hash should trigger useRouter()

## System information

- OS: Ubuntu 20.04
- Browser Chrome Dev
- Version of Next.js: 9.4.4
- Version of Node.js: 12.6.0

## Additional context
Found this:
https://github.com/vercel/next.js/issues/5161

It states the issue is resolved, but I cannot figure out how to achieve this behaviour.",ijjk,kind: bug;type: needs investigation,2020-06-02T11:14:21Z,2020-08-06T22:04:48Z,balazsorban44,aorsten;tomdohnal;balazsorban44;oyeanuj,Timer,,,,,
vercel/next.js,13868,"ERR_HTTP_HEADERS_SENT when requesting fallback page in dev # Bug report

## Describe the bug

Ever since upgrading to v9.4.4, whenever I'm running the project locally and request a dynamic page which isn't included in `getStaticPaths` it'll error;

```
Error [ERR_HTTP_HEADERS_SENT]: Cannot set headers after they are sent to the client
    at ServerResponse.setHeader (_http_outgoing.js:533:11)
    at DevServer.sendHTML (/Users/jamespegg/Repositories/next_error_example/node_modules/next/dist/server/next-dev-server.js:23:5)
    at DevServer.render (/Users/jamespegg/Repositories/next_error_example/node_modules/next/dist/next-server/server/next-server.js:49:37)
    at processTicksAndRejections (internal/process/task_queues.js:97:5)
    at async Object.fn (/Users/jamespegg/Repositories/next_error_example/node_modules/next/dist/next-server/server/next-server.js:35:852)
    at async Router.execute (/Users/jamespegg/Repositories/next_error_example/node_modules/next/dist/next-server/server/router.js:28:28)
    at async DevServer.run (/Users/jamespegg/Repositories/next_error_example/node_modules/next/dist/next-server/server/next-server.js:44:494)
    at async DevServer.handleRequest (/Users/jamespegg/Repositories/next_error_example/node_modules/next/dist/next-server/server/next-server.js:13:133) {
  code: 'ERR_HTTP_HEADERS_SENT'
}
```

This is also usually followed by the next-server crashing;

```
events.js:292
      throw er; // Unhandled 'error' event
      ^

Error [ERR_STREAM_WRITE_AFTER_END]: write after end
    at writeAfterEnd (_http_outgoing.js:643:15)
    at ServerResponse.end (_http_outgoing.js:763:7)
    at DevServer.handleRequest (/Users/jamespegg/Repositories/orangedrivertraining.co.uk/node_modules/next/dist/next-server/server/next-server.js:13:221)
    at processTicksAndRejections (internal/process/task_queues.js:97:5)
Emitted 'error' event on ServerResponse instance at:
    at writeAfterEndNT (_http_outgoing.js:702:7)
    at processTicksAndRejections (internal/process/task_queues.js:85:21) {
  code: 'ERR_STREAM_WRITE_AFTER_END'
}
error Command failed with exit code 1.
```

I've created a repo to reproduce the issue: https://github.com/jamespegg/next_error_example
Weirdly, it gets the first error but doesn't then crash like it does in my real project.

Going back to v9.4.2 fixes the issue. It also works okay in production / Vercel, so it only seems to affect local development.

## To Reproduce

1. Clone and run https://github.com/jamespegg/next_error_example
2. Go to http://localhost:3000/world
3. See error in logs

The `[...page].js` page component;
```
import React from 'react'

const Page = props => (
  <div>Hello</div>
)

export async function getStaticProps ({ params, preview = false, previewData }) {
  return {
    props: {
      preview
    },
  }
}

export async function getStaticPaths () {

  return {
    paths: [
      { params: 
        {
          page : [""hello""]
        }
      }
    ],
    fallback: true
  }
}

export default Page

```

## Expected behavior

No error

## System information

- OS: macOS 10.15.4
- Version of Next.js: v9.4.4
- Version of Node.js: v14.2.0",ijjk,kind: bug,2020-06-07T14:17:40Z,2020-06-08T18:49:07Z,jamespegg,darshkpatel;Timer;ericobi;balazsorban44,timneutkens;Timer,Timer,Timer,,Timer,
vercel/next.js,139,"Next provides two URLs with different behaviors when page names are capitalized E.g if `pages/index.js` is renamed to `pages/Index.js`, it seems HMR doesn't work any more.
",timneutkens,kind: bug,2016-10-28T13:57:34Z,2017-02-20T15:48:48Z,sedubois,CompuIves;sedubois;eezing,nkzawa;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,13902,"Update handling for experimental basePath to be consistent Currently, the experimental basepath support supports transparently adding and removing base path.

That means for an app with `basePath: 'docs'` and `pages/foo.js`, both of these work:

```jsx
<Link href=""/foo"" />
<Link href=""/docs/foo"" />
```

However, this behavior can become problematic when a user wants to nest an identical segment:
```jsx
<Link href=""/docs"" /> // /docs or /docs/docs?
```

Furthermore, this behavior is confusing because it does not map 1-to-1 with the pages directory.

Even more problematic, if the basepath is edited, every `<Link />` in your application needs updated.

To remedy this, we only want to allow the `href` to match a page in `pages/`, no base path permitted.",ijjk,kind: bug,2020-06-08T15:26:55Z,2020-06-08T15:59:51Z,Timer,balazsorban44,Timer,,Timer,,,
vercel/next.js,13966,"[experimental] Basepath bug with catch all routes Question/possible bug with the latest commit on this branch. 

The previous solution worked fine for me with catch-all routes and basePath (see earlier comment), but with the later commit I now get `incompatible-href-as` errors with `router.push`, as the `as` value gets basePath added but `href` does not.

Example
```javascript
router.push('/section/[...slug]', '/section/success')
```
results in the error
```text
Error: The provided `as` value (/basepath/section/success) is incompatible with the `href` value (/section/[...slug])
```

Assuming this a bug unless I'm missing something?

_Originally posted by @daveskybet in https://github.com/vercel/next.js/pull/13560#issuecomment-641258600_",ijjk,kind: bug,2020-06-09T16:45:54Z,2020-06-10T18:26:58Z,Timer,balazsorban44,Timer,,Timer,,,
vercel/next.js,13970,"bundle size increase from [9.4.5-canary.7] to [9.4.5-canary.8]  # Bug report

## Describe the bug
building the project after only updating to 9.4.5-canary.8, and with no other changes increases each page size for ~10kb

## To Reproduce
Try build with [repro project](https://github.com/srdjan/next-repros) with 9.4.5-canary.8
and 9.4.5-canary.7 - difference will be visible in the build output

## Screenshots
with 9.4.5-canary.7:
<img width=""747"" alt=""Screen Shot 2020-06-09 at 1 25 12 PM"" src=""https://user-images.githubusercontent.com/61190/84180415-762faf00-aa55-11ea-9e26-b65d69a909a3.png"">

with 9.4.5-canary.8
<img width=""747"" alt=""Screen Shot 2020-06-09 at 1 25 23 PM"" src=""https://user-images.githubusercontent.com/61190/84180439-7def5380-aa55-11ea-8716-e25866fd50d4.png"">

## System information

- OS: [macOS]
- Version of Next.js: [9.4.5-canary.8]
- Version of Node.js: [14.4.0]

",timneutkens,kind: bug,2020-06-09T17:32:18Z,2020-06-11T08:57:25Z,srdjan,Timer;balazsorban44,Timer,,Timer,,timneutkens,
vercel/next.js,13978,"Fast refresh not working when page has exported config # Bug report

Fast refresh not working when exporting page config. (hybrid amp pages)
```js
export const config = { amp: 'hybrid' };
```

## To Reproduce

Add the line above to a fast reresh enabled page


## Expected behavior

Fast refresh should work on react version of page (no amp).


## System information

- OS: Linux
- Browse: Chromium 83 Arch Linux
- Version of Next.js: 9.4.0
- Version of Node.js: 12.17

## Additional context

related #13104 ",Timer,kind: bug,2020-06-09T20:57:56Z,2020-06-10T19:56:06Z,amiralies,balazsorban44,Timer,,Timer,,,
vercel/next.js,13986,"Incorrectly loading source map files in development ![image](https://user-images.githubusercontent.com/616428/84221910-4360d780-aaa4-11ea-8fa6-8801c536b227.png)

Screenshot highlights wrong script. See the one below!",timneutkens,kind: bug,2020-06-10T02:55:13Z,2020-06-11T08:57:25Z,Timer,balazsorban44,Timer,,Timer,,timneutkens,
vercel/next.js,13990,Experimental scroll restoration broken on forward nav https://i.imgur.com/sGr07Tp.gif,ijjk,kind: bug,2020-06-10T05:41:28Z,2020-06-12T15:25:20Z,Timer,Timer;balazsorban44,Timer;ijjk,Timer,Timer,,Timer,
vercel/next.js,14138,"Inconsistent error stack when editing the page # Bug report

## Describe the bug

When editing a component and receiving an error, the message has a super helpful hint saying where the error could be coming from: `Check the render method of ""Home""`. This message doesn't appear when you access the page and it already has the error (when reloading it, for example)

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. `npx create-next-app a`
2. Edit `pages/index.js`, with these changes:
```diff
--- a/pages/index.js
+++ b/pages/index.js
@@ -1,4 +1,5 @@
 import Head from 'next/head'
+import { UndefinedThing } from 'react'
 
 export default function Home() {
   return (
@@ -13,6 +14,8 @@ export default function Home() {
           Welcome to <a href=""https://nextjs.org"">Next.js!</a>
         </h1>
 
+        <UndefinedThing />
+
         <p className=""description"">
           Get started by editing <code>pages/index.js</code>
         </p>
```
3. Start the server, go to http://localhost:3000
4. See this error:
```
Server Error
Error: Element type is invalid: expected a string (for built-in components) or a class/function (for composite components) but got: undefined. You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.

This error happened while generating the page. Any console logs will be displayed in the terminal window.
```
5. Edit the file removing `UndefinedThing` from the JSX, save the file and the page will work normally
6. Now add `UndefinedThing` in the JSX again, save the file and this is the error:

```
Unhandled Runtime Error
Error: Element type is invalid: expected a string (for built-in components) or a class/function (for composite components) but got: undefined. You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.

Check the render method of `Home`.
```

## Expected behavior

`Check the render method of ""X""` should be visible in server errors too

## Screenshots

![image](https://user-images.githubusercontent.com/11896398/84534117-beeaa080-acbf-11ea-84ce-93ef35cd19e6.png)

## System information

- Version of Next.js: 9.4.4
- Version of Node.js: 12.17.0",Timer,kind: bug,2020-06-12T18:20:23Z,2020-06-17T19:56:22Z,rafaelalmeidatk,Timer;Gatesvert81;balazsorban44,rafaelalmeidatk,,Timer,,Timer,
vercel/next.js,14212,"Symbols in dynamic routes cause ""Error: failed to decode param"" # Bug report

## Describe the bug

Use of a symbol, for example, `%`, within a dynamic route will cause the route-matcher to throw the error `Error: failed to decode param`.

## To Reproduce

The issue has been reproduced, in a minimal fashion, in the following CodeSandbox:

[CodeSandbox Link](https://codesandbox.io/s/nextjs-url-encoding-8m3wm?file=/pages/index.js)

Steps to reproduce the error:

1. Create a [Dynamic Route](https://nextjs.org/docs/routing/dynamic-routes).

2. Attempt to access a dynamic route where the parameter contains a special symbol such as a `%`.

Notably, attempting to use a function such as `encodeURI()` to escape the special symbol does NOT resolve the issue. Using the browser debug tool, I found that `getRouteMatcher()` in `route-matcher.ts` receives a URI which is already decoded, and thus attempts to decode the URI again.

## Expected behavior

It is reasonable for unescaped symbols to cause an error, but I would expect that accessing `/testb/100%25awesome` would access `/testb/[query].js` with the query value `100%awesome`.

## Screenshots

![image](https://user-images.githubusercontent.com/4635334/84734213-5ecd5600-af6e-11ea-9ce6-7f640821e444.png)


## System information

- OS: Windows
- Browser: Firefox
- Version of Next.js: 9.4.5

## Additional context

In the use case where I encountered this issue, I was creating a page which makes an API call to load search results. The results of a given search will change relatively infrequently. Building the page for each possible search result is obviously not feasible, and I did not want to constantly rebuild the same page, so making the page use a dynamic route (rather than a `?search=` query parameter) and using getStaticProps to fetch the search query from the URL was the obvious choice.

However, if any query the user makes contains a special symbol, the user is not able to be routed to the relevant search results, as the request fails even if the URI is encoded using standard means.

Using a query parameter like `?search=` would be the normal solution, but in this case the search results cannot be cached (the parameter is not part of the URL), causing processing time to be wasted on common searches.",Timer,kind: bug,2020-06-16T05:09:23Z,2020-06-25T20:14:14Z,MasterEric,timneutkens;MasterEric;Timer;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,14282,"Link to index page with getServerSideProps and basePath results in full page reload # Bug report

## Describe the bug

Using the experimental `basePath` and linking from any page back to the index page with `Link` results in a full page reload if the index page uses `getServerSideProps`. Looking at the network tab in Chrome I see a request to `http://localhost:3000/base/_next/data/development.json` that 404s. In the production build, the request that 404s looks like this `http://localhost:3000/base/_next/data/xpCmLw_g1hPw_3b847mWF.json`. I believe there's a `/` missing before `.json`.

## To Reproduce

1. Clone this repo https://github.com/bernardop/next-basepath-repro
1. Install dependencies and `yarn dev`
1. Go to http://localhost:3000/base
1. Click on ""a"" or ""b""
1. Click on ""Back"" link
1. Index page does a full load and the network tab shows 404 to `.json`

## Expected behavior

Index page should not fully reload.

## System information

- OS: macOS
- All browsers
- Version of Next.js: 9.4.5-canary.8
- Version of Node.js: 14.4.0

## Additional context

I believe this was introduced in `9.4.5-canary.8` and I suspect #13876 is the culprit. `9.4.5-canary.7` does not have this error.
",ijjk,kind: bug,2020-06-17T18:54:13Z,2020-06-22T13:57:21Z,bernardop,ijjk;bernardop;alecrae;balazsorban44,Timer,,timneutkens,,ijjk,
vercel/next.js,14290,"Route prefetch not working correctly with [experimental] optional catch-all  ## Disclaimer:

I understand how to use dynamic routing in Next.js, I need optional catch-all for a specific feature I'm building.

### Bug report:

Notice the `[]` around the username:

<img width=""721"" alt=""Screen Shot 2020-06-18 at 12 22 20 AM"" src=""https://user-images.githubusercontent.com/52452/84956588-d1b70800-b0f9-11ea-8b06-0a71142d47ae.png"">

## To Reproduce

Here's a repo where I reproduce the issue: https://github.com/ivorpad/optional-catch-all-debug

Run `yarn install && yarn build && yarn start` and go to root.

https://github.com/ivorpad/optional-catch-all-debug/blob/master/pages/index.js#L8-L10
## Expected behavior

The JSON route should be generated correctly, notice it the server responded with `200`, but this is just an error object.

<img width=""393"" alt=""Screen Shot 2020-06-18 at 12 26 13 AM"" src=""https://user-images.githubusercontent.com/52452/84956893-5efa5c80-b0fa-11ea-89ae-381760b0c034.png"">

Expected URL(s):

<img width=""824"" alt=""Screen Shot 2020-06-18 at 12 26 54 AM"" src=""https://user-images.githubusercontent.com/52452/84956939-79ccd100-b0fa-11ea-900d-16dd893720b3.png"">
",Timer;Janpot,kind: bug,2020-06-17T22:29:32Z,2020-06-22T03:00:31Z,ivorpad,balazsorban44,Timer,,Janpot;Timer,,,
vercel/next.js,14382,"Params don't match when using 'unstable_revalidate' and 'getStaticProps' # Bug report

## Describe the bug

When running `getStaticPaths` on build, the params passed to `getStaticProps` looks like this (logged from `getStaticProps`):
```
{ uri: [ 
       'mat-og-drikke',
       'spisesteder',
       'markedet'
  ] }
```
This statically builds the pages I want and they work when refreshing the page in a browser.

When I navigate with `next/link` the pages are blank, and the json fetched is missing data. This is because the params from `getStaticProps` looks like this when navigating client side (also logged from `getStaticProps`):
```
{ uri: [
       '_next',
       'data',
       'w2nXsthsLcSAUfxXKvvWD',
       'mat-og-drikke',
       'spisesteder',
       'markedet.json'
 ] }
```

Pages directory looks like this:
```
pages
    [...uri]
         index.tsx
```
This does not happen if I turn off `unstable_revalidate`.

I'm using `fallback: true` in `getStaticPaths`.

## Expected behavior

That the params match both on build time and runtime so data fetched when navigating client side is correct and works.

## System information

- OS: macOS, Windows
- Version of Next.js: 9.4.4
- Version of Node.js: Deployed to Vercel
",ijjk,kind: bug,2020-06-20T06:21:49Z,2020-07-02T21:18:45Z,fredrik-sogaard,ijjk;fredrik-sogaard;balazsorban44,Timer;ijjk,ijjk,Timer,,ijjk,vercel/next.js#12851;
vercel/next.js,14419,"Catch-all routes with a period followed by a two-digit number inserts `00` into the params # Bug report

## Describe the bug

When you have a [catch all route](https://nextjs.org/docs/routing/dynamic-routes#catch-all-routes), and the passed parameter includes a colon followed by exactly two numbers (e.g. `/a:42b`), then instead of passing that parameter as-is to the app (i.e. `a:42b`), Next.js inserts two zeroes (i.e. `a:4200b`). This only happens after client-side navigation, not on a fresh load of the page.

## To Reproduce

See https://github.com/Vinnl/nextjs-repro-catchall-bug.

Try it online: https://repro-catchall-bug.vercel.app/

## Expected behavior

For path parameters not to be modified.

## Screenshots

![bug](https://user-images.githubusercontent.com/4251/85233061-08e02e80-b404-11ea-96c0-8f0f4dba77d6.gif)

## System information

- OS: Ubuntu 20.04
- Browser: Firefox
- Version of Next.js: 9.4.4
- Version of Node.js: 12.16.1

",Timer;Janpot,kind: bug,2020-06-21T18:13:48Z,2020-06-25T17:19:13Z,Vinnl,msheakoski;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,14425,"next/head causes issue when rendered outside of Next.js > have to switch back to the stable version :( the canary version has problems with `render`ing by testing-library/react

> `this.props.headManager.mountedInstances.add(this);` mountedInstances is undefined

_Originally posted by @coolgk in https://github.com/vercel/next.js/issues/8841#issuecomment-647180628_",ijjk,kind: bug,2020-06-21T22:01:08Z,2020-06-23T20:46:41Z,timneutkens,balazsorban44,timneutkens,,timneutkens,,,
vercel/next.js,14470,"react-dev-overlay does not work correctly with `basePath` # Bug report

## Describe the bug

react-dev-overlay does not work as expected when it is run with [`basePath`](https://github.com/vercel/next.js/issues/4998) because it sends a request to the` /__nextjs_original-stack-frame` and `/__nextjs_launch-editor` paths. however, when basePath is active, requests get 404 error because these paths are not actually available.


https://github.com/vercel/next.js/blob/7f6c6f031611057d44b253fbd53473471a84504f/packages/react-dev-overlay/src/middleware.ts#L83

https://github.com/vercel/next.js/blob/7f6c6f031611057d44b253fbd53473471a84504f/packages/react-dev-overlay/src/middleware.ts#L199

https://github.com/vercel/next.js/blob/7f6c6f031611057d44b253fbd53473471a84504f/packages/react-dev-overlay/src/internal/helpers/stack-frame.ts#L56

https://github.com/vercel/next.js/blob/86160a5190c50ea315c7ba91d77dfb51c42bc65f/packages/react-dev-overlay/src/internal/container/RuntimeError.tsx#L27

https://github.com/vercel/next.js/blob/86160a5190c50ea315c7ba91d77dfb51c42bc65f/packages/react-dev-overlay/src/internal/components/CodeFrame/CodeFrame.tsx#L49

## To Reproduce

`next.config.js`
```js
module.exports = {
  experimental: {
    basePath: '/blog',
  },
};
```

`pages/index.js`
```js
export default function Index() {
  return (
    <div>
      <h1>Hi!</h1>
      {foo}
    </div>
  );
}

```

![image](https://user-images.githubusercontent.com/1294640/85333518-65198000-b4e2-11ea-89ec-735969c66fe9.png)

![image](https://user-images.githubusercontent.com/1294640/85333574-7cf10400-b4e2-11ea-8d77-ef1a1315cf7b.png)



## Expected behavior

![image](https://user-images.githubusercontent.com/1294640/85333644-9abe6900-b4e2-11ea-8fce-a52b563863c5.png)

## System information

- OS: macOS
- Browser chrome
- Version of Next.js: 9.4.4
- Version of Node.js: 14.3.0

## Additional context

I have resolved my problem temporarily by creating a custom server with the following method.

```js
const express = require('express');
const next = require('next').default;
const port = parseInt(process.env.PORT, 10) || 3000;

const nextServer = next({
  dir: '.',
  dev: process.env.NODE_ENV !== 'production',
});

const handler = nextServer.getRequestHandler();
const app = express();

nextServer.prepare().then(() => {
  app.use((req, res) => {
    if (
      req.originalUrl.startsWith('/__nextjs_original-stack-frame') ||
      req.originalUrl.startsWith('/__nextjs_launch-editor')
    ) {
      req.url = '/blog' + req.originalUrl;
    }
    return handler(req, res);
  });
  app.listen(port, (err) => {
    if (err) {
      throw err;
    }
    console.log(`> Ready on port ${port} `);
  });
});

```
",ijjk,kind: bug,2020-06-22T20:56:17Z,2020-06-23T15:11:13Z,OnurGvnc,ijjk;balazsorban44,ijjk,,Timer,,,
vercel/next.js,14560,"Next App with assetPrefix and basePath infinitely reloads pages with route params # Bug report

## Describe the bug

The Next App will infinitely reload itself on a page with route parsm (`[routeParam].js`) if using the assetPrefix and basePath features

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

https://github.com/egucciar/next-app-refresh-reproducer

Clone the above repo. `yarn` and `yarn dev`. Go to http://localhost:3000/next-app/example/broke . Observe the page. After a few seconds, the app will reload itself. It should not reload itself.

## Expected behavior

Page should load and only refresh itself if there are build changes.

## Screenshots

The reload originates from `on-demand-entries-utils` as seen here:

![image](https://user-images.githubusercontent.com/2848185/85754310-f3f0ed00-b6da-11ea-9a0c-1803874ac769.png)

![image](https://user-images.githubusercontent.com/2848185/85754362-feab8200-b6da-11ea-9236-a9ed70c47baf.png)

I could not dig deeper into the file here to find the specific cause because i could not add logging or more debugging breakpoints around it (from minification/mapping)


## System information

- OS: macOs
- Browser Chrome
- Version of Next.js: latest
- Version of Node.js:  10.16

",ijjk,kind: bug,2020-06-25T15:59:38Z,2020-06-25T20:36:03Z,egucciar,ijjk;balazsorban44,Timer,,Timer,,ijjk,
vercel/next.js,14573,"Static paths that end in a trailing slash get exported as `.html` # Bug report

## Describe the bug

My CMS (WordPress) outputs links that end in trailing slashes e.g. `/my-blog-post/`.

In order to match those links correctly, I also return paths with trailing slashes in `getStaticPaths`:

```js
export const getStaticPaths = async () => ({
  // (imagine this was generated)
  paths: ['/my-blog-post/'],
  fallback: false
});
```

In `next dev`, it correctly matches the path so that links with `<Link href=""/my-blog-post/"">` work as expected, however, when I run the build and export this, I get the following output:

![image](https://user-images.githubusercontent.com/10551026/85819921-22a2ae00-b743-11ea-8605-2605a028db21.png)

Every trailing slash path becomes `.html` instead of `index.html`

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. run dev

```
git clone https://github.com/ricokahler/next-trailing-slash-export-bug.git
yarn
yarn dev
```

2.  try clicking both links. notice how only the link with the trailing slash works in dev

![image](https://user-images.githubusercontent.com/10551026/85820831-233c4400-b745-11ea-9c5b-87c156ff5946.png)

3. `npx next export`

Notice `.html`

![image](https://user-images.githubusercontent.com/10551026/85820905-5da5e100-b745-11ea-8032-bd6666814ad2.png)


## Expected behavior

Since the trailing slash link works in dev, i think it's reasonable to assume it'll work when exported. That would require `.html` to be `index.html`

## System information

- OS mac 10.15.1
- Version of Next.js: 9.4.4
- Version of Node.js: v12.13.1
",Janpot,kind: bug,2020-06-26T04:41:02Z,2020-06-27T11:59:28Z,ricokahler,Janpot;balazsorban44,Timer,,Timer,,,
vercel/next.js,14711,"Bad module not found error from webpack # Bug report

## Describe the bug

![image](https://user-images.githubusercontent.com/616428/86084798-c2c24500-ba6b-11ea-9a76-005a1dd981f3.png)


## To Reproduce

```tsx
import a from 閳ユ競閳;
```

## Expected behavior

A more clear message that says you're trying to import `b` and that's the problem. This message alludes to `a` being the problem.

---

Useful flag: 

![image](https://user-images.githubusercontent.com/616428/87306475-114cf600-c4e6-11ea-907c-9f181f873b7d.png)
",timneutkens,kind: bug,2020-06-30T04:51:52Z,2020-08-05T19:11:36Z,Timer,eeekkoo;Timer;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,14734,"Invalid trailing slash behavior with basepath and index route See video when navigating from about back to index.

https://mega.nz/file/xRQU0CKK#iQbiAovc6uV2gygy8GhO_RLLl2SgMEyBPGutnkqt4YA",Janpot,kind: bug,2020-06-30T16:49:32Z,2020-07-02T03:48:11Z,Timer,balazsorban44,Timer,,Timer,Timer,,
vercel/next.js,14748,"Possible bug: 308 redirects for assets when using trailing slashes option # Bug report

We are using a `pre-release` version to make use of #13333 for trailing slashes. The routes work fine with trailing slashes but we noticed that the server now redirects asset requests to include trailing slashes, too. We are not sure if we are doing something wrong or if this is a bug. In case it is a bug, we wanted to bring this to your attention so that it can be fixed before the `9.4.5` release.

## Expected behavior

The server does not redirect the requests, i.e. responds with status code `200` instead of `308`.

## Screenshots

![Screenshot 2020-06-30 at 21 39 13](https://user-images.githubusercontent.com/63334/86171483-13de4180-bb1d-11ea-8152-c00ea3054ccf.png)

## System information

- Version of Next.js: `9.4.5-canary.20`
- Version of Node.js: `14.0.5`

## Additional context

@Janpot for visibility.
",Timer;Janpot,kind: bug,2020-06-30T20:00:27Z,2020-07-01T07:48:03Z,ianflorian,Janpot;timneutkens;ianflorian;balazsorban44,Timer,,Timer,,timneutkens,
vercel/next.js,14792,"[cms-sanity] Add `NEXT_PUBLIC_` to readme env variables # Bug report

## Describe the bug

[Step 4](https://github.com/vercel/next.js/tree/canary/examples/cms-sanity#step-4-set-up-environment-variables) of the [readme](https://github.com/vercel/next.js/blob/canary/examples/cms-sanity/README.md) says, i have to create a env variable named `SANITY_PROJECT_ID` but to work locally with `yarn dev` it has to be `NEXT_PUBLIC_SANITY_PROJECT_ID` (as well?) 

Since i was not aware of this part of the next.js config, i was confused why it wasn閳ユ獩 working. Since i could access all env variables within my code, but not on runtime.

## To Reproduce

Follow the [steps](https://github.com/vercel/next.js/tree/canary/examples/cms-sanity#step-4-set-up-environment-variables) of the [Readme](https://github.com/vercel/next.js/blob/canary/examples/cms-sanity/README.md) to install & run the example.

## Expected behavior

Follow the readme and have a functioning project running with `yarn dev`

## Screenshots

Without the `NEXT_PUBLIC_SANITY_PROJECT_ID` variable in the `.env.local` file:
![image](https://user-images.githubusercontent.com/1867543/86346498-4abb7100-bc5d-11ea-83fa-23406fe6dec6.png)


## System information

- OS: macOS
- Browser: Chrome
- Version of Next.js: v9.4.4
- Version of Node.js: v.13.8.0
",chibicode;lfades,kind: bug;area: documentation,2020-07-02T10:16:04Z,2020-07-08T15:01:21Z,Maybach91,balazsorban44,Timer,,Timer,,,
vercel/next.js,14828,"Dynamic link vars not be interpolated on latest canary version # Bug report

## Describe the bug

https://github.com/vercel/next.js/discussions/14822

happy to report that is is working fine on 9.4.4 - but after seeing if I could reproduce on a next.js/examples paired down repo with the latest canary next.js - it was reproducible. (this could be a functionality changing that I haven't caught in the docs) - but it feels like a bug to me


## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. https://github.com/followbl/dynamic-routing
2. Deploy to Vercel
3. Click any post
4. Click any comment
5. View Logs on Vercel
<img width=""1079"" alt=""Screen Shot 2020-07-03 at 2 16 05 PM"" src=""https://user-images.githubusercontent.com/927065/86491117-ca1d7300-bd37-11ea-8951-5fefb31bd2c2.png"">

## Expected behavior

Expect the <Link vars to be interpolated in `getServerSideProps` context - instead they are provided as is in square brackets

## System information
- Version of Next.js: [9.4.5-canary.28]


",ijjk,kind: bug,2020-07-03T18:18:49Z,2020-07-06T15:10:18Z,followbl,Timer;ijjk;followbl;timneutkens;balazsorban44,ijjk,ijjk,ijjk,,timneutkens,
vercel/next.js,14833,"webpack dependency in @next/react-dev-overlay I am playing with yarn 2, next.js and typescript.

There were some typescript-related issues with ```tsx``` files (e.g. ""JSX element class does not support attributes because it does not have a 'props' property. [2607]"" when using next ```Link```).

Updating from ```next@9.4.4``` to ```next@9.4.5-canary.28``` resolved the ```tsx``` issues.

However, running ```next dev``` causes yarn to throw the following error:

```
$ yarn dev
ready - started server on http://localhost:3000
Error: @next/react-dev-overlay tried to access webpack, but it isn't declared in its dependencies; this makes the require call ambiguous and unsound.

Required package: webpack (via ""webpack"")
Required by: @next/react-dev-overlay@virtual:662a71a5c3fcdc3fdda9ed7f117282fb9b068600afb7f480ffe899fb17c3e6a32a9896fc4a914d0ec4de737118ba46840dbb999b9260cdf0479462680dbb04b2#npm:9.4.5-canary.28 (via /home/rh/box/.yarn/$$virtual/@next-react-dev-overlay-virtual-4f642ef845/0/cache/@next-react-dev-overlay-npm-9.4.5-canary.28-b4e8895b98-0063344906.zip/node_modules/@next/react-dev-overlay/lib/)

[...]
```
Adding the following to ```.yarnrc.yml``` fixes the issue:

```
packageExtensions:
  ""@next/react-dev-overlay@*"":
    dependencies:
      webpack: ""*""
```

Would it be possible to add ```webpack``` to ```@next/react-dev-overlay``` dependencies?",timneutkens,kind: bug,2020-07-03T21:12:45Z,2020-07-05T21:42:34Z,ramblehead,balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,14845,"basePath: urls in Router events include basePath # Bug report

## Describe the bug

Been picking apart the router logic a bit while working on https://github.com/vercel/next.js/pull/14827 and noticed that urls that are emitted in router events include the basepath.

Additionally, searching the test folder, there isn't a single test containing ""routeChangeStart"". It seems like these events are not covered by any tests.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. configure a `basePath`
2. add an `pages/_app.js` like:
    ```js
    import { useEffect } from 'react'
    import { useRouter } from 'next/router'
    
    export default function MyApp({ Component, pageProps }) {
      const router = useRouter()
    
      useEffect(() => {
        const handleRouteChange = (url) => console.log('App is changing to: ', url)
        router.events.on('routeChangeStart', handleRouteChange)
        return () => router.events.off('routeChangeStart', handleRouteChange)
      }, [])
    
      return <Component {...pageProps} />
    }
    ```
3. navigate links in your app and observe the console

## Expected behavior

urls don't contain the basepath
",Timer,kind: bug,2020-07-04T11:39:39Z,2020-07-20T20:03:50Z,Janpot,timneutkens;balazsorban44,Janpot;Timer,,Timer,,Timer,
vercel/next.js,14923,"Canary.29: Unexpected error in root path with optional catch all # Bug report

## Describe the bug

Production build fails to render root path page when using optional catch all in canary.29 with fallback and empty static paths.

## To Reproduce

1. Install `next@9.4.5-canary.29`
2. Create page `pages/[[...slug]].js`
3. Add following code:
```javascript
const CatchAllPages = () => {
  return <div>Test</div>
}
export const getStaticPaths = async () => {
  return {
    paths: [],
    fallback: true,
  }
}
export const getStaticProps = async (ctx) => {
  return {
    props: {},
  }
}

export default CatchAllPages
```
4. Run `next build && next start`
5. Go to `http://localhost:3000/`
6. See error

## Expected behavior

It should render

## Screenshots

In Chrome & Firefox same error:
<img width=""614"" alt=""Screen Shot 2020-07-07 at 10 12 53 PM"" src=""https://user-images.githubusercontent.com/1407526/86794370-0554d480-c09f-11ea-8638-9384345d7de7.png"">
In Safari, quite different error:
<img width=""1067"" alt=""Screen Shot 2020-07-07 at 10 13 53 PM"" src=""https://user-images.githubusercontent.com/1407526/86794475-26b5c080-c09f-11ea-88c0-07e84db84ad7.png"">


## System information

- OS: MacOS; Vercel as well
- Version of Next.js: 9.4.5-canary.29
- Version of Node.js: v12.16.3
- Browsers: All

## Additional context

If it helps, adding a breakpoint in the bundle code shows that this fails here (prettyfied bundle slice of code):
```javascript
fetch(t, {
  credentials: ""same-origin"",
}).then(function (t) {
  if (!t.ok) {
    if (--n > 0 && t.status >= 500) return e();
    throw new Error(""Failed to load static props"");
  }
  return t.json();
});
```
Logging here `t` (argument passed to `fetch`) when root path `localhost:3000/`, displays `t` as an empty string while other routes (e.g: `/de/` & `/fr/`) display, for example:
```markdown
/_next/data/77xPdya_xyQSG_SoVaE0m/de.json
/_next/data/77xPdya_xyQSG_SoVaE0m/fr.json
```
Since `fetch('').then(t => t.json())` would get the homepage fallback html code `t.json()` would fail with error shown in screenshots.",Timer,kind: bug,2020-07-07T14:24:47Z,2020-07-14T18:58:03Z,eddyw,balazsorban44,Timer,,Timer,,,
vercel/next.js,14959,"Link and router query should automatically replace dynamic route parts # Feature request

It would be great if the `Link` component was smart enough to replace dynamic route parts in `pathname` automatically based on the `query` when using the url-object form of `href`:

```js
<Link href={{ pathname: ""/posts/[id]"", query: { id: 1, anotherParam: 2 } }}><a>...</a></Link>
```

Currently this renders `<a href=""/posts/[id]?id=1&anotherParam=2"">...</a>` which is _functional_ but odd (also it breaks getServerSideProps et al `params`). So in order to make this work, I have to replace the dynamic parts in `pathname` with matching `query` params and stringify a `search` to construct an `as` prop manually.

The same issue concerns `router.push` and `router.replace`.

Another example to illustrate the issue where it's quite tedious to construct the `as` prop would be to replace one or more query params of the current (unknown) route to link to another locale:

```js
const LinkCurrentRouteToLocale = ({ locale, ...rest }) => {
  const { pathname, query } = useRouter();
  // pathname being /[locale]/foo or similar
  return <Link href={{ pathname, query: { ...query, locale } }} {...rest} />
}
```

## Describe the solution you'd like

If this was handled out of the box, using `{ pathname: ""/posts/[id]"", query: { id: 1, anotherParam: 2 } }` would create the URL `/posts/1?anotherParam=2` and the link would be `<a href=""/posts/1?anotherParam=2"">...</a>`.

I think adding this behavior would be a non-breaking change without any new API. It would be a big improvement over the current behavior. I also don't think that it would be at odds with a more sophisticated approach described in #8207 

## Describe alternatives you've considered

An alternative could be to explicitly add a `params` prop to the url object form, e.g.

```js
<Link href={{ pathname: ""/posts/[id]"", params: { id: 1 }, query: { anotherParam: 2 } }}><a>...</a></Link>
```

But I don't see the benefit of doing this.

P.S.: I already posted this suggestion in https://github.com/vercel/next.js/issues/8207#issuecomment-537408323 but as that RFC had a much bigger scope it probably wasn't the right place to discuss this.",ijjk,kind: bug,2020-07-08T08:01:18Z,2020-09-02T16:23:27Z,jerstucki,timneutkens;balazsorban44,Timer,,Timer,,,
vercel/next.js,14964,"Optional catchAll route with getStaticProps breaks builds, but not the dev server # Bug report

## Describe the bug

I'm trying to build dynamic nested SSG routes with Next. The goal is to be able to create any page using an external data source. I also want this method to cover the root (path `/`) page, so I'm using optional catch-all routes. I have a `[[...slug]].js` file that generates all my pages.

I'm using the Next canary 9.4.5 version to avoid issue #14886.

My app works fine when I run the development server. But when I try to create a build, I get this error:

```
Creating an optimized production build  

Compiled successfully.

> Build error occurred
[Error: ENOENT: no such file or directory, rename '/pathtomyapp/.next/export/.html' -> '/pathtomyapp/.next/server/pages/.html'] {
  errno: -2,
  code: 'ENOENT',
  syscall: 'rename',
  path: '/pathtomyapp/.next/export/.html',
  dest: '/pathtomyapp/.next/server/pages/.html'
}
```

When I remove the root route (the one where the slugs array is empty), the build doesn't break. It seems like Next wants to create an html file for each page, like `home.html`, then tries to create a `.html` file for the root instead of something like `index.html`.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Create a default Next app
2. Update it to the latest canary
3. In the pages folder, delete `index.js` and create a file called `[[...slug]].js` instead
4. In that `[[...slug]].js` file, paste this code:
```js
const MyPage = ({ slug }) => {
  return <div>My page, slug {JSON.stringify(slug)}</div>;
};

export async function getStaticPaths() {
  const paths = [
    {
      params: { slug: [] },
    },
    {
      params: { slug: [""home""] },
    },
    {
      params: { slug: [""home"", ""page""] },
    },
  ];
  return { paths, fallback: false };
}

export async function getStaticProps({ params }) {
  return {
    props: {
      slug: params.slug || null,
    },
  };
}

export default MyPage;
```
5. Run `yarn dev`, and see that things are working as expected
6. Run `yarn build`, and watch the build fail

## Expected behavior

With the code provided above, Next.js should have been able to build these pages:

```
Page                                                           Size     First Load JS
閳   /_app                                                      3.47 kB        61.1 kB
閳 閳 /[[...slug]]                                               319 B          61.5 kB
閳   閳 /
閳   閳 /home
閳   閳 /home/page
閳 閳 /404                                                       3.25 kB        64.4 kB
```

## System information

- OS: macOS 10.15.5

- Version of Next.js: `^9.4.5-canary.29`
- Version of Node.js: 12.18.2",Janpot,kind: bug,2020-07-08T09:06:44Z,2020-07-09T04:21:50Z,remidej,remidej;balazsorban44,Janpot,,Janpot,,,
vercel/next.js,15023,"useRouter has inconsistent results depending on getInitialProps # Bug report

## Describe the bug

Using a query url flag to change layout render options; it should function without having to use getInitialProps.

## To Reproduce

https://codesandbox.io/s/goofy-williams-ru4nv

Append to base URL in the sandbox demo: `/test?inapp=1`

- In _app.jsx make sure getInitialProps is commented out.
- AppStateProvider logs a message and the content of message will be 

```javascript
{
  route: '/[locale]',
  pathname: '/[locale]',
  query: { amp: undefined },
  asPath: '/[locale]',
  basePath: '',
  events: undefined,
  isFallback: false
}
```

- Uncomment getInitialProps in _app.tsx
- AppStateProvider logs a message and the content of message will be 

```javascript
{
  route: '/[locale]',
  pathname: '/[locale]',
  query: { inapp: '1', locale: 'test' },
  asPath: '/test?inapp=1',
  basePath: '',
  events: undefined,
  isFallback: false
}
```

inapp is used to set a global per session flag of whether or not to choose a different layout.

## Expected behavior

query and asPath should be availble with/without getInitialProps

## System information

- Latest of all packages in codesandbox",ijjk,kind: bug,2020-07-09T18:04:58Z,2020-07-10T03:16:03Z,Icehunter,Timer;Icehunter;balazsorban44,Timer,,Timer,,,
vercel/next.js,15026,"Build fails when using CSS grid-column shorthand syntax # Bug report

## Describe the bug

`next build` fails with error:
```
f.charCodeAt is not a function
```
if any of the CSS contains the following valid rule:
```
grid-column: span 2;
```

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Add offending style to any css file (global or module).
2. Run `next build`
4. See error

## Expected behavior

Builds successfully.

## System information

- OS: macOS Catalina 10.15.5
- Version of Next.js: 9.4.5-canary.30
- Version of Node.js: 12.16.1

## Additional context
This was working up to `next@9.4.5-canary.23`. The version after replaced an import of `cssnano-simple` from a local version to a npm published version. I have added additional details as an issue on that repository: https://github.com/Timer/cssnano-preset-simple/issues/6",Timer,kind: bug,2020-07-09T19:30:26Z,2020-08-04T04:08:10Z,vukers,4cm4k1;kush-agra;barinali;nicholaschiang;justincy;Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,1510,"Navigation in dev yields ""cannot read property call of undefined"" I got this error when upgrading next from beta 36 to 40, running my project with `yarn dev` and navigating from `/` to `/discover`.

<img width=""994"" alt=""screen shot 2017-03-26 at 20 04 16"" src=""https://cloud.githubusercontent.com/assets/4217871/24333383/96679346-125f-11e7-9e53-14de1c0e1e00.png"">

<img width=""614"" alt=""screen shot 2017-03-26 at 20 21 47"" src=""https://cloud.githubusercontent.com/assets/4217871/24333520/e8540de0-1261-11e7-9980-75b4362c5644.png"">

Here's the code on that line: 
```
modules[moduleId].call(module.exports, module, module.exports, hotCreateRequire(moduleId));
```

Project source code: https://github.com/relatenow/relate/tree/3c9212fac02c94a4c0c6e3f8425a8867f9feb75d

Deployment: https://relate-gqqbryqkoy.now.sh/",arunoda,kind: bug,2017-03-26T17:23:31Z,2017-03-26T20:38:56Z,sedubois,rauchg;ithinco;tz5514,arunoda,,arunoda,,rauchg,
vercel/next.js,15147,"Preview mode breaking datocms-next-js-blog-demo # Bug report

## Describe the bug

Unhandled Runtime Error
Error: Failed to load static props

When navigating to blog post routes the following error is shown:

<img width=""1070"" alt=""Error"" src=""https://user-images.githubusercontent.com/12905638/87390048-5a3aa280-c5eb-11ea-912e-010be3638e9c.png"">

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Setup repo as per readme
2. Navigate to blog post eg. http://localhost:3000/posts/mistakes-tourists-make-on-their-first-trip-abroad

## Expected behavior

Show blog page without error

## System information

- OS: macOS
- Version of Next.js: 9.4.4
- Version of Node.js: 12.18.1

## Additional context

If I comment out `preview` here it fixes the issue but can't use Preview Mode:

```
export async function getStaticProps({ params, preview }) {
  const data = await getPostAndMorePosts(params.slug, preview);
  const content = await markdownToHtml(data?.post?.content || """");

  return {
    props: {
      // preview,
      post: {
        ...data?.post,
        content,
      },
      morePosts: data?.morePosts,
    },
  };
}
```",Timer,kind: bug;good first issue,2020-07-14T06:09:14Z,2020-07-14T16:52:33Z,jahlherapath,rokinsky;Timer;balazsorban44,Timer,,Timer,Timer,Timer,
vercel/next.js,15194,"Investigate edge-case with `basePath` and `trailingSlash: true`: Something wrong going on when using `basePath` and `trailingSlash: true`:
Next/Link removes trailing slash when going to ""/""
And in some old browsers got error (which was not in `9.4.5-canary.27`)
```
Unhandled promise rejection,TypeError: t.entries is not a function
/_next/static/runtime/polyfills-35e39b6a0bf08dcb376c.js
```
Using `9.4.5-canary.34`

_Originally posted by @Unsfer in https://github.com/vercel/next.js/issues/15148#issuecomment-658731907_",Janpot,kind: bug,2020-07-15T16:50:53Z,2020-07-16T17:41:58Z,Timer,Janpot;Unsfer;Timer;marlonmarcello;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,15253,"Canary trailingSlash experimental feature first level paths # Bug report

## Describe the bug

Adding the trailingSlash feature causes first level paths to crash when deployed to Vercel. Deeper levels of paths works perfectly fine.

## To Reproduce

1. enable` trailingSlash: true`
2. Go to localhost:3000/firstlevel
3. You will be redirected to https://firstlevel/
4. It strips the entire host from the url

## Expected behavior

Should redirect to https://localhost:3000/firstlevel/

## System information

- OS: macOS
- Browser (if applies) Chrome
- Version of Next.js: 9.4.5-canary.36
- Version of Node.js: v12.14.0

",Timer,kind: bug;type: upstream,2020-07-17T09:14:17Z,2020-07-20T18:24:44Z,Joelgullander,timneutkens;Joelgullander;balazsorban44,timneutkens;Timer,Timer,Timer,,Timer,
vercel/next.js,15284,"Scope page-imported CSS module stylesheet to correct page when prefetched # Feature request
## Is your feature request related to a problem? Please describe.

When using CSS modules and creating stylesheets for pages to pass as props to components for overrides, those styles are not scoped to the page. When prefetched routes resolve and a new stylesheet is downloaded, those styles can beat out styles on the current page, causing all sorts of problems 棣冩У 

Repo: https://github.com/kylemh/test-css-page-issue
Deployment: https://test-css-page-issue.vercel.app/

## Describe the solution you'd like

I've spit-balled 3 ideas:

1. Make a route-named CSS class, wrapping each pages styles in that class ruleset, and then add `class=""route-named-class""` to the `__next` element.
2. A temporary fix would be to not prefetch the page's stylesheet if the page imports a stylesheet maybe, but that might make transitions look janky.
3. Ensure the current page's stylesheet is resolved last and popped off the top of the ""stack"" when route changes actually begin.

## Describe alternatives you've considered

If a solution can't be found, I'll likely need to wrap all my pages in a div just to define a [pageName] CSS class name to scope the selectors. It just sucks because it's hard to protect against this problem from other devs.

## Additional context

https://github.com/vercel/next.js/issues/13092#issuecomment-660374787
",Timer,kind: bug,2020-07-18T04:46:16Z,2020-08-21T15:15:33Z,kylemh,Timer;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,15342,"Next.js canary install emits warnings Running `yarn add next@canary` emits the following warnings:
```
warning ""next > @next/react-dev-overlay@9.4.5-canary.41"" has incorrect peer dependency ""webpack@^4|^5"".
warning ""next > @next/react-refresh-utils@9.4.5-canary.41"" has incorrect peer dependency ""webpack@^4|^5"".
```",timneutkens,kind: bug,2020-07-20T19:20:39Z,2020-07-21T17:33:26Z,Timer,balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,1537,"fs.unlink on Windows I'm trying to get Next.js (tried both 1.x and 2.x) running with IISNode on Windows, however, I get an error due to `fs.unlink()`. Unfortunately, I don't know much about how to actually *fix* the problem, and can't submit any more help other than an error, suspected problematic file, and a StackOverflow link I've ran across where others have found similar issues (with other libraries).

Error:
`(node:3788) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: EPERM: operation not permitted, unlink 'C:\Websites\BaseExpressSite\.next'`

Suspected problematic file:
https://github.com/zeit/next.js/blob/4b74c70cc9f55a19d4f8305214d2840186af0155/server/build/plugins/unlink-file-plugin.js#L19

StackOverflow ""Node.js fs.unlink causes EPERM error""
http://stackoverflow.com/questions/8496212/node-js-fs-unlink-function-causes-eperm-error

Thanks for creating a great, useful project and sharing it with everyone!",arunoda,kind: bug,2017-03-28T16:03:29Z,2017-06-12T17:38:03Z,DevanB,saulflores95;yuraxdrumz;arunoda;DevanB;msenevir;bufface,arunoda,,arunoda,,timneutkens,
vercel/next.js,15383,"Generating static pages even with no paths and fallback:false # Bug report

## Describe the bug

I have a simple blog app:

* Shows a list of posts in the homepage
* Then when clicked it shows the blog post

I have configured the `getStaticPaths` of the post page with following:

```js
export async function getStaticPaths () {
  return {
    paths: [],
    fallback: false
  }
}
```

Due to above, I expect to get 404 for blog posts. But they do give me correct static pages.

## To Reproduce

* Use this repo: https://github.com/arunoda/fallback-false-nextjs-demo
* `yarn build & yarn start`
* Visit home page
* Click a post
* Reload the post
* You can see that

## Expected behavior

The blog post should give us 404.

## Demo Video
https://www.youtube.com/watch?v=XqSqTwBa-N0

## System information

- OS: macOS
- Browser: Chrome
- Version of Next.js: canary (same behavior even with latest)
- Version of Node.js: [e.g. 12.x.x]

",Timer,kind: bug,2020-07-21T21:00:53Z,2020-08-20T17:59:05Z,arunoda,balazsorban44,Timer,,Timer,,,
vercel/next.js,15391,"Trailing slash route mismatch Hey guys, I think this is still an issue.
When using `trailingSlash: true` and `basePath: /dev` you get warnings on the console like so:
`Warning: Prop 'href' did not match. Server: ""/dev/second"" Client: ""/dev/second/""`.

Tried both ways:
```jsx
<Link href=""/second"">
  <a>Second Page</a>
</Link>
```

and 

```jsx
<Link href=""/second/"">
  <a>Second Page</a>
</Link>
```

next version `9.4.5-canary.42`

@Unsfer @Timer

_Originally posted by @marlonmarcello in https://github.com/vercel/next.js/issues/15194#issuecomment-662167808_",Janpot,kind: bug,2020-07-22T06:22:24Z,2020-07-26T10:22:14Z,Timer,Unsfer;Timer;timneutkens;balazsorban44;marlonmarcello;awareness481;Janpot,Timer,Timer,Timer,,timneutkens,vercel/next.js#15194;
vercel/next.js,15436,"Router prefetch does not resolve promise in development mode Sorry, it looks like it [does return a promise](https://github.com/jamesmosier/next.js/blob/54d991e6420d5493242a933037a8192ade0b53b8/packages/next/next-server/lib/router/router.ts#L819-L847) I was looking at the wrong `prefetch` method. 

But yes, omitting the `as` will cause a full page refresh. But `prefetch` only works in production so that is why you are seeing oddities. 

You'll see that there is a check for `NODE_ENV !== 'production'` below and that just returns, it does not resolve the promise

https://github.com/vercel/next.js/blob/e4e3ad38fd7cfc7dd5f72efd493d75a5b945c300/packages/next/next-server/lib/router/router.ts#L817-L820

_Originally posted by @jamesmosier in https://github.com/vercel/next.js/discussions/15431#discussioncomment-41264_",jamesmosier,kind: bug,2020-07-23T15:10:50Z,2020-07-25T04:36:44Z,Timer,Janpot;balazsorban44,Timer,,Timer,,,
vercel/next.js,15472,"Query params stripped on api routes # Bug report

## Describe the bug
Query params are not being passed through to API route correctly in production, even though API route is not statically optimised.

## To Reproduce
Visiting https://www.stkildapc.org/api/preview?secret=foo&slug=draft does not pass in {secret: 'foo', slug: 'draft'} to API route via request, instead it only produces an empty object. I have confirmed this by logging out the request.

The issue does not manifest in development, and behaviour is as expected (req.query is non-empty).

See source code here: https://github.com/NewFrontDoor/stkildapc-nextjs/blob/master/pages/api/preview.js 

## Expected behavior

req.query ought to contain the query parameters from the URL, rather than be empty.

## System information

- OS: Any
- Version of Next.js: 9.4.4
- Version of Node.js: 14.5.0

## Additional context

Please see the previous issue I raised and for some reason moved to 'discussion': https://github.com/vercel/next.js/discussions/15419",Timer,kind: bug;type: needs investigation,2020-07-25T12:02:40Z,2020-08-21T15:41:22Z,readeral,readeral;10xchs;Timer;sajadZmani;apoorvans;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,15477,"Experimental basePath causes a refresh on page navigation # Bug report

## Describe the bug

Using the experimental basePath feature causes a refresh while navigating with `<Link />`

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. `git clone git@github.com:lucas-janon/base-path-bug.git`
1. Install the dependencies and run the app
1. Go to http://localhost:3040/base-path-test/
1. Click on `Navigate to /test-b`
1. Wait for a few seconds (the page should get a refresh)

## Expected behavior

I expect the page not to be refreshed since it gets annoying to navigate multiple routes in development

## System information

- OS: macOS
- Browser: Chrome
- Version of Next.js: 9.4.4
- Version of Node.js: 12.18.0
",Timer,kind: bug,2020-07-25T22:16:02Z,2020-07-26T01:09:06Z,lucas-janon,juansalvatore;Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,15543,"Cannot test <Link> outside of a Page on Next v9.5.0 (Enzyme + Jest) # Bug report

## Describe the bug

As of Next v9.5.0, Components which use the `<Link>` component cannot be tested in isolation.  However, Pages which use `<Link>` can be tested fine.

## To Reproduce

With this component:

```tsx
// file: components/commonLink.tsx
import Link from ""next/link"";

export default function CommonLink() {
  return (
    <>
      <Link href=""/other/page"">
        <a>Click Me!</a>
      </Link>
    </>
  );
}
```

And this Test

```tsx
// file: __tests__/components/commonLink.tsx
import { mount } from ""enzyme"";
import Component from ""../../components/commonLink"";

describe(""navigation"", () => {
  let wrapper;

  beforeEach(() => {
    wrapper = mount(<Component />);
  });

  afterEach(() => {
    wrapper.unmount();
  });

  test(""renders"", async () => {
    const html = wrapper.html();
    expect(html).toContain('href=""/other/page"">Click Me</a>');
  });
});
```

Produce the error:

```
    Error: Uncaught [TypeError: Cannot read property 'pathname' of null]
        at reportException (/Users/evan/workspace/grouparoo/grouparoo/core/node_modules/jsdom/lib/jsdom/living/helpers/runtime-script-errors.js:62:24)
        at innerInvokeEventListeners (/Users/evan/workspace/grouparoo/grouparoo/core/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:333:9)
        at invokeEventListeners (/Users/evan/workspace/grouparoo/grouparoo/core/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:274:3)

...

        at Link (/Users/evan/workspace/grouparoo/grouparoo/core/node_modules/next/client/link.tsx:176:14)

...


    The above error occurred in the <Link> component:
        in Link (at commonLink.tsx:6)
        in CommonLink (created by WrapperComponent)
        in WrapperComponent

    Consider adding an error boundary to your tree to customize error handling behavior.
    Visit https://fb.me/react-error-boundaries to learn more about error boundaries.

      at logCapturedError (../node_modules/react-dom/cjs/react-dom.development.js:19527:21)
      at logError (../node_modules/react-dom/cjs/react-dom.development.js:19564:5)
      at update.callback (../node_modules/react-dom/cjs/react-dom.development.js:20708:5)
...
```

## Expected behavior

The test should pass

 In older versions of Next.js, this test passed.

## Screenshots

N/A

## System information

- OS: OSX
- Browser  N/A
- Version of Next.js: v9.5.0
- Version of Node.js: v12, v14
",ijjk,kind: bug,2020-07-27T23:36:00Z,2020-07-29T06:56:34Z,evantahler,evantahler;ijjk;Timer;stovmascript;Fi1osof;balazsorban44;gavinsharp;stefvhuynh;sagar-gavhane;djeusette;carloscuesta;thebuilder;iicdii,Timer;ijjk,Timer,ijjk,,,
vercel/next.js,15579,"[9.5] optional catch all routes req.query.params behavior is different when deployed on vercel (works in dev, works in 9.4.4) # Bug report

## Describe the bug

Hi, just tried to upgrade from 9.4.4 to 9.5.0. I was previously using the experimental `optionalCatchAll` flag. On 9.5.0 my optional catch-all routes are working in dev mode (next dev) but no more working when deployed on Vercel.

The issue is that req.query.params value is different between Vercel and dev mode when using optional catch-all routes.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

Given a project structure of:

```
- project
- api/
- api/organizations/
- api/organizations/[organizationId]
- api/organizations/[organizationId]/teams/
- api/organizations/[organizationId]/teams/[[...params]].js
```

When calling `https://example.com/organizations/200/teams` on vercel (9.5.0):
- `req.query.params` value: `[""""]`

When calling `https://localhost/organizations/200/teams` on `next dev` (9.5.0):
- `req.query.params` value: `undefined`

When calling `https://example.com/organizations/200/teams` on vercel (9.4.4):
- req.query.params value: `undefined`

When calling `https://localhost/organizations/200/teams` on `next dev` (9.4.4):
- req.query.params value: `undefined`

## Expected behavior

Both vercel and `next dev` should send the same value for req.query.params, maybe sticking to `undefined` or anything else that makes sense given current APIs.

## System information

- OS: macOS
- Version of Next.js: 9.5.0
- Version of Node.js: 12.8.3

## Additional context

n/a
",Timer;ijjk,kind: bug,2020-07-28T14:23:00Z,2021-03-02T19:51:53Z,vvo,Janpot;NBruhno;stevez86;Timer;vvo;ijjk;balazsorban44,Timer;ijjk,,Timer,Timer,ijjk,
vercel/next.js,15580,": or * in header value crash site. Lexer skips out. # Bug report
`next.config.js` header configuration
```
async headers () {
    return [{
      source: '/:path*',
      headers: [{
        key: 'Content-Security-Policy',
        value: 'default-src https:',
      }]
}
```

results in 
```
Missing parameter name at 172
/node_modules/next/dist/compiled/path-to-regexp/index.js:47:23
```
when accessing site

## Describe the bug
The : or * characters in header value seem to bug the lexer

## Expected behavior
Header should be set as described

## System information
- Version of Next.js: 9.5.0",ijjk,kind: bug,2020-07-28T14:53:48Z,2020-07-29T08:47:24Z,serrynaimo,Timer;balazsorban44,Timer;ijjk,,Timer,Timer,,
vercel/next.js,15585,"Fix new flaking test ## Failing test suites <!--974603495-->
Commit: aa5d9f71b38da90b1597e571dd50703de69fa91b

**test/integration/error-is-clickable/test/index.test.js** 
- Clickable error link > Shows error which is clickable and redirects

<details>
<summary>Expand output</summary>

  閳 Clickable error link 閳 Shows error which is clickable and redirects

    JavascriptError: javascript error: Cannot read property 'click' of null
      (Session info: headless chrome=84.0.4147.89)

      22 |     const browser = await webdriver(appPort, '/first')
      23 | 
    > 24 |     await browser.eval(`(function () {
         |     ^
      25 |           document.querySelector(""nextjs-portal"")
      26 |           .shadowRoot
      27 |           .querySelector(""#nextjs__container_errors_desc > a"").click()

      at Object.throwDecodedError (../node_modules/selenium-webdriver/lib/error.js:550:15)
      at parseHttpResponse (../node_modules/selenium-webdriver/lib/http.js:565:13)
      at Executor.execute (../node_modules/selenium-webdriver/lib/http.js:491:26)
      at thenableWebDriverProxy.execute (../node_modules/selenium-webdriver/lib/webdriver.js:700:17)
      at Object.<anonymous> (integration/error-is-clickable/test/index.test.js:24:5)

  閳 Clickable error link 閳 Shows error which is clickable and redirects

    thrown: ""Exceeded timeout of 300000 ms for a test.
    Use jest.setTimeout(newTimeout) to increase the timeout value, if this is a long-running test.""

      19 |   afterAll(() => killApp(app))
      20 | 
    > 21 |   it('Shows error which is clickable and redirects', async () => {
         |   ^
      22 |     const browser = await webdriver(appPort, '/first')
      23 | 
      24 |     await browser.eval(`(function () {

      at integration/error-is-clickable/test/index.test.js:21:3
      at Object.<anonymous> (integration/error-is-clickable/test/index.test.js:12:1)

</details>

_Originally posted by @ijjk in https://github.com/vercel/next.js/pull/14197#issuecomment-665085730_",ijjk,kind: bug,2020-07-28T16:03:26Z,2020-07-29T06:38:14Z,Timer,darshkpatel;balazsorban44,Timer;ijjk,,ijjk,,,
vercel/next.js,15589,"Invalid CSS comment breaks build since 9.5.0 # Bug report

## Describe the bug

Since 9.5.0 invalid CSS comments starting with `//` will break the build with an opaque error:

```
Failed to compile.

Error: Unexpected '/'. Escaping special characters with \ may help.


> Build error occurred
Error: > Build failed because of webpack errors
    at build (/home/joris/Projects/next-css-crash-repro/node_modules/next/dist/build/index.js:15:918)
```

## To Reproduce

[Example repo](https://github.com/GriffinSauce/next-css-crash-repro/) - just `yarn install` and `yarn build`

[The offending comments](https://github.com/GriffinSauce/next-css-crash-repro/blob/master/styles/globals.css) in said repo.

## Expected behavior

Before 9.5.0 this did not cause a crash. It's fair to say that it should but then the error should include a stack trace or at least point to a file / loader because at the moment the above error says nothing about the location or the nature of the problem.

In the end I had to go to a process of elimination to find the issue which is obviously not great.

## System information

- OS: macOS / Ubuntu
- Version of Next.js: 9.5.0
- Version of Node.js: 12.17.0
",Timer;ijjk,kind: bug;type: upstream,2020-07-28T16:42:16Z,2020-11-14T15:03:05Z,GriffinSauce,balazsorban44,Timer,Timer,Timer,Timer,,
vercel/next.js,15616,"9.5.0 introduced compile error / breaks when using the pnpm package manager # Bug report
Upgrading a hello world project from 9.4.4 to 9.5.0 when using pnpm introduces a compile error for next build (see below)

## To Reproduce

install pnpm on your system.

clone example repo https://github.com/bitfrost/example_pnpm_next_issue
cd into repo

run:

pnpm install
pnpm next build

Get 
> next ""build""

Creating an optimized production build

Compiled successfully.

Automatically optimizing pages ..
Error occurred prerendering page ""/404"". Read more: https://err.sh/next.js/prerender-error
Error: Minified React error #321; visit https://reactjs.org/docs/error-decoder.html?invariant=321 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
    at Z (/Users/kobrien/dev/nx-5/.next/server/pages/_document.js:1028:404)
    at module.exports.mbhs.exports.useContext (/Users/kobrien/dev/nx-5/.next/server/pages/_document.js:1033:261)
    at Html (/Users/kobrien/dev/nx-5/.next/server/pages/_document.js:257:29)
    at d (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:36:498)
    at $a (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:39:16)
    at a.b.render (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:44:476)
    at a.b.read (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:44:18)
    at renderToStaticMarkup (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:54:462)
    at renderDocument (/Users/kobrien/dev/nx-5/node_modules/.pnpm/next@9.5.0_react-dom@16.13.1+react@16.13.1/node_modules/next/dist/next-server/server/render.js:3:594)
    at renderToHTML (/Users/kobrien/dev/nx-5/node_modules/.pnpm/next@9.5.0_react-dom@16.13.1+react@16.13.1/node_modules/next/dist/next-server/server/render.js:47:72)

Error occurred prerendering page ""/"". Read more: https://err.sh/next.js/prerender-error
Error: Minified React error #321; visit https://reactjs.org/docs/error-decoder.html?invariant=321 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
    at Z (/Users/kobrien/dev/nx-5/.next/server/pages/_document.js:1028:404)
    at Object.module.exports.mbhs.exports.useState (/Users/kobrien/dev/nx-5/.next/server/pages/_document.js:1034:277)
    at Link (/Users/kobrien/dev/nx-5/.next/server/pages/index.js:1975:50)
    at d (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:36:498)
    at $a (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:39:16)
    at a.b.render (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:44:476)
    at a.b.read (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:44:18)
    at renderToString (/Users/kobrien/dev/nx-5/node_modules/.pnpm/react-dom@16.13.1_react@16.13.1/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:54:364)
    at Object.renderPage (/Users/kobrien/dev/nx-5/node_modules/.pnpm/next@9.5.0_react-dom@16.13.1+react@16.13.1/node_modules/next/dist/next-server/server/render.js:45:686)
    at Function.getInitialProps (/Users/kobrien/dev/nx-5/.next/server/pages/_document.js:222:19)

> Build error occurred
Error: Export encountered errors on following paths:
	/
	/404
    at exportApp (/Users/kobrien/dev/nx-5/node_modules/.pnpm/next@9.5.0_react-dom@16.13.1+react@16.13.1/node_modules/next/dist/export/index.js:24:1103)
    at processTicksAndRejections (internal/process/task_queues.js:97:5)
    at async build (/Users/kobrien/dev/nx-5/node_modules/.pnpm/next@9.5.0_react-dom@16.13.1+react@16.13.1/node_modules/next/dist/build/index.js:37:218)
Automatically optimizing pages .閳ュ僐ROR閳 Command failed with exit code 1.


Move dependency to ""next"": ""9.4.4"" in package.json

repeat:

pnpm install
pnpm next build

project works and builds

## Expected behavior

pnpm and be used with a minimal next.js app 


## System information

- OS: macos

- Version of Next.js: 9.5.0
- Version of Node.js: 12.6.3

",Timer,kind: bug,2020-07-29T00:58:48Z,2020-07-29T23:16:06Z,bitfrost,IanMitchell;bitfrost;zkochan;elliottsj;keyworks;theprobugmaker;balazsorban44;Timer,Timer,Timer,ijjk;Timer,Timer,Timer,
vercel/next.js,15626,"Rewrite adds query param when re-appending a matched path param to the destination # Bug report

## Describe the bug

A rewrite from `/source/:route*` to `http://my-api-server.example.org/destination/:route*` forwards a request sent to `/source/foo` to `http://my-api-server.example.org/destination/foo?route=foo`. The extra query param will lead to issues especially with API servers as in REST this might represent a filter criteria.
## To Reproduce

1. Create a new next app

2. Create a custom next.config.js:

```js
module.exports = {
  async rewrites() {
    return [
      {
        source: ""/api/:route*"",
        destination: ""https://postman-echo.com/:route*"",
      },
    ];
  },
};

```

3. Start next: `yarn next dev`

4. Open up `http://localhost:3000/api/get`

5. The results includes `""url"":""https://postman-echo.com/get?route=get""`

## Expected behavior

Params that are added to the destination path should not be included as a query param.

5. The results includes `""url"":""https://postman-echo.com/get""`

## Screenshots

n/a

## System information

- Version of Next.js: 9.5.0
- Version of Node.js: n/a

## Additional context

n/a
",ijjk,kind: bug,2020-07-29T10:55:09Z,2020-08-14T18:51:59Z,sventschui,mAAdhaTTah;ijjk;pratheekhegde;a-axton;balazsorban44,Timer;ijjk,Timer;ijjk,Timer,,,vercel/next.js#15700;
vercel/next.js,15700,"Trailing slash + rewrites results in unintuitive behavior and/or unproxied pages # Bug report

## Describe the bug

I'm migrating off a system that currently uses trailing slashes. To maintain consistency, we've enabled tailing slashes in our Nextjs app. I've added the rewrites as per the docs, but we're getting some unexpected behavior, depending on the configuration we chose.

## To Reproduce

Configure your Nextjs app as per the docs with `trailingSlash: true`:

```js
    trailingSlash: true,
    async rewrites() {
      return [
        // check if Next.js project routes match before we attempt proxying
        {
          source: '/:path*',
          destination: '/:path*',
        },
        {
          source: '/:path*',
          destination: `${process.env.WEB_PROXY_TARGET}/:path*`,
        },
      ];
    },
```

With the configuration this way, all non-Nextjs pages 404. Nothing seems to be proxied correctly.

I then attempted including trailing slashes on everything:

```js
    trailingSlash: true,
    async rewrites() {
      return [
        // check if Next.js project routes match before we attempt proxying
        {
          source: '/:path*/',
          destination: '/:path*/',
        },
        {
          source: '/:path*/',
          destination: `${process.env.WEB_PROXY_TARGET}/:path*/`,
        },
      ];
    },
```

This _almost_ works. Most pages are rendered correctly, except one, which may be specific to the pages I have:

```
pages
|____products
  |____index.js
  |____[path].js
```

With the second configuration, the `/products/` gets proxied, rather than rendered by Nextjs.

I have attempted a number of combinations of this, none of them working exactly right. I'm happy to try out additional combos in my local if you'd like.

## Expected behavior

Proxying should work correctly.

## System information

- Version of Next.js: v9.5.1
- Version of Node.js: v12",ijjk,kind: bug,2020-07-30T17:45:26Z,2020-08-20T04:05:39Z,mAAdhaTTah,mAAdhaTTah;Timer;balazsorban44,Timer;ijjk,ijjk,Timer,,,
vercel/next.js,15704,"Links from non-AMP pages to AMP pages causes broken pages # Bug report

## Describe the bug

So, the problem I reported in https://github.com/vercel/next.js/issues/11521 has essentially resurfaced again.

## To Reproduce

Clone https://github.com/kevva/next-app-issue and do the following:

1. Run `npm run dev`
2. Click on the ""Test"" link and then on the ""Home"" link again
3. The image on the start page is gone (notice that it tries to load the bundle for the page)",ijjk,kind: bug,2020-07-30T18:25:25Z,2020-08-17T17:24:19Z,kevva,kevva;balazsorban44,Timer,,Timer,,,
vercel/next.js,15713,"Crashes deploying to Vercel using Next.js 9.5.0/9.5.1 # Bug report

## Describe the bug

Getting the following crash deploying to Vercel using Next.js 9.5.0 and 9.5.1. This works as expected using Next.js 9.4.4. Also, 9.5.0 and 9.5.1 work fine locally. 
```
12:06:01.769 | TypeError: Cannot read property 'filter' of undefined
-- | --
12:06:01.769 | at NextScript.getPolyfillScripts (/vercel/5c3be1a5/packages/sh-www/.next/serverless/pages/_error.js:649:26)
12:06:01.769 | at NextScript.render (/vercel/5c3be1a5/packages/sh-www/.next/serverless/pages/_error.js:750:75)
12:06:01.769 | at d (/vercel/5c3be1a5/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:38:231)
12:06:01.769 | at $a (/vercel/5c3be1a5/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:39:16)
12:06:01.769 | at a.b.render (/vercel/5c3be1a5/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:44:476)
12:06:01.770 | at a.b.read (/vercel/5c3be1a5/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:44:18)
12:06:01.770 | at renderToStaticMarkup (/vercel/5c3be1a5/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:54:462)
12:06:01.770 | at renderDocument (/vercel/5c3be1a5/node_modules/next/dist/next-server/server/render.js:3:594)
12:06:01.770 | at renderToHTML (/vercel/5c3be1a5/node_modules/next/dist/next-server/server/render.js:47:72)
12:06:01.770 | at async renderReqToHTML (/vercel/5c3be1a5/packages/sh-www/.next/serverless/pages/_error.js:2188:22)
12:06:01.771 | Error occurred prerendering page ""/404"". Read more: https://err.sh/next.js/prerender-error
```

## To Reproduce

Deploy to Vercel using Next.js 9.5.0 or 9.5.1

## Expected behavior

Deploy succeeds 

",ijjk,kind: bug,2020-07-30T20:48:44Z,2020-07-31T15:17:15Z,jknight12882,ijjk;jknight12882;balazsorban44,ijjk;Timer,ijjk,ijjk,,,
vercel/next.js,15744,"variables expanded multiple times in .env # Bug report

## Describe the bug

When I add environment variables containing `$` in .env, Next.js parse them multiple times as variable(`$var`) and they would be empty

## To Reproduce
1. write this into `.env`
  ```env
  A=
  ```
2. write this into `.env.local`
  ```env
  A=\$foo
  ```
3. `process.env.A` appears to be `''`

## Expected behavior

`process.env.A` should be `'$foo'`

## System information

- OS: Manjaro Linux 20.0.3 (Kernel 5.4.52)
- Vivaldi
- Version of Next.js: 9.4.4
- Version of Node.js: 14.5.0

## Additional context

Reading source code, the problem seems to be caused by [dotenv-expand](https://github.com/vercel/next.js/blob/master/packages/next/compiled/dotenv-expand/main.js).
The library rewrites process.env.
However, I think its behavior is right, so I report a bug here.
",ijjk,kind: bug;good first issue,2020-07-31T15:42:58Z,2020-08-02T20:15:12Z,ibuki2003,Timer;balazsorban44,Timer;ijjk,,ijjk,,,
vercel/next.js,15747,"Inconsistent url (prefetch/fetch) for .json data file on link click (next/link) when using SSG + basePath # Bug report

## Describe the bug

Using both SSG and basePath, when next.js tries to get the .json data file that corresponds to the page data (instead of doing full reload), the url that is fetched does not correspond to the location where the file has been physically generated during build/export

## To Reproduce

1. clone: https://github.com/oecd/next-link-basepath-bug
2. npm install
3. npm run build-n-export
4. host the content of the ""out"" folder so that app is served from ""/folder"" by any random web server
5. browse http://localhost/folder/home
6. check network tab: http://localhost/folder/_next/data/xxxxxx/another-page.json gives 200
7. click on the ""go to another page.."" link
8. check network tab: http://localhost/folder/_next/data/xxxxxx/folder/another-page.json gives 404

...so a full reload occurs.

It should be noted that using next.js server (npm run start), the inconsistency in urls are still there but both urls give 200!
There must be some magic somewhere! ;)

## Expected behavior

Both prefetch and fetch should use the same url and that url should correspond to the location where the files are generated.

## System information

- OS: Windows
- Browser: all
- Version of Next.js: 9.5.0

## Additional context

I was already using basePath when it was ""experimental"" without any problem.
",ijjk,kind: bug,2020-07-31T16:05:44Z,2020-08-17T15:25:37Z,bertrand-riviere,ZinoKader;bertrand-riviere;ijjk;balazsorban44,Timer;ijjk,,Timer,,,
vercel/next.js,15755,"When using rewrites, client asPath is sliced by the basePath's length even when basePath config is false # Bug report

## Describe the bug

We're trying to implement `basePath` in our repo and it works until we want to exclude any paths using `rewrites` in our config. When using `rewrites` we find that `asPath` is shortened by the `basePath`'s length even though we've set `basePath` to `false`. It appears that `asPath` works correctly on server, but not on the client.

## To Reproduce

Using the following config, visit `/diets` and see `asPath` is ""ts"" instead of the expected ""/diets"". Tried with both `/web/diets` and `/diets` as `destination`, both produce the same problem.

```
// next.config.js

basePath: '/web',
rewrites: () => [
  {
    source: '/diets',
    destination: '/diets',
    basePath: false,
  }]
```

## Expected behavior

I expect the `asPath` to be ""/diets""

See this file: 

Line 41: `packages/next/next-server/lib/router/router.ts` <-- method that's slicing `asPath`
Line 64: `packages/next/client/index.js` <-- client does not check the config for `basePath` before slicing `asPath`

## Screenshots

![image](https://user-images.githubusercontent.com/26289936/89082847-11e9e700-d344-11ea-94f9-3081ee294f93.png)

## System information

- Version of Next.js: 9.5.0
- Version of Node.js: 12.16.0

## Additional context

Add any other context about the problem here.
",Janpot,kind: bug,2020-07-31T22:40:18Z,2020-08-02T05:11:56Z,tonycassara,tonycassara;Timer;sallomendo;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,15820,"Dynamic route segment with full URL as asPath produces error. # Bug report
Dynamic route segment with full path as asPath produces error.

## Describe the bug
Dynamic route segment with full path as asPath produces error.

## To Reproduce
Sandbox: https://codesandbox.io/s/epic-star-930zq

1. Go to https://930zq.sse.codesandbox.io/days
2. Click on day one, day two is working.
3. Clicking on day three, day four is not working due to having full URL as asPath: https://codesandbox.io/s/epic-star-930zq
4. See error

## Expected behavior
All links should work

## System information
- Version of Next.js: 9.5.1
",Janpot,kind: bug,2020-08-03T09:04:00Z,2020-08-05T18:12:19Z,rashidul0405,Timer;rashidul0405;balazsorban44,Timer,,Timer,,,
vercel/next.js,1587,"Creating `components` folder not making effect until server restart STR:

1. Create new next.js app
2. Run the dev server
3. Create `components` folder and some component
4. Use it in the page

Expected:
Component wires up into the page

Actual:
```
Error in edit/pages/index.js?entry
Module not found: Error: Can't resolve '../components/Header' in 'edit/pages'
ModuleNotFoundError: Module not found: Error: Can't resolve '../components/Header' in 'edit/pages'
    at factoryCallback (edit/node_modules/webpack/lib/Compilation.js:260:39)
    at edit/node_modules/webpack/lib/NormalModuleFactory.js:243:19
    at onDoneResolving (edit/node_modules/webpack/lib/NormalModuleFactory.js:59:20)
    at edit/node_modules/webpack/lib/NormalModuleFactory.js:132:20
    at edit/node_modules/async/dist/async.js:3799:9
    at edit/node_modules/async/dist/async.js:360:16
    at iteratorCallback (edit/node_modules/async/dist/async.js:934:13)
    at edit/node_modules/async/dist/async.js:844:16
    at edit/node_modules/async/dist/async.js:3796:13
    at apply (edit/node_modules/async/dist/async.js:21:25)
```

The component works fine after a dev server restart.",arunoda,kind: bug,2017-04-01T12:37:01Z,2018-03-16T12:33:07Z,Flamefork,zigzactly;aranajhonny;timneutkens;eezing;Neorama;sergiodxa,arunoda,,arunoda,,timneutkens,
vercel/next.js,15879,"Vercel deployments include query string in `asPath` ![image](https://user-images.githubusercontent.com/616428/89336872-10802d80-d668-11ea-802a-28f418a25b45.png)

Reproduction:
https://github.com/MJHLS/slug-test

https://slug-test.vercel.app/yeet",ijjk,kind: bug,2020-08-04T19:36:19Z,2020-08-05T19:29:39Z,Timer,balazsorban44,Timer;ijjk,,ijjk,,,
vercel/next.js,15904,"getServerSideProps not called when exported for multiple pages. # Bug report

## Describe the bug

When a common react component is exported from multiple pages, `getServerSideProps` is not called except when revisiting the page that the component was initially visited.

## To Reproduce
Repository Structure
```
pages
   - index.ts
   - home.ts
views
   Home.tsx
```

index.ts __AND__ home.ts
```
export * from '../views/Home';
export { default } from '../views/Home';
```

Home.tsx
```
import { NextPage, GetServerSidePropsContext, GetServerSidePropsResult } from 'next';
import Link from 'next/link';

interface HomeCubeProps {
	name: string;
	description: string;
}

export interface HomeProps {
	words: HomeCubeProps[];
}

const Home: NextPage<HomeProps> = (props: HomeProps) => {
	return (
		<div>
			<Link href=""/"">
				<a>Root</a>
			</Link>
			<Link href=""/home"">
				<a>Home</a>
			</Link>
			User Home.
			<div>
				{props.words.map((cube) => {
					return <div key={cube.name}>{cube.description}</div>;
				})}
			</div>
		</div>
	);
};

export async function getServerSideProps(
	context: GetServerSidePropsContext
): Promise<GetServerSidePropsResult<HomeProps>> {
	return {
		props: {
			words: [
				{
					name: 'big cube',
					description: 'These are words'
				},
				{
					name: 'little cube',
					description: 'These are more words'
				}
			]
		}
	};
}

export default Home;
```

1. Start Next.js (Dev or Prod)
2. Navigate to `localhost:3000` or `localhost:3000/home`
3. Click root if you're at `/home`, click home if you're at `/`.
4. Error because getServerSideProps is not providing props.

## Expected behavior

I expected getServerSideProps to be called for all pages that this component is exported.

## System information

- OS: Windows
- Browser (if applies) Chrome and Edge (Chromium)
- Version of Next.js: 9.4.4
- Version of Node.js: 12.18.3

",Timer,kind: bug,2020-08-05T14:40:08Z,2020-08-05T20:21:41Z,MRobertEvers,MRobertEvers;Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,15916,"Regression of #14740 # Bug report

## Describe the bug

The work in #14740 has caused a bug when a page errors on the server side

```
Uncaught TypeError: Cannot read property 'statusCode' of undefined
    at Object.fLxa (index.js:60)
    at t (bootstrap:86)
    at Object.LwBP (next.js:1)
    at t (bootstrap:86)
    at c (bootstrap:45)
    at Array.a [as push] (bootstrap:32)
    at 84f3b8c7222dd2225c268a644154c5ba8e99769e.f6885231c259f16e58e7.js:1
```

Inspecting the error it's happening with:

```
if (
  page !== '/404' &&
  !(
    page === '/_error' &&
    hydrateProps &&
    hydrateProps.pageProps.statusCode === '404'
  )
) {
  asPath = delBasePath(asPath)
}
```
Namely `hydrateProps` does not have a `pageProps` at this moment. All it has is `initialProps`, `initialState` and `isServer`

`pageProps` should be prefixed with `initialProps`

EG the full line should be

`hydrateProps.initialProps.pageProps.statusCode === '404'`

## To Reproduce

Generate an error server side.

```
function App() {
	const [s, setS] = useState({});
	const z = useMemo(
		() => ({
			a: s.g.h, //.h is not defined
		}),
		[s.g.h]
	);
```

## Expected behavior

Should not throw an exception here

## Screenshots
![image](https://user-images.githubusercontent.com/564256/89461991-9c09c500-d721-11ea-972d-ed488eed3346.png)

## System information

- OS: macOS
- Version of Next.js: 9.5.1
- Version of Node.js: 12.18.2
",Janpot,kind: bug;please add a complete reproduction;type: needs investigation,2020-08-05T20:44:17Z,2020-08-05T20:59:11Z,tm1000,Timer;tm1000;balazsorban44,Timer,,Timer,Timer,tm1000,
vercel/next.js,15940,"Serverless wrapper error Trying this out, I got the following error on a non-dynamic route page:

```
defaultRouteRegex is not defined
```

![image](https://user-images.githubusercontent.com/709159/89506290-2f4b0500-d7cb-11ea-8775-d5aa4bf28eef.png)

_Originally posted by @kevva in https://github.com/vercel/next.js/pull/15914#issuecomment-669774302_",ijjk,kind: bug,2020-08-06T14:31:07Z,2020-08-07T07:01:35Z,Timer,balazsorban44,Timer;ijjk,,ijjk,,timneutkens,
vercel/next.js,15972,"Browser does not set preview mode cookies even though they are present in the response headers. (Only in production mode!) # Bug report

## Describe the bug

I have a preview.js file in my api/pages folder which calls 

`res.setPreviewData({});
  res.end();`

This works in development (starting the server with the ""next"" command and open up 'api/preview' in a browser), I get a Set-Cookie header from the server, and the browser successfully stores the cookie and context.preview is true in getStaticProps().

However, when I make a production build (next build && next start), the browser will not save the cookie. My api/preview route still returns a Set-Cookie header, though. 

Am I misunderstanding how this is supposed to work? This could seem to have nothing to do with Next.js, considering that the headers are set correctly. Any ideas on what might cause this?

## To Reproduce

1. Clone https://github.com/mskutle/next-preview-bug-reproduction
2. npm install
3. npm run build && npm start
4. go to http://localhost:3000/api/preview
5. Inspect cookies in browser

## Expected behavior

I expected the cookies to be set exactly like in development mode.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- OS: macOS Catalina 10.15.6
- Browser: Happens in Chrome, Safari & Edge (haven't tried other browsers, assuming the same behavior)
- Version of Next.js: 9.5.1
- Version of Node.js: 12.18.1



",Timer,kind: bug,2020-08-07T12:55:52Z,2020-08-18T06:12:24Z,mskutle,Timer;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,16020,"Preview mode pages can be accessed publicly ## Description
I have a post in draft, path for which is `/posts/id`. I want for rebuild it on request since data is new.
So I made it a preview url using preview mode feature. Now the url is `/api/preview?secret=token&slug=/posts/id`.
Now when I make this request this page is generated and stored on disk and any one with url `/posts/id` can visit this.

## To Reproduce

Steps to reproduce

This sandbox is not working because it says res.redirect is not a function (which we can ignore) but  you can see code or  check [repo](https://github.com/contactyash/nextjs-bug) also.

 Go to [this sandbox](https://codesandbox.io/s/epic-babbage-03z7h?file=/pages/api/preview.js) and check

## Expected behavior
I am no expert but I think it should not write preview pages on disk, it should serve them from memory. when someone visit `/posts/id` it should return 404.


## System information

- OS [ Windows]
- Version of Next.js: [lates]
",ijjk,kind: bug,2020-08-09T14:13:54Z,2020-08-26T11:07:33Z,kyashrathore,biiishal;kyashrathore;ijjk;balazsorban44,Timer;ijjk,,Timer,,,
vercel/next.js,16028,"Navigating Between Dynamic Routes with Browser Back Button Breaks After Shallow Routing # Bug report

## Describe the bug

I have a `/movie/[movieId]` page. It has `getServerSideProps` function for SEO purposes and fetches base movie info at server-side. In this page, there is an image list and when you click an image it opens a modal by adding a query string like `?view=/xXBnM6uSTk6qqCf0SRZKXcga9Ba.jpg`. To prevent unnecessary SSR, I use shallow routing like this:
```ts
const query = { view: ""/xXBnM6uSTk6qqCf0SRZKXcga9Ba.jpg"" };
router.push(
   pathname: ""/movie/[movieId]"", query },
   pathname: `/movie/${movie.id}`, query },
   { shallow: true },
);
```
and when user closes the modal, it routes to the movie page like this:
```ts
const query = {  };
router.push(
   pathname: ""/movie/[movieId]"", query },
   pathname: `/movie/${movie.id}`, query },
   { shallow: true },
);
```
After that, user clicks another movie and navigates to its page (without shallow routing). Still no problem. But when we go back with browser's back button, `getServerSideProps` is not called, so we have the movie info from the previous movie (before clicking the back button).

At client-side, `router` has the right params etc, so I can check if the id of data from SSR and `router`'s current `movieId` are same or not and then fetch proper info at client-side. But it adds a little bit of overhead for more complex scenarios. Another solution is, when I disable shallow routing for closing the modal, there is no problem too but it ends up with unnecessary SSR.

I've seen similar issues but many of them were about `getInitialProps` and I'm not sure if they were a match for this issue.

Thanks for your hard work and thanks for this great framework!

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to https://tmdb-explorer.vercel.app/movie/516486
2. Scroll a bit down, get to ""Images"" section.
3. Click one of the images. It will open a modal for viewing the selected image (with shallow routing).
4. Click close button at the top right of the screen. This will trigger a shallow routing too.
5. There is ""Recommendations"" section at the right (or at the bottom if you are on a small device). Click one of the movies. Wait for new page to load. (This is not shallow routing.)
6. Click back button of your browser.
7. Now we have the previous movie's info at the top of screen. Title, genres, overview, poster etc. Videos and Recommendations are proper. Because they are fetched at client-side with current `movieId` param. But ""Images"" list is wrong too. Because it depends on the fetched movie info.

Note: I use `swr` for client-side data fetching. So, if you unfocus and focus back to that browser tab, it will fetch the proper movie info at client-side. Of course you already know that, `swr` is one of your own packages, but if you unfocus/focus to follow these steps, the error may not occur. So, I wanted to point it out anyway.

Repository: https://github.com/onderonur/tmdb-explorer
Note: This repo needs an API key from TMDb API, so if you want I can try to create a much simpler repo with dummy data etc.

## Expected behavior

The last routing before we click the browser's back button is not shallow. So, I guess the back button should not trigger a shallow routing like here. Removing `shallow: true` solves this of course, but it may be hard to keep everything in place for much complex scenarios and it results in unnecessary SSR.  Or if this is not a proper usage for shallow routing, please add its right usages etc to the docs. Docs are already great but if this is some expected behavior and there are recipes for this kind of scenarios, that would be absolutely helpful.

## System information

- OS: Windows 10
- Browser: Chrome Version 84.0.4147.105 (Official Build) (64-bit)
- Version of Next.js: 9.5.2
- Version of Node.js: 12.18.0

",ijjk,kind: bug,2020-08-09T23:05:12Z,2020-08-22T21:51:16Z,onderonur,balazsorban44,Timer;ijjk,ijjk,Timer,,,
vercel/next.js,16064,"Preloading in purely static sites causes duplicate requests (increasing payload) and produces an error in light house # Bug report

## Describe the bug

Preloading in purely static sites causes duplicate requests (increasing payload) and produces an error in light house. This happens when using the Link component (importing from ""next/link""). If I create navigation links with the standard `<a href=""..."">..</a>` it bypasses this error but also stops preloading.


## To Reproduce

Create ""Navigation"" component with Link tags and add it to page after <Head> component.

sample Link tag in navigation.js component:
```

import Link from ""next/link"";
...
           <Link href=""/"">
            <a>Home</a>
          </Link>
...
```

index.js:

```
...

<Navigation />

....
```

Using light house report or page speed insights reveals payload error and also shows that the HTTP requests are being duplicated therefore the network payload is double what it should be.

`A preload <link> was found for ""......_next/static/chunks/.......js"" but was not used by the browser. Check that you are using the `crossorigin` attribute properly.`


## Expected behavior

No payload error and no duplication of requests (no unnecessary duplication of network payload)



## System information

- OS: macOS
- Browser: chrome
- Version of Next.js: Next.js v9.5.2
- Version of Node.js: v12.18.3


",Timer,kind: bug,2020-08-11T06:09:53Z,2020-08-18T06:18:17Z,Nou-r,timneutkens;Nou-r;Timer;JimmyGray;balazsorban44,timneutkens;Timer,timneutkens,timneutkens,,Timer,
vercel/next.js,16076,"`@vercel/next` matches exact route match for dynamic pages # Bug report

## Describe the bug

`@vercel/next` matches exact paths for dynamic routes, successfully invoking a lambda when the page is meant to be static.

## To Reproduce

[View success instead of 404 here](https://test-direct-access.vercel.app/test/[slug]).

https://test-direct-access.vercel.app/_src

```
閴 httpstat https://test-direct-access.vercel.app/test/[slug]

Connected to 76.76.21.21:443

HTTP/2.0 200 OK
Server: Vercel
Age: 0
Cache-Control: public, max-age=0, must-revalidate
Content-Type: text/html; charset=utf-8
Date: Tue, 11 Aug 2020 14:05:05 GMT
Strict-Transport-Security: max-age=63072000; includeSubDomains; preload
X-Nextjs-Page: /test/[slug]
X-Vercel-Cache: MISS
X-Vercel-Id: cle1::sfo1::lhkc7-1597154704606-04600048d451

Body discarded

  DNS Lookup   TCP Connection   TLS Handshake   Server Processing   Content Transfer
[      1ms  |          36ms  |        196ms  |            811ms  |             6ms  ]
            |                |               |                   |                  |
   namelookup:1ms            |               |                   |                  |
                       connect:38ms          |                   |                  |
                                   pretransfer:235ms             |                  |
                                                     starttransfer:1047ms           |
                                                                                total:1053ms  
```

## Expected behavior

The page should 404.",ijjk,kind: bug;area: Routing,2020-08-11T14:06:02Z,2022-02-03T18:31:20Z,Timer,ijjk,Timer;timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,16103,"Fast refresh disabled warning with react experimental version Error: https://github.com/vercel/next.js/blob/master/errors/react-version.md
Any way I can enable fast refresh?

_Originally posted by @searchableguy in https://github.com/vercel/next.js/discussions/16100_

---

This is caused by our check for React lower than 16.10 which seems to catch the experimental React version as well. This is just a warning and does not actually ""disable"" Fast Refresh.",Timer,kind: bug,2020-08-12T07:48:01Z,2020-08-18T05:54:32Z,timneutkens,balazsorban44,timneutkens,Timer,Timer,,Timer,
vercel/next.js,16107,"Link without href throws error # Bug report

Server Error
TypeError: Cannot destructure property 'auth' of 'urlObj' as it is undefined.


## Describe the bug

Link without passed href results in this bug

## To Reproduce

Use Link without href.

## Expected behavior

Even though that typescript indicates the error, maybe a more helpful error message would be better?
## Screenshots

![Screenshot 2020-08-12 at 12 17 00](https://user-images.githubusercontent.com/51530311/89998078-bb5ea000-dc95-11ea-9fa7-d1c3e7c58aeb.png)

![Screenshot 2020-08-12 at 12 19 19](https://user-images.githubusercontent.com/51530311/89998330-0f698480-dc96-11ea-9d5d-30e68fb01362.png)
",Timer,kind: bug,2020-08-12T09:19:54Z,2020-08-18T16:36:42Z,todortotev,todortotev;dodiameer;maerzhase;Kumagor0;RemLampa;nareshNishad;jserrao;dangerousdan;balazsorban44,Timer,,Timer,,,
vercel/next.js,16108,"React 17.0.0-rc.0 breaks error reporting # Bug report

## Describe the bug

When upgrading from `16.13.1` to `17.0.0-rc.0`, the runtime error overlay does not display at all.

## To Reproduce

In a component, throw an error. This can be either on the server, or purely in the browser. The type of error does not seem to matter - merely that it would be one that triggers the dev error box.

I've tried to make this repo as minimal as possible - using `create-next-app` and removing unnecessary parts.

https://github.com/Winwardo/nextjs-react-17-error-failure/blob/master/pages/index.js
https://github.com/Winwardo/nextjs-react-17-error-failure/blob/master/package.json

## Expected behavior

Screenshot using React `16.13.1`
![image](https://user-images.githubusercontent.com/840549/90006741-66208f80-dc91-11ea-9825-4f50999dcdb5.png)

## Screenshots

Screenshot using React `17.0.0-rc.0`, with console scrolled to where I believe the issue is in NextJS. (Note how the page is completely blank - anything that was previously rendered will be removed.)
![image](https://user-images.githubusercontent.com/840549/90006778-76386f00-dc91-11ea-8e73-fb88478d98e8.png)


## System information

- Browser: Tested on both Chrome (with an assortment of installed extensions like React devtools, which spits out errors too) and Firefox (with no extensions installed that I'm aware of)
- Version of Next.js: `9.5.2` (I've experienced this on `9.5.1` as well)
- Version of Node.js: `12.16.3`

## Additional context

This happens with recent `experimental` versions of React as well, but it didn't seem worth making an issue for them as they're not meant to be supported.

This happens even if I have my own error boundary catching the error (I use https://github.com/bvaughn/react-error-boundary) though I believe that's part of Next's philosophy to capture any and all errors, even handled ones.
",Timer,kind: bug,2020-08-12T10:50:46Z,2020-09-01T15:29:26Z,Winwardo,hamlim;eps1lon;gaearon;Winwardo;flybayer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,16147,"[9.5.2] The query string doesn't cleanup undefined value # Bug report

## Describe the bug
Navigating router via `push`:
```js
router.push({
  pathname: ""/page-a"",
  query: {
    param1: ""ok"",
    param2: undefined
  }
})
```
```js
// /pages/page-2
const router = useRouter();

console.log(router.query);
```
Result
```js
{
  param1: ""ok"",
  param2: ""undefined""
}
```
In the `page-a`: The `param2` is an `undefined` string value.

## Expected behavior
Result
```js
{
  param1: ""ok""
}
```
The `param2` should be an `undefined` value.

## System information

- OS: [macOS]
- Browser (if applies) [chrome]
- Version of Next.js: [9.5.2]
- Version of Node.js: [14]

## Additional context
https://github.com/vercel/next.js/pull/15378",Janpot,kind: bug,2020-08-13T04:02:04Z,2020-09-10T15:12:38Z,nghiepdev,Janpot;balazsorban44,Timer,,Timer,,,
vercel/next.js,16218,"trailingSlash: true don't work together with SSG and 404 page # Bug report

## Describe the bug

I want to enable redirects with `trailingSlash: true` in a project that uses **SSG** but seems that after enable this configurations together my project is not allowed to display 404 page.

- https://devsoutinhoblog.omariosouto.vercel.app/
- https://devsoutinhoblog.omariosouto.vercel.app/any-page-that-dont-exist

## To Reproduce

Check this project here https://github.com/omariosouto/devsoutinhoblog/tree/test, I only changed the pages directory and next.config.js

## Expected behavior

I believe that 404 page must work as the result of the redirect of a page that don't exists even if the `trailingSlash: true` is enabled

## Screenshots

![image](https://user-images.githubusercontent.com/13791385/90321263-81ec9580-df1e-11ea-8fad-17e3036de3c7.png)


## System information

- Version of Next.js: 9.5.2",ijjk,kind: bug,2020-08-15T20:42:03Z,2020-08-17T14:12:23Z,omariosouto,ijjk;balazsorban44,timneutkens;ijjk,,timneutkens,,,
vercel/next.js,16259,"After upgrading to to 9.5.2, client bundle includes unnecessary browser-node-polyfills # Bug report

## Describe the bug

After upgrading to next@9.5.2, client bundle includes `browser polyfils for Node.js`, probably related to #16022.

As far as I can tell, no code relies on these modules, because doing

```js
          delete config.resolve.alias.crypto;
          delete config.resolve.alias.stream;
          delete config.resolve.alias.path;
          delete config.resolve.alias.buffer;
          delete config.resolve.alias.vm;
```

in `next.config.js` removes the modules from the bundle, but the code still works. 



## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Upgrade to next 9.5.2
2. Bundle your code
3. Inspect the output

I realise that this will not be easy to debug, since it probably is related to our setup, which is closed source (sorry). 

## Expected behavior

Unnecessary browser node polyfills should not be in the bundle

## Screenshots

<img width=""611"" alt=""Screenshot 2020-08-17 at 14 59 16"" src=""https://user-images.githubusercontent.com/7705041/90398800-4aa2f380-e09a-11ea-9226-92022dbccfc1.png"">


## System information

- OS:macOS
- Version of Next.js:  9.5.2
- Version of Node.js: 12.18.3

## Additional context

My best guess is that some code only running on the server causes this to be bundled, even though it is not used on the client. 

Any help with further debugging would be awesome, just knowing why these are ending up being a part of the bundle. What dependency triggers these to be bundled.
",Timer,kind: bug,2020-08-17T13:03:38Z,2020-08-21T18:50:25Z,tbergquist-godaddy,michel-kraemer;timneutkens;tbergquist-godaddy;balazsorban44,Timer,Timer,Timer,Timer,,
vercel/next.js,16283,[internal] [canary only] Fix IE 11 compat The latest canary is failing on IE 11.,ijjk,kind: bug,2020-08-18T03:55:14Z,2020-08-18T03:56:15Z,Timer,balazsorban44,Timer,,Timer,,,
vercel/next.js,16332,"Rewrites bug when using with basePath and public directory # Bug report

## Describe the bug
Next.js cannot rewrites URL when using `basePath` option and having `public` directory.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Clone [the reproduction repo](https://github.com/titicacadev/next.js-rewrites-bug-reproduction)
2. Install dependencies, build next server, and run it.
```sh
npm install
npm run build
npm run start
```

3. GET the url what should be rewritten.
```sh
curl 'http://localhost:3000/todos'
```

4. See error

## Expected behavior

```sh
$ curl 'http://localhost:3000/todos'
HTTP/1.1 200 OK
...
```

## System information

- OS: macOS
- Version of Next.js: 9.5.2
- Version of Node.js: v12.18.0

## Additional context

Add any other context about the problem here.
",ijjk,kind: bug,2020-08-19T02:26:10Z,2020-08-19T17:30:34Z,giwan-dev,inbeom;balazsorban44,ijjk,ijjk,ijjk,,,
vercel/next.js,16333,"Next.js router can sometimes hang for existing users on app after a new deployment The Next.js router can sometimes hang (an edge case) when a user is on the app and a new deployment is made. This causes routing assets to go missing, and under certain conditions, prevents Next.js from automatically reloading to the new version.",timneutkens,kind: bug,2020-08-19T02:59:11Z,2020-08-19T11:41:02Z,Timer,balazsorban44,Timer,,Timer,,,
vercel/next.js,16366,"Dynamic root page doesn't revalidate when using the optional catch all routes # Bug report

## Describe the bug

I'm using a headless CMS and Next.js with the optional catch all routes for creating dynamic marketing pages.

Next.js doesn't revalidate the root page (domain.com/).

All other dynamic pages revalidate, though.

- / (doesn't revalidate)
- /blog (revalidates)
- /blog/hello-world (revalidates)

## To Reproduce

Pages directory:

- [[...slug]].js
- blog/[pid].js

`pages/[[...slug]].js`

```jsx
// ...

function Page({ route }) {
  // ...
}

export async function getStaticPaths() {
  const allRoute = await getRoutes();

  // Get the paths we want to pre-render based on routes
  const paths = allRoute.map((route) => {
    const slug = route.slug.current;
    return {
      params: { slug: slug === ""/"" ? false : [slug] },
    };
  });

  return {
    paths,
    fallback: false,
  };
}

export async function getStaticProps({ params }) {
  const allRoute = await getRoutes();

  const route = allRoute.find(
    (route) =>
      route.slug.current ===
      (params.slug === undefined ? ""/"" : params.slug.join(""""))
  );

  // Pass route data to the page via props
  return {
    props: {
      route,
    },
    revalidate: 1,
  };
}

export default Page;
```

## Expected behavior

The root page `/` should revalidate as any other dynamic page using `revalidate: 1` with the optional catch all routes feature.

## System information

- OS: macOS
- Version of Next.js: v9.5.2
- Version of Node.js: v14.7.0

## Additional context

Deployed on Vercel.",ijjk,kind: bug,2020-08-19T21:47:16Z,2020-08-21T18:13:25Z,jferrettiboke,jferrettiboke;Timer;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,16410,"problem with Router.push using hash # Bug report

## Describe the bug

In my case when i change only hash url using `Router.push(localhost:3000/#change)` coming from `localhost:3000` all stylesheets reload again causing the screen blink and a error in browser console.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Checkout https://github.com/fabinppk/hash-problem
2. All instructions on readme file.

## Screenshots

![image](https://user-images.githubusercontent.com/15840422/90815040-70c9cd00-e300-11ea-94c5-ed3aa96a2017.png)

## System information

- OS: Ubuntu 20.04
- Version of Next.js: 9.5.3-canary.6 or higher
- Version of Node.js: v12.13.1
",Timer,kind: bug,2020-08-20T19:19:00Z,2020-08-27T19:52:05Z,fabinppk,Timer;fabinppk;balazsorban44;kylemh;Mistereo,Timer,Timer,Timer,,Timer,
vercel/next.js,16440,"Spread operator not working in Safari 11.0.3 # Bug report

## Describe the bug

A user has reported this issue for our site, which is running on nextjs 9.4.0. This also happens on vercel.com/login. Certain elements on the site fails to load on with console error `SyntaxError: Unexpected token '...'. Expected a property name.`. 

For our site, our mapbox based map doesn't load, while on vercel's login page, the ""Continue with..."" buttons do not render.

We are unable to replicate exactly on our side as we don't have access to Safari 11.0.3 currently. Using browserstack, it works fine on Safari 11.1, but not on 10.1

According to https://github.com/vercel/next.js/issues/11507, this might be due to a node_module not being polyfilled

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Get a mac running Safari 11.0.3
2. Go to 'https://vercel.com/login'
3. See that ""Continue with ..."" buttons do not render properly

## Expected behavior

Nextjs 9.4.0 to render properly with polyfills, but if that version of Safari is no longer supported, then I'll close this

## Screenshots

![Image from iOS](https://user-images.githubusercontent.com/19505419/90893211-25dbb280-e3f1-11ea-82e6-1526836ce369.jpg)

Sorry for lack of proper screenshots, this was provided by a user. 

## System information

- OS: macOS
- Browser (if applies) Safari
- Version of Next.js: 9.4.0

## Additional context

",ijjk,kind: bug,2020-08-21T13:13:22Z,2020-08-21T19:11:26Z,gpng,jamesmosier;gpng;balazsorban44,ijjk,,ijjk,,,
vercel/next.js,16450,"Webpack 5 polyfills See #16259 for details.

We need to respect the `browsers` key in `package.json` for webpack 5 based apps.",timneutkens,kind: bug,2020-08-21T17:41:34Z,2021-11-16T21:03:03Z,Timer,timneutkens;balazsorban44,Timer,,Timer,,timneutkens,
vercel/next.js,1647,"Replace babel-preset-latest with babel-preset-env I'm currently in the process of setting up next.js and got this notification:
```
$ npm install next react react-dom --save
npm WARN deprecated babel-preset-latest@6.24.0: 棣冩寽  preset-latest accomplishes the same task as babel-preset-env. 棣冩  Please install it with 'npm install babel-preset-env --save-dev'. '{ ""presets"": [""latest""] }' to '{ ""presets"": [""env""] }'. For more info, please check the docs: http://babeljs.io/docs/plugins/preset-env 棣冩啠. And let us know how you're liking Babel at @babeljs on 棣冩儊
```
I'm assuming this comes from here: https://github.com/zeit/next.js/blob/6e0e2307dab46eeeda8fd761986f33350a811cee/package.json#L61

I have no idea if you're already aware of this. I've briefly searched the open issues and didn't find anything that related to this, so I figured I better open an issue for this. If you're already aware of this or have even solved it somewhere, I'm sorry 閳 this is my first time setting up next.js so I have no experience or involvement with the project whatsoever.",arunoda,kind: bug,2017-04-06T20:09:58Z,2017-04-18T13:58:34Z,osartun,arunoda,arunoda,,arunoda,,arunoda,
vercel/next.js,16508,"Navigation back with anchors is broken # Bug report

## Describe the bug

When you enter directly on a page with an anchor and then you navigate to another page, everything is fine. But when you press to go back on the previous page, the navigation is broken.


## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

I created a reproducible example:

Code: https://codesandbox.io/s/nextjs-forked-660z5?file=/pages/index.tsx
Executable: https://660z5.sse.codesandbox.io/#example

1. Go to 'https://660z5.sse.codesandbox.io/#example' (with the #example hash)
2. Click on 'Navigate to page 2'
3. Press the browser button to navigate back
4. See error: The back button is not working well

## Expected behavior

Should navigate back.

## System information

- OS: macOS
- Browser: chrome
- Version of Next.js: 9.5.2
- Version of Node.js: 14.8.0

",ijjk,kind: bug;type: needs investigation,2020-08-24T07:16:56Z,2020-08-25T06:03:36Z,aralroca,Yogendra0Sharma;ijjk;littleninja;aralroca;balazsorban44,Timer,,Timer,,aralroca,
vercel/next.js,16542,"deploying to Vercel causes conditional statements to evaluate incorrectly # Bug report

## Describe the bug

When rendering a page using Incremental Static Regeneration a *conditional statement is erroneously applied to the wrong element.

*I'm referring to conditional rendering expressions of the following form:

```jsx
<div>
   {true && <div />}
   <div />
</div>
```

## To Reproduce

1. go to my repo, https://github.com/AHBruns/vercel-repro
2. clone it, `npm install`, and *`npm run dev`
3. inspect element
4. you'll see the following, which is correct:
```html
<div>
   <div class=""SHOW""></div>
</div>
```
5. deploy the repo to Vercel
6. go to the deployed site
7. inspect element
8. you'll see the following, which is incorrect:
```html
<div>
   <div class=""NO_SHOW""></div>
</div>
```

*`npm run build && npm run start` yields the same problem

## Expected behavior

A single div with the class `SHOW` should be added to the DOM regardless of the environment.

## System information
- Version of Next.js: v9.5.2
- Version of Node.js: v14.3.0

",ijjk,kind: bug;type: needs investigation,2020-08-25T03:35:31Z,2020-09-14T16:48:04Z,AHBruns,Timer;AHBruns;vikasg603;balazsorban44;timneutkens;ijjk,Timer,Timer,timneutkens,,,
vercel/next.js,16624,"[Next 9.5] Prefetch related Uncaught Exceptions on Firefox # Bug report

## Describe the bug

Whenever a dynamic route is referenced in a page through the use of the `next/link` with prefetching enabled, **on a production build**, Firefox throws `Uncaught Exceptions` for each one of the `<link link=""..."" rel=""prefetch"" as=""fetch"" />` entries.

An example image can be found below. Also, you can refer to [this repository](https://github.com/araujoigor/nextjs9.5-firefox-prefetch-exception) if you want to reproduce the issue.

No behavior is impacted but this is specifically annoying since it may trigger alerts on monitoring platforms such as `Sentry`. If you have enough links, it may even trigger rate limiting on these services.

## To Reproduce

In order to reproduce the issue, simply open the following repository and follow the instructions:

https://github.com/araujoigor/nextjs9.5-firefox-prefetch-exception

## Expected behavior

The expected behavior is simply to not have these Uncaught Exceptions to occur.

## Screenshots

![Example of the issue](https://github.com/araujoigor/nextjs9.5-firefox-prefetch-exception/raw/master/public/example.png)

## System information

- OS: macOS 10.15.6
- Browser: Firefox
- Version of Next.js: 9.5.2
- Version of Node.js: 12.18.2

## Additional context

This issue didn't exist in previous versions of Next.
",Timer,kind: bug;type: needs investigation,2020-08-27T11:56:40Z,2020-09-01T18:09:26Z,araujoigor,amineo;timneutkens;araujoigor;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,16667,"`Cannot find module 'next/dist/next-server/server/node-polyfill-fetch'` for vercel monorepo serverless functions # Bug report

Hi, first of all love your work!

I'm migrating to use the NEW monorepo support for vercel,

and although the functions succeed to deploy, I get the following error when invoking it.
## Describe the bug

`Cannot find module 'next/dist/next-server/server/node-polyfill-fetch'`

## To Reproduce

Reproduction coming ...

## Expected behavior

A clear and concise description of what you expected to happen.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- OS: [e.g. macOS, Windows]
- Browser (if applies) [e.g. chrome, safari]
- Version of Next.js: [e.g. 6.0.2]
- Version of Node.js: [e.g. 10.10.0]

## Additional context

Add any other context about the problem here.
",styfle;Timer,kind: bug;type: needs investigation,2020-08-28T23:51:37Z,2020-09-10T14:41:39Z,shunkakinoki,timneutkens;belgattitude;JakeCooper;paulogdm;vongohren;styfle;Timer;yournatalita;balazsorban44;mattphillips;good-idea,Timer,Timer,,,Timer,
vercel/next.js,16690,"Experimental scrollRestoration flag causes browser to make a favicon request on every scroll event # Bug report

## Describe the bug

When the `experimental.scrollRestoration: true` feature is enabled, the resulting `replaceState` triggered by each scroll event will (potentially depending on caching, I assume) cause Chrome to re-request the favicon URL.

(I'm not sure why Chrome would re-request that just for a `replaceState`, that doesn't seem necessary, but it's happening nonetheless.)

## To Reproduce

1. Enable `experimental.scrollRestoration: true` in your app.
2. Start the app and open the Network panel.
3. Scroll the page.

## Expected behavior

Scrolling should not cause network requests.

## Screenshots

![Kapture 2020-08-29 at 15 32 47](https://user-images.githubusercontent.com/53522/91647221-081fd600-ea0d-11ea-97ad-05f09a4ff3f4.gif)

## System information

- macOS
- Chrome (maybe others)
- Next.js 9.5.2

## Additional context

Maybe a solution would be to capture the scroll position the moment before the page changes, instead of on every scroll event? Was that tried already?
",Timer,kind: bug;area: experimental,2020-08-29T22:36:17Z,2020-12-31T16:08:13Z,exogen,Timer;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,16746,"scrollrestoration broken on same-page navigation with hash links # Bug report

## Describe the bug

when navigating with browser-back button between hash links on the same route, the scroll position is not updated when going from `/page#hash` =[backbutton]=> `/page` with `experimental: scrollRestoration` enabled. With `scrollRestoration: false` this works as expected.

## To Reproduce

1. Clone repo https://github.com/stefanprobst/next-issue-scroll-restoration
2. On / page click ""Go to middle""
3. Click browser back button
4. Scroll position remains unchanged

5. (optionally) disable `scrollRestoration` in `next.config.js` and try the above again

## Expected behavior

The scroll position should be updated to the previous position (which is what happens without `scrollRestoration: true`)

## System information

- OS: ubuntu 20.04
- Browser (if applies) firefox 80, chrome 85
- Version of Next.js: 9.5.2
- Version of Node.js: 12.18.3
",shuding,kind: bug,2020-09-01T09:00:21Z,2021-03-03T18:48:04Z,stefanprobst,shuding;stefanprobst;balazsorban44,Timer,timneutkens,Timer,Timer,shuding,
vercel/next.js,16775,"import config in _app raises https://err.sh/vercel/next.js/invalid-page-config # Bug report

## Describe the bug

I use the package `@fortawesome/fontawesome-svg-core` and since nextjs **9.5.3** it causes an error, due to this code in `_app`:

```
import { config } from '@fortawesome/fontawesome-svg-core';
config.autoAddCss = false;
```

The error:

```
error - ./pages/_app.js
Error: C:\Projects\nextapp\pages\_app.js: Invalid page config export found. Expected object but got import in file \pages\_app.js. See: https://err.sh/vercel/next.js/invalid-page-config
```

Is this behavior expected?


## Workaround

An alias named import solves the issue:

```
import { config as fontawesomeConfig } from '@fortawesome/fontawesome-svg-core';
fontawesomeConfig.autoAddCss = false;
```",ijjk,kind: bug;good first issue,2020-09-02T08:28:54Z,2020-09-04T13:19:13Z,hk86,prakharshukla321;chadlittle;m0rg-dev;hk86;ijjk;klapec;Vadorequest;bivainis;balazsorban44,timneutkens;ijjk,,ijjk,,,
vercel/next.js,16825,"[9.5.3 - Rewrites] Navigating route with dynamic routes  no longer work properly ## Describe the bug
```js
// next.config.js
module.exports = {
  rewrites() {
    return [
      {
        source: ""/my-post/:id"",
        destination: ""/post""
      }
    ];
  }
};
```
Navigating via `Link` or `router.push`
```js
      <Link
        href={{
          pathname: ""/post"",
          query: {
            id: 1,
            another: ""another""
          }
        }}
        as=""/my-post/1?another=another""
      >
        <a>Post 1</a>
      </Link>
```
When custom the `as` path with `params` then `router.query.id` no longer true.

Actual: `id=1?another=another`
Expected: `id=1`

## To Reproduce
https://codesandbox.io/s/aged-sky-nzs6j?file=/pages/index.js
",ijjk,kind: bug,2020-09-03T14:38:34Z,2020-09-04T19:19:19Z,nghiepdev,MrEfrem;ijjk;nghiepdev;Timer;balazsorban44,Timer;ijjk,,Timer,,,vercel/next.js#16872;
vercel/next.js,16851,"Interpolating dynamic href values doesn't preserve extra query params # Bug report

This is a feedback to #16774 which I'm very excited about since it solves a big pain point in most apps I've been writing!

## Describe the bug

Adding extra query params to the `href` prop doesn't construct the expected URL; only the dynamic params are interpolated, while the extra query params are omitted.

## To Reproduce

Create a Next.js Link with more params than specified by the dynamic route.

```
<Link href={ pathname: ""/posts/[id]"", query: { id: 1, anotherParam: 2 } }><a>...</a></Link>
```

Navigates to the URL `/posts/1` and creates the link `<a href=""/posts/1"">...</a>`, omitting `anotherParam`.

## Expected behavior

As I wrote in https://github.com/vercel/next.js/issues/14959 :

`{ pathname: ""/posts/[id]"", query: { id: 1, anotherParam: 2 } }` should create the URL `/posts/1?anotherParam=2` and the link should be `<a href=""/posts/1?anotherParam=2"">...</a>`.

## System information

- Version of Next.js: 9.5.4-canary.1
",ijjk,kind: bug,2020-09-04T12:32:23Z,2020-09-08T13:33:17Z,jerstucki,ijjk;jerstucki;coderdix;power-f-GOD,ijjk,ijjk,ijjk,,Timer,vercel/next.js#14959;
vercel/next.js,16950,"CSS module removed when navigating pages that contain the same next/dynamic component # Bug report

## Describe the bug

Components that use next/dynamic to load and that have a CSS module lose their CSS when navigating to another page that contains the same dynamically loaded component.

## To Reproduce

Here is a [repo](https://github.com/adamayres/next-dynamic-css-issue) that contains the minimal amount of code to reproduce.

1. Create a Component that includes a CSS module.
2. Create two pages.
3. Using next/dynamic add the component to each page, as well as add a link to the other page.
4. Start the app and view the first page and then click the link to the second page.

## Expected behavior

The styles for the dynamically included component will persist when navigating to other pages the component lives on.

## Screenshots

The styles for the dynamically included component do not persist when navigating to other pages the component lives on.

## System information

- OS: macOS
- Browser: Chrome
- Version of Next.js: 9.5.3
- Version of Node.js: 12

## Additional context

This issue only occurs when navigating via page links, direct access to the `index` or `other-page` load the CSS correctly.

This bug appears to have been introduced as a regression from #12843 that fixed a related issue, #10557, where there is a flash of unstyled content when navigating to a page that contains a dynamically loaded component. I verified that this new issue is not present in 9.5.3-canary.20, but is present on 9.5.3-canary.21 and is currently present in 9.5.3. See this [comment](https://github.com/vercel/next.js/pull/12843#issuecomment-688285826) thread for more details on potential solutions.",Timer,kind: bug,2020-09-08T20:35:40Z,2020-11-03T05:23:32Z,adamayres,diegoleft;khades;adamayres;Gr0m;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,1705,"Updating states (HMR) not working properly ```js
import { Component } from 'react';

export default class Articles extends Component {
  state = {hello: 'hello'}

  render() {
    return <div>{this.state.hello}</div>;
  }
}
```

Changing the state doesn't update the page view, but reloading the page does.",timneutkens,kind: bug,2017-04-12T17:10:25Z,2018-09-04T15:53:08Z,ghigt,arunoda;ghigt;timneutkens;cia48621793;kengres;jaytrovare;xup3;saiqulhaq;pixelhijack;pvtri96,arunoda;timneutkens,arunoda,timneutkens,,timneutkens,
vercel/next.js,17056,"Invalid Unicode escape sequence from _buildManifest.js # Bug report

## Describe the bug

Roughly 5-10% of the time when starting the Next.js dev server in Blitz.js results in the below error in the browser immediately after first page load. This error shows in the dev error overlay and in the browser console.

```
SyntaxError: Invalid Unicode escape sequence        _buildManifest.js:1
```

Before `9.5.3`, it would show as something like `s is undefined`.

Note: we do have concurrent mode enabled, so possibly it could have something to do with that?

## To Reproduce

I'm unable to reliably reproduce, but here's how it happens:

1. `npx blitz new testapp`
2. `cd testapp`
3. `yarn blitz start`
4. Immediately click the `localhost:3000` link as soon as it appears from the Next.js dev server
5. Repeat steps 3 & 4 until you see the error

## Expected behavior

Should not error



## System information

  System:
    OS: macOS 10.15.6
    CPU: (16) x64 Intel(R) Core(TM) i9-9980HK CPU @ 2.40GHz
    Memory: 614.28 MB / 64.00 GB
    Shell: 3.1.2 - /usr/local/bin/fish
  Next.js: 9.5.3

",ijjk;kdy1,kind: bug;area: Routing,2020-09-13T02:28:03Z,2022-09-04T10:13:23Z,flybayer,ShikChen;flybayer;MisterJimson;amirho1;ppedziwiatr,timneutkens,,timneutkens,,huozhi,
vercel/next.js,17066,"Disable cssnano's postcss-calc  # Bug report

`next build` messes up complex css calc that works as expected in `next dev`

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Clone https://github.com/theMosaad/tailwindcss-capsize
2. On the dev server `npm run dev` the calc function works as expected https://prnt.sc/ugllip
3. When using `npm run build` then `npm run start` it shortens the calc function from
```css
.text-6xl::before {
    margin-top: calc(-1em * ((var(--ascent-scale) - var(--cap-height-scale) + var(--line-gap-scale) / 2) - (((var(--line-height-scale) * (var(--font-size-rem) * var(--root-font-size-px)) - (var(--line-height-rem) * var(--root-font-size-px)) - (var(--line-height-unitless) * (var(--font-size-rem) * var(--root-font-size-px))) - var(--line-height-px)) / 2) / (var(--font-size-rem) * var(--root-font-size-px))) + (.05 / (var(--font-size-rem) * var(--root-font-size-px)))));
}
```
to 
```css
.text-6xl::before {
    margin-top: calc(-1em*(var(--ascent-scale) - var(--cap-height-scale) + .05));
}
```

That's when I added the following to postcss.config.js
```js
module.exports = {
  plugins: {
    cssnano: {
      preset: ['default', { calc: false }],
    },
  },
}
```

## Expected behavior

Expected the full calc function when using `npm run build`

## System information

- OS: Windows 10
- Version of Next.js: 9.5.3
- Version of Node.js: 12.18.2

## Additional context

I tried the same cssnano options on a gulp configuration and it disabled calc.
```js
const gulp = require('gulp')
const postcss = require('gulp-postcss')
const cssnano = require('cssnano')

gulp.task('css', function () {
  return gulp
    .src('input.css')
    .pipe(
      postcss([
        cssnano({
          preset: ['default', { calc: false }],
        }),
      ])
    )
    .pipe(gulp.dest('dist'))
})
```
",Timer,kind: bug,2020-09-13T18:02:15Z,2020-11-06T05:46:20Z,theMosaad,theMosaad;marcbouchenoire;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,17073,"Experimental scrollRestoration + Sentry causes performance issues # Bug report

## Describe the bug

Every scroll event is apparently watched by Sentry which registers it as `navigation` breadcrumb event.

## To Reproduce

1. enable `scrollRestoration` in `next.config.js`
2. initialize Sentry in the application and observe `__SENTRY__.hub._stack[0].scope._breadcrumbs` changing

## Expected behavior

Navigation changes are only fired when an url change occurs.

## Screenshots

The first console entry is the site right after loading.
The second after scrolling a single time via mousewheel.

![image](https://user-images.githubusercontent.com/29307652/93058124-363d2100-f66f-11ea-9eda-c15ef462d2e3.png)

I presume the 10ms timeout here is too low.
![image](https://user-images.githubusercontent.com/29307652/93058362-959b3100-f66f-11ea-8c6c-2a50733d956b.png)

Those are all `Sentry.addBreadcrumb` due to the `scroll` event being fired:
![image](https://user-images.githubusercontent.com/29307652/93058602-e6128e80-f66f-11ea-8845-9ad4f7fe04cf.png)
![image](https://user-images.githubusercontent.com/29307652/93058683-ff1b3f80-f66f-11ea-9b14-2d5ae90dfb03.png)


## System information

- OS: Android on OnePlus 3, Windows 10 on multiple machines
- Browser (if applies): chrome, firefox mobile, chrome mobile
- Version of Next.js: latest stable

## Additional context

Latest sentry releases:
```
    ""@sentry/minimal"": ""5.23.0"",
    ""@sentry/node"": ""5.23.0"",
    ""@sentry/react"": ""5.23.0"",
```",Timer,kind: bug;area: experimental,2020-09-14T07:55:10Z,2020-12-31T16:08:13Z,ljosberinn,ljosberinn;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,17113,"[9.5.4-canary.18] Different router.asPath between server and client. # Bug report
From `9.5.4-canary.18` `router.asPath` in the sever-side return incorrect value.

## Describe the bug
```js
// next.config.js
module.exports = {
  rewrites() {
    return [
      {
        source: ""/my-post"",
        destination: ""/post""
      }
    ];
  }
};
```

## To Reproduce
https://codesandbox.io/s/sharp-cannon-kcsio?file=/pages/post.js
Directly access `/my-post` url

<img width=""1009"" alt=""Screen Shot 2020-09-15 at 21 30 53"" src=""https://user-images.githubusercontent.com/4768095/93224362-36d2d600-f79b-11ea-8c91-3b4073ba9c08.png"">

## Expected behavior
The `router.asPath` always return  `/my-post`.

## Additional context

https://github.com/vercel/next.js/pull/17082",ijjk,kind: bug,2020-09-15T14:40:09Z,2020-09-15T19:19:08Z,nghiepdev,ijjk;nghiepdev;balazsorban44,Timer;ijjk,,Timer,,,
vercel/next.js,17181,"Experimental conformance mode breaks on variable script src # Bug report

## Describe the bug

When the `conformance` experiment is enabled in `next.config.js` a `<script src={SOME_VARIABLE}>` will cause production builds to fail with `TypeError [ERR_INVALID_URL]: Invalid URL: undefined`.

## To Reproduce

After a `npx create-next-app`閳

```js
// next.config.js
module.exports = {
  experimental: {
    conformance: true,
  },
};
```

```jsx
// pages/index.js
import Head from 'next/head'
import styles from '../styles/Home.module.css'

export default function Home() {
  const SCRIPT_SRC = ""https://example.com/script.js"";

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <link rel=""icon"" href=""/favicon.ico"" />

        <script src={SCRIPT_SRC} async></script>
      </Head>

      <main className={styles.main}>
{/* 閳snip閳 */}
```

```sh
$ NODE_ENV=production yarn next build
yarn run v1.22.5
$ /private/tmp/test/my-app/node_modules/.bin/next build
warn  - You have enabled experimental feature(s).
warn  - Experimental features are not covered by semver, and may cause unexpected or broken application behavior. Use them at your own risk.

info  - Creating an optimized production build  
Failed to compile.

./pages/index.js
Module parse failed: Invalid URL: undefined
File was processed with these loaders:
 * ./node_modules/next/dist/build/webpack/loaders/next-babel-loader.js
You may need an additional loader to handle the result of these loaders.
TypeError [ERR_INVALID_URL]: Invalid URL: undefined
    at Array.forEach (<anonymous>)


> Build error occurred
Error: > Build failed because of webpack errors
    at build (/private/tmp/test/my-app/node_modules/next/dist/build/index.js:15:918)
```

## Expected behavior

No error.

## Screenshots

N/A

## System information

- OS: macOS
- Browser: N/A
- Version of Next.js: 9.5.3
- Version of Node.js: 14.11.0

## Additional context

I don閳ユ獩 have a use for it, but I also noticed while testing that using a relative URL like `<script src=""/foo.js"" async></script>` results in a similar `Invalid URL: /foo.js` error.",housseindjirdeh,kind: bug;area: ESLint,2020-09-17T16:07:57Z,2022-02-15T16:48:43Z,davecardwell,housseindjirdeh,timneutkens,,timneutkens,timneutkens,housseindjirdeh,
vercel/next.js,17220,"""Optional catch all routes"" is not working when deploying to Vercel # Bug report

## Describe the bug

""Optional catch all routes"" is not working when deploying to Vercel

## To Reproduce

- I have a page: `pages/the-loai/[[...slug]].tsx`
- When starts production server in local (http://localhost:3000/the-loai) => props: `""page"":""/the-loai/[[...slug]]"",""query"":{},""buildId"":""vsDb98I1lSnwfBqQ1KKgX""`
- When deploy to Vercel (https://story-react.vercel.app/the-loai) => props: `""page"":""/the-loai/[[...slug]]"",""query"":{""slug"":[""[[...slug]]""]},""buildId"":""XBGtXp4fTtSIAp5Xvhv-B""`
## Expected behavior

`query` should be `{}`

## Screenshots

view-source:https://story-react.vercel.app/the-loai
![image](https://user-images.githubusercontent.com/16433547/93664701-15276680-fa9b-11ea-8764-4336187b7b61.png)",ijjk,kind: bug,2020-09-19T10:11:50Z,2020-10-05T07:34:51Z,thanhtoan1196,thanhtoan1196;ijjk;balazsorban44,ijjk,,ijjk,,,vercel/next.js#16366;
vercel/next.js,17273,"[9.5.4-canary.20] default loader doesn't transpile nullish coalescing and optional chaining # Bug report

## Describe the bug

Loader `next-babel-loader` doesn't transpile nullish coalescing operator and optional chaining on canary

## To Reproduce

Repository: [next.js-bug-nullish-coalescing](https://github.com/rokinsky/next.js-bug-nullish-coalescing)
Steps to reproduce the behavior:

1. Go to [http://localhost:3000](http://localhost:3000)
2. See error
3. Go to [http://localhost:3000/about](http://localhost:3000/about)
4. See error

## Expected behavior

Don't see the errors.

## Screenshots

<img width=""810"" alt=""Screenshot 2020-09-22 at 02 47 57"" src=""https://user-images.githubusercontent.com/20644874/93832383-3b592c00-fc7e-11ea-8f35-fcb16bc288bc.png"">
<img width=""810"" alt=""Screenshot 2020-09-22 at 03 04 22"" src=""https://user-images.githubusercontent.com/20644874/93833145-79efe600-fc80-11ea-843d-6e12358a1538.png"">

## System information

- OS: macOS
- Browser (if applies): chrome
- Version of Next.js: `9.5.4-canary.20`
- Version of Node.js: `14.2.0`

## Additional context

Works with `9.5.3`
",ijjk,kind: bug,2020-09-21T23:50:24Z,2020-09-28T23:47:06Z,rokinsky,nghiepdev;rokinsky;Timer;omBratteng;wiesson;JLHwung;garretteklof;kryptonian41;balazsorban44,lfades;Timer;ijjk,,ijjk,,Timer,
vercel/next.js,17364,"[9.5.4-canary.21] head-manager breaks when it gets an empty title as a child # Bug report

## Describe the bug

`next/head` breaks on the client-side when it gets an empty `title` as a child.

Stack trace:
```
Uncaught TypeError: Cannot read property 'join' of undefined
    at eval (head-manager.ts?0645:46)
    at Array.forEach (<anonymous>)
    at updateElements (head-manager.ts?0645:41)
    at initHeadManager (head-manager.ts?0645:84)
    at Object.eval (index.tsx?8abf:95)
    at eval (index.js:813)
    at Object../node_modules/next/dist/client/index.js (main.js?ts=1601052556893:2107)
    at __webpack_require__ (webpack.js?ts=1601052556893:873)
    at fn (webpack.js?ts=1601052556893:151)
    at Object.eval (next-dev.js?53bc:2)
```

## To Reproduce

Repository: [next.js-bug-head-empty-title](https://github.com/rokinsky/next.js-bug-head-empty-title)
Steps to reproduce the behavior:

1. Go to [http://localhost:3000](http://localhost:3000)
2. See the blank page and an error in the dev console.

## Expected behavior

Displaying `Hello, world!` without errors.

## Screenshots

<img width=""1097"" alt=""Screenshot 2020-09-25 at 20 04 57"" src=""https://user-images.githubusercontent.com/20644874/94295758-67b8c500-ff6a-11ea-8319-80ee2b26fc95.png"">

## System information

- OS: macOS
- Browser (if applies): chrome, safari
- Version of Next.js: `9.5.4-canary.21`
- Version of Node.js: `13.14.0`

## Additional context

Works fine with `9.5.3`. Assume this was broken in #16758.",ijjk,kind: bug,2020-09-25T17:05:40Z,2020-09-28T23:12:08Z,rokinsky,Southclaws;ijjk;balazsorban44,Timer;ijjk,,ijjk,,,
vercel/next.js,17440,"Redirect does not work with ""https://"" in a destination query parameter # Bug report

## Describe the bug

When trying to redirect to an external URL which contains query parameters, one cannot have ""https://"" in the parameter.

For example if I wish to redirect `/set-password` to `https://authserver.example.com/set-password?returnUrl=https://www.example.com/login`. This results in an ""Internal Server Error"". It is also the case when urlencoded: `https://authserver.example.com/set-password?returnUrl=https%3A%2F%2Fwww.example.com%2Flogin`

## To Reproduce

Add the following code to next.config.js

```
async redirects() {
        return [
            {
                source: '/set-password',
                destination: 'https://authserver.example.com/set-password?returnUrl=https%3A%2F%2Fwww.example.com/login',
                permanent: true,
            },
        ]
    },
```

Start the nextJS dev server:  e.g.`next -p 3000`
Visit `http://127.0.0.1:3000/set-password

## Expected behavior

Browser should redirect to https://authserver.example.com/set-password?returnUrl=https://www.example.com/login

## Actual behaviour

Browser shows ""Internal Server Error"". Terminal console reads:

```
$ next -p 3000
ready - started server on http://localhost:3000
info  - Using external babel configuration from /project/package.json
event - compiled successfully
TypeError: Missing parameter name at 6
    at lexer (/project/node_modules/next/dist/compiled/path-to-regexp/index.js:47:23)
    at parse (/project/node_modules/next/dist/compiled/path-to-regexp/index.js:97:18)
    at compile (/project/node_modules/next/dist/compiled/path-to-regexp/index.js:181:29)
    at prepareDestination (/project/node_modules/next/dist/next-server/server/router.js:10:64)
    at Object.fn (/project/node_modules/next/dist/next-server/server/next-server.js:31:821)
    at Router.execute (/project/desktop_front_end/node_modules/next/dist/next-server/server/router.js:38:83)
    at async DevServer.run (/project/desktop_front_end/node_modules/next/dist/next-server/server/next-server.js:44:494)
```

## System information

- OS: Docker linux
- Version of Next.js: 9.5.3
- Version of Node.js: [e.g. 10.10.0]
",ijjk,kind: bug,2020-09-29T08:40:44Z,2020-11-07T04:30:15Z,djmarland,ijjk;djmarland;balazsorban44,ijjk,ijjk,ijjk,,,
vercel/next.js,17582,"fallback: 'unstable_blocking' is not encoding dynamic params properly # Bug report

## Describe the bug

In the following page called `pages/post/[slug].tsx`:

```jsx
import { useRouter } from 'next/router'

export async function getStaticPaths() {
  return {
    paths: [{ params: { slug: '/my-post/' } }],
    fallback: 'unstable_blocking',
  }
}

export async function getStaticProps({ params }: any) {
  console.log('SLUG', params.slug)
  return { props: {} }
}

export default function Page() {
  const router = useRouter()
  return <h1>Hello World {router.query.slug}</h1>
}
```

The value of `slug` is `my-post` on development, and `%2Fmy-post%2F` on production.

Using `fallback: 'unstable_blocking'` the page will match `/post/my-post` on development but it won't on production, and using `fallback: false` the page will encode the param properly and it will never match `/post/my-post`.

## Expected behavior

The encoded param should be consistent in development and production, and while using different values for `fallback`

## System information

- Version of Next.js: 9.5.4-canary.23
",ijjk,kind: bug,2020-10-03T04:00:40Z,2020-12-28T20:08:58Z,lfades,realw5;balazsorban44,lfades;ijjk,,Timer,,,
vercel/next.js,17701,"Broken build on `9.5.4` # Bug report

## Describe the bug

After upgrading to `9.5.4` from `9.5.3`, `next build` is no longer working for me. I'm also using `tailwindcss@1.8.12` + `postcss`.

## To Reproduce

```sh
# Running on `9.5.3` (works fine)
yarn dev

$ cross-env NEXT_TELEMETRY_DISABLED=1 NODE_ENV=development next -p 8090
info  - Loaded env from /dev/project/.env.local
ready - started server on http://localhost:8090

risk - There are upcoming breaking changes: removeDeprecatedGapUtilities, purgeLayersByDefault
risk - We highly recommend opting-in to these changes now to simplify upgrading Tailwind in the future.
risk - https://tailwindcss.com/docs/upcoming-changes
event - compiled successfully
```

```sh
# Upgrade to `9.5.4` and try again
rm yarn.lock
yarn add next@latest
yarn dev

$ cross-env NEXT_TELEMETRY_DISABLED=1 NODE_ENV=development next -p 8090
info  - Loaded env from /dev/project/.env.local
ready - started server on http://localhost:8090

risk - There are upcoming breaking changes: removeDeprecatedGapUtilities, purgeLayersByDefault
risk - We highly recommend opting-in to these changes now to simplify upgrading Tailwind in the future.
risk - https://tailwindcss.com/docs/upcoming-changes
error - ./src/styles/core.css (./node_modules/next/node_modules/css-loader/dist/cjs.js??ref--5-oneOf-6-1!./node_modules/next/dist/compiled/postcss-loader??__nextjs_postcss!./src/styles/core.css)
Error: Can't resolve '/fonts/la-brands-400-98099f67.eot' in '/dev/project/src/styles'
event - build page: /_error
wait  - compiling...
error - ./src/styles/core.css (./node_modules/next/node_modules/css-loader/dist/cjs.js??ref--5-oneOf-6-1!./node_modules/next/dist/compiled/postcss-loader??__nextjs_postcss!./src/styles/core.css)
Error: Can't resolve '/fonts/la-brands-400-98099f67.eot' in '/dev/project/src/styles'
Error: Cannot find module '/dev/project/.next/build-manifest.json'
```

<details>
  <summary>Then it starts looping on a `MODULE_NOT_FOUND` exception</summary>

```sh
Require stack:
- /dev/project/node_modules/next/dist/next-server/server/load-components.js
- /dev/project/node_modules/next/dist/next-server/server/api-utils.js
- /dev/project/node_modules/next/dist/next-server/server/next-server.js
- /dev/project/node_modules/next/dist/server/next.js
- /dev/project/node_modules/next/dist/server/lib/start-server.js
- /dev/project/node_modules/next/dist/cli/next-dev.js
- /dev/project/node_modules/next/dist/bin/next
    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:831:15)
    at Function.Module._load (internal/modules/cjs/loader.js:687:27)
    at Module.require (internal/modules/cjs/loader.js:903:19)
    at require (internal/modules/cjs/helpers.js:74:18)
    at loadComponents (/dev/project/node_modules/next/dist/next-server/server/load-components.js:1:886)
    at DevServer.findPageComponents (/dev/project/node_modules/next/dist/next-server/server/next-server.js:54:189)
    at DevServer.renderErrorToHTML (/dev/project/node_modules/next/dist/next-server/server/next-server.js:103:114)
    at DevServer.renderErrorToHTML (/dev/project/node_modules/next/dist/server/next-dev-server.js:34:974)
    at runMicrotasks (<anonymous>)
    at processTicksAndRejections (internal/process/task_queues.js:97:5) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/dev/project/node_modules/next/dist/next-server/server/load-components.js',
    '/dev/project/node_modules/next/dist/next-server/server/api-utils.js',
    '/dev/project/node_modules/next/dist/next-server/server/next-server.js',
    '/dev/project/node_modules/next/dist/server/next.js',
    '/dev/project/node_modules/next/dist/server/lib/start-server.js',
    '/dev/project/node_modules/next/dist/cli/next-dev.js',
    '/dev/project/node_modules/next/dist/bin/next'
  ]
}
```

</details>

## Expected behavior

Build should continue to work. No other change was introduced in the failing project. 

- **Reverting back to `9.5.3` solves the issue**.
- The file it's complaining about (`/fonts/la-brands-400-98099f67.eot`) it's actually there and has always been.
- `next build` fails with the exact same error.

## System information

- OS: macOS `10.15.7` (19H2)
- Version of Next.js: `9.5.4`
- Version of Node.js: `v12.19.0`",ijjk,kind: bug,2020-10-07T21:28:20Z,2020-10-08T18:45:40Z,nfantone,ijjk;spencewood;dutchenkoOleg;nfantone;timneutkens;pkellner;UncleClapton;balazsorban44;mjr;flayks;RobbyUitbeijerse,ijjk;timneutkens,ijjk,,,,
vercel/next.js,17721,"Failed to execute 'createElement' on 'Document' | v9.5.4 # Bug report

## Describe the bug

I ran into this error after updating Next.js to version 9.5.4. The problem is that you cannot use React Components inside `Head` in _app.js file.

**Minimal Example:**

```
const Metadata = () => (
  <>
      <base href=""/"" />
      <meta name=""msapplication-TileColor"" content=""#000000"" />
      {/*...*/}
  </>
)

class NextApp extends App {
  render() {
      return (
          <>
              <Head>
                  <title>Next Bug Report</title>
                  {/*Error*/}
                  <Metadata />
              </Head>
          </>
      )
  }
}
```

## To Reproduce

Just open the dev server

**Reproduction repo:** [next-bug-report](https://github.com/arthruwelkin/next-bug-report)

## Screenshots

![image](https://user-images.githubusercontent.com/26415925/95482647-0c89c800-0997-11eb-83c0-4516c6cdb42e.png)

## System information

- Version of Next.js: [9.5.4]
- Version of React/ReactDOM: [16.13.1]
- Version of Node.js: [14.0.0]

",devknoll,kind: bug,2020-10-08T15:59:23Z,2020-11-10T21:35:48Z,arthruwelkin,danvoyce;jflayhart;schlosser;timneutkens;devknoll;omar-dulaimi;matfin;osdevisnot;bencodesall;balazsorban44;vxcamiloxv;alaingoga,,,,,arthruwelkin,
vercel/next.js,17732,"Failed to load the correct optional catch all route (9.5.4) # Bug report

## Describe the bug

There are two routes in our project

- `[destintionName]/[[...params]]` - **DestinationPage**
- `[desitntionName]/properties/[propertyId]/package/[[...params]]` - **PackagePage**

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. On **DestinationPage** `/cairns`

2. Click `<Link href=""/cairns/properties/123451/package"" />` to go to **PackagePage**

3. It updates browser url to `/cairns/properties/123451/package`

## Expected behavior

4. Expects to go and load **PackagePage**, but it refreshes and load **DestinationPage**

### It works on 9.5.3

## System information

- OS: macOS
- Browser (if applies) chrome
- Version of Next.js: 9.5.4
- Version of Node.js: 10.16.3
",ijjk,kind: bug,2020-10-09T02:46:16Z,2020-12-30T02:11:40Z,KieraDOG,ijjk;KieraDOG;balazsorban44,ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,17775,"[Next 9.5.4 or above] Throw function expected error and app stops working in Edge 41 # Bug report

## Describe the bug
App throws SCRIPT5002: Function expected error in Edge 41 or Edge 42. 
Some react components are broken, all links and buttons are stop working.

## To Reproduce
Open a next.js 9.5.4 or above application in production mode on Browserstack with preset Edge 41 or Edge 42.

## Expected behavior
Next.js should transpile the script to ES5(supports Set) and running without crash in Edge 41 and Edge 42

## Screenshots
Error message
![Screen Shot 2020-10-10 at 7 53 46 pm](https://user-images.githubusercontent.com/138992/95651999-b012de00-0b39-11eb-95d7-385ff3f77179.png)

Error highlighted in debugger
![Screen Shot 2020-10-10 at 7 50 30 pm](https://user-images.githubusercontent.com/138992/95652001-b3a66500-0b39-11eb-96ff-ef6802e2042f.png)


## System information

- OS: macOS
- Browser: 
Edge 41.16299.15.0
Edge HTML 16.16299

Edge 42.17134.1098.0
Edge HTML 17.17134

- Version of Next.js: 9.5.4 or above
- Version of Node.js: 14.13.1

## Additional context
These new changes in head-manager.js/ts which break the app since Next 9.5.4
`const headEl = document.getElementsByTagName('head')[0]`
` const elements = new Set<Element>(headEl.children)`
https://github.com/vercel/next.js/blob/658810815035e55a7031f27c5a6f3c01baa31ccf/packages/next/client/head-manager.ts#L92
I have to rollback to Next 9.5.3 in order to get the app running in Edge 41 and 42.
",devknoll,kind: bug,2020-10-10T12:20:12Z,2020-11-10T21:35:48Z,davepoon,davepoon;daiyam;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,17813,"Using `getStaticPaths` in combination with `trailingSlash: true` leads to invalid json prefetching # Bug report

Using `getStaticPaths` in combination with `trailingSlash: true` leads to invalid json prefetching. For a link to a dynamic route, the json file that is prefetched includes an invalid slash in the path, causing a 404 to be returned. However, when clicking the link and landing on the dynamic page the correct json file is fetched.

## To Reproduce

1. Configure 

```js
// next.config.js
module.exports = {
  trailingSlash: true,
};
```

2. Add dynamic route

```js
// pages/[name].js
export default function Hello({ name }) {
  return <div>Hello {name}</div>
}

export function getStaticProps(context) {
  return {
    props: {
      name: context.params.name
    }
  };
}

export function getStaticPaths() {
  return {
    paths: [
      { params: { name: 'world' } }
    ],
    fallback: false
  };
}
```

3. Add link to dynamic route

```js
// pages/index.js
import Link from 'next/link'
export default function Home() {
  return (
    <div>
      <Link as=""/world"" href=""/[name]"">
        <a>Hello world</a>
      </Link>
    </div>
  )
}
```

4. Export using `next build && next export`
5. Open root page
6. Observe a network request for `https://example.com/_next/data/some-hash/world/.json` returning a 404

## Expected behavior

The correct `https://example.com/_next/data/some-hash/world.json` is (pre)fetched

## System information

- OS: macOs
- Browser (if applies): chrome
- Version of Next.js: 9.5.5
- Version of Node.js: v12.18.0
",ijjk,kind: bug,2020-10-12T09:55:11Z,2021-03-14T12:58:35Z,bram-l,erkde;bernardodestefano;emadicio;jchen1;shawner18;chaddjohnson;mrrau;balazsorban44,timneutkens;ijjk,ijjk,ijjk,,,
vercel/next.js,17889,"Public routes not being served if basePath setting contains a forward slash character # Bug report

## Describe the bug

If you configure a basePath with a forward slash in it, e.g.

`basePath: '/my/site'`

and a `public` folder with, e.g. a file called `foo` in it, then requesting the URL with path of `/my/site/foo` will result in a 404 response, rather than the file `foo`

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Create a new nextJS application with `create-next-app`
2. Create a `next.config.js` file with the following contents:

```
module.exports = {
  basePath: '/my/site',
}
```

3. Run `npm run build`
4. Run `npm run start`
5. Navigate to `http://localhost:3000/my/site/vercel.svg`
6. Observe 404 page

## Expected behavior

In the above example, a 404 response is not expected.  Indeed, if one sets basePath to, e.g. `/my-site` and navigate to `http://localhost:3000/my-site/vercel.svg` the asset is loaded properly.

I do not believe this is by design: the documentation on the `basePath` setting does not mention any such prohibition on forward slashes.

## System information

- Version of Next.js: 9.5.5

## Additional context

Here's the problem I reckon:

```
...
// if basePath is defined require it be present
if (basePath) {
  if (pathParts[0] !== basePath.substr(1)) return { finished: false }
  pathParts.shift()
}
...
```

from `packages/next/next-server/server/next-server.ts:788`

We're only comparing the first path part against the entire basePath.  Almost, but not quite, like comparing apples and pears :)
",ijjk,kind: bug,2020-10-14T17:59:44Z,2020-11-03T02:44:51Z,willbritton,balazsorban44,Timer;ijjk,ijjk,Timer,,,
vercel/next.js,17907,"[Next 9.5.4] [ERR_INVALID_CHAR]: Invalid character in header content [""Location""] # Bug report

## Describe the bug

internal server error occurs when redirect path includes query strings of non-ascii character(like Japanese).

in this PR, non-ascii character is passed to 'Location' header without encoding.
https://github.com/vercel/next.js/pull/17323/files

## To Reproduce
0. Set `next.config.js` with trailing slash config `true`.
```jsx
<!-- next.config.js -->
module.exports = {
  trailingSlash: true
};
```

1. Open link with query strings of non-ascii character
```jsx
<!-- indes.jsx -->
export default function IndexPage() {
  return (
    <div>
      <a href=""/about?tag=閺冦儲婀扮懢"">
        with query strings
      </a>
    </div>
  );
}
```

3. Redirected to `/about?tag=閺冦儲婀扮懢鐎 page, not `/about/?tag=閺冦儲婀扮懢鐎. and 500 error occurs.
```shell
TypeError [ERR_INVALID_CHAR]: Invalid character in header content [""Location""]
    at ServerResponse.setHeader (_http_outgoing.js:488:3)
    at Object.fn (/node_modules/next/next-server/server/next-server.ts:569:15)
    at Router.execute (/node_modules/next/next-server/server/router.ts:200:40)
    at processTicksAndRejections (internal/process/task_queues.js:93:5)
    at DevServer.run (/node_modules/next/next-server/server/next-server.ts:855:23)
```

here is a demo.
https://codesandbox.io/s/non-ascii-query-error-c8esl

## Expected behavior

redirected to `/about/?tag=閺冦儲婀扮懢鐎, with trailing slash.
otherwise, encode japanese character.",ijjk,kind: bug,2020-10-15T06:26:07Z,2020-11-06T00:51:07Z,yk1979,ka2jun8;PepijnSenders;ijjk;eduludi;hinsxd;omar-dulaimi,ijjk,,ijjk,,ijjk,
vercel/next.js,17930,"Failed to read the 'cssRules' property from 'CSSStyleSheet': Cannot access rules # Bug report

## Describe the bug

DOMException: Failed to read the 'cssRules' property from 'CSSStyleSheet': Cannot access rules

## To Reproduce
Steps to reproduce the behavior, please provide code snippets or a repository:

1. Setting assetPrefix to subdomain
2. Use withSass default config, import scss file in a page
3. Handle error componentDidCatch in _app.js
4. Run production mode

## Expected behavior

App render success without catch

## System information

- OS: Windows
- Browser Chrome
- Version of Next.js: 9.5.5
- Version of Node.js: 11.15.0
",Timer,kind: bug,2020-10-16T05:11:06Z,2020-11-03T12:50:16Z,kuongknight,timneutkens;jeremy-coleman;kuongknight;bmathews;balazsorban44,timneutkens;Timer,Timer,Timer,,,
vercel/next.js,18056,"Bumping project to 9.5.5 causes build errors # Bug report

## Describe the bug

Upgrading to 9.5.5 causes `Failed to compile` error when running `next build`

```
static/chunks/228a2a7ba78e3ffd319f6ce5014dd859657e6b72.6c045b2e351579d8c08d.js from Terser
TypeError: e.computed_key is not a function
    at Array.some (<anonymous>)
```

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Upgrade to next@9.5.5 via `yarn add next@9.5.5`
2. Run `next build`
3. See error

## Expected behavior

The build to succeed as it has with previous versions.

## System information

- OS: Debian 10
- Browser (if applies) [e.g. chrome, safari]
- Version of Next.js: 9.5.5
- Version of Node.js: 14.14.0

## Additional context

The exact point at which our builds fail is upgrading to 9.5.4. Builds previous to that work.
Any pointers to debugging this issue would be appreciated.
",Timer,kind: bug;type: upstream,2020-10-20T16:21:01Z,2020-12-10T16:49:24Z,vallode,ljosberinn;vallode;balazsorban44;Timer,timneutkens;Timer,Timer,Timer,,,
vercel/next.js,18083,"React 17: Property expression of JSXExpressionContainer expected node to be of a type [""Expression"",""JSXEmptyExpression""] but instead got undefined # Bug report

## Describe the bug

In a Next.js project using styled-jsx I get the following error across different components that create a <style jsx> tag to generate CSS selectors within template literals (or import such styles from a separate file):

```
Property expression of JSXExpressionContainer expected node to be of a type [""Expression"",""JSXEmptyExpression""] but instead got undefined
```
The error appears as soon as I update react and react-dom to 17.0.0 and might be related to the new JSX transform in React v17.

## Expected behavior

It renders the component as expected without any errors.

## System information

- OS: macOS Catalina
- Version of React: 17.0.0 
- Version of Next.js: 9.5.5
- Version of Node.js: 12.18.3
- Version of TypeScript: 4.0.3

## Additional context

Add any other context about the problem here.
",Timer,kind: bug,2020-10-21T11:22:55Z,2020-11-13T21:47:10Z,jakeherp,jakeherp;timneutkens;message;SemperFortis;brianshano;Timer;balazsorban44;narciero,timneutkens,timneutkens,,,Timer,
vercel/next.js,18096,"""React is not defined"" when using a custom _app.tsx and .babelrc using React 17 # Bug report

After upgrading to React 17, I can no longer compile my project with a custom `.babelrc` file without importing React in every `*.tsx` file. Having a `_app.tsx` file seems to be required to reproduce the issue. The error returned is:
```
Error occurred prerendering page ""/"". Read more: https://err.sh/next.js/prerender-error
ReferenceError: React is not defined
    at MyApp.render (/home/bruhno/projects/react-not-defined/.next/server/pages/_app.js:297:70)
    at d (/home/bruhno/projects/react-not-defined/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:35:231)
    at bb (/home/bruhno/projects/react-not-defined/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:36:16)
    at a.b.render (/home/bruhno/projects/react-not-defined/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:42:43)
    at a.b.read (/home/bruhno/projects/react-not-defined/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:41:83)
    at exports.renderToString (/home/bruhno/projects/react-not-defined/node_modules/react-dom/cjs/react-dom-server.node.production.min.js:52:138)
    at Object.renderPage (/home/bruhno/projects/react-not-defined/node_modules/next/dist/next-server/server/render.js:50:851)
    at Function.getInitialProps (/home/bruhno/projects/react-not-defined/.next/server/pages/_document.js:273:19)
    at loadGetInitialProps (/home/bruhno/projects/react-not-defined/node_modules/next/dist/next-server/lib/utils.js:5:101)
    at renderToHTML (/home/bruhno/projects/react-not-defined/node_modules/next/dist/next-server/server/render.js:50:1142)
```

I'm not sure if TypeScript is related to the issue, but I've simply copy pasted minimal configuration from my own project which is where I experienced the issue.

## To Reproduce

I've created the following repo to reproduce the error: https://github.com/NBruhno/nextjs-react-not-defined

1. run `yarn`
2. run `yarn dev` or `yarn build`
4. See error in the terminal and on the rendered page

## Expected behavior

I could before React 17 run my repo without having to import React in my .tsx files unless explicitly referring to some functions, with my own custom `.babelrc` file.

## System information

- OS: Windows running WSL: Ubuntu-20.04
- Version of Next.js: 9.5.5
- Version of Node.js: v12.17.0",Timer,kind: bug;type: needs investigation,2020-10-21T16:55:52Z,2020-11-13T07:41:56Z,NBruhno,NBruhno;vasco3;kyle-mccarthy;BernardA;F3WS;mdirolf;ccambournac;karlhorky;PabloSzx;Vadorequest;Andarist;Migggz;lucax88x;lukeshumard,Timer,,,,Timer,
vercel/next.js,18125,"Using basePath breaks SPA when using getServerSideProps or getStaticProps # Bug report

## Describe the bug

Setting basePath breaks SPA fetches and causes full re-render.

## To Reproduce

1. Set basePath to project in next.config.js
2. Add either `getServerSideProps` or `getStaticProps` and `getStaticPaths` method to a page. 

**Repo for testing:**
https://github.com/IikkaWinter/next-basepath-demo

**Deployments**
with basePath: https://nextjs-blog-d3av2acke.vercel.app/docs/foo

without basePath (everything works): https://nextjs-blog-2o56gnpjr.vercel.app/foo

Everything works as expected when run locally with `vc dev`. Deploy to Vercel and every _next/data/*/*.json path returns 404.

## Expected behavior

Expected to run serverside method and return 200.

## Screenshots

OBS! Prerendered page1.json and page2.json work. 
<img width=""313"" alt=""Screenshot 2020-10-22 at 14 56 22"" src=""https://user-images.githubusercontent.com/5743958/96868893-58e50580-1477-11eb-9b46-94919a697877.png"">

`foo.json` missing. Also see how Lambda function is named instead of `/foo`.
<img width=""224"" alt=""Screenshot 2020-10-22 at 14 59 54"" src=""https://user-images.githubusercontent.com/5743958/96868838-42d74500-1477-11eb-84cc-c74e56a64a41.png"">


## System information

- OS: macOS
- Browser (if applies) Chrome
- Version of Next.js: 9.5.5
- Version of Node.js: 12.13.0

## Additional context

Additionally, when using basePath (/docs) with rewrites and parameters in sources, e.g. `/:locale/:path`, the route`/docs/en` will pass the following parameters to the getServerSideProps: 
```
{
  locale: 'doc',
  path: 'en'
}
```",ijjk,kind: bug,2020-10-22T10:17:48Z,2020-11-07T04:40:33Z,IikkaWinter,tiagooliveira08;IikkaWinter;joiglifberg;ijjk;balazsorban44,Timer;ijjk,ijjk,Timer,,Timer,
vercel/next.js,18134,"styled-jsx css.resolve errors after upgrading to React 17.0.0/Next 9.5.5 # Bug report

## Describe the bug

After upgrading our Next.js application to React `17.0.0` and Next.js `9.5.5`, our builds are failing with the following TypeError when parsing [styled-jsx's `resolve`](https://github.com/vercel/styled-jsx#the-resolve-tag) calls:

```
TypeError: pass.get(...) is not a function
```

This only seems to happen when `resolve` is called outside of a jsx/tsx file. You can see a working example here: https://codesandbox.io/s/elegant-bassi-tbx5c?file=/pages/index.tsx (as opposed to the reproduction sandbox below).

I'm struggling to find the cause of these errors, as this pattern is working fine for us on React `16.x` and Next.js `9.5.5`. Could this be due to the [new JSX transform](https://reactjs.org/blog/2020/09/22/introducing-the-new-jsx-transform.html) [support](https://github.com/vercel/next.js/pull/16603/files)?

## To Reproduce

CodeSandbox reproduction:

https://codesandbox.io/s/nice-bose-85uux?file=/lib/styles.ts

## Expected behavior

The build should succeed without errors.

## System information

- OS: any
- Version of Next.js: `9.5.5`
- Version of Node.js: `10.20.1` / `12.11.1`

## Additional context

N/A
",Timer,kind: bug,2020-10-22T14:24:47Z,2020-11-14T03:18:46Z,iprignano,KB1RMA;iprignano;alex-polunochev-zz;duongmngo;hotehrud;balazsorban44;trekinbami;optimistiks;brianshano;joerobot;lucax88x;dwjohnston,Timer,,Timer,Timer,Timer,vercel/next.js#18083;
vercel/next.js,18196,"[9.5.6-canary.13][notFound] custom 404-page rendering crashes in prod mode # Bug report

## Describe the bug

I use the experimental `unstable_notFound` feature on SSG/ISG pages and it fails in production mode when the custom-404 page uses `getStaticProps`.

## To Reproduce

Repository: [next.js-bug-not-found](https://github.com/rokinsky/next.js-bug-not-found)
Steps to reproduce the behavior:

1. `yarn build && yarn start`
2. Go to  [http://localhost:3000](http://localhost:3000)
3. See Internal Server Error

## Expected behavior

Displaying ""not-found"" with 404 status code.

## Screenshots

<img width=""874"" alt=""Screenshot 2020-10-24 at 17 20 22"" src=""https://user-images.githubusercontent.com/20644874/97084174-c92d8b80-161d-11eb-9b5d-09f0ac0bf30c.png"">

## System information

- OS:macOS
- Browser (if applies): chrome
- Version of Next.js: 9.5.6-canary.13
- Version of Node.js: v10.22.1

## Additional context

Works fine in dev mode.
",ijjk,kind: bug,2020-10-24T14:42:54Z,2020-10-24T19:22:49Z,rokinsky,balazsorban44,ijjk,,ijjk,,,
vercel/next.js,18332,"next/link & next/router - using getStaticProps with a route that starts with the same characters as defaultLocale # Bug report

## Describe the bug

When using a `defaultLocale` (e.g. `""de""`) in combination with `getStaticProps` and a route that starts with the same characters as the `defaultLocale` (e.g. `/pages/details/[slug].js`) we cannot visit the page when using `next/link` or `next/router`.
   
## To Reproduce

Check out the [repository](https://github.com/ankri/next-locale-bug) 

1. Create a [next.config.js](https://github.com/ankri/next-locale-bug/blob/main/next.config.js) with `defaultLocale: ""de""`
2. Create a page starting with `de`: [/pages/details/[slug].js](https://github.com/ankri/next-locale-bug/blob/main/pages/details/%5Bslug%5D.js)
3. Use next/link or a next/router to [link to the page](https://github.com/ankri/next-locale-bug/blob/main/pages/index.js#L12-L14)

## Expected behavior

When clicking on the `/de/details/slug-1` link (or the router button) the page should load. But instead we get the following error:

## Screenshots

![image](https://user-images.githubusercontent.com/2842920/97354854-4e22da00-1896-11eb-8ea5-abbbb5f19182.png)

## System information
- NextJS 10.0.0

## Additional context
It works when we bypass the link or router by entering the URL for the page.
The app can be built. The same error occurs in the built version.",ijjk,kind: bug,2020-10-27T20:12:42Z,2020-11-02T23:32:58Z,ankri,balazsorban44,Timer,,Timer,,,
vercel/next.js,18334,"Automatic Language dectection seems to work only in Chrome when locale is only partially in locales # Bug report

## In Firefox or Safari, automatic language detection doesn't seem to work properly if in locales we have [""pt-PT""] but Accept-Language is ""pt"" for example

According to the documentation: https://nextjs.org/docs/advanced-features/i18n-routing#automatic-locale-detection

> When a user visits the application root (generally /), Next.js will try to automatically detect which locale the user prefers based on the Accept-Language header and the current domain.

However, if in `next.config.js` we have `locales: ['en-CA', 'fr-CA', 'pt-PT']` and we've defined the browser language to `pt` then NextJS will fail to set locale as 'pt-PT' and will instead set `locale` as the `defaultLocale`

So unless the browser language is exactly the same as in locales, automatic language detection won't work.

## Clone this example https://github.com/vercel/next.js/tree/canary/examples/i18n-routing

Then change locales to something like [""en-CA"", ""fr-CA"", ""pt-PT""] or a language of your choice but it needs to be `xx-XX` and set `defaultLocale: ""en-CA""
 
Then change your browser language to one of the languages in `locales` but instead make sure you only have `xx`, for example `en` or `fr` or `pt` or whatever languages you've added to your locales.

Navigate to the index page and you should be redirected to `http://localhost:3000/pt` or the language you've set your browser to.

Instead you stay on `http://localhost:3000`

I'm not sure it's a bug in NextJS though since it works in Chrome but fails in both Firefox and Safari.",ijjk,kind: bug,2020-10-27T20:33:27Z,2020-11-17T20:42:12Z,alveshelio,theostrahlen;ijjk;balazsorban44,Timer,,Timer,,ijjk,
vercel/next.js,18337,"Wrong defaultLocale on non-index pages on client-side and detected language redirect doesn't work. # Bug report

## Describe the bug

On non-index pages `defaultLocale` overrided was with detected language, only happend on client-side. At the same time `defaultLocale` was correct on the server-side. Also on non-index pages detected language redirect doesn't work.

## To Reproduce

Check out the [repository](https://github.com/dmitrykozyrenko/next10-i18n-routing-issue)

## Expected behavior

`defaultLocale` should be immutable, detected language redirect should work on non-index pages.

## Screenshots

### pages/index

server-side
![image](https://user-images.githubusercontent.com/29832979/97359721-deb4e680-18a5-11eb-95ed-b352538f4617.png)

client-side
![image](https://user-images.githubusercontent.com/29832979/97359767-f2604d00-18a5-11eb-9553-6718f8f19452.png)

### pages/test

server-side
![image](https://user-images.githubusercontent.com/29832979/97359834-0e63ee80-18a6-11eb-9d50-441bd1f6fa17.png)

client-side
![image](https://user-images.githubusercontent.com/29832979/97359902-2a679000-18a6-11eb-866e-af5cfae39f27.png)

## System information

- OS: Windows
- Browser chrome
- Version of Next.js: 10.0.0
- Version of Node.js: 12.16.1",ijjk,kind: bug,2020-10-27T20:50:08Z,2020-11-02T23:00:42Z,dmitrykozyrenko,balazsorban44,Timer,,Timer,,,
vercel/next.js,18338,"Trailing slashes appends slashes to external links # Bug report

## Describe the bug

Using the configuration Trailing slashes true, <Link></Link> components append the slash to external URLs.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

Repo: https://github.com/conanbatt/nextjs-export-slashes
Steps:
```
// next.config.js
module.exports = {
  trailingSlash: true,
}
```
And
```
// pages/index.js
<Link href=""https://example.com"">Without slash</Link>
```

## Expected behavior

1- External links do not append trailing slashes.
2- Export and next dev exhibit the same behavior? (```next dev``` does not append trailing slash)

## Screenshots

Result
```
<h1 class=""Home_title__3DjR7"">Welcome to <a href=""https://nextjs.org"">Without slash</a></h1>
<h1 class=""Home_title__3DjR7"">Welcome to <a href=""https://nextjs.org/"">With slash?</a></h1>
```

## Additional context

If I remember right, Link components should not be used for external urls. This used to be caught by Next. It would be nice to detect external or absolute paths for trailing slash purposes.
",Timer,kind: bug,2020-10-27T20:52:36Z,2020-11-12T18:10:41Z,conanbatt,balazsorban44,timneutkens,Timer,Timer,,,
vercel/next.js,18356,"_next/image 404 on next build && next export # Bug report

## Describe the bug

Images are 404 on next build && next export. Works properly next build && next start

## To Reproduce

1. npx create-next-app --example image-component image-app
2. cd image-app
3. npx next build && npx next export && cd out && npx serve
4. visit localhost:5000

## Screenshots

![image](https://user-images.githubusercontent.com/23246308/97381906-08e9c100-1905-11eb-95cc-a0855c433c19.png)

## System information

- OS: macOS Mojave
- Version of Next.js: [e.g. 10.0.0]
- Version of Node.js: [e.g. 12.18.4]",styfle,kind: bug,2020-10-28T02:05:16Z,2020-11-11T15:46:49Z,jericopulvera,melvin2016;muhaimincs;eloquentmack;Timer;maxwellpopescu;elitan;zackdotcomputer;ceodigvijay;krystof-k;maxwaiyaki;mclngl;jlarmstrongiv;timneutkens;flaviut;lokesh14v;barayuda;Chamnol007;sahanatroam;leerob;Sir-Chasington;nickroberts;sethlarkin;marlonmarcello;nahtnam;Jaynam07,Timer,Timer,,,,
vercel/next.js,18369,"[next/image] Image doesn't update on page change # Bug report

## Describe the bug

I'm currently building a website that shows information about tv shows. In the tv show page, when can see all information such as pictures, name, etc. When clicking on a similar tv show, next/link redirects to the correct page, the title updates but the images stay the same, they never update. I need to _hard reload_ the page to see image change. 

## To Reproduce

(Reproducing will not longer work since I implement the fix on my website, refer to the video below to see the bug)
1. Go to [soononnetflix.vercel.app](https://soononnetflix.vercel.app)
2. Click on any show, for exemple [this one](https://soononnetflix.vercel.app/show/21/the-crown)
3. Scroll down to 'similar tv shows' and click on one.
4. You'll see the cover image stay the same as the previous one.

This project is not open sourced but if you got issues to reproduce the bug, I'll make a little repository to help you reproduce it.

## Expected behavior

It should update to the correct image that match the show. Reload the page in your browser to see the right images.

## Screenshots

I've made [this video](https://youtu.be/LYvolLWbtuc) that shows the bug.

## System information

- OS: macOs
- Browser : chrome
- Version of Next.js: 10.0.0
- Version of Node.js: 12.13.0

",Timer,kind: bug,2020-10-28T08:50:03Z,2020-11-06T23:03:16Z,PolMrt,dkodeit;miguelmoya1;PolMrt;onderonur;petertenhoor;Elia-Darwish;raphaeljoer;CalebLovell;Timer;balazsorban44,Timer,Timer,Timer,,PolMrt,
vercel/next.js,18372,"Image component fails when using image data URI # Bug report

## Describe the bug

When passing an image data URI to the Next.js image component an error is thrown.

## To Reproduce

Pass data URI to the Next.js image component:

Example:

```javascript
import Image from 'next/image';
<Image src=""data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="">
```

## Expected behavior

The simplest solution and expectation would be to pass the URI directly to the `img` tag without any modification or optimization.

## Screenshots

Not applicable but error reported on the debug overlay is:

```
Error: Invalid src prop (data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=) on `next/image`, hostname is not configured under images in your `next.config.js`
```

## System information

- OS: Windows
- Browser (if applies) Chrome, Firefox, Edge
- Version of Next.js: 10.0.0
- Version of Node.js: 12.9.0

## Additional context

None.
",styfle;Timer,kind: bug,2020-10-28T09:00:22Z,2020-11-04T21:14:56Z,jecassis,AlexSapoznikov;fzembow;styfle;diegoulloao;ndom91;brnyza;balazsorban44,Timer,,Timer,,,
vercel/next.js,18389,"buildManifest 404 causing app failure # Bug report

## Describe the bug

A clear and concise description of what the bug is.

I have a Next.js application which uses `getStaticProps` and `getStaticPaths`. It is running inside a docker container with the `server` target, and I am repeatedly running into a 404 error when trying to fetch the `buildManifest.js` file, which causes all navigation to break. It also causes direct navigation to pages that don't have a cached version yet to hang forever on the fallback page.

## To Reproduce

You can see a hanging fallback page here: https://beta.openebooks.us/app/collection/https%3A%2F%2Fqa-circulation.openebooks.us%2FUSOEI%2Fgroups%2F406

You can see the app working, but navigation not working here (because this path was cached before the problem started): https://beta.openebooks.us/app 

If the buildManifest file is cached in the browser, for example by visiting the working page and then directly navigating to the not-working page, the not-working page will render correctly, though you will now see 404s on other files, like `app.json`, etc in the console. 

The code producing this behavior is here https://github.com/NYPL-Simplified/circulation-patron-web

## Expected behavior

The buildManifest should not 404, and SSG should not hang.

## Screenshots

The `buildManifest` 404:
![image](https://user-images.githubusercontent.com/4398775/97441154-b02c1f80-1928-11eb-99db-bb5a6ee801be.png)

The `app.json` 404:
![image](https://user-images.githubusercontent.com/4398775/97441283-d782ec80-1928-11eb-8600-061c6962d8b9.png)

Other file 404:
![image](https://user-images.githubusercontent.com/4398775/97441342-e9648f80-1928-11eb-9ca4-21ea093e7eb6.png)


## System information

This is running in a docker image built on top of node:12.2.0-alpine with Next.js version ^9.5.3. 

## Additional Context

This doesn't seem to be always happening. The deployment worked totally fine for some time before this began. ",Timer,kind: bug,2020-10-28T13:27:19Z,2020-11-11T18:13:17Z,kristojorg,kristojorg;Timer;Lauwed;MitchEff;timneutkens;marracheco;St3ve89;MoSattler;asdillon;antonyleme;dlr1251;kristjanmar;sergioloporto;cbfn;steedems;chenrui333,Timer,Timer,Timer,,kristojorg,
vercel/next.js,18393,"Image component does not work with Storybook # Bug report
## Describe the bug
using `next/image` component in storybook throw Error.

## To Reproduce

1. Set up with-storybook example `yarn create next-app --example with-storybook with-storybook-app`
2. Create new story using `next/image`
```image.stories.js
import Image from 'next/image'
import React from 'react'

export default { title: 'Image' }
// image url
const url = 'https://......'

export const withNextImage = () => (
  <Image src={url} width={100} height={100} />
)
```

3. Start storybook

## Expected behavior

show Image without Error as plane image tag do.
## Screenshots
![image](https://user-images.githubusercontent.com/33568829/97450241-de841c00-1975-11eb-9b0d-a91f7c98e8ab.png)

## System information

- OS: macOS
- Browser Chrome
- Version of Next.js: 10.0.0
- Version of Node.js: v12.16.3
",atcastle,kind: bug;type: needs investigation;area: Ecosystem,2020-10-28T14:40:10Z,2022-01-26T20:59:56Z,kodai3,styfle;aippili-asp;josbroers;sklawren;luiscarlin;Erazihel;dohomi;bke-daniel;Aid19801;tiavina-mika;rajansolanki;ghost;kylemh;audishos;phuocv76;tar-aldev;moschan;travisbloom;evisotskiy;kn0ll;SZharkov;steoneill;BramDecuypere;ChoSeoHwan;mavichow,Timer,,Timer,styfle;Timer,balazsorban44,
vercel/next.js,18397,"Local sub-route with param renders 404 in production app I have a route with a param (`/src/pages/items/[id].tsx`), and am testing the built-in i18n routing. 

```
// next.config.js
module.exports = {
  i18n: {
    locales: [
      'fr',
      'en-US',
    ],
    defaultLocale: 'fr'
  }
};
```

The app renders correctly the page `/en-US/items/0` in local. However, in production it returns a 404 (app hosted on Vercel). If I navigate to this url from within the app, it works correctly though. It really happens with routes with params, a page `/en-US/items` renders fine.

Is it a bug or I am doing something wrong ?",ijjk,kind: bug,2020-10-28T16:01:53Z,2020-11-08T02:18:14Z,gwendall,revskill10;ijjk;balazsorban44;alinjie;gwendall,Timer;ijjk,ijjk,Timer,,ijjk,
vercel/next.js,18404,"i18n routing with getStaticProps and getStaticPaths, first item provided to getStaticProps is empty # Bug report

## Describe the bug

It looks like that the first element provided to `getStaticProps` is empty while using i18n and `getStaticPaths`:

```Javascript
export const getStaticPaths = async ({ locales }) => {
  // generate dummy pages
  const items = [
    ""123_a"", ""234_b"", ""345_c"", ""456_d"",
  ];

  // create paths
  const paths = locales.reduce(
    (acc, next) => [
      ...acc,
      ...items.map((slug) => ({
        params: {
          slug,
        },
        locale: next,
      })),
    ],
    []
  );

  return {
    paths,
    fallback: true,
  };
```

Generated paths:
```Javascript
[
  { params: { slug: ""123_a"" }, locale: ""de"" },
  { params: { slug: ""234_b"" }, locale: ""de"" },
  { params: { slug: ""345_c"" }, locale: ""de"" },
  { params: { slug: ""456_d"" }, locale: ""de"" },
  { params: { slug: ""123_a"" }, locale: ""en"" },
  { params: { slug: ""234_b"" }, locale: ""en"" },
  { params: { slug: ""345_c"" }, locale: ""en"" },
  { params: { slug: ""456_d"" }, locale: ""en"" },
  { params: { slug: ""123_a"" }, locale: ""fr"" },
  { params: { slug: ""234_b"" }, locale: ""fr"" },
  { params: { slug: ""345_c"" }, locale: ""fr"" },
  { params: { slug: ""456_d"" }, locale: ""fr"" },
  { params: { slug: ""123_a"" }, locale: ""it"" },
  { params: { slug: ""234_b"" }, locale: ""it"" },
  { params: { slug: ""345_c"" }, locale: ""it"" },
  { params: { slug: ""456_d"" }, locale: ""it"" },
];
```


getStaticProps
```Javascript
export const getStaticProps = async ({ params, locale }) => {
  const { slug } = params;

  const id = slug.match(/\d{3}/)[0]; // fails, because slug is undefined

  return {
    props: { slug, id, locale },
    revalidate: 1,
  };
};
```

With the first item, params is empty, but locale is set (de).


Error message: 

```
18:24:27.197  	info  - Generating static pages (0/46)
18:24:27.444  	info  - Generating static pages (11/46)
18:24:27.446  	Unhandled error during request: TypeError: Cannot read property 'match' of undefined
18:24:27.447  	    at getStaticProps (/vercel/workpath0/.next/serverless/pages/items/[slug].js:1059:19)
18:24:27.447  	    at renderToHTML (/vercel/workpath0/node_modules/next/dist/next-server/server/render.js:26:115)
18:24:27.447  	    at async renderReqToHTML (/vercel/workpath0/.next/serverless/pages/items/[slug].js:890:22)
18:24:27.447  	    at async Object.exportPage [as default] (/vercel/workpath0/node_modules/next/dist/export/worker.js:12:92)
18:24:27.447  	Error occurred prerendering page ""/items/[slug]"". Read more: https://err.sh/next.js/prerender-error
18:24:27.447  	TypeError: Cannot read property 'match' of undefined
18:24:27.448  	    at getStaticProps (/vercel/workpath0/.next/serverless/pages/items/[slug].js:1059:19)
18:24:27.448  	    at renderToHTML (/vercel/workpath0/node_modules/next/dist/next-server/server/render.js:26:115)
18:24:27.448  	    at async renderReqToHTML (/vercel/workpath0/.next/serverless/pages/items/[slug].js:890:22)
18:24:27.448  	    at async Object.exportPage [as default] (/vercel/workpath0/node_modules/next/dist/export/worker.js:12:92)
18:24:27.455  	info  - Generating static pages (22/46)
18:24:27.464  	info  - Generating static pages (34/46)
18:24:27.494  	info  - Generating static pages (46/46)
18:24:27.494  	> Build error occurred
18:24:27.496  	Error: Export encountered errors on following paths:
18:24:27.496  		/items/[slug]
18:24:27.496  	    at exportApp (/vercel/workpath0/node_modules/next/dist/export/index.js:25:1103)
18:24:27.496  	    at runMicrotasks (<anonymous>)
18:24:27.496  	    at processTicksAndRejections (internal/process/task_queues.js:97:5)
18:24:27.496  	    at async build (/vercel/workpath0/node_modules/next/dist/build/index.js:39:69)
18:24:27.510  	npm ERR! code ELIFECYCLE
18:24:27.510  	npm ERR! errno 1
18:24:27.511  	npm ERR! nextjs-i18n-static-error@0.1.0 build: `next build`
18:24:27.511  	npm ERR! Exit status 1
18:24:27.511  	npm ERR! 
18:24:27.511  	npm ERR! Failed at the nextjs-i18n-static-error@0.1.0 build script.
18:24:27.512  	npm ERR! This is probably not a problem with npm. There is likely additional logging output above.
18:24:27.518  	npm ERR! A complete log of this run can be found in:
18:24:27.518  	npm ERR!     /vercel/.npm/_logs/2020-10-28T17_24_27_512Z-debug.log
18:24:27.523  	Error: Command ""npm run build"" exited with 1
18:24:29.426  	Done with ""package.json""
```



## To Reproduce

Example: https://github.com/wiesson/nextjs-i18n-static-error

## Expected behavior

I expect that getStaticProps only receives items that has been defined by `getStaticPaths`

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

Deployed on vercel.",ijjk,kind: bug,2020-10-28T17:53:35Z,2020-11-02T20:41:35Z,wiesson,wiesson;domcoleman;timneutkens;SalahAdDin;balazsorban44,timneutkens;Timer,,Timer,,,
vercel/next.js,18411,Test Hello there 2,styfle,kind: bug,2020-10-28T19:02:14Z,2020-10-29T01:01:13Z,Timer,balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,18414,"next/image is not a drop-in replacement for the <img> tag # Bug report

## Describe the bug

While the Next 10 blog post states that next/image is a drop-in replacement for the &lt;img&gt; tag, this is not the case for many layouts.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. See https://codesandbox.io/s/practical-booth-uwzr6.

## Expected behavior

The layout should remain the same before and after switching from &lt;img&gt; to next/image.

## Screenshots

![image](https://user-images.githubusercontent.com/13417496/97555081-ad4f2e80-19fd-11eb-920a-afa2f13266bc.png)


## System information

- OS: macOS
- Browser (if applies) Chrome and Firefox, but problem is independent of browser
- Version of Next.js: 10
- Version of Node.js: v14.9.0
",styfle;Timer,kind: bug,2020-10-28T19:53:21Z,2020-11-02T00:55:58Z,kbrgl,M1ck0;kbrgl;balazsorban44;dohomi;kush-agra;Timer,Timer,,Timer,Timer,Timer,
vercel/next.js,18415,"Unable to test components that import ""next/image"" # Bug report

## Describe the bug

Using jest and react-testing-library, tests that run on components that use the new Image component fail with the following error:

```
    TypeError: Cannot destructure property 'deviceSizes' of 'imageData' as it is undefined.

    > 1 | import Image from ""next/image"";
        | ^
      2 | 
```

## To Reproduce

As far as my testing has gone just simply running a test against any component that imports Image from ""next/image"" causes this error. I've setup a simple vanilla nextjs repo that adds jest and react-testing-library, along with a component that uses the Image component here: https://github.com/spencewood/next-image-test. Running the tests on this repo yields the above error:

```
> yarn test
```

## Expected behavior

I would expect the tests to run normally.

## System information

- OS: macOS 10.15
- Version of Next.js: 10.0
- Version of Node.js: 12.18
",styfle,kind: bug,2020-10-28T19:54:27Z,2020-11-12T19:24:09Z,spencewood,georgekaran;balazsorban44,timneutkens;Timer,,styfle,,,
vercel/next.js,18420,"Reconsider default `deviceSizes` configuration to handle 2x/3x DPI Currently, deviceWidths is `[320, 420, 768, 1024, 1200]`, however we did not consider DPI.

For example, an iPhone 5/SE is 320px wide but it requests the a 640px image from the `srcset` because its 2x DPI.

However, because we don't have 640w as an option, this means the 768w image is used because it is the next largest.


### Apple Docs

- [Device Display Resolutions](https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/Displays/Displays.html)
- [DPI: 2x vs 3x](https://developer.apple.com/design/human-interface-guidelines/ios/icons-and-images/image-size-and-resolution/)",Timer,kind: bug,2020-10-28T20:49:22Z,2020-11-03T02:12:47Z,styfle,styfle;dohomi;balazsorban44,styfle,Timer;styfle,styfle;Timer,Timer,,
vercel/next.js,18437,"[next/link] weird race condition due to setState being used in ref callback # Bug report

## Describe the bug

This is the code that reproduces the behavior that we are debugging.

https://codesandbox.io/s/nextjs-forked-vg87p

Note the comments:

```js
// when menu is open and clicked inside menu, A is expected to be false
// when menu is open and clicked outside menu, A is expected to be true

```

The weird use of `setAnything` inside of `ref` comes from `next/link`:

https://github.com/vercel/next.js/blob/e058fa49d099c052a84e8f2b2149d25a9ba625a4/packages/next/client/link.tsx#L312

It appears that because `ref` callback calls `setState`, the `click` handler is called before the element is mounted.

A very simple fix would be to wrap `setAnything` (or `setChildElm` in next.js case) in a `setTimeout`, e.g.

https://codesandbox.io/s/nextjs-forked-6oxv9

However, I am not convinced that this is even a bug or just a race condition that we are not handling properly.

In either case, calling `setState` in `ref` seems bizarre.",Janpot,kind: bug;good first issue,2020-10-29T03:05:33Z,2020-11-01T03:37:29Z,gajus,erictaylor;balazsorban44,timneutkens;Timer,Timer,Janpot,,Timer,
vercel/next.js,18448,"[next/image] flash broken image placeholder (alt text and white border) before load image # Bug report

## Describe the bug

I use next/image component and after reload page I see blink alt (attribute `alt`) text.

## To Reproduce

1. Use next/image component
2. Reload page

## Expected behavior

1. Show alt text if image didn't load (404 error for example)
2. If I have good image I shouldn't see flash broken image placeholder

## Screenshots

https://monosnap.com/file/BjNLnRZMWmwG5NugYk8TuDm3VZ6tez

**screen from video above (timecode 8sec)**
![Screenshot 2020-10-29 133243](https://user-images.githubusercontent.com/19692986/97544372-50e31380-19eb-11eb-8330-2a924daad1c0.png)

## System information

- OS: Windows 10
- Browser: Latest Edge, Latest Firefox
- Version of Next.js: 10
- Version of Node.js: 14.13

## Additional context

My code:

```jsx
import Link from 'next/link'
import Image from 'next/image'
import slugify from '@sindresorhus/slugify'
import format from 'date-fns/format'
import isToday from 'date-fns/isToday'
import isTomorrow from 'date-fns/isTomorrow'
import ru from 'date-fns/locale/ru'
import cx from 'classnames'
import { ReleaseType, ReleaseInList } from 'types/common'
import PlatformList from '../PlatformList'
import Text from '../Text'
import ExpectButton from '../ExpectButton'

import styles from './styles.module.css'

export enum Source {
  Calendar = 'calendar',
  Today = 'today',
  Profile = 'profile',
}

function renderDate(today: boolean, tomorrow: boolean, date: Date) {
  if (today) return '瑜嬫拌皭鑺鍐欒柂瑜'

  if (tomorrow) return '锜归偑鑳佽岃夐偑'

  return format(date, 'EEEEEE, d MMM', {
    locale: ru,
  })
}

interface Props {
  release: ReleaseInList
  source: Source
}

function ReleaseCard({ release, source }: Props) {
  const { title, released, release_id } = release

  const releasedDate = new Date(released)

  const slug = slugify(title)
  const today = isToday(releasedDate)
  const tomorrow = isTomorrow(releasedDate)

  return (
    <Link href=""/release/[id]"" as={`/release/${release_id}-${slug}`}>
      <a className={styles.ReleaseCard}>
        <div className={styles.Header}>
          <div
            className={cx(styles.Date, {
              [styles.isToday]: today,
            })}
          >
            {renderDate(today, tomorrow, releasedDate)}
          </div>
          <ExpectButton release={release} />
        </div>
        <div className={styles.Cover}>
          <Image src={release.cover} alt={release.title} unsized />
        </div>
        <div className={styles.Footer}>
          <Text className={styles.Title}>{release.title}</Text>
          {release.type === ReleaseType.Films && (
            <Text secondary i className={styles.Info}>
              {release.director}
            </Text>
          )}
          {release.type === ReleaseType.Series && (
            <Text secondary i className={styles.Info}>
              {release.season} 瑜嬫拌煿鑺钖
            </Text>
          )}
          {release.type === ReleaseType.Games && (
            <PlatformList platforms={release.platforms} />
          )}
        </div>
      </a>
    </Link>
  )
}

export default ReleaseCard
```

```css
.Cover {
  display: flex;
  width: 100%;
  height: 100%;
  background-color: #000;
  transition: opacity 250ms;

  &::after {
    position: absolute;
    top: 20%;
    left: 0;
    width: 100%;
    height: 80%;
    background-image: var(--release-card-cover-gradient);
    content: '';
  }

  * {
    width: 100%;
    height: 100%;
  }

  img {
    object-fit: cover;
  }
}
```

When I use [lazysizes](https://github.com/aFarkas/lazysizes) I had similar problem, but I fix it like this

You can check [it](https://github.com/aFarkas/lazysizes#broken-image-symbol)

```jsx
const IMG_PLACEHOLDER = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='

function Image({
  lazy = true,
  src,
  alt = '',
  ...rest
}: Props & HTMLAttributes<HTMLImageElement>) {
  const isAmp = useAmp()

  if (isAmp) {
    return <amp-img src={src} alt={alt} layout=""fill"" {...rest} />
  }

  if (lazy) {
    return (
      <img
        className=""lazyload""
        src={IMG_PLACEHOLDER} // It is fix that problem
        data-src={src}
        alt={alt}
        {...rest}
      />
    )
  }

  return <img  src={src} alt={alt} {...rest} />
}
``` ",styfle,kind: bug;please add a complete reproduction;type: needs investigation;area: next/image,2020-10-29T08:35:25Z,2020-11-11T22:53:03Z,shashkovdanil,Timer;shashkovdanil;styfle;balazsorban44,Timer;balazsorban44,,styfle,,styfle,
vercel/next.js,18452,"Internationalized Routing Error: lang attribute of <html> is not updated after router.push(...,{ locale: 'XX' }) in a non-dynamic getStaticProps page  # Bug report
Internationalized Routing Error: The lang attribute of <html> is not updated after router.push(...,{ locale: 'XX' }) in a non-dynamic getStaticProps page 

## Describe the bug
I have activated the internationlized routing with sub-path routing as described in https://nextjs.org/docs/advanced-features/i18n-routing
I am testing it within a static generated page (with getStaticProps), where through a button there will be a routing to another locale of the same page (via router.push(...,{ locale: 'XX' })):

```
router.push(
      router.pathname,
      router.asPath,
      { locale: menuItem.value }
    );
```
By checking with the inspector of the browser, I realize that the routing works (the page with the new locale is shown), but the lang attribute of <html> is not updated.

```
<html lang=""en"">
```
And after router.push(...,{ locale: ""fr"" }) it shows still:
```
<html lang=""en"">
```

## Expected behavior

The expected behaviour would be to have initially

```
<html lang=""en"">
```
And after router.push(...,{ locale: ""fr"" }) it would show:
```
<html lang=""fr"">
```

## System information

- OS: Windows 10
- Browser: chrome, firefox <any>
- Version of Next.js: 10.0.0
- Version of Node.js: 12.19.0

",ijjk,kind: bug,2020-10-29T09:50:50Z,2020-11-02T18:54:21Z,diegopelusa,krisu-pl;balazsorban44,timneutkens;Timer,,Timer,,,
vercel/next.js,18482,"I18n: disabling locale detection doesn't work # Bug report

## Describe the bug
`locale` parameter inside `getServerSideProps` is still detected based on `Accept-Language` header even after disabling it using `localeDetection: false`.

I18n config: 
```js
        i18n: {
            locales: ['he', 'ru', 'en'],
            defaultLocale: 'he',
            localeDetection: false,
        },
```
Locale inside `getServerSideProps` will be set to `en` (based on my browser's Accept-Language) instead of being set to default locale (in my case - `he`):
```js
export const getServerSideProps: GetServerSideProps = async ({ locale }) => {
    console.log(` locale ${locale}`); // will output 'en' instead of 'he'

    return {
        props: {
            something: 'something',
        },
    };
};
```

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Create `next.config.js` with `i18n` section and `localeDetection: false`
2. Create any page with `getServerSideProps` function and try to log locale param as show above

## Expected behavior
When disabling locale detection it should fallback to default locale
## Screenshots

## System information

- OS: Windows
- Browser: chrome
- Version of Next.js: 10.0.0
- Version of Node.js: 12.18.1

",ijjk,kind: bug,2020-10-29T14:28:58Z,2020-11-02T21:02:16Z,IskanderMustafin,javiercr;dmitrykozyrenko;ijjk;balazsorban44,Timer,,Timer,,,
vercel/next.js,18503,"[10.0.0][i18n][Vercel] a full-page reload occur on page transitions # Bug report

## Describe the bug

I use the `i18n` feature. Following links using `next/link` does a full page reload. This happens only when an app is deployed to Vercel.

## To Reproduce

Repository: [next.js-bug-i18n-reload](https://github.com/rokinsky/next.js-bug-i18n-reload)
Steps to reproduce the behavior:

1. Deploy the app to Vercel
2. Go to the website, e.g. [https://next-js-bug-i18n-reload.vercel.app](https://next-js-bug-i18n-reload.vercel.app)
3. Follow the listed links
4. See full page reload (pay attention to favicon if you use Chrome)

## Expected behavior

No page reloading

## Screenshots

N/A

## System information

- OS: macOS
- Browser (if applies): chrome
- Version of Next.js: 10.0.0
- Version of Node.js: v10.22.1

## Additional context

Works great locally in dev and prod modes.",ijjk,kind: bug,2020-10-29T21:13:43Z,2020-10-30T22:40:40Z,rokinsky,ijjk;rokinsky;GHermet;balazsorban44,ijjk,,ijjk,,ijjk,
vercel/next.js,18505,"[10.0.0][i18n][notFound][Vercel] undefined locale and locales in getStaticProps on custom 404-page # Bug report

## Describe the bug

I use the `notFound` and `i18n` features on SSG pages with enabled fallback (`blocking` strategy). Variables `locale` and `locales` are `undefined` in `getStaticProps` context when `notFound` occurs. This happens only when an app is deployed to Vercel.

## To Reproduce

Repository: [next.js-bug-i18n-not-found](https://github.com/rokinsky/next.js-bug-i18n-not-found)
Steps to reproduce the behavior:

1. Deploy the app to Vercel
2. Go to the website, e.g. [https://next-js-bug-i18n-not-found.vercel.app](https://next-js-bug-i18n-not-found.vercel.app)
2. See
```json
{
  ""is404"": true,
  ""locale"": """",
  ""locales"": []
}
``` 

## Expected behavior

Displaying 
```json
{
  ""is404"": true,
  ""locale"": ""en"",
  ""locales"": [
    ""en"",
    ""nl-nl"",
    ""de-de""
  ]
}
```

## Screenshots

N/A

## System information

- OS: macOS
- Browser (if applies): chrome
- Version of Next.js: 10.0.0
- Version of Node.js: v10.22.1

## Additional context

Works fine locally in dev and prod modes.",ijjk,kind: bug,2020-10-29T21:52:37Z,2020-10-30T01:42:29Z,rokinsky,balazsorban44,timneutkens;ijjk,,ijjk,,,
vercel/next.js,18509,"next/image serving large PNGs to Safari # Bug report

## Describe the bug

next/image is serving (large) PNG images to Safari when JPEG should be used.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Edit the [Next Image Component Example](https://github.com/vercel/next.js/tree/canary/examples/image-component) to include a JPEG file (see [commit](https://github.com/michrome/images/commit/3f26a7410795457942b5e148e05d9ae26d3fa37d)).
2. `npm run dev` or `npm run build && npm run start`
3. Inspect or copy the JPEG image from Safari
4. See a large PNG is returned

## Expected behavior

A JPEG to be served. Notes:

1. A JPEG is correctly served when deployed to Vercel.
2. this behaviour only affects Safari: Firefox is correctly serving WEBP.

## Screenshots

[video.mov.zip](https://github.com/vercel/next.js/files/5461835/video.mov.zip)

## System information

- OS: macOS Catalina 10.15.7
- Browser: Safari v14.0
- Version of Next.js: v10.0.0
- Version of Node.js: v12.18.2

## Other information

<img width=""930"" alt=""Screenshot 2020-10-29 at 23 35 00"" src=""https://user-images.githubusercontent.com/596770/97643406-77329e80-1a3f-11eb-9905-1ed99ff763a7.png"">
",styfle,kind: bug,2020-10-29T23:36:42Z,2020-11-01T23:53:36Z,michrome,michrome;balazsorban44,styfle,,styfle,,,
vercel/next.js,18510,"[10.0.0][i18n]  Desync between client and server with new internationalized routing # Bug report

There seems to be a desync between the client and the server when accessing a route other than '/' with a locale different from the locale that is automatically selected by the framework. Also, I'm not sure if it's related but a desync also happens when you reload the index page with a ""#"". For example, reloading the url ""http://localhost:3000/en#"" gives a desync warning too.

## To Reproduce

Steps to reproduce the behavior:

1. Clone this repo https://github.com/SelvinM/i18n-example
2. Make sure your browser language is english
3. Run the project with ""yarn dev""
4. Go to this route ""http://localhost:3000/gssp""""
5. Reload

## Expected behavior
No desync should happen.

## Screenshots

I get this warning on the project I'm working on:
![Captura](https://user-images.githubusercontent.com/29130026/97646825-5144d400-1a16-11eb-9cf2-957b186f3701.PNG)

This warning happens after you follow the steps I described earlier:
![Captura1](https://user-images.githubusercontent.com/29130026/97647048-e051ec00-1a16-11eb-940b-790522b87c93.PNG)


## System information

- OS: Windows 10
- Browser Chrome
- Version of Next.js: 10.0.0
- Version of Node.js: 14.11.0

## Additional context

This desync can become the culprit of bugs. For example, on the project I'm working on, I think the desync is the reason as to why the Link component in a language selector is not routing to the correct route after a server side redirect.",ijjk,kind: bug,2020-10-30T00:46:06Z,2020-11-02T23:00:42Z,SelvinM,fromi;balazsorban44,Timer,,Timer,,,
vercel/next.js,18536,"Image component fails with leading double slash (protocol-relative URLs) Out of curiosity, I was browsing the image optimiser code that landed in Next.js 10 (congrats and thank you!) when I noticed a potential bug in the `isAbsolute` condition branch:

https://github.com/vercel/next.js/blob/426331883638911dec6f93517d6b5406abac1d97/packages/next/next-server/server/image-optimizer.ts#L67

This assumes that [protocol-relative URLs](https://www.paulirish.com/2010/the-protocol-relative-url/) won't be passed to the optimiser, for example `//url.com/image.jpg` will request `https` when the caller is on `https`, and `http` when the caller is on `http`. 

This might be an edge case, but consider any folks migrating from their current `img` tags to the `next/image` component and using protocol-relative URLs; they'll encounter a bug where `next-server/image-optimizer` treats the URL as a file path.

An alternative would be to test a regex pattern for URLs:

```ts
if (!/^(https?:)?\/\//.test(url)) {
  // Relative URL/path
} else {
  // Absolute URL/path
}
```",styfle;Timer,kind: bug,2020-10-30T13:04:04Z,2020-11-04T20:47:50Z,daneden,JamesSingleton;styfle;balazsorban44,Timer;styfle,,Timer,,,
vercel/next.js,18549,"[i18n] Can't refresh the home page and keep the default language after selection # Bug report

## Describe the bug

I use v10 i18n feature. My app default language is 'en', my browser settings is 'fr'.
When I load the root page, I am redirected to '/fr', as expected.
However, if I change the language for 'English', I am redirected to '/', not '/en'. Now if I refresh I am redirected to '/fr' once again, whereas I specifically selected English language earlier.

Suggestion: when changing the locale using Router.push, always keep the locale explicit in the path.",ijjk,kind: bug,2020-10-30T16:38:59Z,2021-09-21T03:16:46Z,fromi,fromi;lipoolock;ijjk;balazsorban44,Timer,,Timer,,ijjk,
vercel/next.js,18563,"Cache-Control not automatically generating ETags and Last-Modified, RE: Image Optimization Next10 # Bug report

When using the new Image Optimization feature, it appears as though even though Cache-Control is being set, the response headers aren't including what should be automatically generated.

## Describe the bug

As an example for all my static images, I am adding cache-control.
e.g. 

```
const setHeadersForImages = (req, res) => {
    res.setHeader('Cache-Control', 'public,max-age=2592000000,immutable')
    return handle(req, res)
}

//This is how I was adding the headers PRE NEW IMAGE OPTIMIZATION
server.get('*.jpg', (req, res) => setHeadersForImages(req, res))
server.get('*.svg', (req, res) => setHeadersForImages(req, res))
server.get('*.png', (req, res) => setHeadersForImages(req, res))

//This is how I am adding the headers POST NEW IMAGE OPTIMIZATION
server.get(/^\/_next\/image/, (req, res) => setHeadersForImages(req, res))
```
I can see in the response headers that the cache control is being added just fine. But pre using the new Image Optimization, my response headers looked like:

```
cache-control: max-age=31536000
content-length: 774746
content-type: image/png
date: Fri, 30 Oct 2020 20:32:17 GMT
etag: ""92703e9f4803a0755947a4b150c7d9af""
last-modified: Mon, 28 Sep 2020 14:56:05 GMT
```

**and now while using the new feature they look like.**

```
Cache-Control: public,max-age=2592000000,immutable
Connection: keep-alive
Content-Type: image/webp
Date: Fri, 30 Oct 2020 20:39:42 GMT
Transfer-Encoding: chunked
X-Powered-By: Express
```

The ETag and date last modified is missing...hmmmm.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Implement a new Image Optimization component, using a static image.
2. Ensure in server.js you are doing
```
const setHeadersForImages = (req, res) => {
    // res.setHeader('Last-Modified', (new Date()).toUTCString())
    // res.setHeader('ETag', etag(req.originalUrl, { weak: true }))
    res.setHeader('Cache-Control', 'public,max-age=2592000000,immutable')

    return handle(req, res)
}


 server.get(/^\/_next\/image/, (req, res) => setHeadersForImages(req, res))
```
3. Check your response headers for the image in the network tab. See that ETag and Last-Modified are not present.

## Expected behavior

Expected behaviour is that the ETag and Last-Modified would be generated as they normally are when normal images are used, using the normal img tag.

## System information

- OS: macOS
- Browser Chrome
- Version of Next.js: [e.g. 10.0.0]
- Version of Node.js: [e.g. 12.18.3]

",styfle;Timer,kind: bug,2020-10-30T20:51:32Z,2020-11-10T04:40:27Z,Braedencraig,klaaz0r;balazsorban44,Timer;styfle,styfle,Timer,,,
vercel/next.js,18600,".ico support for next/image # Feature request

## Is your feature request related to a problem? Please describe.

The `Image` component from `next/image` should allow `.ico` files. Currently using a `.ico` file gives the error: `Input buffer contains unsupported image format`, which seems to come from `sharp`. 

## Describe the solution you'd like
`next/image` should support `.ico` files as the optimization step can be skipped for `.ico` files.",styfle,kind: bug,2020-11-01T03:10:13Z,2020-11-10T17:49:38Z,averryyy,balazsorban44,Timer;styfle,,styfle,,,
vercel/next.js,18601,"router.push() with hash does not work properly # Bug report

## Describe the bug

When using next/router's `router.push()` (and presumably other methods) with a `hash` parameter, the hash does not properly appear or the url ends up improperly interpolated (in the case of dynamic routes).

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to https://codesandbox.io/s/nextjs-router-push-with-hash-589dd
2. Click on `Static page with hash (good)` button
    * Notice URL changes with hash properly appended
3. Click on `Dynamic page with hash (bad)` **button**
    * Notice URL does _not_ have hash appended <-- bad!
3. Click on `Dynamic page with hash (bad)` **button** again
    * Notice URL is not properly interpolated with dynamic route params, although hash is added <-- bad!
3. Click on `Dynamic page with hash (bad)` **link**
    * Notice URL changes with hash properly appended (just to showcase <Link> works properly)

## Expected behavior

The URL should have the hash properly appended the first time the dynamic page button is clicked, and the URL should stay properly interpolated with dynamic route params the second time the dynamic page button is clicked.

## Screenshots

If applicable, add screenshots to help explain your problem.
![image](https://user-images.githubusercontent.com/5668416/97794789-6dce4100-1bbb-11eb-8088-28117a9a3c2d.png)

## System information

- OS: Windows
- Browser (if applies) Chrome
- Version of Next.js: 10.0.0
- Version of Node.js: v10.21.0

## Additional context

Add any other context about the problem here.
",ijjk,kind: bug,2020-11-01T03:59:05Z,2021-01-20T09:34:07Z,Pikachews,jperasmus;cyphire;jonathanmcchesney;ijjk;balazsorban44,Timer;ijjk,,Timer,Timer,timneutkens,
vercel/next.js,18602,"i18n routing disables incremental static regeneration I'm trying to find out why static revalidation seems to be disabled while using i18n routing. 

Here is a quick demo: https://nextjs-i18n-static-error.wiesson.vercel.app, here is the repo: https://github.com/wiesson/nextjs-i18n-static-error/blob/fix/pre-generation/pages/posts/%5Bslug%5D.js

https://nextjs-i18n-static-error.wiesson.vercel.app/posts/123_a or https://nextjs-i18n-static-error.wiesson.vercel.app/en/posts/123_a does not regenerate with the code below.

In order to trigger regeneration, I have added `const revalidatedAt = new Date().toISOString()` so that the props will be updated every time I visit the page.


```Javascript
import { useRouter } from ""next/router"";
import posts from ""../../posts"";

function Post(props) {
  const router = useRouter();
  if (router.isFallback) {
    return <div>Loading...</div>;
  }

  return (
    <div>
      Hello from {props.slug} with id: {props.id} at {props.revalidatedAt},
      locale {props.locale}
    </div>
  );
}

export const getStaticPaths = async ({ locales }) => {
  const paths = locales.reduce(
    (acc, next) => [
      ...acc,
      ...posts.map((slug) => ({
        params: {
          slug,
        },
        locale: next,
      })),
    ],
    []
  );

  return {
    paths,
    fallback: true,
  };
};

export const getStaticProps = async ({ params, locale }) => {
  const { slug } = params;

  if (!slug) {
    console.log(""slug not found"");
    console.log({ params, locale });

    return {
      notFound: true,
    };
  }

  const id = slug.match(/\d{3}/)[0];

  // fake some updated props to trigger regeneration
  const revalidatedAt = new Date().toISOString();
  const props = { slug, id, locale, revalidatedAt };

  console.log(props);

  return {
    props,
    revalidate: 1,
  };
};

export default Post;
```

I have noticed that during the build on vercel (or in general), the first item that `getStaticProps` receives is empty (but locale is set) and the paths from `getStaticPaths` are valid.

_Originally posted by @wiesson in https://github.com/vercel/next.js/discussions/18443_",ijjk,kind: bug,2020-11-01T04:25:04Z,2020-11-01T04:49:49Z,Timer,balazsorban44,Timer,,Timer,,,
vercel/next.js,18633,"[10.0.1-canary.4][i18n] undefined locale when navigating to root page # Bug report

## Describe the bug

I use the `i18n` feature on SSG pages with enabled fallback (`blocking` strategy). The variable `locale` is `undefined` and `params` is not empty in `getStaticProps` context when navigating to the root page using `next/link`.

## To Reproduce

Repository: [next.js-bug-i18n-root-params](https://github.com/rokinsky/next.js-bug-i18n-root-params)
Steps to reproduce the behavior:

1. Go to [http://localhost:3000](http://localhost:3000)
2. Click on `/nl-nl` link
3. See 
```json
{
  ""params"": {
    ""slug"": [
      ""nl-nl""
    ]
  },
  ""locale"": ""undefined""
}
```

## Expected behavior

Displaying
```json
{
  ""params"": {},
  ""locale"": ""nl-nl""
}
```

## Screenshots

N/A

## System information

- OS: macOS
- Browser (if applies): chrome
- Version of Next.js: 10.0.1-canary.4
- Version of Node.js: v10.22.1

## Additional context

N/A
",ijjk,kind: bug,2020-11-01T18:53:20Z,2020-11-11T20:33:45Z,rokinsky,rokinsky;Timer;balazsorban44,rokinsky;Timer;ijjk,Timer,Timer,,,
vercel/next.js,18636,"Locale detection redirect not working with base path # Bug report

## Describe the bug

When setting a `basePath` in `next.config.js` and loading the index page in the browser with a locale other than the default one, the redirect to that locale doesn't include the base path, resulting in an error.

## To Reproduce

1. Create the following `next.config.js` assuming your browser locale is `en`:

```javascript
module.exports = {
    basePath: '/prefix',
    i18n: {
        locales: ['en', 'de'],
        defaultLocale: 'de',
    },
}
```

2. Make sure you have an index page and build the app with `npm run build`.

3. Run the app with `npm start` and open http://localhost:3000/prefix in the browser.

4. You will be redirected to http://localhost:3000/en instead of http://localhost:3000/prefix/en, resulting in an error.

## Expected behavior

Locale detection redirection should include the base path.

## System information

- OS: All 
- Browser: All
- Version of Next.js: 10.0.0
- Version of Node.js: 10.22.1
",ijjk,kind: bug,2020-11-01T20:28:05Z,2020-11-12T05:26:49Z,stpch,balazsorban44,stpch;timneutkens;ijjk,timneutkens,Timer,,Timer,
vercel/next.js,18651,"404 pages in a SSG site are not revalidated in Next 10 # Bug report

## Describe the bug
When using Next 9.5, I had an optional catch all route in the root of my `pages` directory `[[...slug]].tsx` which made use of `getStaticPaths` (fallback: false) and `getStaticProps` (revalidate: 30).

This meant that any pages that did not exist in my site would throw the 404 page, which I had a template for in `pages/404.tsx`. That also had a `revalidate: 30`.

With this set up, if I visited mysite.com/cool-page and it 404'd, it would 404. However, if I created /cool-page and revisited it after it had the change to revalidate, I would then see /cool-page.

In Next 10, this is not happening and is preventing me from being able to upgrade to the latest version. When I try in Next 10, I am stuck with a 404 page all of the time, even after creating /cool-page.

## To Reproduce

If you require access to my test Contentful, please reach out and I can provide log in to the CMS and also provide access keys for the env vars (privately)

Run the below code in Next 9.5.5 and also in Next 10

Build the site `npm run build` and run it `npm run start`

go to a non-existent page, you should get a 404 (e.g. /my-page)

In the CMS, change one the pages to have the url from above (e.g. /my-page)

Reload the page, let it revalidate, reload again.

in 9.5.5 it fetches /my-page
in 10 it still 404's

`pages/[[...slug]].tsx`
```
const Index = ({page}) => {
  return (
    <div>
      {page.title}
    </div>
  )
}

const parsedUrlQueryAsUrlString = (params) => {
  const { slug, ...query } = params
  let url = '/'

  if (Array.isArray(slug)) {
    url = `/${slug.join('/')}`
  }
  else if (typeof slug === 'string') {
    url = `/${slug}`
  }

  return {
    url,
    query
  }
}

export const getStaticProps = async ({ params }) => {
  const req = await fetch(`https://cdn.contentful.com/spaces/${process.env.C_SPACE_ID}/environments/master/entries?access_token=${process.env.C_ACCESS_TOKEN}&content_type=standardPage`)
  const routes = await req.json()
  let { url } = parsedUrlQueryAsUrlString(params)
  console.log('url', url)
  let pageData

  const page = routes.items.find((item) => {
    console.log('item', item)
    return item.fields.urlPath === url
  })

  if (page) {
    const reqPage = await fetch(`https://cdn.contentful.com/spaces/${process.env.C_SPACE_ID}/environments/master/entries?access_token=${process.env.C_ACCESS_TOKEN}&sys.id=${page.sys.id}`)

    pageData = await reqPage.json()
  }

  return {
    props: pageData && {page: pageData.items[0].fields} || {},
    revalidate: 5,
  }
}

export async function getStaticPaths() {
  const req = await fetch(`https://cdn.contentful.com/spaces/${process.env.C_SPACE_ID}/environments/master/entries?access_token=${process.env.C_ACCESS_TOKEN}&content_type=standardPage`)
  const routes = await req.json()

  const params = routes.items.map((route) => {
    // We need to supply false for the root most route
    // (e.g. ""/"" and not ""/some/page"")
    if (route.fields.urlPath === '/') {
      return { params: { slug: false } }
    }

    return {
      params: {
        slug: route.fields.urlPath.replace('/', '').split('/'),
      },
    }
  })

  return {
    paths: params,
    fallback: false,
  }
}

export default Index
```

`404.tsx`
```
const NotFound = () => {
  return (
    <div>
      <p>not found</p>
    </div>
  )
}

export async function getStaticProps() {
  return {
    props: {},
    revalidate: 5
  }
}

export default NotFound
```

## Expected behavior

In Next 10, I was expecting to have the 404.tsx revalidate pages when they become existant like in version 9.5.5

## System information

- OS: macOs
- Browser (if applies) [e.g. chrome, safari]
- Version of Next.js: 9.5.5 and 10
- Version of Node.js: 12.19.0",ijjk,kind: bug,2020-11-02T00:14:00Z,2020-11-14T07:12:48Z,anthwinter,rokinsky;ijjk;anthwinter;pixelass;laarakus;NikitaMazur;balazsorban44,anthwinter;Timer;ijjk,Timer,Timer,,,
vercel/next.js,18672,"Fix i18n preload edge-cases > Noticed while investigating #18503 that preloads can be incorrectly generated when using the locale option since it isn't passed correctly to prefetchData and href and as aren't properly normalized to handle the locale option there. This corrects the behavior and adds tests ensuring the preloads are generated correctly.

Originally posted by @ijjk ",ijjk,kind: bug,2020-11-02T13:46:01Z,2020-11-02T17:22:41Z,Timer,balazsorban44,Timer,,Timer,,ijjk,
vercel/next.js,18673,"Experimental Next.js plugin version locking Our experimental Next.js Plugin system should force the version of a plugin to match that of Next.js, and refuse to run `next build`, `next dev`, or `next start` otherwise.",ijjk,kind: bug,2020-11-02T14:10:33Z,2020-11-12T04:59:58Z,Timer,balazsorban44,Timer;ijjk,ijjk,Timer,,Timer,
vercel/next.js,18679,Fix Windows CI,ijjk,kind: bug,2020-11-02T14:41:58Z,2020-11-09T05:56:40Z,Timer,balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,18681,"next/image webp not falling back for some unsupported browser # Bug report

## Describe the bug

next/image (WebP) not falling back to .jpg/.png for unsupported browser.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. git clone [Image Component Example](https://github.com/vercel/next.js/tree/canary/examples/image-component)
2. npm run dev
3. Use iphone to access http://ip:3000 (same network)

## Expected behavior

Should be able to fall back to show vercel.png instead of a blank area.

## Screenshots

If applicable, add screenshots to help explain your problem.

**iPhone6 iOS 11**
![iPhone6](https://user-images.githubusercontent.com/56999169/97880777-8cb80900-1d5c-11eb-8d2b-a1990e0b2827.gif)

**iPhone11 iOS 11**
![iPhone11](https://user-images.githubusercontent.com/56999169/97880820-95a8da80-1d5c-11eb-83d7-0be8f9397e16.gif)

## System information

- OS: [e.g. iOS <= 11]
- Browser (if applies) [e.g. safari (iPhone 6 to 11)]
- Version of Next.js: [e.g. 10.0.0]
- Version of Node.js: [e.g. v14.4.0]

## Additional context

Add any other context about the problem here.
",styfle,kind: bug,2020-11-02T14:44:22Z,2020-11-09T23:17:10Z,AmazingDevTeam,wilbsy;styfle;balazsorban44;mattjis;mglavall;Timer,AmazingDevTeam;Timer,Timer,Timer,,styfle,
vercel/next.js,18692,Investigate failing image-component tests These tests appear to be failing sometimes and should be stabilized https://github.com/vercel/next.js/pull/18687#pullrequestreview-521780495,styfle,kind: bug,2020-11-02T16:22:28Z,2020-11-04T21:14:56Z,ijjk,styfle;balazsorban44,ijjk;Timer;styfle,Timer,Timer,,,
vercel/next.js,18698,"Prop updates for next/image doesn't work # Bug report

## Describe the bug

When using `next/image` <Image /> component, after changing `src` prop, nothing happens. If `width` or `height` props are modified, image aspect ratio changes. But changing `src` has no effect. 

## To Reproduce

Here's sample repo: https://github.com/cactoo/next-image-dynamic-props-issue
Here's deployed sample: https://next-image-dynamic-props-issue.vercel.app/blog/post-1

1. Go to [localhost:3000](localhost:3000)
2. Click `Image 2` then `Image 1` (just have a play with it)
3. Image props are changing, but no effect on image below (well, it changes aspect ratio, but not actual picture)

And 2nd version, that's where I found this bug:
1. Go to [localhost:3000/blog/post-1](localhost:3000/blog/post-1)
2. Then click 'Blog post 2'
3. Page path (param) is changing, but same as above: image changes aspect ratio but not actual picture

## Expected behavior

When updating <Image /> `src`,  it should update. Allow dynamic image replacement.

## System information

- OS: macOS
- Browser (if applies) Chrome
- Version of Next.js: 10.0.0
- Version of Node.js: 12.18.3
## Screenshots

GIF below:
![sample](https://user-images.githubusercontent.com/11618314/97903586-8ff0cc00-1d3f-11eb-8796-b4299ef8c394.gif)


## Additional context

It's useful when you for example navigate from one blog post to the other.",Timer,kind: bug,2020-11-02T18:15:12Z,2020-11-06T23:03:16Z,cactoo,balazsorban44,cactoo;Timer,Timer,Timer,,,
vercel/next.js,18711,"Image component return 404 for images with redirects method in next.config.js # Bug report

## Describe the bug

Image component not creating images with redirects method in next.config.js, if I comment out it, then images works properly. Do I need to add some extra path config to redirects method to make images works?

## To Reproduce

next.config.js

```javascript
module.exports = {
  async redirects() {
    return [
      {
        source: '/',
        destination: '/wonziu',
        permanent: true,
      },
      {
        source: '/favourite/page/1',
        destination: '/favourite',
        permanent: true,
      },
      {
        source: '/:streamer/page/1',
        destination: '/:streamer',
        permanent: true,
      },
      {
        source: '/:streamer/:video',
        destination: '/:streamer/video/:video',
        permanent: true,
      },
    ];
  },
  images: {
    domains: ['assets.vercel.com'],
  },
};
```
## System information

- OS: macOS
- Version of Next.js: 10.0.0
- Version of Node.js: 12.16.1",ijjk,kind: bug,2020-11-02T21:47:11Z,2020-11-06T23:08:35Z,schriker,schriker;ijjk;balazsorban44,schriker;Timer,Timer,Timer,,ijjk,
vercel/next.js,18727,"[10.0.0][redirect][notFound] redirect must have a higher priority than notFound # Bug report

## Describe the bug

In the case where both `redirect` and `notFound` are returned, `notFound` currently has a higher priority. If I redirect somewhere, of course, this page probably doesn't exist.

## To Reproduce

Repository: [next.js-bug-redirect-not-found](https://github.com/rokinsky/next.js-bug-redirect-not-found)
Steps to reproduce the behavior:

1. Go to [http://localhost:3000](http://localhost:3000)
2. See 404 page

## Expected behavior

Displaying 
```json
{
  ""hello"": ""world""
}
```
with `/redirected` path and `307` status code

## Screenshots

N/A

## System information

- OS: macOS
- Browser (if applies): chrome
- Version of Next.js: 10.0.0
- Version of Node.js: v10.22.1

## Additional context

N/A",ijjk,kind: bug,2020-11-03T10:08:28Z,2020-11-11T22:02:11Z,rokinsky,timneutkens;balazsorban44,rokinsky;timneutkens;ijjk,timneutkens,ijjk,,,
vercel/next.js,18735,"Redirect from getStaticProps only redirects once # Bug report

## Describe the bug
When I go to a page that should be redirected with `getStaticProps` redirect, it is redirected.

Going to the page that should be redirected again, I get some props that look to be internal, and also get an error in the terminal.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. clone https://github.com/balazsorban44/next-example
2. build with `yarn build` and run in production mode with `yarn start`
3. Go to http://localhost:3000/should-redirect
4. You will be redirected to http://localhost:3000/redirected
5. Go to http://localhost:3000/should-redirect again
6. You will stay on http://localhost:3000/should-redirect, and some potentially internal props are shown
7. The terminal also shows an `Error [ERR_HTTP_HEADERS_SENT]: Cannot set headers after they are sent to the client` error. (see scrennshot for more details)

## Expected behavior

Whenever I go to a page that returns a redirect property, I expect the page to redirect to `destination`

## Screenshots

If applicable, add screenshots to help explain your problem.

A screenshot of what is shown the second time I go to an url that should redirect. The first time, the redirect happened, and I am presented with `/redirected` both in the URL and in the content.
Note: I am using a `pre` tag to show all the `props` sent to the page component
![image](https://user-images.githubusercontent.com/18369201/97981101-16ee8480-1dd2-11eb-83a1-bf916cf3bba9.png)


```sh
Error [ERR_HTTP_HEADERS_SENT]: Cannot set headers after they are sent to the client
    at ServerResponse.setHeader (_http_outgoing.js:526:11)
    at handleRedirect (/home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/render.js:17:1734)
    at renderToHTML (/home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/render.js:28:1094)
    at processTicksAndRejections (internal/process/task_queues.js:97:5)
    at async /home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/next-server.js:100:66
    at async __wrapper (/home/balazs/projects/redirect-gsp/node_modules/next/dist/lib/coalesced-function.js:1:330)
    at async Server.renderToHTMLWithComponents (/home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/next-server.js:125:376)
    at async Server.renderToHTML (/home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/next-server.js:126:711)
    at async Server.render (/home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/next-server.js:69:236)
    at async Object.fn (/home/balazs/projects/redirect-gsp/node_modules/next/dist/next-server/server/next-server.js:54:264) {
  code: 'ERR_HTTP_HEADERS_SENT'
}
```

## System information

- OS: Ubuntu 20.04
- Browser: Chrome 88.0.4300.0 (Official Build) dev (64-bit) *AND* Firefox 82.0 (64-bit)
- Version of Next.js: 10.0.0
- Version of Node.js: v12.19.0

## Additional context

I have used `create-next-app` for this example, but it occurs in my other Next.js projects that I currently upgraded to next@10 as well. (Meaning it is not `create-next-app` specific)

Question in addition. How is trailing slash handled in these cases? If I go to `http://localhost:3000/should-redirect/` would this have any different effect? As far as I understand, pages with a trailing slash are automatically redirected to their non-trailing slash counterpart. Would this mess something up here?",ijjk,kind: bug,2020-11-03T11:43:22Z,2020-11-04T22:18:45Z,balazsorban44,ijjk;balazsorban44,balazsorban44;timneutkens;ijjk,timneutkens;ijjk,Timer,,,
vercel/next.js,18745,"AMP page renders multiple times per single request # Bug report

## Describe the bug

AMP page renders 6 times per a single request.


## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Install this [example repository](https://github.com/vercel/next.js/tree/canary/examples/amp):
2. Add `console.log('hello')` statement just before the return statement (line 12) in `/pages/index.js`
3. run the project -`yarn build` && `yarn start`
4. Go to localhost:3000 and watch `hello` printed 6 times in the terminal - Means server executed the render function 6 times) 
## Expected behavior
Render function should execute only once. It happens in non-AMP.


## System information

- OS: macOS Mojave
- Version of Next.js:  Tested on 9.5.2 and 10.0.0
- Version of Node.js: 12.19.0
",ijjk,kind: bug,2020-11-03T15:07:27Z,2021-01-04T21:18:33Z,iliran11,iliran11;timneutkens;Linux249;ijjk;balazsorban44,iliran11;timneutkens;Timer,timneutkens,Timer,,ijjk,
vercel/next.js,18767,"_buildManifest.js and _ssgManifest.js should also send ""immutable"" in ""cache-control"" # Bug report

## Describe the bug

All js files that contain a hash in them send a header `cache-control: public, max-age=31536000, immutable`, but _buildManifest.js and _ssgManifest.js don't.

## To Reproduce

Run any Next.js app and check the headers of _buildManifest.js / _ssgManifest.js and compare to headers of any other js file.

Here's from a live deploy of my starter: https://next-typescript-tailwind-starter-eeb3dmhtn.vercel.app/

```
$ curl -s -I https://next-typescript-tailwind-starter-eeb3dmhtn.vercel.app/_next/static/chunks/pages/_app-fe957e929b383b773990.js | rg cache-control
cache-control: public,max-age=31536000,immutable
$ curl -s -I https://next-typescript-tailwind-starter-eeb3dmhtn.vercel.app/_next/static/zcYBg7WDsKKR5Bv4Ibhcz/_ssgManifest.js | rg cache-control
cache-control: public, max-age=0, must-revalidate
```

## Expected behavior

cache-control header should be set to immutable.

## System information

- OS: macOS
- Version of Next.js: 10.0.1
- Version of Node.js: 15.0.1

---

The fix likely involves editing https://github.com/vercel/next.js/blob/7e51b29c23e405c4b15add8026086d83d8431d9b/packages/next/next-server/server/next-server.ts#L534-L542.",Timer,kind: bug,2020-11-03T23:05:34Z,2020-11-10T14:19:27Z,utkarshkukreti,utkarshkukreti;Timer;balazsorban44,utkarshkukreti;timneutkens;Timer,timneutkens,Timer,,Timer,
vercel/next.js,18769,"FOUC using new Next.js 10 and React 17 # Bug report

## Describe the bug

Before Next.js 10, my [portfolio website](https://nicholaschiang.com) had no flashes of unstyled content on both the development server and after being deployed to Vercel. After upgrading to Next.js 10 and React 17, however, I seem to have lots:

![FOUC](https://user-images.githubusercontent.com/20798889/98053854-6d69bc00-1dee-11eb-9a81-77596c32b869.gif)

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to https://nicholaschiang.com
2. See FOUC

Or, if you want to reproduce locally:

1. Clone [this repository](https://github.com/nicholaschiang/website)
2. Follow [these instructions](https://github.com/nicholaschiang/website#development-environment) to install deps, etc
3. Run `yarn dev` or `yarn build && yarn start`
4. Open up http://localhost:3000
5. See FOUC

## Expected behavior

There should be no FOUC when using React 17 and Next.js 10.

## System information

- OS: PopOS 20.10
- Browser (if applies) Firefox
- Version of Next.js: 10.0.0
- Version of Node.js: 12.18.3",Timer,kind: bug;type: needs investigation,2020-11-04T00:06:14Z,2021-02-12T17:21:07Z,nicholaschiang,felixmosh;nicholaschiang;meandillar;AlexSapoznikov;ITSWYoo;Timer;nikoladev;serhii-baraniuk;nagman;drazik;gregorybolkenstijn;4lejandrito;hagilemha;osequi;michaeldever;phumaster;trompx;1jmj;alittlebitweird;dpatel4-lat;TylerJNewman;rgbskills,nicholaschiang;Timer,Timer,Timer,,Timer,
vercel/next.js,18795,"[i18n] redirects defined in next.config.js doesn't work on Vercel # Bug report

## Describe the bug
`redirects` defined with `i18n` config in `next.config.js` doesn't work when deploying to Vercel, but work in dev.

## Expected behavior
`redirects` with `i18n` should work when deploy to Vercel.

## System information

- OS: Windows
- Browser: Chrome
- Version of Next.js: 10.0.1
- Version of Node.js: 12.16.1
",ijjk,kind: bug,2020-11-04T15:50:34Z,2020-11-14T03:35:43Z,dmitrykozyrenko,fpahl;dohomi;ijjk;dmitrykozyrenko;balazsorban44,dmitrykozyrenko;Timer;ijjk,Timer;ijjk,Timer,,,
vercel/next.js,18799,"[Next 10][Next/Image] Image in Head breaks at build/server render time # Bug report

Images under an tag breaks at build/server render time

## To Reproduce

Repo: https://github.com/conanbatt/nextjs-webpack-5-images
1. yarn build 
OR
1. yarn dev -> go to /

Alternatively run this snippet in a page:
```
<Head>
  <noscript>
    <img src="""" />
  </noscript>
</Head>
```

## Expected behavior

Does not produce error

## Screenshots

![image](https://user-images.githubusercontent.com/268199/98142858-355d8a00-1e7d-11eb-954a-ab348cdf6926.png)

## System information

- Version of Next.js: [e.g. 10.0.1]
- Version of Webpack: [e.g. 5.4.0]

## Additional context

I believe this might be related to image changes in Next 10. The error points to the image tag being transformed into something that can't be processed. Does not happen on Next 9.5.3 and webpack 4

I was able to skirt around it by doing:
```
<noscript>
 {[<img src="""" key=""1]}
</noscript>
```",Timer,kind: bug,2020-11-04T17:11:44Z,2021-01-04T17:41:55Z,conanbatt,timneutkens;Timer;balazsorban44,conanbatt;Timer,Timer,Timer,,Timer,
vercel/next.js,18808,"Postcss config broken in next@10 # Bug report

## Describe the bug

In version 10, next.js upgraded the postcss version from `7` to `8`. This version unfortunately [is not compatible with postcss-preset-env](https://github.com/csstools/postcss-preset-env/issues/191), which is [used as a default by nextjs internally](https://github.com/vercel/next.js/blob/canary/packages/next/build/webpack/config/blocks/css/plugins.ts#L89).

This is kind of a big problem for anyone using postcss. Assuming that we don't want to back out and downgrade the postcss version in nextjs, and that preset-env will not soon become compatible with `postcss@8`, which i think is a safe assumption judging by [this issue](https://github.com/csstools/postcss-preset-env/issues/191), I think the only remaining option may be to either not default preset-env within nextjs at all, or break apart preset-env to its parts and build our own postcss-8-comptible preset-env, then include that with next.js.

## To Reproduce

I have created a full reproduction based on `create-next-app` here: https://github.com/jescalan/next-10-postcss-bug-repro/tree/main

Just run it with `next dev` to see the error. In this case, I turned on nesting and added a single nested selector -- the css breaks immediately as nesting is not processed by postcss. If you run the same thing with `next@9` it will work fine.

## System information

- OS: macOS
- Version of Next.js: 10.0.0
- Version of Node.js: 12.13.0",Timer,kind: bug,2020-11-04T19:27:53Z,2020-11-12T17:47:20Z,jescalan,Timer;ai;deadcoder0904;balazsorban44,jescalan;Timer,Timer,Timer,,Timer,
vercel/next.js,18827,"next/image IE11 support - fallback # Bug report

## Describe the bug

Yeah I know, IE11 support. Since next.js adds polyfills for IE11, I assumed the new next/image component works somehow with a fallback to the original image for IE11 browser too, but it doesn't work.

I saw a pull request `Fix image format for Safari and old browsers` #18646, it's included in 10.0.1 but it's not affecting IE11.


## To Reproduce

Steps to reproduce the behavior:

1. Clone the image-component example, https://github.com/vercel/next.js/tree/canary/examples/image-component
2. Open it with IE11
3. See no images

## HTML from IE11 Inspector

```html
<div
  style=""
    margin: 0px;
    overflow: hidden;
    display: inline-block;
    position: relative;
    max-width: 100%;
    box-sizing: border-box;
  ""
>
  <div style=""display: block; max-width: 100%; box-sizing: border-box"">
    <img
      role=""presentation""
      aria-hidden=""true""
      style=""display: block; max-width: 100%""
      alt=""""
      src='data:image/svg+xml;charset=utf-8,<svg width=""1000"" height=""1000"" xmlns=""http://www.w3.org/2000/svg"" version=""1.1""/>'
    />
  </div>
  <img
    class=""__lazy""
    style=""
      margin: auto;
      padding: 0px;
      border: currentColor;
      border-image: none;
      left: 0px;
      top: 0px;
      width: 0px;
      height: 0px;
      right: 0px;
      bottom: 0px;
      display: block;
      visibility: hidden;
      position: absolute;
      min-height: 100%;
      max-height: 100%;
      min-width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    ""
    alt=""Vercel logo""
    decoding=""async""
    data-srcset=""/_next/image?url=%2Fvercel.png&w=1080&q=75 1x, /_next/image?url=%2Fvercel.png&w=2048&q=75 2x, /_next/image?url=%2Fvercel.png&w=3840&q=75 3x""
    data-src=""/_next/image?url=%2Fvercel.png&w=3840&q=75""
  />
</div>

```

## Expected behavior

Show the images

## Screenshots

![image](https://user-images.githubusercontent.com/987947/98212482-f3e3e200-1f43-11eb-9bab-598ae605159c.png)

## System information

- OS: Windows
- Browser: IE11
- Version of Next.js: 10.0.1
- Version of Node.js: v12.13.1
",styfle,kind: bug,2020-11-05T08:05:42Z,2020-11-06T01:34:26Z,ciruz,mglavall;Timer;joepagan;balazsorban44,ciruz;Timer;styfle,Timer;styfle,styfle,,,
vercel/next.js,18850,"next/image produces invalid HTML according to W3C # Bug report

## Describe the bug

After implementing on our website, we noticed that our pages were now reporting invalid HTML errors on the W3C Markup Validation Service. 

Error: Bad value data:image/svg+xml;charset=utf-8,<svg width=""510"" height=""510"" xmlns=""http://www.w3.org/2000/svg"" version=""1.1""/> for attribute src on element img: Illegal character in scheme data: < is not allowed.

Error: Element img is missing required attribute src.

## To Reproduce

Create a blank page using next/image component and check it on the W3C Validator. 

https://validator.w3.org/

## Expected behavior

No Errors.

## Screenshots

![next-image-validation-error](https://user-images.githubusercontent.com/74015355/98279514-45e23300-1f57-11eb-99af-d69e0bd8737d.png)

## System information

N/A

## Additional context

Great work! If we can resolve this, it will be one of my favorite components!
",styfle,kind: bug,2020-11-05T18:09:18Z,2020-11-07T17:39:15Z,dmaksymec,balazsorban44,dmaksymec;Timer;styfle,Timer;styfle,styfle,,,
vercel/next.js,1888,"How to disable auto-refreshing when on error page? When there is 404/500 page rendered, the browser is auto-refreshing. It's very annoying, especially during the development of error page with dev tools and inspector.",arunoda,kind: bug,2017-05-05T13:17:11Z,2017-07-02T07:29:09Z,pie6k,arunoda;pie6k,arunoda,,arunoda,,arunoda,
vercel/next.js,18917,"Context declared in _app undefined during SSR in dev # Bug report

## Describe the bug

Running into basically this issue #4194 here _sometimes_, only in dev.

It's a fresh app, not much happening as of yet. A single context provider wrapping `Component` in app, and a index page using the context through a custom hook.
The contexts initial value is null, but its filled through the provider. The custom hook throws on empty context value. 

## To Reproduce

Repo: https://github.com/ljosberinn/AuctionCraftSniper/blob/518d537557/src/pages/_app.tsx

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Check that repo out (branch `next`)
2. `yarn dev`
3. click the link in the console to localhost:3000
4. first render will work
5. F5, crashes

## Expected behavior

Context should not be empty.

## Screenshots

_app:
![image](https://user-images.githubusercontent.com/29307652/98426134-fce5c800-2097-11eb-9da0-5da112dc826c.png)

AuthContextProvider rendering _with a value present_
![image](https://user-images.githubusercontent.com/29307652/98426247-62d24f80-2098-11eb-98ef-d21de03b503c.png)

index calling hook:
![image](https://user-images.githubusercontent.com/29307652/98426141-02dba900-2098-11eb-8d53-e97ac4412bd0.png)

Breakpoint where error is thrown:
![image](https://user-images.githubusercontent.com/29307652/98426050-bbedb380-2097-11eb-9d85-052d7dc8cd84.png)

Call Stack in VSCode Debugger:
![image](https://user-images.githubusercontent.com/29307652/98426061-c314c180-2097-11eb-9d69-e50941190cef.png)
Call Stack in Browser:
![image](https://user-images.githubusercontent.com/29307652/98426071-c90aa280-2097-11eb-95e6-848efb8508aa.png)
Call Stack in Console:
![image](https://user-images.githubusercontent.com/29307652/98426092-d6c02800-2097-11eb-9950-1917daadbf3b.png)


## System information

- OS: Win 10
- Browser (if applies) Chrome
- Version of Next.js: latest
- Version of Node.js: 15.0.1
",ijjk,kind: bug,2020-11-07T01:13:51Z,2021-01-01T17:39:40Z,ljosberinn,brandonbloom;PepijnSenders;balazsorban44;bscaspar;ijjk,ljosberinn;timneutkens;ijjk,timneutkens;ijjk,Timer,,Timer,vercel/next.js#20760;
vercel/next.js,18927,"context.locale on getStaticProps returns wrong locale when rewrites are used  # Bug report

## Describe the bug

A website with these urls:

```
/hello
/de/hallo
/es/hola
/ja/hello
```

All urls are served from the same page and SSG is used. Inspecting the context parameter on `getStaticProps`, gives us these results by url:

**/hello:**
```
{
  params: { ... },
  locales: [
    'en', 'de', 'es', 'ja',
  ],
  **locale: 'en',**
  defaultLocale: 'en'
}
```

**/de/hello and /es/hallo:**
```
{
  params: { ... },
  locales: [
    'en', 'de', 'es', 'ja',
  ],
  **locale: 'en',**
  defaultLocale: 'en'
}

```
**/ja/hello:**
```
{
  params: { ... },
  locales: [
    'en', 'de', 'es', 'ja',
  ],
  **locale: 'ja',**
  defaultLocale: 'en'
}
```


## To Reproduce

Create /pages/[slug]/hello.js:

```
export async function getStaticProps(context) {
  return {
    props: { ... },
    revalidate: 10,
  };
}

export async function getStaticPaths() {
  return {
    paths: [],
    fallback: 'blocking',
  };
}
```

Activated the new i18n feature:

```
  i18n: {
    locales: [
    'en', 'de', 'es', 'ja',
    ],
    defaultLocale: 'en',
  },
```

Add rewrites:

```
  async rewrites() {
    return [
      {
        source: ""/de/hallo"",
        destination: ""/hello"",
      },
      {
        source: ""/es/halo"",
        destination: ""/hello"",
      },
    ];
  },
```

## Expected behavior

context.locale should return the correct locale.

## System information

Version of Next.js: 10.0.1

## Additional context

This issues arrise when deployed to NOW. If I build it locally and run `npm run start` the context parameter has the correct locale.",ijjk,kind: bug,2020-11-07T15:39:15Z,2020-11-14T03:35:43Z,hk86,hk86;timneutkens;delucca;balazsorban44;ijjk,hk86;ijjk,ijjk,ijjk,,,
vercel/next.js,18929,"next start not working with React 17 on default create-next-app # Bug report
After creating app with `yarn create next-app` and running `yarn build && yarn start` browser page hangs.
When I remove `_app.js` file and return only one jsx string, I get this error:
```
TypeError: Object(...) is not a function
    at o (index-54f93a3aba2589cf692d.js:1)
    at no (framework.4ed712e956e4440973f2.js:1)
    at ju (framework.4ed712e956e4440973f2.js:1)
    at xi (framework.4ed712e956e4440973f2.js:1)
    at Si (framework.4ed712e956e4440973f2.js:1)
    at ki (framework.4ed712e956e4440973f2.js:1)
    at pi (framework.4ed712e956e4440973f2.js:1)
    at ii (framework.4ed712e956e4440973f2.js:1)
    at Ki (framework.4ed712e956e4440973f2.js:1)
    at framework.4ed712e956e4440973f2.js:1
```

The line in index.js file is `return Object(i.jsxDEV)...`.

Without any jsx and in development mode (`yarn dev`) there are no errors, so it's probably bug in build script.
After changing react to version 16 everything is working normally.

## To Reproduce

1. Create next app with `yarn create next-app`
2. Run `yarn build && yarn start`
3. Open browser

## Expected behavior
App should build and run without problems

## System information

- OS: Linux
- Browser: chrome, firefox
- Version of Next.js: 10.0.2
- Version of Node.js: 14.15.0",Timer,kind: bug;please add a complete reproduction;type: needs investigation,2020-11-07T17:51:01Z,2021-01-02T00:36:17Z,ozamorowski,jamesmosier;ozamorowski;MatthewCushing;correttojs;robschwitzer;OzzyCzech;balazsorban44,ozamorowski;jamesmosier;Timer,Timer,Timer,,,
vercel/next.js,18970,"Incorrect defaultLocale on server side domain routing. # Bug report

Getting incorrect `defaultLocale` on server side domain routing.

## Describe the bug

Getting incorrect `defaultLocale` when accessing locale information via the `getServerSideProps`'s context. Seems like it is getting the fallback `defaultLocale` instead of the `defaultLocale` assigned to the domain.

## To Reproduce

```javascript
// next.config.js
module.exports = {
  i18n: {
    locales: [""en"", ""ar""],
    defaultLocale: ""en"",

    domains: [
      {
        domain: ""example.com"",
        defaultLocale: ""en"",
      },
      {
        domain: ""example.ae"",
        defaultLocale: ""ar"",
      },
      {
        domain: ""sa.example.com"",
        defaultLocale: ""ar"",
      },
    ],
  },
};
```

```javascript
// when on domain ""example.ae""
import type { NextPage, GetServerSideProps } from ""next"";
import { useRouter } from ""next/router"";

const Home: NextPage = () => {
  const router = useRouter();
  // router.defaultLocale returns ""ar"" which is correct.
  return <div></div>;
};

export const getServerSideProps: GetServerSideProps = async (context) => {
  // context.defaultLocale returns ""en"" which is incorrect.

  return {
    props: {},
  };
};

export default Home;

```
## Expected behavior

I would expect it to return the `defaultLocale` of the domain instead of the fallback `defaultLocale`.

## System information

- OS: macOS
- Browser: chrome
- Version of Next.js: 10.0.1
- Version of Node.js: 12.4.0

",ijjk,kind: bug,2020-11-09T09:34:31Z,2020-11-11T02:09:46Z,wilson-alcantara,Timer;wilson-alcantara;balazsorban44,wilson-alcantara;Timer;ijjk,Timer,Timer,,,
vercel/next.js,18984,"SSR redirect destition with basePath # Bug report

## Describe the bug

We are using basePath in our application and from / we are directing to /[goalType] with Server Side Rendering. We are determining the goalType base on a API fetch and the language use in the app. GoalType can be AS or GE. If I use basePath '/resource-finder' and trying it, the page is hitted but I'm redirected to '/AS'. It should redirect me to '/resource-finder/AS'. I have the same behavior if using router.push('/AS').

Here's the getServerSideProps function
```javascript
export async function getServerSideProps(context) {
  const { i18n } = context.req;
  const isFrench = i18n.language.startsWith('fr');
  const sort = [isFrench ? 'descriptionFr' : 'descriptionEn'];

  const goals = [...((await GoalService.getGoals({ size: 1, sort }))._embedded?.goals ?? [])];
  const goal = goals.length ? goals[0] : undefined;

  // redirects to goal
  if (goal) return { props: {}, redirect: { destination: `/${goal.goalType}` } };

  // returns 404
  return { notFound: true };
}
```
## Expected behavior

Usins basePaht '/resource-finder should redirect me to '/resource-finder/AS' if using '/resource-finder/' path in the browser. This basePath is ignored in getServerSideProps and router.push().

## System information

- OS: Windows
- Version of Next.js: 10.0.1
- Version of Node.js: 15.1.0
",ijjk,kind: bug,2020-11-09T15:35:06Z,2020-11-11T07:13:19Z,sebascomeau,sebascomeau;ijjk;balazsorban44,sebascomeau;ijjk,ijjk,ijjk,,,
vercel/next.js,19001,"Bad `next build` when using new JSX transform & NODE_ENV=development # Bug report

## Describe the bug

When creating a production build in development (Weird use case, I know, but I use this to test a compiled app with development settings), next appears to be confused about whether to use jsx or jsxDEV.

The app appears to have SSG rendered fine (I get a brief flash of content,) however when hydration is triggered on the client, the #__next div is emptied, and an infinite error loop occurs. Thousands of `TypeError: Object(...) is not a function` (`Object(o.jsxDEV)(...)` in source) errors appear in the console. 

I don't know how next handles the JSX transform, but my guess is `next build` doesn't include `jsxDEV` on the client, somehow breaking the app.

<details>
  <summary>Full trace</summary>

```
TypeError: Object(...) is not a function
    at r.default (_app-b6e6c2c671f93d19d381.js:1)
    at no (framework.4ed712e956e4440973f2.js:1)
    at ju (framework.4ed712e956e4440973f2.js:1)
    at xi (framework.4ed712e956e4440973f2.js:1)
    at Si (framework.4ed712e956e4440973f2.js:1)
    at ki (framework.4ed712e956e4440973f2.js:1)
    at pi (framework.4ed712e956e4440973f2.js:1)
    at ii (framework.4ed712e956e4440973f2.js:1)
    at Ki (framework.4ed712e956e4440973f2.js:1)
    at framework.4ed712e956e4440973f2.js:1
```

Compiled source:

```js
r.default = function(e) {
  var r = e.Component
    , t = e.pageProps;

  // Error occurs here:

  return Object(o.jsxDEV)(r, function(e) {
    for (var r = 1; r < arguments.length; r++) {
      var t = null != arguments[r] ? arguments[r] : {};
      r % 2 ? c(Object(t), !0).forEach((function(r) {
          n(e, r, t[r])
        }
      )) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : c(Object(t)).forEach((function(r) {
          Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r))
        }
      ))
    }
    return e
  }({}, t), void 0, !1, {
    fileName: ""[...]/jsxdev-repro/pages/_app.js"",
    lineNumber: 4,
    columnNumber: 10
  }, this)
}
```
</details>

## To Reproduce

Pretty straightforward to reproduce:

```shell
npx create-next-app jsxdev-repro
cd jsxdev-repro
NODE_ENV=development npm run build
npm start
```
Open site in a browser

## Expected behavior

- Client should correctly compile with jsx or jsxDEV
- Hydration should not fail into a blank page state
- Hydration should not enter an infinite loop

## Screenshots

## System information

- macOS
- Tested in firefox & chrome
- Next 10.0.1
- React(-dom) 17.0.1
- Node 14.13

## Additional context

Add any other context about the problem here.
",Timer,kind: bug,2020-11-10T02:26:35Z,2021-01-02T00:36:17Z,AsherFoster,Timer;ChrisSargent;matthewdavidson;anestesya;TopHatMan;balazsorban44,AsherFoster;Timer,Timer,Timer,,,
vercel/next.js,19016,"Navigating to index.js with a query part in the url, give back a 404 error # Bug report
I'm using the index.js root page to do some optional stuffs based on url query string. 
I need to do it that way, because navigation to index page could have been started from a shared link (mail, whatsapp, sms, etc...) and that link has code in the query string associated with that optional operations.
I think this is quite a common pattern.

## Describe the bug
Up to Next 9.4.x all is going fine, as expected, but moving to Next 9.5.x something is going wrong. Asking for index give a 404 error (page not found), with or without a query string.

## To Reproduce
use base app with create-next-app (it should install Next 10.x now).
1) npx create-next-app my-app
2) cd my-app
3) npm run dev
4) from Chrome/Firefox go to localhost:3000 (you will see the app page correctly)
5) now from Chrome/Firefox go to localhost:3000/index and you'll see a 404 error page.

## Expected behavior
Navigating to localhost:3000 or localhost:3000/index or localhost:3000/index?param=1 should yeld the same result of rendering the index.js page.

## System information

- OS: [Linux Ubuntu 18.04]
- Browsers: Chrome, Firefox
- Version of Next.js: [>= 9.5.5]
- Version of Node.js: [10.22.1]

",ijjk,kind: bug,2020-11-10T13:39:03Z,2020-12-30T00:45:12Z,JumpinHack,ijjk;balazsorban44,JumpinHack;Timer,Timer,Timer,,Timer,
vercel/next.js,19026,"Failed to resolve ""@babel/runtime"" with Yarn 2 and Next.js canary # Bug report

## Describe the bug

I can't use Yarn 2.3.3 with Next.js canary.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. `yarn create next-app my-app`
2. `cd my-app`
3. `yarn dev`: everything works!
4. `yarn set version berry && yarn set version latest`
5. `yarn dev`: there's this output:
```
ready - started server on http://localhost:3000
error - ./.yarn/$$virtual/next-virtual-6b6cc49c53/0/cache/next-npm-10.0.2-canary.7-b861c3bd6e-81131dbf83.zip/node_modules/next/dist/client/dev/amp-dev.js
Error: [BABEL] /private/tmp/my-app/.yarn/$$virtual/next-virtual-6b6cc49c53/0/cache/next-npm-10.0.2-canary.7-b861c3bd6e-81131dbf83.zip/node_modules/next/dist/client/dev/amp-dev.js: Failed to resolve ""@babel/runtime"" relative to ""/private/tmp/my-app/.yarn/$$virtual/next-virtual-6b6cc49c53/0/cache/next-npm-10.0.2-canary.7-b861c3bd6e-81131dbf83.zip/node_modules/next/dist/build/babel"" (While processing: ""programmatic item$5"")
    at Generator.next (<anonymous>)
    at Generator.next (<anonymous>)
```
and `localhost:3000` hangs and doesn't render anything

## Expected behavior

no errors and the page renders fine. the following work as expected:
- Next.js 10.0.1 and Yarn 1.22.10
- Next.js 10.0.1 and Yarn 2.3.3
- Next.js 10.0.2-canary.7 and Yarn 1.22.10

but *not* Next.js 10.0.2-canary.7 and Yarn 2.3.3

## Screenshots

N/A

## System information

- OS: macOS 11.0 Beta (20A5395g)
- Browser: Chrome 86.0.4240.183, Safari 14.0.1 (16610.2.8.1.1), Firefox 81.0.1
- Version of Next.js: 10.0.1
- Version of React: 17.0.1
- Version of Node.js: 12.14.1

## Additional context

initially reported at https://github.com/vercel/next.js/issues/18913#issuecomment-724090647
",Timer,kind: bug,2020-11-10T17:59:06Z,2020-11-11T15:18:34Z,sumanthratna,balazsorban44,sumanthratna;Timer,Timer,Timer,,,
vercel/next.js,19041,"Image srcSet flashes then switches back to src image # Bug report

## Describe the bug
I use srcSet to display 2 different images: one on desktop and a different one mobile. My hero image needs to take full width of the container so I use `layout=""fill""`. The bug I encounter is that on mobile the image flashes to the srcSet specified on that size then flash back to the desktop image.   

## To Reproduce
Steps to reproduce the behavior, please provide code snippets or a repository:
I've written an example on codesandbox to explain what I am talking about:

1. Go to 'https://codesandbox.io/s/mutable-river-wi0uj'
2. Open in new window.
3. toggle device toolbar & use Iphone X for example, then refresh the page.
4. You will notice the `moving-truck-mobile.jpg` flashes then switches to `moving-truck.jpg`

## Expected behavior
The expected behaviour should display the `moving-truck-mobile.jpg` on mobile, knowing that it works for me when I use the html `img`
```js
<img
    src=""/moving-truck.jpg""
    srcSet=""/moving-truck-mobile.jpg 375w,
            /moving-truck-mobile.jpg 640w,
            /moving-truck.jpg""
     sizes=""(max-width: 375px) 375px, 100%""
     width=""100%""
/>
```

## System information

- Browser : chrome
- Version of Next.js:  10.0.1

",Timer,kind: bug;type: needs investigation,2020-11-11T03:14:46Z,2020-12-31T21:08:58Z,ettaibi,balazsorban44,ettaibi;Timer,Timer,Timer,,,
vercel/next.js,19048,"prefetch in combination with i18n and next/link locale:false result in 404 of defaultLocale # Bug report

## Describe the bug

Use of i18n and defaultLocale returns in prefetched links in the defaultLocale to be 404 not found.

## To Reproduce

Use i18n and SSG mode the prefetched links inside of the default locale are wrong. 

## Expected behavior

The generated refetch URL is wrong, defaultLocale === en
```
/_next/data/Zs6ypKU6jWKL8TDFyfTqC/home.json
instead of:
/_next/data/Zs6ypKU6jWKL8TDFyfTqC/en/home.json
```
https://storyblok-mui-planettraining-dohomi.lumenmedia1.vercel.app/
## System information

- OS: every
- Browser every
- Version of Next.js: 10.0.1
- Version of Node.js: 12.x

## Additional context

It seems that the defaultLocale is missing the defaultLocale inside of the PATH of the generated prefetch data links
",ijjk,kind: bug,2020-11-11T08:47:50Z,2020-11-20T21:50:27Z,dohomi,ijjk;dohomi;balazsorban44,dohomi;Timer,Timer,ijjk,,,
vercel/next.js,19067,"Fix flaky test ```
  閳 SSG Prerender 閳 production mode 閳 should reload page on failed data request, and retry

    expect(received).toMatch(expected)

    Expected pattern: /post.*?post-999/
    Received string:  """"

      689 | 
      690 |       const text = await browser.elementByCss('#params').text()
    > 691 |       expect(text).toMatch(/post.*?post-999/)
          |                    ^
      692 |     })
      693 |   }
      694 | 

      at Object.<anonymous> (integration/prerender/test/index.test.js:691:20)
          at runMicrotasks (<anonymous>)

```",ijjk,kind: bug,2020-11-11T18:43:34Z,2020-12-29T05:55:31Z,Timer,ijjk;balazsorban44,Timer,,Timer,,ijjk,
vercel/next.js,19068,"Investigate error case ![image](https://user-images.githubusercontent.com/616428/98851362-239f5800-2424-11eb-8459-23a1f8c3f94c.png)

We shouldn't be emitting the argument entity bug.",ijjk,kind: bug,2020-11-11T18:45:43Z,2020-11-19T16:25:55Z,Timer,balazsorban44,Timer,,Timer,,,
vercel/next.js,19069,"trailingSlash + i18n causing redirect issue on index # Bug report

## Describe the bug

Setting `i18n` and `trailingSlash: true` in next config results in too many redirects error when visiting the index route in development. 

## To Reproduce

1. Using next config of
```
i18n: {
    locales: ['en', 'fr'],
    defaultLocale: 'en'
},
trailingSlash: true
```
2. Visit `/` and the page loads
3. Visit `/fr/` and the error occurs

If you remove the prop `trailingSlash: true` it then works.

Here is a repo of a default create-next-app with the config above: https://github.com/edbrett/i18n-demo

## Expected behavior

The page should load.

## Screenshots

<img width=""673"" alt=""Screenshot 2020-11-11 at 18 48 49"" src=""https://user-images.githubusercontent.com/20288774/98851713-958c9700-244e-11eb-8a30-61ea985df729.png"">

## System information

- OS: macOS
- Browser chrome
- Version of Next.js: 10.0.1
- Version of Node.js: 12.16.2
",ijjk,kind: bug,2020-11-11T18:51:00Z,2020-11-20T18:45:48Z,edbrett,GiancarlosIO;edbrett;ijjk;balazsorban44,edbrett;timneutkens;ijjk,timneutkens,ijjk,,,
vercel/next.js,19071,Strongly type Next.js' serverless loader It's currently incorrectly using `sendPayload` (sending a boolean instead of object) and missing behavior. We should fix this via TypeScript.,ijjk,kind: bug,2020-11-11T20:23:33Z,2020-11-25T19:56:19Z,Timer,timneutkens;balazsorban44,Timer,Timer,Timer,,,
vercel/next.js,19095,"SSG static generation with fallback false, i18n and catch-all route missing root page on vercel # Bug report

## Describe the bug

Using SSG with catch-all route and i18n I get no page (directory listing) on vercel. It's working ok in local environment

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Clone repository https://github.com/vonschau/next-i18n-catchall
2. Deploy it to vercel
3. There's directory listing instead of root page (in all locales)

App has 2 locales - cs (default) and en.
You can see it on https://next-i18n-catchall.vercel.app/ or https://next-i18n-catchall.vercel.app/en.
Subpages are displayed correctly (ie. https://next-i18n-catchall.vercel.app/en/blog)

## Expected behavior

Root page is correctly displayed on vercel.

## Screenshots

![image](https://user-images.githubusercontent.com/1563734/98928433-104ec400-24da-11eb-8382-82ead631b5c9.png)


## System information

- OS: macOS
- Version of Next.js: 10.0.2-canary.12
- Version of Node.js: v14.8.0

## Additional context

I think the root pages are incorrectly generated as "".html"" & "".json"" files instead of index.html & index.json.
",ijjk,kind: bug,2020-11-12T10:28:48Z,2020-11-12T18:50:33Z,vonschau,balazsorban44,vonschau;ijjk,ijjk,ijjk,,,
vercel/next.js,19120,"The HTML generated by Image component is missing sizes ![image](https://user-images.githubusercontent.com/616428/98987157-df7b8880-24f3-11eb-8b73-315e1bf9c32f.png)

We should fix this so we pass validation.",styfle,kind: bug,2020-11-12T19:32:41Z,2020-11-13T04:30:42Z,Timer,balazsorban44,Timer;styfle,,styfle,,,
vercel/next.js,19122,"Progress spinner breaks with small apps # Bug report

Progress spinner breaks with small apps.

## Describe the bug

For apps with less than 4 pages, the progress spinner is borked for completed builds.

What's worse, is this is causing [Gasket](https://gasket.dev) apps with `next@^10` to hang when building. I believe it is related to the changes in https://github.com/vercel/next.js/pull/16815.

## To Reproduce

From the next.js repo root, run:
```
node packages/next/dist/bin/next build test/integration/polyfills
```

Notice at the end of the output `[    ] info  - Generating static pages (0/3)% `

## Expected behavior

The spinner text should update properly and stop before page data is output.

## Screenshots

![Screen Shot 2020-11-12 at 1 21 11 PM](https://user-images.githubusercontent.com/82775/98993276-7859d600-24eb-11eb-9e69-8c13dfe6f690.png)

## System information

- OS: [macOS]
- Version of Next.js: 10.0.1
- Version of Node.js: 12.18.3
",ijjk,kind: bug,2020-11-12T20:35:57Z,2020-11-20T16:57:36Z,kinetifex,balazsorban44,kinetifex;timneutkens;Timer,timneutkens,Timer,,,
vercel/next.js,19200,"@next/plugin-storybook does not work with experimental `modern: true` config option # Bug report

when using the `experimental: { modern: true }` config option in `next.config.js`, and configuring storybook with `@next/plugin-storybook`, starting storybook fails with: ""NextEsmPlugin: TypeError: Cannot read property 'chunks' of undefined"".

## Describe the bug

see above

## To Reproduce

1. Clone repro at [https://github.com/stefanprobst/next-storybook-issue](https://github.com/stefanprobst/next-storybook-issue)
2. `yarn && yarn storybook`
3. see error

## Expected behavior

`@next/plugin-storybook` should work with `modern: true` config.

## Screenshots

![next-storybook](https://user-images.githubusercontent.com/20753323/99198416-c9422680-2798-11eb-8dee-3f6788599be8.png)

## System information

- OS: ubuntu 20.04
- Version of Next.js: 10.0.1
- Version of Node.js: 14.15.0

## Additional context

i realize that both `modern: true` and `@next/plugin-storybook` are marked as experimental, so feel free to close or move to discussions.
",Timer,kind: bug;area: experimental,2020-11-15T22:20:32Z,2020-11-18T18:30:01Z,stefanprobst,timneutkens;balazsorban44,stefanprobst;timneutkens;Timer,timneutkens,Timer,,,
vercel/next.js,19214,"[i18n] next/link can navigate to unconfigured locale <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

It's possible to navigate to a locale that is not configured using next/link.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to https://codesandbox.io/s/suspicious-jackson-qh7qr
2. Click on the ""About (FR)"" link
3. The page shows up, instead of displaying a 404 immediately
4. After a page refresh, the 404 is shown correctly

## Expected behavior

Links to non-configured locales should show a 404 page when clicking on them.

Optionally, a dev warning could be shown when using a `locale` prop that is not valid.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- Version of Next.js: 10.0.2-canary.18
",ijjk,kind: bug,2020-11-16T17:14:50Z,2020-11-20T15:07:01Z,jerstucki,balazsorban44,jerstucki;timneutkens;ijjk,timneutkens,ijjk,,,
vercel/next.js,19230,"Fast Refresh not working with getStaticProps <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Working with Next.js 10.0. According to the release docs, any changes made in the getStaticProps function will automatically reflect on the page without a need to refresh but that does not seem to be happening. 

## To Reproduce
Create a route with the code supplied below, change/add any key to the object being returned and save. Check whether the page rendered on the browser changes automatically or not.

Steps to reproduce the behavior, please provide code snippets or a repository:

``` jsx
import Head from 'next/head'
import styles from '../styles/Home.module.css'

export default function TestImage({data}) {
  console.log('props passed :', data);
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <link rel=""icon"" href=""/favicon.ico"" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title}>
          Hey There! <code className={styles.codelarge}>I'm {data.name}</code>
        </h1>
        <h1 className={styles.title}>
          I'm a <code className={styles.codelarge}>{data.age}</code> years old {data.job}.
        </h1>
      </main>

      <footer className={styles.footer}>
        <a
          href=""https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app""
          target=""_blank""
          rel=""noopener noreferrer""
        >
          Powered by{' '}
          <img src=""/vercel.svg"" alt=""Vercel Logo"" className={styles.logo} />
        </a>
      </footer>
    </div>
  )
}

export async function getStaticProps() {
  // Get external data from the file system, API, DB, etc.
  const data = {
    name: 'John',
    age: 28,
    job: 'actor'
  }

  // The value of the `props` key will be
  //  passed to the `Home` component
  return {
    props: {data}
  }
}
```

## Expected behavior

Upon changing any value for any key that is returned from inside of getStaticProps, the page should reflect the same upon saving.

## System information

- OS: macOs
- Browser Chrome
- Version of Next.js: 10.0.1
- Version of Node.js: 10.16.0

",ijjk,kind: bug;type: needs investigation;area: Compiler,2020-11-17T07:23:44Z,2022-02-16T22:32:25Z,kokanek,timneutkens;kokanek;thanders;rishi-raj-jain;schickling;ijjk;bondom,kokanek;timneutkens,timneutkens,,,ijjk,
vercel/next.js,19237,"_app context loses state when navigating back (looks like vercel only, 10.0.2^18) <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

I have wrapped a context around `_app` and it looses it's state when I navigate back (via browser or `<Link />` (at least I think that is the problem, might be introduced with https://github.com/vercel/next.js/pull/19006, but I'm also not 100% sure)

_app.js
```Javascript
import { ListContextProvider } from ""../context"";

function MyApp({ Component, pageProps }) {
  return (
    <ListContextProvider>
      <Component {...pageProps} />
    </ListContextProvider>
  );
}
```

Usage in List Component
```Javascript
const List = ({ items = [] }) => { // initial state comes from the parent component
  const context = useContext(ListContext);

  function loadMoreFn() {
    context.addFn([makeId(6), makeId(6), makeId(6), makeId(6)]); // just faking additional random data 
  }

  return (
    <>
      <div className={styles.grid}>
        {items.concat(context.items).map((item) => ( // yes, could also be done with useEffect and useState, but for simplicity 
          <Link href={`/detail/${item}`} key={item}>
            <a className={styles.card}>
              <h3>{item} &rarr;</h3>
            </a>
          </Link>
        ))}
      </div>

      <button onClick={loadMoreFn}>Load more</button>
    </>
  );
};
```

## To Reproduce

Repo - https://github.com/wiesson/next-testing
Basic demo - https://next-testing-six.vercel.app 

1. Click on load more, 
2. Follow an item (loaded or existing)
3. go back afterwards

## Expected behavior

The state should not be cleared and it worked well before 10.0.2. It does not happen locally (`next start`), but on Vercel.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- Version of Next.js: 10.0.2^18
- Deployment: Vercel",ijjk,kind: bug,2020-11-17T15:54:16Z,2020-11-17T20:09:57Z,wiesson,ijjk;wiesson;balazsorban44,wiesson;Timer,Timer;ijjk,Timer,,Timer,
vercel/next.js,19294,"Routing with queries in root url is not working with basePath setting <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug
To add new query-strings to current URL, I used `Router.push` with query string. However, when called routing method like `push` or `replace` in root URL, error is raised.

```
The provided as value (/) is incompatible with the href value (/[fooId]).
```

When I disable the basePath configuration, the error does not appear. Also, no errors found in other urls. 

## To Reproduce
https://github.com/titicacadev/next-routing-bug-reproduction

1. Go to http://localhost:3000/foo
2. Click buttons.

## Expected behavior

URL should become `/foo?foo=bar`

## System information

- OS: macOS
- Browser (if applies) chrome
- Version of Next.js: 10.0.1
- Version of Node.js: 12.18.3
- Deployment: [e.g. next start, next export, Vercel, other platform]",ijjk,kind: bug,2020-11-19T04:26:59Z,2020-12-30T05:37:27Z,giwan-dev,ijjk;balazsorban44,giwan-dev;timneutkens,timneutkens,Timer,,,
vercel/next.js,19302,"redirects i18n locale:false not working as expected <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Redirects i18n feature with setting `locale: false` not working as expected.

## To Reproduce

```js
// one singular api catchall endpoint: [[...index]].tsx

 i18n: {
    defaultLocale: 'en',
    locales: ['en', 'de', 'it', 'es']
  },

async redirects(){
  return [{
    source: '/fussballtraining/fussballuebung-torschuss',
    destination: '/de/fussballtraining/fussballuebung-torschuss',
    locale: false,
    permanent: true
 }]
}
```

## Expected behavior

I expect that any request of `/fussballtraining/fussballuebung-torschuss` will be redirect to `/de/fussballtraining/fussballuebung-torschuss`.

## Current behaviour

The redirect is falsely redirecting to: `/en/de/fussballtraining/fussballuebung-torschuss` which results to a 500 / 404 error.

## System information
- Version of Next.js: 10.0.2
- Version of Node.js: 12.0.x
- Deployment: all platforms

### Background

There are pages in the Google index without the locale identifier. I want all this pages redirected to the `/{locale}/` counterpart.",ijjk,kind: bug,2020-11-19T07:38:33Z,2020-12-04T10:14:56Z,dohomi,domtaylor;balazsorban44,dohomi;ijjk,ijjk,ijjk,,,
vercel/next.js,19314,"Images disappear at all viewport sizes with 'layout=""responsive""'  # Bug report

## Describe the bug
Images disappear at all viewport sizes with 'layout=""responsive""' 

## To Reproduce
Steps to reproduce the behaviour, please provide code snippets or a repository:

```
<Image src=""/updates.svg"" width={600} height={400} layout=""responsive"" />
```

Image disappears at all viewpoint sizes.

## Expected behavior
Image to change size, depending on viewport size.

## System information
- OS: [e.g. macOS, Windows]
Mint 19.2
- Browser (if applies) [e.g. chrome, safari]
FF, Chrome
- Version of Next.js: [e.g. 10.0.1]
10.0.1
- Version of Node.js: [e.g. 12.0.0]
12.10.0
- Deployment: [e.g. next start, next export, Vercel, other platform]
next start

Add any other context about the problem here.
<Image /> would be more trouble than it's worth even if it did work.  It overrides the CSS for the img tag, making it impossible to modify the size in sync with the text.",Timer,kind: bug,2020-11-19T13:51:30Z,2021-01-04T17:34:35Z,pkail,timneutkens;danzawadzki;Beezey;sfonua10;Timer;T10kingjames;gabeodame;josegoval;ghost;balazsorban44,pkail;timneutkens,timneutkens,Timer,,Timer,
vercel/next.js,19399,"Using Preact, some components get rendered multiple times as duplicates <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

When using Preact (via `next-plugin-preact`), some components get rendered multiple times as duplicates.

Unfortunately, I still haven't found the root cause. The only information I have right now is that the issue doesn't occur if I use React instead.

## To Reproduce

Please see the following video (it's only about 1 minute) to see how to reproduce it.
https://streamable.com/nbkpuz

For references:
1. This is the site that is using preact in the video: 
    - https://jackyef-git-using-preact.jackyef.vercel.app/posts/6-things-i-learned-during-my-remote-job-search
    - code: https://github.com/jackyef/my-site/pull/40
2. This is the site that is using react: 
    - https://jackyef-git-using-react.jackyef.vercel.app/posts/6-things-i-learned-during-my-remote-job-search
    - code: https://github.com/jackyef/my-site/pull/39


## Expected behavior

Using Preact should have the same result with using React.

## System information

- OS: Windows
- Browser: Chrome
- Version of Next.js: 10.0.2
- Version of Node.js: 12.18.0
- Deployment: Vercel

## Additional context

Add any other context about the problem here.

The duplicated component was rendered lazily using a combination of IntersectionObserver and `next/dynamic`. The code for the component can be seen [here](https://github.com/jackyef/my-site/blob/master/src/components/Webmention/LazyWebmentionWidget.tsx) and it is rendered [here](https://github.com/jackyef/my-site/blob/master/src/components/Blog/Post/Post.tsx#L63). The component basically fetches data from an API using `react-query` and then renders some UI.",Timer,kind: bug,2020-11-21T18:07:58Z,2020-11-23T15:04:14Z,jackyef,marvinhagemeister;srdjan;jackyef;AlexMeah;developit;Timer;balazsorban44,jackyef;Timer,Timer,Timer,,,
vercel/next.js,19403,"[i18n + redirects] defaultLocale was ignored # Bug report

## Describe the bug

`defaultLocale` was ingored in redirects with i18n.

i18n config: `{ locales: ['en', 'fr', 'zh'], defaultLocale: 'en' }`
redirects config: `{ source: '/first-page', destination: '/second-page', permanent: true }`

We will be redirected from `/first-page` to `/en/second-page`, for `fr` and `zh` locales redirect is correct.

## To Reproduce

Described in the `Describe the bug` section.

## Expected behavior

`defaultLocale` should be stripped from redirects.

## System information

- OS: Windows, Linux
- Browser: Chrome
- Version of Next.js: 10.0.3-canary.0
- Version of Node.js: 12.16.1
- Deployment: dev, next start, Vercel
",ijjk,kind: bug,2020-11-21T20:19:50Z,2020-12-04T10:14:56Z,dmitrykozyrenko,dmitrykozyrenko;balazsorban44,dmitrykozyrenko;timneutkens;ijjk,timneutkens,ijjk,,,
vercel/next.js,19405,"[i18n + redirects] unnecessary redirect for index page # Bug report

## Describe the bug

Unnecessary redirect for index page.

i18n config: `{ locales: ['en', 'fr', 'zh'], defaultLocale: 'en' }`
redirects config: `{ source: '/first-page', destination: '/', permanent: true }`

In this case we have three redirects instead of two: `/first-page` -> `/en/` -> `/en`, `/fr/first-page` -> `/fr/` -> `/fr`

## To Reproduce

Described in the `Describe the bug` section.

## Expected behavior

For index page we should redirect only once, from `/first-page` -> `/en`

## System information

- OS: Windows
- Browser: Chrome
- Version of Next.js: 10.0.3-canary.0
- Version of Node.js: 12.16.1
- Deployment: dev, next start, Vercel
",ijjk,kind: bug,2020-11-21T20:23:35Z,2020-12-22T17:12:54Z,dmitrykozyrenko,balazsorban44,dmitrykozyrenko;timneutkens;ijjk,timneutkens;ijjk,ijjk,,,
vercel/next.js,19437,"Configuring `basePath` and using query parameters breaks routing in frontend. # Bug report

## Describe the bug

When configuring the `basePath` in the `next.config.js` and then accessing the index page with a query parameter, the next frontend rewrites the URL in a broken way. The configured `basePath` is appended a second time, so that we are on `/basePath/basePath?foo=bar`, which is not actually a working page.

## To Reproduce

I created a repository here: https://github.com/Lynbarry/next-basepath-bug

All I did in there was use `npx create-next-app` and add a `next.config.js` with the following content:

```
module.exports = {
  basePath: ""/basePath"",
};
```

To reproduce the behavior:
1. Run `npm run dev`
2. Go to `localhost:3000/basePath?foo=bar`
3. Notice that the URL changes to `localhost:3000/basePath/basePath?foo=bar` in the frontend
4. Reload the page to get a 404

## Expected behavior

Don't add the basePath a second time. The URL should stay `localhost:3000/basePath?foo=bar`

## System information

- OS: macOS
- Browser: chrome, firefox (probably any browser)
- Version of Next.js: 10.0.2
- Version of Node.js: v12.13.1",ijjk,kind: bug,2020-11-23T10:51:16Z,2020-12-30T05:37:27Z,Lynbarry,Tomburgs;acfasj;ijjk;Lynbarry;balazsorban44,Lynbarry;timneutkens,timneutkens,Timer,,,
vercel/next.js,19448,"Next@10.0.2 breaks builds that rely on @babel/runtime being resolved relatively. <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Next has changed the way it imports `@babel/runtime`

**Next@10.0.1**
```js
var _interopRequireDefault = require(""@babel/runtime/helpers/interopRequireDefault"");
```

**Next@10.0.2**
```js
var _interopRequireDefault = require(""/home/USER/PROJECT/node_modules/@babel/runtime/helpers/interopRequireDefault"");
```

This has broken our deployments, as we build on one image and deploy on a different one, which would require a different absolute path.

We now get MODULE_NOT_FOUND errors. 


## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. This happens by default on all Next.js builds

## Expected behavior

`@babel/runtime` is required with a relative path, so we don't have to worry about external environment.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- OS: Ubuntu (probably all OSes)
- Browser (if applies) [e.g. chrome, safari]
- Version of Next.js: 10.0.2
- Version of Node.js: 12


## Additional context

",Timer,kind: bug,2020-11-23T17:06:36Z,2021-01-02T00:27:00Z,RossMcMillan92,Timer;balazsorban44,RossMcMillan92;Timer,Timer,Timer,,Timer,
vercel/next.js,19478,"[Next/Image] Images on Safari are getting downloaded multiple times in different sizes <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

The image component is only requesting the image in the original size on safari for some reason, the requested Url always looks like this `http://localhost:3000/_next/image?url=%2Fitalian-fabric-dark-blue.jpg&w=3840&q=75`.

Code:
```js
export default function Home() {
  return (
    <div className=""max-w-screen p-16"">
      <Head>
        <title>Create Next App</title>
        <link rel=""icon"" href=""/favicon.ico"" />
      </Head>

      <main className=""max-w-full max-h-full"">
        <div className=""relative"">
          <Image
            src=""/italian-fabric-dark-blue.jpg""
            width={3984}
            height={2656}
            alt=""""
          />
        </div>
      </main>
    </div>
  )
}
```

html output:
```Html
<main class=""max-w-full max-h-full"">
  <div class=""relative"">
    <div
      style=""
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        position: relative;
        box-sizing: border-box;
        margin: 0;
      ""
    >
      <div style=""box-sizing: border-box; display: block; max-width: 100%"">
        <img
          style=""max-width: 100%; display: block""
          alt=""""
          aria-hidden=""true""
          role=""presentation""
          src=""data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzk4NCIgaGVpZ2h0PSIyNjU2IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIvPg==""
        />
      </div>
      <img
        alt=""""
        src=""/_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=3840&amp;q=75""
        decoding=""async""
        style=""
          visibility: visible;
          position: absolute;
          top: 0px;
          left: 0px;
          bottom: 0px;
          right: 0px;
          box-sizing: border-box;
          padding: 0px;
          border: none;
          margin: auto;
          display: block;
          width: 0px;
          height: 0px;
          min-width: 100%;
          max-width: 100%;
          min-height: 100%;
          max-height: 100%;
        ""
        srcset=""
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=3840&amp;q=75 1x
        ""
      />
    </div>
  </div>
</main>
```

and when adding the sizes attributes two images are requested at the same time `http://localhost:3000/_next/image?url=%2Fitalian-fabric-dark-blue.jpg&w=3840&q=75` and `http://localhost:3000/_next/image?url=%2Fitalian-fabric-dark-blue.jpg&w=640&q=75`

code:
```js
export default function Home() {
  return (
    <div className=""max-w-screen p-16"">
      <Head>
        <title>Create Next App</title>
        <link rel=""icon"" href=""/favicon.ico"" />
      </Head>

      <main className=""max-w-full max-h-full"">
        <div className=""relative"">
          <Image
            src=""/italian-fabric-dark-blue.jpg""
            width={3984}
            height={2656}
            sizes=""50vw""
            alt=""""
          />
        </div>
      </main>
    </div>
  )
}
```

output
```Html
<main class=""max-w-full max-h-full"">
  <div class=""relative"">
    <div
      style=""
        display: block;
        overflow: hidden;
        position: relative;
        box-sizing: border-box;
        margin: 0;
      ""
    >
      <div
        style=""
          display: block;
          box-sizing: border-box;
          padding-top: 66.66666666666666%;
        ""
      ></div>
      <img
        alt=""""
        src=""/_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=3840&amp;q=75""
        decoding=""async""
        style=""
          visibility: visible;
          position: absolute;
          top: 0px;
          left: 0px;
          bottom: 0px;
          right: 0px;
          box-sizing: border-box;
          padding: 0px;
          border: none;
          margin: auto;
          display: block;
          width: 0px;
          height: 0px;
          min-width: 100%;
          max-width: 100%;
          min-height: 100%;
          max-height: 100%;
        ""
        sizes=""50vw""
        srcset=""
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=640&amp;q=75   640w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=750&amp;q=75   750w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=828&amp;q=75   828w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=1080&amp;q=75 1080w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=1200&amp;q=75 1200w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=1920&amp;q=75 1920w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=2048&amp;q=75 2048w,
          /_next/image?url=%2Fitalian-fabric-dark-blue.jpg&amp;w=3840&amp;q=75 3840w
        ""
      />
    </div>
  </div>
</main>
```

Our production server is also crashing every time it is visited from a Safari browser (seems to happen more on iOS) and this error is logged

```bash
Killed
error Command failed with exit code 137.
````

## To Reproduce

here is a minimal [codeSandbox](https://codesandbox.io/s/eager-firefly-xmrtd?file=/pages/index.js).

1. open the sandbox in Safari
2. open network tab
3. notice the image is loaded in the original size
4. add the sizes attribute the Image component
5. notice the image loaded twice in the network tab

## Expected behaviour

The Image component should load the correct image like in other browsers

## System information

- OS: macOS 11.0.1
- Browser Safari
- Version of Next.js: 10.0.3
- Version of Node.js: 14.15.0
- Deployment: next start

## Additional context

Add any other context about the problem here.
",shuding,kind: bug;type: needs investigation,2020-11-24T12:54:46Z,2021-03-09T19:07:01Z,Elia-Darwish,Elia-Darwish;ericvrp;joshourisman;rmhowe;bryanMeneses;balazsorban44,Elia-Darwish;Timer,Timer,shuding,,,
vercel/next.js,19520,"Page with url `/developments` causes issues with `stripNextDataPath()` # Bug report

## Describe the bug

A page with URL `/developments` causes a server error when rendered.

## To Reproduce

Repl.it:
https://repl.it/@berndartmueller/nextjs10xx-stripNextDataPath-bug

1. Click on ""CLICK HERE TO SEE ERROR"" link
2. Error `TypeError: Cannot read property 'toLowerCase' of undefined` is thrown on SSR in terminal

OR 

1. npx create-next-app --example i18n-routing i18n-app
2. `cd i18n-app/pages`
3. `mkdir developments`
4. Create index.js with following demo content (does not really matter):
```
import Link from 'next/link'
import { useRouter } from 'next/router'

export default function DevelopmentsPage(props) {
  const router = useRouter()
  const { defaultLocale } = router

  return (
    <div>
      <h1>getStaticProps page</h1>
      <p>Current locale: {props.locale}</p>
      <p>Default locale: {defaultLocale}</p>
      <p>Configured locales: {JSON.stringify(props.locales)}</p>

      <Link href=""/gsp/first"">
        <a>To dynamic getStaticProps page</a>
      </Link>
      <br />

      <Link href=""/gssp"">
        <a>To getServerSideProps page</a>
      </Link>
      <br />

      <Link href=""/"">
        <a>To index page</a>
      </Link>
      <br />
    </div>
  )
}

export const getStaticProps = ({ locale, locales }) => {
  return {
    props: {
      locale,
      locales,
    },
  }
}
```

4. `yarn dev`
5. Navigate in browser to /developments page
6. Error on server:

```
TypeError: Cannot read property 'toLowerCase' of undefined
    at PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/lib/i18n/normalize-locale-path.js:3:91
    at Array.some (<anonymous>)
    at normalizeLocalePath (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/lib/i18n/normalize-locale-path.js:3:57)
    at stripNextDataPath (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/server/next-server.js:84:555)
    at DevServer.renderToHTMLWithComponents (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/server/next-server.js:86:35)
    at DevServer.renderToHTML (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/server/next-server.js:124:484)
    at async DevServer.renderToHTML (PROJECT_PATH/i18n-app/node_modules/next/dist/server/next-dev-server.js:34:578)
    at async DevServer.render (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/server/next-server.js:71:236)
    at async Object.fn (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/server/next-server.js:46:704)
    at async Router.execute (PROJECT_PATH/i18n-app/node_modules/next/dist/next-server/server/router.js:24:67)
```

## Expected behavior

Successfully rendered /developments page

## System information

- OS: macOS
- Version of Next.js: 10.0.4 (<=10.0.4)
- Version of Node.js: 12.19.0
- Deployment: next dev

## Additional context

This line causes the issue: https://github.com/vercel/next.js/blob/f4bf8a4696af6f9a0b64636205356ba207fb1ea9/packages/next/next-server/server/next-server.ts#L1315

It's because this custom created page `/developments` causes an issue when the string is split by the `this.buildId` (=""development"")",ijjk,kind: bug,2020-11-25T12:26:38Z,2021-01-19T18:27:30Z,berndartmueller,balazsorban44,Timer;ijjk,,ijjk,,,
vercel/next.js,19521,"Rewrites with i18n causes TypeError: Expected ""nextInternalLocale"" to be a string <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Using rewrites in next.config.js together with following `i18n` settings:

```
i18n: {
  locales: ['en', 'de'],
  defaultLocale: 'de',
  localeDetection: false,
}
```

Rewrite example:

```
async rewrites() {
    const rewrites = [
      {
        source: '/gssp-alternative',
        destination: '/gssp',
      },
    ];

    return rewrites;
  },
```

Navigating in browser from / to /gssp-alternative causes a client-side runtime error.

## To Reproduce

https://repl.it/@berndartmueller/nextjs1003-nextInternalLocale-bug

1. Click on ""CLICK HERE TO SEE ERROR"" link
2. Error popup is shown with error `TypeError: Expected ""nextInternalLocale"" to be a string`

## Expected behavior

No error.

## System information

- OS: macOS
- Browser: does not matter
- Version of Next.js: 10.0.3
- Version of Node.js: Don't know, it's repl.it :D
- Deployment: next dev

Thanks a lot!
",ijjk,kind: bug,2020-11-25T13:27:39Z,2020-12-04T10:14:56Z,berndartmueller,delucca;muserref-sefer;berndartmueller;kivohin;mengqing;ijjk;balazsorban44,berndartmueller;ijjk,ijjk,ijjk,,,
vercel/next.js,19599,"Nested public folder is ignored by the Next.js builder <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

If there's a nested `public` folder, like `public/public/icon.png`, `icon.png` should be available under `/public/icon.png`. But in the case of Vercel that's currently not the case and it will be under `/icon.png`.

## To Reproduce

Add a file under `public/public` and deploy to Vercel. Locally it works fine with `next dev` and `next start`.

## System information

- Version of Next.js: 10.0.1",ijjk,kind: bug,2020-11-27T14:35:40Z,2020-12-08T15:25:56Z,lfades,balazsorban44,lfades;ijjk,,ijjk,,Timer,
vercel/next.js,19630,"External image broken on Vercel builds with next/image # Bug report

## Describe the bug

When using an external image with dynamic query params like what Reddit has, it works on development but when deployed to Vercel, `INTERNAL_UNEXPECTED_ERROR` will be thrown.

## To Reproduce

Create a fresh Next app and paste this on your `index.js` file and deploy to Vercel.

```javascript
import Image from 'next/image'

export default function Home() {
  const src = ""https://preview.redd.it/p4nxklz18z161.jpg?width=640&crop=smart&auto=webp&s=0cc1daae30269488f127e29e2db48e201456bf40"";

  return (
    <div>
      <Image width=""640"" height=""853"" src={src} />
    </div>
  )
}
```

Repo:  https://github.com/wobsoriano/next-image-error
Demo: https://image-error-next.vercel.app/
Vercel image URL: https://bit.ly/3mhJdrc

## Expected behavior

I expect it to work on Vercel just as it does on local development.

## System information

- OS: Mac OS
- Version of Next.js: 10.0.3
- Deployment: Vercel",nkzawa,kind: bug,2020-11-28T16:28:39Z,2020-12-01T09:34:31Z,wobsoriano,wobsoriano;timneutkens;balazsorban44,wobsoriano;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,1966,"[Question] is it normal that ComponentDidMount is triggerred twice when using next/link? So I have simply ""single post page"" that can be navigated through links (post?slug=x), and in getInitialProps Im dispatching action to get data for the singlePost, thing is that after clicking a link I have this scenario (in page single post page component):
shouldComponentUpdate -> componentDidUpdate -> componentDidUpdate (extra)
I would like to dispatch some additional actions after component will be loaded with the new post but its dispatching twice because of this.. or I just have a bug, but I spend some time on it already and it will be good to know if this is not a normal behaviour.

Menu with links: https://github.com/lzgrzebski/teachmesilence.com/blob/master/src/components/Menu/index.js
SinglePostContainer: https://github.com/lzgrzebski/teachmesilence.com/blob/master/src/containers/SinglePostContainer.js
post page: https://github.com/lzgrzebski/teachmesilence.com/blob/master/src/pages/post.js",arunoda,kind: bug,2017-05-14T21:14:23Z,2018-05-25T22:41:12Z,lzgrzebski,lfades;timneutkens,timneutkens,,arunoda,,timneutkens,
vercel/next.js,19711,"next/image component can't find image when using basePath # Bug report

## Describe the bug

Trying to use `next/image` while setting the `basePath` property in the next.config.js file, causing the image to break with the following error:
image:1 GET http://localhost:3000/_next/image?url=%2Fmountains.jpg&w=750&q=75 404 (Not Found)



## To Reproduce
I've created a repo out of your official image-component example:
https://github.com/talcodota/nextjs-image-basepath-issue

1. yarn
2. yarn dev
3. go to http://localhost:3000/base/layout-intrinsic
4. console error:
image:1 GET http://localhost:3000/_next/image?url=%2Fmountains.jpg&w=750&q=75 404 (Not Found)

## Expected behavior

Show the image with no error

## Screenshots

![Screen Shot 2020-12-01 at 17 09 37](https://user-images.githubusercontent.com/69414424/100758276-01cc3c00-33f8-11eb-96cc-99a0b771c3a7.png)

## System information

- OS: macOS
- Browser (if applies) Chrome
- Version of Next.js: 10.0.0
- Version of Node.js: 14.15.0
- Deployment: next dev

## Additional context

Nothing
",ijjk,kind: bug,2020-12-01T15:12:29Z,2020-12-30T01:57:09Z,talcodota,ericag1985;ppbl;foreseaz;snigo;gtodd876;lucasalmeida92;thaismartins;vidjul;balazsorban44,talcodota;timneutkens;ijjk,timneutkens,ijjk,,,
vercel/next.js,19747,"When using locales, error happen by using URL parameters and dynamic routes # Bug report

## Describe the bug
When using non default locales, error happen by using URL parameters and dynamic routes

## To Reproduce
I created a sample of what I am experiencing currently with that topic here https://ud4rt.sse.codesandbox.io
You can check the source code over there : https://codesandbox.io/s/misty-water-ud4rt

Current issue spotted:
1. Click on non default locale like `fr` or `nl` to change the locale in the URL
2. By clicking on `/b?a=1&b=2&c=3` button, I should be routed properly to B page and passing parameters to it
(same with `/c?a=1&b=2&c=3` button)

You will get this error
```
Unhandled Runtime Error

Error: The provided `as` value (/b) is incompatible with the `href` value (/[page]/[subpage]). Read more: https://err.sh/vercel/next.js/incompatible-href-as
```

## Expected behavior
It should behave the same with non default and default locale. Currently everything runs well with `en` which is the default locale

## Screenshots
![route_issue](https://user-images.githubusercontent.com/42861634/100885103-8f6c6200-34b2-11eb-8cce-648c36a1a6fd.jpg)

## System information
- via codesandbox.io
",ijjk,kind: bug,2020-12-02T14:27:32Z,2020-12-12T14:06:47Z,lipoolock,lipoolock;balazsorban44,lipoolock;ijjk,ijjk,ijjk,,,
vercel/next.js,19784,"Disable sub-path i18n routing # Bug report

## Describe the bug

When using [Domain Routing](https://nextjs.org/docs/advanced-features/i18n-routing#domain-routing) combined with trailing slash redirects, a page without a trailing slash is getting redirected to a locale sub-path even though the documentation states ""The default locale does not have a prefix"".

```
// next.config.js
module.exports = {
  trailingSlash: true,
  i18n: {
    locales: ['en-GB', 'fi-FI'],
    defaultLocale: 'en-GB',
    localeDetection: false,
    domains: [
      {
        domain: 'example.com',
        defaultLocale: 'en-GB',
      },
      {
        domain: 'example.fi',
        defaultLocale: 'fi-FI',
      },
    ]
  }
};
```
When visiting https://example.com/page/one, it redirects the user to https://example.com/en-GB/page/one/. Is there no way to completely disable sub-paths?

## To Reproduce

There is a code sandbox set up to demonstrate the issue - https://codesandbox.io/s/staging-glade-hx5pe.

1. Append `/day` to the URL in the address bar (without trailing slash)
2. You will be redirected to `/en-GB/day/`

Strangely enough, this behaviour doesn't happen if you append `/about` to the URL, you are only redirected to `/about/` which is the expected behaviour.

`about.js` is a top level page `pages/about.js`, whereas `/day/` is served from `pages/day/index.js`

## Expected behavior

As mentioned above, the expected behaviour would be for the redirect _not_ to insert a locale sub-path into the URL. I would expect https://example.com/page/one to redirect to https://example.com/page/one/.
",ijjk,kind: bug,2020-12-03T11:35:22Z,2020-12-07T17:36:47Z,tomellwood,zephyrmathias;DedaDev;balazsorban44,tomellwood;ijjk,ijjk,ijjk,,,
vercel/next.js,19817,"next/image - sizerSvg style not overriding padding, margins etc to match imgStyle If you target `img` margins with something like the CSS below, you end up with a stretched image.

```css
/* @tailwindcss/typography does this */
.prose img {
  margin-top: 2em;
  margin-bottom: 2em;
}
```

I _think_ this is because [`margin` and `padding` aren't being overridden for the sizerSvg](https://github.com/vercel/next.js/blob/fddad89cbccd74d74553986c79f387d2369e6185/packages/next/client/image.tsx#L384). They are being overridden for the [actual Img](https://github.com/vercel/next.js/blob/fddad89cbccd74d74553986c79f387d2369e6185/packages/next/client/image.tsx#L258), so the sizerSvg should be updated to match that.

![Screenshot 2020-12-04 at 11 27 26](https://user-images.githubusercontent.com/596770/101158898-7257a080-3624-11eb-9672-712f8aac4790.png)


",Timer,kind: bug,2020-12-04T11:33:19Z,2020-12-29T17:34:12Z,michrome,ajitzero;michrome;balazsorban44,Timer,,Timer,,,
vercel/next.js,19849,"SSG doesn't work for 404 error pages in Vercel environment when using getInitialProps on _app <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report
SSG doesn't work for 404 error pages in Vercel environment when using getInitialProps on _app

## Describe the bug
Since there is still no support for [getStaticProps on _app](https://github.com/vercel/next.js/discussions/10949), I'm forced to keep using getInitialProps on _app to fetch common data for shared components (header, footer, seo, ...). Up until this point, I had no problems with this approach since I'm using getStaticProps to fetch data in all of my pages, and this **does not** opt-out of SSG. So only downside is that my website cannot use automatic static optimization.

However, today I noticed that when I go to page that does not exists and I get redirected to a 404 error page, I see changes in header that were made after the build. What is even more strange is that even when I clear all of my cache, on all subsequent requests to this page, changes in header are no longer reflected. **But** they still are reflected on 404 pages that i didn't access yet (but also only on the first access). The way it works closely resembles how Incremental Static Generation works.

It is important to note that I'm returning an empty getStaticProps in this page also, since I want the 404 error page to be also able to utilize SSG (since I'm using getInitialProps on _app and this is not automatic). (See screenshots below)

When seeing the build log, I get a full dot next to the 404 page meaning the page is statically pre-generated.

When running `npm run build` and `npm run start` on localhost, this issue does not occur. Not even when exporting to serverless environment (target: 'serverless' in next.config). But once I push the project to Vercel, the problem arises. From what I have discovered during my research, this bug is exclusive to Vercel environment.

## To Reproduce

1. Run getInitialProps on _app
2. Create a custom 404 error page with empty getStaticProps
3. Push to Vercel
4. Go to a page that does not exist

## Expected behavior

I expect the page to be statically generated since that is what I'm seeing from the build output.

## Screenshots
Custom 404:
<img width=""751"" alt=""Screenshot 2020-12-04 at 19 41 13"" src=""https://user-images.githubusercontent.com/52152407/101201876-ae145980-3668-11eb-8c3d-054558992113.png"">
Build output:
<img width=""607"" alt=""Screenshot 2020-12-04 at 19 46 03"" src=""https://user-images.githubusercontent.com/52152407/101203291-bbcade80-366a-11eb-8c68-44b0b35c681a.png"">

## System information

- OS: macOS 11.0.1
- Browser: Chrome 87.0.4280.88
- Version of Next.js: 10.0.3
- Version of Node.js: 12.14.1
- Deployment: Vercel

## Additional context

During my research I also discovered that getStaticProps is not passing data to custom 404 component. I don't know if that's intentional. I didn't find it mentioned anywhere in the documentation though.
",ijjk,kind: bug,2020-12-04T18:58:17Z,2021-01-04T20:53:30Z,vajajak,vajajak;zenflow;ijjk;kmkr;balazsorban44,vajajak;timneutkens,timneutkens,,,,
vercel/next.js,19862,"TypeError: require.resolveWeak is not a function (jest test) <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

There's an error when trying to test a component which contains a dynamic imported component. The error i get is `TypeError: require.resolveWeak is not a function`. 

## To Reproduce

1. Clone the repo https://github.com/Emiliano-Bucci/jest-with-dynamic-import- (it's a fork of the repo `with-jest` example)
2. Run tests

## Expected behavior

It should be possible to test components which contains dynamic imported components, or dynamic components itself.

## Screenshots

![image](https://user-images.githubusercontent.com/36669369/101622250-17a0b900-3a17-11eb-908e-fd30f7a86784.png)

## System information

- OS: macOS 11.0.1
- Browser: Chrome 87.0.4280.88
- Version of Next.js: 10.0.3
- Version of Node.js: 12.14.1
- Deployment: Vercel
",huozhi,kind: bug;good first issue,2020-12-05T11:14:59Z,2021-06-28T13:23:15Z,Emiliano-Bucci,Emiliano-Bucci;andrewmclagan;timneutkens;robinpiets;vojto;balazsorban44,Emiliano-Bucci;timneutkens,timneutkens,huozhi,,,
vercel/next.js,19928,"Next.js compiles .ts files outside of the application directory, but not .tsx files # Bug report

## Describe the bug

Next.js supports TypeScript, which means that it is able to load `.ts` and `.tsx` files from within the application directory. In addition, Next.js also supports loading files from *outside* the application directory, e.g. to be able to use shared components. However, this only works for `.ts` files, not for `.tsx` files. This is unexpected and makes it hard to work with re-usable UI components, without having to come up with a separate npm module for them, which is often not what you need.

## To Reproduce

We have set up a sample repository with a small, but complete example to reproduce the issue. Please see https://github.com/thenativeweb/temp--next-issue for details. The `README.md` file contains the detailed description on how to reproduce the issue.

## Expected behavior

Next.js should not only support `.ts` files from outside the application directory, but `.tsx` files as well.

## System information

- OS: `macOS Big Sur (11.0.1)`
- Version of Next.js: `10.0.3`
- Version of Node.js: `14.14.0`
- Deployment: `npx next`

## Additional context

Setting up a separate npm module for the shared components is definitely not what we want to use. Even the various Next.js applications we have shall be in a single npm module, as they get started altogether using a custom server. So in the end, although our ""real"" repository contains multiple Next.js applications, there is only one actual application in the end. This is also the reason why we don't want to go down the `next-transpile-modules` road (it would force us to introduce separate modules as well).

Given that Next.js is able without any ado to handle `.ts` files from outside the application directory, we assume that the same should be possible for `.tsx` files.",Timer,kind: bug;type: needs investigation,2020-12-07T12:49:12Z,2021-06-21T12:48:24Z,goloroden,Timer;goloroden;timneutkens;balazsorban44,goloroden;Timer,Timer,Timer,,Timer,
vercel/next.js,19934,"[i18n] i18n breaks optional catch-all route for index <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Under the following conditions, the index page can't be accessed:

- i18n configured
- top-level optional catch-all route `pages/[[...slug]].tsx`
- `fallback: false` is used in `getStaticPaths`

Changing any of those will ""fix"" the problem:

- Disabling i18n
- Moving the catch-all route to a sub-path like `pages/blog/[[...slug]].tsx`
- Using `fallback: ""blocking""`

Obviously, it should work nontheless ;)

## To Reproduce

1. Go to https://codesandbox.io/s/practical-meitner-iq7pj
2. The index page https://iq7pj.sse.codesandbox.io/ shows a 404
3. Any other page https://iq7pj.sse.codesandbox.io/another will work

## Expected behavior

A clear and concise description of what you expected to happen.

## Screenshots

If applicable, add screenshots to help explain your problem.

## System information

- Version of Next.js: 10.0.3 and 10.0.4-canary.2
- Version of Node.js: 14
- Deployment: next dev
",ijjk,kind: bug,2020-12-07T17:04:30Z,2021-01-01T04:36:21Z,jerstucki,ijjk;jerstucki;balazsorban44,jerstucki;Timer;ijjk,Timer,ijjk,,ijjk,
vercel/next.js,19935,"Type checking skipped for files with names like pages/contest.tsx # Bug report

## Describe the bug

NextJS skips type checking for files with .test.* extensions.

Due to a bug in the regex that checks for those files, it also skips type checking for files that end in test.*, like contest.tsx

This is probably due to a bug in `packages/next/lib/typescript/runTypeCheck.ts`, at const `const regexIgnoredFile = /[\\/]__(?:tests|mocks)__[\\/]|(?:spec|test)\.[^\\/]+$/`

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Create a typescript application with a `pages/contest.tsx` route
2. Introduce a typing error on that page
3. yarn build
4. Builds successfully
5. rename `contest.tsx` to `contst.tsx`
6. yarn build
6. See type error

I used this content:

```
import React from ""react"";

export default function Home() {
  return <div invalidProp=""invalidValue""/>
}
```
## Expected behavior

A type error should be reported in step 4

## System information

- OS: CentOS 7
- Version of Next.js: 10.0.1
- Version of Node.js: 12.19.0

",Timer,kind: bug,2020-12-07T17:20:05Z,2020-12-30T15:49:37Z,mtimmerm,balazsorban44,mtimmerm;Timer,Timer,Timer,,,
vercel/next.js,19950,"[i18n] Optional catch-all route masks more specific routes on client side <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

When i18n is configured, an optional catch-all route will mask a more specific route, but on client-side navigation only.

```
pages/
  blog/
    [id].tsx
  [[...slug]].tsx
```

In this case, the `[[...slug]]` route will render when using a `<Link href=""/blog/1"">`.

When i18n is disabled, this works correctly.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to https://codesandbox.io/s/youthful-https-bo1dp
2. Click on the link to /blog/1
3. The page will show the catch-all route (i.e. `Slug is [""blog"", ""1""]`) instead of the more specific blog route
4. Reload page or go directly to https://bo1dp.sse.codesandbox.io/blog/1
5. Blog route will be rendered correctly.

## Expected behavior

The behavior should be the same, regardless of i18n being enabled or not.

## System information

- Version of Next.js: 10.0.3, 10.0.4-canary.2
- Version of Node.js: 14
- Deployment: next dev
",ijjk,kind: bug,2020-12-08T09:12:16Z,2021-01-01T04:44:51Z,jerstucki,jerstucki;ijjk;balazsorban44,jerstucki;timneutkens;ijjk,timneutkens,Timer,,ijjk,
vercel/next.js,19964,"next/image having specificity issues with Tailwind Typography # Bug report

## Describe the bug

When using Tailwind Typography and the `prose` element, it automatically adds margin-top and bottom to the `img` element. This messes up the responsive-ness of the `next/image` component.

## To Reproduce

I've set a width and height
![image](https://user-images.githubusercontent.com/9113740/101501610-8f96b280-3935-11eb-96f8-d187668d501d.png)

But it's displayed wrong
![image](https://user-images.githubusercontent.com/9113740/101501515-73931100-3935-11eb-9b8a-52c8bff83666.png)

Toggling these styles fixes it.
![image](https://user-images.githubusercontent.com/9113740/101501490-6a09a900-3935-11eb-85f2-20bf12fca96d.png)

## Expected behavior

I'd be great if we can build this into `next/image` to prevent users from hitting issues with Tailwind Typography.

## Screenshots

See repo.

## System information

- OS: Mac
- Browser: Chrome
- Version of Next.js: 10.0.3
- Deployment: next start and Vercel",Timer,kind: bug,2020-12-08T15:15:13Z,2020-12-29T17:34:12Z,leerob,erhankaradeniz;leerob;brandonpittman;michrome;balazsorban44,leerob;Timer,Timer,Timer,,,vercel/next.js#19817;
vercel/next.js,20058,"Router bug with Catch-All routes <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

This appears to be an issue with Catch-All-Routes and the query-string params presented in the asPath.  If query string is present the router url will update but the actual page will not change.  This appears to only happen in dev environment.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Download repo from ""https://github.com/rmsheppard/next-router-error""
2. run in ""npm run dev""
3. Click on ""Managed Project List"" link
4. Click on ""Project 111 - Package 222"" link
5. Notice behavior in url ( url changes, but page route didn't actually change )

## Expected behavior

The router should navigate to the expected page with the params

## Screenshots

See repo/steps to reproduce

## System information

- OS: macOS
- Browser: Tested in Chrome
- Version of Next.js: [e.g. 10.0.3]
- Version of Node.js: [e.g. 12.18.3]
- Deployment: run on local development environment

## Additional context

This issue appears only in the development environment.  The functionality though should be consistent between dev run and prod build.  The router url will update but the page will not update and will be stuck basically on the loading screen.  Removal of the query string params on the asPath allows the page to work but this shouldn't stop the router from working.",ijjk,kind: bug,2020-12-10T15:12:26Z,2021-01-21T23:40:24Z,rmsheppard,rmsheppard;lfades;ijjk;balazsorban44,rmsheppard;lfades;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,2006,"Escaping problem with meta tags Hi,

I'm facing an issue with meta tags. When I use some special characters like single quote in the head tag, it's escaping. I can not use `dangerouslySetInnerHtml` for meta tags.

in code:
`<meta name=""description"" content=""That's it!"" />`

result:
`<meta name=""description"" content=""That&#x27;s it!"" />`

How can I handle with this? I couldn't find any solution about this problem.

Thanks.",arunoda,kind: bug;type: upstream,2017-05-18T08:23:25Z,2020-01-02T19:42:23Z,Balamir,arunoda;Balamir;oliviertassinari;mrasoahaingo;timneutkens;equinusocio;vxcamiloxv;DesignMonkey;dzinemon;YoannBuzenet;jasonfarrell;mislavmiocevic;Rupeshn73;damusnet;poohitan;donaminos;stefl,arunoda,arunoda,arunoda,,arunoda,
vercel/next.js,20134,"Font optimization breaks dynamic font loading <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

Font optimization has been enabled in the canary releases of Next.js, by #19758. Since then, Google Fonts stylesheets cannot be injected in runtime with `next/head`.

## Describe the bug

I'm using the gist below for loading Google Fonts on demand:

https://gist.github.com/kripod/52c0f37ad6c4d5e84b4e3a7bc976f50b

Usage example:

```tsx
<GoogleFontsSheet
  fonts={{
    ""Source Sans Pro"": [
      { wght: 400 },
      { wght: 400, ital: 1 },
      { wght: 700 },
      { wght: 700, ital: 1 },
    ],
    ""Playfair Display"": [{ wght: 700 }],
  }}
/>
```

It generates the following code:

```tsx
import Head from ""next/head"";

<Head>
  <link href=""https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"" rel=""stylesheet"" />
</Head>
```

However, when passing user-changeable data to the `fonts` prop of `<GoogleFontsSheet>`, the corresponding style sheets refuse to load.

## To Reproduce

Please see the instructions above.

## Expected behavior

Runtime injection of Google Fonts via `<link>` elements should be allowed. The optimization shouldn't remove elements which load fonts dynamically.

## System information

- OS: macOS
- Version of Next.js: 10.0.4-canary.5
- Version of Node.js: 14.15.0
- Deployment: next start
",housseindjirdeh,kind: bug;area: experimental;type: chrome,2020-12-12T22:09:26Z,2021-08-12T08:51:59Z,kripod,rishi-raj-jain;kripod;balazsorban44,kripod;Timer,Timer,housseindjirdeh,,kripod,
vercel/next.js,20178,"next/image flashes without objectFit property and when full width <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

When using the Nextjs Image component, even with `loading=""eager""`, the image flashes on page reload when used as a full width image as well as when using set `width` and `height` props without `objectFit`.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. check out this repro [https://github.com/ryan-reach/next-image-flash-repro](https://github.com/ryan-reach/next-image-flash-repro)
2. `/hero` and `/thumbnails` are example pages of full width hero images and
 thumbnails flashing. (thumbnails are fixed when adding `objectFit` prop, probably just needs to be documented)
3. go to one of the example pages, open dev tools, go to the performance tab and start profiling + reload the page
4. scroll through the frames to see when the next Image component flashes, while regular `img` and `div` with background image don't flash

## Expected behavior

Nextjs Image component should behave like regular `img` and not cause a repaint during reconciliation, which is what I think might be happening? I'm really not sure...棣

## Screenshots

![image](https://user-images.githubusercontent.com/60242214/102118444-efd99880-3dfc-11eb-992a-3438798c9987.png)
![image](https://user-images.githubusercontent.com/60242214/102118598-29aa9f00-3dfd-11eb-92b2-bd6f0264ca0d.png)

## System information

- OS: macOS
- Browser chrome
- Version of Next.js: 10.0.3
- Version of React: 17.0.1
- Version of Node.js: 12.18.4
- Deployment: local dev

## Additional context

I'm not very skilled at deciphering the performance tab, but it appears the flash is happening after Nextjs hydration and possibly right around the onload event.

I haven't tried a production deployment yet but will update when I can.
",atcastle,kind: bug;type: needs investigation,2020-12-14T18:35:12Z,2021-08-24T09:09:09Z,ryan-reach,Slowl;heysanil;AbeCole;atcastle;balazsorban44,ryan-reach;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,20198,"next/image occupies space / is clickable in parent with visibility hidden <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

`<img style=""visibility: visible;"">` tag can't be used in components (modal, collapsible menu) which are hidden by `visibility: hidden`. `visibility: visible` is too aggressive and overrides `hidden` in parent.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

```
<div style={{ visibility: 'hidden' }}>
   <Image 閳 />
</div>
```

## Expected behavior

Image won't be visible and clickable if the parent is hidden.

Second image should not be visible as demonstrated on screen capture below.

![image](https://user-images.githubusercontent.com/1045362/102221016-e83fef80-3ee1-11eb-9643-10970f73614b.png)

```
<div style={{ width: '200px' }}>
	<Image
		src=""https://placekitten.com/200/300""
		width={200}
		height={300}
		alt=""""
	/>
	Visible picture
</div>
^visible
<br />
<br />
<div style={{ width: '200px', visibility: 'hidden' }}>
	<Image
		src=""https://placekitten.com/200/300""
		width={200}
		height={300}
		alt=""""
	/>
	Hidden picture
</div>
^hidden
```

## Screenshots

Current nonoptimal behavior.

![hidden](https://user-images.githubusercontent.com/1045362/102220594-520bc980-3ee1-11eb-915f-f56814089248.gif)

## System information

- Version of Next.js: [e.g. 10.0.3]

## Additional context

Replace `visibility: hidden` with `visibility: inherit` in `<img>` tag.
",Timer,kind: bug,2020-12-15T13:26:17Z,2020-12-28T18:55:45Z,FilipChalupa,ciruz;FilipChalupa;balazsorban44,FilipChalupa;Timer,Timer,Timer,,,
vercel/next.js,20212,"Bug in the internationalization feature # Bug report

## Describe the bug

When you navigate to a page that use query parameters and isn't the default locale, the query parameters are treated as ""undefined"".

## To Reproduce

1. Go to my repo or other repo that uses the internationalization feature (https://github.com/luckasnix/next-bug-report);
2. Switch to other locale (the bug don't appear in the default locale);
3. Navigate to a page that uses query parameters (""/pt-BR/articles?page=1"") using the browser buttons (the bug don't appear when using the Next Link);
4. At first, the value of the query parameter is treated as ""undefined"".

## Expected behavior

The value of the query parameter must not be treated as ""undefined"". The behavior must be the same as the default locale.

## Screenshots

The console shows the value of the query parameter as ""undefined"".
![bug-in-the-console](https://user-images.githubusercontent.com/50385918/102269575-9a37e580-3efb-11eb-941b-bece3fe99c4e.png)

## System information

- OS: Windows 8.1
- Browser Google Chrome
- Version of Next.js: 10.0.3
- Version of Node.js: 14.3.0
- Deployment: next dev

## Additional context

No additional context.
",ijjk,kind: bug,2020-12-15T20:33:51Z,2020-12-28T17:58:08Z,luckasnix,timneutkens;luckasnix;ijjk;balazsorban44,luckasnix;ijjk,ijjk,ijjk,,,
vercel/next.js,20330,"pages-manifest.json is generated with backwards slashes on Windows 14.x # Bug report

## Describe the bug

In a project with i18n configured, Next 10.0.3, the pages-manifest.json file has some unintentional backwards slashes.

![dsd](https://user-images.githubusercontent.com/57350178/102689397-c25d6800-41cb-11eb-88fd-386e94154200.png)

## To Reproduce

Build an app with i18n configured, in Next 10.x and investigate pages-manifest.json

## Expected behavior

Forward slashes only :)

## System information

- OS: Windows 14.x
- Version of Next.js: 10.0.3
- Version of Node.js: 14.x
- Deployment: next build",ijjk,kind: bug,2020-12-19T12:30:51Z,2020-12-22T01:51:52Z,lindsaylevine,balazsorban44,lindsaylevine;ijjk,ijjk,ijjk,,,
vercel/next.js,20404,"AMP OPTIMIZER Failed downloading latest AMP runtime data. Proxies need to be configured manually <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

When create a next js app using `npx create-next-app` on windows 10, I receive this error in terminal

`AMP OPTIMIZER Failed downloading latest AMP runtime data. Proxies need to be configured manually, see https://github.com/ampproject/amp-toolbox/tree/main/packages/optimizer#fetch.`

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Run `npx create-next-app`

## Expected behavior

I expect not to see any errors :)

## Screenshots

![Capture](https://user-images.githubusercontent.com/72021045/102935226-671ec480-44ae-11eb-9ca6-11476a17c62c.PNG)

## System information

- OS: Windows 10
- Version of Node.js: 14.15.3
",ijjk,kind: bug,2020-12-22T21:35:50Z,2021-02-11T09:55:57Z,ahmedosama74574,Mohammad-Afaque;ahmedosama74574;ahmedosama5200;balazsorban44;timneutkens;Timer;ijjk,ahmedosama74574;Timer;ijjk,Timer,ijjk,,,
vercel/next.js,20456,"sharp no longer optional since 10.0.4-canary.7 # Bug report

## Describe the bug

Next.js has an optional dependency on sharp. This means that it should run without sharp present in node_modules.

PR #20035 broke this by adding `require.resolve('sharp')` without a try/catch to catch `MODULE_NOT_FOUND`.

I discovered this because sharp no longer installs with NPM 7 (see #20432).

## To Reproduce

npm i next@10.0.4-canary.7
rimraf node_modules/sharp
npm run build

> > Build error occurred
> Error: Cannot find module 'sharp'
> Require stack:
> - C:\Projects\ANWB\Travelhome-git\camper2-website\node_modules\next\dist\build\index.js
> - C:\Projects\ANWB\Travelhome-git\camper2-website\node_modules\next\dist\cli\next-build.js
> - C:\Projects\ANWB\Travelhome-git\camper2-website\node_modules\next\dist\bin\next
>     at Function.Module._resolveFilename (internal/modules/cjs/loader.js:902:15)
>     at Function.resolve (internal/modules/cjs/helpers.js:94:19)
>     at build (C:\Projects\ANWB\Travelhome-git\camper2-website\node_modules\next\dist\build\index.js:11:794) {
>   code: 'MODULE_NOT_FOUND',
>   requireStack: [
>     'C:\\Projects\\ANWB\\Travelhome-git\\camper2-website\\node_modules\\next\\dist\\build\\index.js',
>     'C:\\Projects\\ANWB\\Travelhome-git\\camper2-website\\node_modules\\next\\dist\\cli\\next-build.js',
>     'C:\\Projects\\ANWB\\Travelhome-git\\camper2-website\\node_modules\\next\\dist\\bin\\next'
>   ]
> }

## Expected behavior

The site builds OK.

- OS: Windows or Linux (alpine in docker)
- Version of Next.js: 10.0.4-canary.7 and up
- Version of Node.js: 14 (latest)
- Deployment: fails on build
",Timer,kind: bug,2020-12-24T12:34:37Z,2021-02-18T10:23:25Z,jorrit,jorrit;timneutkens;firefart;valerie-makes;genemators;onigoetz;cseas;robertveloso;EduardoHidalgo;thien-do;lewyuburi;habib786;balazsorban44;iou90;davidgilbertson;jhonalino;ChristianPraiss,jorrit;timneutkens,timneutkens,,,,
vercel/next.js,20486,"experimental.scrollRestoration configuration makes Safari throw SecurityError # Bug report

## Describe the bug

When enabling `experimental.scrollRestoration` in `next.config.js`, scrolling too fast makes Safari (Desktop & Mobile) throws exceptions in the console: it complains `replaceState` is called more than 100 times in a 30-second window.

## To Reproduce

- Have the following `next.config.js`

> `module.exports = {
>   experimental: {
>     scrollRestoration: true,
>   },
> }`
> 
- Have a component which renders a long page
- Scroll fast on mobile Safari (iOS 14) or desktop Safari (macOS 11.1)
- Look at the debugger console or popup appearing on screen if in dev mode
-  
## Expected behavior

- No such exception
- Maybe let the developer specify its debounce timeout: I tried increasing the default 10ms and it works fine

## Screenshots
![Capture d閳ユ銉絩an 2020-12-26 鑴 10 20 04](https://user-images.githubusercontent.com/765273/103149061-6dd76100-4766-11eb-850b-864066f1143b.png)

## System information
- OS: iOS and macOS
- Browser: Safari
- Version of Next.js: 10.0.4
- Version of Node.js: 15.4.0
- Deployment: next dev and next start, both localhost and Vercel
",Timer,kind: bug;area: experimental,2020-12-26T09:38:24Z,2020-12-31T16:08:13Z,SylvainGarrigues,balazsorban44,SylvainGarrigues;Timer,Timer,Timer,,,
vercel/next.js,20500,"Production source maps show webpack-generated files rather than source files in 10.0.4 <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Looks like something is wrong with the `productionBrowserSourceMaps` option, which was moved out from experimental in v10.0.4 (#20267). Instead of displaying what developers have in the editor, they resolve into some intermedeate webpack output.

## To Reproduce

1.  Create an app

    ```sh
    npx create-next-app next-production-source-maps-mvp
    cd next-production-source-maps-mvp
    yarn why next
    ## => Found ""next@10.0.4""
    ```

1.  Enable `productionBrowserSourceMaps` ([as suggested by docs](https://nextjs.org/docs/advanced-features/source-maps))

    ```sh
    cat <<EOF >next.config.js
    module.exports = { productionBrowserSourceMaps: true }
    EOF
    ```

1.  Build and start

    ```sh
    yarn build && yarn start
    ```

1.  Open the browser and observe

    - Raw source (pointing to a source map as expected):
      <img width=""1121"" alt=""producion (raw source)"" src=""https://user-images.githubusercontent.com/608862/103157643-114b6480-47ad-11eb-95fd-00cd5e46395f.png"">

    - Source map (resolved and downloaded, but is not very helpful):
      <img width=""1121"" alt=""production source map (broken)"" src=""https://user-images.githubusercontent.com/608862/103157645-16101880-47ad-11eb-8a10-eb948a87904a.png"">

## Expected behavior

I was expecting the source maps for `yarn build && yarn start` to look the same as for `yarn dev`:

<img width=""1121"" alt=""development source map (looking good)"" src=""https://user-images.githubusercontent.com/608862/103157651-24f6cb00-47ad-11eb-975f-7f92324c54c7.png"">

Seeing jsx, original file paths and unchanged js / ts syntax is crucial for debugging.

## System information

- OS: macOS 11
- Browser (if applies) Chrome / Firefox
- Version of Next.js: 10.0.4
- Version of Node.js: 14.15.3
- Deployment: local (also observed on vercel for [njt.now.sh](https://njt.now.sh))



## Additional context


Switching to [@zeit/next-source-maps](https://www.npmjs.com/package/@zeit/next-source-maps) (which the new option is aiming to replace) gives the same incorrect result in Next 10.0.4. Here are the additional repro steps to observe this:

```sh
yarn add -D @zeit/next-source-maps

cat <<EOF >next.config.js
const withSourceMaps = require('@zeit/next-source-maps')
module.exports = withSourceMaps()
EOF

yarn build && yarn start
```

What helps is downgrading to Next 10.0.3 and either keeping `@zeit/next-source-maps` or setting the experimental option:

```sh
yarn add next@10.0.3

cat <<EOF >next.config.js
module.exports = { experimental: { productionBrowserSourceMaps: true } }
EOF

yarn build && yarn start
```

<img width=""1121"" alt=""production and experimental flag in version 10.0.3 "" src=""https://user-images.githubusercontent.com/608862/103157914-2aa1e000-47b0-11eb-9c17-3e60d2726e3b.png"">
",Timer,kind: bug,2020-12-26T19:27:32Z,2021-01-01T20:30:51Z,kachkaev,kachkaev;balazsorban44,kachkaev;Timer,Timer,Timer,,,
vercel/next.js,20540,"CSS Modules have flash of unstyled content before loading # Bug report

## Describe the bug

When loading a page using CSS Modules, there is an unexpected flash of unstyled CSS.

## To Reproduce

Two deployments, identical source code. Before using `next@9.2.0`, after using `next@9.3.0`.

- Before: https://next-cssm-before.vercel.app/cssm
- After: https://next-cssm-after.vercel.app/cssm

This issue is still in the latest version of Next.js. Both of the deployments above are public, you can see the source code there. This doesn't appear to affect styles with `styled-jsx`.

Other examples with this issue:

- https://demo.vercel.store
- https://demo.vercel.events

## Expected behavior

The styles should not flash.

## Screenshots

![CleanShot 2020-12-28 at 10 07 36](https://user-images.githubusercontent.com/9113740/103227702-99885180-48f4-11eb-8b89-9f61a2cbc9c2.gif)",Timer,kind: bug,2020-12-28T16:09:49Z,2021-01-02T02:01:01Z,leerob,Timer;Chochek;balazsorban44,leerob;Timer,Timer,Timer,,Timer,
vercel/next.js,20567,"Lighthouse reports me that an <Image> is the Largest Contentful Paint element because it takes 4.6s to load <!-- NOTE: This template is not optional. If you remove it or leave out sections there is a high likelihood it will be moved to the GitHub Discussions ""Help"" section -->

# Bug report

## Describe the bug

Lighthouse is lowering my score in mobile because my hero image takes 4.6s to load (in desktop it takes 1.2s). I'm trying to preload the image but it doesn't work.

## To Reproduce

Use this example code to load a hero image:

```javascript
<Image
 src={data.mediaItemUrl}
 layout=""fill""
 priority={true}
 loader=""eager""
 objectFit=""cover""
 quality={90}
/>
```

## Expected behavior

The image is optimized so it should render faster. Also, as it uses the priority attribute it should preload the image.

## Screenshots

![Captura de pantalla 2020-12-29 a las 12 05 55](https://user-images.githubusercontent.com/3605582/103279501-3bc83800-49ce-11eb-862a-fe12ceb35965.png)


## System information

- OS: [e.g. macOS, Windows]
- Browser (if applies) [e.g. chrome, safari]
- Version of Next.js: [e.g. 10.0.1]
- Version of Node.js: [e.g. 12.0.0]
- Deployment: [e.g. next start, next export, Vercel, other platform]

## Additional context

Add any other context about the problem here.
",Timer,kind: bug,2020-12-29T11:06:47Z,2020-12-31T19:18:16Z,aresrioja10,TheThirdRace;Timer;balazsorban44,aresrioja10;Timer,Timer,Timer,,Timer,
vercel/next.js,20576,"Improve stacktrace for wrong webpack 5 version ```
閴 yarn next build                                                                                                  閴 1 
yarn run v1.22.5
$ /Users/joe/Documents/Development/Work/zeit/front/node_modules/.bin/next build
(node:45037) UnhandledPromiseRejectionWarning: Error: webpack 5 version must be greater than v5.11.1 to work properly with Next.js, please upgrade to continue!
See more info here: https://err.sh/next.js/invalid-webpack-5-version
    at Object.<anonymous> (/Users/joe/Documents/Development/Work/zeit/front/node_modules/next/dist/build/webpack-config.js:1:3644)
    at Module._compile (internal/modules/cjs/loader.js:1015:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1035:10)
    at Module.load (internal/modules/cjs/loader.js:879:32)
    at Function.Module._load (internal/modules/cjs/loader.js:724:14)
    at Module.require (internal/modules/cjs/loader.js:903:19)
    at require (internal/modules/cjs/helpers.js:74:18)
    at Object.<anonymous> (/Users/joe/Documents/Development/Work/zeit/front/node_modules/next/dist/build/index.js:1:2150)
    at Module._compile (internal/modules/cjs/loader.js:1015:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1035:10)
    at Module.load (internal/modules/cjs/loader.js:879:32)
    at Function.Module._load (internal/modules/cjs/loader.js:724:14)
    at Module.require (internal/modules/cjs/loader.js:903:19)
    at require (internal/modules/cjs/helpers.js:74:18)
    at Object.<anonymous> (/Users/joe/Documents/Development/Work/zeit/front/node_modules/next/dist/cli/next-build.js:2:287)
    at Module._compile (internal/modules/cjs/loader.js:1015:30)
(node:45037) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 1)
(node:45037) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.
閴  Done in 1.51s.
```",ijjk,kind: bug,2020-12-29T16:20:28Z,2020-12-29T17:35:23Z,Timer,balazsorban44,Timer;ijjk,,ijjk,,Timer,
vercel/next.js,20612,"New locale redirect behavior Thanks @ijjk I just tried `v10.0.5-canary.4` in one of my projects. Is it expected that `<Link href=""/hello"" locale=""xx"" />` still points to `/xx/hello`, which is followed by a redirect on click? Two observations:

- Having `/xx/hello` is probably not as good as `my-domain-for.xx/hello` SEO-wise

- During local dev, having `domains: [{domain: ""xx.localhost"", defaultLocale: ""xx""}]` means that the redirect from `/xx/hello` goes to `https://xx.localhost/hello` instead of `http://xx.localhost:3000/hello` (note the port and the protocol). This requires manual URL tweaking before the website in another locale can be viewed. What would be the suggested way forward here?

_Originally posted by @kachkaev in https://github.com/vercel/next.js/issues/19174#issuecomment-752695489_",ijjk,kind: bug,2020-12-30T17:43:35Z,2020-12-31T08:07:52Z,Timer,kachkaev;ijjk;balazsorban44,Timer;ijjk,,Timer,,,
vercel/next.js,20725,"Rewrite of the sitemap.xml does not work. Hi. I use 10.0.5-canary.8 version and I have one small rewrite:

```
async rewrites() {
    return [
      {
        source: '/sitemap.xml',
        destination: '/api/sitemap'
      },

    ]
}
```

and it does not return content of the sitemap page. It returns this: `Error: Objects are not valid as a React child (found: [object Promise]). If you meant to render a collection of children, use an array instead`. What I am doing wrong? if i try fetch address `/api/sitemap` directly it works.

Thank you",ijjk,kind: bug,2021-01-04T02:03:57Z,2021-01-06T09:54:46Z,jurajkrivda,ijjk;jurajkrivda;balazsorban44,jurajkrivda;ijjk,ijjk,ijjk,,,
vercel/next.js,2073,"dynamic import request 404 in production mode Hi guys,

I made a demo to display news from API & using a new feature `dynamic` import. While in development mode it works well. But in production mode, some components were not loaded successfully. Here is a repo
[https://github.com/nndung179/next.js/tree/feature/refactor_layout_with_material_ui](https://github.com/nndung179/next.js/tree/feature/refactor_layout_with_material_ui)
",arunoda,kind: bug,2017-05-26T12:06:12Z,2017-06-08T17:41:23Z,davidnguyen11,arunoda;davidnguyen11;cdock1029,arunoda,,arunoda,,timneutkens,
vercel/next.js,20760,"HMR taking much longer with webpack@5 and next@canary **What version of Next.js are you using?**

10.0.5-canary.9

**What version of Node.js are you using?**

v15.3.0

**What browser are you using?**

Chrome

**What operating system are you using?**

macOS

**How are you deploying your application?**

next start

**Describe the Bug**

In dev mode with webpack@5 HMR takes considerably longer than with webpack@4 for the same change and exactly the same codebase.

**Expected Behavior**

HMR being faster or at the same speed.

**To Reproduce**

Still need to isolate the issue, which is really hard because this page is around 700kB total!

The webpack@4 baseline uses the following versions:

```
閳规壕鏀 next@npm:10.0.3
閳  閳规柡鏀 webpack@npm:4.44.1 (via npm:4.44.1)
```

The baseline refresh time of HMR is around a second:

<img width=""354"" alt=""Screen Shot 2021-01-04 at 8 07 55 PM"" src=""https://user-images.githubusercontent.com/2052659/103595140-b6122400-4ec8-11eb-85cd-83b80b69d0db.png"">

Compared with doing the same action with webpack@5:

```
閳规壕鏀 next@npm:10.0.5-canary.9
閳  閳规柡鏀 webpack@npm:5.11.1 (via npm:5.11.1)
```

<img width=""375"" alt=""Screen Shot 2021-01-04 at 8 10 53 PM"" src=""https://user-images.githubusercontent.com/2052659/103595248-f7a2cf00-4ec8-11eb-89bf-ceb5f05a3921.png"">

This takes around 12 seconds (vs. 1 second with webpack@4) and there's an extra event as well:

```json
{
	""event"": ""serverOnlyChanges"",
	""pages"": [""/legacy/plans""]
}
```

and the built event has some errors regarding anonymous arrow functions that didn't have anything to do with the change.

We initially thought this issue was related to the context issue #18917, but it's not fixed on the latest canary.",timneutkens,kind: bug;please add a complete reproduction;type: needs investigation,2021-01-05T01:23:29Z,2021-06-21T14:33:55Z,PepijnSenders,Timer;PepijnSenders;cullylarson,PepijnSenders;Timer,Timer,,,PepijnSenders,
vercel/next.js,20776,"Why does next.js offen shows the wrong line/file when there's an error? **What version of Next.js are you using?**

10.0.3

**What version of Node.js are you using?**

v12.20.1

**What browser are you using?**

Chrome

**What operating system are you using?**

Linux:Ubuntu

**How are you deploying your application?**

Ubuntu/Docker

**Describe the Bug**

When there's an error next js shows wrong line/file almost every time? is this normal behaviour?

**Expected Behavior**

Shows the correct file and the line number

**To Reproduce**

Create a next js application, throw an unhandled error related to the template.
ex: try to use an object as a component in a template:


```
import React from 'react';

const Test = () => (
  <div>
    {{ test: 'test' }}
  </div>
);

export default Test;

```


![image](https://user-images.githubusercontent.com/1854023/103655613-82e59880-4f8d-11eb-987b-2a5c25ced506.png)

as per the above image, there is no attribute called type on pointed location, or the file. this very hard to debug.

This location is not even in the application's files:
![image](https://user-images.githubusercontent.com/1854023/103655876-e7085c80-4f8d-11eb-9105-b988d0f9dc5a.png)

",shuding,kind: bug,2021-01-05T14:08:28Z,2021-03-20T19:34:45Z,spmsupun,spmsupun;timneutkens;balazsorban44,spmsupun;Timer,Timer,shuding,,,
vercel/next.js,20791,"Images using next/image are not properly fetched with basePath **What version of Next.js are you using?**

10.0.5-canary.9

**What version of Node.js are you using?**

14.5.0

**What browser are you using?**

Brave

**What operating system are you using?**

Windows (Everything is built/tested through WSL though)

**How are you deploying your application?**

Vercel

**Describe the Bug**

I have updated next to canary after having this initial issue: https://github.com/vercel/next.js/issues/19711
Now, while using the dev server or running build on my local machine (through `npm run build` and `npm run start`) image is properly displayed
However, when I try to visit my deployed version on Vercel, image is not fetched properly.
Looks like `_next/image` is working differently on Vercel
http://localhost:3000/docs/_next/image?url=%2Fdocs%2F500.png&w=1080&q=75 is working.
https://next-image-deploy.vercel.app/docs/_next/image?url=%2Fdocs%2F500.png&w=1080&q=75 is 404 while
https://next-image-deploy.vercel.app/_next/image?url=%2Fdocs%2F500.png&w=1080&q=75 is working

**Expected Behavior**

Image should be displayed on deployed version also.

**To Reproduce**

- clone https://github.com/vidjul/next-image-deploy
- `cd next-image-deploy`
- `npm run build`
- `npm run start`
- visit `https://localhost:300/docs`
- Check if 500x500 placeholder is properly displayed
- Deploy the test app on vercel (already done at https://next-image-deploy.vercel.app)
- Notice that 500x500 placeholder is not displayed

As a side note, before creating an issue here, I have tried to reach Vercel support and they have suggested to drop an issue here:

> Hi there,Since you are using a canary build of Next.js, you should share your issue over at https://github.com/vercel/next.js/issues鑱絪o that the Next.js contributors can act upon it and offer help to work around the bug you are facing. 


",ijjk,kind: bug,2021-01-05T20:44:59Z,2021-02-08T20:20:47Z,vidjul,fangyulovechina;balazsorban44,vidjul;Timer,Timer,Timer,,ijjk,vercel/next.js#19711;
vercel/next.js,20794,"Webp images using next/image are not converted to another format on incompatible browsers **What version of Next.js are you using?**

10.0.4

**What version of Node.js are you using?**

12.16.0

**What browser are you using?**

Safari <= 13

**What operating system are you using?**

MacOS, iOS

**How are you deploying your application?**

next start, externally hosted assets

**Describe the Bug**

If you pass an image src which is natively a `webp` to the `next/image` component, it is always served as a webp. Safari versions <= 13 do not include webp support so the image fails to load.

The Accept header sent in the request to the `_next/image` endpoint from Safari looks like this:
```
Accept: image/png,image/svg+xml,image/*;q=0.8,video/*;q=0.8,*/*;q=0.5
```

I believe the following code is at fault:
https://github.com/vercel/next.js/blob/356bcdec0302c13af312ddcc5c39e78ef8e40c9d/packages/next/next-server/server/image-optimizer.ts#L234-L240

**Expected Behavior**

On browsers that do not support webp, files should be converted into `jpeg` or `png` (most likely jpeg?). 

**To Reproduce**

- Place a `.webp` in your `public` folder or any other configured public host.
- Use the `next/image` component and set the `src` prop to point to the `.webp` image.
- Observe in Safari or IE or another non-webp supporting browser as the image is served in webp format and fails to render.

Perhaps it would also make sense to add an optional `format(s)` query param which the server accepts, passed through as a prop?

Also worth being aware of/considering is the HTML `<Picture />` tag ([MDN Docs](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture))

Let me know if you'd like anything else from me, and I'll be happy to lend a hand :)",styfle,kind: bug;area: next/image,2021-01-05T22:22:26Z,2022-03-10T14:02:13Z,JakeStanger,xyy94813;royjosefsson;JakeStanger;nmokkenstorm;vleung-into;Jaynam07;fungilation;edlerd;PatrickChagastavares;davidpaley;jaddoescad;styfle,JakeStanger;Timer,Timer,,,balazsorban44,
vercel/next.js,20816,"Cache error on redirects from dynamic routes with SSG [Node.js 14+] **What version of Next.js are you using?**

10.0.4

**What version of Node.js are you using?**

14.15.4

**What browser are you using?**

Chrome

**What operating system are you using?**

Windows 10/Alpine Linux

**How are you deploying your application?**

next start

**Describe the Bug**

When returning a redirect value from getStaticProps in a dynamic route, the IncrementalCache.set function attempts to write invalid html data to the static page cache.

Node.js version 14+ throws an exception here, which triggers this warning:
`Failed to update prerender files for <pathname> TypeError [ERR_INVALID_ARG_TYPE]: The ""data"" argument must be of type string or an instance of Buffer, TypedArray, or DataView. Received an instance of Object`

After downgrading to node version 12.18.4, no error occurs, instead an html file containing `[object Object]` is written.

In our use case, there are no apparent ill effects with either version, aside from a large amount of entries in our error logs for the node.js 14 variant. Redirects still work as expected.

**Expected Behavior**

Html-cache should probably not be (attempted) generated from redirected paths.

**To Reproduce**

- Clone this repo https://github.com/anders-nom/nextjs-ssg-redirect-cache-bug
- Install and use Node.js version 14.15.4
- Delete the .next directory if it exists
- `npm run build`
- `npm run start`
- Visit http://localhost:3000/redirect
- Observe the aforementioned warning in the server console, and note that no redirect.html or redirect.json was generated in /.next/server/pages

",ijjk,kind: bug,2021-01-06T15:30:27Z,2021-06-28T12:23:24Z,anders-nom,balazsorban44;diegoaguilar;Dimich-x33;baba43;Aviortheking;garfiaslopez;ijjk,anders-nom;Timer,Timer,ijjk,,,
vercel/next.js,20873,"Single specific file not working with next/image **What version of Next.js are you using?**

10.0.4

**What version of Node.js are you using?**

12.18.0

**What browser are you using?**

Chrome v85.0.4183.83

**What operating system are you using?**

Windows 10

**How are you deploying your application?**

next dev

**Describe the Bug**

When using next/image, most images work fine. There's a single file that doesn't work no matter what I do, be it renaming, copy-pasting it on Photoshop, re-downloading the original image with whichever name. Instead of `data:image/png;base64,` it's always being linked as `/_next/image?url=%2F_next%2Fcover-19.png&w=1920&q=75`. The only times it works is when linking from an external URL, be it original site, deployed Heroku site or even the same file from GitHub, which stops working when re-downloaded.

**Expected Behavior**

next/image should display the image like the other 20+ I'm using.

**To Reproduce**

Create a next/image with any one of: cover-19.png, scover-19.jpg, cover-19.80b0e3ab.png, cover-20.png, cover-21.png, downloaded from https://github.com/hyoretsu/aufklarung-site/tree/6dad014a6f0bf4697aed8b39b6f250e3bd181377/src/assets/tmp. Has to be local copy.

```
import Image from 'next/image';
import Cover from '@assets/tmp/cover-19.png';

<Image src={Cover} alt=""Capa da edi鑾借尗o"" width={455} height={614} />
```

I'm in the middle of learning/creating (converting) a Next site for the first time, so it's bound to have some non-optimal configs. [Here](https://github.com/hyoretsu/aufklarung-site/tree/6dad014a6f0bf4697aed8b39b6f250e3bd181377)'s my repo if needed. Go to /issues for a list of images I'm using with next/image.",atcastle,kind: bug,2021-01-07T20:46:16Z,2021-06-30T22:09:20Z,hyoretsu,hyoretsu;balazsorban44,hyoretsu;timneutkens,timneutkens,timneutkens,,hyoretsu,
vercel/next.js,2098,"`<Link />` doesn't handle hashes well When you have a `<Link />` component that points to an arbitrary section of a different page, e.g. `<Link href=""/#who-we-are"" />` (in this case, I want to go to `who-we-are` section of `/`), it will only work when that link is pressed from another page.

When this link is pressed on the `/` page, Next will not scroll into that view. I believe it's because we don't have any code in `Container.js` to handle hash change. We only seem to handle `didMount` scenario.

Also, since we are using `history.pushState`, there's no `hashchange` event being fired. That means we need to integrate handling logic somehow into the router itself.",arunoda,kind: bug,2017-05-29T14:18:28Z,2017-06-09T19:32:29Z,grabbou,sergiodxa;arunoda,arunoda,,arunoda,,arunoda,
vercel/next.js,2114,"shouldComponentUpdate() not working on development when used with Router Hi!
I'm trying to implement `shouldComponentUpdate()` method on some components to avoid unnecessaries renders and it is totally ignored while in development. The render method is triggered even if I return a straight false in it. But it works as expected in the production build...  
So I've dug around and it looks like when using Router to change the url (even if you stay in the same page and use shallow routing) everything gets re renders without taking shouldComponentUpdate into account. But only in development.

I've reproduced this in the with-redux example making this 2 changes to `components/AddCount.js` file:
```javascript
class AddCount extends Component {
  add = () => {
    this.props.addCount()

    // Change 1
    Router.push('/', `/${this.props.count}`, {shallow: true})
  }

  // Change 2
  shouldComponentUpdate() {
    return false;
  }

  render () {
    const { count } = this.props
    return (
      ...
    )
  }
}
```
If you run this in devel the count would increase and it will stay the same on a production build.
It this the expected behaviour? is there's a way to avoid it?

PS: same think happens using PureComponent or with Recompose HOC, like pure(), shouldUpdate(), etc.",arunoda,kind: bug,2017-05-30T15:04:37Z,2018-06-05T08:30:10Z,coluccini,TooTallNate;arunoda;coluccini;harshmaur;marbemac;j;nelsonomuto;timneutkens,arunoda,,arunoda,,timneutkens,
vercel/next.js,21209,"i18n doesn't prevent devs from creating broken pages with the locale prefix **What version of Next.js are you using?**

10.0.5

**What version of Node.js are you using?**

15.6.0

**What browser are you using?**

n/a

**What operating system are you using?**

n/a

**How are you deploying your application?**

next build && next start

**Describe the Bug**

It's possible to create pages that include a locale prefix (e.g. `pages/en/index.js`) and `next build` doesn't complain about it.

**Expected Behavior**

Build should fail

**To Reproduce**

Run `npx create-next-app`, then enable i18n in `next.config.js`:

```js
module.exports = {
  i18n: {
    locales: ['en', 'pl'],
    defaultLocale: 'en'
  }
};
```

Create a `pages/en/index.js` file:

```js
export default function Unreachable() {
  return <div>unreachable</div>;
}
```

Run `next build`, it should fail because of a conflict with the existing locale but it doesn't. If you start the server and navigate to `/en` you'll get a 404.

",ijjk,kind: bug,2021-01-15T20:41:45Z,2021-09-21T03:15:57Z,sebastian-nowak,ijjk;balazsorban44,sebastian-nowak;timneutkens,timneutkens,ijjk,,ijjk,
vercel/next.js,2121,"Dynamic imports get bundle with reactdom I'm using the new
`const DynGmp = dynamic(import('some-react-comp'))` feature and by running webpack bundle analyzer I noticed that `react-dom.min.js` gets bundled with `some-react-comp`. adding `import ReactDom from 'react-dom` on my page component fixed it. 

Am I doing something wrong? Should I always explicitly import react-dom ?",arunoda,kind: bug,2017-05-31T13:02:33Z,2017-06-16T14:05:01Z,quentin-sommer,arunoda;quentin-sommer;rauchg,arunoda,,arunoda,,quentin-sommer,
vercel/next.js,21267,"asPath in getInitialProps ignores query params in dev mode **What version of Next.js are you using?**

10.0.5

**What version of Node.js are you using?**

12.18.3

**What browser are you using?**

Chrome

**What operating system are you using?**

macOS

**How are you deploying your application?**

npm run dev

**Describe the Bug**

When using dev mode, the value of `asPath` in `getInitialProps` is correct only when rendered by the server. When rendered by the browser, only the path is included, and the query portion is ignored.

In prod (npm start), everything works as expected. This leads me to believe that there is some kind of race condition that surfaces only when the app is slowed down due to being in dev mode. 

**Expected Behavior**

The value of `asPath` should consistently include the query portion both on the server and in the browser, even in dev mode.

**To Reproduce**

*/pages/test1.js:*

```
import { useRouter } from ""next/router"";

const Test1 = ({ asPath }) => {
  const router = useRouter();
  return (
    <div onClick={() => router.push(""/test2"", ""/test2?foo=bar"")}>
      go to /test2?foo=bar
      <br />
      <br />
      asPath = {asPath}
    </div>
  );
};

Test1.getInitialProps = ({ asPath }) => {
  return { asPath };
};

export default Test1;
```


*/pages/test2.js:*

```
import Link from ""next/link"";

const Test2 = ({ asPath }) => {
  return (
    <Link href=""/test1"" as=""/test1?foo=bar"">
      <div>
        go to /test1?foo=bar
        <br />
        <br />
        asPath = {asPath}
      </div>
    </Link>
  );
};

Test2.getInitialProps = ({ asPath }) => {
  return { asPath };
};

export default Test2;
```

Upon initial SSR render, navigating to `/test1?foo=bar` will correctly display the entire `asPath`. But after clicking ""go to /test2?foo=bar,"" only `/test2` is displayed, even though the actual path includes a query string.

Note that this happens both when using the `Link` component, as well as with `router.push`.",ijjk,kind: bug,2021-01-18T05:13:02Z,2021-01-21T23:40:24Z,0x54321,kaykdm;wweaver;ijjk;balazsorban44,0x54321;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,21453,"GetStaticProps returning initial notFound never triggers a rebuild on revalidate with dynamic routes **What version of Next.js are you using?**

10.0.5

**What version of Node.js are you using?**

12.13.0

**What browser are you using?**

Chrome

**What operating system are you using?**

Windows

**How are you deploying your application?**

next start

**Describe the Bug**

If `getStaticProps` returns `notFound: true` in the initial build with a revalidate value, Nextjs never tries to rebuild the page

**Expected Behavior**

Nextjs should try rebuilding the page instead of assuming permanent 404

**To Reproduce**

```javascript
export const getStaticProps = async (props) => {
  try {
    const dictionaries = await apiFetch();
    return {
      props: {
        dictionaries,
      },
      revalidate: 60,
    };
  } catch (error) {
// assume the api fetch fails with the initial build
   return {
      notFound: true,
      props: {
        dictionaries: {},
      },
      revalidate: 60,
    };
  }

// On subsequent re-builds after revalidate has passed and the api returns a ok response, Nextjs never tries to rebuild the page and always returns the 404 page instead

",ijjk,kind: bug,2021-01-22T19:08:21Z,2021-08-14T13:11:40Z,alizeait,janus-reith;alizeait;la55u;ijjk;artmsv;NikitaMazur;bscaspar;balazsorban44;jatbone;LotharVM;ramiel;tbgse,alizeait;timneutkens,timneutkens,timneutkens,,,
vercel/next.js,2154,"async-loaded scripts in v3 throw invariant errors Example at: https://github.com/exoplay/exobot-docs (`npm run build`)

`next` server works great, and `next export` works great when loading `docs/index.html` locally. _however_, as soon as you push the static site generated by next.js to a remote server - in my case, github pages - all kinds of react errors occur, such as invariant errors relating to ""not finding element id of undefined"". If you remove the `async=""""` property from the `script` tags that load each page's code, everything works perfectly fine.

I haven't started tracking down the error yet, but did want to make you aware that at least in v3.0.0-beta.8, async-loading scripts is broken. I don't _think_ I'm doing anything weird in my project. It's fairly simple to set up and run the example, but let me know if you have any questions about what I've written if I haven't updated this issue with more detail by the time you look at this.",arunoda,kind: bug,2017-06-03T00:14:40Z,2018-05-25T21:54:24Z,ajacksified,arunoda;ajacksified;timneutkens,timneutkens,,arunoda,arunoda,timneutkens,
vercel/next.js,21543,"Error: Route did not complete loading: /projects **What version of Next.js are you using?**

10.0.5

**What version of Node.js are you using?**

14.15.0

**What browser are you using?**

Chrome

**What operating system are you using?**

Windows 10

**How are you deploying your application?**

Vercel

**Describe the Bug**

I am trying to build a simple route for my portfolio. The route is '/projects'. I've added a projects.js file in the pages directory with the logical code and when I use next/link for client side transition, I get an error: Route did not complete loading: ""projects"".
When I use regular anchor tag for routing, there is no issue.

**Expected Behavior**

It should change the route to the destined page without any error.

**To Reproduce**

```
import styles from '../styles/Home.module.css'
import Link from 'next/link'

export default function Footer() {
    return (
        <>
            <div className={styles.link}>
                <a href=""https://github.com/devdaksh"" target=""__blank"">github</a>
                <a href=""https://twitter.com/dawksh"" target=""__blank"">twitter</a>
                <a href=""https://devdaksh.hashnode.dev"" target=""__blank"">blogs</a>
                <a href=""mailto:akshd@outlook.com"">email</a>
                <Link href=""/projects"" >
                    <a>projects</a>
                </Link>
            </div>
        </>
    )
}
```

![Screenshot (130)](https://user-images.githubusercontent.com/20741933/105847787-1433b200-6004-11eb-9331-62681d1a4865.png)

This is a screenshot of the error",shuding,kind: bug,2021-01-26T12:57:16Z,2021-03-05T16:32:00Z,dawksh,donpark;mikkelramlov;dawksh;florianmartens;ocodista;ghost;timneutkens;balazsorban44;retr00exe;GaddMaster;bpas247;dbo;timkindberg,dawksh;Timer,Timer,shuding,,,
vercel/next.js,22130,"Warning: Prop `href` did not match. Server: ""https://dev-user.example.com/"" Client: ""/"" **What version of Next.js are you using?**

10.0.7-canary.8

**What version of Node.js are you using?**

12.16.3

**What browser are you using?**

Google Chrome Version 88.0.4324.146 (Official Build) (x86_64)

**What operating system are you using?**

Mac OS Big Sur 11.1

**How are you deploying your application?**

next start

**Describe the Bug**

With this `next.config.js` 

```
module.exports = {
  i18n: {
    locales: ['en-US', 'it'],
    defaultLocale: 'it',
    domains: [
      {
        domain: 'dev-user.example.com',
        defaultLocale: 'it',
      }
    ]
  }
}
```
And this code:
```javascript
<Link href=""/"">
  <a>Just a link</a>
</Link>
```
In `development` I'm watching these warings from React:
```
Warning: Prop `href` did not match. Server: ""https://dev-user.example.com/"" Client: ""/""
```
Note that the domain is not `example` but I'm not on `localhost` 

**Expected Behavior**

The expected behaviour is not having those warnigs. I think what React is trying to say is that the HTML generated by the server is different when is computed in the client.

If I switch my `next.config.js` from [Next i18n Domain routing](https://nextjs.org/docs/advanced-features/i18n-routing#domain-routing) to [Next i18n Sub-path routing](https://nextjs.org/docs/advanced-features/i18n-routing#sub-path-routing) these warnings are gone.

So my theory is that `next/link` is behaving differently in `Server` and `Client` somehow.

**To Reproduce**

Yes! I can reproduce. Here are the steps:

1. Clone this repo. [next@canary + nginx in a docker-compose](https://github.com/andresgutgon/next-href-warning)
2. run `docker-compose up`
3. Change for a moment your `/etc/hosts` 

My `/etc/hosts` has this line:
```
127.0.0.1 dev-user.example.com
```
After that you should see this error:
![image](https://user-images.githubusercontent.com/49499/107816789-8f6fc480-6d75-11eb-947c-57b51666f082.png)


I think followed all the steps : ) Let me know if something is not clear.",ijjk,kind: bug;type: needs investigation,2021-02-12T20:20:49Z,2021-06-22T16:55:53Z,andresgutgon,andresgutgon;djfarly;vbuch;SpeedingRoo;el-zoltan;valdeniomarinho;phuocng;medmin;craftgear;matteociasco;karmingc;timneutkens;ramonortigosa;shane-arthur;jacobhytter;preeteshjain;marnixhoh;ms77grz;renanlido,andresgutgon,timneutkens,,,ijjk,
vercel/next.js,22329,"Invalid Accept-Language header will crash the server **What version of Next.js are you using?**

10.0.7

**What version of Node.js are you using?**

15.6.0

**What browser are you using?**

N/A

**What operating system are you using?**

Docker: node:15.6.0-alpine3.11

**How are you deploying your application?**

next start

**Describe the Bug**

If the server receives a request with an invalid Acceot-Language header it crashes due to an un caught exception

```
(node:18) UnhandledPromiseRejectionWarning: Error: Invalid accept-language header
    at Object.internals.parse (/app/node_modules/@hapi/accept/lib/header.js:144:28)
    at Object.exports.selections (/app/node_modules/@hapi/accept/lib/header.js:21:22)
    at Object.exports.selection (/app/node_modules/@hapi/accept/lib/header.js:12:32)
    at Object.exports.<computed> [as language] (/app/node_modules/@hapi/accept/lib/index.js:29:53)
    at DevServer.handleRequest (/app/node_modules/next/dist/next-server/server/next-server.js:19:265)
    at Server.emit (events.js:315:20)
    at parserOnIncoming (_http_server.js:790:12)
    at HTTPParser.parserOnHeadersComplete (_http_common.js:119:17)
(node:18) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 503)
```

**Expected Behavior**

It not to crash

**To Reproduce**

- Start your server
- send a curl request at it with an invalid Accept-Language header \
```bash
curl https://my.next-project.com -H 'Accept-Language: ldfir;'
```
- the server crashes

The error will also happen with the dev server `next dev` but the server doesnt actually crash in that case

",huozhi,kind: bug,2021-02-19T09:47:25Z,2021-06-22T15:05:55Z,indeedhat,hanayashiki;eugle;xcrzx;lortmorris;kkoudev;wereHamster;psaren;indeedhat;balazsorban44,indeedhat;timneutkens,timneutkens,timneutkens;huozhi,huozhi,,
vercel/next.js,2240,"hash urls break in exported pages When exporting pages to static html & js in next@3.0.0-beta14.
`href=""#somewhere""` becomes `href=""#somewhere/""`",arunoda,kind: bug,2017-06-12T22:00:20Z,2017-06-13T06:14:32Z,cloudkite,arunoda,arunoda,,arunoda,,arunoda,
vercel/next.js,2249,"No router errors in exported site There are no router errors in an exported site using next@3.0.0-beta14.

This happens on a fresh install with a single page containing a non-existing link.

When I click the link the router fires `onRouteChangeStart`, then the server responds with a 404 error and nothing happens.

`onRouteChangeError` is never called and the error document is never shown. The same happens also when clicking a link and a network error occurs.",arunoda,kind: bug,2017-06-13T15:53:22Z,2018-05-11T07:01:22Z,code2k,arunoda;q-nishimura;code2k,timneutkens,,arunoda,,code2k,
vercel/next.js,22741,"react-loadable-manifest can be missing needed modules in some cases When using `next/dynamic`, the [react-loadable-manifest plugin](https://github.com/vercel/next.js/blob/2046648fa720de0a21686ec2ed953627b82f4a4f/packages/next/build/webpack/plugins/react-loadable-plugin.ts) can fail to include modules that should be included. 

We need to update the react-loadable-manifest plugin to handle these cases as well as attempt to add a test for this as well. 

This was initially noticed while using `next/dynamic` on the Vercel blog and is currently the only reproduction. This occurs with both webpack 4 and webpack 5. 

When these modules aren't included in the react-loadable-manifest it can cause hydration issues since we aren't waiting for all of the needed modules to be loaded before hydrating. ",sokra,kind: bug;type: needs investigation,2021-03-03T22:22:22Z,2021-04-21T11:18:05Z,ijjk,Saci46;timneutkens;balazsorban44,ijjk,ijjk,ijjk,,,
vercel/next.js,22750,"Router is mistaking index route for a dynamic route with fallback ### What version of Next.js are you using?

10.0.7

### What version of Node.js are you using?

14.12.0

### What browser are you using?

Chrome, Safari, Firefox

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

The Next.js router is mistaking the index.js route as a dynamic route with a query of ""index"".

I have 2 pages:
-鑱絧ages/index.js
-鑱絧ages/[page].js with fallback

Occasionally when loading the index route, I am getting directed to the [page].js route which is returning as an error page.
The router at this point is looking like this: 
```
{
  ""pathname"": ""/[page]"",
  ""route"": ""/[page]"",
  ""query"": {
    ""page"": ""index""
  },
  ""asPath"": ""/"",
  ""components"": {
    ""/[page]"": {
      ""initial"": true,
      ""props"": {
        ""pageProps"": {
          ""preview"": false,
          ""pageData"": {}
        },
        ""__N_SSG"": true
      },
      ""__N_SSG"": true
    },
    ""/_app"": {
      ""styleSheets"": []
    }
  },
  ""isFallback"": false,
  ""basePath"": """",
  ""isReady"": true,
  ""isLocaleDomain"": false,
  ""events"": {}
}
```

### Expected Behavior

The index route should load consistently

### To Reproduce

Create an `index.js` page and a dynamic route page with `fallback: true`.

Load the index route in the browser and refresh until it does not display.

My site can also be viewed for an example: [https://cappellazzo-website-cvrquuxk8-homestudio.vercel.app/](https://cappellazzo-website-cvrquuxk8-homestudio.vercel.app/)

",ijjk,kind: bug,2021-03-04T00:06:45Z,2021-03-04T22:09:46Z,dennylouis,balazsorban44,dennylouis;ijjk,ijjk,ijjk,,,
vercel/next.js,2278,"Link component doesn't navigate properly when it has a hash fragment in it Reproductions:

Case 1:

You are in the home page and you click this link:
```
<Link href=""/partners#retailers"">Retailers</Link>
// Somewhere down the page
<a id=""retailers"" name=""retailers"" />
```

It will take you to the page, but will not scroll back to the top nor take you to the `retailers` anchor.

Case 2:

You are in the `/partners` page and you click this link:

```
<Link href=""/partners#retailers"">Retailers</Link>
// Somewhere down the page
<a id=""retailers"" name=""retailers"" />
```

It will not jump you to the `retailers` anchor that was placed further down.
  ",arunoda,kind: bug;good first issue,2017-06-15T21:55:15Z,2018-01-06T16:14:58Z,rclai,khrome83;rclai;pozylon;arunoda;EranM6;timneutkens;pablopunk;superbull,timneutkens;arunoda,arunoda,arunoda,,timneutkens,
vercel/next.js,22811,"10.0.8: Env variables redefined within next.config.js are undefined in dev mode ### What version of Next.js are you using?

10.0.8

### What version of Node.js are you using?

14.15.1

### What browser are you using?

Tested in Firefox and Safari 

### What operating system are you using?

macOS Big Sur 11.2.1

### How are you deploying your application?

yarn dev, yarn build && yarn start

### Describe the Bug

Environment variables defined in `next.config.js` return undefined in page components when on dev mode (yarn dev).
But running the same project on production (yarn build && yarn start) the env variables work as expected.

### Expected Behavior

If env variables are set in an `.env` file at the root of the project and then exposed to Next.js within the `next.config.js` file I would expect them to be accessible in component code in both production and development environments. 

### To Reproduce

1. Clone example project. https://github.com/krall12/nextjs-env-config-dev-bug
2. Install deps
3. run yarn dev and open browser. You should see the test environment variable not defined. 
4. run yarn build && yarn start and open your browser. You should see the test environment variable correctly defined. 

As a control: 
1. yarn add next@10.0.7
2. in both dev and production modes the environment variable is returned correctly. 

",ijjk,kind: bug,2021-03-05T22:00:29Z,2021-03-08T16:53:52Z,krall12,neilpoulin;TimNZ;krall12;OmgDef;ijjk;underfisk;nfantone;violabg;balazsorban44;weyert;tophsic;jsonchou;ciruz,krall12;ijjk,ijjk,ijjk,,,
vercel/next.js,22815,"Next 10.0.8 attempts to generate static error pages despite `_error` with `getInitialProps` ### What version of Next.js are you using?

10.0.8

### What version of Node.js are you using?

12.13.0

### What browser are you using?

All

### What operating system are you using?

macOS

### How are you deploying your application?

Own infra

### Describe the Bug

We have an `_error` component with `getInitialProps` (as does our `_app` component) and no `/404` or `/500` components, as we need dynamism on these routes for i18n, tracking, etc. Under 10.0.7, this correctly opted all error paths out of static optimization during build:
```
Warning: You have opted-out of Automatic Static Optimization due to `getInitialProps` in `pages/_app`. This does not opt-out pages with `getStaticProps`
Read more: https://err.sh/next.js/opt-out-auto-static-optimization

info  - Collecting page data  
Page                                           Size     First Load JS
閳 浣 /                                          306 B           429 kB
閳   /_app                                      0 B             296 kB
閳 浣 /404                                       308 B           429 kB
閳 浣 /login                                     309 B           429 kB
閳 浣 /not-found                                 309 B           429 kB
...etc
```

Under 10.0.8, `next build` attempts to erroneously generate static pages, which fails because they rely on dynamism (specifically data collected from our custom server and transported into Next via the `req` object):
```
Warning: You have opted-out of Automatic Static Optimization due to `getInitialProps` in `pages/_app`. This does not opt-out pages with `getStaticProps`
Read more: https://err.sh/next.js/opt-out-auto-static-optimization

info  - Collecting page data  
[  ==] info  - Generating static pages (0/3)
Error occurred prerendering page ""/404"". Read more: https://err.sh/next.js/prerender-error
...

Error occurred prerendering page ""/404.html"". Read more: https://err.sh/next.js/prerender-error
...

Error occurred prerendering page ""/500"". Read more: https://err.sh/next.js/prerender-error
...

info  - Generating static pages (3/3)

> Build error occurred
Error: Export encountered errors on following paths:
	/404
	/404.html
	/500
```

I'm guessing this was introduced alongside the new static `/500` component introduction?

### Expected Behavior

`next build` won't attempt to generate static pages for 404/500 paths when `_error` has `getInitialProps` defined and no static `404` or `500` components are defined

### To Reproduce

Attempt to build a next app with `_error` with `getInitialProps` defined and no `500` or `404` components

",ijjk,kind: bug;area: documentation,2021-03-06T03:36:29Z,2021-03-09T09:55:29Z,merrywhether,ijjk;kikoanis;matheusalcuri;tm1000;merrywhether;balazsorban44;jondcallahan;dutchenkoOleg;prarabdhb;timneutkens,merrywhether;ijjk,ijjk,ijjk,,,
vercel/next.js,22847,"Bug: Not found routes-manifest.json at deploying by Vercel. v10.0.8 ### What version of Next.js are you using?

10.0.8

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

When I deploy vercel, I get an error after the build step. I have confirmed that no error occurs in v10.0.7.

```
23:32:15.953  	Traced Next.js server files in: 11311.251ms
23:32:15.958  	[Error: ENOENT: no such file or directory, lstat '/.next/routes-manifest.json'] {
23:32:15.958  	  errno: -2,
23:32:15.958  	  code: 'ENOENT',
23:32:15.958  	  syscall: 'lstat',
23:32:15.958  	  path: '/.next/routes-manifest.json'
23:32:15.959  	}
23:32:18.607  	Done with ""package.json""
```

![閵堝箍鍋楅妷閵夌哄厒閵堟灚鍎抽妷鍐﹀創 2021-03-07 23 43 30](https://user-images.githubusercontent.com/6711766/110243730-f3656180-7f9e-11eb-9697-67913d236149.png)

### Expected Behavior

Expect the deployment to be successful.

### To Reproduce

1. install NextJS v10.0.8
2. create ssr page application
3. deploy by Vercel

",ijjk,kind: bug,2021-03-07T14:42:33Z,2021-03-11T16:32:50Z,aiji42,ijjk;underfisk;balazsorban44;aiji42,aiji42;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,22925,"10.0.8 next/image high memory use ### What version of Next.js are you using?

10.0.8

### What version of Node.js are you using?

14.15.4

### What browser are you using?

chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

With v10.0.8 on pages with lots of next/image components seeing much higher memory use compared to 10.0.7. Possibly related to https://github.com/vercel/next.js/pull/22253

### Expected Behavior

less memory use

### To Reproduce

checkout branch `nextjs-leak` https://github.com/scttcper/xmplaylist/tree/nextjs-leak
run `yarn && yarn build && cd frontend && npx next start`

open localhost:3000 and just refresh the root/home page a few times (the backend is not required for this page). Memory should shoot up to 400-500mb. In production this was consuming 2gb (all memory available)


Production version is - https://xmplaylist.com/ you can see the home page has a good set of images.

",shuding,kind: bug;type: needs investigation,2021-03-10T00:49:31Z,2021-03-16T21:08:36Z,scttcper,frigus02;jnv;timneutkens;fostyfost;Trallp;jakubjo;gu-stav;karlhorky;balazsorban44;underfisk;r3na;muntasirsyed;imhuynq;shuding;chemicalkosek,scttcper;timneutkens,timneutkens,shuding,,,vercel/next.js#23189;
vercel/next.js,22929,"10.0.8 next/image double images ### What version of Next.js are you using?

10.0.8

### What version of Node.js are you using?

15.2.0

### What browser are you using?

Chrom, Safari, Firefox

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

Many of the images show up duplicated after being compressed from next/image and also have a greenish hue to them, this fixes itself if unoptimized is set to true, can also be reproduced in 10.0.9-canary.4 but not in 10.0.7. Possibly related to #22253

### Expected Behavior

Image just appearing once in the correct size and colours as they used to

### To Reproduce

The code below is able to reproduce the issue


```jsx
import Image from ""next/image"";

export default function Demo() {
    return (
        <Image src={""https://i.imgur.com/WCcL3Ip.png""} alt={""""}
               width={36} height={36}/>
    )
}
```


Image before conversion
![https://i.imgur.com/WCcL3Ip.png](https://i.imgur.com/WCcL3Ip.png)

Image after conversion
![https://i.imgur.com/dHE5BPB.png](https://i.imgur.com/dHE5BPB.png)
",shuding,kind: bug;template: bug,2021-03-10T05:44:44Z,2021-04-01T15:16:26Z,kush-agra,shuding;balazsorban44,kush-agra;shuding,,shuding,,,
vercel/next.js,2293,"when run command `npm run build`, an error 'Error: ENOENT: no such file or directory' occurred. package.json 

```json
{
  ""name"": ""next_train"",
  ""version"": ""1.0.0"",
  ""description"": ""next.js train"",
  ""main"": ""index.js"",
  ""scripts"": {
    ""test"": ""echo \""Error: no test specified\"" && exit 1"",
    ""dev"": ""node server.js"",
    ""build"": ""next build"",
    ""start"": ""next start""
  },
  ""keywords"": [],
  ""author"": """",
  ""license"": ""ISC"",
  ""repository"": ""next_train"",
  ""dependencies"": {
    ""isomorphic-unfetch"": ""^1.0.0"",
    ""koa"": ""^2.2.0"",
    ""koa-bodyparser"": ""^4.2.0"",
    ""koa-router"": ""^7.2.0"",
    ""next"": ""^2.4.3"",
    ""react"": ""^15.6.1"",
    ""react-dom"": ""^15.6.1""
  }
}
```

npm log
```bash
F:\node\project\next_train>npm run build

> next_train@1.0.0 build F:\node\project\next_train
> next build

{ Error: ENOENT: no such file or directory, open 'F:\node\project\next_train\.next\build-stats.json'
  errno: -4058,
  code: 'ENOENT',
  syscall: 'open',
  path: 'F:\\node\\project\\next_train\\.next\\build-stats.json' }
npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! next_train@1.0.0 build: `next build`
npm ERR! Exit status 1
npm ERR!
npm ERR! Failed at the next_train@1.0.0 build script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     C:\Users\xinsh\AppData\Roaming\npm-cache\_logs\2017-06-17T07_28_48_316Z-debug.log
```

npm run dev ok, operating system is win10",arunoda,kind: bug,2017-06-17T07:34:45Z,2017-09-13T06:21:33Z,joyran,nelix,timneutkens,,arunoda,,joyran,
vercel/next.js,22994,"[ =] info - Generating static pages (0/0) never completes ### What version of Next.js are you using?

npm i next@10.0.9-canary.6

### What version of Node.js are you using?

12.19.1

### What browser are you using?

Chrome Version 89.0.4389.82

### What operating system are you using?

CentOS 7

### How are you deploying your application?

next build

### Describe the Bug

After running into problems similar in nature to #22815 and #22907 I upgraded to `10.0.9-canary.6`. This seemed to resolve the issue with it blowing when running `next build` however when it gets to the ""Generating static pages"" section there are 0 static pages and this seems to cause some sort of infinite loop. I walked away for 45 minutes while it sat there doing `[ =] info - Generating static pages (0/0)` but nothing changed. I had to abort back to 10.0.7 (before the issues in #22815 and #22907)

### Expected Behavior

I'd expect it to be able to complete generating static pages (of which there are none)

### To Reproduce

Not sure of the exact steps to reproduce other than what was mentioned in #22815 and #22907

",ijjk,kind: bug,2021-03-11T23:00:16Z,2021-03-12T08:36:29Z,tm1000,tm1000;balazsorban44,tm1000;ijjk,ijjk,ijjk,,,
vercel/next.js,230,"Page does not reload after recovering from server error If there is e.g a syntax error in the code, browser displays 500 error, then error is fixed, the console shows that code is rebuilt correctly, but the page isn't refreshed automatically (need to hit F5).

Tested with Next 1.1.0.",timneutkens,kind: bug,2016-11-08T15:14:33Z,2018-09-17T11:25:21Z,sedubois,nkzawa;sedubois;timneutkens,nkzawa,,timneutkens,,timneutkens,
vercel/next.js,2305,console keeps refreshing; errors disappear It is very hard to debug a lot of app errors because the console keeps refreshing. Is there any way to disable that?!,arunoda,kind: bug,2017-06-18T19:34:03Z,2017-07-02T07:29:29Z,hchoriq,albinekb;arunoda;radum;hchoriq,arunoda,,arunoda,,arunoda,
vercel/next.js,23156,"target: serverless being ignored ### What version of Next.js are you using?

10.0.9

### What version of Node.js are you using?

12.15

### What browser are you using?

N/A

### What operating system are you using?

N/A

### How are you deploying your application?

Gitlab -> Vercel

### Describe the Bug

In 10.0.7, I could build my application, installing 10.0.9 caused a breaking change where target:""serverless"" seemed to be being ignored.
...
  const target = { target: 'experimental-serverless-trace' };
...
Error: No serverless pages were built. Learn More: https://err.sh/vercel/vercel/now-next-no-serverless-pages-built

Rolling back to 10.0.7 fixes the issue.

### Expected Behavior

Serverless pages were built

### To Reproduce

Attempt to build application with target:""serverless"" in vercel

",ijjk,kind: bug,2021-03-17T15:32:52Z,2021-03-17T19:52:44Z,kyle-ssg,ijjk;kyle-ssg;balazsorban44,kyle-ssg;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,23189,"Memory leak in Image Optimization ### What version of Next.js are you using?

10.0.9

### What version of Node.js are you using?

14.15.5

### What browser are you using?

Chrome

### What operating system are you using?

alpine (docker image)

### How are you deploying your application?

express server

### Describe the Bug

Upgrading from 10.0.7 to 10.0.8 or 10.0.9 results in a server side memory leak when using the <Image /> component.
Consumes over 1GB of memory after only 10-20 image optimizations.

### Expected Behavior

Memory usage should be normal.

### To Reproduce

Import Image from 'next/image' and use it as the the documentation says https://nextjs.org/docs/api-reference/next/image with an allowed external image source.
In this case layout=""fixed"" was used.

",shuding,kind: bug,2021-03-18T13:37:15Z,2021-04-02T10:26:14Z,Pythe1337N,shuding;Pythe1337N;mjenzen;jdfm;avisra;joe-bell;andrijavulicevic;thomasgrivet;henryStelle;fabb;gu-stav;tbanys;JVictorV;karlhorky;kmdev1;timneutkens;ahmetuysal;tiagocarmo;stefanprobst,Pythe1337N,,,,timneutkens,
vercel/next.js,23201,"VoiceOver support in next/image ### What version of Next.js are you using?

10.0.6

### What version of Node.js are you using?

12.20.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS 11

### How are you deploying your application?

next start + Vercel

### Describe the Bug

When using `next/image` images that are below the fold, the images are loaded using `visibility: none`. This causes screenreaders to ignore the element and not read it, even though scrolling the element into the viewport would display the element for sighted users.

### Expected Behavior

VoiceOver should read and scroll to `next/image` images below the fold.

### To Reproduce

See repo here: https://github.com/myplanetdigital/voiceover-next-image-bug and deployment here: https://voiceover-next-image-shanly-myplanet.vercel.app/

Steps to reproduce:
1. Go to the deployment with VoiceOver on
2. Try to navigate using the voiceover cursor (VO+left, VO+right)
3. Note that the UL is announced as having four items, but only one (the one above the fold) is read.

I believe this is due to the use of `visibility: hidden`, which prevents screen readers from parsing an element. I don't understand the purpose of that rule as the images are already defaulting to lazy loading.",shuding,kind: bug,2021-03-18T17:26:58Z,2021-03-22T19:20:52Z,shanly-suepaul,nersoh;shuding;balazsorban44,shanly-suepaul;shuding;timneutkens,timneutkens;shuding,shuding,,,
vercel/next.js,23312,"next/image serves files other than images from public dir ### What version of Next.js are you using?

10.0.7

### What version of Node.js are you using?

14.15.1

### What browser are you using?

chrome

### What operating system are you using?

linux

### How are you deploying your application?

next start

### Describe the Bug

`next/image` package should not serve other files rather then only images excluding svg

### Expected Behavior

only image are allowed, excluding svg - it is responsive by it self

### To Reproduce

1. create simple nextjs app
2. add simple json file to `public/locales/en-GB/common.json` with some sample json content
3. run `npm build`
4. run `npm start`
5. navigate to `http://localhost:3000/_next/image?url=/locales/en-GB/common.json&w=640&q=75`

![image](https://user-images.githubusercontent.com/468006/112150482-d0ff5500-8be8-11eb-9665-8a1e55b1c38a.png)
",shuding,kind: bug,2021-03-23T13:02:46Z,2021-03-24T17:59:00Z,FDiskas,FDiskas;balazsorban44,FDiskas;shuding,shuding,shuding,,,
vercel/next.js,23415,"has field example seems wrong in next@canary ### What version of Next.js are you using?

10.0.10-canary.11

### What version of Node.js are you using?

12.2.0

### What browser are you using?

Edge

### What operating system are you using?

macOS

### How are you deploying your application?

Not deploying

### Describe the Bug

When following the recently added example provided in https://github.com/vercel/next.js/blob/canary/docs/api-reference/next.config.js/rewrites.md#header-cookie-and-query-matching for the `has` field with type `query`, the following error occurs when running `next dev` or `next build`:

```
`destination` has segments not in `source` (page) for route {""source"":""/specific/:path*"",""has"":[{""type"":""query"",""key"":""page"",""value"":""home""}],""destination"":""/:path*/:page""}
```

### Expected Behavior

I am not entirely sure on this one. I would love if `:page` was accessible there but I believe the example is incorrect.

### To Reproduce

```
npx create-next-app some-app
```

Create a `next.config.js` file in the root folder and add this content:

```
module.exports = {
  async rewrites() {
    return [
      {
        source: ""/specific/:path*"",
        has: [
          {
            type: ""query"",
            key: ""page"",
            value: ""home"",
          },
        ],
        destination: ""/:path*/:page"",
      },
    ];
  },
};
```

Run either `next build` or `next start`.

",ijjk,kind: bug,2021-03-26T09:41:10Z,2021-04-13T12:34:51Z,gustavobini,laugharn;gustavobini;ijjk;balazsorban44,gustavobini;ijjk,ijjk,ijjk,,,
vercel/next.js,23436,"Race condition with Image Loader makes it unusable in a production environment ### What version of Next.js are you using?

10.0.9

### What version of Node.js are you using?

v12.19.0, v14.16.0

### What browser are you using?

Any browser

### What operating system are you using?

Any OS

### How are you deploying your application?

AWS

### Describe the Bug

The default image loader at present seems to suffer from a race condition. Unfortunately this issue has now meant that for us, the pretty awesome functionality, cannot be used at all.

Assuming the image cache does not contain the given image, when making a request the loader will go off and do it's thing and then return the given image and add it to its cache. The problem comes when you have real traffic.

Example scenario:

Lets assume you have a simple page that has 3 images that are utilising next/image. The page has an average traffic of 10 req/s for a given screen size. This page is brand new and the images have never been server before (ie the image's do not yet exist in the cache). 

Currently when this above scenario happens, c.30 calls to the original image URL happen. Each one of these images then resolves, gets transformed and then placed into the cache and returned to the user. The important note here is that we now have a cache folder that contains 10 cached files of the same image three times.

When we replicate the above scenario but in more realistic terms (12 images on a new page with average traffic of 25 req/s) this means that we suddenly have a cache folder that contains 25 images x 12 (300 total). This is because when the first request comes in, the code says hey you're not in the cache, lets go get you. The second request comes in and says, hey you're not in the cache (because the first one is still processing), let's go get you and so on and so on.

So why does this cause the container to die? It doesn't; writing and reading from disk is not the only thing that the loader is doing. Http requests, FS, Image manipulation. These things are heavy on not only memory but CPU too.

In the above example we're asking a container to not only go and fetch 300 images per second, we're also manipulating, writing to file storage, serving back. The chances are then by the time these have finished, the next second comes around with another 300 requests, the chances are probably the images still aren't in the cache because the the CPU is rocketed and so has the memory so things just start to back up and get worse and worse until the container falls over completely.

TL;DR:

Requests to non cached images are not aware of each other which means there's a race condition when the same image is requested from the same user within the same time period of it not being in the cache. This then (with enough traffic) spirals into a horrible loop that is non escapable and leads to the containers falling over.

### Expected Behavior

I'd expect that when parallel requests are made, that the image loader is directly only called once and is sat behind some sort of batching mechanism (similar to DataLoader) that removes duplicates and is aware of parallel requests and then maps the responses accordingly. This means that the site could require 500 images per second of the same image, but only do all of the hardware intensive stuff once.

### To Reproduce

- Create simple page with a single (or multiple) image(s) utilising next/image
- Deploy/run the container so you can see memory/cpu usage
- Start simultaneous request
- Notice Memory/CPU usage climbing
- Notice cache folder starting to drastically grow in size
- If persisted, eventually hardware limitations will be met

",shuding,kind: bug,2021-03-26T21:04:55Z,2021-04-12T22:38:52Z,kmdev1,goguda;kmdev1;balazsorban44;atom-shanghai;shuding;PranavSathy,kmdev1;shuding,shuding,shuding,,,
vercel/next.js,23490,"Rewrites query params not available in useRouter ### What version of Next.js are you using?

10.0.9

### What version of Node.js are you using?

14.15.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next dev

### Describe the Bug

Query parameters specified in the destination of a next rewrites module entry are not made available client side by the router.



### Expected Behavior

Query property of the useRouter hook shall include the properties specified in the rewrites module.

### To Reproduce

See bellow

Create next.config.js as follow:
```
module.exports = {
  async rewrites() {
    return [
      {
        source: ""/hello/:second"",
        destination: ""/hello?second=:second"",
      },
    ];
  },
};
```

Create pages/hello.js
```
import { useRouter } from ""next/router"";

export default function Hello() {
  const { query } = useRouter();

  console.log(query);

  return <div>Hello</div>;
}
```

Go to page http://localhost:3000/hello/test - query object is empty
<img width=""277"" alt=""Capture d閳ユ獔铏俢ran 2021-03-29 a铏 09 36 22"" src=""https://user-images.githubusercontent.com/45501180/112767268-41d3c080-9072-11eb-9842-5c54e66bd548.png"">

Got to page http://localhost:3000/hello/test?t=3 - query object contains both values **second**  and **t** 
<img width=""212"" alt=""Capture d閳ユ獔铏俢ran 2021-03-29 a铏 09 38 04"" src=""https://user-images.githubusercontent.com/45501180/112767312-83fd0200-9072-11eb-9a96-4bac84aae897.png"">


",ijjk,kind: bug,2021-03-28T20:40:05Z,2021-04-18T10:00:04Z,njarraud,ijjk;njarraud;balazsorban44,njarraud;ijjk,ijjk,ijjk,,,
vercel/next.js,23519,"Next 10.1 respawns infinite jest-worker child processes ### What version of Next.js are you using?

10.1.0

### What version of Node.js are you using?

12.18.3

### What browser are you using?

N/A

### What operating system are you using?

Windows 10.1809

### How are you deploying your application?

next dev

### Describe the Bug

I have a Next application that's been running on 10.0.3.  I just tried to update it to 10.1.0, and now every time I start `next dev`, my CPU pegs to 100% and stays there. Inspecting the process tree, I see the parent Next process, a couple children, and then an infinite series of child `jest-worker` processes that are spawning, dying, and re-spawning. The `jest-worker` process respawns appear to be the culprit for the CPU usage:

![image](https://user-images.githubusercontent.com/1128784/112896959-086c7680-90ad-11eb-9285-6c5a7665dcc2.png)

Part of the excess CPU usage is due to this corporate machine having extra process security checks that slow down Windows process creation.  However, previous versions of Next worked just fine, and I can confirm that the behavior first appears in 10.0.10-canary.1 .

### Expected Behavior

Next would start, eat some CPU and spawn a few processes during startup, but then settle down to idle after initial setup is complete.

### To Reproduce

Haven't tried reproducing this as a standalone project or repro. But, I've stepped my way through a dozen different Next versions within our repo, and I can confirm that this first appeared in version 10.0.10-canary.1.

Some of the 10.x versions I tried, and their results:

- 0.6, 0.7: work (no extra processes)
- 0.8, 0.9, 0.10-c.0: crash on startup (EPIPE)
- 0.10-c.1 and up: failure (extra processes)

Each time, all I've done is:

```
yarn add next@10.0.$SOME_VERSION
yarn dev
```

If I compare https://github.com/vercel/next.js/compare/v10.0.10-canary.0...v10.0.10-canary.1 , I see that canary.1 includes https://github.com/vercel/next.js/pull/23077 , which is an update to the `jest-worker` library. 

That PR seems like the likely candidate to have modified the child process behavior. 

",ijjk,kind: bug;area: Compiler,2021-03-29T20:37:13Z,2022-02-03T19:16:15Z,markerikson,rkrv;CharlieHess;quinn;ijjk;markerikson;egeriis,markerikson;Timer,Timer,,,ijjk,
vercel/next.js,23553,"Regional Locale duplicate route on back button pressed ### What version of Next.js are you using?

10.0.9

### What version of Node.js are you using?

14.15

### What browser are you using?

Chrome

### What operating system are you using?

Windows

### How are you deploying your application?

Vercel

### Describe the Bug

When using regional locale like fr-CA and en-CA, after navigating with Next/Link, the browser go back button append the locale twice in the url. 

### Expected Behavior

The locale should only be present once in the url

### To Reproduce

1) Create a NextJS project with i18n and two regional locale (fr-CA, en-CA)
2) Using the url, navigate to the page locale (https://localhost:3000/fr-ca/login let's say).
3) From the page, navigate using Next/Link to another page. (https://localhost:3000/fr-ca/login let's say). You should see the regional locale being transform to uppercase. (fr-ca -> fr-CA). Go back to the previous page using the browser back button.
4) The path is now /fr-CA/fr-ca/
 

",ijjk,kind: bug,2021-03-30T14:25:59Z,2021-04-18T09:01:02Z,sebastienlabine,benkermode;ijjk;balazsorban44,sebastienlabine;ijjk,ijjk,ijjk,,,
vercel/next.js,23577,"Rewrites matching i18n route in front when they should not. ### What version of Next.js are you using?

10.1.2

### What version of Node.js are you using?

14.15.4

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

local only (npm run dev)

### Describe the Bug

With the following next.config.js

```
module.exports = {
  i18n: {
    locales: ['en', 'el'],
    defaultLocale: 'el',
    localeDetection: false,
  },

  async rewrites() {
    return {
      fallback: [
        {
          source: '/:path*',
          destination: '/foo'
        },
      ]
    }
  },
}
```

the url ```/en?v=2``` gets rewritten when it should not. All of ```/```, ```/en```, ```/?v=2``` are correctly not rewritten.

### Expected Behavior

The url ```/en?v=2``` should not be rewritten.

### To Reproduce

With the following next.config.js

```
module.exports = {
  i18n: {
    locales: ['en', 'el'],
    defaultLocale: 'el',
    localeDetection: false,
  },

  async rewrites() {
    return {
      fallback: [
        {
          source: '/:path*',
          destination: '/foo'
        },
      ]
    }
  },
}
```
and the /foo page existing, visit ```/en?v=2``` and you will see the content of /foo page instead of the correct frontpage content.

",ijjk,kind: bug,2021-03-31T12:33:24Z,2021-04-06T10:25:04Z,smessaris,ijjk;smessaris;TheFullResolution;balazsorban44,smessaris;ijjk,ijjk,ijjk,,,
vercel/next.js,23623,"Redirecting externally in getServerSideProps with basePath ### What version of Next.js are you using?

10.1.0

### What version of Node.js are you using?

12.18.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Other

### Describe the Bug

When redirecting to an external URL in getServerSideProps with a basePath, the destination path is instead appending to the current url.
```
  return {
    redirect: {
      destination: 'https://www.google.com',
      permanent: false
    }
  }
```
`localhost:3000` becomes `localhost:3000https://www.google.com`

### Expected Behavior

It should redirect with a basePath externally

### To Reproduce

1. Add a basePath
2. Add this to a getServerSideProps:
```
  return {
    redirect: {
      destination: 'https://www.google.com',
      permanent: false
    }
  }
```

",ijjk,kind: bug,2021-04-02T00:25:06Z,2021-04-06T10:02:14Z,craig1123,ijjk;balazsorban44,craig1123;ijjk,ijjk,ijjk,,,
vercel/next.js,23677,"Error with sizes on the standard <Image> component ### What version of Next.js are you using?

10.1.3

### What version of Node.js are you using?

10.22.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

development (no deploy)

### Describe the Bug

Using this code:

      <Image
        src=""/images/lorem.jpg""
        height={150} 
        width={850} 
        layout=""responsive""
        sizes=""50vw"" // <== 棣冩啛 Commenting this line it works
        alt=""Lorem ipsum""
      />

returns this error

    TypeError: sizes.matchAll(...) is not a function or its return value is not iterable

[![enter image description here][1]][1]

And without `_document.js` the error is:

[![enter image description here][2]][2]


Actual code of a standard page (`pages/about.js`)

```
import Image from 'next/image'

export default function About() {
  return (
    <>
      <Image
        src=""/images/profile.jpg"" // Route of the image file
        height={444} // Desired size with correct aspect ratio
        width={844} // Desired size with correct aspect ratio
        layout=""responsive""
        sizes=""50vw""
        alt=""Your Name""
        className=""image""
      />
    </>
  )
}
```



  [1]: https://i.stack.imgur.com/m6BAP.jpg
  [2]: https://i.stack.imgur.com/ws54x.jpg

### Expected Behavior

No error

### To Reproduce

Include an `<Image>` component with `sizes`

",shuding,kind: bug,2021-04-04T07:49:06Z,2021-04-29T10:07:27Z,dangelion,Deep-Codes;JudgmentJay;vadim-givola;dangelion;shuding;antoninlanglade;okaysuper;topovik;balazsorban44,dangelion;shuding,shuding,shuding,,,
vercel/next.js,2371,"Dynamic imports do not load in production builds when a custom distDir is set Example repo: https://github.com/sbking/nextjs-dynamic-import-distdir

This example shows that dynamic import webpack chunks return 404 errors in production builds if a custom `distDir` is set in `next.config.js`. This is simply the `with-dynamic-imports` example with the following next config:

    const config = {
      distDir: 'build',
    }

    module.exports = config

The dynamic imports work perfectly in development mode, but give 404 errors in a production build.",arunoda,kind: bug,2017-06-26T21:52:05Z,2017-07-02T05:53:16Z,sbking,arunoda,arunoda,,arunoda,,arunoda,
vercel/next.js,23719,"Vercel monorepo routing error ""cannot find module var/task[...]api/any-valid-route.js"" after Next upgrade ### What version of Next.js are you using?

10.0.9

### What version of Node.js are you using?

12.13.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

When upgrading Nextjs to 10.0.9 from Nextjs 10.0.8. Next API routing doesn't work in a monorepo setup after build on Vercel.
Keep receiving this error: `Cannot find module var/task/packages/nextjs/.next/server/pages/api/any-valid-route.js`

### Expected Behavior

""/api/any-valid-route"" should be accessible after build and deploy

### To Reproduce

Minimal reproduction repository: [https://github.com/dimroth/aircampus-repro](https://github.com/dimroth/aircampus-repro)
Clone the repository
Try upgrading next to 10.0.9 in `packages/nextjs/package.json` and trigger a build on Vercel. Build should pass but access to ""/api/check-domain"" will fail once deployed.

![Capture d閳ユ獔铏俢ran 2021-04-01 a铏 16 54 46](https://user-images.githubusercontent.com/19348229/113670547-8f28e100-96b5-11eb-9e40-ebf90b4b395a.png)",ijjk,kind: bug,2021-04-06T07:02:03Z,2021-04-17T15:47:32Z,dimroth,ijjk;dimroth;balazsorban44,dimroth;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,23724,"Error: invariant: progress total can not be zero ### What version of Next.js are you using?

10.1.3

### What version of Node.js are you using?

15.12.0

### What browser are you using?

-

### What operating system are you using?

Ubuntu 20.04

### How are you deploying your application?

-

### Describe the Bug

When running `npm run build` next js throws an error (`Error: invariant: progress total can not be zero`) and the build fails


### Expected Behavior

It builds without an error

### To Reproduce

repo: https://github.com/SimonSiefke/nextjs-progress-bug

```js
// pages/[[...slug.js]]

export default function Home() {
  return <div></div>
}

export const getStaticProps = () => {
  return {}
}

export const getStaticPaths = () => {
  return {
    paths: [], // empty for demo, usually there will be data which comes from a cms
    fallback: false,
  }
}
```

```js
// pages/_error.js
import React from 'react'

class Error extends React.Component {
  static getInitialProps({ res, err }) {
    const statusCode = (res && res.statusCode) || (err && err.statusCode)
    return { statusCode }
  }

  render() {
    return <div></div>
  }
}

export default Error
```

Run `npm run build`
The build fails with `Error: invariant: progress total can not be zero`



![screenshot](https://user-images.githubusercontent.com/23744935/113684678-c2736c00-96c5-11eb-82b7-4879dccfdbcc.png)
",ijjk,kind: bug,2021-04-06T08:49:39Z,2021-04-06T17:12:24Z,SimonSiefke,ijjk;SimonSiefke;balazsorban44,SimonSiefke;ijjk,ijjk,ijjk,,,
vercel/next.js,23854,"Dynamic routing does not work with rewrites in dev environment ### What version of Next.js are you using?

10.1.3

### What version of Node.js are you using?

v12.20.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

[Dynamic routing](https://nextjs.org/docs/routing/dynamic-routes) is completely broken in dev mode when using the rewrite rules from [Incrementally Adopting Next.js](https://nextjs.org/docs/migrating/incremental-adoption#rewrites). The original dynamic page route simply isn't found in the app and it gets rewritten to the catch all rewrite url from the config.

It becomes very difficult to test/work on such pages in development, as the only way to test such pages in development would be to each time remove the rewrite rule from the configuration and develop the feature, then add the rewrite rule back, which is more than suboptimal workflow tbh.

### Expected Behavior

Dynamic routes works as expected in dev mode even with rewrite rules.

### To Reproduce

- Create a simple next app and add `/pages/offer/[offerId].js` page file
- Create `next.config.js` with rewrite rule as specified here https://nextjs.org/docs/migrating/incremental-adoption#rewrites
- Start the dev server and navigate to `/offer/1234`
- Notice that instead of loading the dynamic route, the app rewrites to the catch all route from the rewrite rule

The behaviour can be seen in this sample repo https://github.com/emadalam/nextjs-dynamic-routing-bug while running the dev server. When deployed to vercel, the behaviour seems to be normal without bugs https://nextjs-dynamic-routing-bug.vercel.app/offer/1234",ijjk,kind: bug,2021-04-09T10:57:11Z,2021-04-12T09:42:01Z,emadalam,ijjk;balazsorban44,emadalam;ijjk,ijjk,ijjk,,,
vercel/next.js,24056,"Errors in server compilation result in a 404 instead of showing the error overlay ### What version of Next.js are you using?

next@canary

### What version of Node.js are you using?

latest

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Does not affect this bug

### Describe the Bug

Recently found an edge case where if the server compilation fails we'll render a 404 page instead of showing the error overlay. This is obviously not what we'd want. It was surfaced in rauchg's blog and I've opened a PR with a failing test here: https://github.com/vercel/next.js/pull/24054

### Expected Behavior

The webpack error is surfaced instead of showing a 404 page

### To Reproduce

A reproduction is provided as as failing test in https://github.com/vercel/next.js/pull/24054",shuding,kind: bug,2021-04-14T13:03:25Z,2021-04-22T11:47:16Z,timneutkens,balazsorban44,timneutkens,timneutkens,shuding,,,
vercel/next.js,24391,"Bug Report ### What version of Next.js are you using?

10.1.3

### What version of Node.js are you using?

12.22.1

### What browser are you using?

Firefox, Chrome

### What operating system are you using?

Linux

### How are you deploying your application?

next start

### Describe the Bug

When I use a rewrite and the backend is not available, the request hangs.

The console prints

```
Error occurred proxying http://127.0.0.1:8888/somepath Error: connect ECONNREFUSED 127.0.0.1:8888
    at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1146:16) {
  errno: -111,
  code: 'ECONNREFUSED',
  syscall: 'connect',
  address: '127.0.0.1',
  port: 8888
}
```

### Expected Behavior

503

### To Reproduce

A next.config.js with:

```  rewrites: function () {
    return [
      {
        source: '/proxiedPath/somepath',
        destination: '127.0.0.1:8888/somepath',
      },
    ]
  },
```",ijjk,kind: bug,2021-04-23T14:12:16Z,2021-04-26T13:40:33Z,Industrial,Industrial;balazsorban44,Industrial;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,24421,"next/image on node 16 give SIGSEGV ### What version of Next.js are you using?

10.1.3

### What version of Node.js are you using?

16.0.0

### What browser are you using?

Chrome, Firefox

### What operating system are you using?

macOS 11.2.3

### How are you deploying your application?

next dev

### Describe the Bug

Mac Mini M1, Node 16 next start crashes hitting next/images
Already nuked node_modules and locks after updating node version

```
$ next dev
ready - started server on 0.0.0.0:3000, url: http://localhost:3000
info  - Loaded env from /Users/vfornito/DEV/gvdp/vdp/.env.development
info  - Using webpack 4. Reason: future.webpack5 option not enabled https://nextjs.org/docs/messages/webpack5
(node:2822) [DEP0148] DeprecationWarning: Use of deprecated folder mapping ""./"" in the ""exports"" field module resolution of the package at /Users/vfornito/DEV/gvdp/node_modules/next/node_modules/postcss/package.json.
Update this package.json to use a subpath pattern like ""./*"".
(Use `node --trace-deprecation ...` to show where the warning was created)
event - compiled successfully
event - build page: /
wait  - compiling...
event - compiled successfully
error Command failed with signal ""SIGSEGV"".
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
```

### Expected Behavior

To work :)

### To Reproduce

Use a simple next/image on a next.js project. Either using js or TS does not change the behavior",styfle,kind: bug,2021-04-24T14:40:47Z,2021-07-15T06:33:05Z,artecoop,apollonian;artecoop;njdullea;Yagogc;zuccs;jca41;trm217;vrbarros;davidossahdez;timneutkens;karlhorky;ItzaMi;ViktorYermak;fers4t;verekia;lavgup;RuiGuilherme;16abhimasani,artecoop,,,,artecoop,
vercel/next.js,24700,"With webpack 5 and once deployed, local files are not readable from APIs anymore ### What version of Next.js are you using?

10.2.0

### What version of Node.js are you using?

14.0.0

### What browser are you using?

Chrome,Firefox,Safari

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

Since updating to 10.2.0, local files are not accessible from apis anymore once deployed on Vercel. I do not know if it was on purpose, but it used to work fine before upgrading.

In both case, an internal server error is returned. After closer inspection of the logs, the error message is as follows:
```
[Error: ENOENT: no such file or directory, open '/app/data/metadata.yml'] {

errno: -2,

code: 'ENOENT',

syscall: 'open',

path: '/app/data/metadata.yml'

}
```

It went back to normal after downgrading to next 10.1.3.

**EDIT:** It seems the problem comes from webpack 5, it is working fine if webpack5 is disabled in `next.config.js`.

**EDIT:** It does not fail if there is only one API trying to read only one local file. It is possible the problem occurs when multiple files have to be available for reading.

**EDIT:** According to @jacksonhardaker, this also fails when reading files from `getServerSideProps`.

### Expected Behavior

Local files should be readable from apis. If these are not embedded by default anymore, maybe an option could be used to indicate what files should be available?

### To Reproduce

Here is an example showing APIs failing: https://github.com/QuentinRoy/vercel-local-min-example deployed at https://vercel-local-min-example.vercel.app.

Here is another example from @jacksonhardaker showing `getServerSideProps` failing: https://github.com/jacksonhardaker/next-webpack-5-fs-bug deployed at https://next-webpack-5-fs-bug-jwegk8q1o-jacksonhardaker1.vercel.app/.",sokra;ijjk,kind: bug;area: standalone mode,2021-05-02T03:18:15Z,2021-11-17T16:30:25Z,QuentinRoy,QuentinRoy;joe-bell;nath-green;ijjk;marbiano;jonalvarezz;carl0s;adrai;eric-burel;jacksonhardaker;wworrall,QuentinRoy;timneutkens;ijjk,timneutkens,timneutkens,,ijjk,vercel/next.js#25431;
vercel/next.js,24783,"_document  -> makeStylesheetInert -> ""Cannot read property 'type' of null"" if Child is null ### What version of Next.js are you using?

10.2.0

### What version of Node.js are you using?

14.16.0

### What browser are you using?

All

### What operating system are you using?

Windows

### How are you deploying your application?

Other platform

### Describe the Bug

When a Child of the Head is null an exception is thrown: `TypeError: Cannot read property 'type' of null`.

In the condition a nullsafe is missing

https://github.com/vercel/next.js/blob/cf4ba8d7051a4fc47647b7c7bc3b7f4b45de41eb/packages/next/pages/_document.tsx#L331

### Expected Behavior

```
if (c && c.type === 'link' &&
        c.props['href'] &&
        OPTIMIZED_FONT_PROVIDERS.some((url) => c.props['href'].startsWith(url))
      ) 
```

### To Reproduce

In the _document put a null component inside the Head.

```
import Document, { Html, Head, Main, NextScript } from 'next/document'

const NullComponent = () => null;

class MyDocument extends Document {
  static async getInitialProps(ctx) {
    const initialProps = await Document.getInitialProps(ctx)
    return { ...initialProps }
  }

  render() {
    return (
      <Html>
        <Head>
            <NullComponent />
        </Head>
        <body>
          <Main />
          <NextScript />
        </body>
      </Html>
    )
  }
}

export default MyDocument
```",janicklas-ralph,kind: bug;please add a complete reproduction;area: Font Optimization,2021-05-04T14:37:04Z,2021-11-29T16:14:25Z,pecoram,ljosberinn;pecoram;janicklas-ralph;flybayer;atdrago;huozhi;balazsorban44;synoptase;timneutkens;fbudassi,pecoram;timneutkens,timneutkens,timneutkens,,huozhi,
vercel/next.js,25285,"router.back() not working when going back between two dynamic routes ### What version of Next.js are you using?

10.2.2

### What version of Node.js are you using?

14.15

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

vercel

### Describe the Bug

I have a dynamic route in the following format:

/path/[type]

If i visit the following paths:
/path/custom1
/path/custom2

and then call router.back() from custom2 I get the following error message:

```log
Unhandled Runtime Error
Error: The provided `as` value (/path/custom1) is incompatible with the `href` value (/h/[type]). Read more: https://nextjs.org/docs/messages/incompatible-href-as
Call Stack
Router._callee$
node_modules/next/dist/next-server/lib/router/router.js (1055:16)
tryCatch
node_modules/regenerator-runtime/runtime.js (63:14)
Generator.invoke [as _invoke]
node_modules/regenerator-runtime/runtime.js (293:0)
Generator.eval [as next]
node_modules/regenerator-runtime/runtime.js (118:0)
asyncGeneratorStep
node_modules/@babel/runtime/helpers/asyncToGenerator.js (3:0)
_next
node_modules/@babel/runtime/helpers/asyncToGenerator.js (25:0)
```

I use my app with a basepath. It is happening only when I have a basepath. My next.config.js file is:

```js
module.exports = {
  basePath: ""/app"",
  future: {
    webpack5: true
  }
};
```

Given my application has lots of dynamic routes I'm unable to upgrade from 10.0 to 10.2.

### Expected Behavior

The page should be able to go back from /path/custom2 to /path/custom1

### To Reproduce

I have created a codesandbox with reproducable scenario:

https://znkfe.sse.codesandbox.io/app

If the buttons are followed, it will land on the issue.

Source: https://codesandbox.io/s/nextjs-routing-issue-znkfe?file=/pages/index.js",ijjk,kind: bug,2021-05-20T07:20:00Z,2021-05-26T07:58:06Z,DaniAkash,m235;TanDung2512;PaulSenon;balazsorban44,DaniAkash;ijjk,ijjk,ijjk,,,
vercel/next.js,25303,"Imported next-server modules are duplicated, causing duplicate react contexts ### What version of Next.js are you using?

10.2.1

### What version of Node.js are you using?

16.1.0

### What browser are you using?

Chrome and Safari

### What operating system are you using?

macOS

### How are you deploying your application?

None

### Describe the Bug

We use `@apollo/client` to execute some graphQL queries during SSR: we do this in getServerSideProps, and most importantly by rendering the component tree before nextjs actually renders it on the server. A simplified example of how this looks is below:

```typescript
export function getServerSideProps(ctx) {
  // ....
     await renderToStringWithData(
        <RouterContext.Provider value={router}>
          <ApolloProvider client={apolloClient}>
             <Page {...props} />
          </ApolloProvider>
        </RouterContext.Provider >
      )
  // ...
}
```

Most importantly, because we use `useRouter` and render different components based on `query`, we create a dummy next router and pass it into the router provider:

```typescript
  const router = {
    query: ctx.query
  }
```

The router context itself is imported like so:
```typescript
import { RouterContext } from 'next/dist/next-server/lib/router-context'
```

This worked fine up until 10.2.1, where now calls on the server to `useRouter` return `null`.
After doing some debugging it turns out this is caused by the two different `router-context` modules being imported: One in our app, and one in `next/router`.
So whenever `useRouter` calls `useContext`, it looks up a different `RouterContext` than the `RouterContext` we imported, and thus returns null.

Previously in 10.2.0 these imported modules were the same, and we believe the PR that caused this new behaviour is https://github.com/vercel/next.js/pull/24603

The difference between the generated webpack imports is that on 10.2.0, they look like this:

```javascript
/* harmony import */ var next_dist_next_server_lib_router_context__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! next/dist/next-server/lib/router-context */ ""next/dist/next-server/lib/router-context"");
```

But on 10.2.1 it now becomes:

```javascript
/* harmony import */
var next_dist_next_server_lib_router_context__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! next/dist/next-server/lib/router-context */
""./node_modules/next/dist/next-server/lib/router-context.js"");
```
`./node_modules` has been prefixed

`next/dist/client/router.js` imports the module as `require(""../next-server/lib/router-context"")`, so understandably webpack gives back two different modules, with two different contexts

### Expected Behavior

Importing modules from `next/dist/next-server/` should resolve to the same module as the modules used by next itself

### To Reproduce

https://github.com/bubba/next-webpack-import-bug.git",ijjk,kind: bug,2021-05-20T14:22:04Z,2021-05-28T11:17:09Z,bubba,ijjk;balazsorban44,bubba;ijjk,ijjk,ijjk,,timneutkens,
vercel/next.js,25353,"Router path query regression in next 10.2.2 ### What version of Next.js are you using?

10.2.2

### What version of Node.js are you using?

14.16.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

vercel, next dev

### Describe the Bug

When updating router query using 10.2.0 the url changes correctly (doesn't get duplicated productId)

10.2.0
https://codesandbox.io/s/routerquery-1020-w4t1r?file=/pages/product/%5BproductId%5D.js

10.2.2
https://codesandbox.io/s/routerquery-1022-qlywt?file=/pages/product/%5BproductId%5D.js

### Expected Behavior

When using dynamic routes, updating query using `router.replace({ query: { ...router.query, productId: uuid() } })` should change the path like in 10.2.0

### To Reproduce


10.2.0
https://codesandbox.io/s/routerquery-1020-w4t1r?file=/pages/product/%5BproductId%5D.js

10.2.2
https://codesandbox.io/s/routerquery-1022-qlywt?file=/pages/product/%5BproductId%5D.js

Open both sandboxes, click the ""Change productId"" button, and you will see:

10.2.0: path stays correct with only one productId in path: 
https://w4t1r.sse.codesandbox.io/product/0a61dff3-e58a-47f3-b38a-1915e4cc8247

10.2.2: query gets polluted with extra productId, doesn't match with dynamic route
https://qlywt.sse.codesandbox.io/product/8d4950a5-f6ca-4649-b5bb-debaf4618e22?productId=98b76b78-7bb7-49c8-b974-20ebd21dcc33

### More info

I think this broke in https://github.com/vercel/next.js/pull/24199
Both 10.2.1, 10.2.1-canary.2 and 10.2.2 does not work as expected",ijjk,kind: bug,2021-05-22T10:56:34Z,2021-05-28T12:51:41Z,albinekb,Gyllsdorff;balazsorban44,albinekb;ijjk,ijjk,ijjk,,timneutkens,
vercel/next.js,25431,"Webpack 5, API functions and Vercel error ### What version of Next.js are you using?

10.2.2

### What version of Node.js are you using?

14

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

**What is happening?**
As soon as we enable webpack5, some of our endpoints break.

**Which endpoints?** 
Those that share using a function that uses `fs.readFile`. If it's a single endpoint using that function, it works just fine. As soon as we add a second endpoint, they both break.

**What's the error?**
<img width=""1082"" alt=""Screen Shot 2021-05-22 at 12 00 20 AM"" src=""https://user-images.githubusercontent.com/5664/119417708-d5211f00-bccc-11eb-909d-b10d2c83c92a.png"">

**Where does this happen>?**
This **only happens on Vercel**, it works fine locally while doing `next build && next start`.

### Expected Behavior

We should be able to enable webpack5 and not have endpoints breaking under the description listed above.

### To Reproduce

Check it out [this repo](https://github.com/marbiano/next-webpack5-fs-bug). [Here are the two endpoints](https://github.com/marbiano/next-webpack5-fs-bug/tree/main/pages/api) sharing a single external function.

Also, we have Vercel deployments to verify:

- [Here's a deployment](https://next-webpack5-fs-bug-5xryadaxf.cosy.dev/api/hello) with a single endpoint where everything works just fine.
- [Here's a deployment](https://next-webpack5-fs-bug-6z42ka0re.cosy.dev/api/hello) with an extra endpoint where they break.
- [Here's the diff](https://github.com/marbiano/next-webpack5-fs-bug/commit/59c39cc49c72ce6161eead868340a628f2c5c0f2) between those two deployments, in order to fully verify the issue.",ijjk,kind: bug,2021-05-24T23:16:30Z,2021-09-01T15:56:04Z,marbiano,ijjk;marbiano;balazsorban44,marbiano;timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,25440,"Type '""fill""' is not assignable to type '""fixed"" | ""intrinsic"" | ""responsive"" | undefined'. ### What version of Next.js are you using?

10.2.3

### What version of Node.js are you using?

16.1.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

I am using a simple `next/image` component:

```js
import Image, { ImageProps } from 'next/image'

export const Img = ({ className = '', ...props }: ImageProps) => (
	<div className=""unset-img full-bleed"">
		<Image className={`${className} custom-img`} layout=""fill"" {...props} />
	</div>
)
```

I get red-squiggly lines on	`layout` saying:

> Type '""fill""' is not assignable to type '""fixed"" | ""intrinsic"" | ""responsive"" | undefined'.

### Expected Behavior

It shouldn't show a TS error.

### To Reproduce

Clone [this commit](https://github.com/deadcoder0904/better-code-blocks/commit/057fcce49fbdab9620840d775273c152745faede), install the dependencies & run the app. VSCode should yell.

The error is in [this file](https://github.com/deadcoder0904/better-code-blocks/blob/057fcce49fbdab9620840d775273c152745faede/src/components/mdx/Img.tsx). See `layout=""fill` there.",styfle,kind: bug,2021-05-25T10:28:11Z,2021-07-07T19:15:32Z,deadcoder0904,brandonchinn178;deadcoder0904;buzzysin;balazsorban44;kb1995;ycscholes,deadcoder0904;styfle,styfle,styfle,,,
vercel/next.js,25484,"`next dev` fails with webpack error when importing functions inside web worker ### What version of Next.js are you using?

10.2.3

### What version of Node.js are you using?

16.2.0

### What browser are you using?

Firefox

### What operating system are you using?

macOS

### How are you deploying your application?

next dev

### Describe the Bug

Using a web worker, similar to the [with-web-worker](https://github.com/vercel/next.js/tree/canary/examples/with-web-worker) example. The web worker file (located under `worker/search.js`) imports functions from another local file like this:
```js
import { getIndexRange, getTextItemWithNeighbors } from '../lib/search';
```
Which then results in the following error with Next.js >=10.2.1:
```
error - webpack/runtime/compat
The ""path"" argument must be of type string. Received undefined
```

I'm able to resolve this error by in-lining the functions directly in the web worker file (`worker/search.js`) instead of  importing them.

This issue appeared with [v10.2.1-canary.9](https://github.com/vercel/next.js/releases/tag/v10.2.1-canary.9), so probably introduced by https://github.com/vercel/next.js/pull/25035. It used to work before.

### Expected Behavior

I would like to be able to import the functions in the web worker file without an error, as it used to work in the past.

### To Reproduce

Honestly, it's pretty hard to reproduce this issue... I've tried to apply a similar structure as in my project to the [with-web-worker](https://github.com/vercel/next.js/tree/canary/examples/with-web-worker) example, but wasn't able to reproduce it.
Maybe @nemanja-tosic (https://github.com/vercel/next.js/issues/25276#issuecomment-847681082) has some clues about it...",sokra,kind: bug;type: needs investigation;area: Compiler,2021-05-26T08:31:31Z,2022-02-07T13:54:10Z,paescuj,nemanja-tosic;mdirolf;Qeldrona;lagz0ne;alirezavlz;ColmanHumphrey;dontsave;njarraud;eschaefer;yakovenkoroman1993;talaikis;andreypopp;balazsorban44;rauchg;timneutkens,paescuj;timneutkens,timneutkens,sokra,,balazsorban44,
vercel/next.js,25548,"eslint rule no-document-import-in-page does not respect `pageExtensions` ### What version of Next.js are you using?

10.2.3

### What version of Node.js are you using?

14.17.0

### What browser are you using?

Firefox

### What operating system are you using?

Ubuntu

### How are you deploying your application?

-

### Describe the Bug

when setting `pageExtensions` in `next.config.js` to e.g. `page.tsx`, the ""no-document-import-in-page"" rule included in `eslint-plugin-next` falsely warns that ""next/document should not be imported outside of pages/_document.js.""

### Expected Behavior

eslint rule should respect `pageExtensions`

### To Reproduce

- create next project with `yarn create next-app --typescript` and enable eslint
- add `pageExtensions: [""page.tsx""]` to `next.config.js`
- add `pages/_document.page.tsx` and see error",housseindjirdeh,kind: bug,2021-05-28T10:32:00Z,2021-06-07T11:15:00Z,stefanprobst,pacexy;balazsorban44,stefanprobst;timneutkens,timneutkens,timneutkens,,stefanprobst,
vercel/next.js,2573,"Error component rendered 2 times when server rendering in production ## Expected Behavior
1 error component is rendered

## Current Behavior
2 error components are rendered below eachother. 1 through SSR and 1 through client side rendering.

## Steps to Reproduce (for bugs)
```jsx
import Link from 'next/link'

export default class extends React.Component {
  static async getInitialProps() {
   // Just throw an error in getInitialProps
    throw new Error('test');
  }
  render() {
    return (
      <div>
        <h1>Hello world</h1>
      </div>
    )
  }
}
```

## Context
Issue can be seen here: https://create-next-example-app-olyuogqcxe.now.sh/ (deployment with the above code). Scroll down cause the component itself is screen filling 棣冩 

@harshmaur surfaced this.

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    |    2.x+ (so beta too)     |
| mode | production |
",arunoda,kind: bug,2017-07-16T14:42:37Z,2017-10-21T23:47:56Z,timneutkens,stevegeek;coluccini;kochis,timneutkens,,timneutkens,,rauchg,
vercel/next.js,25790,"Next.js i18n routing generates api routes for each locale in Vercel ### What version of Next.js are you using?

10.2.0

### What version of Node.js are you using?

v14.17.0

### What browser are you using?

firefox / chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

When using internationalization config, Next.js api route serverless function are generated by Vercel with locale prefixes.

For example, if you have three locales in your `next.config.js` of 'en', 'fr', and 'de', a single api route `/api/hello` will generate:
 - `en/api/hello`
 - `fr/api/hello`
 - `de/api/hello`

This causes issues calling api routes in more complicated applications.

### Expected Behavior

No matter what your localization configurations are, your api routes will deploy with exactly the paths you define.
Does not make sense for api routes to be localized.

### To Reproduce

This boilerplate was created with `create-next-app`: https://github.com/sharad-s/next-i18n

This repo has 3 commits on it.
Deploy the first or second commit to vercel, and you will see an api route function of just `/api/hello`:

![image](https://user-images.githubusercontent.com/8727763/120848654-aa3f9200-c53a-11eb-8b18-907917038ad1.png)


Once you deploy the third commit, which only makes a change to `next.config.js`, you will see three localized serverless functions for your single api route:

![](https://cdn.discordapp.com/attachments/848835365505990667/849766962242650112/unknown.png)
![](https://cdn.discordapp.com/attachments/848835365505990667/849766843165048853/unknown.png)


",ijjk,kind: bug;type: needs investigation,2021-06-04T18:51:27Z,2021-06-28T13:56:40Z,sharad-s,dmitrykozyrenko;oscar-gallog;balazsorban44;ijjk;sharad-s,sharad-s;timneutkens,timneutkens,timneutkens,,,
vercel/next.js,26127,"Parsing error: Cannot find module 'next/babel' ### What version of Next.js are you using?

11.0.0

### What version of Node.js are you using?

14.0.0

### What browser are you using?

Safari

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

every file underlines imports and aslant gives me this message: Parsing error: Cannot find module 'next/babel'

### Expected Behavior

nextjs 10 didn't show this message

### To Reproduce

just import something into any file in nextjs 11",housseindjirdeh,kind: bug,2021-06-15T16:48:09Z,2021-07-15T18:28:48Z,JoseGarciaM,cromosom;timneutkens;housseindjirdeh;rochdev;balazsorban44;BenjaminWFox;lgh06;DuaneMcD,JoseGarciaM;timneutkens,timneutkens,timneutkens,,housseindjirdeh,
vercel/next.js,26130,"SVGR fails to load SVGs with Next 11 # **UPDATE**

## A temporary solution that seems to work and does not disable Webpack 5
If you find any issues with this solution, please tag me @scottagirs to update as appropriate.
By @dohomi

```javascript
  webpack (config) {
    const fileLoaderRule = config.module.rules.find(rule => rule.test && rule.test.test('.svg'))
    fileLoaderRule.exclude = /\.svg$/
    config.module.rules.push({
      test: /\.svg$/,
      loader: require.resolve('@svgr/webpack')
    })
    return config
  }
```
--- 
### What version of Next.js are you using?

Next 11.0.0

### What version of Node.js are you using?

14.x

### What browser are you using?

Chrome, Brave

### What operating system are you using?

macOS 11.4

### How are you deploying your application?

localhost atm

### Describe the Bug

https://discord.com/channels/752553802359505017/752668543891276009/854396809497673788

After upgrading from 10.x Next.js with webpack 4 config, to Nextjs 11, application fails to build with the below errors:
```
error - ./icon.svg
TypeError: unsupported file type: undefined (file: undefined)
```
<img width=""1115"" alt=""Screen Shot 2021-06-15 at 1 12 25 PM"" src=""https://user-images.githubusercontent.com/11737572/122095419-59058d00-cddb-11eb-9ede-4bbe175ac33e.png"">

## Full stack trace when trying to load the app (open in browser tab)
<details><summary><span>----- Expand to view -----</span></summary>
<pre>
Error: Cannot find module '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/.next/server/pages-manifest.json'
Require stack:
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/require.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/load-components.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/api-utils.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/next-server.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/server/next.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/server/lib/start-server.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/cli/next-dev.js
- /Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/bin/next
    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:880:15)
    at Function.mod._resolveFilename (/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/build/webpack/require-hook.js:4:1855)
    at Function.Module._load (internal/modules/cjs/loader.js:725:27)
    at Module.require (internal/modules/cjs/loader.js:952:19)
    at require (internal/modules/cjs/helpers.js:88:18)
    at getPagePath (/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/require.js:1:735)
    at requirePage (/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/require.js:1:1397)
    at loadComponents (/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/load-components.js:1:1289)
    at DevServer.findPageComponents (/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/next-server.js:77:296)
    at DevServer.renderErrorToHTML (/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/next-server.js:139:209) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/require.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/load-components.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/api-utils.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/next-server/server/next-server.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/server/next.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/server/lib/start-server.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/cli/next-dev.js',
    '/Users/scottagirs/workspace/iJS/ijs.to/iJStoFE/node_modules/next/dist/bin/next'
  ]
}
</pre>
</details>

### To Reproduce

Upgrade to Next 11 and add `next.config.js`

```javascript
module.exports = {
  webpack(config, options) {
    config.module.rules.push({
      test: /\.svg$/,
      use: ['@svgr/webpack'],
    });

    return config;
  },
};
```

in `package.json`
```
""@svgr/webpack"": ""^5.5.0"",
""next"": ""^11.0.0"",
""react"": ""^17.0.2"",
""react-dom"": ""^17.0.2"",
```",styfle,kind: bug,2021-06-15T17:16:26Z,2021-06-18T00:40:23Z,ScottAgirs,sambecker;dreamer01;njmh;passionkind;mohux;jakeherp;kylemh;dohomi;kevinseabourne;ScottAgirs;kripod;arcataroger;styfle;Pipe-Runner;schoenwaldnils;Klohto;Vsion;FDiskas;ilchoTaleski;mxmtsk;chozzz,ScottAgirs,,,,,
vercel/next.js,26155,"`next lint` does not work with `src` directory ### What version of Next.js are you using?

11

### What version of Node.js are you using?

16.3

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

If you run `next lint` when storing your code in a `src` directory, the CLI complains that there is no `/components` directory.

This also means that `next build` fails when using the ESLint config.

```
> site@1.6.0 build
> next build

info  - Using webpack 5. Reason: Enabled by default https://nextjs.org/docs/messages/webpack5
info  - Checking validity of types

> Build error occurred
Error: No files matching '/Users/blp/Sites/site/components' were found.
    at FileEnumerator.iterateFiles (/Users/blp/Sites/site/node_modules/eslint/lib/cli-engine/file-enumerator.js:317:27)
    at iterateFiles.next (<anonymous>)
    at CLIEngine.executeOnFiles (/Users/blp/Sites/site/node_modules/eslint/lib/cli-engine/cli-engine.js:765:48)
    at ESLint.lintFiles (/Users/blp/Sites/site/node_modules/eslint/lib/eslint/eslint.js:530:23)
    at lint (/Users/blp/Sites/site/node_modules/next/dist/lib/eslint/runLintCheck.js:2:1752)
    at async Object.runLintCheck (/Users/blp/Sites/site/node_modules/next/dist/lib/eslint/runLintCheck.js:8:8) {
  type: 'NoFilesFoundError',
  messageTemplate: 'file-not-found',
  messageData: { pattern: '/Users/blp/Sites/site/components', globDisabled: false }
}
```


### Expected Behavior

`next lint` should look inside a `src` directory.

### To Reproduce

Create a Next project, move source code into a `src` directory, and run `npx next lint`.",housseindjirdeh,kind: bug,2021-06-16T01:02:35Z,2021-07-16T18:19:08Z,brandonpittman,vasco3;brandonpittman;ranisalt;n3oney;timneutkens;housseindjirdeh;ijjk;balazsorban44,brandonpittman;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,26160,"When using TypeScript, custom font warnings incorrect ### What version of Next.js are you using?

11.0.0

### What version of Node.js are you using?

12.18.3

### What browser are you using?

Chrome

### What operating system are you using?

ChromeOS (SSH into Ubuntu 20.04 on AWS EC2)

### How are you deploying your application?

Vercel

### Describe the Bug

When adding custom fonts to a TypeScript custom document (in `pages/_document.tsx`), the Next.js ESLint rules still give the following warning:

```
./pages/_document.tsx
17:11  Warning: Custom fonts not added at the document level will only load for a single page. This is discouraged. See https://nextjs.org/docs/messages/no-page-custom-font.
```

### Expected Behavior

There should be no warning. I am doing what [is asked](https://nextjs.org/docs/messages/no-page-custom-font) and have added the custom font to my custom document (which, because I'm using TypeScript, happens to be located at `pages/_document.tsx` instead of `pages/_document.js` which is where I'm guessing it's assuming it's be located).

### To Reproduce

1. Run `yarn create next-app --template typescript` (i.e. create a new TypeScript Next.js app).
2. Create a custom `pages/_document.tsx` with the following:

```tsx
import NextDocument, { Head, Html, Main, NextScript } from 'next/document';

// Prevent FOUC on Firefox due to an age-old script processing bug.
// @see {@link https://nextjs.org/docs/advanced-features/custom-document}
// @see {@link https://github.com/vercel/next.js/issues/22465}

// Also, address the Next.js ESLint warning about custom fonts not here.
// @see {@link https://nextjs.org/docs/messages/no-page-custom-font}
export default class Document extends NextDocument {
  public render(): JSX.Element {
    return (
      <Html>
        <Head>
          <meta charSet='UTF-8' />
          <meta name='viewport' content='width=device-width,initial-scale=1.0' />
          <link rel='preconnect' href='https://fonts.gstatic.com' />
          <link
            href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=optional'
            rel='stylesheet'
          />
        </Head>
        <body>
          <script>0</script>
          <Main />
          <NextScript />
        </body>
      </Html>
    );
  }
}
```
3. Run `yarn next lint` (or `yarn eslint`).
4. See invalid warning message.

You can also try cloning [this repository](https://github.com/nicholaschiang/saintmichaeltrio) as it's the one I'm having issues with.",housseindjirdeh,kind: bug,2021-06-16T03:49:12Z,2021-08-05T00:58:07Z,nicholaschiang,botond-veress;housseindjirdeh;nicholaschiang;SSylvain1989;balazsorban44,nicholaschiang;timneutkens,timneutkens,housseindjirdeh,,,
vercel/next.js,26309,"Blurred image not positioned correctly when using object-position ### What version of Next.js are you using?

11.0.0

### What version of Node.js are you using?

14.13.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

Blurred images are not respecting the objectPosition property in Image component

Full image: [Example Image](https://i.schoen.world/cVAqU.png)


**What I see:** 
![](https://i.schoen.world/g6CeV.png)

### Expected Behavior

The blurred placeholder should have the save position as the the later loaded full image.

**What I expect:**

![](https://i.schoen.world/6ctkR.png)

An easy fix for this would be to mirror the `object-position` value to the `background-position` value while loading.

### To Reproduce

Setup:

```jsx
import Image from 'next/image'

import exampleImg from '../data/example.png'

const Page = () => (
  <Image
    src={exampleImg}
    width={1024}
    height={700}
    layout=""responsive""
    objectFit=""cover""
    objectPosition=""center""
    placeholder=""blur""
  />
)

export default Page
```

Deployed example: [schoenwaldnils.vercel.app/objectPositionIssue](https://schoen-world-8793xnvzh-schoenwaldnils.vercel.app/objectPositionIssue)",styfle,kind: bug,2021-06-18T13:07:39Z,2021-06-30T21:58:27Z,schoenwaldnils,styfle;DarkCode01;schoenwaldnils;balazsorban44,schoenwaldnils;styfle,styfle,styfle,,,
vercel/next.js,26348,"Next should not require that eslint-config-next be installed separately ### What version of Next.js are you using?

11.0.0

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

`next build` fails when eslint-config-next isn't installed

### Expected Behavior

If Next wants to require eslint-config-next be installed to successfully build a project then it should be listed as a dependency of Next itself. If eslint-config-next is not installed Next should still be able to successfully build a project, and it should not require that you manually specify `eslint.ignoreDuringBuilds` in your next.config.js.

It's incredibly confusing that Next will now *always* fail to build in it's default configuration, where this has never been an issue in any previous versions.

### To Reproduce

Upgrade to Next 11 without installing eslint-config-next",housseindjirdeh,kind: bug,2021-06-19T01:23:57Z,2021-08-04T21:53:15Z,aslilac,mikestopcontinues;housseindjirdeh;aslilac;tw0517tw;stefanprobst;balazsorban44,aslilac;timneutkens,timneutkens,housseindjirdeh,,,
vercel/next.js,26406,"Error with ESLint in Next 11 ""Parsing error: Cannot find module 'next/babel'"" ### What version of Next.js are you using?

11

### What version of Node.js are you using?

12.21.0

### What browser are you using?

FireFox

### What operating system are you using?

Linux (Kubuntu/Ubuntu)

### How are you deploying your application?

none

### Describe the Bug

Whenever I have the `.eslintrc` file in my project I receive the error below. However, if I run `npm run lint` as it says in the [docs](https://nextjs.org/docs/basic-features/eslint), it shows that there aren't any issues.
```
File is a CommonJS module; it may be converted to an ES6 module.ts(80001)
Parsing error: Cannot find module 'next/babel'
Require stack:
- /home/dark/Documents/Projects/typescript-test/node_modules/next/dist/compiled/babel/bundle.js
- /home/dark/Documents/Projects/typescript-test/node_modules/next/dist/compiled/babel/eslint-parser.js
- /home/dark/Documents/Projects/typescript-test/node_modules/eslint-config-next/parser.js
- /home/dark/Documents/Projects/typescript-test/node_modules/@eslint/eslintrc/lib/config-array-factory.js
- /home/dark/Documents/Projects/typescript-test/node_modules/@eslint/eslintrc/lib/index.js
- /home/dark/Documents/Projects/typescript-test/node_modules/eslint/lib/cli-engine/cli-engine.js
- /home/dark/Documents/Projects/typescript-test/node_modules/eslint/lib/cli-engine/index.js
- /home/dark/Documents/Projects/typescript-test/node_modules/eslint/lib/api.js
- /home/dark/.vscode/extensions/dbaeumer.vscode-eslint-2.1.23/server/out/eslintServer.jseslint
module export=
(property) export=: {
    reactStrictMode: boolean;
}
```

### Expected Behavior

There should be no linting error.

### To Reproduce

Just having the `.eslintrc` with the default configurations.",housseindjirdeh,kind: bug,2021-06-21T07:39:31Z,2021-06-30T20:27:49Z,adriandelgg,housseindjirdeh;baufometic;balazsorban44,adriandelgg;timneutkens,timneutkens,housseindjirdeh,,housseindjirdeh,vercel/next.js#26541;
vercel/next.js,26531,"ImageProps type are not assignable to next/image ### What version of Next.js are you using?

11.0.0

### What version of Node.js are you using?

16.0.0

### What browser are you using?

Firefox

### What operating system are you using?

Arch Linux

### How are you deploying your application?

Vercel

### Describe the Bug

I made an Image component with `chakra-ui` Box as a wrapper for `next/image`. When I try to assign the props type, it gives me a TypeScript type error:

> Type '{ objectFit: ""cover""; layout: ""fill""; src: string | StaticImport; alt: string | undefined; }' is not assignable to type 'IntrinsicAttributes & ImageProps'.

`@chakra-ui/react` version: 1.6.3

### Expected Behavior

No type error.

### To Reproduce

Here's the component:

```ts
import { Box, BoxProps } from '@chakra-ui/react'
import NextImage, { ImageProps } from 'next/image'

export type NextChakraImageProps = Omit<BoxProps, 'as'> & ImageProps

export function NextChakraImage({ src, alt, ...rest }: NextChakraImageProps) {
	return (
		<Box {...rest}>
			<NextImage objectFit=""cover"" layout=""fill"" src={src} alt={alt} />
		</Box>
	)
}
```",styfle,kind: bug,2021-06-23T15:18:34Z,2021-07-07T19:15:32Z,vinicius507,Clee681;deadcoder0904;styfle;vinicius507;balazsorban44,vinicius507;timneutkens,timneutkens;styfle,timneutkens;styfle,styfle,,vercel/next.js#25440;
vercel/next.js,26534,"Place 'charset' meta element at the top of <head> ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

16.3.0

### What browser are you using?

Edge, Firefox

### What operating system are you using?

macOs Big Sur

### How are you deploying your application?

still on local environment

### Describe the Bug

I would like to re-address this issue [ #3210](https://github.com/vercel/next.js/issues/3210), since it has been locked as resolved.

When adding a web font to a custom `_document.js`, the web font (e.g. `<link href=""https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"" rel=""stylesheet"" />`) is placed at the top of `<head>` before `<meta charset=""utf-8"">`. 

![Screenshot 2021-06-23 at 22 15 42](https://user-images.githubusercontent.com/11626164/123122855-8fdd4200-d470-11eb-9370-36d65c4df54f.png)

Also, it seems that  manually adding `<meta charset=""utf-8"">` before the web font would result in duplication (which has been addressed in [#9794](https://github.com/vercel/next.js/issues/9794), and is also an open issue [#17085](https://github.com/vercel/next.js/issues/17085)). 

### Expected Behavior

`<meta charset=""utf-8"">` should be the first thing in `<head>` (referring to this [hint](https://webhint.io/docs/user-guide/hints/hint-meta-charset-utf-8)).

### To Reproduce

By adding a web font to custom `_document.js`, as provided on the [Font Optimization](https://nextjs.org/docs/basic-features/font-optimization)  documentation.

```
import Document, {Html, Head, Main, NextScript} from 'next/document';

class CustomDocument extends Document {
  static async getInitialProps(ctx) {
    const initialProps = await Document.getInitialProps(ctx);
    return {...initialProps};
  }

  render() {
    return (
      <Html>
        <Head>
          <link
            href=""https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap""
            rel=""stylesheet""
          />
        </Head>
        <body>
          <Main />
          <NextScript />
        </body>
      </Html>
    );
  }
}

export default CustomDocument;
```
",janicklas-ralph,kind: bug;area: next/head / head.js,2021-06-23T15:32:38Z,2022-02-06T19:51:51Z,amarangganar,kotx;eubyt;radeno;ijjk,amarangganar;timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,26541,"Cannot find module 'next/babel' when ""next"" in .eslintrc ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

Windows 10

### How are you deploying your application?

next start

### Describe the Bug

I just updated Nextjs from v10.2.0 to 11.0.1. When I include ""next"" in my .eslintrc file (see ""To reproduce"" snippet below), every single file that ESLint is monitoring shows an error on line 1 stating ""Parsing error: Cannot find module 'next/babel'"".

This error blocks all other real ESLint errors so until I get this sorted out, I have to add ""next"" to my .eslintrc file, run `npm run lint` to get the proper output in the CLI and then remove ""next"" right before I commit my code. Not ideal.

I should also mention that I already had ESLint installed and configured prior to the changes Next v11 introduced.

And the error message:
![image](https://user-images.githubusercontent.com/14049283/123147615-7dd1b400-d41c-11eb-9724-b90aee1a8e4b.png)



### Expected Behavior

I expect to see only actual ESLint errors appearing in my files.

### To Reproduce

Add ""next"" to the .eslintrc file:

```
{
  ...
  ""extends"": [""plugin:react/recommended"", ""airbnb"", ""next"", ""prettier""],
  ...
}
```",housseindjirdeh,kind: bug,2021-06-23T18:18:34Z,2021-06-28T20:51:41Z,fated-x,anthonyshew;housseindjirdeh;balazsorban44,fated-x;timneutkens,timneutkens,timneutkens,,housseindjirdeh,vercel/next.js#26406;
vercel/next.js,26574,"Generic build error when updating from 10.2.4-canary.2 to any version above ### What version of Next.js are you using?

10.2.4-canary.3

### What version of Node.js are you using?

14.16.1

### What browser are you using?

Chrome

### What operating system are you using?

MacOs & Windows

### How are you deploying your application?

next start

### Describe the Bug

When using 10.2.4-canary.2 or earlier versions building works fine, but when upgrading to 10.2.4-canary.3 or any version above I get this very anonymously error. It do however work to start in dev

`

    yarn build                        
    yarn run v1.22.10
    $ next build
    info  - Loaded env from /Users/user/Desktop/dashboard/.env.local
    info  - Using webpack 4. Reason: custom webpack configuration in next.config.js https://nextjs.org/docs/messages/webpack5
    NODE ENV: production
    info  - Checking validity of types  
    To use ESLint, additional required package(s) must be installed.
    
    Please install eslint-config-next by running:
    
            yarn add --dev eslint-config-next
    
    If you do not want to run ESLint during builds, run next build --no-lint or remove the .eslintrc.json file from your package root.
    
    error Command failed with exit code 1.
    info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.

`

This is happening in two separate projects and I have tried building them on both macOs and Windows, but dont even know where to start debugging with this very generic build error.

Does anyone have a clue of what could be causing this? I've narrowed it down to 10.2.4-canary.3

Lord please..!

### Expected Behavior

Should be able to build project with never version than 10.2.4-canary.2

### To Reproduce

Update to 10.2.4-canary.3 and try to build",housseindjirdeh,kind: bug;type: needs investigation,2021-06-24T14:40:36Z,2021-06-25T20:26:09Z,huggge,PythonCreator27;housseindjirdeh;huggge;balazsorban44,huggge;timneutkens,timneutkens,timneutkens,,housseindjirdeh,
vercel/next.js,26587,"next/image serves unoptimized local image with max-age=0 ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

14.17.1

### What browser are you using?

Chrome, Safari

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

Next/image serves local images with max-age=0 when using ""unoptimized"" flag.

```
import image2 from ""../public/image2.png"";
...
<Image src={image2} width={730} height={300} layout=""fixed"" unoptimized  />
```

This image is served with `Cache-Control: public, max-age=0` header, which forces browsers to revalidate the image every time they load a page.

In comparison an optimized image is served with `Cache-Control: public, max-age=315360000, immutable` header.

### Expected Behavior

Cache-control header for ""unoptimized"" images should be no different from the optimized ones since image content is hashed and the image is assigned a unique name.

### To Reproduce

Here is the code sandbox demonstrating this issue - https://codesandbox.io/s/nextjs-unoptimized-image-0svlt",styfle,kind: bug,2021-06-24T22:49:39Z,2021-07-01T22:14:43Z,igordanchenko,styfle;balazsorban44,igordanchenko;timneutkens,timneutkens;styfle,timneutkens;styfle,styfle,,
vercel/next.js,26591,"next/script - Can't get Google Analytics inline script to load `beforeInteractive` - before close of <head> tag ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

10.23.0

### What browser are you using?

Chrome, Firefox

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

I've just upgraded to Next.js v11.0.1 and trying out the <Script> component.

I'm trying to add the Google Analytics tag as they suggest; before the closing <head> tag using `strategy=""beforeInteractive""`.

Here is my code for the `index.tsx` page

```
const Home: React.FC<Props> = ({ data }) => {
  return (
    <>
      <Script
        src=""https://www.googletagmanager.com/gtag/js?id=[TRACKING-ID]""
        strategy=""beforeInteractive""
      />
      <Script
        dangerouslySetInnerHTML={{
          __html: `window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '[TRACKING-ID]');`,
        }}
        strategy=""beforeInteractive""
      />
      <ThemeProvider theme={fullySickTheme}>
        <Head>
          <title>My Site</title>
        </Head>
...
```

The first <Script> with the `https://www.googletagmanager.com/gtag...` loads in the <head> but the script doesn't load at all.

The only way I can load it is at the bottom of the document using the default `afterInteractive` or `lazyOnload`.

Is this by design?
Should I just let the inline portion load before the ending body tag and be done with it? I'm only trying to follow what Google recommends in GA.

I've tried the following:

1. In a `page.tsx` file and in `_app.tsx` (docs say NOT to use `_document.tsx`)
2. Tried loading inline script with `dangerouslySetInnerHTML{{}}` and also adding the inline script to a custom function [and loading it that way](https://nextjs.org/docs/basic-features/script#inline-scripts), ala `dangerouslySetInnerHTML={setGoogleTags(stationGA)}` and `{window.dataLayer = window.dataLayer || [];...}`

### Expected Behavior

`beforeInteractive` adding my inline script inside the <head> tags.

### To Reproduce

1. Spin up a Next.js v11 site
2. In the index.js or index.tsx page, add the following.

```
import Script from ""next/script"";

// Then in the page's component

<Script
  src=""https://www.googletagmanager.com/gtag/js?id=[TRACKING-ID]""
  strategy=""beforeInteractive""
/>
<Script
  dangerouslySetInnerHTML={{
  __html: `window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '[TRACKING-ID]');`,
  }}
  strategy=""beforeInteractive""
 />
```

## Actual result

No inline script renders at all until you remove `strategy=""beforeInteractive""`",janicklas-ralph,kind: bug;type: needs investigation;area: next/script,2021-06-25T07:12:41Z,2022-04-29T15:20:32Z,simon-olsen,LetItRock;simon-olsen;lxsmnsyc;wedneyyuri;janicklas-ralph;vinitgundeti,simon-olsen;timneutkens,timneutkens,timneutkens,,,
vercel/next.js,26607,"Static Image Imports Places Duplicate Images In .next\server\chunks Folder ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

v14.15.4

### What browser are you using?

Brave

### What operating system are you using?

Windows 10

### How are you deploying your application?

Vercel

### Describe the Bug

When using static image imports on pages that are rendered using Server or SSG, for images that are located in the components directory, the image assets are placed in two locations:

   * Server: `.next\server\chunks\static\image\components\...`
   * Static: `.next\static\image\components\...`

For sites with lots of image imports on pages that are SSG or Server rendered, this can result in `.next/server/chunks` getting very large and for platforms like `Vercel`, builds will fail as the chunks director is greater then 50MB Compressed or 250MB Uncompressed. 

### Expected Behavior

Image assets should only be placed in the static folder as `next/image` does not reference images in the server location. 

### To Reproduce

- Create a Next.JS Project
- Create a component in the `./components` folder
- Add an image in that same folder
- In the newly created component, add `next/image` component and reference the image you just added
- build the project


Example Component

```
import * as React from ""react"";
import NextImage from ""next/image"";
import quarry from ""./quarry.png"";

export type DuplicatorProps = {
  id: string;
};

const Duplicator: React.FC<DuplicatorProps> = (props) => {
  return (
    <div>
      <h1>Hello {props.id}</h1>
      <NextImage src={quarry} width={100} height={100} />
    </div>
  );
};

export default Duplicator;
```

Folder Structure of Components & Image Assets:
![image](https://user-images.githubusercontent.com/1762141/123429334-d75cee80-d594-11eb-9301-63fc9b94e093.png)

Example Output
Static Location
![image](https://user-images.githubusercontent.com/1762141/123429722-44708400-d595-11eb-93c1-b1075ae88303.png)

Server Location
![image](https://user-images.githubusercontent.com/1762141/123429792-5baf7180-d595-11eb-967f-51198e890e6f.png)
",atcastle,kind: bug;type: needs investigation,2021-06-25T13:13:51Z,2021-07-02T11:27:32Z,JoeRall,JoeRall;balazsorban44,JoeRall;timneutkens,timneutkens,timneutkens,,,
vercel/next.js,26737,"Image filename/title is not dynamic when using Next/Image and external URLs ### What version of Next.js are you using?

10.2.0

### What version of Node.js are you using?

14.15.5

### What browser are you using?

Chrome/Brave

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel, next start

### Describe the Bug

When attempting to right-click download an image using Next/Image that is hosted outside of the static folder (i.e. a CMS), the title of the image is set to `image` for all images.

### Expected Behavior

Images should right-click download with the name of the image, like locally hosted static images do.

### To Reproduce

1. create a new image using Next/Image 
2. use an externally hosted image src
3. right-click download, the save as filename/title will read `image`",styfle,kind: bug,2021-06-29T21:11:30Z,2021-07-27T23:22:49Z,JarrodMFlesch,LetItRock;styfle;balazsorban44,JarrodMFlesch;styfle,styfle,styfle,,,
vercel/next.js,26781,"Not able to load jquery using the Script component with the 3 strategies ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

Using the `Script` component to load jquery trying all the 3 strategies doesn't seem to work, so I used the native script tag.

```
<Script strategy=""beforeInteractive"" src=""https://code.jquery.com/jquery-3.6.0.min.js"" />
```

### Expected Behavior

It should have loaded jquery and should work fine

### To Reproduce

Try to load jquery and use the `window.$()` function somewhere in your app",janicklas-ralph,kind: bug,2021-06-30T22:00:30Z,2021-09-24T09:14:42Z,smakosh,janicklas-ralph;jacklimwenjie;smakosh;balazsorban44,smakosh;timneutkens,timneutkens,timneutkens,,smakosh,
vercel/next.js,26868,"Build Fails on Vercel ### What version of Next.js are you using?

11.0.2-canary.4

### What version of Node.js are you using?

14

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

After updating to lastest Canary version which got a core change [26734](https://github.com/vercel/next.js/pull/26734) 

i got this error on vercel 
Cannot find module 'next/dist/next-server/server/next-server' Require stack: - /vercel/path0/noop.js 

<img width=""333"" alt=""CleanShot 2021-07-02 at 14 20 19@2x"" src=""https://user-images.githubusercontent.com/43112535/124267229-a8202180-db40-11eb-94fd-cf9c70d390be.png"">


### Expected Behavior

It should build my site

### To Reproduce

Update next to 11.0.2-canary.4 then deploy on vercel",styfle,kind: bug,2021-07-02T11:21:13Z,2021-07-02T15:23:20Z,mzaien,styfle;mzaien;timneutkens;balazsorban44,mzaien;styfle,styfle,styfle,,styfle,
vercel/next.js,26892,"[typescript] Next.js ImageProps giving errors after updating to Next.js v11.0.1 ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

14.17.0

### What browser are you using?

Firefox, Chrome

### What operating system are you using?

Windows

### How are you deploying your application?

Vercel

### Describe the Bug

I created a component and used `next/image` inside it, also I created a new type based on the `ImageProps` from next/image and used that type for my component props type.
Then the ts compiler gave me the following errors:
```
Type '{ key?: Key | null | undefined; alt?: string | undefined; crossOrigin?: """" | ""anonymous"" | ""use-credentials"" | undefined; decoding?: ""async"" | ""auto"" | ""sync"" | undefined; referrerPolicy?: HTMLAttributeReferrerPolicy | undefined; ... 266 more ...; src: string | StaticImport; } | { ...; } | { ...; } | { ...; } | { .....' is not assignable to type 'IntrinsicAttributes & ImageProps'.
  Type '{ key?: Key | null | undefined; alt?: string | undefined; crossOrigin?: """" | ""anonymous"" | ""use-credentials"" | undefined; decoding?: ""async"" | ""auto"" | ""sync"" | undefined; referrerPolicy?: HTMLAttributeReferrerPolicy | undefined; ... 266 more ...; src: string | StaticImport; }' is not assignable to type 'IntrinsicAttributes & ImageProps'.
    Type '{ key?: Key | null | undefined; alt?: string | undefined; crossOrigin?: """" | ""anonymous"" | ""use-credentials"" | undefined; decoding?: ""async"" | ""auto"" | ""sync"" | undefined; referrerPolicy?: HTMLAttributeReferrerPolicy | undefined; ... 266 more ...; src: string | StaticImport; }' is not assignable to type 'ObjectImageProps'.
      Types of property 'src' are incompatible.
        Type 'string | StaticImport' is not assignable to type 'StaticImport'.
          Type 'string' is not assignable to type 'StaticImport'.ts(2322)
```
However, it used to work with next.js version 10.2.3.

### Expected Behavior

TS compiler should not give errors.

### To Reproduce

Here's the full code to my component:

```
import NextImage, { ImageProps } from ""next/image"";

import { useState } from ""react"";

type FadeImageProps = ImageProps & {
    fallbackSrc?: string;
};

const FadeImage = ({
    fallbackSrc = ""/media/placeholder/350x300.jpg"",
    src,
    ...props
}: FadeImageProps) => {
    const [ready, setReady] = useState(false);
    const [imgSrc, setImgSrc] = useState(false);
    const [oldSrc, setOldSrc] = useState(src);
    if (oldSrc !== src) {
        setImgSrc(false);
        setOldSrc(src);
    }
    return (
        <div
            style={{
                opacity: ready ? 1 : 0,
                transition: ""opacity .3s ease-in-out"",
            }}
        >
            <NextImage
                src={imgSrc ? fallbackSrc : src}
                onError={() => {
                    setImgSrc(true);
                }}
                onLoad={(event) => {
                    event.persist();
                    event.currentTarget.srcset && setReady(true);
                }}
                {...props}
            />
        </div>
    );
};

export default FadeImage;
```",styfle,kind: bug,2021-07-03T07:18:44Z,2021-07-07T21:31:31Z,MohammadxAli,balazsorban44,MohammadxAli;styfle,styfle,styfle,,,
vercel/next.js,26902,"CSS with duplicate variables is minified unsafely ### What version of Next.js are you using?

11.0.0

### What version of Node.js are you using?

15

### What browser are you using?

N/A

### What operating system are you using?

macOS

### How are you deploying your application?

N/A

### Describe the Bug

Given this CSS input:

```css
.a {
  --var-1: 0;
  --var-2: 0;
  --var-1: -50%;
  --var-2: -50%;
}

.b {
  --var-1: 0;
  --var-2: 0;
  --var-2: -50%;
}
```

...when the CSS is minified for production, the output is incorrect (pretty printed so easier to read): 

```css
.a {
  --var-2: 0;
  --var-1: -50%;
  --var-2: -50%;
}
.a,
.b {
  --var-1: 0;
}
.b {
  --var-2: 0;
  --var-2: -50%;
}
```

The `--var-1` variable ends up being `0` for `.a` when it should be `-50%`.

### Expected Behavior

The output should look more like this:

```css
.a {
  --var-1: 0;
  --var-2: 0;
  --var-1: -50%;
  --var-2: -50%;
}
.b {
  --var-1: 0;
  --var-2: 0;
  --var-2: -50%;
}
```

This is what cssnano produces when using cssnano directly rather than through Next.

### To Reproduce

1. Clone this repository: https://github.com/adamwathan/next-css-minification-bug
2. Run `yarn build`
3. Inspect the output CSS, see it's incorrect

This is the underlying problem behind this bug reported on the Tailwind CSS repo: https://github.com/tailwindlabs/tailwindcss/issues/4755

We may be able to work around it on our side by trying to produce slightly different output that avoids this bug but ideally it would get fixed here 閳 hoping it's just a matter of using an outdated version of cssnano or something since cssnano itself seems to work as expected.",styfle,kind: bug,2021-07-03T19:11:18Z,2021-07-14T21:16:12Z,adamwathan,timneutkens;styfle;adamwathan;balazsorban44,adamwathan;timneutkens,timneutkens,timneutkens,,,
vercel/next.js,27092,"next/image optimized image does not look like original image ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

15.7.0

### What browser are you using?

Safari

### What operating system are you using?

macOS

### How are you deploying your application?

yarn dev

### Describe the Bug

I am using the Next.js **Image** component and when it is reered to Image in the browser, the image is **damaged**, but when I use the normal **img** HTML element the image is normal, but the deploy requires `next/image`.

There is another image very similar to this that works normally.

<img width=""311"" alt=""Screen Shot 2021-07-11 at 20 05 10"" src=""https://user-images.githubusercontent.com/37712275/125212372-5e8faf00-e283-11eb-9909-a50d46667ca0.png"">


### Expected Behavior

Expected Behavior is the TeamViewer icon image normally render like AnyDesk.

### To Reproduce

```jsx
import Image from 'next/image'

export default function Test() {
  return (
    <div>
      { /** Team Viewer button (link) */}
      <div className=""floating-button"" style={{ backgroundColor: ""var(--color-teamviewer)"", right: 160 }} >
          <Image 
            src={""/images/png/teamviewer.png""}
            alt=""TeamViewer""
            width={24}
            height={24}/>

        <h6>Team Viewer</h6>
      </div>

      { /** AnyDesk button (link) */ }
      <div className=""floating-button"" style={{ backgroundColor: ""var(--color-anydesk)"" }} >
        <Image 
          src={""/images/png/anydesk.png""}
          alt=""AnyDesk""
          width={24}
          height={24} />

        <h6>AnyDesk</h6>
      </div>
    </div>
  );
}
```
### Assets
![anydesk](https://user-images.githubusercontent.com/37712275/125212419-a7476800-e283-11eb-864d-fcc0323abc0b.png)
![teamviewer](https://user-images.githubusercontent.com/37712275/125212420-a7dffe80-e283-11eb-97ba-4010e2bc14ce.png)

### Result
<img width=""311"" alt=""Screen Shot 2021-07-11 at 20 05 10"" src=""https://user-images.githubusercontent.com/37712275/125212525-6ac83c00-e284-11eb-9184-fdf064dd35aa.png"">
",styfle,kind: bug,2021-07-11T23:14:16Z,2021-10-06T14:47:49Z,davidgaspardev,styfle;balazsorban44,davidgaspardev;styfle,styfle,styfle,,,
vercel/next.js,27163,"next/image generates invalid html tag (empty alt attribute) ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

15.7.0

### What browser are you using?

safari

### What operating system are you using?

macOS

### How are you deploying your application?

other

### Describe the Bug

As I see, `next/image` generates some divs with image inside it. I don't know the exact reason for that, but this additional image has empty `alt` attribute which prevent site from being passed html validator.

![image](https://user-images.githubusercontent.com/735194/125597894-73c5d81b-4b25-4fe3-a8f4-f5be7d79a2d9.png)

![灏忚柂鎳堝睉鑺娉 瑜濇郴瑜夐偑钖閭 2021-07-14 鑳 12 23 01](https://user-images.githubusercontent.com/735194/125597938-aeb54a35-a1b7-4f97-9dd8-a71848b58905.png)


### Expected Behavior

To pass validation

### To Reproduce

```javascript
import Image from 'next/image';

<Image
	{...rest}
	src={(imgSrc as StaticImageData) || fallback}
	alt={alt}
	unoptimized
	className={className}
	onError={() => {
		setImgSrc(fallback);
	}}
/>
`
",styfle,kind: bug,2021-07-14T09:24:05Z,2021-08-04T18:42:59Z,meliborn,Eliepse;styfle;balazsorban44,meliborn;styfle,styfle,styfle,,,
vercel/next.js,27298,"Hot reload connection can fail on Windows ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

v14.17.0

### What browser are you using?

Edge 91.0.864.67 - Chrome 91.0.4472.124

### What operating system are you using?

Windows 10 Pro 20H2

### How are you deploying your application?

npm run dev

### Describe the Bug

Hot reload / Fast Refresh isn't working.

I'm following the next tutorial, so here's my code:
npx create-next-app nextjs-blog --use-npm --example ""https://github.com/vercel/next-learn-starter/tree/master/learn-starter""

Here https://nextjs.org/learn/basics/create-nextjs-app/editing-the-page it says that the page will live reload, just like react / vue, but it doenst reload.

On network tab I see this errors:
![image](https://user-images.githubusercontent.com/84980469/126173782-e0f4afae-d7a0-413a-9283-1ec58d0243e0.png)



Approaches tried following google/yt tutorials:
Create next.config.js with FAST_REFRESH='TRUE'
Create webpack.config.js with TARGET = 'WEB'
Delete project and restarted from 0
npm ci
Delete node_modules and .next and recreated

### Expected Behavior

Live reload should work.

### To Reproduce

npx create-next-app nextjs-blog --use-npm --example ""https://github.com/vercel/next-learn-starter/tree/master/learn-starter""",ijjk,kind: bug,2021-07-19T14:12:23Z,2021-07-19T23:12:28Z,MateusFP95,ijjk;MateusFP95;shadowwalker;balazsorban44,MateusFP95,,,,,
vercel/next.js,27501,"next/image preload with priority in IOS 11 ### What version of Next.js are you using?

11.0.1

### What version of Node.js are you using?

14.15.1

### What browser are you using?

Safari

### What operating system are you using?

IOS 11

### How are you deploying your application?

next start

### Describe the Bug

next/image with static import and priority=true does not set href attribute for its preload tag. It triggers error on IOS 11 and less

<img width=""513"" alt=""Screen Shot 2021-07-26 at 13 19 39"" src=""https://user-images.githubusercontent.com/32598874/126973563-5bf2aafe-3b9b-4682-af34-03c27f40aa8f.png"">


### Expected Behavior

Set image original src as href attribute for preload tag.

### To Reproduce

`import NextImage from 'next/image'`
`import SearchIcon from './icons/search.svg'`
`const Component = ()=>  <NextImage src={SearchIcon as StaticImageData} priority />`
Just open image with priority property in IOS 11 with real device. or browserstack",atcastle,kind: bug;type: needs investigation,2021-07-26T10:25:52Z,2021-07-30T05:20:43Z,bladl,LetItRock;balazsorban44,bladl;timneutkens,timneutkens,timneutkens,,bladl,
vercel/next.js,27973,"""url"" parameter is valid but upstream response is invalid 閳 next/image on 11.1 ### What version of Next.js are you using?

11.1

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

serverless-next.js

### Describe the Bug

My images are served via S3 and signed urls. They worked locally (using `next dev`) until I upgraded to Next.js@11.1 this morning. I previously had an issue with this, where the MIME types were `binary/octet-stream` but have since changed the MIME types to `image/jpg`, and have had no trouble since then. I also now know that `image/jpeg` is preferable to `image/jpg` however I am unsure if this is the issue. The only error I get back is 
```js
""url"" parameter is valid but upstream response is invalid
```

If I downgrade to Next@11.0.1, the issue is resolved.

### Expected Behavior

Next image would return me my optimized image, not a 400 bad request with 
```js
""url"" parameter is valid but upstream response is invalid
```

I see that in [next.js/image-optimizer.ts](https://github.com/vercel/next.js/blob/988c0c7fd3d780f63a6a85a7731d1854e52e61d4/packages/next/server/image-optimizer.ts#L223) this comes from a failed fetch on the href. I am curious why this would be the case now, and not in previous versions. Thinking perhaps this was a CORS error (somehow, really just trying anything) I changed my bucket policy. Error persists.

### To Reproduce

Use an image signed by S3 with the MIME type of `image/jpg`",styfle,kind: bug,2021-08-11T19:11:41Z,2021-08-13T00:31:52Z,jonahallibone,styfle;Sakhro;jonahallibone;FDiskas;balazsorban44,jonahallibone;styfle,styfle,styfle,,,
vercel/next.js,28215,"Unnecessary warnings when using custom image loader with size buckets ### What version of Next.js are you using?

11.1.0

### What version of Node.js are you using?

14.17.3

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

After upgrading Next.js, we are seeing lots of errors being printed about a missing width, referencing this page: https://nextjs.org/docs/messages/next-image-missing-loader-width. This error makes the assumption that the loader cannot be resizing the image properly without the width value as a parameter. We have a custom image loader that relies on `size` and `scale` parameters to bucket image requests into several predefined sizes. Based on the needed width, we'll compute the appropriate `size` and `scale` and only those parameters are passed to the image service, like `size=medium-360&scale=1`. There doesn't seem to be any way to silence this error, even though it is working as expected and the images are being optimized within their appropriate buckets.

### Expected Behavior

No error, or at least a way to assert that we are using our custom loader in an expected way.

### To Reproduce

```jsx
function transcodeImageImageLoader({ src, width }: { src: string; width: number; }): string {
  const [size, scale] = getSizeForWidth(width);

  return `https://example.com/${src}?size=${size}&scale=${scale}`;
}

export default function TranscodeImage(props: ImageProps): ReactElement {
  return <Image {...props} loader={transcodeImageImageLoader} />;
}
```",styfle,kind: bug,2021-08-17T20:39:04Z,2021-10-29T16:54:51Z,ericmatthys,ijjk;balazsorban44,ericmatthys;ijjk,ijjk,styfle,,ijjk,
vercel/next.js,2825,"Changing hash in URL causes getInitialProps to be re-fired Changing the hash in the URL causes getInitialProps to be fired, which I think should've been fixed in [this PR](https://github.com/zeit/next.js/pull/1250). See the following example repo: https://github.com/ldthorne/nextjs-back-reproduction.

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
If the user clicks the `go somewhere` link that leads to an anchor -- which will add a hash to the url -- and then clicks the back button, `getInitialProps` should not be called.

## Current Behavior
If the user clicks the `go somewhere` link that leads to an anchor -- which will add a hash to the url -- and then clicks the back button, `getInitialProps` is called.

## Steps to Reproduce (for bugs)
1. Clone repo: https://github.com/ldthorne/nextjs-back-reproduction.
2. `yarn`.
3. Open dev tools.
4. Click the `go somewhere` link. Notice that nothing is logged.
5. Click the browser's back button. Notice that `getInitialProps` is logged. 

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech | Version |
|---------|---------|
| next | 3.0.6 |
| node | 8.1.2 |
| OS | macOS 10.12.6 |
| browser | All |
",ijjk,kind: bug,2017-08-21T20:35:23Z,2019-05-05T19:34:34Z,ldthorne,ldthorne;timneutkens;arunoda;coluccini;mherodev,timneutkens,,timneutkens,timneutkens,lfades,
vercel/next.js,28251,"Blur placeholder stay visible with JavaScript disabled ### What version of Next.js are you using?

11.1.0

### What version of Node.js are you using?

12.22.1

### What browser are you using?

Chrom, Firefox, Safari

### What operating system are you using?

macOS

### How are you deploying your application?

next dev, next start

### Describe the Bug

When rendering an image with `next/image` that has a blur placeholder set:
If JavaScript is disabled in the browser, the `img` tag with blur placeholder as a background is shown on top of the `noscript` image. See this screenshot:

<img width=""791"" alt=""nextjs-img-placeholder-noscript"" src=""https://user-images.githubusercontent.com/33351/129887590-f3fae4ea-a739-468e-b25a-87850da4a62f.png"">

And this is the DOM showing that the later `img` overlaps the `noscript` img:

<img width=""733"" alt=""nextjs-img-placeholder-dom"" src=""https://user-images.githubusercontent.com/33351/129887750-54ccd4cd-ebbf-4ef3-b4d4-7fdea880bea9.png"">

We could solve this with some CSS trickery like:

```css
noscript + img[data-nimg] {
    visibility: hidden;
}
```

But I think it would be best to change the order of both elements (but it's not clear to me if the order is on purpose here).

### Expected Behavior

No blur placeholder should be visible when images are loaded with JavaScript disabled.

### To Reproduce

* Open the placeholder example in https://github.com/vercel/next.js/blob/master/examples/image-component/pages/placeholder.js
* Disable JS in the browser, reload the page
* The blur placeholder should stay visible on top of the actual image",styfle,kind: bug,2021-08-18T11:11:32Z,2021-08-19T04:26:07Z,hlubek,hlubek;styfle;balazsorban44,hlubek;styfle,styfle,styfle,,,
vercel/next.js,28464,"api endpoint hangs and eventually times out when you res.status(204).send('anything') instead of throwing an error ### What version of Next.js are you using?

11.1.0

### What version of Node.js are you using?

14 (hosted on vercel)

### What browser are you using?

chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

```jsx
res.status(204) // works as expected
res.status(200).send('message') // works as expected
res.status(204).send('something') // shits itself
```

The request hangs and eventually gives a timeout error. 
It took me way longer to debug this than it should have. Completely my fault, I admit it.

This isn't an issue when running the app with `yarn dev`
It's only an issue for me when it is deployed on vercel.

reminder: http code 204 = no response

### Expected Behavior

Some options:

1. throw an error when attempting to send any data when the status is 204
2. make the function typesafe so it can't call `.send()` if the status is a 204
3. anything that would have made life a bit easier if there is a sneaky 204 in your code that is meant to be a 200.
4. at the very least, having consistent behaviour between the dev environment and the deployed app would make this much faster to spot.

### To Reproduce

`res.status(204).send('message')` when deployed on vercel",styfle,kind: bug,2021-08-24T15:25:09Z,2021-08-25T15:52:43Z,anguskeatinge,styfle;anguskeatinge;balazsorban44,anguskeatinge;styfle,styfle,styfle,,,
vercel/next.js,28596,"False positive for `no-document-import-in-page` ### What version of Next.js are you using?

11.1.0

### What version of Node.js are you using?

14.17.1

### What browser are you using?

Chrome

### What operating system are you using?

Windows

### How are you deploying your application?

next start

### Describe the Bug

The `@next/next/no-document-import-in-page` ESLint rule displays an error in a custom `_document` if it is located at `pages/_document/index.js`, `pages/_document/index.jsx`, `pages/_document/index.ts`, or `pages/_document/index.tsx`.

### Expected Behavior

I expect there to be no ESLint error from the `@next/next/no-document-import-in-page` rule in all valid custom `_document` file locations.

### To Reproduce

Create `pages/_document/index.jsx` as follows with the ESLint rule enabled.

```jsx
import Document, { Html, Head, Main, NextScript } from 'next/document';

class MyDocument extends Document {
	render() {
		return (
			<Html lang=""en"">
				<Head />
				<body>
					<Main />
					<NextScript />
				</body>
			</Html>
		);
	}
}

export default MyDocument;
```

This results in an error on line 1.",housseindjirdeh,kind: bug,2021-08-29T08:39:50Z,2021-09-04T18:42:01Z,GrantGryczan,kimbaudi;JamesSingleton;housseindjirdeh;rtritto;samsisle;GrantGryczan;akd-io;darrylhuffman;realdocweird;ivenuss;alex-drocks;mkayander,GrantGryczan,,housseindjirdeh,,housseindjirdeh,
vercel/next.js,29363,"OnLoadingComplete not working when passing function, but works when console log ### What version of Next.js are you using?

11.1.2

### What version of Node.js are you using?

10.20.1

### What browser are you using?

chrome

### What operating system are you using?

codesandbox

### How are you deploying your application?

codesandbox

### Describe the Bug

I'm trying to get the naturalWidth and naturalHeight from onLoadingComplete props: https://nextjs.org/docs/api-reference/next/image#onloadingcomplete but its not working? Perhaps I'm doing it wrong?

I have a codesandbox, lines 62, 63: https://codesandbox.io/s/proud-rain-d51sv?file=/pages/index.js

When you upload an image, console log only works, but it doesn't work when I'm trying to pass handleImageLoad function listed in the sandbox. 

### Expected Behavior

Trying to get naturalWidth and naturalHeight

### To Reproduce

https://codesandbox.io/s/proud-rain-d51sv?file=/pages/index.js lines 62, 63",styfle,kind: bug,2021-09-24T17:21:23Z,2021-09-26T15:03:08Z,levelingup,ijjk;styfle;levelingup;balazsorban44,levelingup;styfle,styfle,styfle,,,
vercel/next.js,29717,"<Image> components in <p> tags act oddly ### What version of Next.js are you using?

11.x

### What version of Node.js are you using?

14.15.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

n/a

### Describe the Bug

Because `<Image>` uses a `<div>` wrapper under the hood, adding an `<Image>` tag within a `<p>` tag results in a `<div>` inside a `<p>` (which is considered a semantic malformation in HTML). In attempting to handle the malformation, the browser starts with the `<div>` outside the `<p>`, then eventually appends it correctly. This churn causes CLS as a line break is briefly visible.


### Expected Behavior

There shouldn't be a line break. One potential fix is to replace the wrapper `<div>` with a `<span>`, which would be semantically valid. This would be a breaking change.

### To Reproduce

See repro here: https://github.com/goncy/nextjs-image-bug-repro",styfle,kind: bug,2021-10-07T19:17:55Z,2021-10-18T21:29:19Z,kara,styfle;stefanprobst;CarltonHenderson;balazsorban44,kara;styfle,styfle,styfle,,,
vercel/next.js,29788,"Cannot find name 'StaticImageData'. ### What version of Next.js are you using?

11.1.2 & 11.1.3-canary.57

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next build

### Describe the Bug

The following error occurs during type checking.

```bash
node_modules/next/dist/client/image.d.ts:19:14 - error TS2304: Cannot find name 'StaticImageData'.

19     default: StaticImageData;
                ~~~~~~~~~~~~~~~

node_modules/next/dist/client/image.d.ts:21:45 - error TS2304: Cannot find name 'StaticImageData'.

21 declare type StaticImport = StaticRequire | StaticImageData;
                            
```

I got the following Issue in v11.0.0, upgraded to v11.1.2 and the problem was solved, but now I get this error instead.
https://github.com/vercel/next.js/issues/26892

### Expected Behavior

TS compiler should not give errors.

### To Reproduce

Here's the full code to my component:

```js
import { memo, useState, VFC } from 'react';
import Image, { ImageProps } from 'next/image';
import { isTest } from 'src/lib/environmentDetector';

type PropsType = ImageProps & {
  fallback: string | JSX.Element;
};

export const ImageWithFallback: VFC<PropsType> = memo(
  ({ src, fallback, ...rest }) => {
    const [showFallback, setShowFallback] = useState(false);
    if (isTest()) return null;

    const onError = () => {
      setShowFallback(true);
    };

    if (showFallback && typeof fallback !== 'string') return fallback;
    return <Image {...rest} src={showFallback ? (fallback as string) : src} onError={onError} />;
  },
  (p, n) => p.src === n.src
);
```",timneutkens,kind: bug;area: next/image;area: TypeScript,2021-10-11T01:38:34Z,2022-02-19T03:25:49Z,sakit0,stefanprobst;mac-h95;atcastle;nbouvrette;unknownbreaker;SpencerKaiser;balazsorban44;leerob;esafev;PrimeObjects;EstebanBorai,sakit0;timneutkens;balazsorban44,balazsorban44,timneutkens,,balazsorban44,vercel/next.js#26892;
vercel/next.js,29994,"Adding URL parameters causes Vercel to serve stale content when using ISG ### What version of Next.js are you using?

11.1.1

### What version of Node.js are you using?

14.x

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

When using Incremental Static Generation, adding GET parameters to a URL bypasses the edge cache and serves stale content from static storage. Subsequent requests are served from the cache. This causes issues when sharing content on social media platforms, which append parameters to the URL for tracking purposes, e.g. `?fbclid=IwAR0DLppoXhiaAkQgLOCypQEDp6YP9w5ywomrFtKJaxhB6JW6MljOGNFElb0`.

### Expected Behavior

After regeneration, users should always see fresh content regardless of extra URL parameters. Stale content should not be served to the user after a page has been regenerated.

### To Reproduce

Pre-conditions:

* Return `revalidate: 1` with `getStaticProps` for route `/my-page`
* Next.js deployed on Vercel
* Update `/my-page` content in CMS

1. Navigate to `/my-page`. User sees stale page (expected).`x-vercel-cache: STALE`
2. Navigate to `/my-page`. User sees page with new updates (expected). `x-vercel-cache: HIT`
3. Navigate to `/my-page?test=1`. Expected: User sees page with new updates. Actual: User sees stale page `x-vercel-cache: PRERENDER` 

On the third step, `x-vercel-cache: PRERENDER` makes sense because adding a URL parameter ""breaks"" the cache and redirects the request to the nearest data center and serves the page from static storage. What is unexpected is the static storage still returns the stale version of the page. When the page is regenerated after the first visit in STEP 1, shouldn't static storage have been updated with the new version of the page?",styfle,kind: bug;area: Static Generation,2021-10-17T17:38:52Z,2021-12-15T19:03:10Z,benknight,benknight;styfle;balazsorban44,benknight;styfle;timneutkens,styfle,styfle,,balazsorban44,
vercel/next.js,30033,"Image placeholder does not respect objectFit property ### What version of Next.js are you using?

11.1.0

### What version of Node.js are you using?

14.17.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

When I use the `Image` component to render an image with `layout=fill` and `objectFit=contain` property, it does it well when the image has been loaded (image is adapting into parent container), but when I set `placeholder=blur` I see blurred image filling the whole container instead of being contained (image ratio is same as original)

### Expected Behavior

I'm expecting to see `objectFit` and `objectPosition` props to `blurDataURL` image as well

### To Reproduce

Here is the code sample:
`
<Image
      src=""https://assets.imgix.net/setup/serving-swimmer.jpg?w=7000""
      alt=""Image test""
      layout=""fill""
      objectFit=""contain""
      objectPosition=""center""
      placeholder=""blur""
      blurDataURL=""https://assets.imgix.net/setup/serving-swimmer.jpg?w=10""
    />
`
You can find a sandbox running sample here. If your connection is too good, please increase the `w=7000` value in src to increase the image size
https://codesandbox.io/s/image-placeholder-object-fit-contain-70h5q?file=/pages/index.js",styfle;atcastle,kind: bug;area: next/image,2021-10-18T14:51:46Z,2022-06-16T10:36:45Z,matteosailogy,vulture990;styfle;kirkas;grazianodev;joshuabaker;balazsorban44,matteosailogy;timneutkens;styfle,styfle,styfle;timneutkens;kara,kara,balazsorban44,
vercel/next.js,30203,"For internationalised apps, asPath doesn't include dynamic param when rendering server side. ### What version of Next.js are you using?

11.1.2 and 11.1.3-canary.96

### What version of Node.js are you using?

14.x

### What browser are you using?

Chome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

I have a statically generated page with dynamic param like this `/pages/page/[slug].js`. It is using `getStaticProps` and using `getStaticPaths` to render some slugs and have `fallback: blocking`.

I am using `asPath` from `useRouter()` to calculate canonical url for the page. But for the pages which are being rendered because of `fallback: blocking`, `asPath` is returning `/page/[slug]` instead of `/page/actual-slug`.

As far as I can tell, it only happens in Vercel as `yarn start` works fine.

**Fix** 
It starts returning actual slug if I remove i18n from `next.config.js`. So it has something to do with internationalisation

### Expected Behavior

`asPath` should still return the actual slug value when i18n is present in `next.config.json`

### To Reproduce

I have created a minimal reproduction repo. https://github.com/akshitkrnagpal/nextjs-error-repro

You can verify by visiting these two urls
https://nextjs-error-repro-sable.vercel.app/page/page-a - prebuilt
https://nextjs-error-repro-sable.vercel.app/page/page-b - fallback blocking

Do view source on both pages. 
For page-a, you'll see `<link rel=""canonical"" href=""https://example.com/page/page-a""/>`
For page-b, you'll see `<link rel=""canonical"" href=""https://example.com/page/[slug]""/>`",ijjk,kind: bug;area: Routing,2021-10-23T06:07:28Z,2021-11-11T20:11:51Z,akshitkrnagpal,ijjk;akshitkrnagpal;balazsorban44,akshitkrnagpal;ijjk;timneutkens,ijjk,ijjk,,,
vercel/next.js,30322,"[11.1.3-canary.104] ReferenceError: PerformanceObserver is not defined ### What version of Next.js are you using?

11.1.3-canary.104

### What version of Node.js are you using?

14.18.0

### What browser are you using?

Firefox

### What operating system are you using?

Windows

### How are you deploying your application?

Vercel

### Describe the Bug

With the latest canary, I am noticing tests failing due to `PerformanceObserver` not being defined. This issue didn't happen in in the previous canary or in LTS.

### Expected Behavior

My tests shouldn't fail or if I need to add a mock for this, there should be some updated documentation to support.

### Reproduce
I have a modal that has an `Image` component, I am seeing this error in my jest logs:

```
Error: Uncaught [ReferenceError: PerformanceObserver is not defined]

console.error
    The above error occurred in the <Image> component:
    
        at Image (/home/wade/Code/Clients/rhythm-marketing/node_modules/next/client/image.tsx:307:3)
        at div
        at Modalstyled__ModalIcon (/home/wade/Code/Clients/rhythm-marketing/node_modules/styled-components/src/models/StyledComponent.js:252:3)
        at div
        at Layout__FlexBox (/home/wade/Code/Clients/rhythm-marketing/node_modules/styled-components/src/models/StyledComponent.js:252:3)
        at div
        at Modalstyled__ModalDialog (/home/wade/Code/Clients/rhythm-marketing/node_modules/styled-components/src/models/StyledComponent.js:252:3)
        at div
        at Modalstyled__ModalPageContainer (/home/wade/Code/Clients/rhythm-marketing/node_modules/styled-components/src/models/StyledComponent.js:252:3)
        at Modal (/home/wade/Code/Clients/rhythm-marketing/src/components/Modal/Modal.component.tsx:37:3)
        at Object.<anonymous>.exports.ThemeProvider (/home/wade/Code/Clients/rhythm-marketing/node_modules/styled-components/src/models/ThemeProvider.js:24:7)
        at I18nextProvider (/home/wade/Code/Clients/rhythm-marketing/node_modules/react-i18next/dist/commonjs/I18nextProvider.js:13:19)
        at Providers (/home/wade/Code/Clients/rhythm-marketing/test-utils.tsx:48:26)
```",styfle,kind: bug,2021-10-26T14:55:16Z,2021-10-27T00:37:20Z,wadehammes,wadehammes;JoshuaASmith;miketheodorou;styfle;ijjk;balazsorban44,wadehammes;styfle,styfle,styfle,,,
vercel/next.js,30330,"Dev mode on Next.js v12 breaks with combination of features ### What version of Next.js are you using?

12.0.0 and 12.0.1

### What version of Node.js are you using?

v16.13.0 and v14.18.1 and v12.22.7

### What browser are you using?

Doesn't apply, breaks on terminal

### What operating system are you using?

Arch Linux and macOS Big Sur 11.6

### How are you deploying your application?

next dev

### Describe the Bug

`next dev` breaks on v12, but I'm not exactly sure why, I was able to create a minimal reproduction repo with a combination of features, but I tried reproducing the issue with almost every feature (externalDir, chakra-ui, monorepo, typescript of course) of the repository by itself and worked fine, so I'm not completely sure what breaks it 

### Expected Behavior

dev mode should work??, in v11 everything works fine

### To Reproduce

https://github.com/PabloSzx/next-v12-bug

```sh
> next

ready - started server on 0.0.0.0:3000, url: http://localhost:3000
warn  - You have enabled experimental feature(s).
warn  - Experimental features are not covered by semver, and may cause unexpected or broken application behavior. Use them at your own risk.

event - compiled successfully in 3.2s (1515 modules)
wait  - compiling /_error...
event - compiled successfully in 322 ms (1516 modules)

<--- Last few GCs --->

[60697:0x4967150]    24587 ms: Scavenge 4046.5 (4123.3) -> 4046.0 (4131.3) MB, 5.2 / 0.0 ms  (average mu = 0.387, current mu = 0.119) allocation failure 
[60697:0x4967150]    24599 ms: Scavenge 4052.6 (4131.3) -> 4051.3 (4131.6) MB, 10.1 / 0.0 ms  (average mu = 0.387, current mu = 0.119) allocation failure 
[60697:0x4967150]    25112 ms: Scavenge 4053.6 (4131.6) -> 4052.5 (4152.6) MB, 511.8 / 0.0 ms  (average mu = 0.387, current mu = 0.119) allocation failure 


<--- JS stacktrace --->

FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
 1: 0xb02eb0 node::Abort() [node]
 2: 0xa181fb node::FatalError(char const*, char const*) [node]
 3: 0xced75e v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]
 4: 0xcedad7 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]
 5: 0xea5d75  [node]
 6: 0xeb544d v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [node]
 7: 0xeb814e v8::internal::Heap::AllocateRawWithRetryOrFailSlowPath(int, v8::internal::AllocationType, v8::internal::AllocationOrigin, v8::internal::AllocationAlignment) [node]
 8: 0xe7957a v8::internal::Factory::NewFillerObject(int, bool, v8::internal::AllocationType, v8::internal::AllocationOrigin) [node]
 9: 0x11f2d56 v8::internal::Runtime_AllocateInYoungGeneration(int, unsigned long*, v8::internal::Isolate*) [node]
10: 0x15e7759  [node]
```
",sokra,kind: bug,2021-10-26T17:05:07Z,2021-10-27T13:53:45Z,PabloSzx,candidosales;timneutkens;mustaphaturhan;d3v4nt;sangdth;Navbryce;arthuryeti;PabloSzx;cschroeter;alessandrojcm;sokra;CTNicholas;alirezavlz;patrick-samy;balazsorban44;icopp;adrianthedev;M-e-r-c-u-r-y,PabloSzx;timneutkens,timneutkens,timneutkens,,,
vercel/next.js,30398,"Getting ""ReferenceError: Response is not defined"" while trying to upgrade an app from next 11 to next 12 ### What version of Next.js are you using?

12.0.0

### What version of Node.js are you using?

16.3.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next build + next start

### Describe the Bug

I am trying to upgrade Next.js version in a big application from v11.0.1 to Next.js 12. It uses Next with express.js.
I'm getting the following error:
```
ReferenceError: Response is not defined
    at Object.<anonymous> (/Users/andreisena/projects/.../node_modules/next/dist/server/web/spec-extension/response.js:23:28)
    at Module._compile (node:internal/modules/cjs/loader:1109:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1138:10)
    at Module.load (node:internal/modules/cjs/loader:989:32)
    at Function.Module._load (node:internal/modules/cjs/loader:829:14)
    at Function.wrappedLoad [as _load] (/Users/andreisena/projects/.../node_modules/newrelic/lib/shimmer.js:373:24)
    at Module.require (node:internal/modules/cjs/loader:1013:19)
    at require (node:internal/modules/cjs/helpers:93:18)
    at Object.<anonymous> (/Users/andreisena/projects/.../node_modules/next/dist/server/next-server.js:47:17)
    at Module._compile (node:internal/modules/cjs/loader:1109:14)
```

### Expected Behavior

To work correctly like v11

### To Reproduce

I couldn't reproduce it yet on a fresh install of Next.js and I cannot share the repo since it is private. But if I find something new I will post here.

What I could see in a fresh install is that when I debug Response in `server/web/spec-extension/response.js`, it has the same contract as **node-fetch** Response. Is that correct?

```
Object [Response] {
  url: [Getter],
  status: [Getter],
  ok: [Getter],
  redirected: [Getter],
  statusText: [Getter],
  headers: [Getter],
  clone: [Function: clone],
  body: [Getter],
  bodyUsed: [Getter],
  arrayBuffer: [Function: arrayBuffer],
  blob: [Function: blob],
  json: [Function: json],
  text: [Function: text],
  buffer: [Function: buffer],
  textConverted: [Function: textConverted]
}
```

By the way, on the main application, Response always come as undefined.",javivelasco,kind: bug;area: Middleware,2021-10-27T03:48:05Z,2021-12-13T18:30:25Z,andreisena,ijjk;franklinjavier;andreisena;gm-rebricker;rogermori;javivelasco;balazsorban44,andreisena;timneutkens,timneutkens,timneutkens,javivelasco,,
vercel/next.js,30421,"Security Vulnerability on dependency shell-quote@1.7.2 - CVE-2021-42740 ### What version of Next.js are you using?

latest

### What version of Node.js are you using?

N/A

### What browser are you using?

N/A

### What operating system are you using?

N/A

### How are you deploying your application?

N/A

### Describe the Bug

A security vulnerability has been raised on one of next.js dependency shell-quote@1.7.2

**Introduced through:** next@11.1.2 閳 @next/react-dev-overlay@11.1.2 閳 shell-quote@1.7.2

https://cve.report/CVE-2021-42740

latest version of shell-quote 1.7.3 fixes the issues : https://github.com/substack/node-shell-quote/blob/master/CHANGELOG.md#173




### Expected Behavior

N/A

### To Reproduce

N/A",styfle;ijjk,kind: bug,2021-10-27T10:01:19Z,2021-10-29T16:12:47Z,SSlimani,imranbarbhuiya;dennisroethig;balazsorban44,SSlimani;timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,30429,"swcMinify: true - ReferenceError: Can't find variable: excludeEmptyString ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

16.10.0

### What browser are you using?

Safari

### What operating system are you using?

MacOS

### How are you deploying your application?

Vercel

### Describe the Bug

I'm sure its connected to other issues, but thought I'd provide some more context.

Setting the swcMinify config to true seems to break something in the runtime as it successfully builds and deploys, but then when navigating to certain pages I get:

```
ReferenceError: Can't find variable: excludeEmptyString 
  matches 閳 string.js:75
  (anonymous function) 閳 <some-page>.tsx:33
  g 閳 bootstrap:22
  (anonymous function) 閳 _N_E:6
  promiseReactionJob
```





### Expected Behavior

Not error :)

### To Reproduce

Our team has a boilerplate repo we use on all our projects:

https://github.com/NoQuarterTeam/boilerplate

- cd into packages/web
- change the next.config.js file to set swcMinify to true
- yarn build
- yarn start
- Navigate to /login

",balazsorban44,kind: bug;area: SWC Minify,2021-10-27T11:51:22Z,2021-12-23T12:43:06Z,JClackett,mr47;JClackett;nikosantis;kdy1;neilpoulin;timneutkens;rodilo;Aliemeka;BluetyIt;ScottEAdams;balazsorban44;jamesbluecrow;MohammedWaheeb;mntnv;rpedroni;egaba,JClackett;timneutkens,timneutkens,,,timneutkens,vercel/next.js#30498;
vercel/next.js,30480,"Interpolation in styled jsx media query not working after upgrading to nextjs 12 ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

12.22.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

After upgrading to nextjs 12 interpolations in styled jsx media query not working anymore.

```
<style jsx>{`@media (${breakPoint}) {}`}</style>
```

is compiled to:

`@media max-width: 1024px {}`

but should be:

`@media (max-width: 1024px) {}`

The parenthesis is missing.

### Expected Behavior

```
<style jsx>{`@media (${breakPoint}) {}`}</style>
```

should be compiled to:

`@media (max-width: 1024px) {}`

### To Reproduce

1. git clone https://github.com/dim2k2006/nextjs-styled-jsx-bug
2. yarn install
3. yarn dev
4. Open http://localhost:3000/
5. Inspect page heading styles 

![image](https://user-images.githubusercontent.com/7868088/139131165-06c635b1-3ae8-4f1b-8906-337cf1d3c0a8.png)

Source code of the page could be found here: https://github.com/dim2k2006/nextjs-styled-jsx-bug/blob/main/pages/index.tsx",padmaia;kdy1,kind: bug;area: SWC transforms,2021-10-27T19:11:33Z,2021-11-15T08:27:46Z,dim2k2006,padmaia;kdy1;dim2k2006;balazsorban44,dim2k2006;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,30486,"Next.js 12 failing with `react-icons` ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

14

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

`next build` fails to bundle necessary files for `react-icons`

### Expected Behavior

Should be able to run bundled functions from `nft.json`

### To Reproduce

```js
// Put this in `pages/api/index.js`

import { IconContext } from 'react-icons';
console.log(IconContext)

export default function handler(req, res) {
  res.end('it works')
}
```

Trace from `next build` is:

```json
{
  ""version"": 1,
  ""files"": [""../webpack-runtime.js"",
    ""../../../package.json"",
    ""../../../node_modules/react-icons/lib/package.json"",
    ""../../../node_modules/react-icons/package.json"",
    ""../../../node_modules/react-icons/lib/cjs/index.js"",
    ""../../../node_modules/react/package.json"",
    ""../../../node_modules/react/index.js"",
    ""../../../node_modules/react-icons/lib/cjs/iconBase.js"",
    ""../../../node_modules/react-icons/lib/cjs/iconsManifest.js"",
    ""../../../node_modules/react-icons/lib/cjs/iconContext.js"",
    ""../../../node_modules/react/cjs/react.production.min.js"",
    ""../../../node_modules/object-assign/package.json"",
    ""../../../node_modules/object-assign/index.js""
  ]
}
```

The trace from `nft` is:

```
node_modules/object-assign/index.js
node_modules/object-assign/package.json
node_modules/react-icons/index.js
node_modules/react-icons/lib/cjs/iconBase.js
node_modules/react-icons/lib/cjs/iconContext.js
node_modules/react-icons/lib/cjs/iconsManifest.js
node_modules/react-icons/lib/cjs/index.js
node_modules/react-icons/lib/package.json
node_modules/react-icons/package.json
node_modules/react/cjs/react.development.js
node_modules/react/cjs/react.production.min.js
node_modules/react/index.js
node_modules/react/package.json
package.json
pages/api/index.js
pages/api/index.js
```

Notice the react-icons/index.js is missing from `next build` which causes the following:

```
Error: Cannot find module '/var/task/node_modules/react-icons/lib'. Please verify that the package.json has a valid ""main"" entry
```",ijjk,kind: bug,2021-10-27T20:58:05Z,2021-11-05T01:09:38Z,styfle,aboveyunhai;Hopsken;timneutkens;ijjk;balazsorban44,styfle,,styfle,,ijjk,
vercel/next.js,30498,"Static pages render but React not mounting client-side in Production mode. Works in dev.  ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

16.11.1

### What browser are you using?

Brave, Chrome, Safari

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

Prior to Next 12, building a production bundle and running the server via `next start` worked great. Most of my pages are static, and a handful are server-side-rendered. 

After upgrading, running `next dev` continues to work well but running `next build` followed by `next start` results in a non-interactive application. There are no build errors or warnings, and the app starts up fine. I can render my home page and even navigate via link in my menubar (next/links). All styles appear correct. 

However, none of the interactions powered by javascript are present. I added logging in the render function of my pages and I see the log statements when building the app (static pages) and in the server logs when hitting that route for server-side-rendered pages, but _none_ of the pages appear to mount the react application on the client. I don't see any logging, or can i interact with javascript-powered components (dropdown menus, etc).

I do have a custom `_document.tsx` page in order to server-side render Material UI styles, and a custom `_app.tsx` page that adds things like Redux Providers, etc. I actually tried removing both of those pages and using the default Next pages, but I still was not able to get any log statements to print out in the browser from inside a render function. 

I do not have any custom babel configuration, nor any custom webpack configs. My various config files are below.

I'm totally stumped by this. See the repo below to reproduce the issue.

### Expected Behavior

The production build should behave exactly like the dev build, which should behave exactly like the test build. 

### To Reproduce
Edit: [here's a repo](https://github.com/neilpoulin/next-bugreport-30498) that reproduces the issue. While creating the repo, I learned a few things: 

* I'm pretty sure this issue is caused by pulling in a particular dependency, in this case `yup`. 
* The app behaves differently when building in Dev, Test, and Production modes (via `NODE_ENV=test|production|development`)
* [dev] `next dev` -> app works as expected. No broken behavior, no build warnings, no console logs, everything is great.
* [test] `NODE_ENV=test next build && NODE_ENV=test next start` -> app builds with no warnings/errors and all pages render, but there is no interaction available. The app doesn't seem to ""mount"". No errors in the browser or server. 
* [prod] `next build && next start` -> App builds fine, no warnings/errors. When loading the page in the browser content flashes, then a generic Next error screen appears: 
    > Application error: a client-side exception has occurred (see the browser console for more information).
   
    Checking the browser console reveals a `ReferenceError: excludeEmptyString is not defined` ultimately coming from the `yup` library. ",kdy1,kind: bug;area: SWC Minify,2021-10-28T01:00:44Z,2021-11-10T16:39:34Z,neilpoulin,neilpoulin;timneutkens;padmaia;balazsorban44,neilpoulin;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,30530,"styled-jsx css.resolve tag does not work anymore when using top level css rules without enclosing those rules in a selector ### What version of Next.js are you using?

12.0.1 and 12.0.2-canary.2

### What version of Node.js are you using?

16.13.0

### What browser are you using?

Chrome

### What operating system are you using?

Ubuntu 20.04.3 LTS

### How are you deploying your application?

next start

### Describe the Bug

In previous Next.js versions, styled-jsx css.resolve tag works using top level css rules without enclosing those rules in a selector, in Next.js 12.0.0+ it does not.

Running npm run dev results in:

```
wait  - compiling /...
error - ./components/NavLink/NavLink.js
Error: error: Invalid selector
  
   |
38 |   border-bottom: 3px solid #000000;
   |                 ^

error: Failed to parse css in styled jsx component
  
   |
37 |   const navLinkSelected = () => css.resolve`
   |  __________________________________________^
38 | |   border-bottom: 3px solid #000000;
39 | | `;
   | |_^
   |
   = note: Input to the css parser is 
             border-bottom: 3px solid #000000;
```

### Expected Behavior

CSS compiles and aplies correctly to the element, like the [styled-jsx resolve tag documentation](https://github.com/vercel/styled-jsx#the-resolve-tag) specifies

### To Reproduce

Try to render an example component like this one:

**NavLink.js**

```
import { css } from 'styled-jsx/css';

const navLinkSelected = () => css.resolve`
  border-bottom: 3px solid #000000;
`;

function NavLink() {
  const { className: navLinkSelectedClassName, styles: navLinkSelectedJSX } = navLinkSelected();

  return (
    <a className={navLinkSelectedClassName} >
        {navLinkSelectedJSX}
        {'example nav link'}
    </a>
  );
}
```",padmaia,kind: bug;area: SWC transforms,2021-10-28T09:49:17Z,2021-11-30T19:17:11Z,JustLitio,sudhiry;padmaia;balazsorban44,JustLitio;padmaia;timneutkens,timneutkens,timneutkens,,padmaia,
vercel/next.js,30567,"CSS @import url for loading fonts doesnt work ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

17.0.1

### What browser are you using?

Firefox, Chrome

### What operating system are you using?

Windows 10

### How are you deploying your application?

next start

### Describe the Bug

App.scss:
`@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');`

Loading the font with next dev works but not with next build (next start).

Tested with `optimizeFonts: false` but with same result.

### Expected Behavior

In next 11.0.1 the font was imported correctly

### To Reproduce

Inside App.scss
`@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');`

1. next build
2. next start",sokra,kind: bug;type: needs investigation;area: Compiler,2021-10-28T16:39:05Z,2021-11-22T15:09:59Z,jaemil,sveggiani;sitoftonic;alizahid;zackdotcomputer;edgechurchdev;balazsorban44;hoangph271;matthoiland;alaadahmed;gthb;mrodrigues95;petehl,jaemil;timneutkens,timneutkens,,,,
vercel/next.js,30570,"with next@12 some `@supports()` at-rules values become part of the styles ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

14.18.1

### What browser are you using?

Brave

### What operating system are you using?

macOS

### How are you deploying your application?

vercel

### Describe the Bug

The value of some supports-at-rules become part of the css-output, e.g.
```tsx
export default function IndexPage() {
  return (
    <div>
      <h1>Hello World.</h1>

      <style jsx global>{`
        @supports (display: flex) {
          h1 {
            color: hotpink;
          }
        }
      `}</style>
    </div>
  );
}
```

will output the following css:
```css
h1 {
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    color: hotpink;
}
```

It doesn't happen for every display value, for example `display: grid` works as expected, but there are likely more css rules affected.

### Expected Behavior

Obviously the value of a `@supports` at-rule should not become part of the css output.

### To Reproduce

1. visit this codesandbox: https://codesandbox.io/s/billowing-moon-xh6vi?file=/pages/index.js  
and go to step 4, or:

2. Install next@12.0.1 
3. create the following page:
```tsx
export default function IndexPage() {
  return (
    <div>
      <h1>Hello World.</h1>

      <style jsx>{`
        @supports (display: flex) {
          h1 {
            color: hotpink;
          }
        }
      `}</style>
    </div>
  );
}
```

4. inspect the title element
5. you should see the title element has `display: flex;`

",kdy1,kind: bug;area: SWC transforms,2021-10-28T17:20:18Z,2021-11-15T08:27:46Z,klaasman,balazsorban44,klaasman;timneutkens,timneutkens,kdy1,,timneutkens,
vercel/next.js,30592,"This is undefined in object getter ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

v14.18.0

### What browser are you using?

Chrome

### What operating system are you using?

MacOs Monterey

### How are you deploying your application?

Vercel

### Describe the Bug

I'm a getting a `TypeError` when reading a property from `this` inside an object's getter.
`this` is undefined when the object was returned by a function.



### Expected Behavior

`this` should not be undefined. This worked on v11.

### To Reproduce

Next@12 not working: https://replit.com/@francofantini/getter-bug
Next@11 working: https://replit.com/@francofantini/getter-bug-1


Steps:
1. Create an function that returns an object with a getter
```js
const navigation = (path) => [
  {
    name: ""Home"",
    href: `/`,
    get current() {
      return this.href === path;
    },
  },
  {
    name: ""Dashboard"",
    href: `/dashboard`,
    get current() {
      return this.href === path;
    },
  },
];
```

2. Try reading the getter from inside a component
```js
export default function Home() {
  // Works on the server, not on the client
  console.log(navigation('test')[0].current)
  return null;
}
```

3. The log gets output to the console, as this seems to work on the server

4. Error on the client
```
Unhandled Runtime Error
TypeError: Cannot read properties of undefined (reading 'href')
```",kdy1,kind: bug;type: needs investigation;area: SWC transforms,2021-10-29T03:34:19Z,2021-11-03T08:31:32Z,francofantini,balazsorban44,francofantini;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,30600,"next 12: False-Positive Build Error: ""Images cannot be imported within pages/_document.js"" ### What version of Next.js are you using?

12.0.1 and 12.0.2-canary.8

### What version of Node.js are you using?

14.17.6

### What browser are you using?

none

### What operating system are you using?

macOS

### How are you deploying your application?

none

### Describe the Bug

During build, this error shows up:

```
Images cannot be imported within pages/_document.js. Please move image imports that need to be displayed on every page into pages/_app.js.
Read more: https://nextjs.org/docs/messages/custom-document-image-import
Location: pages/_document.tsx
```

Note that we **do not** use `next/image`. We use our own webpack plugin based on `file-loader` to import images and copy them to the build output. It works fine in next.js 11 with webpack 5. We even have set `images.disableStaticImages:true` in next.config.js (even though that should not be necessary since we later might use next/image for some images except the ones in _document.tsx).

### Expected Behavior

It should compile fine.

### To Reproduce

* Add an image import to _document.tsx: `import favicon16 from 'static_hashed/img/touch-icons/favicon-16x16.png'`
* Do not use next/image
* Run `next build` or `next dev`

Note that we use the imported images for `<Head><link rel=""icon"">`:

Our webpack plugin should not be necessary to demonstrate the issue, but let us know if you need it.",styfle,kind: bug;area: next/image,2021-10-29T06:50:45Z,2021-11-02T20:25:13Z,fabb,stefanprobst;fabb;styfle;balazsorban44,fabb;timneutkens;styfle,styfle,styfle,,,
vercel/next.js,30631,"[i18n] i18n breaks optional catch-all route for index ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

Linux

### How are you deploying your application?

Vercel

### Describe the Bug

Seems the same issue as #19934. It seems this was resolved, but somewhere along the way it broke again.

We have a project with structure of pages/[userId]/social/[[...socialId]]:

- /user-123/social: does not work when it should.

- /user-123/social/social-123: work as expected 

- The issue only happens whenever the project is i18n configured.

If I revert the Next.js version to 10.0.5-canary.9, it works again.

### Expected Behavior

Both /user-123/social and /user-123/social/social-123 should work.

### To Reproduce

1. Go to [https://routing-test-peach.vercel.app](https://routing-test-peach.vercel.app)
2. Index page shows a 404 [ https://routing-test-peach.vercel.app/user-123/social](https://routing-test-peach.vercel.app/user-123/social)
3. Any other page will work [https://routing-test-peach.vercel.app/user-123/social/social-123](https://routing-test-peach.vercel.app/user-123/social/social-123)

Repo for reproduction: [https://github.com/expjazz/routing-test](https://github.com/expjazz/routing-test)",ijjk,kind: bug;area: Routing;area: I18n,2021-10-29T17:27:34Z,2022-02-02T19:02:04Z,expjazz,zkwsk;augustosamame;ijjk,expjazz;balazsorban44,balazsorban44,ijjk,,,
vercel/next.js,30683,"ambiguous Error During compile whole app  ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

14.0.0

### What browser are you using?

microsoft edge

### What operating system are you using?

windows 11

### How are you deploying your application?

next dev

### Describe the Bug

after compile my page it shows an error that said:
wait  - compiling...
thread '<unnamed>' panicked at 'not implemented: regenerator: complex pattern in catch clause', C:\Users\runneradmin\.cargo\registry\src\github.com-1ecc6299db9ec823\swc_ecma_transforms_compat-0.47.1\src\es2015\regenerator\case.rs:1232:30
error - ./pages/auth/index.tsx
Error: failed to process not implemented: regenerator: complex pattern in catch clause

maybe its cause by SWC but it so ambiquous and nothing help me to figure out what exactly caused this error !

### Expected Behavior

compiled my code without error because on next 11 we don't have this error

### To Reproduce

![image](https://user-images.githubusercontent.com/65160744/139573510-ec62576c-2b6f-41eb-bf6c-8fe469e42b78.png)
",kdy1,kind: bug;area: SWC transforms,2021-10-31T07:49:19Z,2021-11-03T08:31:32Z,pooooriya,pooooriya;Sridatta19;kdy1;balazsorban44;timneutkens;petrbela;matthewwolfe,pooooriya;timneutkens,timneutkens,,,timneutkens,
vercel/next.js,30710,"Invalid HMR message..Error: No router instance found. ??? ### What version of Next.js are you using?

12.0.1

### What version of Node.js are you using?

17.0.1

### What browser are you using?

Chrome / Safari

### What operating system are you using?

macOS

### How are you deploying your application?

dev

### Describe the Bug

While loading in locally developed npm packages, I get a weird warning in the console:
`[Warning] Invalid HMR message: {""action"":""sync"",""hash"":"""",""warnings"":[],""errors"":[]}
Error: No router instance found.
You should only use ""next/router"" on the client side of your app.
`

This current app is a test app that has no router instance anywhere, its just one page so the error doesn't really make sense. The npm package is adding styles to the _app.tsx (global style) and an Icon component to the index.tsx file.

Chrome gives the same warning only on initial load but the warning goes away after that

### Expected Behavior

The expected behaviour would be no hmr warning

### To Reproduce

Not sure how others can reproduce the error since its kinda random",sokra;ijjk,kind: bug;area: Compiler,2021-10-31T22:58:05Z,2021-11-21T14:42:20Z,snowytime,snowytime;flowck;skele2k;chandraaditya;theCocoonStudio;meness;WillSquire;abhinavkumar940;GitMazzone;ijjk;brianlovin;vallerydelexy;slevy85;SebHex;danielaliendo;wmcb91;ka2jun8;TszHong0411,snowytime;timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,30799,"styled-jsx issue with interpolation when SWC is enabled Report: [https://vercel.slack.com/archives/C0290CZ3U6Q/p1635502416198300?thread_ts=1635325628.111200&cid=C0290CZ3U6Q](https://vercel.slack.com/archives/C0290CZ3U6Q/p1635502416198300?thread_ts=1635325628.111200&cid=C0290CZ3U6Q)

@delbaoliveira  investigated it:

Hey鑱紷timneutkens So I narrowed their issue down. They are using an integer as a variable when combining the鑱絒https://github.com/vercel/styled-jsx#dynamic-styles](https://github.com/vercel/styled-jsx#dynamic-styles)鑱絘nd鑱絒https://github.com/vercel/styled-jsx#external-css-and-styles-outside-of-the-component](https://github.com/vercel/styled-jsx#external-css-and-styles-outside-of-the-component)鑱絪tyled-jsx features.

- Summary below and full reproduction here:鑱絒https://github.com/delbaoliveira/styled-1/blob/main/pages/index.js](https://github.com/delbaoliveira/styled-1/blob/main/pages/index.js)
- I am unsure if these combinations are supposed to work in SWC or if they unintentionally worked by chance in Babel

```
const paddingInt = 10
const paddingStr = ""10""

// 閴 babel
// 閴 swc
const Test1 = () => (
鑱<div>
鑱借伣<p>test 1</p>
鑱借伣<style jsx>{styles1}</style>
鑱</div>
)

const styles1 = css`
鑱絧 {
鑱借伣color: red;
鑱絵

鑱.something-else {
鑱借伣padding: ${paddingInt}px;
鑱絵
`
```

- Using an integer variable works with Babel but doesn't work in SWC
- Using a string as a variable works in both Babel and SWC

```
const paddingInt = 10

// 閴 babel
// 閴 swc
const Test2 = () => (
鑱<div>
鑱借伣<p>test 2</p>
鑱借伣<style jsx>{`
鑱借伣鑱絧 {
鑱借伣鑱借伣color: red;
鑱借伣鑱絵
鑱借伣鑱.something-else {
鑱借伣鑱借伣padding: ${paddingInt}px;
鑱借伣鑱絵
鑱借伣`}</style>
鑱</div>
)
```

- Using an integer in an inline style worked in both Babel and SWC

```
import { paddingStrExternal } from ""../lib/external""

// 閴 babel
// 閴 swc
const Test7 = () => (
鑱<div>
鑱借伣<p>test 7</p>
鑱借伣<style jsx>{styles7}</style>
鑱</div>
)

const styles7 = css`
鑱絧 {
鑱借伣color: red;
鑱絵
鑱.something-else {
鑱借伣padding: ${paddingStrExternal}px;
鑱絵
`
```

- Importing a string variable from another file did not work in SWC, but worked in Babel.

I also tested a few different variations like鑱絗css.resolve`鑱絯hich worked in both.",padmaia,kind: bug;area: SWC transforms,2021-11-02T11:34:43Z,2021-11-04T09:24:22Z,timneutkens,balazsorban44,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,30800,"Double const compiled to var instead of erroring From @sokra:

I noticed that SWC transpiles that:

```
const Thing = 1
const Thing = 2
```

to

```
var Thing = 1
var Thing = 2
```

but instead that should be an error as Thing is declared twice",kdy1,kind: bug;area: SWC transforms,2021-11-02T11:39:07Z,2021-12-20T10:55:27Z,timneutkens,balazsorban44,timneutkens,,timneutkens,,,
vercel/next.js,30801,"""for await"" regenerator transform breaks Reported here: [https://vercel.slack.com/archives/CGU8HUTUH/p1634933363100400?thread_ts=1634931484.096800&cid=CGU8HUTUH](https://vercel.slack.com/archives/CGU8HUTUH/p1634933363100400?thread_ts=1634931484.096800&cid=CGU8HUTUH)

Seems there is a bug with regenerator when using `for await`, at least from seeing the reported error.",kdy1,kind: bug;area: SWC transforms,2021-11-02T11:44:38Z,2022-09-26T08:52:33Z,timneutkens,kdy1,timneutkens,,timneutkens,,kdy1,
vercel/next.js,30839,"Next 12 Runtime TypeError: Class constructors cannot be invoked without 'new' ### What version of Next.js are you using?

12.0.2

### What version of Node.js are you using?

16.13.0

### What browser are you using?

Chrome 96

### What operating system are you using?

MacOS

### How are you deploying your application?

next start

### Describe the Bug

While updating my application from next 11 to 12 I ran into a runtime issue which I'm guessing is originating from the switch to SWC (?). I'm extending a Class and instantiating it, leading to a runtime error:

```javascript
Unhandled Runtime Error
TypeError: Class constructors cannot be invoked without 'new'
pages/index.tsx (7:15) @ new newClient

   5 | import { Client } from '@spree/storefront-api-v2-sdk';
   6 | 
>  7 | class newClient extends Client {
     |               ^
   8 |   constructor(config: any) {
   9 |     super(config);
  10 |   }
```

### Expected Behavior

The application should run / build successfully as it did in Next 11.

### To Reproduce

1. Install next 12 / typescript: `npx create-next-app@latest --typescript poc`
2. Apply patch to reproduce the issue:
   ```patch
   diff --git a/package.json b/package.json
   index 2f98703..e2de6ca 100644
   --- a/package.json
   +++ b/package.json
   @@ -8,6 +8,7 @@
        ""lint"": ""next lint""
      },
      ""dependencies"": {
   +    ""@spree/storefront-api-v2-sdk"": ""^4.11.0"",
        ""next"": ""12.0.2"",
        ""react"": ""17.0.2"",
        ""react-dom"": ""17.0.2""
   diff --git a/pages/index.tsx b/pages/index.tsx
   index 72a4a59..23e7ec6 100644
   --- a/pages/index.tsx
   +++ b/pages/index.tsx
   @@ -2,6 +2,17 @@ import type { NextPage } from 'next'
    import Head from 'next/head'
    import Image from 'next/image'
    import styles from '../styles/Home.module.css'
   +import { Client } from '@spree/storefront-api-v2-sdk';
   +
   +class newClient extends Client {
   +  constructor(config: any) {
   +    super(config);
   +  }
   +}
   +
   +const v2Client = new newClient({
   +  host: 'https://localhost:3000/',
   +});
   
    const Home: NextPage = () => {
      return (
   ```
3. install deps: `npm install`
4. start the development server (`npm dev`) and visit the site",kdy1,kind: bug;type: needs investigation;area: SWC transforms,2021-11-02T19:59:09Z,2021-11-10T09:06:05Z,jbergstroem,pboyer;Samin100;balazsorban44;timneutkens;jfmmm;jbergstroem;AryanJ-NYC;ijjk,jbergstroem;timneutkens;padmaia,padmaia,timneutkens,,,
vercel/next.js,30895,"Regression: `Cannot find module './data:image/svg+xml;utf8,<svg ...></svg>` for .scss file containing `background-image: url( data:...)` ### What version of Next.js are you using?

12.0.3.canary-2

### What version of Node.js are you using?

14.18.1

### What browser are you using?

Chrome (but not relevant)

### What operating system are you using?

macOS

### How are you deploying your application?

Not yet deployed

### Describe the Bug

As of Next.js 12.0.3-canary.2, this in a `.scss` file:
```scss
.myproj {
  ...

  &.outlined:not(.selected) {
    background-image: url(
      'data:image/svg+xml;utf8,' +
      '<svg xmlns=""http://www.w3.org/2000/svg"" width=""10"" height=""10"">' +
      '<rect fill=""gray"" width=""5"" height=""5"" y=""0"" x=""0"" />' +
      '</svg>'
    );
    background-repeat: repeat-x;
    background-size: 3px 3px;
    background-position: right 0 bottom .05em;
  }

  ...
}
```
causes `next build` to fail with:
```
./src/myproj/styles/index.module.scss
HookWebpackError: Cannot find module './data:image/svg+xml;utf8,<svg xmlns=""http:/www.w3.org/2000/svg"" width=""10"" height=""10""><rect fill=""gray"" width=""5"" height=""5"" y=""0"" x=""0"" /></svg>'
    at tryRunOrWebpackError (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:47140:9)
    at __webpack_require_module__ (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32948:12)
    at __nested_webpack_require_150254__ (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32905:18)
    at /Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32976:20
    at symbolIterator (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/neo-async/async.js:1:14452)
    at done (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/neo-async/async.js:1:14832)
    at Hook.eval [as callAsync] (eval at create (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:141008:10), <anonymous>:15:1)
    at /Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32883:43
    at symbolIterator (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/neo-async/async.js:1:14410)
    at timesSync (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/neo-async/async.js:1:5037)
-- inner error --
Error: Cannot find module './data:image/svg+xml;utf8,<svg xmlns=""http:/www.w3.org/2000/svg"" width=""10"" height=""10""><rect fill=""gray"" width=""5"" height=""5"" y=""0"" x=""0"" /></svg>'
    at webpackMissingModule (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/css-loader/src/index.js??ruleSet[1].rules[2].oneOf[6].use[1]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/postcss-loader/src/index.js??ruleSet[1].rules[2].oneOf[6].use[2]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/resolve-url-loader/index.js??ruleSet[1].rules[2].oneOf[6].use[3]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/sass-loader/cjs.js??ruleSet[1].rules[2].oneOf[6].use[4]!/Users/gthb/git/MYPROJ-client/src/myproj/styles/index.module.scss:4:106)
    at Object.<anonymous> (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/css-loader/src/index.js??ruleSet[1].rules[2].oneOf[6].use[1]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/postcss-loader/src/index.js??ruleSet[1].rules[2].oneOf[6].use[2]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/resolve-url-loader/index.js??ruleSet[1].rules[2].oneOf[6].use[3]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/sass-loader/cjs.js??ruleSet[1].rules[2].oneOf[6].use[4]!/Users/gthb/git/MYPROJ-client/src/myproj/styles/index.module.scss:4:344)
    at /Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:91484:11
    at Hook.eval [as call] (eval at create (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:140994:10), <anonymous>:7:1)
    at /Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32950:39
    at tryRunOrWebpackError (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:47135:7)
    at __webpack_require_module__ (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32948:12)
    at __nested_webpack_require_150254__ (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32905:18)
    at /Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/webpack/bundle5.js:32976:20
    at symbolIterator (/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/neo-async/async.js:1:14452)

Generated code for /Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/css-loader/src/index.js??ruleSet[1].rules[2].oneOf[6].use[1]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/postcss-loader/src/index.js??ruleSet[1].rules[2].oneOf[6].use[2]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/resolve-url-loader/index.js??ruleSet[1].rules[2].oneOf[6].use[3]!/Users/gthb/git/MYPROJ-client/node_modules/next/dist/compiled/sass-loader/cjs.js??ruleSet[1].rules[2].oneOf[6].use[4]!/Users/gthb/git/MYPROJ-client/src/myproj/styles/index.module.scss
  1 | // Imports
  2 | var ___CSS_LOADER_API_IMPORT___ = __webpack_require__(""/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/css-loader/src/runtime/api.js"");
  3 | var ___CSS_LOADER_GET_URL_IMPORT___ = __webpack_require__(""/Users/gthb/git/MYPROJ-client/node_modules/next/dist/build/webpack/loaders/css-loader/src/runtime/getUrl.js"");
  4 | var ___CSS_LOADER_URL_IMPORT_0___ = __webpack_require__(Object(function webpackMissingModule() { var e = new Error(""Cannot find module './data:image/svg+xml;utf8,<svg xmlns=\""http:/www.w3.org/2000/svg\"" width=\""10\"" height=\""10\""><rect fill=\""gray\"" width=\""5\"" height=\""5\"" y=\""0\"" x=\""0\"" /></svg>'""); e.code = 'MODULE_NOT_FOUND'; throw e; }()));
  5 | var ___CSS_LOADER_URL_IMPORT_1___ = __webpack_require__(Object(function webpackMissingModule() { var e = new Error(""Cannot find module './data:image/svg+xml;utf8,<svg xmlns=\""http:/www.w3.org/2000/svg\"" width=\""10\"" height=\""10\""><path fill=\""none\"" stroke=\""gray\"" stroke-width=\""2\"" d=\""M1,1 L9,9 M1,9 L9,1\""/></svg>'""); e.code = 'MODULE_NOT_FOUND'; throw e; }()));
  6 | var ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(false);
  7 | var ___CSS_LOADER_URL_REPLACEMENT_0___ = ___CSS_LOADER_GET_URL_IMPORT___(___CSS_LOADER_URL_IMPORT_0___);
  8 | var ___CSS_LOADER_URL_REPLACEMENT_1___ = ___CSS_LOADER_GET_URL_IMPORT___(___CSS_LOADER_URL_IMPORT_1___);
  9 | // Module
 10 | ___CSS_LOADER_EXPORT___.push([module.id, ""

// omitting lots of CSS that seems OK and not relevant, except here are all the rules containing LOADER, extracted with:
// pbpaste | rg -o --pcre2 '(?<=\})[^{]+\{[^}]+LOADER[^}]+\}' | pbcopy

.styles_editor__38BxS.styles_outlined__1i4Hx:not(.styles_selected__2b2R3){background-image:url("" + ___CSS_LOADER_URL_REPLACEMENT_0___ + "");background-repeat:repeat-x;background-size:3px 3px;background-position:right 0 bottom .05em}

.styles_dropdown__3SSSr select::-webkit-search-cancel-button{-webkit-appearance:none;height:1em;width:1em;margin-right:-3px;background-color:#f2f2f2;background-image:url("" + ___CSS_LOADER_URL_REPLACEMENT_1___ + "");background-repeat:no-repeat;background-position:center;background-size:8px 8px;border-radius:1em;cursor:pointer;z-index:1}

.styles_container__QCUb4 .styles_inputWrap__D2OqW input::-webkit-search-cancel-button{-webkit-appearance:none;height:1em;width:1em;margin-right:-3px;background-color:#f2f2f2;background-image:url("" + ___CSS_LOADER_URL_REPLACEMENT_1___ + "");background-repeat:no-repeat;background-position:center;background-size:8px 8px;border-radius:1em;cursor:pointer;z-index:1}

.styles_table__1yJJn .styles_filter__3RMh8 .styles_inputWrap__D2OqW input[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;height:1em;width:1em;margin-right:-3px;background-color:#f2f2f2;background-image:url("" + ___CSS_LOADER_URL_REPLACEMENT_1___ + "");background-repeat:no-repeat;background-position:center;background-size:8px 8px;border-radius:1em;cursor:pointer;z-index:1}

"", """"]);
 11 | // Exports
 12 | ___CSS_LOADER_EXPORT___.locals = {
 13 |   ""primaryPurple"": ""#583491"",
 14 |   ""purple50"": ""#7243bc"",
 15 |   ""purple70"": ""#aa8ed7"",
... etc. ...
 69 |   ""outlined"": ""styles_outlined__1i4Hx"",
... etc. ...
170 |   ""noui"": ""styles_noui__1jOmv"",
171 |   ""mathNotation"": ""styles_mathNotation__ryjXn""
172 | };
173 | module.exports = ___CSS_LOADER_EXPORT___;
```

This is fine in Next.js 12.0.3-canary.1 and in 12.0.2 (and has been fine in our Next.js build for a year), it only fails once 12.0.3-canary.2 is installed.

### Expected Behavior

`npm run build` succeeds on our project like in previous Next.js versions.

### To Reproduce

Extracting a clean repro case from our big closed-source project is taking some doing. Can you diagnose based on the above?",sokra,kind: bug,2021-11-03T15:04:25Z,2021-11-10T20:00:46Z,gthb,rtritto;esistgut;styfle;opolo;gthb;bbortt;ipy;balazsorban44,gthb;styfle,styfle,styfle,,styfle,
vercel/next.js,3091,"`next export` won't generate index.js for dynamic routes - [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

As stated in the title, for dynamic pages defined in the `exportPathMap` there are no generated `index.js` files. This brakes the next-router.
For example `http://blog.schoenwald.media/_next/a7725bcd-89fa-4f04-950c-54d296a9e9d9/page/tag/css/index.js`

As you can see here: 
- https://issue-3091.schoenwald-media.de
- https://github.com/schoenwaldnils/blog/tree/issue-3091
- [next.config.js](https://github.com/schoenwaldnils/blog/blob/issue-3091/next.config.js)
- [Travis build (see line 4069 and following)](https://travis-ci.org/schoenwaldnils/blog/builds/287982634)
- the generated files on gh-pages: https://github.com/schoenwaldnils/blog/tree/gh-pages

the generated pathMap:
```json
{
  ""/"": {
    ""page"": ""/"",
    ""query"": {
      ""posts"": [{
        ""id"": ""6uzkBYXsME0CiSwMI8isSY"",
        ""url"": ""/sticky-footer-with-flexbox""
      }, {
        ""id"": ""4iJ3AOLOmIqykMw4qAKw4Y"",
        ""url"": ""/hello-world""
      }]
    }
  },
  ""/imprint"": {
    ""page"": ""/page"",
    ""query"": {
      ""id"": ""5Wa2mgh3zOuku4GqOQEuAG""
    }
  },
  ""/about"": {
    ""page"": ""/page"",
    ""query"": {
      ""id"": ""yBv8udv1XqwkEMmew0Wwi""
    }
  },
  ""/sticky-footer-with-flexbox"": {
    ""page"": ""/page"",
    ""query"": {
      ""id"": ""6uzkBYXsME0CiSwMI8isSY""
    }
  },
  ""/hello-world"": {
    ""page"": ""/page"",
    ""query"": {
      ""id"": ""4iJ3AOLOmIqykMw4qAKw4Y""
    }
  },
  ""/tag/css"": {
    ""page"": ""/tag"",
    ""query"": {
      ""tag"": ""css"",
      ""tags"": [""css"", ""flexbox"", ""footer"", ""Hello"", ""world""],
      ""posts"": [{
        ""id"": ""6uzkBYXsME0CiSwMI8isSY"",
        ""url"": ""/sticky-footer-with-flexbox""
      }]
    }
  },
  ""/tag/Hello"": {
    ""page"": ""/tag"",
    ""query"": {
      ""tag"": ""Hello"",
      ""tags"": [""css"", ""flexbox"", ""footer"", ""Hello"", ""world""],
      ""posts"": [{
        ""id"": ""4iJ3AOLOmIqykMw4qAKw4Y"",
        ""url"": ""/hello-world""
      }]
    }
  },
  ""/tag/world"": {
    ""page"": ""/tag"",
    ""query"": {
      ""tag"": ""world"",
      ""tags"": [""css"", ""flexbox"", ""footer"", ""Hello"", ""world""],
      ""posts"": [{
        ""id"": ""4iJ3AOLOmIqykMw4qAKw4Y"",
        ""url"": ""/hello-world""
      }]
    }
  },
  ""/tag/footer"": {
    ""page"": ""/tag"",
    ""query"": {
      ""tag"": ""footer"",
      ""tags"": [""css"", ""flexbox"", ""footer"", ""Hello"", ""world""],
      ""posts"": [{
        ""id"": ""6uzkBYXsME0CiSwMI8isSY"",
        ""url"": ""/sticky-footer-with-flexbox""
      }]
    }
  },
  ""/tag/flexbox"": {
    ""page"": ""/tag"",
    ""query"": {
      ""tag"": ""flexbox"",
      ""tags"": [""css"", ""flexbox"", ""footer"", ""Hello"", ""world""],
      ""posts"": [{
        ""id"": ""6uzkBYXsME0CiSwMI8isSY"",
        ""url"": ""/sticky-footer-with-flexbox""
      }]
    }
  }
}
```

| Tech    | Version |
|---------|---------|
| next    |  ~4.0.3 |
| node    | 8.4.0 |
",timneutkens,kind: bug,2017-10-14T17:53:44Z,2018-05-29T09:50:46Z,schoenwaldnils,jacobpdq;timneutkens;schoenwaldnils,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,30953,"Middleware in API have a null body on POST Requests ### What version of Next.js are you using?

12.0.2

### What version of Node.js are you using?

v14.18.0

### What browser are you using?

Chrome

### What operating system are you using?

Linux

### How are you deploying your application?

next dev, next start, Vercel

### Describe the Bug

When sending a POST request that gets handled by middleware in the /pages/api folder, the request body is always null. 

So, in the client side (`/pages/index.tsx`) we have: 
```const sendPost = () => {
    fetch(""/api/middlewaretest"", {
      method: ""post"",
      body: JSON.stringify({ hello: ""world"" }),
      headers: { ""content-type"": ""application/json"" },
    })
      .then((res) => res.json())
      .then((res) => console.log(res))
      .catch((e) => {
        console.error(e);
      });
  };
```
  
In `/api/middlewaretest/_middleware.ts` we have:

```import type { NextFetchEvent, NextRequest } from ""next/server"";

export function middleware(req: NextRequest, ev: NextFetchEvent) {
  console.log(""method"", req.method); // will be post
  console.log(""bodyUsed"", req.bodyUsed); // will be false
  console.log(""headers"", req.headers); // shows proper content type and content length
  console.log(""body"", req.body); // always null!

  /***
   *
   * If middleware is async and I try any of the following:
   *
   * await res.json() // TypeError: invalid json body reason: Unexpected end of JSON input
   * await res.text() // blank string
   *
   */
  return new Response(JSON.stringify({ message: ""hello world!"" }), {
    status: 200,
    headers: {
      ""Content-Type"": ""application/json"",
    },
  });
}

```

### Expected Behavior

In https://nextjs.org/docs/api-reference/next/server#nextrequest it notes that `NextRequest` is an extension of the native `Request` interface which should provide a stream on `req.body` that could be read. However, it always comes across as null.

### To Reproduce

1. Clone `https://github.com/idreaminteractive/nextjs-middleware-body`
2. `yarn`
3. `yarn dev` (or `yarn build && yarn start`)
4. Goto `http://localhost:3000`
5. Press the `Send the post` button to trigger the middleware, check the console logs to see `req.body` is always null for a `POST` request.

The second button (Send the post to hello) is a regular NextJS API end point and works fine.",javivelasco;Schniz,kind: bug;area: Middleware,2021-11-04T13:23:50Z,2022-02-18T19:43:44Z,idreaminteractive,Kikobeats;mtt87;HeyImMatt;jessehalpern;Schniz,idreaminteractive;timneutkens;balazsorban44,balazsorban44,javivelasco,,,
vercel/next.js,30962,"next/script onLoad run once per cache Key (id, src) ### What version of Next.js are you using?

12.0.2

### What version of Node.js are you using?

14.18.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

codesandbox

### Describe the Bug

When using more than one `Script` with same `id` or `src`, only first script that complete load trigger the `onLoad` prop.
Same problem happens using one `Script` but after unmount and remount, for example when navigating throughout client-side router the `onLoad` will not be called.
@giorgiabosello

### Expected Behavior

`Script` component should load once the src script but run `onLoad` on component did mount and script is loaded.

### To Reproduce

https://codesandbox.io/s/nextjs-script-onload-ltm95",housseindjirdeh,kind: bug;area: next/script,2021-11-04T15:30:19Z,2022-07-28T20:42:53Z,bordeo,havran;giorgiabosello;housseindjirdeh;zacharyliu;bordeo;Zerebokep;eps1lon,bordeo;timneutkens;balazsorban44,balazsorban44,timneutkens;kara,kara,,
vercel/next.js,30984,"External scripts added with `next/script` load only once ### What version of Next.js are you using?

12.0.2

### What version of Node.js are you using?

14.17.6

### What browser are you using?

Chrome, Safari, Firefox

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

While trying to integrate external scripts with `next/script`, I noticed that they load only once on a page or component mount. I've created a quick [demo](https://external-script-routing.vercel.app) to describe it more visually.

### Expected Behavior

I expect the status to turn green every time I visit the page using website navigation links without reloading.

### To Reproduce

[Source](https://github.com/ndekross/external-script-routing)",housseindjirdeh,kind: bug;area: next/script,2021-11-04T20:56:21Z,2022-11-22T09:27:59Z,ndekross,housseindjirdeh;ndekross;bobbymart1n;balazsorban44,ndekross;timneutkens;balazsorban44,balazsorban44,timneutkens;kara,kara,balazsorban44,
vercel/next.js,31250,"Error `Objects are not valid as a React child (found: object with keys...` with `swcMinify: true` ### What version of Next.js are you using?

v12.0.3 and v12.0.4-canary.4

### What version of Node.js are you using?

v16.3.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next build && next start

### Describe the Bug

#### With **`swcMinify: false`** in `next.config.js`:
When running `next build && next start` or `next dev` , after opening `http://localhost:3000/` in the browser, everything works fine and is rendered correctly, there are no errors in the console.

#### With **`swcMinify: true`** in `next.config.js`:
- After running `next dev` and opening `http://localhost:3000/` in the browser everything is still working fine
- However running `next build && next start`, after opening `http://localhost:3000/` in the browser instead of the rendered page you see: `Application error: a client-side exception has occurred (see the browser console for more information).`, with the [following error in the console](https://gist.github.com/martinfrancois/d8d59f5c11acea980b997cb696f1d3c6). When decoded, it results in the following errors:
```
Objects are not valid as a React child (found: object with keys {Qr, RV, cI, Gc}). If you meant to render a collection of children, use an array instead.
Objects are not valid as a React child (found: object with keys {passive}). If you meant to render a collection of children, use an array instead.
```

### Expected Behavior

Having **`swcMinify: true`** in `next.config.js` should result in the same page being rendered after running `next build && next start` as when having **`swcMinify: false`** in `next.config.js` and should be rendered without any errors.

### To Reproduce

1. Clone https://github.com/martinfrancois/swc-minification-repro
2. `npm ci`
3. `npm run build`
4. `npm start`
5. Open http://localhost:3000/ in your browser.",kdy1,kind: bug;area: SWC Minify,2021-11-10T14:01:29Z,2022-01-10T10:37:32Z,martinfrancois,balazsorban44,martinfrancois;timneutkens,timneutkens,kdy1,,timneutkens,
vercel/next.js,31254,"New avif image larger than webp ### What version of Next.js are you using?

12.0.3

### What version of Node.js are you using?

v16.4.0

### What browser are you using?

Chrome

### What operating system are you using?

Mac (local dev environment)

### How are you deploying your application?

next start

### Describe the Bug

The new avif image format was introduced with ""enabling 20% smaller images compared to WebP."".

Unfortunately, my local tests show me the opposite.

**Example result:**

Avif: 96,4kb

<img width=""959"" alt=""Bildschirmfoto 2021-11-10 um 16 06 41"" src=""https://user-images.githubusercontent.com/6911678/141142280-d21aff51-57fa-4073-bf5f-1bacfd1dff14.png"">


Webp: 82,6kb

<img width=""953"" alt=""Bildschirmfoto 2021-11-10 um 16 06 17"" src=""https://user-images.githubusercontent.com/6911678/141142216-9f168bf3-b1ed-4463-b03b-695610225b6a.png"">


I know the efficiency of image compression algorithms depends on the image, that's why I tested this with multiple images. But I always had a similar result.

### Expected Behavior

The Avif Image should not be larger than the webp image.

### To Reproduce

### Short Version:
I created a example project to show this problem:
https://github.com/derweili/next-image-compression-test

1. Clone this repo: https://github.com/derweili/next-image-compression-test
2. Run `npm run build && npm run start`
3. Load the page in the Browser and check the image size via the dev tools (network tab)
4. Comment out line 7 of the next.config.js file
https://github.com/derweili/next-image-compression-test/blob/79c14ce248db4b9b00740ffd8307b98a327e4a50/next.config.js#L7
5. Run `npm run build && npm run start` again
6.  Load the page in the Browser and check the image size via the dev tools (network tab)
7. Compare both image sizes

### Manual version:

1. Create a new nextjs project using create-next-app
2. Add a random photo
3. Run `npm run build && npm run start`
4. Load the page in the Browser and check the image size via the dev tools (network tab)
5. Add avif support as described here: https://nextjs.org/blog/next-12#smaller-images-using-avif
6. Run `npm run build && npm run start` again
7. Load the page in the Browser and check the image size via the dev tools (network tab)
8. Compare both image sizes
",styfle,kind: bug;area: next/image,2021-11-10T15:31:23Z,2021-11-17T20:31:16Z,derweili,styfle;balazsorban44,derweili;timneutkens;styfle,styfle,styfle,,,
vercel/next.js,31291,"Optimisations no longer applied to `_buildManifest.js` when using SWC ### What version of Next.js are you using?

12.0.4-canary.4

### What version of Node.js are you using?

16.13.0

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

After enabling SWC I noticed that `buildManfest.json`'s output grew significantly (20kb閳80kb) because it is no longer using optimisations for chunk names, e.g: `self.__BUILD_MANIFEST=function(e,s,a,t,c,o,n,i,r,g,l,b,d,u,p,f,h,m,k)` 

```
// With SWC off:
ls -lh .next/static/JdI1kHMMIQ4b_kwr2NZiG/_buildManifest.js

-rw-r--r--  1 benschwarz  staff    26K 11 Nov 18:58 .next/static/JdI1kHMMIQ4b_kwr2NZiG/_buildManifest.js


// With SWC on: 
ls -lh .next/static/dtDJS-Od0qktpqIrQBB_S/_buildManifest.js

-rw-r--r--  1 benschwarz  staff    80K 11 Nov 18:51 .next/static/dtDJS-Od0qktpqIrQBB_S/_buildManifest.js
```

Over the wire (with Gzip compression) the file size difference isn't anywhere near as dramatic (Repeated strings are of course optimised by Gzip, so they both end up around 6kb), **but** there may be an impact to JS parse & compile times, which could compromise main thread performance for sites with many pages.

### Expected Behavior

Optimisations should be applied to `_buildManifest.js` to avoid a potential perf regression.

### To Reproduce

* Run `rm -rf .next`
* Run `next build`
* Observe size of `.next/static/<generatedHash>/_buildManifest.js` (small)
* Run `rm -rf .next`
* Turn on SWC using `swcMinify: true` in `next.config.json`
* Run `next build`
* Observe size of `.next/static/<generatedHash>/_buildManifest.js` (large)",kdy1,kind: bug;area: SWC Minify,2021-11-11T08:07:12Z,2021-11-20T19:25:52Z,benschwarz,kdy1;benschwarz;balazsorban44,benschwarz;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,31524,"_middleware.js/.ts files being included in client-side bundles ### What version of Next.js are you using?

12.0.3

### What version of Node.js are you using?

14.18.1

### What browser are you using?

Chome

### What operating system are you using?

OSX/Linux

### How are you deploying your application?

firebase

### Describe the Bug

When I attempt to use node packages intended for server-side use (i.e. 'firebase-functions') in my middleware, I get errors in the client pertaining to nodeJS native packages not being present.

When I do this, in the client when I load a page ""blocked"" by the defined middleware, I get the following error in the browser:
`Module not found: Can't resolve 'child_process'`

This happens w/ other node packages intended for server-side use.

### Expected Behavior

Should be able to use node packages in `_middleware.js/.ts` files since the understanding is that they're only intended for server-side processing of requests.

### To Reproduce

Create a `_middleware.ts` file somewhere.

```typescript
import { NextFetchEvent, NextRequest, NextResponse } from 'next/server'
import { logger } from 'firebase-functions'
export const middleware = async (req: NextRequest, ev: NextFetchEvent) => {
  logger.info('hello world')
  return NextResponse.next()
}
```

Attempt to visit a page ""blocked"" by said middleware in the browser.",javivelasco,kind: bug;area: Middleware,2021-11-17T00:06:51Z,2022-06-15T09:30:40Z,RavenHursT,ljosberinn;madhurjya-acko;RavenHursT;eric-burel;javivelasco,RavenHursT;timneutkens;balazsorban44;reconbot,balazsorban44,,,javivelasco,
vercel/next.js,3156,"HMR breaks when project is run out of a folder starting with ""."" <!--- Provide a general summary of the issue in the Title above -->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
Following the README.md instructions to run a next.js project, but create the project's folder in a subfolder which starts with a "".""

Changing the text in index.js should initiate a recompile which is reflected in the browser.

## Current Behavior
Next never recompiles after change are made to index.js. Must `ctrl+c` to quit, then run `npm run dev` again.

## Steps to Reproduce (for bugs)
Please review video here: https://www.youtube.com/watch?v=HfOiCxw6bKw&feature=youtu.be
note that the project is running out a folder "".nosync"" (because of this: https://discussions.apple.com/thread/6811420?start=0&tstart=0)

## Context
Simply trying out next. basic HMR is not working correctly.

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    |^4.1.3|
| node    |8.7.0|
| OS      |OSX 10.13|
| browser |Chrome 61|
| etc     |npm 5.4.2|
",timneutkens,kind: bug,2017-10-23T16:12:40Z,2018-09-04T15:20:30Z,dt1900,elmasse;NathanielHill,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,31562,"@media query interpolation broken in 12.0.4 ### What version of Next.js are you using?

12.0.4

### What version of Node.js are you using?

v16.11.0

### What browser are you using?

Chrome

### What operating system are you using?

Windows

### How are you deploying your application?

next dev

### Describe the Bug

PR #31407 fixed #30480 but introduced a new issue where interpolated strings in media queries are sometimes unnecessarily parenthesized.

Consider this, which used to work in 12.0.3 and before:

```ts
/// theme.ts

// Media Queries
export const Target: { [size in ScreenSizeQuery]: string } &
  { [prop in OtherQueries]: string } = {
  smallOnly: ""screen and (max-width: 580px)"",
  smallPlus: ""screen and (min-width: 580px)"",
  mediumPlus: ""screen and (min-width: 700px)"",
  largePlus: ""screen and (min-width: 900px)"",
  xlPlus: ""screen and (min-width: 1200px)"",
  touchScreen: ""(hover: none), (pointer: coarse)"",
};
```

And elsewhere in JSX:

```tsx
/// _app.tsx

// ...
      <style jsx global>{`
        html {
          font-size: ${Typography.base.size.default};
          line-height: ${Typography.base.lineHeight};
        }
        @media ${Target.mediumPlus} {
          html {
            font-size: ${Typography.base.size.mediumPlus};
          }
        }
        @media ${Target.largePlus} {
          html {
            font-size: ${Typography.base.size.largePlus};
          }
        }
      `}</style>
// ...
```

### Expected Behavior

This should compile into:

```css
            html {
                font-size: 16px;
                line-height: 1.75;
            }

            @media screen and (min-width: 700px) {
                html {
                    font-size:18px;
                }
            }

            @media screen and (min-width: 900px) {
                html {
                    font-size:21px;
                }
            }
```

### To Reproduce

Instead, in 12.0.4, it compiles into:

```css
html {font-size:16px; line-height:1.75}
@media (screen and (min-width: 700px)) {html {font-size:18px}}
@media (screen and (min-width: 900px)) {html {font-size:21px}}
```

Notably, this should be `@media screen and (min-width: 700px) {}` rather than `@media (screen and (min-width: 700px)) {}`.",kdy1,kind: bug;area: SWC transforms,2021-11-18T01:36:02Z,2021-12-16T11:23:32Z,Eyas,Eyas;balazsorban44,Eyas;timneutkens,timneutkens,kdy1,,timneutkens,
vercel/next.js,31627,"Wrong scope for `this` in functions inside classes with SWC compiler. ### What version of Next.js are you using?

12.0.4

### What version of Node.js are you using?

16.13.0

### What browser are you using?

Chrome

### What operating system are you using?

MacOS

### How are you deploying your application?

Irrelevant

### Describe the Bug

When turning on SWC for compilation, functions in classes get the wrong `this`. We have a lot of D3-code, where scoped function-`this` is used a lot. Upgrading to Next.js v12 with SWC we get `TypeError: this.querySelectorAll is not a function` from our D3 code. It looks like it only happens when the anonymous functions are contained in a class.

When adding a .babelrc to disable SWC, this runs just fine.

### Expected Behavior

This code should not crash.

### To Reproduce

I produced a minimal repro https://github.com/Jakst/d3-this-next-v12

Here's the relevant code
```javascript
import { useEffect } from 'react'
import { select, selectAll } from 'd3-selection'

export default function Home() {
  useEffect(() => {
    new MyClass()
  }, [])

  return (
    <svg>
      <g className=""group"">
        <path />
        <path />
      </g>

      <g className=""group"">
        <path />
        <path />
      </g>
    </svg>
  )
}

class MyClass {
  constructor() {
    selectAll('.group').each(function () {
      select(this).selectAll('path')
    })
  }
}
```

Visit a page with that component when SWC compilation is used and the rendering will crash.",kdy1,kind: bug;area: SWC transforms,2021-11-19T17:15:02Z,2021-11-20T19:25:52Z,jakst,balazsorban44,jakst;timneutkens,timneutkens,kdy1,,,
vercel/next.js,31803,"Middleware does not run when concurrentFeatures is enabled ### What version of Next.js are you using?

12.0.5-canary.9

### What version of Node.js are you using?

14.18.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

Middleware does not run and redirects user.

### Expected Behavior

Middleware should redirect to login page.

### To Reproduce

```
module.exports = {
  images: {
    deviceSizes: [640],
    domains: [""avatars.dicebear.com""],
    formats: [""image/avif"", ""image/webp""],
  },
  createRoot: true,
  swcMinify: false,
  experimental: {
    reactRoot: true,
    concurrentFeatures: true,
    serverComponents: true,
  },
};
```

_middleware.tsx
```
import type { NextRequest } from ""next/server"";
import { NextResponse } from ""next/server"";

export const middleware = (req: NextRequest) => {
  const cookie = req.cookies[""auth""];

  if (!cookie) {
    return NextResponse.redirect(""/login"");
  }
};
```",shuding;huozhi,kind: bug;area: Concurrent Features,2021-11-25T17:41:38Z,2022-06-28T21:01:11Z,saurabhguptarock,KlotzJesse;saurabhguptarock;huozhi,saurabhguptarock;timneutkens;balazsorban44,balazsorban44,shuding;huozhi,,huozhi,
vercel/next.js,31891,"Nextjs app crash at launch because of triples ### What version of Next.js are you using?

12.0.4

### What version of Node.js are you using?

v16.11.0

### What browser are you using?

Chrome

### What operating system are you using?

Android termux

### How are you deploying your application?

npm run dev

### Describe the Bug

I created my next app via : npx create-next-app

but when I navigate to my project and run : (npm run dev  ) the server will start but I will get this error also :
npm run dev

> dev
> next dev

ready - started server on 0.0.0.0:3000, url: http://localhost:3000
Watchpack Error (watcher): Error: EACCES: permission denied, watch '/data/data'
Watchpack Error (watcher): Error: EACCES: permission denied, watch '/data'
Watchpack Error (initial scan): Error: EACCES: permission denied, scandir '/data/data'
Watchpack Error (initial scan): Error: EACCES: permission denied, scandir '/data'
error - ./node_modules/next/dist/client/dev/amp-dev.js
TypeError: triples is not iterable
wait  - compiling...
Watchpack Error (watcher): Error: EACCES: permission denied, watch '/data/data'
Watchpack Error (watcher): Error: EACCES: permission denied, watch '/data'
Watchpack Error (initial scan): Error: EACCES: permission denied, scandir '/data/data'
Watchpack Error (initial scan): Error: EACCES: permission denied, scandir '/data'
error - ./node_modules/next/dist/client/dev/amp-dev.js
TypeError: triples is not iterable
<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: Unable to snapshot resolve dependencies
<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: Unable to snapshot resolve dependencies

________________________

But server is still running and when you try to open http://localhost:3000 on the browser I got this error in the browser: 
Internal Server Error



and this error in error in termux:

(node:6310) [DEP_WEBPACK_MODULE_ISSUER] DeprecationWarning: Module.issuer: Use new ModuleGraph API
(Use `node --trace-deprecation ...` to show where the warning was created)
Watchpack Error (watcher): Error: EACCES: permission denied, watch '/data/data'
Watchpack Error (watcher): Error: EACCES: permission denied, watch '/data'
Watchpack Error (initial scan): Error: EACCES: permission denied, scandir '/data/data'
Watchpack Error (initial scan): Error: EACCES: permission denied, scandir '/data'
wait  - compiling /_error...
error - ./node_modules/next/dist/client/dev/amp-dev.js
TypeError: triples is not iterable
error - Error: Cannot find module '/data/data/com.termux/files/home/next-express/.next/fallback-build-manifest.json'
Require stack:
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/utils.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/store.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/index.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/cli/next-dev.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/bin/next
Error: Cannot find module '/data/data/com.termux/files/home/next-express/.next/fallback-build-manifest.json'
Require stack:
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/utils.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/store.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/index.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/cli/next-dev.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/bin/next
    at Function.Module._resolveFilename (node:internal/modules/cjs/loader:933:15)
    at Function.mod._resolveFilename (/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/webpack/require-hook.js:171:28)
    at Function.Module._load (node:internal/modules/cjs/loader:778:27)
    at Module.require (node:internal/modules/cjs/loader:1005:19)
    at require (node:internal/modules/cjs/helpers:102:18)
    at Object.loadDefaultErrorComponents (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js:22:24)
    at DevServer.getFallbackErrorComponents (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/dev/next-dev-server.js:673:43)
    at async DevServer.renderErrorToResponse (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/next-server.js:1730:40)
    at async pipe.req.req (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/next-server.js:1670:30)
    at async DevServer.pipe (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/next-server.js:1148:25) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/utils.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/store.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/index.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/cli/next-dev.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/bin/next'
  ]
}
error - Error: Cannot find module '/data/data/com.termux/files/home/next-express/.next/fallback-build-manifest.json'
Require stack:
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/utils.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/store.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/index.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/cli/next-dev.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/bin/next
Error: Cannot find module '/data/data/com.termux/files/home/next-express/.next/fallback-build-manifest.json'
Require stack:
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/utils.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/store.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/index.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/cli/next-dev.js
- /data/data/com.termux/files/home/next-express/node_modules/next/dist/bin/next
    at Function.Module._resolveFilename (node:internal/modules/cjs/loader:933:15)
    at Function.mod._resolveFilename (/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/webpack/require-hook.js:171:28)
    at Function.Module._load (node:internal/modules/cjs/loader:778:27)
    at Module.require (node:internal/modules/cjs/loader:1005:19)
    at require (node:internal/modules/cjs/helpers:102:18)
    at Object.loadDefaultErrorComponents (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js:22:24)
    at DevServer.getFallbackErrorComponents (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/dev/next-dev-server.js:673:43)
    at async DevServer.renderErrorToResponse (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/next-server.js:1730:40)
    at async pipe.req.req (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/next-server.js:1670:30)
    at async DevServer.pipe (/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/next-server.js:1148:25) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/server/load-components.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/utils.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/store.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/build/output/index.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/cli/next-dev.js',
    '/data/data/com.termux/files/home/next-express/node_modules/next/dist/bin/next'
  ]
}
<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: Unable to snapshot resolve dependencies
<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: Unable to snapshot resolve dependencies
<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: Unable to snapshot resolve dependencies

Also the server still running on termux

### Expected Behavior

The app should work fine

### To Reproduce

npm run dev",padmaia,kind: bug;area: SWC transforms,2021-11-28T18:45:55Z,2021-11-30T00:05:35Z,melsiir,timneutkens;melsiir;padmaia;balazsorban44,melsiir;timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,31911,"Swipe on ionic menu doesn't works with swcMinify on start ### What version of Next.js are you using?

12.0.4

### What version of Node.js are you using?

16.13.0

### What browser are you using?

Chrome, Firefox

### What operating system are you using?

Windows 11

### How are you deploying your application?

Vercel, next start

### Describe the Bug

The swipe gesture of the '@ionic/react' menu only works in dev, when doing build and start stops working and blocks the animation of the menu. swcMinify option was enable in both cases.

The toggle button works in both dev and build.

Version
@ionic/react: ""^5.9.1""

### Expected Behavior

The swipe gesture should work correctly when doing build and start with the swcMinify option enabled

### To Reproduce

https://github.com/Josyto/next-swc-ionic-menu",kdy1,kind: bug;area: SWC Minify,2021-11-29T09:11:53Z,2022-01-10T10:37:32Z,Josyto,balazsorban44,Josyto;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,32133,"Tailwind JIT does not recompile  ### What version of Next.js are you using?

12.0.5

### What version of Node.js are you using?

16.13.0 but it happens on all versions

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

When using JIT mode in TailwindCSS styles are not regenerated.

### Expected Behavior

Styles are regenerated when editing pages / components.

### To Reproduce

I've added a failing test in #32130 which shows the issue. It only seems to happen when running the code in isolated outside of the repository. You can run `yarn testheadless test/development/basic/tailwind-jit.test.ts` to run the test.",sokra,kind: bug;area: Compiler;area: Ecosystem,2021-12-04T21:53:22Z,2021-12-15T15:29:02Z,timneutkens,timneutkens;Klin-Coders;brc-dd;balazsorban44,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,32302,"Middleware rewrites causing router.replace issue ### What version of Next.js are you using?

12.0.7

### What version of Node.js are you using?

17.0.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

We have a _middleware that rewrites requests on a special domain to ""_dashboard/<pathname>"". For example, loading ""dashboard.localhost:3000/example/page"" does a `NextResponse.rewrite('/_dashboard/example/page')`. Under the hood, we have a page at `pages/_dashboard/[...parts].tsx` to handle the request.

The issue comes from the main Next.js Container trying to do a `router.replace` with `href` equal to `/_dashboard/[...parts]` and `as` equal to `/example/page`, with the code causing that here: https://github.com/vercel/next.js/blob/d1a1a4c0f7561235394bdb1911f8a1c99ccdd237/packages/next/client/index.tsx#L213

That `router.replace` call runs into an error: https://nextjs.org/docs/messages/incompatible-href-as since the `as` and `href` don't match.

### Expected Behavior

I think the Container should call something like `router.replace('/_dashboard/example/page', '/_dashboard/example/page')`, though to be honest, I'm not 100% sure on how the router should work on domains where middleware is rewriting requests.

### To Reproduce

Repro: https://github.com/mmmulani/middleware-bug
`npm run dev` and then navigating to `http://localhost:3000/test` or `http://dashboard.localhost:3000/test` causes the error to show

Create a dynamic page that can be exported and serve it on a different domain using a middleware.

FWIW, it seems like this can be worked around by returning `{}` from `getInitialProps` on the page component.",javivelasco,kind: bug;area: Middleware,2021-12-08T20:54:50Z,2021-12-15T13:33:13Z,mmmulani,petrbela;balazsorban44,mmmulani;balazsorban44,balazsorban44,javivelasco,,,
vercel/next.js,32631,"Small memory leak inside trackWebVitalMetric ### What version of Next.js are you using?

12.0.7

### What version of Node.js are you using?

16.4.2

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

next start

### Describe the Bug

In `next/client/vitals.ts` there's a function `trackWebVitalMetric` which gets called on each navigation that will push a metric object onto the `metrics`-array. This causes a small memory leak, especially since this array is only used by an experimental hook `useExperimentalWebVitalsReport`.

### Expected Behavior

A) That the application doesn't contain any sudden memory leak
B) It would be good with an option that doesn't include experimental features

### To Reproduce

1. Have an example with at least a start page and a linked page
2. Navigate between the pages by using e.g., NextLink or use the browser back button
3. Note how the variable `metrics` will grow for each navigation",huozhi,kind: bug,2021-12-18T12:57:18Z,2022-02-01T20:48:08Z,westn,,westn;balazsorban44,balazsorban44,huozhi,,,
vercel/next.js,32774,"Next Image does not work properly when used in a horizontally scrolling container ### What version of Next.js are you using?

12.0.7

### What version of Node.js are you using?

16.13.0

### What browser are you using?

Chrome (Desktop and Android)

### What operating system are you using?

macOS Monterey and Android 12

### How are you deploying your application?

Vercel (broken when developing locally with yarn dev as well)

### Describe the Bug

There are two issues present:

I am using Next Image inside of a horizontally scrolling container and the `lazyBoundary` prop isn't working + on Android Chrome images will permanently disappear once scrolled away from.

Firstly, here is a video screenshot of the network tab in Chrome on desktop. Notice that images do not load until the image is literally in the viewport despite `lazyBoundary` being set to an arbitrarily high value (in this case 9000px). From what I understand from the docs, the syntax is similar to that of the CSS `margin` property. This means that I should be able to specify both a vertical and horizontal value via shorthand (ex: `500px 1000px`), correct?

https://user-images.githubusercontent.com/10248395/147284509-c4006eba-7203-4bbb-8f67-fcbcad131a8f.mov

Secondly (and way more critically) on Chrome for Android I experience the same `lazyBoundary` issue but also experience images completely disappearing after scrolling away from them and back to them.

https://user-images.githubusercontent.com/10248395/147284857-322ab2e0-e101-427b-9aca-235852a2b890.mov


This issue is present when deploying to Vercel as well as developing locally.




### Expected Behavior

The `lazyBoundary` property to be respected in a horizontal container and for images not to disappear on mobile

### To Reproduce

https://github.com/agusterodin/next-image-horizontal-scroll-bug-reproduction 

Present when running the project via yarn dev AND when deployed to Vercel.",styfle,kind: bug;area: next/image,2021-12-23T19:37:53Z,2022-01-25T13:54:16Z,agusterodin,nwongx;styfle;11koukou;hjaber;balazsorban44;agusterodin,agusterodin;balazsorban44;styfle,styfle,styfle,,balazsorban44,
vercel/next.js,32930,"outputStandalone breaking with middleware ### What version of Next.js are you using?

12.0.8-canary.13

### What version of Node.js are you using?

16.13.1

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

When using `experimental.outputStandalone` with middlewares, `yarn build` is breaking. since nft.json file is not generated for middleware. 

```bash
[Error: ENOENT: no such file or directory, open '~/next.js/examples/with-docker/.next/server/pages/_middleware.js.nft.json'] {
```

### Expected Behavior

`yarn build` to succeed and tracing files for middleware to be generated. 

### To Reproduce

create `pages/_middleware.js` in [with-docker](https://github.com/vercel/next.js/tree/c87204e/examples/with-docker) example and then `yarn build` is breaking


```js
import { NextResponse } from 'next/server'

export function middleware(req, ev) {
  return NextResponse.next()
}
```


",ijjk,kind: bug,2022-01-01T10:01:07Z,2022-01-04T00:47:19Z,nil1511,nil1511;balazsorban44,nil1511;styfle,styfle,styfle,,ijjk,
vercel/next.js,33005,"`next/jest` sets `NODE_ENV` to `'production'` ### Run `next info` (available from version 12.0.8 and up)

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:24 PDT 2021; root:xnu-8019.41.5~1/RELEASE_ARM64_T8101
    Binaries:
      Node: 14.17.6
      npm: 8.1.4
      Yarn: 1.22.15
      pnpm: N/A
    Relevant packages:
      next: 12.0.8-canary.17
      react: 17.0.2
      react-dom: 17.0.2

### What version of Next.js are you using?

12.0.8-canary.17

### What version of Node.js are you using?

14.17.6

### What browser are you using?

N/A

### What operating system are you using?

macOS 12.0.1 (21A559)

### How are you deploying your application?

N/A

### Describe the Bug

The `next/jest` preset sets `NODE_ENV` to `'production'`.

Users familiar with Jest will expect `NODE_ENV` to be `'test'` when running tests. The documentation says:
> Set to `'test'` if it's not already set to something else.

In this case, `NODE_ENV` is indeed set to `'test'` initially, but is replaced with `'production'`. I've verified this simply by console logging the environment in the test setup files, and again in a test. I did take a _quick_ look, but wasn't able to identify the cause.

This is related to #17032 and #17903.

### Expected Behavior

When running tests in Jest, `NODE_ENV` should be `'test'`.

### To Reproduce

Create a new app using the Jest example:
```sh
npx create-next-app --example with-jest with-jest-app
```

Add the following line to the example test:
```ts
// __tests__/index.test.tsx
console.log(process.env.NODE_ENV); // production
```

Run:
```sh
npm test
```",ijjk,kind: bug,2022-01-04T23:55:46Z,2022-01-05T15:22:22Z,mrmckeb,mrmckeb;franciscobonand;ijjk;balazsorban44,mrmckeb;styfle,styfle,styfle,,ijjk,
vercel/next.js,33265,"Video.js crash when SWC Minify is enabled ### Run `next info` (available from version 12.0.8 and up)

_No response_

### What version of Next.js are you using?

12.0.8

### What version of Node.js are you using?

any

### What browser are you using?

Chrome  97.0.4692.71

### What operating system are you using?

Windows11 & MacOS 12.1

### How are you deploying your application?

next start

### Describe the Bug
Run `next build && next start`, open the demo in any browser.
Click the play button, video can not play, and console shows the error: `VIDEOJS: ERROR: TypeError: Cannot read properties of null (reading 'playlistLoader')`


### Expected Behavior

Video plays with no errors.

### To Reproduce

Repo: https://github.com/cuyl/next-bug-with-swc-minify
Link: https://next-bug-with-swc-minify.vercel.app/
Open the link and click the play button, the error shows on the console.",kdy1,kind: bug;area: SWC Minify,2022-01-13T14:45:55Z,2022-01-19T08:15:46Z,cuyl,rtritto;cuyl;kdy1,cuyl;balazsorban44,balazsorban44,kdy1,,,
vercel/next.js,33283,"Next.js 12.0.8 breaks ""this"" in TS classes ### Run `next info` (available from version 12.0.8 and up)

Operating System:
       Platform: linux
      Arch: x64
      Version: #51~20.04.1-Ubuntu SMP Fri Jan 7 06:51:40 UTC 2022
    Binaries:
      Node: 16.13.2
      npm: 8.0.0
      Yarn: 1.22.17
      pnpm: N/A
    Relevant packages:
      next: 12.0.8
      react: 17.0.2
      react-dom: 17.0.2

### What version of Next.js are you using?

12.0.8

### What version of Node.js are you using?

16.13.2

### What browser are you using?

Chrome, Safari, Firefox

### What operating system are you using?

Android, IOS, macOS, Windows, Linux

### How are you deploying your application?

Vercel

### Describe the Bug

After upgrading Next.js from 12.0.7 to 12.0.8, an important system broke at our company.
TypeScript code that had classes like the example below broke, because `this` became `undefined`.
(check out ""To Reproduce"" section)

### Expected Behavior

I would expect `this` in a method to actually refer to the instance of the class and not be `undefined`.
(as also specified in [TS docs](https://www.typescriptlang.org/docs/handbook/2/classes.html#arrow-functions)) 

This code has been in the codebase for quite a while and has survived major Next.js releases, until this minor one :)

### To Reproduce

```
// example.ts
export default class Example {
  readonly status: string;

  constructor({ status }: { status: string }) {
    this.status = status;
  }

  public activate = async (data: string) => {
    // Some code...
    this.status // WHOOPS! Exception thrown - this undefined! (worked fine in 12.0.7)
  };
}
```

```
// index.ts
const example = new Example({ status: ""GOOD"" })
example.activate(""some string"");
```",kdy1,kind: bug;area: SWC transforms,2022-01-13T20:23:11Z,2022-01-14T11:54:02Z,VladimirMikulic,balazsorban44,VladimirMikulic;ijjk,ijjk,kdy1,,,
vercel/next.js,3330,"Syntax error on IE11 (or any browser without arrow-functions support) ## Expected Behavior
It should be possible to access the application with older browsers when running `next dev`.

## Current Behavior
IE11, for instance, throws a Syntax error when executing `main.js`.

## Steps to Reproduce (for bugs)
1. Install Next.js
2. Create a demo page
3. Run `next dev`
4. Access application using IE11

I've setup a repo to reproduce the bug: https://github.com/lucasconstantino/next-ie11-syntax-error

## Context
I'm having a hard time testing my application on IE11 locally.

## Your Environment
| Tech    | Version |
|---------|---------|
| next    | 4.1.4 |
| node    | 7.10.0 |
| OS      | any windows (tested on browserstack) |
| browser | IE11 |
",timneutkens,kind: bug,2017-11-24T14:11:32Z,2018-09-04T15:50:12Z,lucasconstantino,lucasconstantino;Jinnified;timneutkens;mgiraldo;kachkaev;yves-s,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,33463,"onLoadingComplete is being called several times when parent rerenders ### Run `next info` (available from version 12.0.8 and up)

_No response_

### What version of Next.js are you using?

12.0.3

### What version of Node.js are you using?

14.16.0

### What browser are you using?

Chrome

### What operating system are you using?

Windows

### How are you deploying your application?

Vercel

### Describe the Bug

If a parent rerenders, onLoadingComplete will be called several times, if onLoadingComplete sets a state this might cause an infinite loop.

### Expected Behavior

onLoadingComplete should be called only once

### To Reproduce

Add an element to an array onLoadingComplete to trigger a re-render

cc @styfle ",styfle,kind: bug;area: next/image,2022-01-19T14:57:58Z,2022-01-20T15:29:34Z,goncy,,goncy;timneutkens;balazsorban44,balazsorban44,styfle,,,
vercel/next.js,33476,"Regression in 12.0.8 for jest: TypeError: require.resolveWeak is not a function ### Run `next info` (available from version 12.0.8 and up)

    Operating System:
      Platform: win32
      Arch: x64
      Version: Windows 10 Enterprise
    Binaries:
      Node: 16.8.0
      npm: 7.21.0
      Yarn: 1.22.10
      pnpm: N/A
    Relevant packages:
      next: 12.0.8
      react: 17.0.2
      react-dom: 17.0.2

### What version of Next.js are you using?

12.0.8

### What version of Node.js are you using?

16.8.0

### What browser are you using?

Edge (Chromium)

### What operating system are you using?

Windows 11 Enterprise (by the way, why does next info say I am using Windows 10??)

### How are you deploying your application?

On Azure App Service as docker container

### Describe the Bug

We have a Next.js website where the unit tests are using Jest. When I try to upgrade the website from Next.js 12.0.7 to 12.0.8 the unit tests which test code that uses dynamic code loading start failing.

It looks to me this is related to this previously closed bug, which would make this a regression for Next.js 12.0.8: [TypeError: require.resolveWeak is not a function (jest test) #19862](https://github.com/vercel/next.js/issues/19862)

Example output
```
  閳 Test suite failed to run

    TypeError: require.resolveWeak is not a function

    > 29 | const HeaderSearchBoxMobile = dynamic(() => import('../HeaderSearchBox/HeaderSearchBoxMobile/HeaderSearchBoxMobile'));
```

### Expected Behavior

Tests should pass even if the code they test uses dynamic()

### To Reproduce

Run a Jest test where the test code tests some code that uses dynamic() to load some other code.",timneutkens,kind: bug;area: Compiler;area: Jest,2022-01-19T22:13:35Z,2022-02-08T14:02:54Z,zmarty,balazsorban44;Parnswir;duc-gp;PsyGik;timneutkens;ryparker;zmarty,zmarty;balazsorban44,balazsorban44,,,,vercel/next.js#19862;
vercel/next.js,33600,"next.js seems to be handling JS closures incorrectly ### Run `next info` (available from version 12.0.8 and up)

```
/bin/sh: pnpm: command not found

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.0.1: Tue Sep 14 20:56:24 PDT 2021; root:xnu-8019.30.61~4/RELEASE_ARM64_T6000
    Binaries:
      Node: 17.1.0
      npm: 8.1.2
      Yarn: 1.22.17
      pnpm: N/A
    Relevant packages:
      next: 12.0.9-canary.6
      react: 17.0.2
      react-dom: 17.0.2
```

### What version of Next.js are you using?

12.0.8

### What version of Node.js are you using?

v17.1.0

### What browser are you using?

Chrome

### What operating system are you using?

MacOS

### How are you deploying your application?

next run dev

### Describe the Bug

The following code executes differently in my browser than in next.js:

```
const myFunction = () => {
  for (let j = 0; j <= 3; j++) {
    for (const _ of []) {
    }

    if (j === 1) {
      console.log(""before set timeout, j is:"", j)

      setTimeout(() => {
        console.log(""in timeout: j is"", j)
      }, 50)
    }
  }

  return null
}

myFunction()
```

In my browser, this code correctly prints:

```
before set timeout, j is: 1
in timeout: j is 1
```

When I paste this into the top level of index.tsx, run `yarn run dev` and navigate my browser to localhost:3000, I see:

```
before set timeout, j is: 1
in timeout: j is 4
```

### Expected Behavior

I expected the output to be the same whether in browser console or in next.js.

### To Reproduce

1. Create a new next app with `npx create-next-app my-app`
2. Paste the code into pages/index.js
3. `yarn run dev` and look at the console",kdy1,kind: bug;area: SWC transforms,2022-01-24T08:37:55Z,2022-01-25T09:22:22Z,johnfn,johnfn,johnfn;balazsorban44,balazsorban44,kdy1,,,
vercel/next.js,33809,"next/image produces invalid HTML according to W3C (again) ### Run `next info` (available from version 12.0.8 and up)

    Operating System:
      Platform: linux
      Arch: x64
      Version: #29-Ubuntu SMP Wed Jan 12 17:36:47 UTC 2022
    Binaries:
      Node: 16.13.2
      npm: 8.3.2
      Yarn: 1.22.15
      pnpm: 6.11.0
    Relevant packages:
      next: 12.0.9
      react: 17.0.2
      react-dom: 17.0.2

### What version of Next.js are you using?

12.0.9

### What version of Node.js are you using?

16.13.2

### What browser are you using?

N/A

### What operating system are you using?

N/A

### How are you deploying your application?

N/A

### Describe the Bug

Using `next@12.0.7` yields no invalid HTML errors on the [W3C Markup Validation Service](https://validator.w3.org/) about `next/image`.

After upgrading to `next@12.0.9`, there is now this kind of error:

```txt
Error: Bad value data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 version=%271.1%27 width=%271000%27 height=%271000%27/%3e 
for attribute src on element img: Illegal character in scheme data: space is not allowed.
```

![image](https://user-images.githubusercontent.com/25207499/151701974-9545dfdc-b27b-47a4-91db-69cdb0849155.png)

There was already an error similar to this one before but that has been fixed: #18850
We might add a new e2e test or CI job to ensure that next produces valid HTML according to W3C, so it's not happening again as it is the case now...

### Expected Behavior

No errors. Valid HTML according to W3C.

### To Reproduce

1. `npx create-next-app --example image-component image-app`
2. `cd image-app`
3. `npm run build`
4. `npm run start`
5. Go to `localhost:3000` and copy/paste the HTML in [The W3C Markup Validation Service](https://validator.w3.org/) or use the [
html-w3c-validator CLI](https://github.com/Divlo/html-w3c-validator).",styfle,kind: bug;area: next/image,2022-01-30T13:38:34Z,2022-02-01T00:13:47Z,Divlo,Divlo;sokra,Divlo;balazsorban44,balazsorban44,styfle,,styfle,
vercel/next.js,33860,"""ENOENT: no such file or directory"" - next.js crashes, related to image caching? ### Run `next info` (available from version 12.0.8 and up)

```
root@1d90163fc150:/app# npx --no-install next info
/bin/sh: 1: pnpm: not found

    Operating System:
      Platform: linux
      Arch: x64
      Version: #1 SMP Debian 4.19.171-2 (2021-01-30)
    Binaries:
      Node: 17.4.0
      npm: 8.3.1
      Yarn: 1.22.17
      pnpm: N/A
    Relevant packages:
      next: 12.0.10
      react: 17.0.2
      react-dom: 17.0.2
```

### What version of Next.js are you using?

12.0.10

### What version of Node.js are you using?

17.4.0

### What browser are you using?

Chrome

### What operating system are you using?

Debian 

### How are you deploying your application?

next build

### Describe the Bug

Upgraded my site to next.js 12.0.10 and with the new release started getting errors;

```
today at 2:27:38 PMready - started server on 0.0.0.0:3000, url: http://localhost:3000
today at 2:27:38 PMinfo  - Loaded env from /app/.env.production
today at 2:27:38 PMinfo  - Loaded env from /app/.env
today at 2:27:39 PMwarn  - SWC minify beta enabled. https://nextjs.org/docs/messages/swc-minify-enabled
today at 2:37:32 PMError: ENOENT: no such file or directory, open '/app/.next/cache/images/iLU6LIXA6TCl8SepFjJ5LNbyzLiOqZ7U49T1Ftm+jW4=/0.1643714865404.blKDVxGlp5+pf7TBeZBnD7i-BF2A5hQCHH0jGL--cVU=.avif'
```

and then next server dies and restarts

### Expected Behavior

shouldn't be crashing.

### To Reproduce

any code with avif + image caching support i guess",styfle,kind: bug;area: next/image,2022-02-01T11:46:51Z,2022-02-02T21:27:56Z,bonesoul,bonesoul;ghost;yayza;ijjk;gngo2018;shyamsukhamit;andersonba;havran;joggienl;tm1000;derkoe;MobinX;icflorescu;quocthangit247;styfle;b-novikov-ipersonality;danielGz,bonesoul;styfle,styfle,styfle,,,
vercel/next.js,34134,"`Error: Cannot find module './image-optimizer'` from serverless functions (12.0.11-canary.10) ### Run `next info` (available from version 12.0.8 and up)

```
Operating System:
  Platform: darwin
  Arch: arm64
  Version: Darwin Kernel Version 21.3.0: Wed Jan  5 21:37:58 PST 2022; root:xnu-8019.80.24~20/RELEASE_ARM64_T8101
Binaries:
  Node: 16.13.2
  npm: 8.1.2
  Yarn: 1.22.17
  pnpm: N/A
Relevant packages:
  next: 12.0.11-canary.10
  react: 17.0.2
  react-dom: 17.0.2
```

### What version of Next.js are you using?

12.0.11-canary.10

### What version of Node.js are you using?

16.13.2 (14.x on Vercel)

### What browser are you using?

Chrome

### What operating system are you using?

macOS

### How are you deploying your application?

Vercel

### Describe the Bug

After upgrading from 12.0.11-canary.9 to canary.10, I'm getting 500 errors from many of my serverless functions (and SSR pages) and this exception in the logs:

```
2022-02-09T16:23:26.321Z	undefined	ERROR	Uncaught Exception 	{""errorType"":""Runtime.ImportModuleError"",""errorMessage"":""Error: Cannot find module './image-optimizer'
Require stack:
- /var/task/node_modules/next/dist/server/next-server.js
- /var/task/___next_launcher.js
- /var/runtime/UserFunction.js
- /var/runtime/index.js"",""stack"":[""Runtime.ImportModuleError: Error: Cannot find module './image-optimizer'"",""Require stack:"",""- /var/task/node_modules/next/dist/server/next-server.js"",""- /var/task/___next_launcher.js"",""- /var/runtime/UserFunction.js"",""- /var/runtime/index.js"",""    at _loadUserApp (/var/runtime/UserFunction.js:202:13)"",""    at Object.module.exports.load (/var/runtime/UserFunction.js:242:17)"",""    at Object.<anonymous> (/var/runtime/index.js:43:30)"",""    at Module._compile (internal/modules/cjs/loader.js:1085:14)"",""    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1114:10)"",""    at Module.load (internal/modules/cjs/loader.js:950:32)"",""    at Function.Module._load (internal/modules/cjs/loader.js:790:12)"",""    at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)"",""    at internal/main/run_main_module.js:17:47""]}
Unknown application error occurred
Runtime.ImportModuleError
```

I assume this has to do with #34075 ? I'm not doing any image processing in these functions but maybe I'm doing something else crazy and unsupported... Source code and logs are linked to below.

Thanks in advance!

### Expected Behavior

No `image-optimizer` errors where images aren't being optimized would be my first thought, but not familiar enough with what's going on in #34075 to make a more educated guess... 棣冩У

### To Reproduce

My source code is public and a good example is at:

https://github.com/jakejarvis/jarv.is/blob/dependabot/npm_and_yarn/next-12.0.11-canary.10/pages/feed.xml.ts

I believe my Vercel logs are public too, if you try to request this page at: https://jarvis-git-dependabot-npmandyarnnext-12011-canary10-jakejarvis.vercel.app/feed.xml 

...and view the logs at https://vercel.com/jakejarvis/jarvis/AG74op91Fv9CnaHZDeJETjvg8XtS/functions

---

edit: Forgot to add that I'm not getting this error locally with `next dev`, which makes sense but thought I should mention it.",ijjk,kind: bug;area: standalone mode,2022-02-09T16:36:08Z,2022-02-09T18:37:56Z,jakejarvis,ijjk;jakejarvis,jakejarvis;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,34807,"Image component change animated files to static ones ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

'yarn' is not recognized as an internal or external command,
operable program or batch file.
'pnpm' is not recognized as an internal or external command,
operable program or batch file.

    Operating System:
      Platform: win32
      Arch: x64
      Version: Windows 10 Home
    Binaries:
      Node: 14.18.1
      npm: 7.20.3
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 12.1.0
      react: 17.0.2
      react-dom: 17.0.2

### What browser are you using? (if relevant)

All main web browsers except Safari (I don't have Safari).

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I have a component for animited photos and I use <Image />. When this one show animated photo, I have static one, but when I change on <img />, the files are animited (e. g. eyes are moving). 

For example: https://pronama.jp/images/animated.png

### Expected Behavior

When Image get animited files (apng, gif or animited webp and avif), Image should know this isn't static photo, yet animited one, so files should move. That files should be converting to avif or webp when web browser support that formats, especially gif format.

Gif format must be converted to avif, webp or apng format by the performance of that format.

### To Reproduce

I change to img tag: it work.
I added ""unoptimized"": it work too.
I added Image without unoptimized: it doesn't work.

I wanted to add apng or gif format in next.config file, but I get the same errors:""
Error: Specified images.formats must be length 1 or 2, received length (3), please reduce the length of the array to continue.

or

Error: Specified images.formats should be an Array of mime type strings, received invalid values (image/apng).
""
""image/apng"" is in headers request.

My components for images: https://github.com/jukialen/portal_for_artists_in_next/blob/main/components/atoms/Photos/Photos.tsx
My next.config:
https://github.com/jukialen/portal_for_artists_in_next/blob/main/next.config.js",styfle,kind: bug;area: next/image,2022-02-25T12:11:53Z,2022-03-07T20:29:12Z,jukialen,styfle;jukialen;Yuripetusko;nikitindiz,jukialen;balazsorban44;styfle,styfle,styfle,,,
vercel/next.js,34809,"unstable_revalidate errors when returning notFound: true  ### What is the improvement or update you wish to see?

Please, describe in the documentation how to remove a page that returns 404.

### Is there any context that might help us understand?


Suppose i have the page /pages/post/[slug].tsx with

getStaticProps
```
export const getStaticProps: GetStaticProps = async ({ params }) => {
  let slug = params.slug;
  const post = await getPostFromWordpress(slug);
  if (!post) {
    return {
      notFound: true
    };
  }
  return {
    props: {
      post
    }
  };
};
```
and getStaticPaths
```
export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getPostFromWordpress();

  return {
    paths: posts .map(post => `/post/${post.slug}`) || [],
    fallback: 'blocking'
  };
};
```

And also i have an api route: /api/wordpress/revalidate:

```
export default async function handler(req, res) {

  if (req.query.secret !== process.env.MY_SECRET_TOKEN) {
    return res.status(401).json({ message: 'Invalid token' })
  }

  try {
    await res.unstable_revalidate(`/post/${req.query.slug}`)
    return res.json({ revalidated: true })
  } catch (err) {
    return res.status(500).send(err.message)
  }
}
```

From client side i can click ""Delete post"". After clicking the button, the post is deleted in Wordpress.
When I delete a post in Wordpress I call this api route /api/wordpress/revalidate?secret=<secret>&slug=some_slug, but I am getting an error ""Failed to revalidate /post/some_slug"".

This happens because {notFound: true } is returned from getStaticProps

https://github.com/vercel/next.js/blob/3d5dd58251a9ffd47741a7c81061fc71a9246621/packages/next/server/api-utils/node.ts#L310-L324

and res.ok = false

Please, describe in the documentation how to delete /pages/post/some_slug?

### Does the docs page already exist? Please link to it.

https://nextjs.org/blog/next-12-1#on-demand-incremental-static-regeneration-beta",ijjk,kind: bug;area: Routing,2022-02-25T15:34:23Z,2022-02-25T22:17:07Z,musme,ijjk;musme;ramiel,musme;ijjk,ijjk,ijjk,,ijjk,
vercel/next.js,34880,"state reset ""// @refresh reset"" for fast refresh does not work as supposed ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information


```
Operating System:
 Platform: linux
 Arch: x64
 Version: 1 SMP Debian 4.19.208-1 (2021-09-29)
Binaries:
 Node: 16.13.0
 npm: 8.1.0
 Yarn: N/A
 pnpm: N/A
Relevant packages:
 next: 12.1.0
 react: 17.0.2
 react-dom: 17.0.2
```
### What browser are you using? (if relevant)

chrome

### How are you deploying your application? (if relevant)

next dev

### Describe the Bug

Quote from the [NextJS Documentation](https://nextjs.org/docs/basic-features/fast-refresh):
> Sometimes you might want to force the state to be reset, and a component to be remounted. For example, this can be handy if you're tweaking an animation that only happens on mount. To do this, you can add `// @refresh reset` anywhere in the file you're editing...

Fast Refresh does not reset and remount the component when `// @refresh reset` is added anywhere in the file i am editing.

### Expected Behavior

Fast Refresh should reload the component every time i edit the file.

### To Reproduce

1. Problem can be reproduced by replacing the code of index.tsx with the following code in a clean nextjs typescript project.

```typescript
// @refresh reset

import { useState } from ""react"";

export default function Home() {
  const [foo, setFoo] = useState(false);
  console.log(foo);

  if (!foo) setFoo(true);

  return (<div />);
}
```
2. Run the nextjs in dev environment.
3. Modify code in index.tsx and safe.
```typescript
// @refresh reset

import { useState } from ""react"";

export default function Home() {
  const [foo, setFoo] = useState(false);
  console.log(foo);

  if (!foo) setFoo(true);

  // new line to trigger fast refresh
  return (<div />);
}
```
4. Console Output on client side.
>false
true
[Fast Refresh] rebuilding
[Fast Refresh] done in 614ms
true
5. As suggested in the in the [NextJS Documentation](https://nextjs.org/docs/basic-features/fast-refresh) the desired output should be.
>false
true
[Fast Refresh] rebuilding
[Fast Refresh] done in 614ms
false
true

The state in the component does not reset after editing the file. This Error is derifed from a [help request](https://github.com/vercel/next.js/discussions/34775) i wrote in the nextjs discussion. I am using the braintree-web package which adds an iframe. After editing the client side throws an error.

> Uncaught (in promise) BraintreeError {name: 'BraintreeError', code: 'HOSTED_FIELDS_FIELD_DUPLICATE_IFRAME', message: 'Element already contains a Braintree iframe.', type: 'MERCHANT', details: {閳}}

This problem can be fixed by reloading the page on error:
```typescript
catch (error) {
  if (error instanceof Error) {
    // is this a braintree error
    if (error.name === 'BraintreeError') {
      // force page reload because of fast refresh problem
      const braintreeError = error as unknown as BraintreeError;
      if (braintreeError.code === 'HOSTED_FIELDS_FIELD_DUPLICATE_IFRAME') {
        Router.reload();
      }
    }
  }
}
```
The component, state or better the page should be forcefully reload everytime i edit the file. This is no big problem because it only happens in a development environment, but it is kind of anoying.

Do i miss something or is this a bug?",kdy1,kind: bug;area: SWC transforms,2022-02-28T10:12:52Z,2022-10-15T16:25:01Z,LaCocoRoco,vcheeney;balazsorban44;alexjball;LaCocoRoco,LaCocoRoco;balazsorban44,balazsorban44,kdy1,,LaCocoRoco,
vercel/next.js,34970,"Image cache is not preserved between vercel deployments for images with absolute external src URL ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

Happening at least on Next v12.1.0 and v12.1.1-canary.5 deployed to Vercel

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 20.6.0: Wed Jan 12 22:22:45 PST 2022; root:xnu-7195.141.19~2/RELEASE_ARM64_T8101
    Binaries:
      Node: 16.11.1
      npm: 8.0.0
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 12.1.1-canary.5
      react: 17.0.2
      react-dom: 17.0.2

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

Vercel

### Describe the Bug

Images optimized with next Image component and default cached on Vercel are not preserved when the `src` attribute is an external URL (i.e. images from images.unsplash.com). After each deployment, for those images, for the first request, the CDN will respond with a `x-vercel-cache: MISS` header.

In contrary this is not happening when an image has a relative `src` URL (i.e. from public folder). In this case the CDN will respond with HIT or STALE even after a deployment.

The image-optimization docs also state that images should be preserved between deployments (https://vercel.com/docs/concepts/image-optimization#usage). See note:
> Even if you redeploy, images cached in /_next/image / /_vercel/image will be preserved.

In other parts of the docs it is said that caches are purged on each deploy. But this seems not to be the case for images in `/_next/image` following the docs mentioned above and actually experiencing that images with a relative URL are actually cached between deployments.

As far as I understand the setup it should not make a difference where the original image comes from. Because the images are optimized and those newly created images are cached in the app.

### Expected Behavior

Image cache for images with absolute external src URL should be cached between deployments. The same way as it happens for images with a relative src URL.

### To Reproduce

I created a test next application which renders two images. One with a local image and one with an external image: https://github.com/rumtraubenuss/vercel-image-cdn-bug

Clone the repo and deploy it to vercel.

Open network dev tools. Make sure to check `Disable cache`. Open the deployed application. Follow the link on the index page. I had to put the images on a second page, otherwise the page preview image in the vercel UI would act as a cache warmer since it requests the actual deployment to render the preview image.

On the page `/cats` you will see two images. Inspect the dev tools network and have a look at the response headers for the two images: For the very first time you open the page for both images the CDN responds with a MISS. Subsequent request (reload the page) will get HIT or STALE responds for both images.

Deploy the app again (you can use the Redeploy option in the vercel UI) wait until it is deployed. Reload the application page. You will see that the local image will have a HIT or STALE, the one with the external URL will have a MISS and therefore take much longer time to render.

Locally I checked the folder `.next/cache/images` and it seems that both kind of images are written to it. So I don't understand why the external URL images are not preserved between deployments.

I tested this with several external images (not only from unsplash) and it was everytime the same behavior.",styfle,kind: bug;area: next/image,2022-03-02T15:13:18Z,2022-03-09T00:15:50Z,rumtraubenuss,styfle,rumtraubenuss;balazsorban44;styfle,styfle,styfle,,,
vercel/next.js,35074,"swcMinify breaks build with react-text-transition package ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

Operating System:
  Platform: darwin
  Arch: x64
  Version: Darwin Kernel Version 21.4.0: Sat Jan 29 03:25:23 PST 2022; root:xnu-8020.100.417.0.4~31/RELEASE_X86_64
Binaries:
  Node: 14.17.0
  npm: 8.5.2
  Yarn: N/A
  pnpm: N/A
Relevant packages:
  next: 12.1.0
  react: 17.0.2
  react-dom: 17.0.2

### What browser are you using? (if relevant)

Chrome 98.0.4758.109

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

When using `swcMinify: true` with package `react-text-transition` - it breaks application.

### Expected Behavior

Working build

### To Reproduce

```js
import { useState, useEffect } from 'react';
import TextTransition, { presets } from 'react-text-transition';

const titleTexts = ['Test', 'Test2', 'Test3', 'Test4', 'Test5'];

const Example = () => {
  const [index, setIndex] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => setIndex((index) => index + 1), 1 * 3000);

    return () => clearTimeout(intervalId);
  }, []);

  return (
    <TextTransition
      text={titleTexts[index % titleTexts.length]}
      springConfig={presets.gentle}
      inline={true}
    />
  );
};


export default Example;
```",kdy1,kind: bug;area: SWC Minify,2022-03-05T11:49:01Z,2022-04-17T10:54:52Z,ch3rn1k,balazsorban44;kdy1,ch3rn1k;balazsorban44,balazsorban44,kdy1,kdy1,kdy1,
vercel/next.js,3511,"TypeScript JSX support for _document If using TypeScript with ""preserve"" which generates ""jsx"" files, you cannot define _document as the framework looks for a _document.js and not _document.jsx.",timneutkens,kind: bug,2017-12-28T16:05:49Z,2018-01-30T15:40:53Z,jatsrt,jatsrt;corydeppen;timneutkens,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,35115,"The `config` arg should not be passed to user-defined `loader` function in `next/image ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

Operating System:        
      Platform: win32        
      Arch: x64
      Version: Windows 10 Pro
    Binaries:
      Node: 14.17.6
      npm: 6.14.15
      Yarn: 1.22.17
      pnpm: N/A
    Relevant packages:       
      next: 12.1.0
      react: 17.0.2
      react-dom: 17.0.2    

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

The bug for next.config.js not considered for node_modeles was discussed here: [https://github.com/vercel/next.js/issues/31065](url)

**Fixed in PR**:[https://github.com/vercel/next.js/pull/33559](url)

After the above fix when trying to build the next app the `config` argument passed in the custom loader function resolves to the default next variables.


### Expected Behavior

The config argument in the loader function should return the variables configured in the next.config.js coming from the node_modules when trying to build the app statically.

### To Reproduce

1) Create the next app
2) The app should use a next.config.js for the 3rd party packages inside node_modules that import next/image(which uses a custom loader function).
3) Build the app `next build`

The config argument in the loader function returns default next.config variables set by vercel.",styfle,kind: bug;area: next/image,2022-03-07T16:42:23Z,2022-04-08T22:19:26Z,sc-addypathania,ambrauer;styfle,sc-addypathania;balazsorban44;styfle,styfle,styfle,,,vercel/next.js#31065;
vercel/next.js,3527,"next/head unsetting _document <title> I'm trying to add a custom Social component to my site that adds several relevant meta tags, but it's setting the `<title>` to an empty string. I have the title defined in `_document.js` and don't change it anywhere else in the codebase. I'm running the Canary version of Next.js

```javascript
import Document, { Head, Main, NextScript } from 'next/document'
export default class CustomDocument extends Document {
  static async getInitialProps (ctx) {
    return await Document.getInitialProps(ctx)
  }

  render () {
    return (
      <html lang=""en"">
        <Head>
          <meta httpEquiv=""X-UA-Compatible"" content=""IE=edge"" />
          <meta name=""viewport"" content=""width=device-width, initial-scale=1"" />
          <title>Website Title</title>
        </Head>
        <body>
          <Main />
          <NextScript />
        </body>
      </html>
    )
  }
}
```

The custom component I call looks like this:

```javascript
import Head from 'next/head'

export default ({ title, image, description, url }) => (
  <Head>
    <meta key=""twitter-card"" name=""twitter:card"" content=""summary"" />
    <meta key=""twitter-site"" name=""twitter:site"" content=""@ianmitchel1"" />
    <meta key=""twitter-title"" name=""twitter:title"" content={title} />
    <meta key=""twitter-description"" name=""twitter:description"" content={description} />
    <meta key=""twitter-image"" name=""twitter:image"" content={image} />
    <meta key=""twitter-url"" name=""twitter:url"" content={url} />

    <meta key=""facebook-type"" property=""og:type"" content=""article"" />
    <meta key=""facebook-title"" property=""og:title"" content={title} />
    <meta key=""facebook-description"" property=""og:description"" content={description} />
    <meta key=""facebook-image"" property=""og:image"" content={image} />
    <meta key=""facebook-url"" property=""og:url"" content={url} />
  </Head>
)
```

It adds all the meta tags correctly (not sure if it's related, but I needed to add the `key` parameter - otherwise only the second set of meta tags was added) and the other meta tags from `_document.js` remain intact, but somehow the title tag just becomes `<title></title>`.

I've created a small example here - https://next-title-pnxpfydvvh.now.sh",timneutkens,kind: bug,2018-01-02T18:14:08Z,2018-06-13T12:36:34Z,IanMitchell,gsimone;gihrig;JonathonJulian;wdifruscio;ewagstaff;timneutkens;Sekhmet;remy;mzzfederico;felipekm,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,3533,"`next build` on canary using full path in transpiled require statements <!--- Provide a general summary of the issue in the Title above -->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
<!--- If you're describing a bug, tell us what should happen -->
<!--- If you're suggesting a change/improvement, tell us how it should work -->
`next build` does not include absolute path to node module

## Current Behavior
<!--- If describing a bug, tell us what happens instead of the expected behavior -->
<!--- If suggesting a change/improvement, explain the difference from current behavior -->
`next build` includes absolute path in transpiled require path

## Steps to Reproduce (for bugs)
### Correct
```sh
yarn add next@4.2.0
next build

# Transpiled output
var _extends2 = require('babel-runtime/helpers/extends');
```

### Incorrect
```sh
yarn add next@canary
next build

# Transpiled output
var _extends2 = require('/Users/kyle/projects/test/node_modules/babel-runtime/helpers/extends');
```

## Context
<!--- How has this issue affected you? What are you trying to accomplish? -->
<!--- Providing context helps us come up with a solution that is most useful in the real world -->
Unable to deploy to lambda using [up](https://github.com/apex/up) due to `up` building locally and uploading zip file to s3 rendering absolute paths invalid

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    |   canary      |
| node    |    8.9.0     |
| OS      |     macos 10.13.2    |

  ",timneutkens,kind: bug,2018-01-04T19:47:05Z,2018-02-06T12:09:42Z,kylealwyn,mrtnzlml;juancampa;timneutkens,timneutkens,,timneutkens,,arunoda,
vercel/next.js,35514,"Content-length header missing from NextJS optimized images ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

Platform: win32
      Arch: x64
      Version: Windows 10 Pro
    Binaries:
      Node: 16.13.1
      npm: 8.3.0
      Yarn: 3.1.1
      pnpm: N/A
    Relevant packages:
      next: 12.1.0
      react: 17.0.2
      react-dom: 17.0.2

### What browser are you using? (if relevant)

Firefox

### How are you deploying your application? (if relevant)

98.0.1

### Describe the Bug

Image served through cdn domain has a content-length image that doesnt get passed after its optimized by next/image.

Example: https://sittingonclouds.net/cdn/album/2199.png https://www.sittingonclouds.net/_next/image?url=https%3A%2F%2Fcdn.sittingonclouds.net%2Falbum%2F2199.png&w=1920&q=75

### Expected Behavior

Content-length header on next/image images.

### To Reproduce

Included examples on bug description",styfle,kind: bug;area: next/image,2022-03-22T04:01:40Z,2022-04-30T01:50:42Z,jorgev259,kobayashi90;styfle,jorgev259;styfle,styfle,styfle,,,
vercel/next.js,35572,"Next (canary) does not support the upcoming TypeScript 4.7 NodeNext/Node12 moduleResolution ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information


    Operating System:
      Platform: linux
      Arch: x64
      Version: #1 SMP Mon Nov 8 10:21:19 UTC 2021
    Binaries:
      Node: 17.6.0
      npm: 8.5.1
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 12.1.1-canary.17
      react: 17.0.2
      react-dom: 17.0.2

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

TypeScript have [added support](https://github.com/microsoft/TypeScript/issues/33079#issuecomment-1043271180) for package exports in the upcoming 1.4.7 release. This has included releasing a new module option called [node12](https://github.com/microsoft/TypeScript/issues/46452). However in order to use this feature (and upcoming ESM features) `moduleResolution` needs to be set to `NodeNext` or `Node12`. 

This is not possible to do in a next project, because Next changes it back to `node` at build time. Meaning users of Next are not able to use TypeScript's upcoming features.

NextJS Output:
```
We detected TypeScript in your project and reconfigured your tsconfig.json file for you. Strict-mode is set to false by default.

The following mandatory changes were made to your tsconfig.json:

        - moduleResolution was set to node (to match webpack resolution)
```

### Expected Behavior

Node12 and NodeNext to be supported in Next so I can make use of [package exports](https://nodejs.org/api/packages.html#exports) in my other dependencies. 

### To Reproduce

- Add `""typescript"": ""4.7.0-dev.20220322""` to your package.json assuming you're already using typescript.
- Set `moduleResolution` to `Node12` or `NodeNext`",styfle,kind: bug;area: TypeScript,2022-03-24T12:56:15Z,2022-04-15T17:09:13Z,jasonwilliams,DovydasNavickas;jasonwilliams,jasonwilliams;timneutkens;balazsorban44,timneutkens,styfle,,,
vercel/next.js,35661,"Emotion with SWC does not work with next/jest (Next 12.1.1) ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

```
Operating System:
  Platform: darwin
  Arch: x64
  Version: Darwin Kernel Version 20.6.0: Wed Jan 12 22:22:42 PST 2022; root:xnu-7195.141.19~2/RELEASE_X86_64
Binaries:
  Node: 16.13.2
  npm: 8.1.2
  Yarn: 1.22.17
  pnpm: N/A
Relevant packages:
  next: 12.1.1
  react: 17.0.2
  react-dom: 17.0.2
```

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I've upgraded my next.js app to 12.1.1 and have enabled SWC and emotion in my next config via the `experimental: {emotion: true}` option

My `jest.config.js` file looks like this:

```js
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  dir: './src',
});

const customJestConfig = {};

module.exports = createJestConfig(customJestConfig);
```

I have a component that uses the nested emotion selector that looks like this:

```js
const Results = styled.div`
  margin: 0;
  padding: 0;
`;

const Container = styled.div`
  ${Results}:first-of-type {
    border-bottom: 1px solid #000;
  }
`;
```

When I run the app using `next dev` or build with `next build` everything works, the SWC plugin is correctly able to handle the nested selectors. But when I run `jest`, it errors out with:

```
console.error
  Error: Uncaught [Error: Component selectors can only be used in conjunction with @emotion/babel-plugin.]
```

### Expected Behavior

`next/jest` correctly configures the swc emotion transform when `experimental: {emotion: true}` is set in the next config file

### To Reproduce

I've set up a simple repo based on the `with-emotion-swc` example: https://github.com/pgrippi/nextjs-emotion-swc-jest-bug

* Clone repo
* `yarn install`
* `yarn test` to see the jest failure
* `yarn dev` / `yarn build` to see that the application works",Brooooooklyn,kind: bug;area: SWC transforms,2022-03-28T13:05:58Z,2022-04-28T02:09:49Z,pgrippi,pgrippi;balazsorban44,pgrippi;balazsorban44,balazsorban44,Brooooooklyn,,,
vercel/next.js,35693,"Emotion interpolation bug ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.3.0: Wed Jan  5 21:37:58 PST 2022; root:xnu-8019.80.24~20/RELEASE_X86_64
    Binaries:
      Node: 16.14.0
      npm: 8.3.1
      Yarn: 1.22.10
      pnpm: N/A
    Relevant packages:
      next: 12.1.2
      react: 17.0.2
      react-dom: 17.0.2

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

```ts
const shadowBorder = ({ width = '1px', color }) =>
  css`
    box-shadow: inset 0px 0px 0px ${width} ${color};
  `;

const StyledInput = styled.input`
  ${shadowBorder({ color: 'red', width: '4px' })}
`;
```

results

![image](https://user-images.githubusercontent.com/18535812/160596526-205058e2-afad-426c-b692-ca1a15763d3d.png)

The space before the first interpolation was removed.

### Expected Behavior

The space is not removed before the first interpolation so the result is:

```css
box-shadow: inset 0px 0px 0px 4px gray;
```

### To Reproduce

- Clone this repo: https://github.com/gubi995/nextjs-emotion-interpolation-bug
- npm i
- npm run dev
- Inspect the input element's style",Brooooooklyn,kind: bug;area: SWC transforms,2022-03-29T11:02:33Z,2022-03-30T13:14:31Z,gubi995,,gubi995;balazsorban44,balazsorban44,Brooooooklyn,,timneutkens,
vercel/next.js,35703,"Fast Refresh does not work @latest ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information


    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.3.0: Wed Jan  5 21:37:58 PST 2022; root:xnu-8019.80.24~20/RELEASE_ARM64_T8101
    Binaries:
      Node: 17.5.0
      npm: 8.4.1
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 12.1.2
      react: 18.0.0
      react-dom: 18.0.0

warn  - Latest canary version not detected, detected: ""12.1.2"", newest: ""12.1.3-canary.0"".
        Please try the latest canary version (`npm install next@canary`) to confirm the issue still exists before creating a new issue.
        Read more - https://nextjs.org/docs/messages/opening-an-issue

### What browser are you using? (if relevant)

Chrome 99.0.4844.83 (Official Build) (arm64)

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Just installed a new project with `npx create-next-app@latest`, and fast refresh is not working. 

### Expected Behavior

For the browser to refresh when I save a change in my code editor.

### To Reproduce

`npx create-next-app@latest`

start project with `npm run dev`",timneutkens,kind: bug;area: Compiler,2022-03-29T18:41:37Z,2022-03-30T12:16:19Z,kasperaamodt,kasperaamodt;diegohaz;timneutkens;ghocevar;gleno;lordkerwin;CarlosLevir;bryanbarrios;djxy;caestrada,kasperaamodt;ijjk,ijjk,timneutkens,,,
vercel/next.js,3575,"<Head> content rendered in reverse order than declared When rendering content to the `<Head>` component, I found out the order of the Head content is actually reverse than what I expected.

## Expected Behavior

I'd assume when declaring a `<Head>` inside the `_document.js` file, this content would show before content declared inside components further in the page lifecycle.

## Current Behavior

Right now it seems `<Head>` content is being shifted. So tags declared later are being rendered first in the head.

## Context

This can cause issues when trying to define resources to preload if scripts like GA or GTM are being executed first by the browser.

## Your Environment

| Tech    | Version |
|---------|---------|
| next    |   ^4.1.4      |
| node    |  6 and 8       |
| OS      |   Ubuntu      |
| browser |   chrome      |
",timneutkens,kind: bug,2018-01-15T11:09:51Z,2018-12-10T22:40:43Z,SBoudrias,pddigital;SBoudrias;Enalmada;yeou;hugotox;kachkaev;lfades;alexandregiordanelli;emileber;shreks7;timneutkens;JerryCauser;matheussampaio,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,35811,"cannot read properties of undefined on swcMinify I've been getting these kind of errors poping up a lot when using swcMinify on version `12.1.2`

```
Cannot read properties of undefined (reading 'lib')
```

FYI this was working in the previous version. `12.1.0`

The error was happening in auth0.js, cryptojs & I also experienced it in styled-components.

I found this reference to the error and disabling swcMinify does fix it.

https://github.com/brix/crypto-js/issues/415

_Originally posted by @moshie in https://github.com/vercel/next.js/discussions/30237#discussioncomment-2484107_",kdy1,kind: bug;please add a complete reproduction;area: SWC Minify,2022-04-01T08:28:43Z,2022-04-15T14:34:34Z,moshie,balazsorban44;moshie;kdy1,balazsorban44,,kdy1,,,
vercel/next.js,36151,"Non ascii char can not be use parameter type with destructuring ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

```
    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.2.0: Sun Nov 28 20:28:41 PST 2021; root:xnu-8019.61.5~1/RELEASE_ARM64_T6000
    Binaries:
      Node: 16.14.0
      npm: 8.3.1
      Yarn: 3.2.0
      pnpm: 6.32.4
    Relevant packages:
      next: 12.1.6-canary.0
      react: 18.0.0
      react-dom: 18.0.0
```

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

<img width=""1019"" alt=""image"" src=""https://user-images.githubusercontent.com/97939463/163384170-004b15df-0619-4de1-a927-be63f6b8ca9d.png"">

```
type 鐪 = {
  name: string;
  value: string;
};

export const SomeComponent = ({ name, value }: 鐪) => {
  return (
    <div>
      {name} {value}
    </div>
  );
};
```

### Expected Behavior

Not met errors

### To Reproduce

https://github.com/flex-jonghyen/reproduce-bug",kdy1,kind: bug;area: SWC transforms,2022-04-14T11:45:48Z,2022-04-22T07:20:44Z,flex-jonghyen,hg-pyun;timneutkens;flex-jonghyen;kdy1,flex-jonghyen;timneutkens,timneutkens,kdy1,,timneutkens,
vercel/next.js,36636,"dynamic import with `suspense:true, ssr:false` causes `The server could not finish this Suspense boundary` error ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

```
Operating System:
  Platform: darwin
  Arch: arm64
  Version: Darwin Kernel Version 21.2.0: Sun Nov 28 20:28:41 PST 2021; root:xnu-8019.61.5~1/RELEASE_ARM64_T6000
Binaries:
  Node: 16.14.2
  npm: 8.1.4
  Yarn: 1.22.1
  pnpm: 6.32.4
Relevant packages:
  next: 12.1.6-canary.16
  react: 18.1.0
  react-dom: 18.1.0
```

### Describe the Bug

Using dynamic component import with `{suspense: true, ssr:false}` cause this error: 
```
Error: The server could not finish this Suspense boundary, likely due to an error during server rendering. Switched to client rendering.
```

![image](https://user-images.githubusercontent.com/8813276/166362901-5c2059fe-91a5-4290-b476-3cafbdd7d455.png)


**Important Note:** functionally this works correctly, the issue is just that an error is being generated and so it appears broken

### Expected Behavior

Should work without any error popup or error in browser console

### To Reproduce

#### Runable reproduction: https://codesandbox.io/s/dank-sound-pkxopr?file=/pages/index.js

```tsx
import { Suspense } from ""react"";
import dynamic from ""next/dynamic"";

const Thing = dynamic(() => import(""../thing""), { ssr: false, suspense: true });

export default function IndexPage() {
  return (
    <div>
      <p>Next.js Example</p>
      <Suspense fallback=""Loading..."">
        <Thing />
      </Suspense>
    </div>
  );
}
```

```tsx
//thing.js
export default function Thing() {
  return ""Thing"";
}
```

### Other

You can also cause this same behavior with this next.js page:

```tsx
import { Suspense } from ""react"";

export default function Thing() {
  if (typeof window === 'undefined') {
    const e = new error()
    e.name = ""rendering suspense fallback...""
    delete e.stack
    throw e
  } 
  return ""Thing""
}

export default function IndexPage() {
  return (
    <div>
      <p>Next.js Example</p>
      <Suspense fallback=""Loading..."">
        <Thing />
      </Suspense>
    </div>
  );
}
```
",Brooooooklyn,kind: bug;template: bug,2022-05-03T00:38:41Z,2022-06-01T11:44:31Z,flybayer,huozhi;flybayer;graup;bkyerv;shkreios;timneutkens;sidwebworks,flybayer;Brooooooklyn,,Brooooooklyn,,huozhi,
vercel/next.js,36639,"Missing @next/swc-freebsd-x64 package ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

    Operating System:
      Platform: freebsd
      Arch: x64
      Version: FreeBSD 13.0-RELEASE-p11 #0: Tue Apr  5 18:54:35 UTC 2022     root@amd64-builder.daemonology.net:/usr/obj/usr/src/amd64.amd64/sys/GENERIC
    Binaries:
      Node: 16.13.0
      npm: 8.5.2
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 12.1.6
      react: 18.1.0
      react-dom: 18.1.0


### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Trying to run `next build` on FreeBSD produces the following error and the project is not built:
``` 
warn  - Attempted to load @next/swc-freebsd-x64, but it was not installed
error - Failed to load SWC binary for freebsd/x64, see more info here: https://nextjs.org/docs/messages/failed-loading-swc
```
The issue is that such package doesn't exist, so it cannot be installed.

### Expected Behavior

The package is found and installed.

### To Reproduce

Simply try to build a next.js app on FreeBSD.",Brooooooklyn,kind: bug;area: SWC transforms,2022-05-03T09:18:54Z,2022-05-11T16:20:05Z,alexdupre,Brooooooklyn;alexdupre;mantoze;ismatim;ijjk,alexdupre;balazsorban44,balazsorban44,Brooooooklyn,,,
vercel/next.js,36681,"[BUG] ImageComponent does not work when combine `trailingSlash` and `basePath` ### Verify canary release

- [X] I verified that the issue exists in Next.js canary release

### Provide environment information

```
    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.4.0: Fri Mar 18 00:46:32 PDT 2022; root:xnu-8020.101.4~15/RELEASE_ARM64_T6000
    Binaries:
      Node: 16.14.2
      npm: 7.24.2
      Yarn: 1.22.17
      pnpm: 6.27.1
    Relevant packages:
      next: 12.1.7-canary.1
      react: 17.0.2
      react-dom: 17.0.2
```

### What browser are you using? (if relevant)

Microsoft Edge Version 101.0.1210.32 (Official build) (arm64)

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

When we combine `basePath` with `trailingSlash`, the `next/image` component does not applies the correct `src` and `srcSet`.

It always generates `/_next/...` instead `/<base-path>/_next/...`.

That leads to images not loading properly.

### Expected Behavior

Add the `basePath` into the generated `src` and `srcSets` so the image can be loaded properly.

### To Reproduce

1. clone this project: https://github.com/raulfdm/next-basepath-trailing-image-bug
3. install the dependencies `npm install`
4. run the server `npm run dev`
5. open the app at [`http://localhost:3001/docs/`](http://localhost:3001/docs/)
6. see the image component failing
7. press the button that adds the base path
8. the image should be properly displayed

If you run `npm build && npm start`, the image will still be broken.",styfle,kind: bug;area: next/image,2022-05-04T15:35:43Z,2022-12-23T23:04:27Z,raulfdm,bigsml;styfle;PGuimarais;fbarrailla;nmalyarsky,raulfdm;balazsorban44;styfle,styfle,styfle,,,
vercel/next.js,3716,"Can't remove x-powered-by header in Next 5 <!--- Provide a general summary of the issue in the Title above -->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
<!--- If you're describing a bug, tell us what should happen -->
<!--- If you're suggesting a change/improvement, tell us how it should work -->

The recent change in Next.js 5.0.0 removed the `poweredByHeader` options from `next.config.js` and [instructs the user](https://github.com/zeit/next.js/blob/canary/errors/powered-by-header-option-removed.md) to remove it in their custom server.

## Current Behavior
<!--- If describing a bug, tell us what happens instead of the expected behavior -->
<!--- If suggesting a change/improvement, explain the difference from current behavior -->
X-Powered-By header cannot be removed or overwritten in custom Express or Koa server.

## Steps to Reproduce (for bugs)
<!--- Provide a link to a live example, or an unambiguous set of steps to -->
<!--- reproduce this bug. Include code to reproduce, if relevant -->
Tested using Express & Koa examples.

### Express
https://custom-server-express-nobxbpklyw.now.sh

```JS
const port = parseInt(process.env.PORT, 10) || 3000
const dev = process.env.NODE_ENV !== 'production'
const app = next({ dev })
const handle = app.getRequestHandler()

app.prepare()
.then(() => {
  const server = express()

  server.get('/a', (req, res) => {
    return app.render(req, res, '/b', req.query)
  })

  server.get('/b', (req, res) => {
    return app.render(req, res, '/a', req.query)
  })

  server.get('/posts/:id', (req, res) => {
    return app.render(req, res, '/posts', { id: req.params.id })
  })

  server.get('*', (req, res) => {
    res.removeHeader('x-powered-by')
    return handle(req, res)
  })

  server.listen(port, (err) => {
    if (err) throw err
    console.log(`> Ready on http://localhost:${port}`)
  })
})
```

### Koa
https://custom-server-koa-wxksegmzhf.now.sh

```JS
const Koa = require('koa')
const next = require('next')
const Router = require('koa-router')

const port = parseInt(process.env.PORT, 10) || 3000
const dev = process.env.NODE_ENV !== 'production'
const app = next({ dev })
const handle = app.getRequestHandler()

app.prepare()
.then(() => {
  const server = new Koa()
  const router = new Router()

  router.get('/a', async ctx => {
    await app.render(ctx.req, ctx.res, '/b', ctx.query)
    ctx.respond = false
  })

  router.get('/b', async ctx => {
    await app.render(ctx.req, ctx.res, '/a', ctx.query)
    ctx.respond = false
  })

  router.get('*', async ctx => {
    await handle(ctx.req, ctx.res)
    ctx.respond = false
  })

  server.use(async (ctx, next) => {
    ctx.res.statusCode = 200
    ctx.response.remove('X-Powered-By')
    await next()
  })

  server.use(router.routes())
  server.listen(port, (err) => {
    if (err) throw err
    console.log(`> Ready on http://localhost:${port}`)
  })
})

```

## Context
<!--- How has this issue affected you? What are you trying to accomplish? -->
<!--- Providing context helps us come up with a solution that is most useful in the real world -->

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    |     5.0.0    |
| node    |    8.8.1     |
| OS      |   macOS 10.13.3      |
| browser |   Chrome      |
",timneutkens,kind: bug,2018-02-06T18:17:49Z,2018-02-14T17:02:49Z,timteeling,ericmai624;bryan;JeromeFitz;ericat;timneutkens;arunoda;timteeling;oliviertassinari;rauchg;julmot,arunoda,,timneutkens,,timneutkens,
vercel/next.js,3775,"Dynamic import() fails in next 5.xx <!--- Provide a general summary of the issue in the Title above -->
I have been using this piece of code to asynchronously load one of heavy component on my client side. It was working like a charm:

`
const DynamicChart = dynamic(
    import('../components/LineChart/LineChart'),
    {
        loading: () => <SectionPlaceholder><Loader /></SectionPlaceholder>,
        ssr: false,
    },
);
`

Since update to v5.0.0 I get webpack error, but only when I open the parent page from frontend route. When I directly load from server, it get's loaded. When I get it once (from first load) and go back to this page on frontend, it works too.

This is the error I get:
![image](https://user-images.githubusercontent.com/9268745/36093000-8e62f87e-0fe9-11e8-9023-cc8f1f391b59.png)

I tried `import(...).then(...).catch(...)` but none of chains were triggered.

The problem is that I can't reproduce it always.

I'm also using next-routes if that matters

I assume that problem occurs because of `undefined` part in webpack. Any ideas how to debug the cause?

My package dependencies:

```
 ""dependencies"": {
    ""babel-plugin-styled-components"": ""^1.5.0"",
    ""dotenv"": ""^5.0.0"",
    ""dotenv-webpack"": ""^1.5.4"",
    ""enzyme"": ""^3.3.0"",
    ""eslint-plugin-jest"": ""^21.7.0"",
    ""express"": ""^4.16.2"",
    ""glamor"": ""^2.20.40"",
    ""glamorous"": ""^4.11.4"",
    ""htmlescape"": ""^1.1.1"",
    ""isomorphic-fetch"": ""^2.2.1"",
    ""lodash"": ""^4.17.5"",
    ""next"": ""^5.0.0"",
    ""next-redux-wrapper"": ""^1.3.5"",
    ""next-routes"": ""^1.3.0"",
    ""polished"": ""^1.9.2"",
    ""react"": ""^16.2.0"",
    ""react-dom"": ""^16.2.0"",
    ""react-extras"": ""^0.5.0"",
    ""react-icons"": ""^2.2.7"",
    ""react-markdown"": ""^3.2.0"",
    ""react-modal"": ""^3.1.12"",
    ""react-no-ssr"": ""^1.1.0"",
    ""react-redux"": ""^5.0.6"",
    ""react-sizeme"": ""^2.3.6"",
    ""recharts"": ""^1.0.0-beta.10"",
    ""redux"": ""^3.7.2"",
    ""redux-logger"": ""^3.0.6"",
    ""redux-thunk"": ""^2.2.0"",
    ""reselect"": ""^3.0.1"",
    ""socket.io"": ""^2.0.4"",
    ""socket.io-client"": ""^2.0.4"",
    ""yargs"": ""^11.0.0""
  },
  ""devDependencies"": {
    ""@storybook/addon-actions"": ""^3.3.12"",
    ""@storybook/addon-info"": ""^3.3.12"",
    ""@storybook/addon-links"": ""^3.3.12"",
    ""@storybook/addons"": ""^3.3.12"",
    ""@storybook/react"": ""^3.3.12"",
    ""@types/enzyme"": ""^3.1.8"",
    ""@types/jest"": ""^22.1.1"",
    ""@types/next"": ""^2.4.7"",
    ""@types/node"": ""^9.4.1"",
    ""@types/react"": ""^16.0.36"",
    ""@types/recharts"": ""^1.0.13"",
    ""@types/reselect"": ""^2.2.0"",
    ""@types/socket.io"": ""^1.4.31"",
    ""@types/storybook__react"": ""^3.0.6"",
    ""babel-core"": ""^6.26.0"",
    ""babel-eslint"": ""^7.2.3"",
    ""babel-plugin-recharts"": ""^1.1.1"",
    ""babel-plugin-transform-decorators-legacy"": ""^1.3.4"",
    ""babel-preset-env"": ""^1.6.1"",
    ""babel-preset-es2015"": ""^6.24.1"",
    ""babel-preset-stage-0"": ""^6.24.1"",
    ""babili-webpack-plugin"": ""^0.1.2"",
    ""console-probe"": ""^2.0.4"",
    ""create-component-app"": ""^1.6.2"",
    ""eslint"": ""^4.17.0"",
    ""eslint-config-airbnb"": ""^16.1.0"",
    ""eslint-plugin-babel"": ""^4.1.2"",
    ""eslint-plugin-import"": ""^2.8.0"",
    ""eslint-plugin-jsx-a11y"": ""^6.0.3"",
    ""eslint-plugin-react"": ""^7.6.1"",
    ""eslint-plugin-styled-components-config"": ""0.0.2"",
    ""jest"": ""^22.1.4"",
    ""prop-types"": ""^15.6.0"",
    ""redux-devtools-extension"": ""^2.13.2"",
    ""webpack-bundle-analyzer"": ""^2.10.0""
  }
```

- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
Component gets loaded every time

## Current Behavior
Sometimes component is not loaded and webpack tries to load something with `undefined` in name
",arunoda,kind: bug,2018-02-12T10:45:22Z,2018-07-26T10:38:45Z,lkostrowski,aputinski;rauchg;exogen;paulrberg;iliketowritecode;zhengqingxin;dcalhoun;brad-decker;vjpr;arunoda;stramel;eli0shin;jesstelford;arnaud-brun;mherodev;zvictor;imagine10255;lkostrowski;gerhardsletten,arunoda,,arunoda,,timneutkens,
vercel/next.js,38020,"Importing jpg image crashes build on node18 ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:29 PDT 2022; root:xnu-8020.121.3~4/RELEASE_ARM64_T8101
    Binaries:
      Node: 18.4.0
      npm: 8.12.1
      Yarn: 1.22.17
      pnpm: N/A
    Relevant packages:
      next: 12.1.6
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I am importing jpg image

```
import image from ""../me.jpg"";
```

- When running dev command everything works
- When running `next build` on node 17 everything works
- When running `next build` on node 18 it crashes with following message

```
Failed to compile.

./src/me.jpg
TypeError: Failed to parse URL from /Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/mozjpeg/mozjpeg_node_dec.wasm
    at new Request (node:internal/deps/undici/undici:4832:19)
    at Agent.fetch2 (node:internal/deps/undici/undici:5524:29)
    at Object.fetch (node:internal/deps/undici/undici:6351:20)
    at fetch (node:internal/bootstrap/pre_execution:197:25)
    at instantiateAsync (/Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/mozjpeg/mozjpeg_node_dec.js:424:28)
    at createWasm (/Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/mozjpeg/mozjpeg_node_dec.js:447:13)
    at /Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/mozjpeg/mozjpeg_node_dec.js:1480:19
    at Object.instantiateEmscriptenWasm (/Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/emscripten-utils.js:15:12)
    at Object.dec (/Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/codecs.js:156:42)
    at Object.decodeBuffer (/Users/hurtak/hello/petrhurtak.com/node_modules/next/dist/server/lib/squoosh/impl.js:55:31)

Import trace for requested module:
./src/pages/index.tsx


> Build failed because of webpack errors
```

Here is github action running node 18 https://github.com/Hurtak/petrhurtak.com/runs/7056425060?check_suite_focus=true#step:5:41

Here is github action running node 17 https://github.com/Hurtak/petrhurtak.com/runs/7056461987?check_suite_focus=true


### Expected Behavior

Build works on node 18

### Link to reproduction

https://github.com/Hurtak/petrhurtak.com

### To Reproduce

Import this jpg image https://github.com/Hurtak/petrhurtak.com/blob/main/src/me.jpg like 

```
import image from ""../me.jpg"";
```

Use it somewhere in img tag

Run build command and observe the crash",styfle,kind: bug;type: upstream;area: next/image,2022-06-25T21:28:13Z,2022-07-20T16:24:50Z,Hurtak,awareness481,Hurtak;balazsorban44,balazsorban44,styfle,,styfle,
vercel/next.js,3817,"Firefox loses query string after a Router.replace shallow We have a very strange edge case only happening in Firefox but its def causing some problems.

This is whats happening is I navigate to the root http://localhost:3000, get redirected on the server to /about2

I click I button which Router.replace shallow:true which replaces the url to /about2?key=value

I refresh the browser at the current state, url is /about2, I expect it to be /about2=key=value

Here a video recording of the scenario.
https://drive.google.com/file/d/1c0oN-UZIVuG5lt6oZiJOlwZSzAM98gSX/view?usp=sharing

To be a friendly guest here's the repro repo, examples/hello-world
npm install && npm run dev

https://github.com/ptomasroos/next.js/tree/firefox-loses-querystrings

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

Firefox 58 (latest)",ijjk,kind: bug;type: needs investigation,2018-02-15T15:36:20Z,2019-03-12T21:36:26Z,ptomasroos,iggyfisk;lfades;ptomasroos,timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,38176,"Server-side rendering not working on production in next@12.1.6 ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Operating System:
Platform: Windows
Arch: x64
Version: 20H2
Binaries:
Node: v14.17.6
npm: 8.1.3
Yarn: 1.22.17
Relevant packages:
next: 12.1.6
react: 17.0.2
react-dom: 17.0.2

### What browser are you using? (if relevant)

Chrome 102.0.5005.115

### How are you deploying your application? (if relevant)

next build

### Describe the Bug

When using server-side rendering with next@12.1.6, the context doesn't get passed down to the children component.
When trying to log the context value, the context gets logged on the client-side but not on the server-side.

NOTE: This issue cannot be reproduced with other versions of nextjs and is only specific to 12.1.6.
The issue also gets resolved when upgrading react to the latest version i.e. 18.2.0.
This works with` next dev` but fails with `next build` && `next start`.

### Expected Behavior

The context should get passed down to the children on the server-side in production.

### Link to reproduction

https://github.com/sc-addypathania/nextjs-bug-repro/tree/main

### To Reproduce

1) npm run build
2) npm run start
3) Check the console/terminal the context is coming out to be undefined whereas its getting logged correctly on the browser",huozhi,kind: bug;type: needs investigation,2022-06-29T22:24:36Z,2022-08-01T14:21:43Z,sc-addypathania,sc-addypathania;Klemensas;julianobrasil;jcomo,sc-addypathania;balazsorban44;huozhi,balazsorban44,huozhi,,,
vercel/next.js,38383,"next/jest tests error when testing next/future/image even when enabled in config ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: #43-Ubuntu SMP Wed Jun 15 12:54:21 UTC 2022
    Binaries:
      Node: 17.9.0
      npm: 8.5.5
      Yarn: 1.22.18
      pnpm: 7.0.1
    Relevant packages:
      next: 12.2.0
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### Which example does this report relate to?

with-jest

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I've enabled next future image feature but any tests that exercise them fail:
```text
Error: Uncaught [Error: The ""next/future/image"" component is experimental and may be subject to breaking changes. To enable this experiment, please include `experimental: { images: { allowFutureImage: true } }` in your next.config.js file.]
```

The next image component works fine using `yarn dev` and I even receive this warning when I run my tests before the error:
```text
warn  - You have enabled experimental feature (images) in next.config.js.
warn  - Experimental features are not covered by semver, and may cause unexpected or broken application behavior. Use at your own risk.
```

### Expected Behavior

next/future/image is enabled for my test run if enabled in next config and disabled otherwise

### To Reproduce

* Switch next/image in `pages/index.tsx` to next/future/image
* Enable future image in next.config.js using `experimental: { images: { allowFutureImage: true } }`
* Add images.domains array in next.config.js
* run `pnpm test -- --watchAll`",styfle,kind: bug;area: experimental;area: next/image,2022-07-06T17:09:25Z,2022-07-13T19:45:10Z,ornous,olaj;karbica;ornous,ornous;ijjk;styfle,styfle,styfle,,,
vercel/next.js,38431,"`next/future/image` blurDataUrl throwing error about 'style property should not contain semicolon' ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
Operating System:
  Platform: linux
  Arch: x64
  Version: #1 SMP PREEMPT_DYNAMIC Thu, 09 Jun 2022 16:14:10 +0000
Binaries:
  Node: 16.15.0
  npm: 8.5.5
  Yarn: 1.22.19
  pnpm: 7.3.0
Relevant packages:
  next: 12.2.1-canary.4
  eslint-config-next: 12.1.6
  react: 18.1.0
  react-dom: 18.1.0
```

### What browser are you using? (if relevant)

Brave 1.39.122 Chromium: 102.0.5005.115 (Official Build) (64-bit) 

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

When using the new (experimental?) `next/future/image` with `next@12.2.1-canary.4`, I'm getting errors in the console that the `style` property shouldn't contain semicolons, with a recommendation to ""try this instead"". See:

![image](https://user-images.githubusercontent.com/7415984/177876464-5d18e14b-c364-409b-b94f-ce79f905e3de.png)

```
Warning: Style property values shouldn't contain a semicolon. Try ""backgroundImage: 
url(""data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' viewBox='0 0 
250 125'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur 
stdDeviation='50'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 
1'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' x='0' y='0' 
height='100%25' width='100%25' 
href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAACCAIAAADwyuo0AAAACXBIWXMAAAsTAAALEwE
AmpwYAAAAI0lEQVQImWMIkQ1b7lH+sWnm/9V9DC4MnAvVbD52R/x/XQUAkkgL+qsVWWQAAAAASUVORK5CYII='/%3E%3C/s
vg%3E"")"" instead.
```

I've played around with it a bit, and its clearly only appearing when I enable and pass a `blurDataURL`. These data URL's are typical base64 data URI's though, which by definition should contain a semicolon, right?

i.e. `data:image/jpeg;base64,/9j/2wBDAYK.....`

Component in question: https://github.com/ndom91/briefkasten/blob/main/src/components/bookmark-card.jsx#L169-L182

I can't tell for sure, but with the network speed slowed down to `Slow 3G`, it seems that the blur placeholder is not working anymore when this error is thrown. It was previously working with 12.1.X and `next/image` with the same code, however.

### Expected Behavior

Render the blur placeholder while image is loading.

### Link to reproduction

https://briefkasten.vercel.app

### To Reproduce

Login to my sideproject bookmark app linked above, add a bookmark, and reload the page.",styfle,kind: bug;area: next/image,2022-07-07T21:49:00Z,2022-07-08T16:24:04Z,ndom91,KenAKAFrosty;styfle;ndom91,ndom91;styfle,styfle,styfle,,,
vercel/next.js,3853,"Explicit returned value is missing  <!--- Provide a general summary of the issue in the Title above -->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
<!--- If you're describing a bug, tell us what should happen -->
<!--- If you're suggesting a change/improvement, tell us how it should work -->
When I was reading source codes of next.js, I found an interesting place, https://github.com/zeit/next.js/blob/canary/lib/router/router.js#L138.

We'd better to return `true` there? Those codes were introduced by #1250.

## Current Behavior
<!--- If describing a bug, tell us what happens instead of the expected behavior -->
<!--- If suggesting a change/improvement, explain the difference from current behavior -->
Return without explicit boolean value.
",timneutkens,kind: bug,2018-02-20T16:14:44Z,2018-02-22T17:07:40Z,chinesedfan,arunoda,timneutkens,,timneutkens,,arunoda,
vercel/next.js,38621,"`next/future/image` with a blurred placeholder shows double images when JS is disabled ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
Operating System:
  Platform: darwin
  Arch: x64
  Version: Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:22 PDT 2022; root:xnu-8020.121.3~4/RELEASE_X86_64
Binaries:
  Node: 18.5.0
  npm: 8.13.2
  Yarn: 1.22.19
  pnpm: N/A
Relevant packages:
  next: 12.2.3-canary.5
  eslint-config-next: N/A
  react: 18.2.0
  react-dom: 18.2.0
```

### What browser are you using? (if relevant)

Chrome 103.0.5060.114, Chrome Canary 105.0.5177.0, Firefox 102.0.1

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

There's something going on with the `<noscript>` behavior of `next/future/image` that I can't quite figure out...

The original `next/image` with `placeholder=""blur""` simply falls back to a normal image tag when JavaScript has been disabled, but the future version either:

1. Shows a blurry image on the left, and the real image on the right in development, or
2. Shows two identical images in production.

### Expected Behavior

One image displayed per one `<Image />` component, whether or not JavaScript is enabled in the browser.

### Link to reproduction

https://github.com/jakejarvis/next-future-image-bug

### To Reproduce

I've tested this in both Chrome and Firefox. To reproduce this specific behavior, JavaScript must be disabled from the dev tools panel followed by a refresh.

- [Chrome instructions](https://developer.chrome.com/docs/devtools/javascript/disable/)
- [Firefox instructions](https://flailingmonkey.com/disable-javascript-option-now-available-in-firefox-developer-tools)

The reproduction is deployed to Vercel at https://next-future-image-bug.vercel.app/. This shows the two identical images next to each other.

Or, clone [the reproduction repo](https://github.com/jakejarvis/next-future-image-bug) locally (`git clone https://github.com/jakejarvis/next-future-image-bug.git` and `next dev`) to see the case where there is one blurred image and one clear image side-by-side.

<img width=""1186"" alt=""Screen Shot 2022-07-13 at 3 10 20 PM"" src=""https://user-images.githubusercontent.com/1703673/178813991-059b992e-3f06-402a-869a-716f0b2578f5.png"">

Both sections use the same statically imported JPG with `placeholder=""blur""` being the only other prop set, i.e.:

```jsx
import FutureImage from ""next/future/image"";
import Image from ""next/image"";
import pandaJpg from ""../public/panda.jpg"";
// ...
<FutureImage src={pandaJpg} placeholder=""blur"" />
<Image src={pandaJpg} placeholder=""blur"" />
```",styfle,kind: bug;area: next/image,2022-07-13T19:34:31Z,2022-08-30T03:59:16Z,jakejarvis,EduardoSCosta,jakejarvis;balazsorban44,balazsorban44,styfle,,,
vercel/next.js,3864,"Dev swallowing errors and showing 404 instead, since 5.0.1-canary.5 <!--- Provide a general summary of the issue in the Title above -->

When developing, it's useful to see if changed dependencies break something. Since 5.0.1-canary.5, instead of error overlays, under certain circumstances there is now a blank 404 page, with no console errors on either client or server console.

I upgraded react-apollo to 2.1.0-beta.0. There is some breakage with this package in my codebase which under 5.0.1-canary.4 shows the following in the browser:

```
Object(...) is not a function
TypeError: Object(...) is not a function
    at Object.libApolloMutationsCreateCredentialsTs (/src/app/lib/apollo/queries/withCredentials.ts:5:19)
    at __webpack_require__ (/src/app/.next/dist/bundles/pages/webpack/bootstrap 09a1c451b2869cd2289b:25:1)
    at Object.libApolloMutationsIndexTs (/src/app/.next/dist/bundles/pages/home.js:2367:60)
```

This makes it very clear that something is wrong with the apollo setup. Under 5.0.1-canary.5, hitting the same page gives a blank 404 page, which makes it very hard to figure out what went wrong. This behaviour is still present in canary.6.

(This report is not about the breakage itself, but the lack of error info.)

Perhaps this is because I'm doing SSR, and Next is not loading a script it knows is broken? Given the few patches that landed between canary.4 and canary.5, this one looks like the most likely candidate: https://github.com/zeit/next.js/pull/3749.


",arunoda,kind: bug,2018-02-21T17:30:52Z,2018-02-24T13:19:08Z,majelbstoat,,timneutkens,,timneutkens,,arunoda,
vercel/next.js,3865,"500 errors flash due to markup mismatch <!--- Provide a general summary of the issue in the Title above -->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues) of this repository and believe that this is not a duplicate.

## Expected Behavior
<!--- If you're describing a bug, tell us what should happen -->
<!--- If you're suggesting a change/improvement, tell us how it should work -->
When encountering an internal server error, it's expected that the server rendered markup matches the clients, thus avoiding flashing content.

## Current Behavior
<!--- If describing a bug, tell us what happens instead of the expected behavior -->
<!--- If suggesting a change/improvement, explain the difference from current behavior -->
Currently internal server errors will cause a flash. More explicitly, the `statusCode` prop isn't present when rendering `_error.js` in the client, causing the markup to differ.

## Steps to Reproduce (for bugs)
<!--- Provide a link to a live example, or an unambiguous set of steps to -->
<!--- reproduce this bug. Include code to reproduce, if relevant -->
1. Setup a simple Next.js project.
2. Add a page `pages/500.js` with the following content:
```js
export default () => { throw new Error('Boom!') }
```
3. `next build && next start`
4. Point a browser to `http://localhost:3000/500`.

## Context
<!--- How has this issue affected you? What are you trying to accomplish? -->
<!--- Providing context helps us come up with a solution that is most useful in the real world -->
When deploying an application to production, internal server errors cause an unwanted flash of content.

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    |v5.0.1-canary.7|
| node    |v9.4.0|
| OS      |macOS v10.13.3|
| browser |Chrome v64|
",timneutkens,kind: bug,2018-02-21T20:45:44Z,2018-12-30T23:35:00Z,migueloller,timneutkens;migueloller;mgiraldo,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,38736,"Streaming API Responses Not Working on Vercel ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 20.6.0: Tue Feb 22 21:10:41 PST 2022; root:xnu-7195.141.26~1/RELEASE_X86_64
    Binaries:
      Node: 16.15.0
      npm: 8.5.5
      Yarn: 1.22.17
      pnpm: 6.16.0
    Relevant packages:
      next: 12.2.3-canary.10
      eslint-config-next: 12.2.0
      react: 18.2.0
      react-dom: 18.2.0
```

### What browser are you using? (if relevant)

Chrome 103.0.5060.114

### How are you deploying your application? (if relevant)

Vercel

### Describe the Bug

I am using the `experimental-edge` runtime for an api route. `/api/stream`. I am creating a custom `ReadableStream` within this API handler, and returning the `ReadableStream` to the `Response` body. This works great locally. However, once I deploy to Vercel, the response resolves with no body. The documentation mentions supporting streaming, so not quite sure what I'm doing wrong.

Not sure if this bug resides on the Next.js side or Vercel.

Below is the simplest repro I can make.


```ts

export const config = {
  runtime: ""experimental-edge"",
  api: {
    bodyParser: false,
    responseLimit: false,
  },
};

export default async function handler(req: NextRequest, res: NextResponse) {

  let count = 0;

  const resultStream = new ReadableStream(
    {
      pull(controller) {
        if (count < 10) {
          controller.enqueue(JSON.stringify({ foo: ""bar"" }) + ""\n"");
          count++;
        } else {
          controller.close();
        }
      },
    },
    {
      highWaterMark: 1,
      size(chunk) {
        return 1;
      },
    }
  );

  return new Response(resultStream, {
    status: 200,
    headers: {
      ""content-type"": ""text/plain"",
      ""Cache-Control"": ""no-cache"",
    },
  });
}

```

### Expected Behavior

I expect the stream to be returned in chunks, similar to local dev. `{""foo"": ""bar""}\n` should be returned 10 times.

### Link to reproduction

https://github.com/jamespantalones/next-js-stream-bug

### To Reproduce

1. `npm install`
2. `npm run dev`
3. Visit `http://localhost:3000/api/stream` and you should see the following:
4.
<img width=""232"" alt=""Screen Shot 2022-07-17 at 4 06 05 PM"" src=""https://user-images.githubusercontent.com/4332285/179423164-9df13520-4565-418a-9b80-6619b56171c8.png"">


5. Visit same app on Vercel [`https://next-js-stream-bug.vercel.app/api/hello`](https://next-js-stream-bug.vercel.app/api/hello)
6. You should see nothing returned.",javivelasco,kind: bug;area: Edge,2022-07-17T20:21:23Z,2022-10-14T12:05:53Z,jamespantalones,crazy-slot;jamespantalones;javivelasco,jamespantalones;balazsorban44,balazsorban44,javivelasco,,javivelasco,
vercel/next.js,38866,"`Response` in edge runtime is logged as an empty object `{}` ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

  Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:22 PDT 2022; root:xnu-8020.121.3~4/RELEASE_X86_64
    Binaries:
      Node: 16.13.0
      npm: 8.1.0
      Yarn: 1.22.11
      pnpm: N/A
    Relevant packages:
      next: 12.2.3-canary.15
      eslint-config-next: 12.2.2
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

When using `fetch()` from edge middleware to an API in the same next app (`/api/hello`) in my example, the target API _is_ invoked and returns a JSON response but the result in the middleware is always an empty object.
```
const fetchResult = await fetch(req.nextUrl.origin + ""/api/hello"", {
    method: ""GET"",
    headers: {
      ""Content-Type"": ""application/json"",
    },
  });
console.log(""result: "", typeof fetchResult, Object.keys(fetchResult), fetchResult);
const payload = fetchResult.json();
console.log(""payload: "", payload, Object.keys(payload));
```
always yields:
```
hello was invoked!
result:  object [] {}
payload:  {} []
```

For reference the `/api/hello` handler is:
```
export default function handler(req, res) {
  console.log('hello was invoked!');
  res.status(200).json({ name: 'John Doe' })
}
```

A minimal repo (based on `yarn create next-app`) is here: https://github.com/nm2501/next-middleware-fetch

### Expected Behavior

I would expect `fetch` to return a real `Response` from which I can obtain the `/api/hello` response data.

### Link to reproduction

https://github.com/nm2501/next-middleware-fetch

### To Reproduce

`git clone https://github.com/nm2501/next-middleware-fetch`
`cd next-middleware-fetch`
`yarn install`
`yarn dev`
Open http://localhost:3000 in a browser.
Check the terminal where you ran `yarn dev`.",Kikobeats,kind: bug;area: Edge,2022-07-21T13:26:50Z,2022-07-27T14:16:50Z,nm2501,balazsorban44;nm2501,nm2501;balazsorban44,balazsorban44,Kikobeats,,ijjk,
vercel/next.js,39360,"Using monaco-editor with next throws error `(cannot read property Symbol(Symbol.iterator))` ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.3.0: Wed Jan  5 21:37:58 PST 2022; root:xnu-8019.80.24~20/RELEASE_ARM64_T6000
    Binaries:
      Node: 16.3.0
      npm: 7.15.1
      Yarn: 1.22.18
      pnpm: N/A
    Relevant packages:
      next: 12.2.4-canary.12
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Chrome Version 103.0.5060.134 (Official Build) (arm64)

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

When using the `monaco-editor` with `next` an exception will be thrown when selecting an item from the suggested items:

```
Error: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
```

Example project: https://github.com/kevinehosford/next-react-monaco

![CleanShot 2022-08-05 at 09 47 57](https://user-images.githubusercontent.com/18267875/183091322-1ec64a12-b0df-477a-af09-82c0e1afc61e.gif)


### Expected Behavior

No exception to be thrown. A similar project not using `next` does not throw the error

Similar project: https://github.com/kevinehosford/webpack-react-monaco

![CleanShot 2022-08-05 at 10 06 06](https://user-images.githubusercontent.com/18267875/183094508-c4e510a1-8b3c-4a53-9651-8723c08a23b5.gif)


### Link to reproduction

https://github.com/kevinehosford/next-react-monaco

### To Reproduce

Select an item from code completion suggestions and the exception will be thrown. ",kdy1,kind: bug;area: SWC transforms,2022-08-05T14:12:01Z,2022-08-17T11:21:59Z,kevinehosford,kdy1,kevinehosford;balazsorban44,balazsorban44,kdy1,,,
vercel/next.js,394,"duplicate react in bundle ? Hi,

Looks like a basic next.js project gets react duplicated in the `next-dev.bundle.js`.
when launching my fresh project, and going to http://127.0.0.1:3000/_next/next-dev.bundle.js i can see two `SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED` in the source, and i guess this is not good ?

it doesnt hurt for simple cases, but as soon as you use `ReactCSSTransitionGroup` or something using React `refs` then you get that error : 

> next-dev.bundle.js:945 Uncaught Error: addComponentAsRefTo(...): Only a ReactOwner can have refs. You might be adding a ref to a component that was not created inside a component's `render` method, or you have multiple copies of React loaded (details: https://fb.me/react-refs-must-have-owner).(閳)

PS: using next.js@1.2.3
",arunoda,kind: bug,2016-12-15T16:05:20Z,2016-12-16T02:36:48Z,revolunet,revolunet;arunoda,arunoda,,arunoda,,arunoda,
vercel/next.js,39412,"Using triple && with swcMinify doesn't working ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.6.0: Sat Jun 18 17:07:25 PDT 2022; root:xnu-8020.140.41~1/RELEASE_X86_64
    Binaries:
      Node: 16.15.0
      npm: 8.5.5
      Yarn: 3.2.0
      pnpm: 7.8.0
    Relevant packages:
      next: 12.2.5-canary.0
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Chrome 103

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Consider this code:
```js
const a = true;
const b = true;
const c = false;
if(a && b && c) {
  console.log('This shouldn\'t log');
}
if(c && b && a) {
  console.log('Reversed: This also shouldn\'t log');
}

```
When compiling with `swcMinify`, first one logged in browser which shouldn't happen, while second if working correctly.
NOTE: It's working correctly in dev mode.

### Expected Behavior

The above example shouldn't log.

### Link to reproduction

https://codesandbox.io/s/sharp-lalande-bgfbvs

### To Reproduce

1. Check link for reproduction.
2. Use `swcMinify:true` in next.config.js
3. Build using `next build`
4. Run with `next start`",kdy1,kind: bug;area: SWC Minify,2022-08-09T07:04:24Z,2022-08-17T11:21:59Z,eashish93,,eashish93;balazsorban44,balazsorban44,kdy1,,,
vercel/next.js,39538,"[SWC Minify] Global Variable Undefined ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:22 PDT 2022; root:xnu-8020.121.3~4/RELEASE_X86_64
    Binaries:
      Node: 16.15.0
      npm: 8.5.5
      Yarn: 1.22.18
      pnpm: 6.32.19
    Relevant packages:
      next: 12.2.5
      eslint-config-next: 12.2.5
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Reproduction in this repo: https://github.com/wvanrensselaer/nextjs-swc-minify-bug

SWC minify appears to strip global variable used by function:

```js
export const IMAGE_SIZE = 40;

export const preloadImage = () => {
  new Image(IMAGE_SIZE, IMAGE_SIZE).src = ""/vercel.svg"";
};
```

Error: `ReferenceError: IMAGE_SIZE is not defined`
And output code:
```js
6450: function(a, b, c) {
		""use strict"";
		c.r(b),
		c.d(b, {
				default: function() {
						return m
				}
		});
		var d = c(1527)
			, e = c(5737)
			, f = c.n(e)
			, g = c(2609)
			, h = c.n(g)
			, i = c(959)
			, j = c(6185)
			, k = c.n(j)
			, l = function() {
				new Image(IMAGE_SIZE,IMAGE_SIZE).src = ""/vercel.svg""
```

### Expected Behavior

Keeps reference to global variable in build.

### Link to reproduction

https://github.com/wvanrensselaer/nextjs-swc-minify-bug

### To Reproduce

```
pnpm install
NODE_ENV=production pnpm build
NODE_ENV=production pnpm start
```

Visit: http://localhost:3000/",kdy1,kind: bug;area: SWC Minify,2022-08-12T13:30:40Z,2022-08-17T11:21:59Z,wvanrensselaer,,wvanrensselaer;balazsorban44,balazsorban44,padmaia,,,
vercel/next.js,40419,"Next/future/image blur placeholder renders with visual artifacts ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:37 PDT 2022; root:xnu-8020.121.3~4/RELEASE_ARM64_T6000
    Binaries:
      Node: 16.16.0
      npm: 8.11.0
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 12.3.0
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Chrome 105.0.5195.102

### How are you deploying your application? (if relevant)

Vercel and Linode (occurs in all environments)

### Describe the Bug

When using the Image component from ```next/future/image``` with a blur placeholder and base64 blurDataURL, the placeholder renders in Chrome 105.0.5195.102 with visual artifacts, likely because the placeholder is being requested with a different request URL (i.e. we specified a ```data:image/jpeg;``` but the placeholder in the browser is being requested as ```data:image/svg+xml``` with an svg filter applied

I deployed an example to https://nextjs-next-image-issue.vercel.app/ and https://github.com/iominh/nextjs-next-image-issue.

It might be hard to see the blur placeholder but if you use the chrome devtools to apply heavy throttling (e.g. with 3g) and/or just look at the devtools you'll see the placeholder is loaded incorrectly with visual artifacts and the wrong requestURL


Here's an example based on Next 12.3.0 and React 18.2.0:

```tsx
import type { NextPage } from ""next"";
import Head from ""next/head"";
import Image from ""next/future/image"";
import styles from ""../styles/Home.module.css"";

// Sample blur
export const blurDataURL =
  ""data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAIRAAAQMEAQUAAAAAAAAAAAAAAQACAwQFCBETITJEUdL/xAAVAQEBAAAAAAAAAAAAAAAAAAAFBv/EABoRAQEAAgMAAAAAAAAAAAAAAAECABIEMUH/2gAMAwEAAhEDEQA/AJLRkG+kgbELPTyxcXQOlc0k++0rKkyA3I4mxU+yT5DvhEVZrIqHeFxx4p1fM//Z"";

const Home: NextPage = () => {
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name=""description"" content=""Generated by create next app"" />
        <link rel=""icon"" href=""/favicon.ico"" />
      </Head>

      <main className={styles.main}>
        <div className={styles.description}>
          The below image should blur without visual artifacts
        </div>
        <Image
          src=""/tuqa-nabi-uhnZZUaTIOs-unsplash.jpg""
          alt=""Kitten""
          width={2848}
          height={4288}
          placeholder=""blur""
          blurDataURL={blurDataURL}
        ></Image>
     
      </main>
    </div>
  );
};

export default Home;

```

In the chrome dev tools you can see the placeholder renders like the following:

![image](https://user-images.githubusercontent.com/1434477/189472595-0f4a36c7-4744-47a5-9583-e9f51ad7d264.png)


### Expected Behavior

I would've expected the placeholder to render without artifacts and with the correct type

Before next/future/image, the next/image component would return a placeholder like the following:

```
data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAIRAAAQMEAQUAAAAAAAAAAAAAAQACAwQFCBETITJEUdL/xAAVAQEBAAAAAAAAAAAAAAAAAAAFBv/EABoRAQEAAgMAAAAAAAAAAAAAAAECABIEMUH/2gAMAwEAAhEDEQA/AJLRkG+kgbELPTyxcXQOlc0k++0rKkyA3I4mxU+yT5DvhEVZrIqHeFxx4p1fM//Z
```

Instead it now returns the following:

```
data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' viewBox='0 0 2400 1601'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='20'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'/%3E%3C/feComponentTransfer%3E%%3C/filter%3E%3Cimage filter='url(%23b)' x='0' y='0' height='100%25' width='100%25' href='data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQF/8QAIRAAAQMEAQUAAAAAAAAAAAAAAQACAwQFCBETITJEUdL/xAAVAQEBAAAAAAAAAAAAAAAAAAAFBv/EABoRAQEAAgMAAAAAAAAAAAAAAAECABIEMUH/2gAMAwEAAhEDEQA/AJLRkG+kgbELPTyxcXQOlc0k++0rKkyA3I4mxU+yT5DvhEVZrIqHeFxx4p1fM//Z'/%3E%3C/svg%3E
```

### Link to reproduction

https://nextjs-next-image-issue.vercel.app/, https://github.com/iominh/nextjs-next-image-issue

### To Reproduce

Go to https://nextjs-next-image-issue.vercel.app/ to see the placeholder load or create an image like shown in the description above",styfle,kind: bug;area: next/image,2022-09-10T06:52:06Z,2022-10-19T20:21:43Z,iominh,menberg;styfle,iominh;balazsorban44;styfle,styfle,styfle,,ijjk,
vercel/next.js,41393,"Next/future/image blur placeholder have undefined to view box SVG width & height ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: #25-Ubuntu SMP Wed Mar 30 15:54:22 UTC 2022
    Binaries:
      Node: 18.9.0
      npm: 8.19.1
      Yarn: 1.22.10
      pnpm: N/A
    Relevant packages:
      next: 12.3.1
      eslint-config-next: 12.3.1
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Brave Version 1.44.108 Chromium: 106.0.5249.103

### How are you deploying your application? (if relevant)

Vercel

### Describe the Bug

Wrong SVG viewBox generated when using placeHolder='blur' with image filling his parent

- ### The blur base64
    - ![](https://raw.githubusercontent.com/Balkeo/next-future-image-issue/main/src/blur.svg)
- ### The SVG using the blur base64
    - ![](https://raw.githubusercontent.com/Balkeo/next-future-image-issue/main/src/render-by-browser.png)

As we can see in the `src/blur.svg` the viewBox have weird values

```SVG
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 undefined undefined'>
    <filter id='b' color-interpolation-filters='sRGB'>
        <feGaussianBlur stdDeviation='20'/>
        <feComponentTransfer>
            <feFuncA type='discrete' tableValues='1 1'/>
        </feComponentTransfer>
    </filter>
    <image filter='url(#b)' x='0' y='0' height='100%' width='100%' href='data:image/jpeg;base64[...]'/>
</svg>
```

So the svg have this weird artifacts and the black borders

### Expected Behavior

I expected the placeHolder to be rendered without artefacts and with a corect viewBox for the SVG not undefined in width & height

### Link to reproduction

https://next-future-image-issue-sigma.vercel.app/

### To Reproduce

A repo with all the need to reproduce 
https://github.com/Balkeo/next-future-image-issue",styfle,kind: bug;area: next/image,2022-10-13T16:50:50Z,2022-10-19T20:21:43Z,Balkeo,balazsorban44;shouze;ElektrikSpark;styfle,Balkeo;balazsorban44;styfle,styfle,styfle,,ijjk,
vercel/next.js,41527,"swcMinifier change the logical behavior of a some code ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: Ubuntu 20.04.0 LTS Tue Oct 18 2022 18:22:36 GMT+0200 (Central European Summer Time)
    Binaries:
      Node: 16.14.2
      npm: 7.17.0
      Yarn: 1.22.19
      pnpm: 7.13.0
    Relevant packages:
      next: 12.3.1
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

The code at line 92 of the toolbar of react-quill

https://github.com/quilljs/quill/blob/20f4c45258af235f5be4a2b7f5411c9b5a9e620e/modules/toolbar.ts#L92

it's meant to format the text based on the selected element inside a `<select>` in the toolbar. This get's correctily minified by react-quill build process:

```javascript
s=!u.hasAttribute(""selected"")&&(u.value||!1)
```

but this code will later be re-minified by next.js swcMinifier in a logically similar but behavior-ally different code

```javascript
s=!u.hasAttribute(""selected"")&&!!u.value
```

This lead to the unusability of react-quill inside Next.JS unless you disable the swcMinifier (given that the former minification always cast the value to a boolean the changes will never apply).

This is also a silent bug since there are no error and in development everything works fine. 

### Expected Behavior

the minified code should have the same logic as the unminified one

### Link to reproduction

https://stackblitz.com/edit/react-quill-repro?file=next.config.js

### To Reproduce

1. Visit [this stackblitz](https://stackblitz.com/edit/react-quill-repro?file=next.config.js)
2. In the integrated terminal run `npm run dev`
3. Try to write something and change either the font, the size or the color. Everything will work fine.
4. Stop the dev server with CTRL+C
5. run `npm run build`
6. run `npm run start`
7. Try to write something and change either the font, the size or the color. This times neither will work.
8. Change next.config.js removing `swcMinify: true`
9. run `npm run build`
10. run `npm run start`
11. Try to write something and change either the font, the size or the color. This times everything will work fine.",kdy1,kind: bug;area: SWC Minify,2022-10-18T16:25:43Z,2022-10-19T03:04:33Z,paoloricciuti,steveluscher;ijjk,paoloricciuti;ijjk,ijjk,kdy1,,,
vercel/next.js,4159,"6.0.0-canary.3 Styled JSX presets not applying <!--- Provide a general summary of the issue in the Title above -->
For whatever reason, the latest canary with babel 7 isn't working well with styled jsx plugins via custom babelrc.

<!--
閳跨媴绗 IMPORTANT 閳跨媴绗
If you have a question about Next.js please ask it on Spectrum https://spectrum.chat/next-js
or join our Slack community at https://zeit.chat and ask it in the `#next` channel
-->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues?q=is%3Aissue) of this repository and believe that this is not a duplicate.

## Expected Behavior
<!--- If you're describing a bug, tell us what should happen -->
Expected to build the page and display in dev environment, instead spits error each build.

<!--- If you're suggesting a change/improvement, tell us how it should work -->

## Current Behavior
<!--- If describing a bug, tell us what happens instead of the expected behavior -->
Instead of building page, the following error is displayed.

Module build failed: Error: Nesting detected at 11:9. Unfortunately nesting is not supported by styled-jsx.

<!--- If suggesting a change/improvement, explain the difference from current behavior -->

## Steps to Reproduce (for bugs)
<!--- Provide a link to a live example, or an unambiguous set of steps to -->

<!--- reproduce this bug. Include code to reproduce, if relevant -->
1. Download and install with-styled-jsx-plugins example from next repo.
2. yarn add next@6.0.0-canary.3 react@16.3.2 react-dom@16.3.2
3. yarn dev
4. goto localhost:3000

I can verify that the babel preset next/babel isn't receiving any custom options, so when the preset looks for the options, they aren't found. 

https://github.com/zeit/next.js/blob/canary/server/build/babel/preset.js#L55

## Context
<!--- How has this issue affected you? What are you trying to accomplish? -->
Impossible to build pages currently.
<!--- Providing context helps us come up with a solution that is most useful in the real world -->

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    |    6.0.0-canary.3     |
| node    |     9.3.0    |
| OS      |     High Sierra    |
| browser |     Chrome    |
| etc     |         |


",timneutkens,kind: bug,2018-04-16T20:15:57Z,2018-04-26T18:26:43Z,brycejacobs,timneutkens;brycejacobs;kheruc,timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,41865,"Module not found: ESM packages (/path/to/app/page.js) need to be imported. ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: #1 SMP Tue Sep 13 07:51:46 UTC 2022
    Binaries:
      Node: 18.12.0
      npm: 8.19.2
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 13.0.0
      eslint-config-next: 12.3.1
      react: 18.2.0
      react-dom: 18.2.0

warn  - Latest canary version not detected, detected: ""13.0.0"", newest: ""12.3.2-canary.43"".
        Please try the latest canary version (`npm install next@canary`) to confirm the issue still exists before creating a new issue.
        Read more - https://nextjs.org/docs/messages/opening-an-issue

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Here is the error output when I run `npm run dev` or `build`:

```
Module not found: ESM packages (/path/to/app/page.js) need to be imported. Use 'import' to reference the package instead. https://nextjs.org/docs/messages/import-esm-externals

https://nextjs.org/docs/messages/module-not-found
```

Could someone give me direction since I don't know where to start with this bug?

I have enabled the novel `app` directory (`experimental: { appDir: true }`) and tried to put `page.js` and `layout.js` files in it.

### Expected Behavior

Load `page.js` and `layout.js` properly.

### Link to reproduction

-

### To Reproduce

-",huozhi,kind: bug;area: Compiler;area: app,2022-10-26T15:52:17Z,2022-11-10T23:16:01Z,rnarkk,vladshcherbin;balazsorban44;kevva;huozhi;schickling,rnarkk;balazsorban44,balazsorban44,timneutkens;huozhi,,huozhi,vercel/next.js#42534;
vercel/next.js,41870,"[Next 13] - Multiple versions of React is shipped. One page has 2x the bundle size without any libraries. ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.6.0: Sat Jun 18 17:05:47 PDT 2022; root:xnu-8020.140.41~1/RELEASE_ARM64_T8101
    Binaries:
      Node: 18.10.0
      npm: 8.19.2
      Yarn: 1.22.17
      pnpm: 7.5.0
    Relevant packages:
      next: 13.0.0
      eslint-config-next: 13.0.0
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Chrome 106.0.5249.119

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

When building my app this is the result:

```bash
Route (app)                                Size     First Load JS
閳 閳 /                                      0 B                0 B
閳 閳 /dashboard                             105 B          66.6 kB
閳 閳 /dashboard/users                       186 B           141 kB // What is going on here?
閳 浣 /dashboard/users/[id]                  4.59 kB        75.7 kB
+ First Load JS shared by all              66.5 kB
  閳 chunks/main-app-fd902262245ffaed.js    64.5 kB
  閳 chunks/webpack-8876bb8973ebf277.js     2.07 kB

Route (pages)                              Size     First Load JS
閳 閳 /404                                   179 B          79.8 kB
+ First Load JS shared by all              79.6 kB
  閳 chunks/main-d4cdf33ec41ad030.js        77.3 kB
  閳 chunks/pages/_app-4e5b418629f6f9e0.js  193 B
  閳 chunks/webpack-8876bb8973ebf277.js     2.07 kB
```

It appears that Next is bundling 2 instances of React for the endpoint `/dashboard/users`. This has resulted in a 2x bundle increase on this particular page, and I cannot seem to figure out why.

I've fired up the bundle analyzer and see that a specific chunk includes both next.js and react + react-dom, and its not the main bundle.

I have attempted running with `swcMinify` & without. Same result.

### Expected Behavior

Dual versions of React should not be shipped randomly on a page.

### Link to reproduction

https://github.com/sannajammeh/next-13-dual-react

### To Reproduce

1. Git clone
2. pnpm install
3. next build
4. Observe /dashboard/users has double the size despite not needing it.
5. Run `ANALYZE=true next build` and observe the chunk shipped with code identical to `main-...` with some exceptions in the Next runtime.

",shuding,kind: bug;area: app,2022-10-26T17:10:36Z,2022-10-27T20:13:18Z,sannajammeh,jescalan;alexparish;timneutkens,sannajammeh;balazsorban44,balazsorban44,shuding,,ijjk,
vercel/next.js,41931,"appDir cannot read properties of null (reading useContext) @ build ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

OS
Mac

""next"": ""^13.0.0"",
""react"": ""^18.2.0"",



### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I get this Build error when using appdir experimental / swc **No error when not using appdir experimental** 

```
TypeError: Cannot read properties of null (reading 'useContext')
--
21:43:44.798 | at exports.useContext (/vercel/path0/node_modules/react/cjs/react.production.min.js:24:118)
21:43:44.799 | at MotionComponent (file:///vercel/path0/node_modules/framer-motion/dist/es/motion/index.mjs:31:16)
21:43:44.799 | at Yd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:101:25)
21:43:44.799 | at Z (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:103:91)
21:43:44.799 | at Zd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:105:98)
21:43:44.799 | at ae (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:104:424)
21:43:44.800 | at Z (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:103:222)
21:43:44.800 | at Zd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:105:98)
21:43:44.800 | at Yd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:98:213)
21:43:44.800 | at Z (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:103:91)
21:43:44.800 | 鑱
21:43:44.801 | Error occurred prerendering page ""/"". Read more: https://nextjs.org/docs/messages/prerender-error
21:43:44.802 | TypeError: Cannot read properties of null (reading 'useContext')
21:43:44.803 | at exports.useContext (/vercel/path0/node_modules/react/cjs/react.production.min.js:24:118)
21:43:44.803 | at MotionComponent (file:///vercel/path0/node_modules/framer-motion/dist/es/motion/index.mjs:31:16)
21:43:44.803 | at Yd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:101:25)
21:43:44.803 | at Z (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:103:91)
21:43:44.803 | at Zd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:105:98)
21:43:44.804 | at ae (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:104:424)
21:43:44.804 | at Z (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:103:222)
21:43:44.804 | at Zd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:105:98)
21:43:44.804 | at Yd (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:98:213)
21:43:44.804 | at Z (/vercel/path0/node_modules/next/dist/compiled/react-dom/cjs/react-dom-server.browser.production.min.js:103:91)
21:43:44.804 | info  - Generating static pages (4/9)
21:43:44.815 | info  - Generating static pages (6/9)
21:43:45.037 | info  - Generating static pages (9/9)
21:43:45.039 | 鑱
21:43:45.039 | > Build error occurred
21:43:45.042 | Error: Export encountered errors on following paths:
21:43:45.042 | /
21:43:45.043 | at /vercel/path0/node_modules/next/dist/export/index.js:405:19
21:43:45.043 | at runMicrotasks (<anonymous>)
21:43:45.044 | at processTicksAndRejections (node:internal/process/task_queues:96:5)
21:43:45.044 | at async Span.traceAsyncFn (/vercel/path0/node_modules/next/dist/trace/trace.js:79:20)
21:43:45.044 | at async /vercel/path0/node_modules/next/dist/build/index.js:1263:21
21:43:45.044 | at async Span.traceAsyncFn (/vercel/path0/node_modules/next/dist/trace/trace.js:79:20)
21:43:45.044 | at async /vercel/path0/node_modules/next/dist/build/index.js:1123:17
21:43:45.045 | at async Span.traceAsyncFn (/vercel/path0/node_modules/next/dist/trace/trace.js:79:20)
21:43:45.045 | at async Object.build [as default] (/vercel/path0/node_modules/next/dist/build/index.js:64:29)
21:43:45.092 | Error: Command ""npm run build"" exited with 1


```

### Expected Behavior

No error w/ appdir

### Link to reproduction

n/a

### To Reproduce

Framer motion with nextjs 13?",huozhi,kind: bug;area: documentation;area: next/head / head.js;area: app,2022-10-27T02:56:24Z,2022-12-09T00:10:00Z,temrb,raajnadar;GeoBrodas;thebinaryfelix;huozhi,temrb;balazsorban44;huozhi,balazsorban44,timneutkens;huozhi,huozhi,huozhi,
vercel/next.js,4194,"Context provided in _app.js can't be consumed in pages in SSR <!--- Provide a general summary of the issue in the Title above -->

React v16.3 context provided in `pages/_app.js` can be consumed and rendered in pages on the client, but is undefined in SSR. This causes React SSR markup mismatch errors.

Note that context can be universally provided/consumed *within* `pages/_app.js`, the issue is specifically when providing context in `pages/_app.js` and consuming it in a page such as `pages/index.js`.

<!--
閳跨媴绗 IMPORTANT 閳跨媴绗
If you have a question about Next.js please ask it on Spectrum https://spectrum.chat/next-js
or join our Slack community at https://zeit.chat and ask it in the `#next` channel
-->

<!--
    Thank you very much for contributing to Next.js by creating an issue! 閴傘倧绗
    To avoid duplicate issues we ask you to check off the following list
-->

<!-- Checked checkbox should look like this: [x] -->
- [x] I have searched the [issues](https://github.com/zeit/next.js/issues?q=is%3Aissue) of this repository and believe that this is not a duplicate.

## Expected Behavior
Context provided in `pages/_app.js` should be consumable in pages both on the server for SSR and when browser rendering.

## Current Behavior
Context provided in `pages/_app.js` is undefined when consumed in pages for SSR. It can only be consumed for client rendering.

## Steps to Reproduce (for bugs)
<!--- Provide a link to a live example, or an unambiguous set of steps to -->
<!--- reproduce this bug. Include code to reproduce, if relevant -->
In `pages/_app.js`:

```jsx
import App, { Container } from 'next/app'
import React from 'react'
import TestContext from '../context'

export default class MyApp extends App {
  render () {
    const { Component, pageProps } = this.props
    return (
      <Container>
        <TestContext.Provider value=""Test value."">
          <Component {...pageProps} />
        </TestContext.Provider>
      </Container>
    )
  }
}
```

In `pages/index.js`:

```jsx
import TestContext from '../context'

export default () => (
  <TestContext.Consumer>
    {value => value}
  </TestContext.Consumer>
)
```

In `context.js`:

```jsx
import React from 'react'

export default React.createContext()
```

Will result in:

<img width=""570"" alt=""screen shot 2018-04-23 at 2 29 29 pm"" src=""https://user-images.githubusercontent.com/1754873/39107043-d45bd2a6-4702-11e8-85a8-f04ef11bcb4b.png"">

## Context
<!--- How has this issue affected you? What are you trying to accomplish? -->
<!--- Providing context helps us come up with a solution that is most useful in the real world -->

A large motivation for the `pages/_app.js` feature is to be able to provide context persistently available across pages. It's unfortunate the current implementation does not support this basic use case.

I'm attempting to isomorphically provide the cookie in context so that [`graphql-react`](https://github.com/jaydenseric/graphql-react) `<Query />` components can get the user's access token to make GraphQL API requests. This approach used to work with separately decorated pages.

## Your Environment
<!--- Include as many relevant details about the environment you experienced the bug in -->
| Tech    | Version |
|---------|---------|
| next    | v6.0.0-canary.5 |
| node    | v9.11.1 |",timneutkens,kind: bug,2018-04-23T04:45:48Z,2018-07-24T09:24:41Z,jaydenseric,timneutkens;joeporpeglia;brad-decker;steida;mtford90;elrumordelaluz;lasersox;Ilaiwi;ckeeney;tz5514;filidorwiese;jaydenseric,,,,,timneutkens,
vercel/next.js,41992,"swcMinify causes production builds to generate incorrect swagger documentation using `next-swagger-doc` ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: #202210150742~1666053244~22.04~cf07008 SMP PREEMPT_DYNAMIC Tue O
    Binaries:
      Node: 17.2.0
      npm: 8.1.4
      Yarn: 1.22.17
      pnpm: N/A
    Relevant packages:
      next: 13.0.1-canary.0
      eslint-config-next: 13.0.0
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Setting `swcMinify: true` in next config causes parameter arrays in OpenAPI documentation generated by next-swagger-doc / swagger-jsdoc to render only the last parameter in the array.

### Expected Behavior

dev and prod output should not be different

### Link to reproduction

https://github.com/billythedummy/swcminify-swagger-bug 

### To Reproduce

- `yarn install` to install dependencies
- When you run `yarn dev`, you should see all 3 params in the swagger documentation generated from the jsdoc in `pages/api/hello.ts`:

![dev screenshot](https://raw.githubusercontent.com/billythedummy/swcminify-swagger-bug/master/assets/dev.png)

- However, when you create a production build with `yarn build` and run the production server with `yarn start`, all params but param3 are gone:

![prod screenshot](https://raw.githubusercontent.com/billythedummy/swcminify-swagger-bug/master/assets/prod.png)

The root cause seems to be somewhere in swcMinify. Setting `swcMinify: false` in `next.config.js` and running `yarn build` and `yarn start` again results in the correct output.
",kdy1,kind: bug;area: SWC Minify,2022-10-27T16:35:03Z,2022-11-04T01:37:38Z,billythedummy,,billythedummy;balazsorban44,balazsorban44,kdy1,,huozhi,
vercel/next.js,41995,"Middleware does not work in Next.js 13 when the /pages directory is removed ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.6.0: Mon Aug 22 20:20:05 PDT 2022; root:xnu-8020.140.49~2/RELEASE_ARM64_T8101
    Binaries:
      Node: 18.10.0
      npm: 8.19.2
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 13.0.1-canary.0
      eslint-config-next: 13.0.0
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

106.0.5249.119

### How are you deploying your application? (if relevant)

n/a

### Describe the Bug

Removing the `pages` directory prevents Next.js middleware from running.

### Expected Behavior

The middleware should work with the new `app` directory when the `pages` directory does not exist.

### Link to reproduction

https://github.com/jamescmartinez/nextjs13-middlware-appdir-bug

### To Reproduce

1. `npm run dev` to start the app
2. `open http://localhost:3000/page2` to open `/page2` in your browser, noting that `/page2` does not redirect to `/` as configured in `middleware.ts`
3. stop the dev server
4. `mkdir pages` to create an empty pages directory
5. `npm run dev` to start the app
6. `open http://localhost:3000/page2` to open `/page2` in your browser, noting that `/page2` now redirects to `/`",huozhi,kind: bug;area: Middleware;area: app,2022-10-27T18:42:08Z,2022-11-21T23:38:00Z,jamescmartinez,jensen,jamescmartinez;balazsorban44,balazsorban44,balazsorban44,,ijjk,
vercel/next.js,42010,"Creating `app/page/page.tsx` maps to `app/page.tsx`       Creating a page at route `/page` by making a file at `app/page/page.tsx` gets mapped to `app/page.tsx`, so basically `/page` route renders the same content as the `/` route. This doesn't seem to be the expected behavior.

_Originally posted by @bhavesh-chaudhari in https://github.com/vercel/next.js/discussions/41745#discussioncomment-3966674_
    


Reproduction repository: https://github.com/balazsorban44/42010",shuding,kind: bug;area: app,2022-10-27T21:49:26Z,2022-11-02T15:17:01Z,balazsorban44,,balazsorban44,,timneutkens,shuding,shuding,
vercel/next.js,42249,"Next 13: experimental appDir breaks useSWR ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.6.0: Mon Aug 22 20:19:52 PDT 2022; root:xnu-8020.140.49~2/RELEASE_ARM64_T6000
    Binaries:
      Node: 18.12.0
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.1-canary.2
      eslint-config-next: 13.0.0
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Default Home component from `yarn create next-app`
```
export default function Home() {
  const { data, error } = useSWR(""/api/hello"", (...args) =>
    fetch(...args).then((res) => res.json())
  );
  ...
}
```
errors with
`TypeError: Cannot read properties of null (reading 'useContext')` with an invalid hook call warning

removing 
```
experimental: {
  appDir: true,
},
```
from `next.config.js` resolves the issue.

### Expected Behavior

useSWR should work when the experimental app directory is enabled

### Link to reproduction

https://stackblitz.com/edit/vercel-next-js-arthzt?file=pages/index.tsx

### To Reproduce

use 
```
experimental: {
  appDir: true
}
```
and `useSWR` from `swr` together",shuding,kind: bug;area: app,2022-10-31T16:23:06Z,2022-11-10T17:11:40Z,andrewcoelho,armandodlvr;shuding;andrewcoelho;lukemorales;rafinskipg,andrewcoelho;balazsorban44,balazsorban44,timneutkens,,shuding,
vercel/next.js,42364,"[Next.js 13][Routing][Pre-fetching] Dynamic route fails to pre-fetch (404) I have already made a ticket for this, but i'm giving here some details.

Pre-fetching (with `<Link>` or `router.prefetch()`) dynamic routes like `app/test/[testId]/leaf` (with one segment over the dynamic param) throws a 404 Not Found **on Vercel** (the page exists). **It works fine on `next dev` and `next start` and with other cloud providers.**

You can try it here [https://test-headers-vercel.vercel.app/test](https://test-headers-vercel.vercel.app/test)
In the inspector you can see that pre-fetching `/test/1` works as expected, pre-fetching `/test/1/leaf` throws a 404.


For `/test/1`
<img width=""482"" alt=""Capture d閳ユ獔铏俢ran 2022-10-31 a铏 11 43 34"" src=""https://user-images.githubusercontent.com/16503412/198990243-dffe4838-04d1-469c-8b93-8fcdbd7e77d4.png"">


For `/test/1/leaf`
<img width=""482"" alt=""Capture d閳ユ獔铏俢ran 2022-10-31 a铏 11 43 28"" src=""https://user-images.githubusercontent.com/16503412/198990250-a4fb3fdb-2de2-48b8-bb9c-75b8e96f6929.png"">
(The first cache hit is a MISS, Vercel then caches it)

This forces a hard navigation to `/test/1/leaf` (probably related to [this issue](https://github.com/vercel/next.js/issues/42175)).


**I haven't tried it on Next 12.**

BTW: pre-fetching seems to work in dev, contrary to what is written in the [beta doc](https://beta.nextjs.org/docs/routing/linking-and-navigating) 


",ijjk,kind: bug;area: app,2022-10-31T10:46:35Z,2022-11-09T04:17:33Z,Smirow,Smirow;timneutkens;ijjk,timneutkens,,timneutkens,,ijjk,
vercel/next.js,42438,"Search params are removed in production unless `useSearchParams` is called ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.6.0: Mon Aug 22 20:17:10 PDT 2022; root:xnu-8020.140.49~2/RELEASE_X86_64
    Binaries:
      Node: 16.14.2
      npm: 8.5.0
      Yarn: 1.22.18
      pnpm: N/A
    Relevant packages:
      next: 13.0.2-canary.2
      eslint-config-next: 13.0.1
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

next start, Vercel

### Describe the Bug

Search params seem to be removed in production _unless_ `useSearchParams` hook is called somewhere. `next dev` seems to work fine. Bug occurs with `next build` and `next start`.

### Expected Behavior

Expected search params to not be removed in production unless `useSearchParams` hook is called.

### Link to reproduction

https://github.com/LukasMurdock/next-13-test

### To Reproduce

Create a page in Next 13 `/app` that does _not_ use `useSearchParams` hook anywhere and run `next build` and `next start` and attempt to load the page with any search parameters. Search parameters should be removed.

If you add a call `useSearchParams()` then search params are not removed.

I have a reproduction here: 
- (Server component, params removed) https://next-13-test-kohl.vercel.app/server?test=
- (Client component, params removed) https://next-13-test-kohl.vercel.app/client/nowork/?test=
- (Client component calls `useSearchParams()`, params retained) https://next-13-test-kohl.vercel.app/client/work/?test=",timneutkens,kind: bug;area: app,2022-11-03T20:03:04Z,2022-11-14T09:50:21Z,LukasMurdock,leerob;timneutkens,LukasMurdock;timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,42466,"appDir + async server component + css-modules causes syntax error ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:30 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8103
    Binaries:
      Node: 18.11.0
      npm: 8.19.2
      Yarn: 1.22.10
      pnpm: N/A
    Relevant packages:
      next: 13.0.2
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Chrome, Safari

### How are you deploying your application? (if relevant)

next dev

### Describe the Bug

When using the experimental /app mode with the following setup, RSC seems to stream in a malformed script tag, causing a crash:

- Uses /app directory
- Root page has both a `layout.tsx` and a `loading.tsx`
- `page.tsx` exports an async server component
- `page.tsx` uses a class name from a CSS module, `styles.module.css`

<img width=""524"" alt=""Screenshot 2022-11-03 at 10 14 23 PM"" src=""https://user-images.githubusercontent.com/3022244/199871717-b5ee32be-2f77-4c83-a8a2-df7fada8ab15.png"">
<img width=""768"" alt=""Screenshot 2022-11-03 at 10 11 36 PM"" src=""https://user-images.githubusercontent.com/3022244/199871719-c334c699-b125-4288-9b88-828db0945474.png"">

`Unexpected string literal "","". Parse error.`

See minimal repro in code here: https://github.com/mxmul/next13-async-component-css-modules-repro/commit/c562d4dcf3745c365eae6f9515e8680980245d79

### Expected Behavior

Page should render the loading state immediately, then the loaded content.

e.g.
<img width=""519"" alt=""Screenshot 2022-11-03 at 10 14 44 PM"" src=""https://user-images.githubusercontent.com/3022244/199871979-23de3d87-a75f-48f5-819b-32dc0fbd8b2f.png"">


### Link to reproduction

https://github.com/mxmul/next13-async-component-css-modules-repro

### To Reproduce

Clone the repo, and run `yarn dev`.

The first time you load the page, it seems to render properly. You see a loading state, then the rendered page:

<img width=""519"" alt=""Screenshot 2022-11-03 at 10 14 44 PM"" src=""https://user-images.githubusercontent.com/3022244/199872112-f9dfed7e-443b-4588-b0b9-e04b10ef11aa.png"">

After refreshing the page, you should see next crash with a syntax error:

<img width=""524"" alt=""Screenshot 2022-11-03 at 10 14 23 PM"" src=""https://user-images.githubusercontent.com/3022244/199872153-1718f462-beaf-4b57-8844-3a58c42c2dca.png"">
",shuding;huozhi;feedthejim,kind: bug;type: needs investigation;area: app,2022-11-04T02:30:28Z,2022-11-23T15:57:42Z,mxmul,balazsorban44;mxmul;chrisco255;feedthejim,mxmul;balazsorban44;timneutkens,timneutkens,timneutkens;feedthejim,,,
vercel/next.js,42493,"AppDir: serverInsertedHTML can break hydration ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.6.0: Wed Aug 10 14:28:23 PDT 2022; root:xnu-8020.141.5~2/RELEASE_ARM64_T6000
    Binaries:
      Node: 17.1.0
      npm: 7.20.1
      Yarn: 1.22.17
      pnpm: 6.11.0
    Relevant packages:
      next: 13.0.2-canary.3
      eslint-config-next: 13.0.2
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

not relevant

### How are you deploying your application? (if relevant)

pnpm run dev

### Describe the Bug

Initially reported here: https://mobile.twitter.com/SanderCokart/status/1588298214863962112

Repro: https://github.com/SanderCokart/learning-tailwind

Need to change `<div>` to `<headers>` here: https://github.com/SanderCokart/learning-tailwind/blob/master/app/layout.tsx#L91-L94

Hydration fails because the polyfills script is being injected into the stream inside the `<headers>` block. It is probably not specifically related to `<headers>` but just some function of how the stream emits chunks.
<img width=""296"" alt=""image"" src=""https://user-images.githubusercontent.com/2716369/200023386-033ede2d-612f-4800-b412-d9eefe78da61.png"">


Investigating I see that node-web-streams-helper injects a number of items into the raw stream which is not supported by React streaming which conflicts with how appDir features should probably work.

In addition to arbitrarily emitting server inserted script tags it also can potentially emit closing body and html tags which is unecessary in React 18 (these form the postamble and will be help back until the stream is ended). The data seeidng scripts for the router also appear to show up after the request is closed. They should probably go first or be routed through react's stream directly.

### Expected Behavior

scripts emitted into the stream should probably just be rendered by react so they go in the right place. if that is not feasible the only safe places to emit scripts are the head and body.

### Link to reproduction

https://github.com/SanderCokart/learning-tailwind

### To Reproduce

Need to change `<div>` to `<headers>` here: https://github.com/SanderCokart/learning-tailwind/blob/master/app/layout.tsx#L91-L94

visit localhost:3000",shuding;huozhi,kind: bug;area: app,2022-11-04T16:14:02Z,2022-11-07T17:16:16Z,gnoff,chengluyu,gnoff;timneutkens,timneutkens,timneutkens,,huozhi,
vercel/next.js,42534,"Resolution errors may happen in server components with packages whose exports field only includes ES module import ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```yml
Operating System:
  Platform: darwin
  Arch: x64
  Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64
Binaries:
  Node: 18.12.0
  npm: 8.19.2
  Yarn: 1.22.19
  pnpm: 7.14.2
Relevant packages:
  next: 13.0.3-canary.0
  eslint-config-next: N/A
  react: 18.2.0
  react-dom: 18.2.0
```

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

In some ES module packages, the `exports` field in `package.json` only includes one `import` field. This causes some resolution errors when imported to server components. However, `getStaticProps` and other data-fetching functions in `pages` directory still works fine.

Since it's quite vague to me, I think I will continue with the example. Clone the repo linked below.

The path `/test` (in `pages` directory, with `getStaticProps`) works as intended. Meanwhile, `/` (RSC in `app` directory) doesn't, with a confusing error message:

```
Module not found: Package path . is not exported from package /path/to/node_modules/periscopic
(see exports field in /path/to/node_modules/periscopic/package.json)
```

That is (apparently) because `periscopic`'s `exports` field is like this

```json
""exports"": {
  ""import"": ""./src/index.js""
}
```

After modifying this `exports` manually, in `periscopic` and 2 other similar modules (`is-reference` and `estree-walker`),

```diff
- ""exports"": {
-  ""import"": ""./src/index.js""
- },
+ ""exports"": ""./src/index.js"",
```

then `/` works as intended.

Ref: https://github.com/orgs/mdx-js/discussions/2168

### Expected Behavior

`/` should not crash and gives the same output as `/test` in the linked reproduction repository.

### Link to reproduction

https://github.com/joulev/debug/tree/nextjs-42534

### To Reproduce

Mentioned in the ""Describe the Bug"" section.

* Clone the repository
* `npm install`
* `npm run dev`
* Open `/`: crash
* Open `/test`: works normally",huozhi,kind: bug;area: app,2022-11-06T13:12:58Z,2022-11-11T00:50:47Z,joulev,huozhi;joulev;schickling;l4b4r4b4b4,joulev;timneutkens;balazsorban44,balazsorban44,timneutkens;huozhi,shuding;huozhi,,vercel/next.js#41865;
vercel/next.js,42557,"Next13 build error `Expected ""NameProps"", got ""PageProps""` ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:30 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8103
    Binaries:
      Node: 18.12.0
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.3-canary.0
      eslint-config-next: 13.0.2
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

My project looks like this and all components are server components
```
.
閳规壕鏀㈤埞 README.md
閳规壕鏀㈤埞 app
閳   閳规壕鏀㈤埞 head.tsx
閳   閳规壕鏀㈤埞 layout.tsx
閳   閳规壕鏀㈤埞 name
閳   閳   閳规壕鏀㈤埞 [name]
閳   閳   閳   閳规柡鏀㈤埞 page.tsx
閳   閳   閳规柡鏀㈤埞 page.tsx
閳   閳规柡鏀㈤埞 page.tsx
閳规壕鏀㈤埞 next.config.js
閳规壕鏀㈤埞 package.json
閳规壕鏀㈤埞 tsconfig.json
閳规柡鏀㈤埞 yarn.lock
```

It works fine when `yarn dev` but when build the app `yarn build` got this error
```
Type error: Page ""app/name/[name]/page.tsx"" does not match the required types of a Next.js Page.
  Invalid configuration:
    The exported page component isn't correctly typed.
        Expected ""NameProps"", got ""PageProps"".
```

### Expected Behavior

The app builds with no issues

### Link to reproduction

https://github.com/alimehasin/next13-build-issue-temp

### To Reproduce

Run `yarn && yarn build`",shuding,kind: bug;area: TypeScript;area: app,2022-11-07T05:24:07Z,2022-11-23T14:57:19Z,alimehasin,balazsorban44;alimehasin;thematrixl;kingsky32;didomenicom;daveteu;shuding;mucahidyazar,alimehasin;balazsorban44,balazsorban44,shuding,,shuding,
vercel/next.js,42587,"Error: NEXT_REDIRECT crashing server in prod ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Operating System:
      Platform: win32
      Arch: x64
      Version: Windows 10 Pro
Binaries:
      Node: 16.15.1
      npm: N/A
      Yarn: N/A
      pnpm: N/A
Relevant packages:
      next: 13.0.3-canary.0
      eslint-config-next: 13.0.2
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Chrome Version 107.0.5304.88

### How are you deploying your application? (if relevant)

Vercel and localhost in prod environment

### Describe the Bug

Looks similar to #42556, but this issue is based on the server crashing

Whenever I run `yarn build && yarn start` and visit `http://localhost:3000/dashboard` i receive this error:
![](https://i.imgur.com/9fJk8nk.png)

The route `/dashboard` is set to route a user back to `/` if not logged in. This is done in a SC via the `redirect()` function.
This error crashes the server and I have to restart it, on a vercel deployment I just get a 500 error.

### Expected Behavior

I expect the page to redirect the user to the desired URL without the server crashing. 

### Link to reproduction

https://github.com/OMikkel/next_redirect_repro

### To Reproduce

1. Clone git repo above
2. Run yarn install
3. Run yarn build
4. Run yarn start
5. Go to /dashboard
6. Restart the app
7. Try again",hanneslund,kind: bug;area: app,2022-11-07T15:09:00Z,2022-11-15T13:46:56Z,OMikkel,adrian-goe;timneutkens;manuthecoder;jomarl,OMikkel;timneutkens;balazsorban44,balazsorban44,hanneslund,,,
vercel/next.js,42588,"TypeError: Cannot read properties of null (reading 'useState') ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: #43-Ubuntu SMP Wed Jun 15 12:54:21 UTC 2022
    Binaries:
      Node: 18.12.0
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.3-canary.0
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0


### What browser are you using? (if relevant)

Chrome 107.0.5304.87 (Official Build) (64-bit) 

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

After upgrading an existing website to Next 13, when `appDir` is enabled swiper code fails. The issue is reported to the swiper team [here](https://github.com/nolimits4web/swiper/issues/6187), but they said it's related to the Next.

### Expected Behavior

Swiper and Next 13 should work together, or an informative message should be shown to help easier debugging.

### Link to reproduction

https://github.com/Nefcanto/swiper-bug

### To Reproduce

1- Clone
2- `npm install`
3- `npm run dev`
4- go to **localhost:3000**
5- You should see *TypeError: Cannot read properties of null (reading 'useState')*

",shuding,kind: bug;area: app,2022-11-07T15:24:03Z,2022-11-10T17:11:41Z,Nefcanto,magnattic;gadingnst;shuding,Nefcanto;timneutkens;balazsorban44,balazsorban44,shuding,,shuding,
vercel/next.js,42697,"Query params getting stripped from index route (Next 13 - App dir) ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
Operating System:
  Platform: darwin
  Arch: arm64
  Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:15:09 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T6000
Binaries:
  Node: 18.4.0
  npm: 8.12.1
  Yarn: 1.22.19
  pnpm: N/A
Relevant packages:
  next: 13.0.2
  eslint-config-next: 13.0.2
  react: 18.2.0
  react-dom: 18.2.0
```

### What browser are you using? (if relevant)

Chrome

### How are you deploying your application? (if relevant)

Vercel

### Describe the Bug

When navigating to my website (example -> https://boilerplate-sandy.vercel.app/?utm_source=test) the url params are stripped from the url. This only happens on the root page and not on any nested routes.

I need the `utm_source` for campaign tracking, so would really appreciate some help!

### Expected Behavior

I'd expect the url params to stay in the url when visiting the page. Note that this is the behaviour on Next 12 apps.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

npx create-next-app@latest --experimental-app

### To Reproduce

This behaviour can be replicated by building a new Next 13 app with `npx create-next-app@latest --experimental-app`",timneutkens,kind: bug;template: bug;area: app,2022-11-09T17:07:27Z,2022-11-10T17:24:32Z,ben-greenwood,ceIia;timneutkens;ijjk,ben-greenwood;wyattjoh,,wyattjoh;timneutkens,timneutkens,ijjk,
vercel/next.js,42782,"Significant bundle size increase after switching to v13.0.3 ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 21.6.0: Mon Aug 22 20:20:05 PDT 2022; root:xnu-8020.140.49~2/RELEASE_ARM64_T8101
    Binaries:
      Node: 18.12.0
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: 7.14.2
    Relevant packages:
      next: 13.0.3
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Starting with `13.0.3-canary.0` (and newer releases) the resulting bundles have a significant increase in size. 

For the starter app created using `npx create-next-app@latest nextjs-starter --use-npm --example ""https://github.com/vercel/next-learn/tree/master/basics/learn-starter""` the build results are as the following:

**v13.0.2**:
```
Route (pages)                              Size     First Load JS
閳 閳 /                                      5.05 kB        77.7 kB
閳 閳 /404                                   181 B          72.9 kB
+ First Load JS shared by all              72.7 kB
  閳 chunks/framework-8c5acb0054140387.js   45.4 kB
  閳 chunks/main-85616fa12b5fff02.js        26.3 kB
  閳 chunks/pages/_app-df511a3677d160f6.js  194 B
  閳 chunks/webpack-ee7e63bc15b31913.js     815 B

閳  (Static)  automatically rendered as static HTML (uses no initial props)
```

**v13.0.3**:
```
Route (pages)                              Size     First Load JS
閳 閳 /                                      5.75 kB        84.6 kB
閳 閳 /404                                   212 B            79 kB
+ First Load JS shared by all              78.8 kB
  閳 chunks/framework-0f397528c01bc177.js   45.7 kB
  閳 chunks/main-e71c796c4d7cc2e4.js        31.8 kB
  閳 chunks/pages/_app-ef9da0a6572b3989.js  243 B
  閳 chunks/webpack-7a6cea4e6a92562f.js     1.08 kB
```

This gives 8-9% increase in the First Load JS, just for the starter app.
For the apps I am working on, upgrade to v13.0.3 gave even larger numbers (20-25%). 


### Expected Behavior

No increase in bundles size or the reasoning behind it.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/vercel/next-learn/tree/master/basics/learn-starter

### To Reproduce

Checkout the code and run build using `v13.0.2` and `v13.0.3`.",kdy1,kind: bug;area: SWC Minify,2022-11-11T10:57:28Z,2022-11-11T14:55:40Z,piotr-czerwik,will-stone,piotr-czerwik;balazsorban44,balazsorban44,kdy1,,,
vercel/next.js,42801,"SVGs (specifically Lottie file SVG json) not rendering properly in 13.0.3 ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:15:09 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T6000
    Binaries:
      Node: 16.17.1
      npm: 8.15.0
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.3
      eslint-config-next: 13.0.3
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Firefox

### How are you deploying your application? (if relevant)

Vercel

### Describe the Bug

After upgrading to Next 13.0.3, Lottie files (animated SVG json) are not rendering properly:

![image](https://user-images.githubusercontent.com/222170/201390146-e4e63d4f-f2e5-4161-aef9-e0aa135c7578.png)

Should look like:
![image](https://user-images.githubusercontent.com/222170/201390202-d3e980d8-8226-4c52-b720-b36e7977688a.png)


### Expected Behavior

![image](https://user-images.githubusercontent.com/222170/201390216-385a7442-cb82-4763-9f71-c4cdfee29e01.png)

Lottie files should rendering SVG properly. Not sure exactly where this regressed in the latest.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://rhythm-marketing-git-package-updates-111122-gotrhythm.vercel.app/

### To Reproduce

Have a site running 13.0.3 that uses Lottie files using `react-lottie-player`",kdy1,kind: bug;area: SWC Minify,2022-11-11T16:56:07Z,2022-11-20T02:18:32Z,wadehammes,wadehammes;jajaperson;jordanlambrecht;DavidChouinard;balazsorban44;smitpatelx;sadam21x;shuvamk;cangel111,wadehammes;balazsorban44,balazsorban44,,,wadehammes,
vercel/next.js,42852,"13.0.3+13.0.4 production builds cause some external libraries to misbehave ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:15:09 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T6000
    Binaries:
      Node: 18.11.0
      npm: 8.19.2
      Yarn: 3.2.4
      pnpm: N/A
    Relevant packages:
      next: 13.0.3
      eslint-config-next: 13.0.3
      react: 18.2.0
      react-dom: 18.2.0
```

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Production builds of next 13.0.3 cause [luxon](https://www.npmjs.com/package/luxon) to break - I suspect the impact is more widespread than just this library hence reporting here.

Development builds work fine.

The specific issue I'm seeing is that `DateTime.now().toISO()` should return an ISO date-time string (e.g `2022-11-13T00:00:00+1:00`). In 13.0.3 I just receive the GMT offset part (e.g. `+1:00`).

Versions <= 13.0.2 are fine; canary is broken.

### Expected Behavior

Production builds should not break applications.

Production builds should not differ in behavior to development builds.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://stackblitz.com/edit/vercel-next-js-ph9din

### To Reproduce

See [reproduction](https://stackblitz.com/edit/vercel-next-js-ph9din?file=pages%2Findex.tsx) for example code.

Create a build (`next build`) and start the server (`next start`) and see that only the timezone offset is displayed.",kdy1,kind: bug;area: SWC Minify,2022-11-13T09:08:33Z,2022-11-20T02:18:34Z,apancutt,mutewinter;apancutt;karlhorky;kdy1;kolorfilm;iscekic;balazsorban44;niranjan94;davecarlson,apancutt;balazsorban44,balazsorban44,kdy1,,ijjk,vercel/next.js#43042;
vercel/next.js,42874,"[Appdir] Using app directory inside src directory cause First Load JS shared by all equal 0kb ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

- Operating System:
  - Platform: win32
  - Arch: x64
  - Version: Windows 10 Home Single Language
- Binaries:
  - Node: 18.12.1
  - npm: N/A
  - Yarn: N/A
  - pnpm: 7.15.0
- Relevant packages:
  - next: 13.0.3
  - eslint-config-next: 13.0.3
  - react: 18.2.0
  - react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

Put app directory inside src directory cause First Load JS shared by all equal 0kb on build

### Expected Behavior

First Load JS shared by all not equal 0kb

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://stackblitz.com/edit/vercel-next-js-m3shiy

### To Reproduce

1. Init project with create-next-app with --experimental-app flag
2. Move both pages and app into src directory
3. Run next build",shuding,kind: bug;area: app,2022-11-14T07:08:30Z,2022-11-22T14:03:48Z,Noki-Asakuri,hanneslund;NuroDev,Noki-Asakuri;timneutkens,timneutkens,timneutkens;shuding,shuding,,
vercel/next.js,42972,"[appDir] Co-located components in catch-all slug causes error if named with ""page"" in name ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: linux
      Arch: x64
      Version: #1 SMP Wed Mar 2 00:30:59 UTC 2022
    Binaries:
      Node: 16.18.1
      npm: 9.1.1
    Relevant packages:
      next: 13.0.4-canary.2
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

If you [co-locate](https://beta.nextjs.org/docs/routing/fundamentals#colocation) a component in a [catch-all segment (`[...slug]`)](https://beta.nextjs.org/docs/routing/defining-routes#catch-all-and-optional-catch-all-segments) with a name that ends with `page.(js|tsx?)`, you get `Error: Catch-all must be the last part of the URL.`

### Expected Behavior

Either it works, or better error message and documentation.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/oBusk/catch-all-components

### To Reproduce

Using `appDir`, create a catch-all segment.

```
棣冩惂 [...slug]
  棣冩憪 page.tsx
```

Now you want to have some component co-located with the page code. If you name it any of 

- `[...slug]/page.client.tsx`
- `[...slug]/this-is-not-a-page-but-ends-with-page.tsx`
- `[...slug]/components/the-page.tsx`

You will recieve a error 

```
Error: Catch-all must be the last part of the URL.
    at UrlNode._insert ({repo-dir}/node_modules/next/dist/shared/lib/router/utils/sorted-routes.js:54:19)
    at UrlNode._insert ({repo-dir}/node_modules/next/dist/shared/lib/router/utils/sorted-routes.js:136:40)
    at UrlNode.insert ({repo-dir}/node_modules/next/dist/shared/lib/router/utils/sorted-routes.js:8:14)
    at {repo-dir}/node_modules/next/dist/shared/lib/router/utils/sorted-routes.js:159:46
    at Array.forEach (<anonymous>)
    at Object.getSortedRoutes ({repo-dir}/node_modules/next/dist/shared/lib/router/utils/sorted-routes.js:159:21)
    at Watchpack.<anonymous> ({repo-dir}/node_modules/next/dist/server/dev/next-dev-server.js:437:55)
```

I suspect there is some check for `page` but not actually checking if file is _only_ named `page`. From what I can tell in the [Special Files](https://beta.nextjs.org/docs/routing/fundamentals#special-files) documentation, _only_ `page.tsx` should be special, and `this-is-not-a-page.tsx` or even `page.client.tsx` should work.",hanneslund,kind: bug;area: Developer Experience;area: app,2022-11-16T01:24:39Z,2022-11-16T21:46:06Z,oBusk,,oBusk;balazsorban44,balazsorban44,hanneslund,,ijjk,
vercel/next.js,43027,"dropzone.js can't be loaded if I use swc ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:30 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8103
    Binaries:
      Node: 19.0.1
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: 7.16.0
    Relevant packages:
      next: 13.0.3
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I use dropzone.js for my nextjs project. I can use it in dev mode, but can't use it for ssg mode.

If I export for ssg, I get the error: `extend is not defined`. 

Then I try to use `dynamic import` with `ssr: false`, nothing has changed, it's returns same error.

But, If I disable `swcMinify`, it can be used. 

P.S. I disable it, but output file size is smaller. why?

### Expected Behavior

dropzone.js can be use for ssg with swcMinify.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/0ldm0s/dropzone-demo

### To Reproduce

set `swcMinify: true` in `next.config.js`",kdy1,kind: bug;area: SWC Minify,2022-11-17T08:39:49Z,2022-11-20T02:18:33Z,0ldm0s,balazsorban44,0ldm0s;balazsorban44,balazsorban44,kdy1,,ijjk,
vercel/next.js,43042,"`next build` breaks @microsoft/signalr [v13.0.3, canary] ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:30 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8103
    Binaries:
      Node: 18.7.0
      npm: 8.15.0
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.4-canary.3
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

The built app doesn't behave as the dev app, see screenshot

<img width=""602"" alt=""Screenshot 2022-11-17 at 16 53 42"" src=""https://user-images.githubusercontent.com/1120395/202498460-c3428b17-242e-4181-8319-97874226aed4.png"">

I was able to identify the function in https://www.npmjs.com/package/@microsoft/signalr that doesn't compile correctly
(the reproduction code contains only this function)

```js
function resolveNegotiateUrl(url) {
  const index = url.indexOf(""?"");
  let negotiateUrl = url.substring(0, index === -1 ? url.length : index);
  if (negotiateUrl[negotiateUrl.length - 1] !== ""/"") {
    negotiateUrl += ""/"";
  }
  negotiateUrl += ""negotiate"";
  negotiateUrl += index === -1 ? """" : url.substring(index);
  if (negotiateUrl.indexOf(""negotiateVersion"") === -1) {
    negotiateUrl += index === -1 ? ""?"" : ""&"";
    negotiateUrl += ""negotiateVersion=1"";
  }
  return negotiateUrl;
}
```


I pasted the function into the [SWC playground](https://play.swc.rs/?version=1.3.18&code=H4sIAAAAAAAAA32QTQ6CMBCF9z3F2IWpUVS2koYb6Eo3xoXigE2akrTFmBjubik%2FAhF37bx5b76ZtFCJFbkCjSaXT9xjlltxtXjUkhVaLuBNAJJcGQtC3fEFHFx57d%2BHlNGYLiLXIdGC6nmbNlPcjNVCZWy7av2cQxBC7HWJKrMP2NWaTxIpsH7Suf9pDQGEF5i5JLqhNSIMxy%2B9VOWV5IfUFXzLWB6BUuoAh9tM434v01VPqI07sQOtI6eAx2Pjai6de8R%2FOzT5POz21WgLrQaWiJTkAxl4R9XtAQAA&config=H4sIAAAAAAAAA0WNSw6DMAxE7%2BI123bBHXqIKDUoVX7yGKkoyt3rABU7ez5vGn3gaW5UnYBlXNizui%2FNpHtleAlVaSKFSYuL4G6Pk5XVIoyHebEU8OVOlEIOyz5IvqQqDNyWy2v8J7uBUnlvQ2jH2AF8Ur8ZKpvVAl5X7iz%2BAPJfOO21AAAA) but I couldn't reproduce the issue.

### Expected Behavior

The application behaves the same in dev and build mode.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/acoiro/next-13.0.3-build-bug

### To Reproduce

Run the reproduction code

```sh
git clone git@github.com:acoiro/next-13.0.3-build-bug.git
cd next-13.0.3-build-bug
npm install
npm run dev
```

Navigate to http://localhost:3000/ and see the correct output.

Now build and run the app

```sh
npm run build && npm start
```

Navigate to http://localhost:3000/ and see a different output.",kdy1,kind: bug;area: SWC Minify,2022-11-17T16:43:09Z,2022-11-20T02:18:33Z,acoiro,niranjan94,acoiro;balazsorban44,balazsorban44,kdy1,,ijjk,
vercel/next.js,43052,"using @w3ui/react-uploader UploaderProvider in a Next.js app with SWC minification enabled breaks in production builds ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.4.0: Fri Mar 18 00:45:05 PDT 2022; root:xnu-8020.101.4~15/RELEASE_X86_64
    Binaries:
      Node: 16.13.1
      npm: 8.1.2
      Yarn: 1.22.19
      pnpm: 7.13.4
    Relevant packages:
      next: 13.0.4-canary.3
      eslint-config-next: 13.0.3
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Brave Version 1.45.127 Chromium: 107.0.5304.110 (Official Build) (x86_64)

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

If I use the `UploaderProvider` from `w3ui/react-uploader` in my app it works fine in dev mode (`npm run dev`) but the app throws errors (https://reactjs.org/docs/error-decoder.html/?invariant=130&args[]=undefined&args[]= and https://reactjs.org/docs/error-decoder.html/?invariant=423) when run in a production build with SWC minification enabled (`npm run build && npm start`). 

Disabling SWC minification in Next 12, 13 or canary fixes the issue.

### Expected Behavior

Apps using `UploaderProvider` should work the same in development and production mode, with SWC minification enabled or disabled.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/web3-storage/w3ui-swc-minify-bug

### To Reproduce

Clone https://github.com/web3-storage/w3ui-swc-minify-bug and run `npm install && npm run build && npm start` and then visit http://localhost:3000

Disable SWC minification (as demonstrated on this branch https://github.com/web3-storage/w3ui-swc-minify-bug/tree/fixed) to fix this issue. The issue also does not occur when running with `npm run dev`.",kdy1,kind: bug;area: SWC Minify,2022-11-17T21:08:03Z,2022-12-19T21:10:04Z,travis,kdy1,travis;balazsorban44,balazsorban44,kdy1,,ijjk,
vercel/next.js,43059,"Dynamic = 'error' throws exception on very simple static page ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:15:09 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T6000
    Binaries:
      Node: 17.8.0
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: 7.16.1
    Relevant packages:
      next: 13.0.4-canary.5
      eslint-config-next: 13.0.3
      react: 18.2.0
      react-dom: 18.2.0


### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_

### Describe the Bug

I have a freshly installed next@canary build (`yarn create next-app --experimental-app`).

I created a simple page with the following code (located in `app/test/page.tsx`):

```typescript
export const dynamic = ""error""

export default function Page() {
  return <div>Nice!</div>
}

```

When running `yarn build`, I get an exception:

```bash
Error occurred prerendering page ""/test"". Read more: https://nextjs.org/docs/messages/prerender-error
Error: Page with dynamic = ""error"" encountered dynamic data method /test.
    at /Users/colinarms/src/nextplayground/test/node_modules/next/dist/export/worker.js:192:31
    at async Span.traceAsyncFn (/Users/colinarms/src/nextplayground/test/node_modules/next/dist/trace/trace.js:79:20)

```

This is a very simple static page with no dynamic fetches, so `dynamic = 'error'` shouldn't throw any exceptions.

### Expected Behavior

The static page should get generated with no issue.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/seeARMS/nextjs-dynamic-repro

### To Reproduce

1. Git clone repo
2. Run `yarn build`
3. Exception occurs and build fails",hanneslund,kind: bug;area: app,2022-11-18T04:52:40Z,2022-11-26T00:39:31Z,seeARMS,,seeARMS;balazsorban44,balazsorban44,hanneslund,,ijjk,
vercel/next.js,43060,"Compilation result does not conform to expectation ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:15:52 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8112
    Binaries:
      Node: 16.15.0
      npm: 8.5.5
      Yarn: 1.22.15
      pnpm: N/A
    Relevant packages:
      next: 13.0.3
      eslint-config-next: 12.1.5
      react: 18.2.0
      react-dom: 18.2.0
```

### Which example does this report relate to?

-

### What browser are you using? (if relevant)

Chrome 107.0.5304.110

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

The development mode is normal, but the compiled results run abnormally.
Question 1
---
```javascript
let str1 = ""Hello"";
let str2 = "" world""
let result = false ? 'wss' : 'https';
result += `://${str1}`;
result += str2;

// ://Hello world
console.log(result);
```

Question 2
---
Some styles will be ignored in the build result.

![image](https://user-images.githubusercontent.com/5469785/202620547-00a918e7-9f52-41f0-8063-f4ad522f4381.png)


### Expected Behavior

Question 1
---

```javascript
// https://Hello world
console.log(result);
```

Question 2
---
![image](https://user-images.githubusercontent.com/5469785/202619927-ed792967-ec49-4ad2-a0d9-8b9d689ff426.png)


### To Reproduce

```javascript
let str1 = ""Hello"";
let str2 = "" world""
let result = false ? 'wss' : 'https';
result += `://${str1}`;
result += str2;

console.log(result);
```",kdy1,kind: bug;area: SWC Minify,2022-11-18T04:55:44Z,2022-11-20T02:18:33Z,sbfkcel,balazsorban44;sbfkcel,sbfkcel;balazsorban44,balazsorban44,kdy1,,ijjk,
vercel/next.js,43080,"useServerInsertedHTML's callback is not called when experimental-edge flag is enabled ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    npx --no-install next info

    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.6.0: Mon Aug 22 20:20:05 PDT 2022; root:xnu-8020.140.49~2/RELEASE_ARM64_T8101
    Binaries:
      Node: 18.9.0
      npm: 8.19.1
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.4-canary.5
      eslint-config-next: 13.0.4
      react: 18.2.0
      react-dom: 18.2.0

    warn  - Latest canary version not detected, detected: ""13.0.4-canary.5"", newest: ""13.0.4"".
    Please try the latest canary version (`npm install next@canary`) to confirm the issue still exists before creating a new issue.
    Read more - https://nextjs.org/docs/messages/opening-an-issue

### What browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

Cloudflare Pages

### Describe the Bug

I created a new Next 13 + styled-components app by following [the beta docs](https://beta.nextjs.org/docs/styling/css-in-js#styled-components) and I was able to get it to work to render a stateless component with some basic styling.

Then when I enabled `experimental-edge` runtime on next.config.js (to deploy Edge API Routes to Cloudflare Pages), none of the styling is being applied. From a quick debugging, I found that the callback passed to `useServerInsertedHTML` in RootStyleRegistry.tsx never gets called.

Note: there is a similar, but possibly unrelated issue with dynamic styling, which is already tracked in [styled-components repo](https://github.com/styled-components/styled-components/issues/3856).

### Expected Behavior

I expect the callback that I passed to `useServerInsertedHTML` to be called at least once so that the app contains server-rendered stylesheet.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/itsuka-dev/memoire

### To Reproduce

1. run `yarn dev`
2. open localhost:3000
3. observe that the text on the page does not have any styling applied from `Title` component (e.g. `font-family`)",huozhi,kind: bug;area: app,2022-11-18T14:16:11Z,2022-11-23T18:01:18Z,itsuka-dev,,itsuka-dev;balazsorban44,balazsorban44,huozhi,,,
vercel/next.js,43147,"[appDir] Dynamically importing a Client Component using the 'use client' directive from a Server Component causes ""Error: object is not a function"" ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:30 PDT 2022; root:xnu-8792.41.9~2/RELEASE_ARM64_T8103
    Binaries:
      Node: 14.18.0
      npm: 6.14.15
      Yarn: 1.22.17
      pnpm: 7.14.1
    Relevant packages:
      next: 13.0.5-canary.3
      eslint-config-next: 13.0.5-canary.3
      react: 18.2.0
      react-dom: 18.2.0

### What browser are you using? (if relevant)

Firefox 107.0

### How are you deploying your application? (if relevant)

Vercel

### Describe the Bug

Dynamically importing with `next/dynamic` a Client Component that uses a `use/client` directive will cause an `Error: object is not a function` error in development. The production build runs fine though. 

Also noticed that adding `ssr: false` won't prevent the component from getting prerendered when running `next build`. Adding `suspense: true` or `suspense: false` won't make a difference either.

### Expected Behavior

We should be able to dynamically import a component that makes heavy use of JavaScript in the client from a Server Component and use a custom Suspense-based fallback.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/brvnonascimento/use-client-dynamic-bug

### To Reproduce

1. Run `yarn create next-app --experimental-app`
2. Create a Client Component by adding the `'use client'` directive
3. Use `next/dynamic` to import the given component
4. See `Error: object is not a function` in development

```tsx
import dynamic from ""next/dynamic"";
import { Suspense } from ""react"";

const ClientTest = dynamic(() => import(""./ClientTest""));

export default function Home() {
  return (
    <div>
      <Suspense fallback={<h1>Loading...</h1>}>
        <ClientTest />
      </Suspense>
    </div>
  );
}
```

https://user-images.githubusercontent.com/34252418/202890528-83f01938-555a-426a-ab6f-4c3cb8885ab5.mov



",huozhi,kind: bug;area: next/dynamic;area: app,2022-11-20T07:17:55Z,2022-12-07T18:42:12Z,brvnonascimento,brvnonascimento;balazsorban44;huozhi,brvnonascimento;balazsorban44;huozhi,balazsorban44;huozhi,huozhi,,huozhi,
vercel/next.js,43208,"Error in production version minification in next 13, error not in next 12 or dev version of next 13 ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
yarn next info
yarn run v1.22.19
$ /home/cdiesh/out/node_modules/.bin/next info

    Operating System:
      Platform: linux
      Arch: x64
      Version: #25-Ubuntu SMP PREEMPT_DYNAMIC Mon Nov 14 14:06:02 UTC 2022
    Binaries:
      Node: 18.12.1
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.5-canary.3
      eslint-config-next: 13.0.4
      react: 18.2.0
      react-dom: 18.2.0

Done in 0.97s.

```

### What browser are you using? (if relevant)

Chrome 107.0.5304.110, also Firefox 107.0

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

I have an app where in dev mode (next dev) the app works, but next build+next start appears to introduce a minification bug. It works with next 12.x but appeared to cause issue with next 13. I don't have a super minimal example (yet) but can try to find one if interested (and similarly, move to another repo like swc if it makes sense?)

### Expected Behavior

Minification should produce a valid program

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/cmdcolin/nextjs-13-minify-error

### To Reproduce


I reduced the example somewhat to the usage of (our) library https://github.com/GMOD/cram-js/ and made a smaller reproducible example here https://github.com/cmdcolin/nextjs-13-minify-error


The TLDR of how this example was made was just a simple create-next-app with next 13, add @gmod/cram library, add basic usage of this library to pages/index.tsx, and run in production produces the syntax error from bad minification. I did `yarn add next@canary` and had the same bug

The app works with next 12 though

I could possibly make the reproducible case more minimal if interested",kdy1,kind: bug;area: SWC Minify,2022-11-22T00:53:55Z,2022-12-10T15:18:58Z,cmdcolin,cmdcolin;ijjk;balazsorban44;kdy1,cmdcolin;balazsorban44,balazsorban44,kdy1,,kdy1,
vercel/next.js,43292,"Next 13 /app directory minification bug with hls.js ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```
    Operating System:
      Platform: darwin
      Arch: arm64
      Version: Darwin Kernel Version 22.2.0: Tue Nov  8 21:14:19 PST 2022; root:xnu-8792.60.55.131.1~1/RELEASE_ARM64_T6000
    Binaries:
      Node: 18.11.0
      npm: 8.19.2
      Yarn: 1.22.19
      pnpm: N/A
    Relevant packages:
      next: 13.0.6-canary.0
      eslint-config-next: N/A
      react: 18.2.0
      react-dom: 18.2.0
```

### What browser are you using? (if relevant)

Not relevant

### How are you deploying your application? (if relevant)

next start

### Describe the Bug

When using `hls.js` with the new `/app` directory, videos played no longer work, because of a syntax error in a blob file, presumable caused by a minification bug.

Running the reproduction project using `yarn dev` works as expected, it's only when running the project in production that the problem occurs, using `yarn build && yarn start`.

It looks to me that it's a bug with minifying the project, but turning setting `swcMinify` to `false` in `next.config.js` file changes nothing.

Here's the generated blob resource link generated by `hls.js`:
```
blob:http://localhost:3000/ad2e6aa9-8f44-49e6-8925-af7919a1744b
```
It succeeds with an ok status code of `200`, but when parsing the file it encounters issues as it it seems like it's got a syntax error.
Here's the contents of the file:
```javascript
((function(){var t={""./src/demux/transmuxer-worker.ts"": ""./src/demux/transmuxer-worker.ts""(t,e,r){""use strict"";r.r(e),r.d(e,{default:()=>o});var i=r(/*! ../demux/transmuxer */ ""./src/demux/transmuxer.ts""),n=r(/*! ../events */ ""./src/events.ts""),a=r(/*! ../utils/logger */ ""./src/utils/logger.ts""),s=r(/*! eventemitter3 */ ""./node_modules/eventemitter3/index.js"");function o(t){var e=new s.EventEmitter,r=function(e,r){t.postMessage({event:e,data:r})};e.on(n.Events.FRAG_DECRYPTED,r),e.on(n.Events.ERROR,r);var o=function(){var t=function(t){a.logger[t]=function(e){r(""workerLog"",{logType:t,message:e})}};for(var e in a.logger)t(e)};t.addEventListener(""message"",function(n){var s=n.data;switch(s.cmd){case""init"":var u=JSON.parse(s.config);t.transmuxer=new i.default(e,s.typeSupported,u,s.vendor,s.id),(0,a.enableLogs)(u.debug,s.id),o(),r(""init"",null);break;case""configure"":t.transmuxer.configure(s.config);break;case""demux"":var c=t.transmuxer.push(s.data,s.decryptdata,s.chunkMeta,s.state);(0,i.isPromise)(c)?c.then(function(e){l(t,e)}):l(t,c);break;case""flush"":var h=s.chunkMeta,f=t.transmuxer.flush(h);(0,i.isPromise)(f)?f.then(function(e){d(t,e,h)}):d(t,f,h)}})}function l(t,e){if(!(r=e.remuxResult).audio&&!r.video&&!r.text&&!r.id3&&!r.initSegment)return!1;var r,i=[],n=e.remuxResult,a=n.audio,s=n.video;return a&&u(i,a),s&&u(i,s),t.postMessage({event:""transmuxComplete"",data:e},i),!0}function u(t,e){e.data1&&t.push(e.data1.buffer),e.data2&&t.push(e.data2.buffer)}function d(t,e,r){e.reduce(function(e,r){return l(t,r)||e},!1)||t.postMessage({event:""transmuxComplete"",data:e[0]}),t.postMessage({event:""flush"",data:r})}}},e={};function r(i){var n=e[i];if(void 0!==n)return n.exports;var a=e[i]={exports:{}};return t[i].call(a.exports,a,a.exports,r),a.exports}r.m=t,r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,{a:e}),e},r.d=function(t,e){for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.r=function(t){""undefined""!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:""Module""}),Object.defineProperty(t,""__esModule"",{value:!0})};var i=r(""./src/demux/transmuxer-worker.ts"");return i.default||i})())(self);
```
And the browser console simply logs this error:
```
ad2e6aa9-8f44-49e6-8925-af7919a1744b:1 Uncaught SyntaxError: Unexpected token '{' (at ad2e6aa9-8f44-49e6-8925-af7919a1744b:1:98)
```

### Expected Behavior

When using `hls.js` with the new `/app` directory, videos should work as they did before in the `/pages` directory and have the same behaviour in both the development server and the production build.

### Link to reproduction - Issues with a link to complete (but minimal) reproduction code will be addressed faster

https://github.com/Puharesource/next-app-directory-with-hls-bug

### To Reproduce

### 1. Build the project
```
yarn build
```

### 2. Run the project
```
yarn start
```

### 3. Navigate to the index page
```
http://localhost:3000
```

### 4. Failure
The video element won't load the video and the console throws an error.",kdy1,kind: bug;area: SWC Minify,2022-11-23T14:09:50Z,2022-11-29T17:31:37Z,Puharesource,Puharesource;balazsorban44;kdy1,Puharesource;balazsorban44,balazsorban44,kdy1,,balazsorban44,
vercel/next.js,43854,"use of client components causes error in 13.0.7-canary.3 ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

    Operating System:
      Platform: win32
      Arch: x64
      Version: Windows 10 Pro
    Binaries:
      Node: 18.4.0
      npm: N/A
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 13.0.7-canary.3
      eslint-config-next: 13.0.7-canary.3
      react: 18.2.0
      react-dom: 18.2.0

### Which area(s) of Next.js are affected? (leave empty if unsure)

_No response_

### Link to the code that reproduces this issue
https://github.com/rafma0/next-brokenuseclient
閵

### To Reproduce

Test.tsx
```js
'use client'

export default function Test () {
  return (
    <p>test</p>
  )
}
```

page.tsx
```js
import Test from './Test'

export default function HomePage () {
  return (
    <Test />
  )
}
```



### Describe the Bug

Trying to use a client component in server page results in

```console
Uncaught TypeError: Cannot read properties of undefined (reading 'call')
The above error occurred in the <NotFoundErrorBoundary> component
Uncaught Error: There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering.
```

### Expected Behavior

The same code works fine in `13.0.7-canary.1`

### Which browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_",huozhi,kind: bug,2022-12-08T17:15:37Z,2022-12-15T18:34:03Z,rafma0,frankandrobot;rafma0;ElektrikSpark;TszHong0411;e2goon;huozhi;andreaskromann;bruceharrison1984,rafma0;huozhi,huozhi,huozhi,,huozhi,
vercel/next.js,43878,"Next 13 + experimental app dir + Tailwind hot-reload of classes doesn't work ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

閴 npx next info

    Operating System:
      Platform: darwin
      Arch: x64
      Version: Darwin Kernel Version 21.6.0: Thu Sep 29 20:12:57 PDT 2022; root:xnu-8020.240.7~1/RELEASE_X86_64
    Binaries:
      Node: 16.16.0
      npm: 8.11.0
      Yarn: 2.4.3
      pnpm: N/A
    Relevant packages:
      next: 13.0.7-canary.3
      eslint-config-next: 13.0.3
      react: 18.2.0
      react-dom: 18.2.0

### Which area(s) of Next.js are affected? (leave empty if unsure)

_No response_

### Link to the code that reproduces this issue

https://github.com/vercel/app-playground

### To Reproduce

- Grab latest version of Next.js with experimental app dir enabled ([I'm using the playground example](https://github.com/vercel/app-playground))
- Load project, go to `/streaming`
- In your editor, go to `Product.tsx` and edit a class with a width class `w-*` (go to line 75)
- Swap `w-1/3` for `w-6/12` save and wait for hot-reload (**don't** manually refresh the page)
- You won't see your new class applied, element will break due to class not being applied
- Go back to editor and try now `w-10/12`, wait for hot-reload. Same result as above.
- Set it now to `w-6/12` and manually reload, you will see your class now (and it seems to be caching this class now)
- If you repeat the steps above `w-6/12` won't fail anymore because it seems to be cached now somehow

### Describe the Bug

Hot reloading of Tailwind CSS when you change classes in your code doesn't work. 
Only works after you apply a new class and manually reload the page.

Bug in action:
![bug](https://user-images.githubusercontent.com/364003/206681426-b3c4363f-94ab-470f-9a39-b83d16d4d08b.gif)


### Expected Behavior

Swapping Tailwind classes from elements should work when hot-reloading.

### Which browser are you using? (if relevant)

Chrome  108.0.5359.98 (Official Build) (x86_64)

### How are you deploying your application? (if relevant)

Locally (npm run dev)",shuding;huozhi,kind: bug;area: Server Components;area: app,2022-12-09T10:28:16Z,2022-12-19T16:24:17Z,Dannymx,ciruz;ElektrikSpark;huozhi;Dannymx;asheikho99;jstnmthw;DerTyp876;denizyoldas;phuson;iamjohnlong;Melvynx;mxswat;Rikimbili;jupelost;robert-yates;babaei-mostafa;ondrej-langr;nghiepdev;teddybee;PatrikTheDev;mmiszy;masasidan;surjithctly,Dannymx;huozhi,huozhi,,,Dannymx,
vercel/next.js,43902,"Dev mode error: ""originalFactory is undefined"" when importing client component (""use client"") from other package ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

```

    Operating System:
      Platform: win32
      Arch: x64
      Version: Windows 10 Pro
    Binaries:
      Node: 19.0.0
      npm: N/A
      Yarn: N/A
      pnpm: N/A
    Relevant packages:
      next: 13.0.7-canary.4
      eslint-config-next: 13.0.0
      react: 18.2.0
      react-dom: 18.2.0
```

### Which area(s) of Next.js are affected? (leave empty if unsure)

App directory (appDir: true)

### Link to the code that reproduces this issue

Repro here: https://github.com/reiv/next-canary-test

### To Reproduce

- clone the repro
- install deps
- run `next dev` in the `apps/web`
- observe error immediately after page loads

### Describe the Bug

(The repro is based on the turborepo starter, modified to use `appDir: true` as well as the latest canary.)

Importing a React client component from a module outside of the Next app causes `TypeError: originalFactory is undefined`. This only occurs in dev mode, and seems to be limited to client components (""use client"") - non-client components can be imported without error.

The bug exists as of `13.0.7-canary.3` (`13.0.7-canary.1` works fine).

### Expected Behavior

No error in dev mode.

### Which browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_",huozhi,kind: bug,2022-12-09T18:23:08Z,2022-12-14T18:52:54Z,reiv,Fluxium2006;reiv;rafma0,reiv;huozhi,huozhi,huozhi,,huozhi,vercel/next.js#43854;
vercel/next.js,43915,"next/dynamic - Named exports don`t work anymore in 13.0.7-canary.3 and 4, working in canary 1 (canary 2 was not released) ### Verify canary release

- [X] I verified that the issue exists in the latest Next.js canary release

### Provide environment information

Use 13.0.7-canary.1 - 4

### Which area(s) of Next.js are affected? (leave empty if unsure)

_No response_

### Link to the code that reproduces this issue

No reproduction because its a type issue, I will propably do a screenshot

### To Reproduce

Use any next/dynamic with named exports

Either import a relative path wise located module

```
const DynamicComponent = dynamic(() =>import('../components/hello').then((mod) => mod.Hello));
```

Or 
```
const Demonstrator = dynamic(() => import('@demonstrators-social/layout').then(module => module.Demonstrator));
```

**Note:**
From a build perspective, a respective component loads with next/dynamic even when the following error gets shown, but only in dev mode. A production build fails according due to the type incompatibility.

The following message gets shown

```
Argument of type '() => Promise<ComponentModule<{}> | FC<StatementProps & { children: ReactNode; }>>' is not assignable to parameter of type 'Loader<{}> | DynamicOptions<{}>'.
  Type '() => Promise<ComponentModule<{}> | FC<StatementProps & { children: ReactNode; }>>' is not assignable to type 'Loader<{}>'.
    Type 'Promise<ComponentModule<{}> | FC<StatementProps & { children: ReactNode; }>>' is not assignable to type 'LoaderComponent<{}>'.
      Type 'ComponentModule<{}> | FC<StatementProps & { children: ReactNode; }>' is not assignable to type 'ComponentModule<{}>'.
        Property 'default' is missing in type 'FunctionComponent<StatementProps & { children: ReactNode; }>' but required in type 'ComponentModule<{}>'.ts(2345)
dynamic.d.ts(4, 5): 'default' is declared here.
```

### Describe the Bug

It is a Typescript type problem, most probably to this commit https://github.com/vercel/next.js/commit/cd0ebd8e8cf922360a6d3150b29c90013cd92d48 landed in canary 3.

The respective definition, which causes the issue, is located in the dynamic.d.ts file when installing next. In the source repo the definitions are located in packages/next/shared/lib/dynamic.tsx

**before the commit** 

```
export declare type LoaderComponent<P = {}> = Promise<React.ComponentType<P> | {
   default: React.ComponentType<P>;
}>;
export declare type Loader<P = {}> = (() => LoaderComponent<P>) | LoaderComponent<P>;
```

**now** 
```
declare type ComponentModule<P> = {
    default: React.ComponentType<P>;
};
export declare type LoaderComponent<P = {}> = Promise<ComponentModule<P>>;

export declare type Loader<P = {}> = () => LoaderComponent<P>;
```

### Expected Behavior

Make types for named exports work again.

### Which browser are you using? (if relevant)

_No response_

### How are you deploying your application? (if relevant)

_No response_",huozhi,kind: bug;area: next/dynamic,2022-12-10T10:20:23Z,2022-12-10T17:35:14Z,gurkerl83,gurkerl83,gurkerl83;huozhi,huozhi,huozhi,,,
vercel/next.js,457,next/css deprecation warning shows even though I'm not using next/css anywhere,nkzawa,kind: bug,2016-12-21T12:59:00Z,2016-12-21T18:43:32Z,luisrudge,rauchg,nkzawa,,nkzawa,,rauchg,
vercel/next.js,4605,"Silently catched error in _app.js getInitialProps # Bug report

## Describe the bug

When an error is thrown in `_app.js` `getInitialProps` on the client side, the error is silently catched and navigation is broken without any error output.

Why it's a problem? As a developer, if you unfortunately generate an error in `_app.js` `getInitialProps`, you suddenly have a broken navigation and have no idea what's happening and where to look at.

## To Reproduce

1. Go to https://app-getinitialprops-silent-error-gbvspsorhf.now.sh/
2. Click on 'Say Hello?'
4. Not navigating to `/hello`, no error output.

## Expected behavior

Navigating to `/hello` OR error output.

## Source

https://github.com/opencollective/next-issues/tree/master/app-getInitialProps-silent-error",timneutkens,kind: bug,2018-06-14T07:09:33Z,2018-06-14T13:58:31Z,znarf,timneutkens;znarf,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,4660,"'Error: Cannot find module '<path>/build-manifest.json'' masks an underlying issue # Bug report

## Describe the bug

The error `Cannot find module 'C:\Dropbox\NextRepro\next-error-reproduction\.next\build-manifest.json'` is printed to console, and browser is not being served any useful errors when masking an underlying issue from Webpack. This only happens for me in dev mode. 

The underlying issue in my specific case is that `ts-loader` does not exist, but I would expect the error from Webpack to be shown and not a not-so-useful error message about a build manifest not found 棣冩啢 

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Go to https://github.com/eweilow/next-error-reproduction
2. Clone the repo
3. Install npm dependencies, run `npm run dev`
4. Open `http://localhost:3000`
5. View console and browser (which show different errors in this case, but not anything about `ts-loader`)

Running `npm run build` shows the real issue from Webpack, which is that `ts-loader` does not exist. I'm aware that the dependency is not in package.json, which is intentional to show the error.

## Expected behavior
I would expect the correct error (`Can't resolve 'ts-loader' in '<path>/next-error-reproduction'`) to be printed to both console and browser. 

## System information
 - OS: Windows
 - Browser (if applies): N/A
 - Version of Next.js: `6.0.2-canary.8

## Additional context

Might be similar in nature to https://github.com/zeit/next.js/issues/4598
",Timer;timneutkens,kind: bug,2018-06-24T21:23:52Z,2019-02-16T16:09:50Z,eweilow,timneutkens;felipero;maximus-lynn;mherodev;wulianglongrd;mattisa;tomspeak;sfrieson-tm;malixsys;fighella;juancampa;vjpr;cmosboss,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,4664,"`buildId` is set to `undefined` in the custom webpack hook during development builds  # Bug report

## Describe the bug

Issue https://github.com/zeit/next.js/pull/3001 exposed the `buildId` to the custom `webpack` handler that is specified in the `next.config.js` configuration file. The `buildId` will, unfortunately, be
set to `undefined` during development, making it impossible to rely on this value. 

A clear and concise description of what the bug is.

## To Reproduce

1. Create a new next.js app
2. Add `next.config.js` with a `webpack` function:

```js
module.exports = {
  webpack: function (config, data) {
     console.log('buildId', data.buildId);
     return config;
  }
}
```

3. Run the server `dev` script: `npm run dev` and you will see `buildId: undefined`
4. Run the server `build` script: `npm run build` and you will see `buildId: <id here>`

## Expected behavior

The `buildId` should not be set as `undefined`, during development the id `-` is used, and should be provided instead of `undefined`.

## System information

 - OS: [e.g. macOS, Windows] OSX
 - Version of Next.js: [e.g. 6.0.2] latest canary.
",timneutkens,kind: bug,2018-06-25T14:59:42Z,2018-06-25T21:06:47Z,3rd-Eden,timneutkens,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,4716,"Outdated references to props.url in README @timneutkens The repo's `README` states: `Note: in order to programmatically change the route without triggering navigation and component-fetching, use props.url.push and props.url.replace within a component`

Since `url` as a prop has been deprecated in Next v6, the file should be updated to indicate the correct way of performing a programatic url update with `router`.

It would be nice to also have an example that shows how to use the `as` parameter as well. In @tim's own words:
>  Basically `push(href, as)`
>   `href` => page inside `pages` directory
>    `as` => what閳ユ獨 displayed in the browser


----

https://github.com/zeit/next.js#routing is also including this bit `Deprecated, use withRouter instead - Each top-level component receives a url property with the following API`, which I believe is confusing.

 It would be much better phrased if mentioned straight away the correct API with `withRouter` (or alternatively even passing down `router` as a prop from the page-level component) and mention that in previous versions `url` was available as a prop, but that's not the case anymore.

-----

There is also a reference to using `url.pushTo`.

----

And `url` is also mentioned as a prop in the [shallow routing](https://github.com/zeit/next.js#shallow-routing) section: `You'll receive the updated pathname and the query via the url prop of the same page that's loaded, without losing state.`
",timneutkens,kind: bug,2018-07-02T20:54:01Z,2018-08-13T21:38:03Z,carlesandres,,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,4737,"`unreachable code after return statement` warning # Bug report

## Describe the bug

there are `unreachable code after return statement` warning in firefox (in production).

i found that it causes by utils `deprecated` function

`deprecated` compiled as
```js
  t.deprecated = function (e, t) {
    return e;   // <----------------- first return (in production)
    var n = !1,
    r = function () {
      n || (n = !0, console.error(t));
      for (var r = arguments.length, o = new Array(r), a = 0; a < r; a++) o[a] = arguments[a];
      return e.apply(this, o)
    };
    return (0, i.default) (r, e), r
  },
```

the source code is
https://github.com/zeit/next.js/blob/canary/lib/utils.js#L17

## To Reproduce

1. Go to  http://zeit.co (firefox)
2. open devtools
3. see console
4. warning here

or

1. yarn create next-app --example hello-world hello-world-app
2. cd hello-world-app
3. yarn build
4. yarn start
5. go to http://localhost:3000 (firefox)

## Expected behavior
:)

## Screenshots
https://www.dropbox.com/s/m700m4c8i4k2jru/Screenshot%202018-07-06%2004.57.10.png?dl=0
https://www.dropbox.com/s/iw43kabb2rthpjl/Screenshot%202018-07-06%2005.05.09.png?dl=0

## System information
 - OS: macOS
 - Browser (if applies) firefox 61.0
 - Version of Next.js: 6.1.1

## Additional context

**it is not very important, so i dont submit a PR, just wanna notes that there are some unnecessary warning**
",timneutkens,kind: bug,2018-07-05T21:08:35Z,2018-07-24T09:24:41Z,comus,MartinKristof;timneutkens,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,475,"Style changes are not hot reloading Trying out the 2.x beta using the same example styled-jsx code in the readme. Changing `background: red` to `background: green` results in all elements losing their styles. Refreshing restores them and displays the changes.

Edit: impronunciable mentioned below that styles are not being flushed. I'm noticing that as well. At first I thought it was related to using global, but it's not. ",nkzawa,kind: bug,2016-12-22T08:19:15Z,2016-12-23T21:10:15Z,iamjacks,impronunciable;katopz;iamjacks;rauchg,nkzawa,,nkzawa,,rauchg,
vercel/next.js,479,"Redirect, Router.push() problem Hi, guys! Can you help me?

I'm using the latest `2.0.0-beta.1` version. And I'm trying to use [this section of README](https://github.com/zeit/next.js#imperatively) to implement a redirect.

My code is:

```javascript
import Router from 'next/router'

export default () => (
    Router.push('/auth/signin')
)
```

And I'm getting error:
```
TypeError: _router2.default.push is not a function
```

Also, I've tried to use `.replace` with the same result.

Can you help me to understand is this a bug or I'm using it wrong?

Thank you!",arunoda,kind: bug,2016-12-22T11:51:13Z,2016-12-22T13:00:12Z,khorolets,manishbalyan;timneutkens,arunoda,,arunoda,,nkzawa,
vercel/next.js,488,"[v2] Back/Forward buttons break parameterized routes that use `async getInitialProps()` I put together a demo repo [here.](https://github.com/jaredpalmer/next-back-button-error)

`async getInitialProps()` is not getting the correct `ctx` during `back()` with parameterized routes.",nkzawa,kind: bug,2016-12-23T00:59:40Z,2016-12-23T17:14:15Z,jaredpalmer,nkzawa;jaredpalmer,arunoda,,nkzawa,,rauchg,
vercel/next.js,496,Hot loading breaks after error This could be the same root cause as #495 but I wanted to submit them separately in case it's helpful.,nkzawa,kind: bug,2016-12-23T08:41:30Z,2016-12-26T18:30:51Z,dnsco,nkzawa;dnsco;rauchg,nkzawa,,nkzawa,,rauchg,
vercel/next.js,521,"components directory not being bundled? cannot find module. I'm using the latest beta release, `2.0.0-beta.2`. I'm also using a custom server module. I've got several re-usable react components inside of a `components` directory, next to the `pages` directory. I'm trying to use these components from a custom `_document.js`.

I'm getting a run-time error as follows ...

```
{ Error: Cannot find module '../components/Navbar'
    at Function.Module._resolveFilename (module.js:470:15)
    at Function.Module._load (module.js:418:25)
    at Module.require (module.js:498:17)
    at require (internal/module.js:20:19)
    at Object.<anonymous> (C:\Users\Ryan\Projects\league\src\.next\dist\pages\_document.js:35:15)
    at Module._compile (module.js:571:32)
    at Object.Module._extensions..js (module.js:580:10)
    at Module.load (module.js:488:32)
    at tryModuleLoad (module.js:447:12)
    at Function.Module._load (module.js:439:3) code: 'MODULE_NOT_FOUND' }
```

After looking in the `dist` folder, I can see that the `components` directory has not been bundled and moved into there. I'm not sure if this is supposed to occur as-needed, as that's why I'm not seeing it, or not. Regardless, it's not there and so the error makes sense.

[Here is my repository](https://github.com/ryancole/league/tree/nextjs/src). Below is my custom `_document.js` file ...

```js
import React from ""react"";
import Document, {Head, Main, NextScript} from ""next/document"";

import Navbar from ""../components/Navbar"";
import Masthead from ""../components/Masthead"";

export default class MyDocument extends Document {
  render () {
    return (
      <html>
        <Head>
          <title>eSports Amateur League</title>
          <link rel=""stylesheet"" href=""/static/css/bootstrap-flex.css"" />
        </Head>
        <body>
          <Masthead />
          <Navbar />
          <Main />
          <NextScript />
        </body>
      </html>
    );
  }
}
```

Any ideas?",nkzawa,kind: bug,2016-12-26T03:31:26Z,2016-12-27T23:28:19Z,ryancole,nkzawa;ryancole,nkzawa,,nkzawa,,rauchg,
vercel/next.js,5347,"Nested dynamic components produce a react warning # Bug report

## Describe the bug

I have a dynamic component loading another dynamic component. Both chunks get correctly loaded by `react-lodable` _before_ `main.js` is loaded (so chunk reporting is working as expected). However, the inner component generates a warning:

```
 Warning: Expected server HTML to contain a matching <p> in <div>.
```

The content doesn't flash (I assume because the component has already been requested, so the ""loading"" state only lasts a few milliseconds), but the warning still indicates that something went wrong.

## To Reproduce

I updated my proof of concept:
https://github.com/arthens/nextjs-canary

Install deps, run it, open http://localhost:3000, you should see a warning in the console.

## Expected behavior

There shouldn't be any warning. The chunk has been pre-loaded, so it should always display the correct value and never go into loading state.

## System information

 - Version of Next.js: 7.0.1

## Additional context

I tried reproducing the problem using `react-loadable` directly, but I couldn't (note: my `react-lodable` setup is significantly different because it's part of a large application, so it is possible that this is a `react-loadable` bug that doesn't get triggered in my app)
",timneutkens,kind: bug,2018-10-01T05:21:23Z,2019-02-17T18:52:00Z,arthens,zvictor;timneutkens;petyosv;manovotny;metagrover;nelsieborja;mario-iliev;arthens;dav-is;KB1RMA;jcampalo;giovannigiordano,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,5437,"Unable to obtain statusCode on a client-side rendered error page in next 7.0.2 # Bug report

## Describe the bug

Upgrading next to 7.0.2 makes it impossible to render a 404 page on the client when a person loads a server-rendered 404 page, then navigates to some other page and finally goes back to a 404 page using browser navigation. This applies to production environment only (in dev, 404 throws anyway).

## To Reproduce

MWE: https://github.com/kachkaev/next.js-5437

1.  ```
    git clone git@github.com:kachkaev/next.js-5437.git
    cd next-issue-xxx
    yarn
    yarn build && yarn start
    ```

2. Go to `http://localhost:3000/asdf` (non-existing page). You will see `Error: 404` (it is server-rendered).

3. Click on _main page_, see URL changed to `http://localhost:3000/`.

4. Press _back_ in your browser to return to `http://localhost:3000/asdf`. You will see `Error: 404` again, now rendered on the client. So far so good 閳 it's `next@7.0.1`. Here's where custom status code is coming from in [`pages/_error.js`](https://github.com/kachkaev/next.js-5437/blob/master/pages/_error.js):

    ```js
      static getInitialProps({ res, err }) {
        const statusCode = res ? res.statusCode : err ? err.statusCode : null;
        return { statusCode };
      }
    ```
    (`res` is used during SSR and `err` is used during the client-side rendering)

5. ```bash
    yarn add next@7.0.2
    yarn build && yarn start
    ```

6. Repeat steps 2-4. In step 4, you will see `Error: unknown` instead of `Error: 404`. This means that the page will look like if the web app crashed badly. The cause of this behaviour is that `err` is now undefined in `getInitialProps`, unlike in 7.0.1.

## System information
 - OS: macOS
 - Browser (if applies) Google Chrome
 - Version of Next.js: 7.0.2
",Timer,kind: bug,2018-10-12T10:14:20Z,2019-02-13T02:32:26Z,kachkaev,kachkaev;timneutkens,timneutkens,Timer,timneutkens,timneutkens,Timer,
vercel/next.js,5464,"static css chunks served with maxage=0 # Bug report

## Describe the bug

static css files appear to be served with sub-optimal cache-control:

/_next/static/css/commons.4e4de3e2.chunk.css
/_next/static/css/styles.4015be53.chunk.css
served with: 
cache-control: public, max-age=0

I am new to Next.js behavior so apologies if this is not really a bug and css chunk shouldn't be served max-age=31536000, immutable for some reason.  I just assume that the chunk hash (commons.**4e4de3e2**.chunk.css) ensure these things could/should be immutable but I am ready to be educated.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Go to any next.js page in chrome right click on any element and inspect element 
2. Right click on any element and inspect element 
3. Look at the network tab and click on a /_next/static/css
4. See cache-control is ""public, max-age=0""

## Expected behavior
I expect them to be served with ""cache-control: public, max-age=31536000, immutable"" like everything else in the /_next/static seems to be served with.


## System information
 - OS: [e.g. macOS, Windows]
 - Browser: chrome
 - Version of Next.js: 7.0.2

## Additional context

You can see this here: https://client.gelltest.com/
I can provide this sample repo if this for some reason isn't immediately and obviously reproducible.
(Identified after looking into css due to this comment: https://spectrum.chat/?t=9f9f43b8-ec8b-45e5-a8e3-5b57a62e9e67)",shuding,kind: bug;type: upstream,2018-10-16T19:55:52Z,2018-11-14T22:23:19Z,Enalmada,timneutkens;Enalmada;lennerd,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,5598,"Can not navigate in development (Router hangs after some time) # Bug report

## Describe the bug

Either `Link` or `Router` stops working when doing client side routing. It seems that HMR may be interrupting the transition between pages. It occurs most frequently if the app is left idle or in the background for a bit of time (although I have experienced it happening whilst clicking around without it being idle)

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Clone this repo (https://github.com/malimccalla/next-routing-issue)
2.  Install dependencies `npm install`
3. Run the server `npm run dev`
4. Visit all pages by clicking the links
5. Go make a coffee (leave page idle for ~2mins)
6. Attempt to visit all pages by clicking the links
7. Certain links do not navigate to their respective page 棣冩 

## Expected behavior
I expect to be able to visit all the individual pages

## Actual behaviour

Page does not navigate to certain routes. Refreshing the page will fix it

## Screenshots

Both the ""about"" and ""contact"" links do not work (notice the HMR log on the first attempt of each route). After a page refresh they work as expected. If I leave the app idle for roughly 2mins again it will start over with the issue

![next-issue](https://user-images.githubusercontent.com/18899991/48032169-7b789980-e14e-11e8-9ec1-959cb9e54b7c.gif)


## System information
 -  mac Mojave 10.14
 - Chrome
 - next.js  v7.0.2

## Additional context

 With the console open you can see that the Router event `routeChangeStart` fires but `routeChangeComplete` never does.
",timneutkens,kind: bug,2018-11-05T18:17:40Z,2019-01-08T22:10:33Z,malimccalla,dankythuat;edelfrade;hiovi;serendipity1004;tomsseisums;alexsenichev;dmayo2;roytsang;timneutkens;Atmospheres;malimccalla;scrumptiousdev;Vgurnani;JonCognioDigital;AmazingTurtle;jsbimra;matejkonrad,,,,,timneutkens,
vercel/next.js,561,"Error: Can't set headers after they are sent. Following code  

```
import React from 'react'

export default class MyPage extends React.Component {
  static async getInitialProps({ req, res }) {
    if (!req.user) {
      res.redirect('/login')
      res.end()
    }
  }

  render() {
    return (
      <div>
      </div>
    )
  }
}
```

will throw a error

` Error: Can't set headers after they are sent.
    at ServerResponse.setHeader (_http_outgoing.js:359:11)
    at sendHTML
`

",nkzawa,kind: bug,2016-12-29T12:29:20Z,2016-12-30T19:55:21Z,spacedragon,spacedragon;nkzawa,arunoda,,nkzawa,,rauchg,
vercel/next.js,5620,"After the initial render, any direct url visits to pages result in 404s # Bug report

## Describe the bug

in `require.js#getPagePath`, the `pages-manifest.json` file is read using:

```
const pagesManifest = require(join(serverBuildPath, PAGES_MANIFEST))
```

But every time a new on-demand entry is added to the build, the `pages-manifest.json` file changes.

Using require though returns a cached version.

This causes `requirePage` to say `module could not be found`, which causes a 404.

## Fix

Strangely, deleting the require.cache entry didn't resolve it.

```
delete require.cache[join(serverBuildPath, PAGES_MANIFEST)]
```

But using the following resolved my issue:

```
  const pagesManifest = JSON.parse(require('fs').readFileSync(join(serverBuildPath, PAGES_MANIFEST), 'utf8'))
```

## System information
 - OS: [e.g. macOS, Windows] macOS
 - Browser (if applies) [e.g. chrome, safari] Chrome
 - Version of Next.js: [e.g. 6.0.2] v7.0.2-canary.20 / https://github.com/zeit/next.js/commit/b46d7e8f6fc31445801eab08d42e1c361bdaaf28",dav-is,kind: bug,2018-11-07T15:22:12Z,2019-03-14T23:22:57Z,vjpr,timneutkens;vjpr,timneutkens,timneutkens,timneutkens,,timneutkens,
vercel/next.js,570,"getInitialProps called both on the client and on the server on first load since we moved to next@2.x.x (we needed custom routing) we see that on first load `geInitialProps`  is called once on the server and then again on the client.

I tried putting a breakpoint to see who calls it but the stacktrace is full of babel/asyncToGenerator and goes nowhere. ",nkzawa,kind: bug,2016-12-30T08:54:05Z,2016-12-30T19:55:01Z,davibe,davibe,nkzawa,,nkzawa,,rauchg,
vercel/next.js,581,"Errors when trying the minimal setup The minimal setup at the beginning of
https://zeit.co/blog/next

seems to generate cryptic errors:

```bash
ERROR  Failed to compile with 4 errors

These dependencies were not found in node_modules:

* ./pages/index.js?entry
* /Users/dmitrizaitsev/Dropbox/Sandbox/nextjs-test/node_modules/next/dist/pages/_error.js?entry
* /Users/dmitrizaitsev/Dropbox/Sandbox/nextjs-test/node_modules/next/dist/pages/_error-debug.js?entry
* /Users/dmitrizaitsev/Dropbox/Sandbox/nextjs-test/node_modules/next/dist/pages/_document.js?entry

Did you forget to run npm install --save for them?
> Ready on http://localhost:3000

```

`npm install` does not help :(",arunoda;nkzawa,kind: bug,2016-12-31T06:25:34Z,2016-12-31T13:17:53Z,dmitriz,nkzawa;dmitriz;arunoda;cncolder;sarovin,nkzawa;arunoda,arunoda,nkzawa;arunoda,,nkzawa,
vercel/next.js,5911,"HMR does not work when exporting undefined # Bug report

## Describe the bug

As described by @timneutkens -> https://github.com/zeit/next.js/pull/5857#issuecomment-447870847

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

- Change [this line](https://github.com/kylemh/next.js/blob/canary/test/integration/basic/test/error-recovery.js#L253) to

```javascript
aboutPage.replace('export default', 'export default undefined;\nexport const fn =')
```

and run `yarn testonly --testPathPattern=""basic"" -t ""should recover after a bad return from the render function""`

## Expected behavior
Edit to test should pass
",ijjk,kind: bug,2018-12-17T18:49:38Z,2019-03-12T20:21:10Z,kylemh,canotech,timneutkens,timneutkens,timneutkens,,ijjk,
vercel/next.js,597,"read-page.js  JSON$parse.component Error Beta 11 Win 10
Node v6.9.2
NPM 3.10.9

Using Examle ssr-caching folder not changing any thing

Npm Run Dev Command After Error read-page.js 48 line

Error 
https://gist.github.com/SerkanDayicik/e867a72a171b6e1a6d1f87e5f0a654a9

next 2.0.0-beta.11
",nkzawa,kind: bug,2017-01-01T08:03:14Z,2017-01-02T16:06:13Z,0xv0idx,nkzawa;arunoda;harmonous;0xv0idx;msand;jschumme;ryancole,nkzawa,,nkzawa,,nkzawa,
vercel/next.js,598,"404 on Link Hi,
Since beta 7 (beta 6 build didn't work at all for me) I have a message in chrome devtools saying:
```
Error: Failed to load JSON for /_next/pages/connexion
    at XMLHttpRequest.xhr.onload (router.js?23b135f:602)
```
while going navigating to `/connexion` works as expected. Any clue on which change could have break the old implementation and how is my code supposed to be changed ?
The result is the same using `'next/link'` or `'next/prefetch'`.

Thank you and happy new year to all of you.",arunoda,kind: bug,2017-01-01T08:22:23Z,2017-01-01T10:07:57Z,havenS,arunoda;havenS;nkzawa,arunoda,,arunoda,,nkzawa,
vercel/next.js,6025,"<Head><title> not set by the time history change event fires # Bug report

## Describe the bug

I'm using Google Tag Manager with a custom trigger for history change (inspired by [SO](https://stackoverflow.com/a/37555679)).

The problem is that the content of the <title> tag as reported in GTM at the time the history change event fires is inconsistent: it may be set to the correct value, to the previous page's title, or it may even be ""not set"" entirely.

I set the title with the typical JSX:

`import Head from ""next/head"";`
`/* ... */`
`<Head><title>stuff</title></Head>`

Issue #4044 that was reported for Next.js v5.0.0. may be related.

## Expected behavior
`<title>` should have the right value by the time the history change event fires.

## System information
 - Version of Next.js: 7.0.2
- React version: 16.7.0-alpha.2 (using Hooks. Could this be the issue?)

Is there a way to solve this?

Alternatively, is there a way to force server rendering every time, so as to bypass all client-side routing / dynamic rendering entirely?",ijjk,kind: bug;type: needs investigation,2019-01-10T19:01:04Z,2020-06-12T16:26:11Z,dandrei,dandrei;peduarte;jackocnr;nx-giap;balazsorban44;HaNdTriX;WillSelway;timneutkens;StarpTech,timneutkens,,timneutkens,,,
vercel/next.js,6095,Last two canary releases haven閳ユ獩 been published to npm The latest canary release of `next` available on npm is `8.0.0-canary.7`. Not sure why?,dav-is,kind: bug,2019-01-20T22:42:08Z,2019-01-21T15:26:41Z,4cm4k1,timneutkens;dav-is,timneutkens,,timneutkens,,dav-is,
vercel/next.js,6246,"v8 server build error # Bug report

With next.js 8, I get this unhelpful message and a 404 error on a page of my app:

```
閴 Server
  Compiled with some errors in 5.02s
```

When running a production build the error is more detailed and it seems that for the **server build**, next.js can't resolve a dependency's entrypoint if the `main` property is missing from package.json but the `module` property is specified.

The culprit seems to be this line:

https://github.com/zeit/next.js/blob/80cb91ec87f6d193899c19faaa89f3cddd87da85/packages/next/build/webpack-config.js#L192

## To Reproduce

One example of a package which defines `module` but not `main`: https://github.com/wereHamster/valde/blob/master/packages/iconography/package.json

## Expected behavior

In next.js 7 this worked, and I presume that using `module` as a main field in addition to `main` would also work in next.js 8, since the server part is also compiled with webpack.

## System information
 - OS: macOS 10.14.3
 - Version of Next.js: 8.0.0
",Timer,kind: bug,2019-02-11T14:08:35Z,2019-02-12T00:39:58Z,jerstucki,timneutkens;jerstucki,timneutkens;Timer,Timer,timneutkens,,timneutkens,
vercel/next.js,6249,"Static export `publicRuntimeConfig` issues # Bug report

## Describe the bug
Hi, after upgrading from v7.0.2. to v8.0.0., I've been having issues running static export. After running `next export`, I get an error:
```
$ next export
> using build directory: /Users/fikip/Desktop/Projects/<project_name>/.next
  copying ""static"" directory
  copying ""static build"" directory
  launching 7 threads with concurrency of 10 per thread
TypeError: Cannot read property 'publicRuntimeConfig' of undefined
```

To be more specific, my publicRuntimeConfig in next.config.js is set up like this:
```
  publicRuntimeConfig: {
    API_URL: process.env.API_URL,
    SENTRY_URL: process.env.SENTRY_URL,
    SENTRY_SERVER_URL: process.env.SENTRY_SERVER_URL,
    VERSION: require(""./package.json"").version,
  }
```
Tracking down the error, it seems to occur here:
```
import getConfig from ""next/config""
const { API_URL } = getConfig().publicRuntimeConfig
```

There have been no changes except updating next.js from v7.0.2 to v8.0.0.

I've noticed in the v8 release blog summary that 

""`publicRuntimeConfig` and `serverRuntimeConfig` are not supported in the `serverless` mode. Use build-time configuration instead."", so that got me thinking that maybe setting `target` explicitly to `server` might help, but, alas, it did not.

## To Reproduce

1. Add a `publicRuntimeConfig`
2. `getConfig()` somewhere in the app & access the `publicRuntimeConfig` object that should be returned
3. Try to perform a static export
4. See error

## Expected behavior
Static export should finish without any errors.
## Screenshots

![image](https://user-images.githubusercontent.com/19172849/52573548-b27bdc80-2e1a-11e9-8150-6b1f65566f56.jpg)

## System information
 - OS: macOS 10.14.3 
 - Version of Next.js: 8.0.0
",dav-is,kind: bug,2019-02-11T15:51:12Z,2019-02-12T01:28:48Z,bozskejkaja,bozskejkaja;timneutkens;tnunes;kumarabhirup;nik-john;Sreilys;zhangciwu;eric-burel;balazsorban44;TheMaxoor;garnerp;dav-is;NathanielHill,timneutkens,,timneutkens,,dav-is,
vercel/next.js,6251,"Static export failed when upgraded to v8.0.0 # 8.0.0(npm) Bug report

## Describe the bug

next app stopped to work on client side after upgrading next to v8.0.0
Coming back to v7.0.3 makes things work.

Here is a [broken version with 8.0.0](https://deepdashio-g8bnfrflm.now.sh/)
Here is a [working version with 7.0.3](https://deepdashio-r1kgpj3fg.now.sh/)

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. this is [fixed commit](https://github.com/YuriGor/deepdash.io/commit/8f0e1233229aaf16b39e332b84101106427e903e)
it works well by `npm run dev`
2. do `npm i next@8.0.0` and run an app
3. menu button and smooth scrolling after side bar clicks do not work.
4.  In browser console you will see `Uncaught TypeError: Cannot read property 'textContent' of null`

## Expected behavior
No errors in console, all the buttons work, scrolling is smooth

## Screenshots
Full error:
```
Uncaught TypeError: Cannot read property 'textContent' of null
    at Object../node_modules/next/dist/client/index.js (index.js:66)
    at __webpack_require__ (bootstrap:788)
    at fn (bootstrap:149)
    at Object../node_modules/next/dist/client/next-dev.js (next-dev.js:23)
    at __webpack_require__ (bootstrap:788)
    at fn (bootstrap:149)
    at Object.0 (module.js:22)
    at __webpack_require__ (bootstrap:788)
    at checkDeferredModules (bootstrap:45)
    at Array.webpackJsonpCallback [as push] (bootstrap:32)
```

## System information
 - OS: Kubuntu 18.04
 - Browser: chromium
 - Version of Next.js: 8.0.0 from npm

## Additional context

CLI command 
`now init` creates nextjs-static example with optimistic package.json:
```json
{
  ""scripts"": {
    ""now-build"": ""next build && next export -o dist""
  },
  ""dependencies"": {
    ""next"": ""latest"",
    ""react"": ""latest"",
    ""react-dom"": ""latest""
  }
}
```
so it was surprise for me to become a tester of pre-release
",timneutkens;dav-is,kind: bug,2019-02-11T16:17:47Z,2019-02-11T23:50:53Z,YuriGor,dav-is;YuriGor;timneutkens,timneutkens,,timneutkens;Timer,Timer,dav-is,
vercel/next.js,6263,"Building a specific directory is broken in 8.0.0 # Bug report

## Describe the bug

`next build` is supposed to support an optional `<dir>` argument that specifies which directory will be built. In 8.0.0, that argument is ignored, and attempting to run a build with that argument specified will fail incorrectly.

## To Reproduce

Create a minimal Next.js project:
* `mkdir example && cd example`
* `npm init`, accept all defaults
* `npm install --save next react react-dom`
* `mkdir -p build/pages`
* `touch build/pages/index.js`
* Edit `build/pages/index.js` to include a minimum working page:
```jsx
function Home() {
  return <div>Welcome to next.js!</div>
}

export default Home
```

After creating this example, run `npx next build build` in the root of the `example` directory that was created. Observe the following output:

```
Couldn't find a `pages` directory. Please create one under the project root
```


## Expected behavior
In Next.js 7.0.3, running `npx next build build` with the above directory structure would build the site in `./build/.next/`. You can test this by running `npm i next@7.0.3` in the above example and then running `npx next build build`

## System information
 - OS: macOS
 - Browser: N/A
 - Version of Next.js: 8.0.0

## Additional context

I tried to do a little bit of debugging here. Adding `console.log(args)` right before https://github.com/zeit/next.js/blob/canary/packages/next/bin/next-build.ts#L29 shows that `args._` is an empty array, even with the `build` argument specified. It looks like this issue could somehow be caused by the switch to using the `arg` package, as v7.x used `minimist` instead.
",timneutkens,kind: bug,2019-02-12T08:39:07Z,2019-02-17T19:13:11Z,nwalters512,timneutkens;nwalters512,timneutkens,,Timer,,timneutkens,
vercel/next.js,6268,"Cannot kill build process with Ctrl+C # Bug report

In Next v7 I was able to kill build process with Ctrl+C. Now Ctrl+C exits to terminal but build process continues in background and outputs stuff to stdout",ijjk,kind: bug;type: needs investigation,2019-02-12T11:20:42Z,2019-03-07T17:29:44Z,sheerun,ijjk,Timer,,timneutkens,,ijjk,
vercel/next.js,6285,"Index routes won't be executed in client when index.js is located in /index/index.js # Bug report

When you build next.js when the index page is located in `/index/index.js` instead of `/index.js` The client side script will not be executed when you access `http://localhost/`.

The built index page will register with `/index` (as shown below)

```js
(window.__NEXT_P = window.__NEXT_P || []).push([""/index"", function () {
  var e = n(""gDgk"");
  return {
    page: e.default || e
  }
}])
```

Moving the index.js to the pages root will restore the wanted behaviour.
It took a while for me to figure out what the actual issue is as it's working just fine in dev mode. 

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Check out https://github.com/adlk/nextjs-index-issue
2. Run `npm install && npm run build && npm start`
3. Check in DevTools if you have a log with `Home: component did mount`

## System information
 - Version of Next.js: 8.0.0
",ijjk,kind: bug;type: needs investigation,2019-02-13T11:13:56Z,2019-03-03T18:36:33Z,adlk,nathfreder;newsroomdev;notthatnathan;balazsorban44;jakeFeldman;eliotyork;timneutkens,Timer,,timneutkens,,timneutkens,
vercel/next.js,6462,"Scroll reset happens at end of `Link` routing rather than beginning # Bug report

## Describe the bug

The next.js `Router` resets the scroll position to 0,0 at the end of navigation if it is navigating to a href without a fragment via the included `Link` tag. However, because of the late timing of the reset, the incoming page renders and begins its lifecycle with the viewport position at the point it was at on the previous page before being reset to the new value. This can cause confusing errors when components on the new page use scroll position to trigger behaviors and events.

## To Reproduce

Steps to reproduce the behavior:
1. In any next site using the default Router with two pages... we'll call one `A` and one `B`.
2. Add an override in `B` of `componentDidMount` that calls `console.log(window.scrollY)`
3. Go to `A` and scroll so that you are no longer at scroll position (0,0).
4. Click a `Link` element to navigate to `B`. Notice that your log will log a value other than 0, though the page will then reset to the top.

## Expected behavior
I would expect this to mirror the behavior found with ""true http routing"". If you perform the navigation using normal `<a>` tags instead of `<Link>` elements, the viewport is reset to (0, 0) before the React elements receive their call to `componentDidMount`.

## System information
 - OS: Mac OS
 - Browser (if applies) Firefox (I'm assuming this applies to all browsers, though)
 - Version of Next.js: 8.0.1

## Additional context

I was able to fix this problem for my code using the following snippet (in typescript):
```typescript
let hasAttachedRouteListener: boolean = false;

export function attachListener() {
  // Only actually attach once
  if (hasAttachedRouteListener) {
    return;
  }
  hasAttachedRouteListener = true;

  // This event fires before the incoming route is loaded or rendered,
  // so by resetting the viewport without animation at this point we avoid
  // the incoming route getting the incorrect viewport at any point.
  const handleRouteChange = () => {
    window.scrollTo({
      top: 0,
      left: 0,
      behavior: ""auto""
    });
  };

  Router.events.on(""routeChangeStart"", handleRouteChange);
}
```

",Timer,kind: bug;type: needs investigation,2019-02-27T05:03:02Z,2020-12-30T04:33:09Z,zackdotcomputer,nblthree;zackdotcomputer;yanyixin;Timer;rjvim;Shawn-Noruzi;alextseitlin;balazsorban44,timneutkens;Timer,,Timer,,,
vercel/next.js,6467,"Export crashes when page folder names contain ""."" character # Bug report

## Describe the bug

When exporting pages that contain a ""."" character in them, the export operation crashes with the following error:

```
{ Error: EISDIR: illegal operation on a directory, open '/Users/aington/git/next-export-example/out/product/v1.12'
  errno: -21,
  code: 'EISDIR',
  syscall: 'open',
  path: '/Users/aington/git/next-export-example/out/product/v1.12' }
{ errno: -21,
  code: 'EISDIR',
  syscall: 'open',
  path: '/Users/aington/git/next-export-example/out/product/v1.12' }
error Command failed with exit code 1.
```

Replacing the ""."" character with something else in the folder name exports successfully.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Create a page: `/pages/v1.12/index.js` containing a valid React component.
2. Create a second page: `/pages/v1.12/video.js` containing a valid React component.
2. Run `next export`.
3. Observe the error.

## Expected behavior
The folders should be exported with the correct name, containing the ""."" character.

## System information
 - OS: MacOS Mojave 10.14.2
 - Version of Next.js: v8.0.3
 - Version of Node.js: v8.12.0
",ijjk,kind: bug,2019-02-27T11:41:49Z,2019-03-12T23:30:04Z,azcn2503,azcn2503;timneutkens,timneutkens,,timneutkens,,ijjk,
vercel/next.js,6480,"EnhancedComponent inside _document.js's renderPage() function not used to render if getInitialProps of _app.js returns Component key # Bug report

## Describe the bug

I found that EnhancedComponent in renderPage() function will not be used if initialProp of App has ""Component"" key in it, as `{...props}` will override `Component={EnhancedComponent}` row.

It was very hard to trace this as I'm not that familiar with next's resolution order. I was done found this bug after I traced all the way up and down to find out how next behaves, My getInitialProps of _app.js was returning Component key as I used relay-modern with next.js and example of relay-modern that I referenced has code that returns Component within its getInitialProps method in _app.js.

I'm not sure this is bug or not, as there's might be a chance that Component in returned value of _app.js should have some prior order than EnhancedComponent of renderPage() method. But I think it might be great if there's some instruction or warnings showing up when this behavior (Which there's two Component to reference inside renderPage() method) occurs, as it is fairly easy to detect with one or two lines of code, to save someone(like me)'s time.

Or maybe, it can be implemented in the way that EnhancedComponent references Component from App's InitialProps rather than Component itself If there's ""Component"" key inside InitialProps. Wonder if there's any problem within this implementation.

If there's error within my description please let me know. It's my first time to use next, so there might be some wrong information. Thanks!
",ijjk,kind: bug,2019-02-28T09:44:42Z,2019-03-01T17:08:27Z,ScripterSugar,timneutkens,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,6497,"HMR Not working for Clean URLs (when redirecting to /pages/index.js) # Bug report

HMR is not working for custom URL. If you redirect to index it will fail, if you redirect to another file, it will work.

## To Reproduce

1. run `npm run dev`
2. update something in /pages/index.js file
3. next compiles but browser doesn't update

## Expected behavior

Browser updates

## System information
 - OS: [e.g. macOS]
 - Browser: chrome 
 - Version of Next.js: 8.0.3

## Additional context

server.js file:

```
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare()
  .then(() => {
    const server = express();

    server.get('/test', (req, res) => {
      app.render(req, res, '/index', {});
    });

    server.get('*', handle);

    server.listen(3000, (err) => {
      if (err) throw err;
      console.log('> Ready on http://localhost:3000')
    })
  })
  .catch((ex) => {
    console.error(ex.stack);
    process.exit(1)
  });
```

/pages/index.js:

```
import React, { Component } from 'react';

class Index extends Component {
 render() {
   return (
     <div>
       <p>Hello Next.js</p>
     </div>
   )
 }
}

export default Index;

```
",ijjk,kind: bug,2019-03-01T09:56:40Z,2019-03-12T11:40:50Z,dfvalero,dmitweb;dfvalero;ijjk,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,6595,"Missing deps in package.json # Bug report

## Describe the bug

```
Module not found: Error: Can't resolve 'react-is' in '/xxx/node_modules/.registry.npmjs.org/next-server/8.0.4-canary.9/node_modules/next-server/dist/lib/router'
```

Also `@babel/runtime-corejs2` in `next-server`.

## To Reproduce

Occurs when using pnpm which expects explicit deps (no hoisting).

## Expected behavior

## Screenshots

## System information
 - OS: [e.g. macOS, Windows]
 - Browser (if applies) [e.g. chrome, safari]
 - Version of Next.js: [e.g. 6.0.2] 8.0.4-canary.9

## Additional context

## Workaround

Install deps in app root.",Timer,kind: bug,2019-03-10T13:44:00Z,2019-08-10T12:47:10Z,vjpr,nathfreder;vjpr;Yzrsah;timneutkens;balazsorban44,Timer,,Timer,,timneutkens,
vercel/next.js,6710,"AMP - Only show canonical links to different page versions when present Once https://github.com/zeit/next.js/pull/6706 is merged, we need to update these sections of code to only include these elements when the other version exists:

https://github.com/zeit/next.js/blob/ff5c8465deef35eb087237bbf912dab739337bcd/packages/next/pages/_document.js#L204

https://github.com/zeit/next.js/blob/ff5c8465deef35eb087237bbf912dab739337bcd/packages/next/pages/_document.js#L243",ijjk,kind: bug,2019-03-19T01:04:29Z,2019-03-19T19:01:43Z,Timer,,Timer,,Timer,,ijjk,
vercel/next.js,6736,"Compiler not recovering Deleting normal version of page while on AMP version in browser does not recover:
```
Failed to compile.

./pages/docs/index.js
Error: ENOENT: no such file or directory, open '/Users/joe/Documents/Development/Work/zeit/next-site/www/pages/docs/index.js'
```

Reproduce by making `pages/index.js` and `pages/index.amp.js`, visit `/` then `/?amp=1` (close `/`) -- then delete `pages/index.js`.

---

## Might be fixed by https://github.com/zeit/next.js/issues/6737",ijjk,kind: bug,2019-03-20T13:48:22Z,2019-03-20T14:14:02Z,Timer,,Timer,,Timer,,Timer,
vercel/next.js,6737,"AMP only page not working ![image](https://user-images.githubusercontent.com/616428/54689168-63018e00-4af5-11e9-927c-16b0ed7550f0.png)

Why is it trying to resolve `./index`?",ijjk,kind: bug,2019-03-20T13:49:26Z,2019-03-20T14:14:12Z,Timer,,Timer,,Timer,,Timer,
vercel/next.js,6882,"8.0.4 weird issue with firefox & query parameters in the url # Bug report

there seems to be a regression in 8.0.4 specifically for newer versions of Firefox relating to next/router code

## Describe the bug

when landing on a page that contains query parameters, the browser becomes ""locked"" to that page and programmatically or manually navigating to a different same-domain page insta-redirects back to the original. note that this does not start happening until a query parameter is involved in the url, totally bizarre

## System information
 - OS: macOS
 - Browser (if applies) firefox 66
 - Version of Next.js: 8.0.4

## Additional context

Downgrading to 8.0.3 fixes this issue, so it's definitely something in nextjs. The two ways my (private) project moves between pages is typical anchor links and using `window.location.assign`.
",ijjk,kind: bug,2019-04-03T19:34:20Z,2019-04-04T20:37:03Z,probablyup,ijjk;probablyup;kachkaev;helsner;timneutkens;tiago-pinheiro,Timer,,Timer,,ijjk,
vercel/next.js,6913,"Promise Finally() in event-source-polyfill.js needs it's own polyfill/shim # Bug report

## Describe the bug
`Fetch` is polyfilled with `unfetch`, but `Promise` needs a polyfill for the 'finally` method being used (or implemented without). The error thrown during dev causes Microsoft Edge to kill the JS stack.

## To Reproduce
1) Run `Next` in `dev` mode.
2) Open any registered/compiled page in Microsoft Edge on dev server
3) You should see `Object doesn't support property or method 'finally'` - stemming from `event-source-polyfill.js`
4) Note that client JS has not executed.
5) Remove call to 'finally' in `event-source-polyfill.js`
6) Restart server
7) Page should run properly.

## Expected behavior
Dev server should not error out app.

## Screenshots
<img width=""929"" alt=""error"" src=""https://user-images.githubusercontent.com/6556310/55660777-e3deac00-57bc-11e9-957f-31de6d8f3bd9.png"">

## System information
 - OS: `Windows 10`
 - Browser: `Microsoft Edge 41`
 - Version of Next.js: `8.0.4`

## Additional context

Add any other context about the problem here.
",Timer,kind: bug,2019-04-05T23:07:42Z,2019-04-09T16:25:22Z,kevinhaugen,dijalmasilva,Timer,,Timer,,Timer,
vercel/next.js,6934,"`now dev` / now/next compiling files that are not pages ```
$ next build
Creating a development build ...

Failed to compile.

./node_modules/next/dist/build/webpack/loaders/next-client-pages-loader.js?page=%2F..%2Fstatic%2Ffavicon.ico&absolutePagePath=static%2Ffavicon.ico
Module not found: Can't resolve 'static/favicon.ico' in '/private/var/folders/ly/4jx0_c9x1271wrwsrvj_cngh0000gn/T/co.zeit.now/dev/workPaths/6tv3965g'

> Build error occurred
Error: > Build failed because of webpack errors
    at Object.build [as default] (/private/var/folders/ly/4jx0_c9x1271wrwsrvj_cngh0000gn/T/co.zeit.now/dev/workPaths/6tv3965g/node_modules/next/dist/build/index.js:190:15)
    at processTicksAndRejections (internal/process/next_tick.js:81:5)
```",dav-is,kind: bug,2019-04-08T06:52:22Z,2019-04-09T02:59:50Z,timneutkens,timneutkens;dav-is,timneutkens,,timneutkens,,dav-is,
vercel/next.js,6935,"`now dev` ENOENT `ENOENT: no such file or directory, chmod '/var/folders/ly/4jx0_c9x1271wrwsrvj_cngh0000gn/T/co.zeit.now/dev/workPaths/s66cb69o/node_modules/@babel/core/lib/config/files/types.js'`

When forcing a reload",dav-is,kind: bug,2019-04-08T06:55:56Z,2019-04-24T16:59:34Z,timneutkens,dav-is;timneutkens,timneutkens,,timneutkens,,dav-is,
vercel/next.js,6936,"`now dev` hanging after 2-3 force refreshes ```
installing dependencies...
installing to /var/folders/ly/4jx0_c9x1271wrwsrvj_cngh0000gn/T/co.zeit.now/dev/workPaths/4gl123vo
yarn install v1.15.2
warning package.json: No license field
warning create-next-example-app: No license field
[1/4] 棣冩敵  Resolving packages...
success Already up-to-date.
閴  Done in 0.38s.
running user script...
running ""yarn run now-build""
yarn run v1.15.2
warning package.json: No license field
$ next build
Creating a development build ...

Compiled with warnings.

./node_modules/next-server/dist/server/require.js
Critical dependency: the request of a dependency is an expression

./node_modules/next-server/dist/server/require.js
Critical dependency: the request of a dependency is an expression

 閳 /
 閳 /_app
 閳 /_document
 閳 /_error

閴  Done in 3.92s.
preparing lambda files...
Creating lambda for page: ""index.js""...
Created lambda for page: ""index.js""
preparing cache ...
producing cache file manifest ...
```

Another refresh ends in `502: An error occurred with your deployment
Code: NO_STATUS_CODE_FROM_LAMBDA`",dav-is,kind: bug,2019-04-08T06:57:03Z,2019-04-24T16:59:42Z,timneutkens,timneutkens;brianle1301,timneutkens,,timneutkens,,dav-is,
vercel/next.js,6937,`now dev` running `yarn` / `npm install` whenever refreshing Every force refresh `yarn` is used while we already know it's not needed because the initial build installed dependencies. We should monitor `yarn.lock`/`package-lock.json`/`package.json` for changes.,dav-is,kind: bug,2019-04-08T07:02:10Z,2019-04-09T03:00:04Z,timneutkens,TooTallNate;dav-is,timneutkens,,timneutkens,,dav-is,
vercel/next.js,6973,"Endless loop when _error render throws on client side # Bug report

## Describe the bug

When using a custom `_error` page, Next can enter an infinite loop if `_error` render throws on client side (with a production build).

## To Reproduce

Repro here : https://github.com/dorian-marchal/next-repro/tree/repro-6973

In a terminal:

```shell
$ git clone -b repro-6973 https://github.com/dorian-marchal/next-repro
Cloning into 'next-repro'...

$ cd next-repro/

$ node -v
v10.14.1

$ npm install

$ npm ls next
next-repro@1.0.0 /tmp/next-repro
閳规柡鏀㈤埞 next@8.0.4

$ npm run build && npm run start
...
> Ready on http://localhost:3000

```

In your browser:

- Go to http://localhost:3000/
- Open your browser devtools
- Click on ""Client side nav""
- See the app entering an endless loop (stopped after 20 iterations).


## Expected behavior
On client side, if `_error` throws, I expect an ""Internal Error"" page (this is what happens when _error throw during server side rendering).

I suppose that Next could force a page reload in this case.

## System information
 - OS: Ubuntu 18.04
 - Version of Next.js: 8.0.4

## Additional context

In our project, this error happens when _error `getInitialProps` fails to retrieve some dependencies (`Error.render` tries to access an undefined property).
",huozhi,kind: bug;good first issue;type: needs investigation,2019-04-09T15:17:44Z,2021-07-01T11:54:54Z,dorian-marchal,dorian-marchal;armenr;dayvista;lucashfreitas;CharlestonREM;tarasov-gk;Abhishek-Sati;huozhi;kvet;WinnersProx;MarcusBondezan;balazsorban44;tried-n-true;timneutkens;nicobarray;Timer;Oikio;grefrit;MyCupOfTeaOo,Timer,,,,timneutkens,
vercel/next.js,699,"next.js fails when installed as a dependency with npm link If I install next.js as a dependency of a module, then `npm link` that module and try to use it in another project, I get the following error:

```
 ERROR  Failed to compile with 6 errors

These dependencies were not found in node_modules:

* ./pages/a.js?entry
* ./pages/b.js?entry
* ./pages/index.js?entry
* C:\Users\user\code\next-as-deps\with-next\node_modules\next\dist\pages\_error.js?entry
* C:\Users\user\code\next-as-deps\with-next\node_modules\next\dist\pages\_error-debug.js?entry
* C:\Users\user\code\next-as-deps\with-next\node_modules\next\dist\pages\_document.js?entry

Did you forget to run npm install --save for them?
> Ready on http://localhost:3000
```

I made a full reproduction in this repo: https://github.com/reel/next-as-deps",arunoda,kind: bug,2017-01-08T15:55:42Z,2017-01-16T05:40:15Z,reel,arunoda;reel,arunoda,,arunoda,,nkzawa,
vercel/next.js,7028,"AMP canonical link support with dynamic routes Right now, AMP canonical links use the page name instead of `asPath`. This causes unexpected behavior with dynamic routing.",ijjk,kind: bug,2019-04-15T06:22:53Z,2019-04-15T11:57:42Z,Timer,ijjk,Timer,,Timer,,ijjk,
vercel/next.js,7073,"Nextjs 8.1.0 does not work with react 16.7.0 or below It looks like the Next.js release 8.1.0 does not work with React version 16.7 or below. The package `react-ssr-prepass` tries to access properties on the `ReactCurrentDispatcher` which is, for as far as I know, introduced in react 16.8.

`react-ssr-prepass` is added as a dependency of `next-server` in version 8.1.0.

### The error:
```
/foo/bar/node_modules/react-ssr-prepass/dist/react-ssr-prepass.development.js:843
var prevDispatcher = ReactCurrentDispatcher.current;
                                            ^
TypeError: Cannot read property 'current' of undefined
    at Object.<anonymous> (/foo/bar/node_modules/react-ssr-prepass/dist/react-ssr-prepass.development.js:843:45)
```

## To Reproduce

1. create a new directory for your next app
2. run `yarn add next@8.1.0 react@16.7.0 react-dom@16.7.0`
3. run `yarn next`

or:
1. Fork https://codesandbox.io/s/yp14oyxjqj
2. Have a look at the terminal (or try restarting the sandbox via the Server Control Panel)

## Expected behavior
No errors  棣冨竴 

## System information
 - OS: macOS
 - Browser: n/a
 - Version of Next.js: 8.1.0
- Version of Node.js: 10.15.3
",ijjk,kind: bug,2019-04-18T09:20:25Z,2019-04-21T18:47:03Z,klaasman,,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,715,"Unexpected token when using ""node server.js"" with transpiled express server I am using babel to transpile everything into a build folder, if i try running server.js with
`cd build`
`node server.js`
I get this error
`SyntaxError: C:/web-liga/node_modules/next/dist/pages/_error-debug.js?entry: Unexpected token (14:11)`
```javascript
  12 |     const { name, message, stack, path } = this.props
  13 |
> 14 |     return <div className='errorDebug'>
     |            ^
  15 |       <Head>
  16 |         <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  17 |       </Head>
```
But if i run the server using ""npm run dev""
```javascript
""scripts"": {
    ""build"": ""node_modules/.bin/babel ./ --out-dir build -s --ignore node_modules"",
    ""clean"": ""rm -rf build && mkdir build"",
    ""dev"": ""npm run clean && npm run build && npm run watch"",
    ""start"": ""NODE_ENV=production node build/server.js"",
    ""watch"": ""node_modules/.bin/babel-watch --exclude components --exclude pages --exclude .next build/server.js""
  }
```
Everything runs perfectly except that .next is getting compiled outside of the build folder because thats where im running npm from

All of this brings problems when trying to deploy to heroku or now",arunoda,kind: bug,2017-01-10T03:56:11Z,2017-01-12T01:57:34Z,angel200sdnot,aranajhonny;angel200sdnot;arunoda;mattecapu,arunoda,,arunoda,,angel200sdnot,
vercel/next.js,7178,"SyntaxError: Strict mode does not allow function declarations in a lexically nested statement in IOS 9.x. # Bug report

## Describe the bug

SyntaxError: Strict mode does not allow function declarations in a lexically nested statement in IOS 9.x.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. install next.js 8.1.0
2. build and start server
3. open page in ios8 or ios9 safari
4. See error

## Expected behavior
page should work.

## Screenshots
![image](https://user-images.githubusercontent.com/6822885/56849469-44c65380-6927-11e9-9bd4-8a0de7decf7c.png)

![image](https://user-images.githubusercontent.com/6822885/56849465-3841fb00-6927-11e9-9826-8676ccf06a81.png)

## System information
 - OS: ios8, ios9
 - Browser: safari
 - Version of Next.js: 8.1.0",Timer;ijjk,kind: bug;type: needs investigation,2019-04-27T12:03:47Z,2019-06-11T17:34:46Z,yanghuabei,keenjaan;e2goon;makarov-foot;MichaelIT;pedrommenezes;weishiji;fionawhim;ijjk;developit;JulesAU;Timer,Timer,,Timer,,Timer,
vercel/next.js,7242,"Cannot use Material UI components in next/link on canary # Bug report

## Describe the bug

Material UI components in next/link break next in the latest canary builds

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:
1. Use material UI 3.9.3
2. Use next 8.1.1-canary-24 
3. Use a Material UI Component as the first child of `<Link>`
4. See error

A code sandbox of the bug is available here: https://codesandbox.io/s/ll0qmmm0ql


## Expected behavior
You should be able to use Material UI component as the first child in a Link just as before (i.e. as was possible in next@8)

## Screenshots
![next-link-bug](https://user-images.githubusercontent.com/18407013/57170742-d4ef1780-6dc3-11e9-8b3a-9d97f3b6bb5a.gif)



## System information
 - Version of Next.js: 8.1.1-canary-24 

## Additional context

You can use a standard HTML element such as `<div>` (or another valid child such as `<>`) to wrap the Material UI child and the bug is subverted.

I think the bug was introduced by #7196 in canary-20.

The bug doesn't exist in canary-19 (after downgrading, using a material UI component as the first child works fine)

The error thrown in `next build` is
```
Failed to execute 'observe' on 'IntersectionObserver': parameter 1 is not of type 'Element'
```",ijjk,kind: bug,2019-05-03T23:53:03Z,2019-05-06T13:44:19Z,jaycenhorton,oliviertassinari,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,7392,"Duplicate <link rel='preload'> and <script> # Bug report

## Describe the bug

When using Webpack's magic comment (`/* webpackChunkName: ""balabala"" */`) to specify several modules bundling into one chunck, the output html contains duplicated `<link rel='preload'>` and `<script>` for the same chunck

## To Reproduce

a simple respository to reproduce the bug:

https://github.com/xboy2012/nextjs-duplicate-dynamic-reproduce

In the respository I defined two modules, `Module1` and `Module2`, using `/* webpackChunkName: ""allModules"" */` to make them bundling into chunck `allModules`.
 
Just execute `npm run dev`, open `http://localhost:3000/` in your browser.
 
Inspect the result HTML, then you'll see duplicated `<link rel='preload'>` and `<script>` such as follows:

```html
<!DOCTYPE html>
<html>
    <head>
        <meta charSet=""utf-8"" class=""next-head""/>
        <meta name=""viewport"" content=""width=device-width,minimum-scale=1,initial-scale=1"" class=""next-head""/>
        <link rel=""preload"" href=""/_next/static/development/pages/index.js?ts=1558408463129"" as=""script""/>
        <link rel=""preload"" href=""/_next/static/development/pages/_app.js?ts=1558408463129"" as=""script""/>
        <link rel=""preload"" href=""/_next/static/chunks/allModules.js?ts=1558408463129"" as=""script""/>
        <link rel=""preload"" href=""/_next/static/chunks/allModules.js?ts=1558408463129"" as=""script""/>
        <link rel=""preload"" href=""/_next/static/runtime/webpack.js?ts=1558408463129"" as=""script""/>
        <link rel=""preload"" href=""/_next/static/runtime/main.js?ts=1558408463129"" as=""script""/>
    </head>
    <body>
        <div id=""__next"">
            <div>
                <div>This is module1</div>
                <div>This is module2</div>
            </div>
        </div>
        <script src=""/_next/static/development/dll/dll_2011977376de5c4d4cfb.js?ts=1558408463129""></script>
        <script id=""__NEXT_DATA__"" type=""application/json"">
            {""dataManager"":""[]"",""props"":{""pageProps"":{}},""page"":""/"",""query"":{},""buildId"":""development"",""dynamicBuildId"":false,""dynamicIds"":[""./components/Module1.js"",""./components/Module1.js""]}
        </script>
        <script async="""" id=""__NEXT_PAGE__/"" src=""/_next/static/development/pages/index.js?ts=1558408463129""></script>
        <script async="""" id=""__NEXT_PAGE__/_app"" src=""/_next/static/development/pages/_app.js?ts=1558408463129""></script>
        <script async="""" src=""/_next/static/chunks/allModules.js?ts=1558408463129""></script>
        <script async="""" src=""/_next/static/chunks/allModules.js?ts=1558408463129""></script>
        <script src=""/_next/static/runtime/webpack.js?ts=1558408463129"" async=""""></script>
        <script src=""/_next/static/runtime/main.js?ts=1558408463129"" async=""""></script>
    </body>
</html>

```

Obviously, `allModules.js` is preloaded and loaded twice.

## Expected behavior

There should be no duplicated `<link rel='preload'>` and `<script>` for the same file.

## Screenshots
See the above description

## System information
 - OS: macOS
 - Browser Chrome
 - Version of Next.js:

I wrote the repository to reproduce the bug using Next 8.x

In my company project I face the same bug using Next 7.x

So it's likely all version have the bug

## Additional context

Not yet.
",lfades,kind: bug,2019-05-21T03:29:14Z,2019-05-27T01:17:08Z,xboy2012,xboy2012;timneutkens;Timer;wushaobo;shivgarg5676;macstr1k3r;jontelm;Juanperezc;littlepoolshark;rishabh2712;mimiqkz;balazsorban44;vinit-m;dcplchandra,timneutkens,,timneutkens,,ijjk,
vercel/next.js,752,"Error: ""Warning: 'next/css' is deprecated."" when importing Glamor. The next/css deprecation warning displays even when you import your own Glamor. (BYOG).
I have no imports of next/css in my project.

<img width=""1205"" alt=""next css warning"" src=""https://cloud.githubusercontent.com/assets/1828900/21904796/819ad35c-d8ca-11e6-8733-e35786595868.png"">
",timneutkens,kind: bug,2017-01-12T19:27:36Z,2017-01-14T15:07:27Z,frankalbenesius,timneutkens,timneutkens,,timneutkens,,nkzawa,
vercel/next.js,756,"Using fetch and Safari While developing an app I've used a custom server setup with `express` and I also used `fetch`. 
I had no idea that the latest version of Safari doesn't yet support `fetch` natively and it took me a while to understand this, so maybe it's possible to add a more friendlier error message?
I ended up using `isomorphic-fetch` 棣冩尨 

Error message running in dev mode (`const app = next({ dir: '.', dev: true });`) : 

<img width=""984"" alt=""screen shot 2017-01-12 at 10 16 03"" src=""https://cloud.githubusercontent.com/assets/23201486/21912281/3c7220f4-d925-11e6-8f16-93fd14be41ad.png"">

Error message running in prod mode (`const app = next({ dir: '.', dev: false });`) : 

<img width=""720"" alt=""screen shot 2017-01-12 at 01 21 38"" src=""https://cloud.githubusercontent.com/assets/23201486/21912282/3dbd5fc8-d925-11e6-92d9-d2a4076a6126.png"">

",arunoda,kind: bug,2017-01-12T23:40:31Z,2017-01-15T16:17:30Z,jetmirshatri,arunoda;timneutkens,arunoda;timneutkens,arunoda,arunoda,,nkzawa,
vercel/next.js,7713,"publicRuntimeConfig shouldn閳ユ獩 be undefined on build # Bug report

## Describe the bug

v8.1.1-canary.62 (or maybe 3aed76fad857b518a31675987e8c79f6f1afccde) (re-)introduces an issue with how I use (and recommend how to use) https://github.com/tusbar/next-runtime-dotenv.

## To Reproduce

This breaks on build as `publicRuntimeConfig` is `undefined` at build time:

```js
const {
  publicRuntimeConfig: {MY_API_URL}
} = getConfig()
```

## Expected behavior

`publicRuntimeConfig` used to be `{}` at build time.

## System information

- OS: macOS
- Version of Next.js: 8.1.1-canary.62

## Additional context

This is not the first time this breaks, maybe it would be nice to add a test. It used to work fine with `8.0.4`, it閳ユ獨 broken in `8.1.0` and used to work fine in canary before `8.1.1-canary.62`. Broken in `9.0` as well.",ijjk,kind: bug,2019-07-01T08:32:16Z,2019-07-09T11:23:52Z,tusbar,tusbar;cbarratt;egdelwonk;ijjk;ryandcsg;Timer;isaachinman;jtaox;controversial;timneutkens;Multiply;ColeTownsend;eddiewang;lukinasargy;kristojorg;csmartinsfct;jbcochery;nandorojo;vitorhsb;timdavish;leangl;baer,timneutkens;ijjk,,timneutkens,,timneutkens,
vercel/next.js,7764,"[typings] Router push and replace methods supporting UrlLike objects # Bug report

## Describe the bug

After upgrading to next canary (future v9) from 8.1.1, I got a few TypeScript errors when calling `Router.push(url)` and `Router.replace(url)` with object-like URLs.

This seems like a regression in built-in typings compared to the third-party ones (`@types/*`). Related to https://github.com/zeit/next.js/pull/6644.

## To Reproduce

```tsx
import { Router, useRouter } from ""next/router"";

const router: Router = useRouter();

// 棣冩啢
router.push(""/about"");
router.replace(""/about"");

// 閴 Argument of type '{ pathname: string; }' is not assignable to parameter of type 'string'.ts(2345)
router.push({ pathname: ""/about"" });
router.replace({ pathname: ""/about"" });
```

## Expected behavior

I expected url-like objects to be still acceptable. Not sure if new typings are simply incomplete or objects are arguments are being deprecated.

https://github.com/zeit/next.js/blob/cc497568b4b226498069c9a7adbdc03e689b8526/packages/next-server/lib/router/router.ts#L208-L226

Typings in `@types/next-server`:

* [Definition of `UrlLike` type](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/132720a17e15cdfcffade54dd4a23a21c1e16831/types/next-server/router.d.ts#L19
)
* [Usage in `push() and` `replace()`](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/132720a17e15cdfcffade54dd4a23a21c1e16831/types/next-server/router.d.ts#L48-L58)

There exists a local `Url` type in `next/client`, which seems like what's needed. Should it be moved to `next-server/router`?

https://github.com/zeit/next.js/blob/b60985b2be964dcac436d025a1943ded6454deaf/packages/next/client/link.tsx#L24

It's already [used in `<Link />` prop types](https://github.com/zeit/next.js/blob/b60985b2be964dcac436d025a1943ded6454deaf/packages/next/client/link.tsx#L49-L50).

---

One more thing: `useRouter()` returns `any` because of how  `RouterContext` is typed 棣
https://github.com/zeit/next.js/blob/cc497568b4b226498069c9a7adbdc03e689b8526/packages/next/client/router.ts#L125-L127
https://github.com/zeit/next.js/blob/b1fdffec75a7a7ce24693e4e1974714ac7733551/packages/next-server/lib/router-context.ts#L3

## System information

- Version of Next.js: `8.1.1-canary.69`
",lfades;huv1k,kind: bug,2019-07-06T12:08:42Z,2019-07-11T17:35:39Z,kachkaev,balazsorban44,Timer,,huv1k;Timer,,Timer,
vercel/next.js,7775,"HMR with certain dynamic routes doesn't work (e.g. `[name]`) # Bug report

When using the new dynamic routing feature the parameters are correctly recognized and passed to the router but HMR doesn't work properly.

## To Reproduce

1. Go to https://github.com/damianfrizzi/nextjs9HMR
2. Install and run yarn dev
3. Make a change to pages/index.tsx -> HMR works
4. Make a change to pages/project/[owner]/[name].tsx -> HMR doesn't work
 
## Expected behavior

A change to [name].tsx should trigger HMR.

## System information

- OS: macOS
- Browser (if applies): Chrome
- Version of Next.js: 9.0.0
",Timer;ijjk,kind: bug,2019-07-08T08:47:19Z,2019-08-01T16:17:43Z,damianfrizzi,huv1k;joeponzio;ijjk;stevefan1999-personal;wilsonpage;Timer;balazsorban44,huv1k;Timer,Timer,Timer,,ijjk,
vercel/next.js,7799,"Improve Router Typings # Feature request

Improve typings for the router.

## Describe the solution you'd like

A couple examples:

* `useRouter` seems to have an `any` return type (because of [this line](https://github.com/zeit/next.js/blob/master/packages/next-server/lib/router-context.ts#L3)) 

```
import * as React from 'react'
import { BaseRouter } from './router/router'

export const RouterContext = React.createContext<BaseRouter | null>(null)
```

* `useRouter` should be generic, as well. This involves propagating generics down through to `BaseRouter<P>` (and finally update `query` to `query: ParsedUrlQuery & P`). This is to allow you to specific custom query (URL params, etc).
* Regression: lost `WithRouterProps` type export from `next/router`
* Improved [`WithRouterProps`](https://github.com/zeit/next.js/blob/master/packages/next/client/with-router.tsx#L6) typings via generics. See [here](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/next-server/router.d.ts#L81). 
* (still finding more)

## Describe alternatives you've considered

The only ""alternatives"" are rolling your own types and asserting e.g. `router.query as MyQueryType` etc.
",lfades;huv1k,kind: bug;type: needs investigation,2019-07-08T21:17:25Z,2019-07-09T01:31:55Z,tills13,tills13;felixmosh;huv1k;Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,7802,[Next 9.0.0] Router types for url objects Router in Next 8 supports url objects `{ pathname: ... }` but types support only string. It's bug or that feature was removed?,lfades;huv1k,kind: bug;type: needs investigation,2019-07-08T21:30:14Z,2019-07-08T21:37:00Z,steida,Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,7829,`exportPathMap` dynamic route query should be set `exportPathMap` needs to be validated against a dynamic page and have the query set at export-time.,huv1k,kind: bug,2019-07-09T12:03:22Z,2019-07-10T21:13:45Z,Timer,deviant32;jerstucki;balazsorban44,Timer,,huv1k,,Timer,
vercel/next.js,7834,"TypeError: declaration.init.properties is not iterable # Bug report

## Describe the bug
Unable to build Next if we export a `config` variable in a file
Assume it's a bug as I had no problem with Next 8, but was unable to build / run after updating to Next 9

## To Reproduce
`export const config = ""someValue""` will cause a webpack `TypeError: declaration.init.properties is not iterable` error.
I assume `config` is now a reserved keyword as I had no problem before.

So not really difficult to correct, as you only have to change the export var name, but it can save hours if someone like me was exporting a `config` variable
",ijjk,kind: bug;type: needs investigation,2019-07-09T14:34:15Z,2019-07-10T19:27:12Z,dbuchet,timneutkens;rickyclegg;Timer;alisd23;Fumler;balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,7838,"Next.js config analysis should handle invalid config Follow-up https://github.com/zeit/next.js/issues/7834

Meaning, if the user does `export const config = 'applesauce'` we should tell them it's not a valid shape.",ijjk,kind: bug,2019-07-09T15:43:52Z,2019-07-15T20:54:36Z,Timer,mmiszy;timneutkens;balazsorban44,Timer,,Timer,,ijjk,
vercel/next.js,7852,"Next 9 - Assigning a ref to the child of <Link> no longer works # Bug report

## Describe the bug
In Next 8, the ref attached to an `<a>` element inside of `<Link>` was working correctly. With the introduction of intersection observer in Next 9, it looks like this ref is getting overwritten, even with prefetch disabled.

## To Reproduce
Here's an example page:
```
import Link from ""next/link"";
import { useRef, useEffect } from ""react"";

const Home = () => {
  const buttonRef = useRef();

  useEffect(() => {
    console.log(""buttonRef"", buttonRef);
  });

  return (
    <Link href=""/"">
      <a ref={buttonRef}>click me</a>
    </Link>
  );
};

export default Home;

```

Steps to reproduce the behavior:

1. Load the page
2. Check the console

## Expected behavior

`buttonRef.current`'s value in Next 8 is a reference to the `<a>` tag. In Next 9, it's `undefined`.

## System information
- Version of Next.js: 9.0.0

## Additional context

Not sure if this is an intended breaking change, but would be useful documented if so.
",huv1k,kind: bug;type: needs investigation,2019-07-09T22:06:19Z,2019-08-08T18:11:18Z,fmapilis,alexlafroscia;Emiliano-Bucci;srghma;balazsorban44,Timer;huv1k,,huv1k,,ijjk,
vercel/next.js,7879,"TS errors do not reflect state of code # Bug report

## Describe the bug

After running `next`, next takes an arbitrary amount of time to resolve TypeScript errors that have actually since been fixed in the code.

Below is terminal output showing a TS error which should have been resolved after the first  [ error ], but continued to log after continual saves. The last line shows that next has recognized this as resolved, but nothing had changed in the actual code by this point.

```shell
undefined
[ event ] build page: /next/dist/pages/_error
[ wait ]  compiling ...
[ info ]  bundled successfully, waiting for typecheck results ...
[ error ] ERROR in /Users/admin/export-buffer/pages/api/index.ts
8:51 Type 'void' is not a valid async function return type in ES5/ES3 because it does not refer to a Promise-compatible constructor value.
     6 | Sentry.init({ dsn: process.env.SENTRY_DSN });
     7 | 
  >  8 | async function executeScript(scriptname: string): void {}
       |                                                   ^
     9 | 
    10 | export default (req: NextApiRequest, res: NextApiResponse) => {
    11 |   console.log(req);
[ wait ]  compiling ...
[ error ] ERROR in /Users/admin/export-buffer/pages/api/index.ts
8:51 Type 'void' is not a valid async function return type in ES5/ES3 because it does not refer to a Promise-compatible constructor value.
     6 | Sentry.init({ dsn: process.env.SENTRY_DSN });
     7 | 
  >  8 | async function executeScript(scriptname: string): void {}
       |                                                   ^
     9 | 
    10 | export default (req: NextApiRequest, res: NextApiResponse) => {
    11 |   console.log(req);
[ wait ]  compiling ...
[ error ] ERROR in /Users/admin/export-buffer/pages/api/index.ts
8:51 Type 'void' is not a valid async function return type in ES5/ES3 because it does not refer to a Promise-compatible constructor value.
     6 | Sentry.init({ dsn: process.env.SENTRY_DSN });
     7 | 
  >  8 | async function executeScript(scriptname: string): void {}
       |                                                   ^
     9 | 
    10 | export default (req: NextApiRequest, res: NextApiResponse) => {
    11 |   console.log(req);
[ event ] disposing inactive page(s): /api, /next/dist/pages/_error
[ info ]  bundled successfully, waiting for typecheck results ...
[ ready ] compiled successfully (ready on http://localhost:3000)
```

## To Reproduce

- run `next` on a project with a `.tsx` or `.ts` file (and use generated `tsconfig.json`)
- let the ts compiler fail
- fix the ts issue

## Expected behavior

The first change that appeases the ts compiler should be understood by next.

## System information

- OS: macOS
- 9.0.0
",Timer,kind: bug,2019-07-10T16:51:16Z,2019-09-11T17:06:49Z,nonnontrivial,balazsorban44,timneutkens;Timer,Timer,timneutkens,Timer,Timer,
vercel/next.js,7880,"Dynamic routing behaves differently in Dev vs Prod In dev, prerendered pages have their queries empty. In prod, the queries are the placeholders `[param]`.

The desired behavior is for both of these to be empty. Not sure if we should use `undefined`, `null`, or `''`. 

I'm leaning towards `null` or empty string.

This **must** have a failing test added in a PR before it can be fixed.",ijjk,kind: bug,2019-07-10T17:16:48Z,2019-07-10T19:23:28Z,Timer,brunolemos;Timer;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,7889,"[v9 regression] react-ssr-prepass isnt bundled in serverless production and deployment fails, but works locally # Bug report

## Describe the bug

Severe as in app doesnt start in prod.

react-ssr-prepass dependent app:
* (next.js@8) works fine in dev and prod
* (next.js@9) works fine in dev, but **fails in prod**

It fails with the following error:

```stdout
START RequestId: c1360c24-825d-4620-b70d-95a61da26a78 Version: $LATEST
2019-07-10T23:37:47.210Z	undefined	ERROR	Uncaught Exception	{
	""errorType"":""Runtime.ImportModuleError"",
	""errorMessage"":""Error: Cannot find module 'react-ssr-prepass'"",
	""stack"":[
""Runtime.ImportModuleError: Error: Cannot find module 'react-ssr-prepass'"",
""    at _loadUserApp (/var/runtime/UserFunction.js:100:13)"",
""    at Object.module.exports.load (/var/runtime/UserFunction.js:140:17)"",
""    at Object.<anonymous> (/var/runtime/index.js:36:30)"",
""    at Module._compile (internal/modules/cjs/loader.js:701:30)"",
""    at Object.Module._extensions..js (internal/modules/cjs/loader.js:712:10)"",
""    at Module.load (internal/modules/cjs/loader.js:600:32)"",
""    at tryModuleLoad (internal/modules/cjs/loader.js:539:12)"",
""    at Function.Module._load (internal/modules/cjs/loader.js:531:3)"",
""    at Function.Module.runMain (internal/modules/cjs/loader.js:754:12)"",
""    at startup (internal/bootstrap/node.js:283:19)""]}
END RequestId: c1360c24-825d-4620-b70d-95a61da26a78
REPORT RequestId: c1360c24-825d-4620-b70d-95a61da26a78	Duration: 239.19 ms	Billed Duration: 300 ms 	Memory Size: 3008 MB	Max Memory Used: 47 MB	
Unknown application error occurred
Runtime.ImportModuleError
```

Important to note: app [explicitly depends on `react-ssr-prepass`](https://github.com/iamstarkov/topics-manager/blob/master/package.json#L26)

## To Reproduce

* Working v8 demo https://topics-manager.now.sh/ (master)
* Failing v9 demo https://topics-manager-phz67x2ki.now.sh/ (only one bump commit ahead of master)
* Related PR https://github.com/iamstarkov/topics-manager/pull/93

You need `now` installed globally

```shell
npm i -g now # if you dont have now installed globally
git clone git@github.com:iamstarkov/topics-manager.git
cd topics-manager
git checkout renovate/major-nextjs-monorepo
yarn
cp .env.example .env
yarn dev # dev works
now deploy # in prod it wont start
```

## Expected behavior

Perhaps, should not fail in prod as far as it doesnt fail locally.

## System information

- OS: probably n/a, but macOS Mojave 10.14.5 (18F132)
- Version of Next.js: v8 vs v9

## Additional context

I see a lot of [back and forth issues/pull-requests regarding `react-ssr-prepass`](https://github.com/zeit/next.js/issues?utf8=%E2%9C%93&q=react-ssr-prepass+). Maybe some of them caused this problem. 

I cant replicate error locally, because next.js is set to `serverless` mode. Furthermore, i use `now dev` and didnt see `local prod` mode of it too. Is there any documentation on how can one debug production-only problems like this?

Maybe, i lack context and some documentation. If someone can help with those, then perhaps i can try try to fix this issue on my own
",ijjk,kind: bug,2019-07-11T00:31:11Z,2019-07-15T14:41:54Z,iamstarkov,sync;iamstarkov;tmilar;Timer;enzoferey;andrey-semin,Timer,,Timer;ijjk,timneutkens,timneutkens,
vercel/next.js,7909,"publicRuntimeConfig as {} is truthy, so error is thrown with serverless target # Bug report

## Describe the bug

Because `publicRuntimeConfig` is initialized as `{}` at https://github.com/zeit/next.js/blob/canary/packages/next-server/server/config.ts#L43 and `{}` is truthy, at https://github.com/zeit/next.js/blob/canary/packages/next-server/server/config.ts#L109 the expression evaluates as `true` when the user is targeting `serverless`, and the error is thrown.

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Install latest `next` (v9.0.1-canary.2) in a Next project.
2. Target `serverless` in `next.config.js`.
3. Don閳ユ獩 use `publicRuntimeConfig` in `next.config.js`.
3. Run `next` or `next dev`.
4. Error will be thrown, even though `publicRuntimeConfig` is not used.

## Expected behavior

When `publicRuntimeConfig` is an empty object, it閳ユ獨 not being used, and so the error regarding its incompatibility with serverless targets should not be thrown.

## Screenshots

N/A

## System information

- OS: macOS 10.15
- Browser: N/A
- Version of Next.js: v9.0.1-canary.2

## Additional context

N/A
",ijjk,kind: bug,2019-07-12T02:29:14Z,2019-07-12T22:16:56Z,4cm4k1,cj;eugrdn;balazsorban44,huv1k,,timneutkens,,ijjk,
vercel/next.js,7915,"Next 9  - Using functional components as child of <Link/> causes ref-warnings # Bug report

## Describe the bug

Using a functional component as a child of `<Link/>` causes:
```
Warning: Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?
```
This happened only after upgrading from v8 => v9.

## To Reproduce

Reproduction repo: https://github.com/nickluger/nextjs-link-ref-functional-comp-warning


## Expected behavior

`<Link/>` should work with functional components, too / not show a warning.

## System information

- Version of Next.js: 9.0.1


",ijjk,kind: bug,2019-07-12T05:44:47Z,2019-08-08T18:11:18Z,nickluger,mustaphaturhan;joaogarin;DonovanCharpin;nickluger;bschwartz757;JonCognioDigital;Vadorequest;hill84;tim-codes;namlq93;andy-pro;mikeyrt16;LauraBeatris;hothvictor;ken-nah;TomasSestak;cgarrovillo;focux;paulboony;th0th;tm1000;srghma,timneutkens,,timneutkens,,ijjk,
vercel/next.js,7927,"TS ErrorComponent => getInitialProps not async # Bug report

## Describe the bug

Trying to port my TypeScript Next 8 to Next 9 and get typecheck inside the error component 

I am extending the generic error component with my own and I need to do some async operations inside `getInitialProps`. `@types/next` has `getInitialProps` can return a promise not not the new built in types. Is there a reason?

Error:
```
Class static side 'typeof CustomError' incorrectly extends base class static side 'typeof Error'.
  Types of property 'getInitialProps' are incompatible.
    Type '({ res, err }: NextPageContext) => Promise<{ statusCode: number; }>' is not assignable to type '({ res, err }: NextPageContext) => { statusCode: number | undefined; }'.
      Property 'statusCode' is missing in type 'Promise<{ statusCode: number; }>' but required in type '{ statusCode: number | undefined; }'.ts(2417)
```

## To Reproduce

```typescript
import ErrorComponent from 'next/error';

class CustomError extends ErrorComponent {
  	static async getInitialProps({ res }: NextPageContext) {
      	if (res.statusCode !== 500) {
			await doSomething();
     	}
		return { statusCode }
  	}
}

```

## Expected behavior

I assume that `getInitialProps` is async like any other page.

## Screenshots

N/A

## System information

- OS: macOS
- Browser (if applies): chrome
- Version of Next.js: 9.0.1

## Additional context

Add any other context about the problem here.
",huv1k,kind: bug,2019-07-12T14:52:37Z,2019-07-15T23:16:41Z,ematipico,balazsorban44,timneutkens,,timneutkens,,Timer,
vercel/next.js,7977,"Custom pages/_error.js doesn't work for serverless deployment # Bug report

## Describe the bug

When using `target: 'serverless'` I'm running into an exception in next code that prevents my custom `pages/_error.js` page from rendering:

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

Reduced test-case: https://github.com/wilsonpage/now-test-serverless-custom-error-page

## Expected behavior

When an exception is thrown in a page's `render()` method next should `500` error and render `pages/_error.js`.

## Stack trace

Full stack trace from `now logs` showing the initial error throw, then later a `next` internal error related to `experimentalPrerender`:

```
Error: wat
  at Page (/var/task/page.js:6886:9)
  at c (/var/task/page.js:2542:501)
  at Sa (/var/task/page.js:2545:1)
  at a.module.exports.FDah.a.render (/var/task/page.js:2550:467)
  at a.module.exports.FDah.a.read (/var/task/page.js:2550:58)
  at renderToString (/var/task/page.js:2562:83)
  at render (/var/task/page.js:4592:16)
  at renderPage (/var/task/page.js:4741:20)
  at _callee2$ (/var/task/page.js:5588:24)
  at tryCatch (/var/task/page.js:8175:40)
2019-07-15T15:42:28.270Z 3cdab899-ea89-426f-b13b-4b4571b0ed36    TypeError: Cannot read property 'experimentalPrerender' of undefined
      at renderToHTML (/var/task/page.js:4620:43)
      at <anonymous>
      at process._tickDomainCallback (internal/process/next_tick.js:228:7)
```

## System information

- OS: Deployed via `Now`
- Version of Next.js: 9.0.1

",ijjk,kind: bug,2019-07-15T16:07:12Z,2019-07-16T00:06:17Z,wilsonpage,wilsonpage;balazsorban44,Timer;ijjk,ijjk,Timer,,Timer,
vercel/next.js,7991,"Next.js 9 Name conflict: 404 for files/folders in pages that start with api # Bug report

## Describe the bug

There is a naming conflict bug for files or folders in the root of `/pages` that start with `api` i.e.  `/pages/api-test.js` or `/pages/api-test/index.js` that results in a `404`. This bug seems to be result of this line of code [/packages/next/build/entries.ts](https://github.com/zeit/next.js/blob/canary/packages/next/build/entries.ts#L71). Files or folders that begin with the name `api` in the root of the `/pages` folder receive the following error in the console:
```
Failed to load resource: the server responded with a status of 404 (Not Found)
```

Additionally clicking on a element with an `onClick` event is unresponsive. Example [/pages/api-test.js](https://github.com/khasty720/next-js-api-name-conflict/blob/9cedabd881c7f441c9830d29948fd47134d7f690/pages/api-test.js#L7).
## To Reproduce
**Repository**
https://github.com/khasty720/next-js-api-name-conflict

**Live Example**
https://nextjs-iv9d3ozsv.now.sh/

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Go to http://localhost:3000 or https://nextjs-iv9d3ozsv.now.sh
2. Click on 'API Test'
3. Open console
4. See error: 
```
Failed to load resource: the server responded with a status of 404 (Not Found)
```
## Expected behavior

Clicking on alert link does not work on http://localhost:3000/api-test. The same `Alert` component does work on http://localhost:3000/alert-test. The expected behavior is that the page will load and not throw a 404.

## System information

- Version of Next.js: 9.0.1

## Additional context

Additional places where `/api` is referenced:

https://github.com/zeit/next.js/blob/canary/packages/next/build/entries.ts#L71
https://github.com/zeit/next.js/blob/canary/packages/next/build/webpack/loaders/next-serverless-loader.ts#L42
https://github.com/zeit/next.js/blob/canary/packages/next/build/index.ts#L324
https://github.com/zeit/next.js/blob/canary/packages/next/build/entries.ts#L71",huv1k,kind: bug,2019-07-16T02:59:48Z,2019-07-16T10:59:10Z,khasty720,balazsorban44,huv1k,,huv1k,,timneutkens,
vercel/next.js,8017,"api routes not working with now dev and Windows # Bug report

## Describe the bug

Trying to use the new api routes with `now dev` results in a 404

## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

1. Download one of the api routes examples
2. install dependencies and run `now dev`
3. See 404 for api routes

## Expected behavior

api routes should be available in the app

## System information

- OS: Windows
- Version of Next.js: ^9.0.0

## Additional context

This is only for Windows, and only for `now dev`
",huv1k,kind: bug,2019-07-17T16:52:26Z,2019-07-24T08:47:43Z,lfades,Erik-Sovereign;sjyasuosj;huv1k;balazsorban44,Timer,,lfades,,huv1k,
vercel/next.js,8024,"Transplilation for IE11 # Bug report

## Describe the bug

I am getting multiple transpilation errors on IE11. Eg:

Invalid syntax:

`next-server@9.0.2/dist/lib/amp.js`:

```
function isInAmpMode({ ampFirst = false, hybrid = false, hasQuery = false, } = {}) {
``` 

`next-server@9.0.2/dist/lib/dynamic.js`:

```
return () => (react_1.default.createElement(Loading, { error: null, isLoading: true, pastDelay: false, timedOut: false }));
```

From the docs:

```
Next.js supports IE11 and all modern browsers out of the box 
```

I'm not exactly sure why the above is not transpiled into IE11 friendly code?

## To Reproduce

You can see the transpiled code:

https://unpkg.com/next-server@9.0.2/dist/lib/dynamic.js
https://unpkg.com/next-server@9.0.2/dist/lib/amp.js

## Expected behavior

Compiled code in `dist` is IE11 compatible.
",ijjk,kind: bug,2019-07-18T06:41:55Z,2019-07-19T02:09:41Z,ellioseven,ijjk;balazsorban44,timneutkens;ijjk,ijjk,timneutkens,,Timer,
vercel/next.js,8068,"Async webpack plugin errors hang watch mode If you throw an error from an async webpack plugin hook while running next.js in dev mode, rather than crashing or displaying the error, the compilation hangs indefinitely. This makes a wide variety of webpack plugins incompatible with next.js.

I have set up a minimal reproduction of the issue here: https://github.com/jescalan/nextjs-webpack-bug-repro/tree/next

I also created a minimal reproduction with webpack only and not next.js which can be seen on the master branch, but it works fine with webpack which leads me to believe this is an issue with next.js.

If there's any way I can help resolve this one and someone can point me in the right direction I'd be happy to pitch in!",Timer,kind: bug,2019-07-23T03:18:14Z,2020-07-30T03:44:26Z,jescalan,balazsorban44,Timer,Timer,Timer,,Timer,
vercel/next.js,8071,"corejs2 with worker-loader _ Uncaught ReferenceError: window is not defined # Bug report




## Describe the bug

worker-loader load some worker file,  but Uncaught ReferenceError window is not defined, see the Screenshots.






## To Reproduce

Steps to reproduce the behavior, please provide code snippets or a repository:

use this project and update the next.js version to lastest. 
(""next"": ""^8.1.0"",) is OK.

https://github.com/ritz078/transform


## Expected behavior



## Screenshots

![Jietu20190723-153015](https://user-images.githubusercontent.com/1061012/61691850-07733580-ad5f-11e9-8dbf-b048e7a3e09a.jpg)

## System information

- OS: macOS
- Browser chrome
- Version of Next.js: 9.0.2

## Additional context

Add any other context about the problem here.
",developit,kind: bug;type: needs investigation,2019-07-23T07:40:01Z,2019-11-09T21:30:04Z,icai,timneutkens;developit;ChhenglinHor;balazsorban44,Timer;timneutkens,,developit,,timneutkens,
vercel/next.js,8074,"AMP pages include the query string in the canonical URL # Bug report

AMP pages include the query string in the canonical URL.

## Describe the bug

On AMP pages the canonical link includes the query string. This has potential to cause duplicate content SEO issues on post pages, etc.

Using https://nextjs.org/blog/next-9 as an example:
- https://nextjs.org/blog/next-9 (`<link rel=""canonical"" href=""/blog/next-9""/>`)
- https://nextjs.org/blog/next-9?utm_source=google (`<link rel=""canonical"" href=""/blog/next-9?utm_source=google""/>`)
- https://nextjs.org/blog/next-9?foo=bar (`<link rel=""canonical"" href=""/blog/next-9?foo=bar""/>`)

In this example the query string does not affect the content, however each URL has a different canonical value.

## To Reproduce

Visit an AMP page such as https://nextjs.org/blog/next-9 with and without query strings. Inspect the canonical link and note the inclusion of the query string.

## Expected behavior

In the example above, the canonical link should not include the query string. However, this is nuanced, since in some situations including the query string (or a subset of the params) might be necessary when building the canonical link. For example, a URL such as `/post?id=123456&foo=junk` could potentially require a canonical link of `<link rel=""canonical"" href=""/post?id=123456""/>` for correct SEO.

Ideally Next would allow full control over the canonical, i.e. it could be overridden. See https://github.com/zeit/next.js/issues/7706 for a similar feature request and https://github.com/zeit/next.js/pull/7373.

## Screenshots

N/A

## System information

- Version of Next.js: 9

## Additional context

We are using hybrid AMP rendering for our post pages. We already set our canonical for the non-AMP version, and there are lots of business and SEO concerns when it comes to canonical links (we are a media company). Having full control over the canonical in the AMP context would be incredibly useful for us.",ijjk,kind: bug,2019-07-23T13:47:47Z,2019-07-29T07:18:24Z,andrewb,K4R0LW;balazsorban44,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,8111,"500 on /pages/api/index.js on Zeit Now # Bug report

## Describe the bug

You get a 500 with code in `/pages/api/index.js` but not if you put the same code in `/pages/api/foo.js`

## To Reproduce

Put the following code in `/pages/api/index.js`:
```js
export default (req, res) => {
  res.setHeader('Content-Type', 'application/json');
  res.statusCode = 200;
  res.end(JSON.stringify({ name: 'Nextjs' }));
};
```

Deploy to Now, and go to `deployment.endpoint/api`, you'll get a 500 (complaining that res.setHeader is not a function).

Hope I'm not missing something. Cheers!
",huv1k,kind: bug,2019-07-25T16:07:28Z,2019-07-26T07:12:59Z,guillaumervls,balazsorban44,huv1k,,Timer,,huv1k,
vercel/next.js,8115,"Pages that start with ""api"" don't load CSS # Bug report

## Describe the bug

Pages that start with ""api"" (eg. `api-test`) don't generate any CSS (or SASS in my case).

Console output:
```
[ event ] build page: /api-agreement
[ wait ]  compiling ...
[ ready ] compiled successfully - ready on http://localhost:3000
Could not find files for /api-agreement in .next/build-manifest.json
```

## To Reproduce

- Clone this repo: https://github.com/panta82/nextjs-bug-demo
- `npm install`
- `npm start`
- Open: http://localhost:3000/api-test

## Expected behavior

You should see red text. Instead, the text is black and there is an error in terminal.

## System information

- OS: Ubuntu 19.04
- Browser: Chrome
- Version of Next.js: 9.0.2

## Additional context

Related to this probably: https://github.com/zeit/next.js/pull/7992
Not fixed all the way, it seems.",huv1k,kind: bug;type: needs investigation,2019-07-25T22:44:47Z,2019-07-26T15:02:13Z,panta82,balazsorban44,timneutkens;huv1k,,timneutkens,,timneutkens,
vercel/next.js,8133,"Remove next.config.js from create-next-app demo app Currently the generated app has a `next.config.js` even though it's not needed to get started, furthermore it updates the webpack config.",lfades;huv1k,kind: bug,2019-07-27T08:08:50Z,2019-07-27T18:46:41Z,timneutkens,balazsorban44,timneutkens,,timneutkens,,timneutkens,
vercel/next.js,8265,"Experimental Prerendering should go to server for skeleton hydration The skeleton hydration should not happen client-side except for in development mode.

During production, this should go to the server.

x-ref: https://github.com/zeit/next.js/pull/7983",ijjk,kind: bug,2019-08-06T19:35:36Z,2019-08-12T01:56:58Z,Timer,balazsorban44,Timer,,ijjk,,Timer,
vercel/next.js,827,"Server-side error in with-loading example? The [with-loading](https://github.com/zeit/next.js/tree/master/examples/with-loading) example works well client-side, but on hard refreshing the `/forever` or `/about` routes, it throws `Cannot read property 'Component' of undefined`. `Component` is being imported from `React` in those two pages. Full trace:

```
TypeError: Cannot read property 'Component' of undefined
    at _callee3$ (http://localhost:3000/_next/-/main.js:11570:50)
    at tryCatch (http://localhost:3000/_next/-/commons.js:12871:40)
    at Generator.invoke [as _invoke] (http://localhost:3000/_next/-/commons.js:13162:22)
    at Generator.prototype.(anonymous function) [as next] (http://localhost:3000/_next/-/commons.js:12923:21)
    at step (http://localhost:3000/_next/-/commons.js:3111:30)
    at http://localhost:3000/_next/-/commons.js:3129:14
    at F (http://localhost:3000/_next/-/commons.js:1634:28)
    at http://localhost:3000/_next/-/commons.js:3108:12
    at doRender (http://localhost:3000/_next/-/main.js:11587:18)
    at Object._callee$ (http://localhost:3000/_next/-/main.js:11489:20)
```",arunoda,kind: bug,2017-01-19T16:55:25Z,2017-01-20T19:33:47Z,moarwick,arunoda;matthewmueller,arunoda,arunoda,arunoda,,rauchg,
vercel/next.js,828,"render arrow functions breaking in 2.0.0-beta.17 The code below
* Works in ""1.2.3""
* Breaks in ""2.0.0-beta.17""
```
import React, { Component } from 'react'

export default class App extends Component {
    render = () => <div>Hi</div> //notice the arrow function
}
```

Errors:
```
warning.js?1292f09:36 Warning: App(...): A valid React element (or null) must be returned. You may have returned undefined, an array or some other invalid object.
```
```
warning.js?1292f09:36 Warning: React attempted to reuse markup in a container but the checksum was invalid. This generally means that you are using server rendering and the markup generated on the server was not what the client was expecting. React injected new markup to compensate which works but you have lost many of the benefits of server rendering. Instead, figure out why the markup being generated is different on the client or server:
 (client) "" data-reactid=""1""><!-- react-empty: 2 -
 (server) "" data-reactid=""1""><div data-reactid=""2""
```",arunoda,kind: bug,2017-01-19T17:01:27Z,2017-01-22T18:11:56Z,johnlindquist,arunoda;johnlindquist;nkzawa;avanslaars,rauchg;arunoda,,rauchg,,rauchg,
vercel/next.js,8297,AppTree types don't allow passing properties https://github.com/zeit/next.js/pull/8180#issuecomment-519757572,lfades;ijjk,kind: bug,2019-08-09T12:25:57Z,2019-08-13T20:15:45Z,timneutkens,balazsorban44,timneutkens,,timneutkens;Timer,Timer,Timer,
vercel/next.js,8347,"Safari raises SyntaxError: The string did not match the expected pattern. # Bug report

## Describe the bug
My app of next@9.0.4-canary.3 raise error in safari.

main.js
```js
function markHydrateComplete() {
  if (!_utils.SUPPORTS_PERFORMANCE_USER_TIMING) return;
  performance.mark('afterHydrate'); // mark end of hydration

  performance.measure('Next.js-before-hydration', null, 'beforeRender');
  // => SyntaxError: The string did not match the expected pattern.
  performance.measure('Next.js-hydration', 'beforeRender', 'afterHydrate');
  clearMarks();
}
```

it seems that safari doesn't exec with second args.

<img width=""583"" alt=""閵堝箍鍋楅妷閵夌哄厒閵堟灚鍎抽妷鍐﹀創 2019-08-13 20 20 08"" src=""https://user-images.githubusercontent.com/7007253/62937751-7eed2f80-be08-11e9-9fe1-edd886e7f6ff.png"">


## To Reproduce
1. Create next app
2. Upgrade next to 9.0.4-canary.3
3. Start dev server
4. Open broswer

## Expected behavior
Safari does not raise a error.

## Screenshots

<img width=""1474"" alt=""閵堝箍鍋楅妷閵夌哄厒閵堟灚鍎抽妷鍐﹀創 2019-08-13 20 18 31"" src=""https://user-images.githubusercontent.com/7007253/62937423-8a8c2680-be07-11e9-9301-9aeda1cd6df4.png"">

## System information

- OS: macOS 10.14.4
- Browser (if applies): Safari 12.1
- Version of Next.js: 9.0.4-canary.3

",housseindjirdeh,kind: bug,2019-08-13T11:28:25Z,2019-08-13T15:48:31Z,mottox2,developit;balazsorban44,timneutkens,,timneutkens,,Timer,
vercel/next.js,8660,"Router#asPath doesn't match between SSR and CSR # Bug report

## Describe the bug

`asPath` doesn't match between SSR and CSR when using dynamic routes

## To Reproduce

https://github.com/Rokt33r/broken-router

1. Run `npm run dev`
2. Click on one of Post links
3. Refresh page
4. See error

<img width=""475"" alt=""Screen Shot 2019-09-07 at 4 43 54"" src=""https://user-images.githubusercontent.com/5865853/64456024-228cdf80-d12a-11e9-9060-41629ca04e80.png"">

## Expected behavior

`""asPath""` should always be `""/posts/1""`

## System information

- OS: macOS
- Browser (if applies) : chrome
- Version of Next.js: next@9.0.5
",ijjk,kind: bug,2019-09-06T19:46:10Z,2019-09-10T17:30:26Z,Rokt33r,fwojciec;balazsorban44,Timer;ijjk,ijjk,Timer,,Timer,
vercel/next.js,868,"A fully rendered next page is re-rendered to a 404 page after successfull initial render I've been trying to track this down for a day now and I've managed to come up with a small example code and I know the version bump that caused this issue.

This happens in older versions of Safari and Mobile Safari. The newest version of Safari I've found to have this issue is version 8.0.8 that is the only bundled browser for Yosemite. It's not even that old comparing how long Mac's last. I haven't seen this bug in other browsers (Chrome, FF etc.) while testing.

In `beta.12` the app renders correctly and no issues arise. With `beta.13` the app is first rendered correctly and then very quickly re-rendered to a ""404 This page could not be found."". I've tracked that the issue is related to next trying to load a URL `http://localhost:3000/_next/pages/fi` on Safari that leads to a 404 error that causes the app to render the 404 page. Why this is happening is some kind of internal issue with next, custom server and older Safaris (my best guess).

Here's what I can provide to help solve this issue:
- Still happens with `beta.18`
- [A video of the issue happening on Safari 8.0.8](https://dl.dropboxusercontent.com/u/36387431/next-issue.mov)
- [A repo branch with example code](https://github.com/sarukuku/next-custom-server-express/tree/double-redirect)
- [Version bump where the bug appeared](https://github.com/zeit/next.js/compare/43e2707e5dcb961189e2ddab3492c2ce8360758d...45bc4fe46550c8085f90173275dcbd57fb2f9acb) (`beta.12` -> `beta.13`)
",arunoda,kind: bug,2017-01-24T08:33:30Z,2017-01-25T16:58:27Z,sarukuku,sarukuku;tpai;arunoda,arunoda,,arunoda,,nkzawa,
vercel/next.js,880,"help needs on error I get this error when  upgrade next from 2.0.0-beta.13 to 2.0.0-beta.14 or newer.
![image](https://cloud.githubusercontent.com/assets/631261/22293448/7e01d6c0-e34a-11e6-8a86-8cdf6c50b704.png)


This error seems related with  https://github.com/react-component/m-list-view  and react-hot-loader ,   but I  can't find  version change of react-hot-loader between  beta.13 and beta14",arunoda,kind: bug,2017-01-25T14:05:16Z,2017-01-28T13:50:47Z,spacedragon,arunoda;spacedragon,arunoda,,arunoda,,nkzawa,
vercel/next.js,899,mobX with next beta 19 For some reason if I upgrade to beta 19 of next I get an error about the mobx store not being available. I'm using a provider and then injected the store into my components. Anyone else using mobx with next getting this error when upgrading?,arunoda,kind: bug,2017-01-27T14:08:40Z,2017-02-15T03:00:39Z,knipferrc,fridays;knipferrc;mingfang;chrisportela;sakulstra;arunoda;7elven;vuldin;yangnianqing;Zaiban,arunoda;timneutkens,,arunoda,,arunoda,
vercel/next.js,9070,"Scripts with async in Head are executed twice # Bug report

## Describe the bug

Scripts in the Head are run twice if marked `async`.

## To Reproduce

Steps to reproduce the behavior:

1. Create next app
2. Create file at `/static/log.js` with `console.log('hello');` inside
3. Attach to a page (make sure to add the `async` attribute)
```
<NextHead>
  <script src=""/static/log.js"" async></script>
</NextHead>
```
4. Run site
5. See duplicate console.log in console.

## Expected behavior

Scripts should only run once.

## Screenshots

![Screen Shot 2019-10-14 at 3 34 44 PM](https://user-images.githubusercontent.com/3136271/66759472-36013800-ee98-11e9-9157-86b2e395adda.jpg)

## System information

- OS: macOS
- Version of Next.js: latest 9.1.1
",Timer,kind: bug,2019-10-14T14:35:16Z,2021-01-04T19:57:52Z,jonkwheeler,mattjburrows;developit;jonkwheeler;fabb;sambokai;fabyeah;nileshparwan;wyattjoh;alexandermendes;msafi;balazsorban44;Timer;dsmikeyorke,Timer,Timer,,,,
vercel/next.js,9253,"Next.js should error when it detects a CommonJS transform in Babel config When using next.js with typescript and importing react `import * as React from 'react';` I'm getting double React imports. Any advice? I'm looking into how some other plugins detect it to see if there is a workaround.

_Originally posted by @cranberyxl in https://github.com/zeit/next.js/pull/8350#issuecomment-547964729_",developit,kind: bug,2019-10-30T16:37:29Z,2021-11-17T11:48:55Z,Timer,Timer;cranberyxl;developit;timneutkens;balazsorban44,Timer,Timer,Timer,,timneutkens,
vercel/next.js,9284,"Functional _app.js causes page getInitialProps to not run # Bug report

## Describe the bug

Exporting a function `App` in `pages/_app.js` as documented in https://github.com/zeit/next.js/pull/9268 causes the `getInitialProps` of pages to stop working.

## To Reproduce

Create a custom app as documented here: https://github.com/zeit/next.js/tree/v9.1.3-canary.1#custom-app

```jsx
const CustomApp = ({ Component, pageProps }) => <Component {...pageProps} />

export default CustomApp
```

In a page, try using `getInitialProps`:

```jsx
IndexPage.getInitialProps = () => {
  console.log('Works!')
  return {}
}
```

## Expected behavior

The page's `getInitialProps` should run when the page is loaded, in this example resulting in `Works!` being logged to the console.

## System information

- Version of Next.js: v9.1.3-canary.1

## Additional context

Original issue for the functional app feature: https://github.com/zeit/next.js/issues/7515
",timneutkens,kind: bug;type: needs investigation,2019-11-02T01:03:30Z,2019-11-02T15:00:56Z,jaydenseric,jhvissotto;ksorv;balazsorban44;timneutkens;esseswann;Timer,Timer;timneutkens,,timneutkens,,Timer,
vercel/next.js,9401,"9.1.3 fails using Jest when a test involves something imported from next/document # Bug report

After updating from `9.1.2` to `9.1.3` in our project some tests began to fail

After some research we've found out that those tests directly or indirectly depends on some module  from `next/document` (like `import Document, { Html, Head, Main, NextScript } from 'next/document';`)

This is the output of the error when running the test suite

```
 閳 Test suite failed to run

    Cannot find module 'next-plugin-loader?middleware=document-head-tags-server!' from '_document.js'

    However, Jest was able to find:
    	'dist/pages/_document.d.ts'
    	'dist/pages/_document.js'

    You might want to include a file extension in your import, or update your 'moduleFileExtensions', which is currently ['js', 'json', 'jsx', 'ts', 'tsx', 'node'].

    See https://jestjs.io/docs/en/configuration#modulefileextensions-array-string

      at Resolver.resolveModule (node_modules/jest-resolve/build/index.js:259:17)
```

## To Reproduce

Clone this repo and run the tests
https://github.com/alexandre-marchina/next-with-jest-loader-bug-repro

It was created based on the `with-jest` example (using the `jest.config.js` provided by the example), but adding a test to the custom `_document.js` that imports from `next/document`

## Expected behavior

Those tests should pass, but if we rollback to the `9.1.2` everything works just fine

## System information
- OS: [Linux Ubuntu 18.04.3]
- Version of Next.js: [9.1.3]

What would be the correct solution for this case?",ijjk,kind: bug,2019-11-13T14:43:46Z,2019-11-15T07:33:53Z,alexandre-marchina,ijjk;alexandre-marchina;balazsorban44,timneutkens,,timneutkens,,Timer,
vercel/next.js,9430,"Reference error: err is not defined # Bug report

## Describe the bug

Variable `err` is not defined, variable in catch is called `error`.

## To Reproduce

Only found this error on a app deployed on Zeit Now with an api route with cors. In development it works. 

## Expected behavior

Catch error and log correctly, using `error` variable.

## System information

- Version of Next.js: 9.1.3

## Additional context

Link to faulty code: https://github.com/zeit/next.js/blob/7c80febcf796c91bb776ea3b841cab18df221ff4/packages/next/build/webpack/loaders/next-serverless-loader.ts#L72
",ijjk,kind: bug,2019-11-16T00:19:24Z,2019-11-16T02:00:25Z,vitorhsb,ijjk;balazsorban44,timneutkens,,timneutkens,,Timer,
vercel/next.js,9471,"Source map error: Error: Invalid URL: (Firefox) # Bug report
Navigating to our next.js page in Firefox we recieve the following error in the console:
```
Source map error: Error: Invalid URL: webpack://[name]_[chunkhash]/webpack/bootstrap
Resource URL: http://127.0.0.1:3001/_next/static/development/dll/dll_01ec57fc9b90d43b98a8.js?ts=1574263926643
Source Map URL: dll_01ec57fc9b90d43b98a8.js.map
```

When investigating the file itself i do see a lot of `webpack://[name]_[chunkhash]` here are the first few lines: (Im guessing it shouldn't be like this?)
```
{""version"":3,""file"":""dll_01ec57fc9b90d43b98a8.js"",""sources"":[""webpack://[name]_[chunkhash]/webpack/bootstrap"",""webpack://[name]_[chunkhash]/./node_modules/object-assign/index.js"",""webpack://[name]_[chunkhash]/./node_modules/prop-types/checkPropTypes.js"",""webpack://[name]_[chunkhash]/./node_modules/prop-types/lib/ReactPropTypesSecret.js"",""webpack://[name]_[chunkhash]/./node_modules/react-dom/cjs/react-dom.development.js"",""webpack://[name]_[chunkhash]/./node_modules/react-dom/index.js"",""webpack://[name]_[chunkhash]/./node_modules/react/cjs/react.development.js"",""webpack://[name]_[chunkhash]/./node_modules/react/index.js"",""webpack://[name]_[chunkhash]/./node_modules/scheduler/cjs/scheduler-tracing.development.js"",""webpack://[name]_[chunkhash]/./node_modules/scheduler/cjs/scheduler.development.js"",""webpack://[name]_[chunkhash]/./node_modules/scheduler/index.js"",""webpack://[name]_[chunkhash]/./node_modules/scheduler/tracing.js""],""sourcesContent"":["" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules
```

## To Reproduce
* Run next watch
* Navigate to next in Firefox 
* Open dev tools

## Screenshots

![image](https://user-images.githubusercontent.com/936006/69252866-98daa300-0bab-11ea-95b6-a88fa042cfe3.png)

## System information

- OS: MacOS 10.14.6
- Browser: Firefox Developer Edition (71.0b10)
- Version of Next.js: 9.1.3

## Additional context
This only seems to be affecting Firefox, Chrome reports no issues in the console",Timer;timneutkens,kind: bug;type: needs investigation,2019-11-20T15:39:26Z,2020-07-20T14:24:26Z,jasonwilliams,jasonLaster;oyeanuj;jasonwilliams;chrisbenincasa;Timer;balazsorban44;loganfsmyth,Timer,,,,Timer,
vercel/next.js,9732,"GET-query params are lost when using unstable_getStaticProps in production mode # GET-query params are lost when using unstable_getStaticProps in production mode

In DEV-mode when i do request to a page with GET-query parameters, i can read them in unstable_getStaticProps.

Example: 

> file pages/[category].jsx
```
...
export async function unstable_getStaticProps({params}) {
    // while doing request to http://localhost:8000/items?page=13
    // category is always ""items""
    // ""params"" is 13 in DEV mode, but undefined in production mode
    const {category, page} = params;
}
```

Meanwhile after build GET-query parameters are not added to params due to code on that line:

https://github.com/zeit/next.js/blob/88de2328e532eaf0cbb860957f8a5bc2d4c82c44/packages/next/next-server/server/next-server.ts#L917

Judging by the code, GET-query parameters are actually got parsed, but are thrown away. 

I checked that out by replacing line 
https://github.com/zeit/next.js/blob/88de2328e532eaf0cbb860957f8a5bc2d4c82c44/packages/next/next-server/server/next-server.ts#L919
with code
```
 result.unstable_getStaticProps ? Object.assign({}, query, params): params
```

I am sure that's not the right way to fix it, but it did show to me there's bug in L917.

This is reproducable on next 9.1.4 and canary 9.1.6",Timer;ijjk,kind: bug,2019-12-13T14:13:18Z,2019-12-13T18:14:10Z,khades,Timer;khades;balazsorban44,Timer,,Timer,,Timer,
vercel/next.js,990,"Cannot read property 'replace' of undefined I tried to upgrade from next@2.0.0-beta.20 but something changed in the beta.21 specifically, I get the stack trace below when running `yarn dev`. Here is my app: https://github.com/relatenow/relate

<details>
TypeError: Cannot read property 'replace' of undefined
    at toRoute (/Users/sdubois/Documents/relate/node_modules/next/dist/lib/router/router.js:618:14)
    at new Router (/Users/sdubois/Documents/relate/node_modules/next/dist/lib/router/router.js:85:19)
    at renderPage (/Users/sdubois/Documents/relate/node_modules/next/dist/server/render.js:143:25)
    at /Users/sdubois/Documents/relate/node_modules/next/dist/server/document.js:56:22
    at renderStatic (/Users/sdubois/Documents/relate/node_modules/glamor/lib/server.js:18:14)
    at Function.getInitialProps (/Users/sdubois/Documents/relate/node_modules/next/dist/server/document.js:55:45)
    at _callee$ (/Users/sdubois/Documents/relate/node_modules/next/dist/lib/utils.js:36:30)
    at tryCatch (/Users/sdubois/Documents/relate/node_modules/regenerator-runtime/runtime.js:64:40)
    at Generator.invoke [as _invoke] (/Users/sdubois/Documents/relate/node_modules/regenerator-runtime/runtime.js:355:22)
    at Generator.prototype.(anonymous function) [as next] (/Users/sdubois/Documents/relate/node_modules/regenerator-runtime/runtime.js:116:21)
(node:4021) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): TypeError: Cannot read property 'replace' of undefined
</details>

",timneutkens,kind: bug,2017-02-04T20:02:21Z,2017-02-09T03:22:48Z,sedubois,timneutkens;sedubois;arunoda,arunoda;timneutkens,,timneutkens,,arunoda,
vercel/next.js,9989,"Blank page when using browser back button on SSR pages. ## Summary
A dynamic SSR rendered page of mine is completely blank when users go back to it from another page.

## To Reproduce

1. Create a new dynamic web page in Next.js. E.g: A React component that is pre-populated with data from a database or cache.
2. In the footer of this page, add a Next.js `<Link/>` to the home page (which is a static, standard next.js page).
3. Deploy the site, visit this dynamic SSR page from step 1.
4. Click the link on the footer.
5. Click the back button or use a keyboard shortcut to ""Go back"".
6. Observe the page is completely empty. No JS errors occur in the console.

## Expected behavior

When I ""Go back"" in my browser, the page should display exactly as it did before.


## System information

- OS: macOS
- Browser (if applies) Chrome 79.0.3945.88
- Version of Next.js: ^9.1.6

## Additional context
Issue doesn't occur for static pages, only dynamic SSR pages.
",ijjk,kind: bug,2020-01-08T04:31:11Z,2020-08-26T15:03:12Z,iMerica,nickmarlou;Timer;Skarian;ijjk;drnachio;samuanv;hanayashiki;Le0nX;Noob7;ugtdbt;javonclarke;collegewap;SergioGeeK7;tylerharpool;thebetterjort;balazsorban44;chiqui3d,Timer,Timer,Timer,,ijjk,vercel/next.js#12530;vercel/next.js#16028;
